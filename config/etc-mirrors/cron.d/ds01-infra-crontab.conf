# Cron jobs for DS01 Infrastructure Monitoring
# Deploy to: /etc/cron.d/ds01-infra
# Source: /opt/ds01-infra/config/etc-mirrors/cron.d/ds01-infra-crontab.conf
# Do: sudo cp /opt/ds01-infra/config/etc-mirrors/cron.d/ds01-infra-crontab.conf /etc/cron.d/ds01-infra


# All scripts output to /var/log/ds01-infra/cron/cron.log
# Individual scripts log to their respective subdirectories

# DS01 Infrastructure Monitoring
PATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin

# Collect metrics every 5 minutes
*/5 * * * * root /opt/ds01-infra/scripts/monitoring/collect-gpu-metrics.sh >> /var/log/ds01/cron.log 2>&1
*/5 * * * * root /opt/ds01-infra/scripts/monitoring/collect-cpu-metrics.sh >> /var/log/ds01/cron.log 2>&1
*/5 * * * * root /opt/ds01-infra/scripts/monitoring/collect-memory-metrics.sh >> /var/log/ds01/cron.log 2>&1
*/5 * * * * root /opt/ds01-infra/scripts/monitoring/collect-disk-metrics.sh >> /var/log/ds01/cron.log 2>&1
*/5 * * * * root /opt/ds01-infra/scripts/monitoring/collect-container-metrics.sh >> /var/log/ds01/cron.log 2>&1

# Check for idle containers every hour at :30 past the hour
30 * * * * root /opt/ds01-infra/scripts/monitoring/check-idle-containers.sh >> /var/log/ds01/idle-cleanup.log 2>&1

# Enforce max runtime limits every hour at :45 past the hour
45 * * * * root /opt/ds01-infra/scripts/maintenance/enforce-max-runtime.sh >> /var/log/ds01/runtime-enforcement.log 2>&1

# Clean up stale GPU allocations every hour at :15 past the hour
15 * * * * root /opt/ds01-infra/scripts/maintenance/cleanup-stale-gpu-allocations.sh >> /var/log/ds01/gpu-cleanup.log 2>&1

# Clean up stale containers every hour at :00 past the hour
0 * * * * root /opt/ds01-infra/scripts/maintenance/cleanup-stale-containers.sh >> /var/log/ds01/container-cleanup.log 2>&1

# Daily report at 23:55
55 23 * * * root /opt/ds01-infra/scripts/monitoring/compile-daily-report.sh >> /var/log/ds01/daily-report.log 2>&1

# Weekly audits - Sunday 2am and 3am
0 2 * * 0 root /opt/ds01-infra/scripts/monitoring/audit-system.sh >> /var/log/ds01/audit-system.log 2>&1
0 3 * * 0 root /opt/ds01-infra/scripts/monitoring/audit-docker.sh >> /var/log/ds01/audit-docker.log 2>&1

# Weekly maintenance - Sunday 3am
0 3 * * 0 root /opt/ds01-infra/scripts/maintenance/setup-scratch-dirs.sh >> /var/log/ds01/maintenance.log 2>&1

# Monthly cleanup - 1st of month at 4am
0 4 1 * * root find /scratch -type f -mtime +45 -delete >> /var/log/ds01/scratch-cleanup.log 2>&1
5 4 1 * * root find /scratch -type d -empty -delete >> /var/log/ds01/scratch-cleanup.log 2>&1

# build this out more

# Clean up Docker images
#COME BACK TO: 0 4 1 * * datasciencelab docker image prune -f >> /var/log/ds01-infra/cron/cron.log 2>&1



