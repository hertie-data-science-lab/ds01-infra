#!/bin/bash
# Enhanced Docker Image Updater with Interactive Package Management
# Supports adding/removing packages without manual Dockerfile editing

set -e

# Source interactive library
source /usr/local/lib/interactive-select.sh

BLUE='\033[94m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
CYAN='\033[0;36m'
BOLD='\033[1m'
DIM='\033[2m'
NC='\033[0m'

USERNAME=$(whoami)
IMAGES_DIR="$HOME/docker-images"

usage() {
    echo ""
    echo -e "${BOLD}Docker Image Updater${NC}"
    echo ""
    echo -e "${CYAN}Usage:${NC}"
    echo "  image-update [image-name] [options]"
    echo "  image-update                                 # Prompts to select image (if none specified)"
    echo "  image-update <image-name>                    # Interactive mode (default)"
    echo ""
    echo -e "${CYAN}Options:${NC}"
    echo "  --add \"pkg1 pkg2\"    Add packages directly (quick mode)"
    echo "  --add-system \"pkg1\"  Add system packages directly"
    echo "  --edit               Edit Dockerfile manually (advanced)"
    echo "  --guided             Show detailed explanations (educational)"
    echo "  --no-cache           Build without using cache (clean rebuild)"
    echo "  -h, --help           Show this help message"
    echo ""
    echo -e "${CYAN}Modes:${NC}"
    echo -e "  ${BOLD}Interactive${NC} (default)  - User-friendly GUI for package management"
    echo -e "  ${BOLD}Quick${NC} (--add)          - Add packages from command line"
    echo -e "  ${BOLD}Advanced${NC} (--edit)      - Direct Dockerfile editing"
    echo -e "  ${BOLD}Guided${NC} (--guided)      - Educational mode with explanations"
    echo ""
    echo -e "${CYAN}Examples:${NC}"
    echo -e "  ${DIM}# Interactive mode (shows current packages, prompts for changes)${NC}"
    echo "  image-update my-project"
    echo ""
    echo -e "  ${DIM}# Quick add packages without interaction${NC}"
    echo "  image-update my-project --add \"wandb optuna pytorch-lightning\""
    echo ""
    echo -e "  ${DIM}# Add system packages${NC}"
    echo "  image-update my-project --add-system \"tmux htop\""
    echo ""
    echo -e "  ${DIM}# Edit Dockerfile directly (power users)${NC}"
    echo "  image-update my-project --edit"
    echo ""
    echo -e "  ${DIM}# Guided mode for beginners${NC}"
    echo "  image-update my-project --guided"
    echo ""
    echo -e "${YELLOW}üí° After updating:${NC}"
    echo "   Recreate containers to use the new image:"
    echo -e "   ${GREEN}container-stop my-project${NC}"
    echo -e "   ${GREEN}container-cleanup${NC}"
    echo -e "   ${GREEN}container-create my-project${NC}"
    echo ""
}

# Parse Dockerfile to extract Python packages
parse_python_packages() {
    local dockerfile="$1"

    # Find all RUN pip install commands and extract packages
    # This handles multiline commands with backslashes
    grep -E "RUN pip install|pip install --no-cache-dir" "$dockerfile" | \
        sed 's/RUN pip install --no-cache-dir //g' | \
        sed 's/RUN pip install //g' | \
        sed 's/\\//g' | \
        tr ' ' '\n' | \
        grep -v "^$" | \
        grep -v "^#" | \
        sort -u
}

# Parse Dockerfile to extract system packages
parse_system_packages() {
    local dockerfile="$1"

    # Find apt-get install commands
    grep -E "apt-get install" "$dockerfile" | \
        sed 's/.*apt-get install -y --no-install-recommends //g' | \
        sed 's/&&.*//g' | \
        sed 's/\\//g' | \
        tr ' ' '\n' | \
        grep -v "^$" | \
        grep -v "^#" | \
        grep -v "apt-get" | \
        grep -v "update" | \
        grep -v "rm" | \
        sort -u
}

# Add Python packages to Dockerfile
add_python_packages() {
    local dockerfile="$1"
    shift
    local packages=("$@")

    # Find the last RUN pip install line
    local last_pip_line=$(grep -n "RUN pip install" "$dockerfile" | tail -1 | cut -d: -f1)

    if [ -z "$last_pip_line" ]; then
        echo -e "${RED}‚úó Could not find pip install section in Dockerfile${NC}"
        return 1
    fi

    # Create backup
    cp "$dockerfile" "${dockerfile}.bak"

    # Add packages to the last pip install section
    # We'll insert them before the last package (which might have no backslash)
    for pkg in "${packages[@]}"; do
        # Check if package already exists
        if grep -q "$pkg" "$dockerfile"; then
            echo -e "${YELLOW}  ‚ö† $pkg already in Dockerfile, skipping${NC}"
            continue
        fi

        # Insert package before the last line of the pip install block
        sed -i "${last_pip_line}i\\    $pkg \\\\" "$dockerfile"
        echo -e "${GREEN}  ‚úì${NC} Added: $pkg"
    done

    return 0
}

# Add system packages to Dockerfile
add_system_packages() {
    local dockerfile="$1"
    shift
    local packages=("$@")

    # Find the apt-get install line
    local apt_line=$(grep -n "apt-get install" "$dockerfile" | head -1 | cut -d: -f1)

    if [ -z "$apt_line" ]; then
        echo -e "${RED}‚úó Could not find apt-get install section in Dockerfile${NC}"
        return 1
    fi

    # Create backup
    cp "$dockerfile" "${dockerfile}.bak"

    # Add packages to apt-get install line
    for pkg in "${packages[@]}"; do
        # Check if package already exists
        if grep -q "$pkg" "$dockerfile"; then
            echo -e "${YELLOW}  ‚ö† $pkg already in Dockerfile, skipping${NC}"
            continue
        fi

        # Insert package in apt-get install line
        sed -i "${apt_line}s/$/ \\\\\n    $pkg/" "$dockerfile"
        echo -e "${GREEN}  ‚úì${NC} Added: $pkg"
    done

    return 0
}

# Remove packages from Dockerfile
remove_packages() {
    local dockerfile="$1"
    shift
    local packages=("$@")

    cp "$dockerfile" "${dockerfile}.bak"

    for pkg in "${packages[@]}"; do
        # Remove the line containing the package
        if sed -i "/$pkg/d" "$dockerfile"; then
            echo -e "${GREEN}  ‚úì${NC} Removed: $pkg"
        else
            echo -e "${YELLOW}  ‚ö†${NC} Package not found: $pkg"
        fi
    done

    return 0
}

# Interactive mode
interactive_mode() {
    local dockerfile="$1"

    while true; do
        echo ""
        echo -e "${CYAN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
        echo -e "${BOLD}Package Management${NC}"
        echo -e "${CYAN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
        echo ""

        # Show current packages
        echo -e "${BOLD}Current Python packages:${NC}"
        echo ""
        parse_python_packages "$dockerfile" | head -20 | while read pkg; do
            echo -e "  ${CYAN}‚Ä¢${NC} $pkg"
        done

        local pkg_count=$(parse_python_packages "$dockerfile" | wc -l)
        if [ "$pkg_count" -gt 20 ]; then
            echo -e "  ${DIM}... and $((pkg_count - 20)) more${NC}"
        fi
        echo ""

        echo -e "${BOLD}Current system packages:${NC}"
        echo ""
        parse_system_packages "$dockerfile" | head -10 | while read pkg; do
            echo -e "  ${CYAN}‚Ä¢${NC} $pkg"
        done

        local sys_count=$(parse_system_packages "$dockerfile" | wc -l)
        if [ "$sys_count" -gt 10 ]; then
            echo -e "  ${DIM}... and $((sys_count - 10)) more${NC}"
        fi
        echo ""

        echo -e "${BOLD}What would you like to do?${NC}"
        echo ""
        echo -e "  ${BOLD}1)${NC} Add Python packages (pip)"
        echo -e "  ${BOLD}2)${NC} Add system packages (apt)"
        echo -e "  ${BOLD}3)${NC} Remove packages"
        echo -e "  ${BOLD}4)${NC} Edit Dockerfile directly ${DIM}(advanced)${NC}"
        echo -e "  ${BOLD}5)${NC} Continue to rebuild"
        echo -e "  ${BOLD}6)${NC} Cancel"
        echo ""
        read -p "Choice [1-6]: " CHOICE </dev/tty

        case $CHOICE in
            1)
                echo ""
                echo -e "${BOLD}Add Python Packages${NC}"
                echo ""
                echo "Enter package names (space-separated):"
                echo -e "${DIM}Examples: wandb optuna pytorch-lightning transformers${NC}"
                echo ""
                read -p "> " NEW_PACKAGES </dev/tty

                if [ -n "$NEW_PACKAGES" ]; then
                    echo ""
                    echo -e "${CYAN}Adding packages...${NC}"
                    echo ""
                    add_python_packages "$dockerfile" $NEW_PACKAGES
                    echo ""
                    echo -e "${GREEN}‚úì${NC} Packages added to Dockerfile"
                else
                    echo -e "${YELLOW}No packages entered${NC}"
                fi
                ;;

            2)
                echo ""
                echo -e "${BOLD}Add System Packages${NC}"
                echo ""
                echo "Enter system package names (space-separated):"
                echo -e "${DIM}Examples: tmux htop tree${NC}"
                echo ""
                read -p "> " NEW_SYS_PACKAGES </dev/tty

                if [ -n "$NEW_SYS_PACKAGES" ]; then
                    echo ""
                    echo -e "${CYAN}Adding system packages...${NC}"
                    echo ""
                    add_system_packages "$dockerfile" $NEW_SYS_PACKAGES
                    echo ""
                    echo -e "${GREEN}‚úì${NC} System packages added to Dockerfile"
                else
                    echo -e "${YELLOW}No packages entered${NC}"
                fi
                ;;

            3)
                echo ""
                echo -e "${BOLD}Remove Packages${NC}"
                echo ""
                echo "Enter package names to remove (space-separated):"
                echo ""
                read -p "> " REMOVE_PACKAGES </dev/tty

                if [ -n "$REMOVE_PACKAGES" ]; then
                    echo ""
                    echo -e "${CYAN}Removing packages...${NC}"
                    echo ""
                    remove_packages "$dockerfile" $REMOVE_PACKAGES
                    echo ""
                    echo -e "${GREEN}‚úì${NC} Packages removed from Dockerfile"
                else
                    echo -e "${YELLOW}No packages entered${NC}"
                fi
                ;;

            4)
                echo ""
                echo -e "${YELLOW}Opening Dockerfile in editor...${NC}"
                echo ""
                ${EDITOR:-vim} "$dockerfile"
                echo ""
                echo -e "${GREEN}‚úì${NC} Dockerfile edited"
                ;;

            5)
                echo ""
                return 0
                ;;

            6)
                echo ""
                echo "Cancelled."
                exit 0
                ;;

            *)
                echo -e "${RED}Invalid choice${NC}"
                ;;
        esac
    done
}

# Guided mode with educational content
guided_mode() {
    local dockerfile="$1"

    echo ""
    echo -e "${CYAN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
    echo -e "${BOLD}Docker Image Updates - Guided Mode${NC}"
    echo -e "${CYAN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
    echo ""
    echo -e "${BOLD}Understanding Docker Images${NC}"
    echo ""
    echo "A Docker image is like a ${CYAN}blueprint${NC} for your computing environment."
    echo "It defines what software, packages, and tools are installed."
    echo ""
    echo -e "${BOLD}Why Can't I Just 'pip install' in My Container?${NC}"
    echo ""
    echo -e "${YELLOW}You can, BUT:${NC}"
    echo ""
    echo -e "  ${CYAN}Temporary Install${NC} (pip install in container):"
    echo "    ‚úì Fast for testing"
    echo "    ‚úì No rebuild needed"
    echo "    ‚úó Lost when container is removed"
    echo "    ‚úó Not reproducible"
    echo "    ‚úó Can't share with colleagues"
    echo ""
    echo -e "  ${GREEN}Permanent Install${NC} (update image):"
    echo "    ‚úì Persists across container recreations"
    echo "    ‚úì Reproducible setup"
    echo "    ‚úì Can share with team"
    echo "    ‚úì Documented in Dockerfile"
    echo "    ‚úó Takes 3-5 minutes to rebuild"
    echo ""
    echo -e "${BOLD}Best Practice Workflow:${NC}"
    echo ""
    echo "  1. ${CYAN}Test${NC} new packages: pip install in container"
    echo "  2. ${CYAN}Confirm${NC} they work: run your code"
    echo "  3. ${CYAN}Make permanent${NC}: image-update (this command)"
    echo "  4. ${CYAN}Recreate${NC} container with updated image"
    echo ""
    echo -e "${BOLD}What This Command Does:${NC}"
    echo ""
    echo "  ‚Ä¢ Shows packages currently in your image"
    echo "  ‚Ä¢ Lets you add/remove packages easily"
    echo "  ‚Ä¢ Updates the Dockerfile automatically"
    echo "  ‚Ä¢ Rebuilds the image with your changes"
    echo "  ‚Ä¢ Creates a permanent, reproducible setup"
    echo ""
    read -p "Press Enter to continue..." </dev/tty
    echo ""

    # Now run interactive mode
    interactive_mode "$dockerfile"
}

# Parse arguments
IMAGE_NAME=""
EDIT_FIRST=false
NO_CACHE=false
QUICK_ADD_PACKAGES=""
QUICK_ADD_SYSTEM=""
GUIDED=false

while [[ $# -gt 0 ]]; do
    case $1 in
        --add)
            QUICK_ADD_PACKAGES="$2"
            shift 2
            ;;
        --add-system)
            QUICK_ADD_SYSTEM="$2"
            shift 2
            ;;
        --edit)
            EDIT_FIRST=true
            shift
            ;;
        --guided)
            GUIDED=true
            shift
            ;;
        --no-cache)
            NO_CACHE=true
            shift
            ;;
        -h|--help|--info)
            usage
            exit 0
            ;;
        -*)
            echo -e "${RED}Unknown option: $1${NC}\n"
            usage
            exit 1
            ;;
        *)
            if [ -z "$IMAGE_NAME" ]; then
                IMAGE_NAME="$1"
            else
                echo -e "${RED}Multiple image names specified${NC}\n"
                usage
                exit 1
            fi
            shift
            ;;
    esac
done

# If no image name provided, prompt to select
if [ -z "$IMAGE_NAME" ]; then
    IMAGE_NAME=$(select_image)
    if [ -z "$IMAGE_NAME" ]; then
        echo "No selection made. Exiting."
        exit 0
    fi
    echo ""
fi

# Validate image name
if [ -z "$IMAGE_NAME" ]; then
    echo -e "${RED}Error: Image name is required${NC}\n"
    usage
    exit 1
fi

# Add username prefix if not present
if [[ ! "$IMAGE_NAME" =~ ^${USERNAME}- ]]; then
    IMAGE_NAME="${USERNAME}-${IMAGE_NAME}"
fi

# Check if image exists
if ! docker images --format "{{.Repository}}" | grep -q "^${IMAGE_NAME}$"; then
    echo -e "${RED}‚úó Image '$IMAGE_NAME' not found${NC}\n"
    echo "Available images:"
    docker images --format "  {{.Repository}}" --filter "reference=${USERNAME}-*"
    echo ""
    echo "Create new image with: ${GREEN}image-create${NC}"
    exit 1
fi

# Find Dockerfile
DOCKERFILE=""

# Check info file first
INFO_FILE="$HOME/ds01-config/images/${IMAGE_NAME}.info"
if [ -f "$INFO_FILE" ]; then
    DOCKERFILE=$(grep "^Dockerfile:" "$INFO_FILE" | cut -d: -f2- | xargs)
fi

# Fallback to standard location
if [ -z "$DOCKERFILE" ] || [ ! -f "$DOCKERFILE" ]; then
    DOCKERFILE="$IMAGES_DIR/${IMAGE_NAME}.Dockerfile"
fi

# Check if Dockerfile exists
if [ ! -f "$DOCKERFILE" ]; then
    echo -e "${RED}‚úó Dockerfile not found${NC}"
    echo "Expected location: $DOCKERFILE"
    echo ""
    read -p "Enter path to Dockerfile: " CUSTOM_PATH
    if [ -f "$CUSTOM_PATH" ]; then
        DOCKERFILE="$CUSTOM_PATH"
    else
        echo -e "${RED}‚úó File not found: $CUSTOM_PATH${NC}"
        exit 1
    fi
fi

echo ""
echo -e "${CYAN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
echo -e "${BOLD}Updating Image: ${CYAN}$IMAGE_NAME${NC}"
echo -e "${CYAN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
echo ""
echo -e "Dockerfile: ${BLUE}$DOCKERFILE${NC}"
echo ""

# Show current image info
CURRENT_SIZE=$(docker images --format "{{.Size}}" "$IMAGE_NAME" | head -1)
CURRENT_CREATED=$(docker images --format "{{.CreatedAt}}" "$IMAGE_NAME" | head -1)

echo -e "${BOLD}Current image:${NC}"
echo "  Size:    $CURRENT_SIZE"
echo "  Created: $CURRENT_CREATED"

# Handle different modes
if [ "$EDIT_FIRST" = true ]; then
    # Advanced mode: direct edit
    echo ""
    echo -e "${YELLOW}Opening Dockerfile in editor...${NC}"
    ${EDITOR:-vim} "$DOCKERFILE"
    echo ""

elif [ -n "$QUICK_ADD_PACKAGES" ]; then
    # Quick mode: add packages from command line
    echo ""
    echo -e "${CYAN}Quick Add Mode${NC}"
    echo ""
    echo -e "${BOLD}Adding Python packages:${NC}"
    echo ""
    add_python_packages "$DOCKERFILE" $QUICK_ADD_PACKAGES
    echo ""

elif [ -n "$QUICK_ADD_SYSTEM" ]; then
    # Quick mode: add system packages from command line
    echo ""
    echo -e "${CYAN}Quick Add Mode${NC}"
    echo ""
    echo -e "${BOLD}Adding system packages:${NC}"
    echo ""
    add_system_packages "$DOCKERFILE" $QUICK_ADD_SYSTEM
    echo ""

elif [ "$GUIDED" = true ]; then
    # Guided mode: educational
    guided_mode "$DOCKERFILE"

else
    # Default: interactive mode
    interactive_mode "$DOCKERFILE"
fi

# Confirm rebuild
echo ""
echo -e "${YELLOW}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
echo -e "${YELLOW}Ready to Rebuild Image${NC}"
echo -e "${YELLOW}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
echo ""
echo "This will rebuild the image with your changes."
if [ "$NO_CACHE" = true ]; then
    echo -e "${YELLOW}‚ö† Building without cache (clean rebuild)${NC}"
fi
echo ""
echo -e "${DIM}Time estimate: 3-5 minutes${NC}"
echo ""
read -p "Continue? [Y/n]: " CONFIRM
CONFIRM=${CONFIRM:-Y}

if [[ ! "$CONFIRM" =~ ^[Yy]$ ]]; then
    echo "Cancelled."

    # Restore backup if exists
    if [ -f "${DOCKERFILE}.bak" ]; then
        mv "${DOCKERFILE}.bak" "$DOCKERFILE"
        echo "Dockerfile restored to original state."
    fi
    exit 0
fi

# Build command
BUILD_CMD="docker build -t $IMAGE_NAME -f $DOCKERFILE"
if [ "$NO_CACHE" = true ]; then
    BUILD_CMD="$BUILD_CMD --no-cache"
fi
BUILD_CMD="$BUILD_CMD $IMAGES_DIR/"

echo ""
echo -e "${CYAN}Building image...${NC}"
echo ""

# Build
if eval "$BUILD_CMD"; then
    echo ""
    echo -e "${GREEN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
    echo -e "${GREEN}${BOLD}‚úì Image updated successfully!${NC}"
    echo -e "${GREEN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
    echo ""

    # Remove backup
    rm -f "${DOCKERFILE}.bak"

    # Show new image info
    NEW_SIZE=$(docker images --format "{{.Size}}" "$IMAGE_NAME" | head -1)
    NEW_CREATED=$(docker images --format "{{.CreatedAt}}" "$IMAGE_NAME" | head -1)

    echo -e "${BOLD}Updated image:${NC}"
    echo "  Size:    $NEW_SIZE"
    echo "  Created: $NEW_CREATED"
    echo ""

    # Update metadata
    if [ -f "$INFO_FILE" ]; then
        sed -i.bak "s/^Created:.*/Created: $(date)/" "$INFO_FILE"
        rm -f "${INFO_FILE}.bak"
    fi

    # Check for containers using this image
    CONTAINER_BASE_NAME="${IMAGE_NAME#$USERNAME-}"
    CONTAINER_BASE_NAME="${CONTAINER_BASE_NAME%-image}"

    echo -e "${CYAN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
    echo -e "${BOLD}Next Steps: Update Your Container${NC}"
    echo -e "${CYAN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
    echo ""
    echo "Your image has been updated, but containers created from"
    echo "the old image are still using the old packages."
    echo ""
    echo "To use the new packages, recreate your container:"
    echo ""
    echo -e "  ${BOLD}1.${NC} Stop the container:"
    echo -e "     ${GREEN}container-stop $CONTAINER_BASE_NAME${NC}"
    echo ""
    echo -e "  ${BOLD}2.${NC} Remove the old container:"
    echo -e "     ${GREEN}docker rm $CONTAINER_BASE_NAME._.$(id -u)${NC}"
    echo ""
    echo -e "  ${BOLD}3.${NC} Create new container from updated image:"
    echo -e "     ${GREEN}container-create $CONTAINER_BASE_NAME${NC}"
    echo ""
    echo -e "${YELLOW}üí° Tip:${NC} Your workspace files are safe and will be"
    echo "   automatically mounted in the new container."
    echo ""

else
    echo ""
    echo -e "${RED}‚úó Build failed${NC}"
    echo ""
    echo "Troubleshooting:"
    echo "  1. Check Dockerfile syntax: ${BLUE}cat $DOCKERFILE${NC}"
    echo "  2. View backup: ${BLUE}cat ${DOCKERFILE}.bak${NC}"
    echo "  3. Restore backup: ${GREEN}mv ${DOCKERFILE}.bak $DOCKERFILE${NC}"
    echo "  4. Try again: ${GREEN}image-update $IMAGE_NAME${NC}"
    echo ""
    exit 1
fi

echo ""
