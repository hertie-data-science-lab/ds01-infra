#!/bin/bash
# /opt/ds01-infra/scripts/user/ds01-login-check
# DS01 Login Check - Run on user login to show warnings
#
# Add to ~/.bashrc or /etc/profile.d/ to run on login:
#   [ -x /opt/ds01-infra/scripts/user/ds01-login-check ] && \
#       /opt/ds01-infra/scripts/user/ds01-login-check
#
# Can be run manually too.

INFRA_ROOT="/opt/ds01-infra"

# Only run in interactive shells
[[ $- != *i* ]] && exit 0

# Throttle - only show warnings once per hour
THROTTLE_FILE="/tmp/.ds01-login-check-$USER"
if [[ -f "$THROTTLE_FILE" ]]; then
    last_run=$(stat -c %Y "$THROTTLE_FILE" 2>/dev/null || echo 0)
    now=$(date +%s)
    if [[ $((now - last_run)) -lt 3600 ]]; then
        exit 0
    fi
fi
touch "$THROTTLE_FILE"

# Colors
YELLOW='\033[1;33m'
NC='\033[0m'

# Check for bare metal processes (quick check, don't run full detection)
check_bare_metal() {
    # Count user's processes that look like compute workloads
    local compute_count=0

    # Check for common compute processes
    compute_count=$(ps -u "$USER" -o comm= 2>/dev/null | \
        grep -cE '^(python|python3|jupyter|train|ray|spark)') || compute_count=0

    if [[ $compute_count -gt 0 ]]; then
        # Only show if processes are outside containers
        # Simple heuristic: if we're in a container, /proc/1/cgroup has docker
        if ! grep -q docker /proc/1/cgroup 2>/dev/null; then
            # We're on bare metal - check if processes are ours and long-running
            local long_running
            long_running=$(ps -u "$USER" --no-headers -o pid,etimes,comm 2>/dev/null | \
                awk '$2 > 300 && /python|jupyter|train|ray/ {count++} END {print count+0}')

            if [[ $long_running -gt 0 ]]; then
                echo ""
                echo -e "${YELLOW}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
                echo -e "${YELLOW}â„¹${NC}  You have ${long_running} compute process(es) running on bare metal."
                echo ""
                echo "   We're transitioning to container-only workflows for:"
                echo "   â€¢ Better GPU access and isolation"
                echo "   â€¢ Reproducible environments"
                echo "   â€¢ Fair resource sharing"
                echo ""
                echo "   Start using containers: container-deploy <project-name>"
                echo "   Check your resources:   check-limits"
                echo -e "${YELLOW}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
                echo ""
            fi
        fi
    fi
}

# Check storage quota (quick estimate)
check_storage() {
    # Quick check using du (if quota system not available)
    local home_kb
    home_kb=$(du -sk "$HOME" 2>/dev/null | cut -f1 || echo 0)

    # Default 100GB limit in KB
    local limit_kb=$((100 * 1024 * 1024))

    if [[ $home_kb -gt $((limit_kb * 90 / 100)) ]]; then
        local percent=$((home_kb * 100 / limit_kb))
        echo ""
        echo -e "${YELLOW}âš  Storage: Using ~${percent}% of quota. Run 'quota-check' for details.${NC}"
    fi
}

# Check for pending alerts
check_alerts() {
    local alerts_file="/var/lib/ds01/alerts/${USER}.json"

    if [[ -f "$alerts_file" ]]; then
        # Read alerts using Python (handles JSON properly)
        local alert_count
        alert_count=$(python3 -c "import json; print(len(json.load(open('$alerts_file'))))" 2>/dev/null || echo "0")

        if [[ "$alert_count" -gt 0 ]]; then
            echo ""
            echo -e "${YELLOW}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
            echo -e "${YELLOW}ğŸ“¢ You have $alert_count resource alert(s):${NC}"
            echo ""

            # Display each alert
            python3 -c "
import json
with open('$alerts_file') as f:
    alerts = json.load(f)
for alert in alerts:
    icon = 'âš ' if 'limit' in alert['type'] else 'â„¹'
    print(f\"   {icon}  {alert['message']}\")
" 2>/dev/null || true

            echo ""
            echo "   Run 'check-limits' for details."
            echo -e "${YELLOW}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
            echo ""
        fi
    fi
}

# Run checks
check_alerts
check_bare_metal
# check_storage  # Enable if quota system is active
