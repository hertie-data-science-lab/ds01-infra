#!/bin/bash
# DS01 Directory Create - Creates standardized project directory structures
# Tier 2 Command - Can be used standalone or called by orchestrators

set -e

# Colors
BLUE='\033[94m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
CYAN='\033[0;36m'
BOLD='\033[1m'
DIM='\033[2m'
NC='\033[0m'

USERNAME=$(whoami)
WORKSPACE_DIR="$HOME/workspace"

usage() {
    echo ""
    echo -e "${BOLD}DS01 Directory Create${NC}"
    echo ""
    echo -e "${CYAN}Usage:${NC}"
    echo "  dir-create <project-name> [options]"
    echo ""
    echo -e "${CYAN}Arguments:${NC}"
    echo "  project-name       Name of the project directory to create"
    echo ""
    echo -e "${CYAN}Options:${NC}"
    echo "  --type=TYPE        Structure type: data-science, blank (default: data-science)"
    echo "  --guided           Show detailed explanations for beginners"
    echo "  --force            Overwrite existing directory"
    echo "  -h, --help         Show this help message"
    echo ""
    echo -e "${CYAN}Examples:${NC}"
    echo -e "  ${DIM}# Create data science project structure${NC}"
    echo "  dir-create my-project"
    echo ""
    echo -e "  ${DIM}# Create blank project directory${NC}"
    echo "  dir-create my-project --type=blank"
    echo ""
    echo -e "  ${DIM}# With guided explanations${NC}"
    echo "  dir-create my-project --guided"
    echo ""
    echo -e "${YELLOW}Structure Types:${NC}"
    echo -e "  ${BOLD}data-science${NC} - Organized ML/DS folders (recommended)"
    echo "    data/{raw,processed,external}/"
    echo "    models/checkpoints/"
    echo "    notebooks/"
    echo "    scripts/"
    echo "    configs/"
    echo "    outputs/{logs,figures}/"
    echo "    tests/"
    echo ""
    echo -e "  ${BOLD}blank${NC} - Empty directory for custom structure"
    echo ""
}

# Parse arguments
PROJECT_NAME=""
STRUCTURE_TYPE="data-science"
GUIDED=false
FORCE=false

while [[ $# -gt 0 ]]; do
    case $1 in
        --type=*)
            STRUCTURE_TYPE="${1#*=}"
            shift
            ;;
        --guided)
            GUIDED=true
            shift
            ;;
        --force)
            FORCE=true
            shift
            ;;
        -h|--help|--info)
            usage
            exit 0
            ;;
        -*)
            echo -e "${RED}‚úó Unknown option: $1${NC}\n"
            usage
            exit 1
            ;;
        *)
            if [ -z "$PROJECT_NAME" ]; then
                PROJECT_NAME="$1"
            else
                echo -e "${RED}‚úó Too many arguments${NC}\n"
                usage
                exit 1
            fi
            shift
            ;;
    esac
done

# Validate project name
if [ -z "$PROJECT_NAME" ]; then
    echo -e "${RED}‚úó Project name required${NC}\n"
    usage
    exit 1
fi

# Validate structure type
if [ "$STRUCTURE_TYPE" != "data-science" ] && [ "$STRUCTURE_TYPE" != "blank" ]; then
    echo -e "${RED}‚úó Invalid structure type: $STRUCTURE_TYPE${NC}"
    echo -e "  Valid types: data-science, blank\n"
    usage
    exit 1
fi

PROJECT_DIR="$WORKSPACE_DIR/$PROJECT_NAME"

# Show guided introduction
if [ "$GUIDED" = true ]; then
    echo ""
    echo -e "${BOLD}What is a Project Directory?${NC}"
    echo ""
    echo "  Your project directory is where all your work lives:"
    echo "  ‚Ä¢ Code, notebooks, and scripts"
    echo "  ‚Ä¢ Data and trained models"
    echo "  ‚Ä¢ Configuration files"
    echo "  ‚Ä¢ Research outputs and visualizations"
    echo ""
    echo -e "${BOLD}Why Use a Standard Structure?${NC}"
    echo ""
    echo "  A well-organized structure helps you:"
    echo "  ‚Ä¢ Find files quickly"
    echo "  ‚Ä¢ Collaborate with others easily"
    echo "  ‚Ä¢ Follow ML/DS best practices"
    echo "  ‚Ä¢ Keep raw data separate from processed data"
    echo "  ‚Ä¢ Track experiments and results"
    echo ""

    if [ "$STRUCTURE_TYPE" = "data-science" ]; then
        echo -e "${BOLD}Data Science Structure:${NC}"
        echo ""
        echo -e "  ${CYAN}data/${NC}"
        echo "    ‚îú‚îÄ‚îÄ raw/          Original, immutable data"
        echo "    ‚îú‚îÄ‚îÄ processed/    Cleaned, transformed data"
        echo "    ‚îî‚îÄ‚îÄ external/     Third-party data sources"
        echo ""
        echo -e "  ${CYAN}models/${NC}"
        echo "    ‚îî‚îÄ‚îÄ checkpoints/  Trained model weights"
        echo ""
        echo -e "  ${CYAN}notebooks/${NC}     Jupyter notebooks for exploration"
        echo -e "  ${CYAN}scripts/${NC}       Python/bash scripts for automation"
        echo -e "  ${CYAN}configs/${NC}       Configuration files (YAML, JSON)"
        echo ""
        echo -e "  ${CYAN}outputs/${NC}"
        echo "    ‚îú‚îÄ‚îÄ logs/         Training logs, metrics"
        echo "    ‚îî‚îÄ‚îÄ figures/      Plots, visualizations"
        echo ""
        echo -e "  ${CYAN}tests/${NC}         Unit tests for your code"
        echo ""
        echo -e "${YELLOW}üí° Tip:${NC} Empty directories include .gitkeep files so Git tracks them"
        echo ""
    else
        echo -e "${BOLD}Blank Structure:${NC}"
        echo ""
        echo "  Just an empty directory - you set up your own structure."
        echo "  Useful if you have a specific organization in mind."
        echo ""
    fi

    read -p "Press Enter to create the directory structure..." </dev/tty
    echo ""
fi

# TODO: only show this header in GUI mode i.e. run without args (if run with args -> no GUI, no header etc, just confirmatory output)
if [ "$GUIDED" = false ]; then
fi

# Check for existing directory
if [ -d "$PROJECT_DIR" ]; then
    if [ "$FORCE" = true ]; then
        echo -e "${YELLOW}‚ö† Directory exists, forcing recreation${NC}"
        rm -rf "$PROJECT_DIR"
    else
        echo -e "${RED}‚úó Directory already exists: $PROJECT_DIR${NC}"
        echo ""
        echo "Options:"
        echo "  ‚Ä¢ Use a different project name"
        echo "  ‚Ä¢ Use --force to overwrite (WARNING: deletes existing files)"
        echo "  ‚Ä¢ Remove manually: rm -rf $PROJECT_DIR"
        echo ""
        exit 1
    fi
fi

# Create directory structure
echo ""
echo -e "${BOLD}Creating Directory Structure${NC}"
echo ""

mkdir -p "$PROJECT_DIR"

if [ "$STRUCTURE_TYPE" = "blank" ]; then
    # Blank directory
    echo -e "${GREEN}‚úì Blank directory created${NC}"
    echo -e "  Location: ${BLUE}$PROJECT_DIR${NC}"

elif [ "$STRUCTURE_TYPE" = "data-science" ]; then
    # Data science structure
    mkdir -p "$PROJECT_DIR"/{data/{raw,processed,external},models/checkpoints,notebooks,scripts,configs,outputs/{logs,figures},tests}

    # Create .gitkeep files to preserve empty directories in Git
    touch "$PROJECT_DIR/data/raw/.gitkeep"
    touch "$PROJECT_DIR/data/processed/.gitkeep"
    touch "$PROJECT_DIR/data/external/.gitkeep"
    touch "$PROJECT_DIR/models/checkpoints/.gitkeep"
    touch "$PROJECT_DIR/outputs/logs/.gitkeep"
    touch "$PROJECT_DIR/outputs/figures/.gitkeep"

    echo -e "${GREEN}‚úì Data science structure created${NC}"
    echo -e "  Location: ${BLUE}$PROJECT_DIR${NC}"
fi

echo ""

# Show created structure
if [ "$GUIDED" = true ]; then
    echo -e "${CYAN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
    echo -e "${BOLD}Directory Structure Created${NC}"
    echo -e "${CYAN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
    echo ""
    echo -e "${BOLD}What Just Happened?${NC}"
    echo ""
    echo "  ‚úì Created project directory: $PROJECT_NAME"

    if [ "$STRUCTURE_TYPE" = "data-science" ]; then
        echo "  ‚úì Set up organized folder structure"
        echo "  ‚úì Added .gitkeep files for Git tracking"
    else
        echo "  ‚úì Created blank directory for custom structure"
    fi

    echo ""
    echo -e "${BOLD}Next Steps:${NC}"
    echo ""
    echo "  1) Navigate to your project:"
    echo -e "     ${GREEN}cd $PROJECT_DIR${NC}"
    echo ""
    echo "  2) Initialize Git repository:"
    echo -e "     ${GREEN}git-init $PROJECT_NAME${NC}"
    echo ""
    echo "  3) Create README and requirements:"
    echo -e "     ${GREEN}readme-create $PROJECT_NAME${NC}"
    echo ""
    echo "  4) Or run full project setup:"
    echo -e "     ${GREEN}project-init $PROJECT_NAME${NC}"
    echo ""
else

fi

exit 0
