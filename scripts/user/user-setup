#!/bin/bash
# DS01 User Setup Wizard - L4 Wizard
# Complete onboarding orchestrator with skill-adaptive flow
# Orchestrates: skill-assessment → ssh-setup → project-init → vscode-setup → jupyter-setup → onboarding-create
# File: /opt/ds01-infra/scripts/user/user-setup

set -e

# Source DS01 context library
if [[ -f "/opt/ds01-infra/scripts/lib/ds01-context.sh" ]]; then
    source /opt/ds01-infra/scripts/lib/ds01-context.sh
fi

# Source skill assessment library
if [[ -f "/opt/ds01-infra/scripts/lib/skill-assessment.sh" ]]; then
    source /opt/ds01-infra/scripts/lib/skill-assessment.sh
fi

# Set orchestration context - suppresses atomic command "Next steps" output
export DS01_CONTEXT="orchestration"
export DS01_INTERFACE="orchestration"

# Colors
BLUE='\033[0;36m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
CYAN='\033[0;36m'
BOLD='\033[1m'
DIM='\033[2m'
NC='\033[0m'

USERNAME=$(whoami)
USER_ID=$(id -u)
GROUP_ID=$(id -g)

# Parse command line arguments
QUICK_MODE=false
SKIP_SKILL_ASSESSMENT=false

for arg in "$@"; do
    case $arg in
        --quick)
            QUICK_MODE=true
            SKIP_SKILL_ASSESSMENT=true
            # Set expert levels
            export DS01_SKILL_REMOTE=2
            export DS01_SKILL_GIT=2
            export DS01_SKILL_HPC=2
            shift
            ;;
        -h|--help)
            echo -e ""
            echo -e "${BOLD}DS01 User Setup Wizard${NC}"
            echo -e ""
            echo -e "${CYAN}Usage:${NC}"
            echo -e "  user-setup [options]"
            echo -e ""
            echo -e "${CYAN}Options:${NC}"
            echo -e "  --quick     Expert mode: skip skill assessment, minimal prompts"
            echo -e "  -h, --help  Show this help message"
            echo -e ""
            echo -e "${CYAN}Description:${NC}"
            echo -e "  Complete onboarding wizard for new DS01 users."
            echo -e "  Adapts to your experience level with SSH, Git, and containers."
            echo -e "  Sets up SSH keys, creates first project, configures VS Code."
            echo -e ""
            exit 0
            ;;
        *)
            ;;
    esac
done

# Logo
cat << "EOF"
    ____  ____  ____  ____
   / __ \/ ___\/ __ \/_ _ |
  / / / /\__ \/ / / /   | |
 / /_/ /___/ / /_/ /    | |
/_____/_____/\____/     |_/ Hertie's HPC Server

EOF

echo -e "${GREEN}${BOLD}Onboarding & Setup Wizard${NC}\n"

# ============================================================================
# SKILL ASSESSMENT (only if not in quick mode)
# ============================================================================

if [ "$SKIP_SKILL_ASSESSMENT" = false ]; then
    echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "${BOLD}Welcome to DS01!${NC}"
    echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e ""
    echo -e "Before we begin, let's understand your experience level"
    echo -e "so we can tailor the setup process for you."
    echo -e ""

    # Run skill assessment (sets DS01_SKILL_* environment variables)
    if type ask_skill_levels &>/dev/null; then
        ask_skill_levels
    else
        # Fallback if library not available - assume beginner
        echo -e "${YELLOW}Note:${NC} Skill assessment library not found, using guided mode."
        export DS01_SKILL_REMOTE=0
        export DS01_SKILL_GIT=0
        export DS01_SKILL_HPC=0
        read -p "Press Enter to continue..." </dev/tty
    fi
    echo -e ""
fi

# Helper functions for skill-aware output
is_beginner() {
    local area="${1:-REMOTE}"
    case "$area" in
        REMOTE) [[ "${DS01_SKILL_REMOTE:-0}" == "0" ]] ;;
        GIT)    [[ "${DS01_SKILL_GIT:-0}" == "0" ]] ;;
        HPC)    [[ "${DS01_SKILL_HPC:-0}" == "0" ]] ;;
    esac
}

is_expert() {
    local area="${1:-REMOTE}"
    case "$area" in
        REMOTE) [[ "${DS01_SKILL_REMOTE:-0}" == "2" ]] ;;
        GIT)    [[ "${DS01_SKILL_GIT:-0}" == "2" ]] ;;
        HPC)    [[ "${DS01_SKILL_HPC:-0}" == "2" ]] ;;
    esac
}

# ============================================================================
# INTRODUCTION (skill-aware)
# ============================================================================

if is_beginner "HPC"; then
    echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "${BOLD}How DS01 Works${NC}"
    echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e ""
    echo -e "DS01 uses ${CYAN}containers${NC} - think of them like separate computers"
    echo -e "that you can create, use, and throw away:"
    echo -e ""
    echo -e "  ${CYAN}Your Workspace${NC} (~/workspace/)"
    echo -e "    └── Files you save here are ${GREEN}permanent${NC}"
    echo -e "    └── Like your \"hard drive\" - always safe"
    echo -e ""
    echo -e "  ${CYAN}Containers${NC}"
    echo -e "    └── Temporary computing environments with GPU access"
    echo -e "    └── Like a \"laptop\" you can turn on/off"
    echo -e "    └── Can be recreated anytime from your settings"
    echo -e ""
    echo -e "  ${BOLD}Key Insight:${NC} Your work (files) survives even when"
    echo -e "  you delete/recreate containers. This is intentional!"
    echo -e ""
    read -p "Press Enter to continue..." </dev/tty
    echo -e ""

    echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "${BOLD}Resource Limits${NC}"
    echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e ""
    echo -e "DS01 is a shared server, so each user has limits:"
    echo -e ""
    echo -e "  ${CYAN}•${NC} GPU / MIG (Multi-Instance GPUs) allocation"
    echo -e "  ${CYAN}•${NC} Number of containers you can run"
    echo -e "  ${CYAN}•${NC} Memory and CPU per container"
    echo -e ""
    echo -e "Currently we're offering 1-2 GPUs across multiple MIGs per user, but this will change dynamically"
    echo -e "Run ${GREEN}check-limits${NC} anytime to see your quotas."
    echo -e ""
    read -p "Press Enter to continue..." </dev/tty
    echo -e ""
fi

echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo -e "${BOLD}Setup Overview${NC}"
echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo -e ""
echo -e "This wizard will help you:"
echo -e ""
echo -e "  ${GREEN}1.${NC} Generate SSH keys - secure remote access"
echo -e "  ${GREEN}2.${NC} Setup your first ds01 project - directory structure + Git"
echo -e "  ${GREEN}3.${NC} Build Docker images - your custom environment"
echo -e "  ${GREEN}4.${NC} Deploy Containers - GPU-enabled compute environments"
echo -e "  ${GREEN}5.${NC} Configure VS Code for remote dev - connecting your IDE to a running container"
echo -e "  ${GREEN}6.${NC} Run Jupyter - Lab & Hub; notebook access via ports etc"
echo -e ""

if is_beginner "REMOTE"; then
    echo -e "${YELLOW}Note:${NC} We'll explain each step as we go."
    echo -e ""
fi

read -p "Press Enter to begin setup..." </dev/tty
echo -e ""

# ============================================================================
# STEP 1: CHECK CURRENT STATUS
# ============================================================================

echo -e "${CYAN}━━━ Step 1: Checking Your Setup ━━━${NC}\n"

NEEDS_SSH=false
NEEDS_PROJECT=false
HAS_DOCKER_ACCESS=false

# Check SSH keys
if [ ! -f ~/.ssh/id_ed25519.pub ]; then
    NEEDS_SSH=true
    echo -e "${YELLOW}○${NC} SSH keys not configured"
else
    echo -e "${GREEN}✓${NC} SSH keys configured"
fi

# Check if user has any projects
if [ ! -d ~/workspace ] || [ -z "$(ls -A ~/workspace 2>/dev/null)" ]; then
    NEEDS_PROJECT=true
    echo -e "${YELLOW}○${NC} No projects found"
else
    PROJECT_COUNT=$(ls -1 ~/workspace 2>/dev/null | wc -l)
    echo -e "${GREEN}✓${NC} Workspace exists: ~/workspace ($PROJECT_COUNT project(s))"
fi

# Check Docker access
if timeout 2 docker info &>/dev/null; then
    HAS_DOCKER_ACCESS=true
    USER_IMAGES=$(docker images --format "{{.Repository}}" 2>/dev/null | grep -c "^ds01-${USER_ID}/" 2>/dev/null || true)
    USER_IMAGES=${USER_IMAGES:-0}
    # Ensure it's a valid integer
    if ! [[ "$USER_IMAGES" =~ ^[0-9]+$ ]]; then
        USER_IMAGES=0
    fi
    if [ "$USER_IMAGES" -eq 0 ]; then
        echo -e "${YELLOW}○${NC} No custom images yet (will create one)"
    else
        echo -e "${GREEN}✓${NC} $USER_IMAGES custom image(s) found"
    fi
else
    HAS_DOCKER_ACCESS=false
    echo -e "${YELLOW}○${NC} Docker access (will be configured)"
fi

echo -e ""
read -p "Press Enter to continue..." </dev/tty

# If everything is already set up
if [ "$NEEDS_SSH" = false ] && [ "$NEEDS_PROJECT" = false ] && [ "$HAS_DOCKER_ACCESS" = true ]; then
    echo -e "${GREEN}${BOLD}✓ You're already set up!${NC}"
    echo -e ""
    echo -e "Everything looks good. You can:"
    echo -e "  • Create more projects: ${GREEN}project-init${NC}"
    echo -e "  • View your containers: ${GREEN}container-list${NC}"
    echo -e "  • Check your limits: ${GREEN}check-limits${NC}"
    echo -e ""

    # Clear any buffered input before prompting
    read -r -t 0.1 -n 10000 discard </dev/tty 2>/dev/null || true

    # Force user to answer
    echo -n "Run full wizard anyway? [y/N]: "
    read -r RUN_ANYWAY </dev/tty

    if [[ ! "$RUN_ANYWAY" =~ ^[Yy]$ ]]; then
        echo -e ""
        echo -e "${GREEN}Tip:${NC} Run ${CYAN}user-setup${NC} again anytime to revisit setup."
        echo -e ""
        exit 0
    fi
    echo -e ""
fi

# ============================================================================
# STEP 2: SSH KEY SETUP
# ============================================================================

echo -e ""
echo -e "${CYAN}━━━ Step 2: SSH Key Setup ━━━${NC}\n"

if [ "$NEEDS_SSH" = true ]; then
    # Pass skill level to ssh-setup via environment variable
    ssh-setup
else
    # Always offer to revisit SSH setup
    echo -e "SSH keys are already configured."
    echo -e ""

    if is_beginner "REMOTE"; then
        echo -e "${YELLOW}Need to:${NC}"
        echo -e "  • Copy your private key to another device?"
        echo -e "  • Regenerate your keys?"
        echo -e "  • Review VS Code SSH config?"
        echo -e ""
    fi

    # Clear any buffered input before prompting
    read -r -t 0.1 -n 10000 discard </dev/tty 2>/dev/null || true

    # Force user to answer - don't allow auto-skip
    echo -n "Review SSH setup? [y/N]: "
    read -r REVIEW_SSH </dev/tty

    if [[ "$REVIEW_SSH" =~ ^[Yy]$ ]]; then
        ssh-setup
    else
        echo -e "${GREEN}✓ Skipped${NC} - Using existing keys"
        echo ""
        # Always show key location info
        SERVER_IP=$(hostname -I | awk '{print $1}')
        echo -e "${BOLD}Quick Reference - SSH Key Location:${NC}"
        echo -e "  Private key: ${CYAN}~/.ssh/id_ed25519${NC}"
        echo ""
        echo -e "${BOLD}Copy to your local machine:${NC}"
        echo -e "  ${GREEN}scp ${USERNAME}@${SERVER_IP}:~/.ssh/id_ed25519 ~/.ssh/ds01_id_ed25519${NC}"
        echo -e "  ${GREEN}chmod 600 ~/.ssh/ds01_id_ed25519${NC}"
        echo ""
        echo -e "${BOLD}Add to local ~/.ssh/config:${NC}"
        echo -e "  ${CYAN}Host ds01${NC}"
        echo -e "  ${CYAN}    HostName ${SERVER_IP}${NC}"
        echo -e "  ${CYAN}    User ${USERNAME}${NC}"
        echo -e "  ${CYAN}    IdentityFile ~/.ssh/ds01_id_ed25519${NC}"
    fi
fi

# ============================================================================
# STEP 3: PROJECT SETUP
# ============================================================================

echo -e ""
echo -e "${CYAN}━━━ Step 3: Project Setup ━━━${NC}\n"

CREATE_PROJECT=true
PROJECT_NAME=""

if [ "$NEEDS_PROJECT" = false ]; then
    echo -e "You already have project(s) in ~/workspace"
    echo -e ""

    # Clear any buffered input before prompting
    read -r -t 0.1 -n 10000 discard </dev/tty 2>/dev/null || true

    # Force user to answer
    echo -n "Create a new project anyway? [Y/n]: "
    read -r CREATE_NEW </dev/tty
    CREATE_NEW=${CREATE_NEW:-Y}

    if [[ ! "$CREATE_NEW" =~ ^[Yy]$ ]]; then
        CREATE_PROJECT=false
        echo -e "${YELLOW}Skipped${NC} - Using existing projects"

        # Ask which project to use for VS Code setup
        echo -e ""
        echo -e "Select a project for VS Code setup:"
        PROJECTS=($(ls ~/workspace 2>/dev/null))
        for i in "${!PROJECTS[@]}"; do
            echo -e "  $((i+1))) ${PROJECTS[$i]}"
        done
        read -p "Choice [1-${#PROJECTS[@]}]: " PROJECT_CHOICE </dev/tty
        if [ -n "$PROJECT_CHOICE" ] && [ "$PROJECT_CHOICE" -ge 1 ] && [ "$PROJECT_CHOICE" -le "${#PROJECTS[@]}" ]; then
            PROJECT_NAME="${PROJECTS[$((PROJECT_CHOICE-1))]}"
        fi
    fi
fi

if [ "$CREATE_PROJECT" = true ]; then
    if is_beginner "HPC"; then
        echo -e "Let's create your first project!"
        echo -e ""
        echo -e "This will set up:"
        echo -e "  • Project directory with standard structure"
        echo -e "  • Git version control"
        echo -e "  • Docker image for your environment"
        echo -e "  • Running container with GPU access"
        echo -e ""
        read -p "Press Enter to continue..." </dev/tty
        echo ""
    fi

    # Call project-init (L4 wizard - handles its own skill awareness)
    project-init

    # Capture project name from last created project
    if [ -d ~/workspace ]; then
        PROJECT_NAME=$(ls -t ~/workspace | head -1)
    fi
fi

# ============================================================================
# STEP 4: VS CODE SETUP
# ============================================================================

echo -e ""
echo -e "${CYAN}━━━ Step 4: VS Code Connection ━━━${NC}\n"

# Call vscode-setup with project info
PROJECT_FLAG=""
if [ -n "$PROJECT_NAME" ]; then
    PROJECT_FLAG="--project=$PROJECT_NAME"
fi

vscode-setup $PROJECT_FLAG

# ============================================================================
# STEP 5: JUPYTER SETUP (brief)
# ============================================================================

echo -e ""
echo -e "${CYAN}━━━ Step 5: Jupyter Access ━━━${NC}\n"

jupyter-setup --brief

# ============================================================================
# STEP 6: CREATE ONBOARDING DOCUMENT
# ============================================================================

echo -e ""
echo -e "${CYAN}━━━ Step 6: Creating Reference Documents ━━━${NC}\n"

onboarding-create

# ============================================================================
# FINAL SUMMARY
# ============================================================================

echo -e ""
echo -e "${GREEN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo -e "${GREEN}${BOLD}✓ Onboarding Complete!${NC}"
echo -e "${GREEN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo -e ""

echo -e "${BOLD}What You've Set Up:${NC}"
echo -e ""
echo -e "  ${GREEN}✓${NC} SSH keys for remote access"
if [ -n "$PROJECT_NAME" ]; then
    echo -e "  ${GREEN}✓${NC} Project: $PROJECT_NAME"
    echo -e "  ${GREEN}✓${NC} Docker image built"
    echo -e "  ${GREEN}✓${NC} Container deployed"
fi
echo -e "  ${GREEN}✓${NC} VS Code connection configured"
echo -e "  ${GREEN}✓${NC} Onboarding guide at ~/ONBOARDING.md"
echo -e ""

echo -e "${BOLD}Next Steps:${NC}"
echo -e ""
echo -e "  ${CYAN}1.${NC} Connect VS Code to DS01"
echo -e "     • Command Palette → 'Remote-SSH: Connect to Host' → 'ds01'"
echo -e ""

if [ -n "$PROJECT_NAME" ]; then
    echo -e "  ${CYAN}2.${NC} Open your project"
    echo -e "     • File → Open Folder → ${CYAN}/home/$USERNAME/workspace/$PROJECT_NAME${NC}"
    echo -e ""

    echo -e "  ${CYAN}3.${NC} Attach to your container"
    echo -e "     • Terminal: ${GREEN}container attach $PROJECT_NAME${NC}"
    echo -e "     • Or use Dev Containers extension"
    echo -e ""
fi

echo -e "${BOLD}Helpful Commands:${NC}"
echo -e ""
echo -e "   ${CYAN}container deploy <name>${NC}   Deploy a new container"
echo -e "   ${CYAN}container attach <name>${NC}   Enter a running container"
echo -e "   ${CYAN}container retire <name>${NC}   Stop and remove container"
echo -e "   ${CYAN}container-list${NC}            See all your containers"
echo -e "   ${CYAN}check-limits${NC}              View your resource quotas"
echo -e "   ${CYAN}project-init${NC}              Create another project"
echo -e ""

echo -e "${BOLD}Documentation:${NC}"
echo -e ""
echo -e "   ${CYAN}~/ONBOARDING.md${NC}           Quick reference guide"
if [ -n "$PROJECT_NAME" ] && [ -f ~/workspace/$PROJECT_NAME/README.md ]; then
    echo -e "   ${CYAN}~/workspace/$PROJECT_NAME/README.md${NC}"
fi
echo -e "   https://github.com/hertie-data-science-lab/ds01-user-docs"
echo -e ""

echo -e "${GREEN}Welcome to DS01! Happy computing!${NC}"
echo -e ""
