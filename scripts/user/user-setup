#!/bin/bash
# DS01 User Setup Wizard - Complete onboarding orchestrator
# Tier 4 Wizard - Orchestrates: ssh-setup â†’ project-init â†’ vscode-setup
# File: /opt/ds01-infra/scripts/user/user-setup

set -e

BLUE='\033[0;36m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
CYAN='\033[0;36m'
BOLD='\033[1m'
DIM='\033[2m'
NC='\033[0m'

USERNAME=$(whoami)
USER_ID=$(id -u)
GROUP_ID=$(id -g)

# Parse command line arguments
GUIDED=true  # Default to guided mode for user-setup

for arg in "$@"; do
    case $arg in
        --guided)
            GUIDED=true
            shift
            ;;
        --quick)
            GUIDED=false
            shift
            ;;
        -h|--help)
            echo ""
            echo -e "${BOLD}DS01 User Setup Wizard${NC}"
            echo ""
            echo -e "${CYAN}Usage:${NC}"
            echo "  user-setup [options]"
            echo ""
            echo -e "${CYAN}Options:${NC}"
            echo "  --guided    Full guided mode with explanations (default)"
            echo "  --quick     Quick mode without detailed explanations"
            echo "  -h, --help  Show this help message"
            echo ""
            echo -e "${CYAN}Description:${NC}"
            echo "  Complete onboarding wizard for new DS01 users."
            echo "  Sets up SSH keys, creates first project, configures VS Code."
            echo ""
            exit 0
            ;;
        *)
            ;;
    esac
done

# Logo
cat << "EOF"
    ____  ____  ____  ____
   / __ \/ ___\/ __ \/_ _ |
  / / / /\__ \/ / / /   | |
 / /_/ /___/ / /_/ /    | |
/_____/_____/\____/     |_/ Hertie's HPC Server

EOF

echo -e "${GREEN}${BOLD}Onboarding & Setup Wizard${NC}\n"

if [ "$GUIDED" = true ]; then
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${BOLD}Welcome to DS01!${NC}"
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
    echo "This wizard will help you set up everything you need:"
    echo ""
    echo -e "  ${GREEN}âœ“${NC} SSH keys for secure remote access"
    echo -e "  ${GREEN}âœ“${NC} Your first project with proper ML/DS repo structure and version control"
    echo -e "  ${GREEN}âœ“${NC} Custom Docker image with your tools"
    echo -e "  ${GREEN}âœ“${NC} GPU-enabled container for computing"
    echo -e "  ${GREEN}âœ“${NC} VS Code connection for easy development"
    echo ""
    echo -e "${YELLOW}ğŸ’¡ Tip:${NC} This takes about 10-15 minutes to complete."
    echo ""
    read -p "Press Enter to begin..." </dev/tty
    echo ""
fi

# Step 1: Check setup status
echo -e "${CYAN}â”â”â” Step 1: Checking Your Setup â”â”â”${NC}\n"

NEEDS_SSH=false
NEEDS_PROJECT=false
HAS_DOCKER_ACCESS=false

# Check SSH keys
if [ ! -f ~/.ssh/id_ed25519.pub ]; then
    NEEDS_SSH=true
    echo -e "${YELLOW}âœ—${NC} SSH keys not configured"
else
    echo -e "${GREEN}âœ“${NC} SSH keys configured"
fi

# Check if user has any projects
if [ ! -d ~/workspace ] || [ -z "$(ls -A ~/workspace 2>/dev/null)" ]; then
    NEEDS_PROJECT=true
    echo -e "${YELLOW}âœ—${NC} No projects found"
else
    PROJECT_COUNT=$(ls -1 ~/workspace 2>/dev/null | wc -l)
    echo -e "${GREEN}âœ“${NC} Workspace exists: ~/workspace ($PROJECT_COUNT project(s))"
fi

# Check Docker access
if timeout 2 docker info &>/dev/null; then
    HAS_DOCKER_ACCESS=true
    USER_IMAGES=$(docker images --format "{{.Repository}}" 2>/dev/null | grep "^${USERNAME}-" | wc -l)
    if [ "$USER_IMAGES" -eq 0 ]; then
        echo -e "${YELLOW}â—‹${NC} No custom images yet (will create one)"
    else
        echo -e "${GREEN}âœ“${NC} $USER_IMAGES custom image(s) found"
    fi
else
    HAS_DOCKER_ACCESS=false
    echo -e "${YELLOW}â—‹${NC} Docker access (will be configured during setup)"
fi

echo ""

if [ "$NEEDS_SSH" = false ] && [ "$NEEDS_PROJECT" = false ] && [ "$HAS_DOCKER_ACCESS" = true ]; then
    echo -e "${GREEN}${BOLD}âœ“ You're already set up!${NC}"
    echo ""
    echo "Everything looks good. You can:"
    echo -e "  â€¢ Create more projects: ${GREEN}project-init --guided${NC}"
    echo -e "  â€¢ View your containers: ${GREEN}container-list${NC}"
    echo -e "  â€¢ See VS Code setup: ${GREEN}vscode-setup${NC}"
    echo ""
    read -p "Run full wizard anyway? [y/N]: " RUN_ANYWAY
    if [[ ! "$RUN_ANYWAY" =~ ^[Yy]$ && -n "$RUN_ANYWAY" ]]; then
    exit 0
    fi
    echo ""
fi

# Step 2: SSH Key Setup
if [ "$NEEDS_SSH" = true ]; then
    echo ""
    echo -e "${CYAN}â”â”â” Step 2: SSH Key Setup â”â”â”${NC}\n"

    # Call Tier 2 module: ssh-setup
    GUIDED_FLAG=""
    if [ "$GUIDED" = true ]; then
        GUIDED_FLAG="--guided"
    fi

    ssh-setup $GUIDED_FLAG
else
    echo ""
    echo -e "${CYAN}â”â”â” Step 2: SSH Key Setup â”â”â”${NC}\n"
    echo -e "${GREEN}âœ“ Skipped${NC} - SSH keys already configured"
    echo ""
fi

# Step 3: Project Setup
echo ""
echo -e "${CYAN}â”â”â” Step 3: Project Setup â”â”â”${NC}\n"

CREATE_PROJECT=true
PROJECT_NAME=""

if [ "$NEEDS_PROJECT" = false ]; then
    echo "You already have project(s) in ~/workspace"
    echo ""
    read -p "Create a new project anyway? [Y/n]: " CREATE_NEW
    CREATE_NEW=${CREATE_NEW:-Y}
    if [[ ! "$CREATE_NEW" =~ ^[Yy]$ ]]; then
        CREATE_PROJECT=false
        echo -e "${YELLOW}Skipped${NC} - Using existing projects"

        # Ask which project to use for VS Code setup
        echo ""
        echo "Select a project for VS Code setup:"
        PROJECTS=($(ls ~/workspace 2>/dev/null))
        for i in "${!PROJECTS[@]}"; do
            echo "  $((i+1))) ${PROJECTS[$i]}"
        done
        read -p "Choice [1-${#PROJECTS[@]}]: " PROJECT_CHOICE
        if [ -n "$PROJECT_CHOICE" ] && [ "$PROJECT_CHOICE" -ge 1 ] && [ "$PROJECT_CHOICE" -le "${#PROJECTS[@]}" ]; then
            PROJECT_NAME="${PROJECTS[$((PROJECT_CHOICE-1))]}"
        fi
    fi
fi

if [ "$CREATE_PROJECT" = true ]; then
    echo "Let's create your first project!"
    echo ""

    # Call Tier 3 orchestrator: project-init
    GUIDED_FLAG=""
    if [ "$GUIDED" = true ]; then
        GUIDED_FLAG="--guided"
    fi

    project-init $GUIDED_FLAG

    # Capture project name from last created project
    if [ -d ~/workspace ]; then
        PROJECT_NAME=$(ls -t ~/workspace | head -1)
    fi
fi

# Step 4: VS Code Setup
echo ""
echo -e "${CYAN}â”â”â” Step 4: VS Code Connection â”â”â”${NC}\n"

# Call Tier 2 module: vscode-setup
GUIDED_FLAG=""
PROJECT_FLAG=""
if [ "$GUIDED" = true ]; then
    GUIDED_FLAG="--guided"
fi
if [ -n "$PROJECT_NAME" ]; then
    PROJECT_FLAG="--project=$PROJECT_NAME"
fi

vscode-setup $GUIDED_FLAG $PROJECT_FLAG

# Final Summary
echo ""
echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${GREEN}${BOLD}âœ“ Onboarding Complete!${NC}"
echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""

echo -e "${BOLD}What You've Set Up:${NC}"
echo ""
echo -e "  ${GREEN}âœ“${NC} SSH keys for remote access"
if [ -n "$PROJECT_NAME" ]; then
    echo -e "  ${GREEN}âœ“${NC} Project: $PROJECT_NAME"
    echo -e "  ${GREEN}âœ“${NC} Dockerfile written"
    echo -e "  ${GREEN}âœ“${NC} Docker image built"
    echo -e "  ${GREEN}âœ“${NC} Container created & deployed"
else
fi
echo -e "  ${GREEN}âœ“${NC} VS Code connection configured"
echo ""

echo -e "${YELLOW}${BOLD}â”â”â” Your Next Steps â”â”â”${NC}\n"

echo -e "${BOLD}1. Connect VS Code to DS01${NC}"
echo "   â€¢ Open VS Code on your computer"
echo "   â€¢ Command Palette â†’ 'Remote-SSH: Connect to Host'"
echo "   â€¢ Select 'ds01'"
echo ""

if [ -n "$PROJECT_NAME" ]; then
    echo -e "${BOLD}2. Open your project${NC}"
    echo -e "   â€¢ In VS Code: File â†’ Open Folder"
    echo -e "   â€¢ Navigate to: ${CYAN}/home/$USERNAME/workspace/$PROJECT_NAME${NC}"
    echo ""

    echo -e "${BOLD}3. Start working in your container${NC}"
    echo "   â€¢ Open terminal in VS Code (Ctrl+\`)"
    echo -e "   â€¢ Enter container: ${GREEN}container-run $PROJECT_NAME${NC}"
    echo -e "   â€¢ Navigate to project: ${GREEN}cd /workspace/$PROJECT_NAME${NC}"
    echo ""
fi

echo -e "${CYAN}ğŸ’¡ Helpful Commands:${NC}"
echo -e "   ${CYAN}alias-list${NC}           # See all available commands"
echo -e "   ${CYAN}vscode-setup${NC}          # Re-run VS Code setup instructions"
echo -e "   ${CYAN}ssh-setup${NC}            # Re-run SSH key setup"
echo -e "   ${CYAN}project-init${NC}         # Create another project"
echo -e "   ${CYAN}user-setup${NC}           # Run this wizard again"
echo ""

echo -e "${YELLOW}ğŸ“– Documentation:${NC}"
echo "   /home/shared/docs/getting-started.md"
echo "   /home/shared/docs/gpu-usage-guide.md"
if [ -n "$PROJECT_NAME" ] && [ -f ~/workspace/$PROJECT_NAME/README.md ]; then
    echo -e "   ${CYAN}~/workspace/$PROJECT_NAME/README.md${NC} (your project guide)"
fi
echo ""

echo -e "${GREEN}Welcome to DS01! Happy computing! ğŸš€${NC}"
echo ""
