#!/bin/bash
# DS01 User Setup Wizard - L4 Wizard
# Complete onboarding orchestrator with skill-adaptive flow
# Orchestrates: skill-assessment → ssh-setup → project-init → vscode-setup → jupyter-setup → onboarding-create
# File: /opt/ds01-infra/scripts/user/user-setup

set -e

# Source DS01 context library
if [[ -f "/opt/ds01-infra/scripts/lib/ds01-context.sh" ]]; then
    source /opt/ds01-infra/scripts/lib/ds01-context.sh
fi

# Source skill assessment library
if [[ -f "/opt/ds01-infra/scripts/lib/skill-assessment.sh" ]]; then
    source /opt/ds01-infra/scripts/lib/skill-assessment.sh
fi

# Set orchestration context - suppresses atomic command "Next steps" output
export DS01_CONTEXT="orchestration"
export DS01_INTERFACE="orchestration"

# Colors
BLUE='\033[0;36m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
CYAN='\033[0;36m'
BOLD='\033[1m'
DIM='\033[2m'
NC='\033[0m'

USERNAME=$(whoami)
USER_ID=$(id -u)
GROUP_ID=$(id -g)

# Parse command line arguments
QUICK_MODE=false
SKIP_SKILL_ASSESSMENT=false

for arg in "$@"; do
    case $arg in
        --quick)
            QUICK_MODE=true
            SKIP_SKILL_ASSESSMENT=true
            # Set expert levels
            export DS01_SKILL_REMOTE=2
            export DS01_SKILL_GIT=2
            export DS01_SKILL_HPC=2
            shift
            ;;
        -h|--help)
            echo -e ""
            echo -e "${BOLD}DS01 User Setup Wizard${NC}"
            echo -e ""
            echo -e "${CYAN}Usage:${NC}"
            echo -e "  user-setup [options]"
            echo -e ""
            echo -e "${CYAN}Options:${NC}"
            echo -e "  --quick     Expert mode: skip skill assessment, minimal prompts"
            echo -e "  -h, --help  Show this help message"
            echo -e ""
            echo -e "${CYAN}Description:${NC}"
            echo -e "  Complete onboarding wizard for new DS01 users."
            echo -e "  Adapts to your experience level with SSH, Git, and containers."
            echo -e "  Sets up SSH keys, creates first project, configures VS Code."
            echo -e ""
            exit 0
            ;;
        *)
            ;;
    esac
done

# Logo
cat << "EOF"
    ____  ____  ____  ____
   / __ \/ ___\/ __ \/_ _ |
  / / / /\__ \/ / / /   | |
 / /_/ /___/ / /_/ /    | |
/_____/_____/\____/     |_/ Hertie's HPC Server

EOF

echo -e "${GREEN}${BOLD}Onboarding & Setup Wizard${NC}\n"

# ============================================================================
# SKILL ASSESSMENT (only if not in quick mode)
# ============================================================================

if [ "$SKIP_SKILL_ASSESSMENT" = false ]; then
    echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "${BOLD}Welcome to DS01!${NC}"
    echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e ""
    echo -e "Before we begin, let's understand your experience level"
    echo -e "so we can tailor the setup process for you."
    echo -e ""

    # Run skill assessment (sets DS01_SKILL_* environment variables)
    if type ask_skill_levels &>/dev/null; then
        ask_skill_levels
    else
        # Fallback if library not available - assume beginner
        echo -e "${YELLOW}Note:${NC} Skill assessment library not found, using guided mode."
        export DS01_SKILL_REMOTE=0
        export DS01_SKILL_GIT=0
        export DS01_SKILL_HPC=0
        read -p "Press Enter to continue..." </dev/tty
    fi
    echo -e ""
fi

# Helper functions for skill-aware output
is_beginner() {
    local area="${1:-REMOTE}"
    case "$area" in
        REMOTE) [[ "${DS01_SKILL_REMOTE:-0}" == "0" ]] ;;
        GIT)    [[ "${DS01_SKILL_GIT:-0}" == "0" ]] ;;
        HPC)    [[ "${DS01_SKILL_HPC:-0}" == "0" ]] ;;
    esac
}

is_expert() {
    local area="${1:-REMOTE}"
    case "$area" in
        REMOTE) [[ "${DS01_SKILL_REMOTE:-0}" == "2" ]] ;;
        GIT)    [[ "${DS01_SKILL_GIT:-0}" == "2" ]] ;;
        HPC)    [[ "${DS01_SKILL_HPC:-0}" == "2" ]] ;;
    esac
}

# ============================================================================
# INTRODUCTION (skill-aware)
# ============================================================================

if is_beginner "HPC"; then
    echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "${BOLD}How DS01 Works${NC}"
    echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e ""
    echo -e "DS01 uses ${CYAN}containers${NC} - think of them like separate computers"
    echo -e "that you can create, use, and throw away:"
    echo -e ""
    echo -e "  ${CYAN}Your Workspace${NC} (~/workspace/)"
    echo -e "    └── Files you save here are ${GREEN}permanent${NC}"
    echo -e "    └── Like your \"hard drive\" - always safe"
    echo -e ""
    echo -e "  ${CYAN}Containers${NC}"
    echo -e "    └── Temporary computing environments with GPU access"
    echo -e "    └── Like a \"laptop\" you can turn on/off"
    echo -e "    └── Can be recreated anytime from your settings"
    echo -e ""
    echo -e "  ${BOLD}Key Insight:${NC} Your work (files) survives even when"
    echo -e "  you delete/recreate containers. This is intentional!"
    echo -e ""
    read -p "Press Enter to continue..." </dev/tty
    echo -e ""

    echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "${BOLD}Resource Limits${NC}"
    echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e ""
    echo -e "DS01 is a shared server, so each user has limits:"
    echo -e ""
    echo -e "  ${CYAN}•${NC} GPU / MIG (Multi-Instance GPUs) allocation"
    echo -e "  ${CYAN}•${NC} Number of containers you can run"
    echo -e "  ${CYAN}•${NC} Memory and CPU per container"
    echo -e ""
    echo -e "Currently we're offering 1-2 GPUs across multiple MIGs per user, but this will change dynamically"
    echo -e "Run ${GREEN}check-limits${NC} anytime to see your quotas."
    echo -e ""
    read -p "Press Enter to continue..." </dev/tty
    echo -e ""
fi

echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo -e "${BOLD}Setup Overview${NC}"
echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo -e ""
echo -e "This wizard will help you:"
echo -e ""
echo -e "  ${GREEN}1.${NC} Generate SSH keys - secure remote access"
echo -e "  ${GREEN}2.${NC} Configure VS Code - extensions and SSH connection"
echo -e "  ${GREEN}3.${NC} Create reference documents - quick command guide"
echo -e ""
echo -e "After setup, run ${CYAN}project-init${NC} to create your first project."
echo -e ""

if is_beginner "REMOTE"; then
    echo -e "${YELLOW}Note:${NC} We'll explain each step as we go."
    echo -e ""
fi

read -p "Press Enter to begin setup..." </dev/tty
echo -e ""

# ============================================================================
# STEP 1: CHECK CURRENT STATUS
# ============================================================================

echo -e "${CYAN}━━━ Step 1: Checking Your Setup ━━━${NC}\n"

NEEDS_SSH=false
NEEDS_PROJECT=false
HAS_DOCKER_ACCESS=false

# Check SSH keys
if [ ! -f ~/.ssh/id_ed25519.pub ]; then
    NEEDS_SSH=true
    echo -e "${YELLOW}○${NC} SSH keys not configured"
else
    echo -e "${GREEN}✓${NC} SSH keys configured"
fi

# Check if user has any projects
if [ ! -d ~/workspace ] || [ -z "$(ls -A ~/workspace 2>/dev/null)" ]; then
    NEEDS_PROJECT=true
    echo -e "${YELLOW}○${NC} No projects found"
else
    PROJECT_COUNT=$(ls -1 ~/workspace 2>/dev/null | wc -l)
    echo -e "${GREEN}✓${NC} Workspace exists: ~/workspace ($PROJECT_COUNT project(s))"
fi

# Check Docker access
if timeout 2 docker info &>/dev/null; then
    HAS_DOCKER_ACCESS=true
    USER_IMAGES=$(docker images --format "{{.Repository}}" 2>/dev/null | grep -c "^ds01-${USER_ID}/" 2>/dev/null || true)
    USER_IMAGES=${USER_IMAGES:-0}
    # Ensure it's a valid integer
    if ! [[ "$USER_IMAGES" =~ ^[0-9]+$ ]]; then
        USER_IMAGES=0
    fi
    if [ "$USER_IMAGES" -eq 0 ]; then
        echo -e "${YELLOW}○${NC} No custom images yet (will create one)"
    else
        echo -e "${GREEN}✓${NC} $USER_IMAGES custom image(s) found"
    fi
else
    HAS_DOCKER_ACCESS=false
    echo -e "${YELLOW}○${NC} Docker access (will be configured)"
fi

echo -e ""
read -p "Press Enter to continue..." </dev/tty

# If everything is already set up
if [ "$NEEDS_SSH" = false ] && [ "$NEEDS_PROJECT" = false ] && [ "$HAS_DOCKER_ACCESS" = true ]; then
    echo -e "${GREEN}${BOLD}✓ You're already set up!${NC}"
    echo -e ""
    echo -e "Everything looks good. You can:"
    echo -e "  • Create more projects: ${GREEN}project-init${NC}"
    echo -e "  • View your containers: ${GREEN}container-list${NC}"
    echo -e "  • Check your limits: ${GREEN}check-limits${NC}"
    echo -e ""

    # Clear any buffered input before prompting
    read -r -t 0.1 -n 10000 discard </dev/tty 2>/dev/null || true

    # Force user to answer
    echo -n "Run full wizard anyway? [y/N]: "
    read -r RUN_ANYWAY </dev/tty

    if [[ ! "$RUN_ANYWAY" =~ ^[Yy]$ ]]; then
        echo -e ""
        echo -e "${GREEN}Tip:${NC} Run ${CYAN}user-setup${NC} again anytime to revisit setup."
        echo -e ""
        exit 0
    fi
    echo -e ""
fi

# ============================================================================
# STEP 2: SSH KEY SETUP
# ============================================================================

echo -e ""
echo -e "${CYAN}━━━ Step 2: SSH Key Setup ━━━${NC}\n"

if [ "$NEEDS_SSH" = true ]; then
    # Pass skill level to ssh-setup via environment variable
    ssh-setup
else
    # Always offer to revisit SSH setup
    echo -e "SSH keys are already configured."
    echo -e ""

    if is_beginner "REMOTE"; then
        echo -e "${YELLOW}Need to:${NC}"
        echo -e "  • Copy your private key to another device?"
        echo -e "  • Regenerate your keys?"
        echo -e "  • Review VS Code SSH config?"
        echo -e ""
    fi

    # Clear any buffered input before prompting
    read -r -t 0.1 -n 10000 discard </dev/tty 2>/dev/null || true

    # Force user to answer - don't allow auto-skip
    echo -n "Review SSH setup? [y/N]: "
    read -r REVIEW_SSH </dev/tty

    if [[ "$REVIEW_SSH" =~ ^[Yy]$ ]]; then
        ssh-setup
    else
        echo -e "${GREEN}✓ Skipped${NC} - Using existing keys"
        echo ""
        # Always show key location info
        SERVER_IP=$(hostname -I | awk '{print $1}')
        echo -e "${BOLD}Quick Reference - SSH Key Location:${NC}"
        echo -e "  Private key: ${CYAN}~/.ssh/id_ed25519${NC}"
        echo ""
        echo -e "${BOLD}Copy to your local machine:${NC}"
        echo -e "  ${GREEN}scp ${USERNAME}@${SERVER_IP}:~/.ssh/id_ed25519 ~/.ssh/ds01_id_ed25519${NC}"
        echo -e "  ${GREEN}chmod 600 ~/.ssh/ds01_id_ed25519${NC}"
        echo ""
        echo -e "${BOLD}Add to local ~/.ssh/config:${NC}"
        echo -e "  ${CYAN}Host ds01${NC}"
        echo -e "  ${CYAN}    HostName ${SERVER_IP}${NC}"
        echo -e "  ${CYAN}    User ${USERNAME}${NC}"
        echo -e "  ${CYAN}    IdentityFile ~/.ssh/ds01_id_ed25519${NC}"
    fi
fi

# ============================================================================
# STEP 3: VS CODE SETUP
# ============================================================================

echo -e ""
echo -e "${CYAN}━━━ Step 3: VS Code Setup ━━━${NC}\n"

SERVER_IP=$(hostname -I | awk '{print $1}')

echo -e "${BOLD}Install these extensions in VS Code:${NC}"
echo -e ""
echo -e "  ${CYAN}Required:${NC}"
echo -e "    • Remote - SSH (ms-vscode-remote.remote-ssh)"
echo -e "    • Dev Containers (ms-vscode-remote.remote-containers)"
echo -e ""
echo -e "  ${CYAN}Recommended:${NC}"
echo -e "    • Python"
echo -e "    • Jupyter"
echo -e "    • Docker"
echo -e "    • GitLens"
echo -e ""

# Clear any buffered input before prompting
read -r -t 0.1 -n 10000 discard </dev/tty 2>/dev/null || true
read -p "Press Enter when extensions are installed..." </dev/tty
echo -e ""

# ============================================================================
# STEP 4: CONFIGURE SSH IN VS CODE
# ============================================================================

echo -e "${CYAN}━━━ Step 4: Configure SSH in VS Code ━━━${NC}\n"

echo -e "In VS Code: ${CYAN}Command Palette → \"Remote-SSH: Open SSH Configuration File\"${NC}"
echo -e ""
echo -e "Add this configuration:"
echo -e ""
echo -e "${GREEN}Host ds01${NC}"
echo -e "${GREEN}    HostName ${SERVER_IP}${NC}"
echo -e "${GREEN}    User ${USERNAME}${NC}"
echo -e "${GREEN}    IdentityFile ~/.ssh/ds01_id_ed25519${NC}"
echo -e "${GREEN}    ForwardAgent yes${NC}"
echo -e "${GREEN}    ServerAliveInterval 60${NC}"
echo -e ""

# Clear any buffered input before prompting
read -r -t 0.1 -n 10000 discard </dev/tty 2>/dev/null || true
read -p "Press Enter when saved..." </dev/tty
echo -e ""

# ============================================================================
# STEP 5: TEST CONNECTION
# ============================================================================

echo -e "${CYAN}━━━ Step 5: Test Connection ━━━${NC}\n"

echo -e "In VS Code: ${CYAN}Command Palette → \"Remote-SSH: Connect to Host\" → ds01${NC}"
echo -e ""

if is_beginner "REMOTE"; then
    echo -e "${DIM}VS Code will open a new window connected to the server.${NC}"
    echo -e "${DIM}You should see 'SSH: ds01' in the bottom-left corner.${NC}"
    echo -e ""
fi

# Clear any buffered input before prompting
read -r -t 0.1 -n 10000 discard </dev/tty 2>/dev/null || true
read -p "Press Enter after connecting..." </dev/tty
echo -e ""

# ============================================================================
# JUPYTER ACCESS (brief mention)
# ============================================================================

echo -e "${CYAN}━━━ Jupyter Access ━━━${NC}\n"

echo -e "For Jupyter notebooks in VS Code, the ${CYAN}Jupyter extension${NC} handles everything."
echo -e "Just open any .ipynb file after connecting."
echo -e ""
echo -e "For browser-based access, run: ${GREEN}jupyter-setup --guided${NC}"
echo -e ""

# ============================================================================
# CREATE ONBOARDING DOCUMENT
# ============================================================================

echo -e "${CYAN}━━━ Creating Reference Documents ━━━${NC}\n"

onboarding-create

# ============================================================================
# FINAL SUMMARY
# ============================================================================

echo -e ""
echo -e "${GREEN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo -e "${GREEN}${BOLD}✓ User Setup Complete!${NC}"
echo -e "${GREEN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo -e ""

echo -e "${BOLD}What we accomplished:${NC}"
echo -e ""
echo -e "  ${GREEN}✓${NC} SSH keys configured"
echo -e "  ${GREEN}✓${NC} VS Code extensions installed"
echo -e "  ${GREEN}✓${NC} SSH connection configured"
echo -e "  ${GREEN}✓${NC} Reference guide at ~/ONBOARDING.md"
echo -e ""

echo -e "${BOLD}Next Steps:${NC}"
echo -e ""
echo -e "  Create your first project:"
echo -e "    ${GREEN}project-init --guided${NC}"
echo -e ""
echo -e "  Or for quick setup (experienced users):"
echo -e "    ${GREEN}project-init my-project${NC}"
echo -e ""

echo -e "${BOLD}Helpful Commands:${NC}"
echo -e ""
echo -e "   ${CYAN}project-init${NC}              Create a new project"
echo -e "   ${CYAN}container deploy${NC}          Deploy a container"
echo -e "   ${CYAN}container-list${NC}            See all your containers"
echo -e "   ${CYAN}check-limits${NC}              View your resource quotas"
echo -e ""

echo -e "${BOLD}Documentation:${NC}"
echo -e ""
echo -e "   ${CYAN}~/ONBOARDING.md${NC}           Quick reference guide"
echo -e "   https://github.com/hertie-data-science-lab/ds01-user-docs"
echo -e ""

echo -e "${GREEN}Welcome to DS01! Happy computing!${NC}"
echo -e ""
