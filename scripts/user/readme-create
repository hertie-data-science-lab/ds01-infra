#!/bin/bash
# DS01 README Create - Generate README, requirements.txt, and config files
# L2 Atomic Command - Can be used standalone or called by orchestrators

set -e

# Colors
BLUE='\033[94m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
CYAN='\033[0;36m'
BOLD='\033[1m'
DIM='\033[2m'
NC='\033[0m'

USERNAME=$(whoami)
WORKSPACE_DIR="$HOME/workspace"

usage() {
    echo -e ""
    echo -e "${BOLD}DS01 README Create${NC}"
    echo -e ""
    echo -e "${CYAN}Usage:${NC}"
    echo -e "  readme-create <project-name> [options]"
    echo -e ""
    echo -e "${CYAN}Arguments:${NC}"
    echo -e "  project-name       Project directory to create files in"
    echo -e ""
    echo -e "${CYAN}Options:${NC}"
    echo -e "  --type=TYPE        Project type: ml, cv, nlp, rl (default: ml)"
    echo -e "  --desc=\"TEXT\"      Project description"
    echo -e "  --structure=TYPE   Structure: data-science, blank (default: data-science)"
    echo -e "  --commit           Create initial Git commit (requires Git repo)"
    echo -e "  --guided           Show detailed explanations for beginners"
    echo -e "  -h, --help         Show this help message"
    echo -e ""
    echo -e "${CYAN}Examples:${NC}"
    echo -e "  ${DIM}# Create README for ML project${NC}"
    echo -e "  readme-create my-project"
    echo -e ""
    echo -e "  ${DIM}# Computer vision project with description${NC}"
    echo -e "  readme-create cv-project --type=cv --desc=\"Image classification\""
    echo -e ""
    echo -e "  ${DIM}# Create and commit${NC}"
    echo -e "  readme-create my-project --commit"
    echo -e ""
    echo -e "  ${DIM}# With guided explanations${NC}"
    echo -e "  readme-create my-project --guided"
    echo -e ""
    echo -e "${YELLOW}Project Types:${NC}"
    echo -e "  ml  - General machine learning"
    echo -e "  cv  - Computer vision (adds torch, opencv, timm)"
    echo -e "  nlp - Natural language processing (adds transformers, datasets)"
    echo -e "  rl  - Reinforcement learning (adds gymnasium, stable-baselines3)"
    echo -e ""
}

# Parse arguments
PROJECT_NAME=""
PROJECT_TYPE="ml"
PROJECT_DESC=""
STRUCTURE_TYPE="data-science"
DO_COMMIT=false
GUIDED=false

while [[ $# -gt 0 ]]; do
    case $1 in
        --type=*)
            PROJECT_TYPE="${1#*=}"
            shift
            ;;
        --desc=*)
            PROJECT_DESC="${1#*=}"
            shift
            ;;
        --structure=*)
            STRUCTURE_TYPE="${1#*=}"
            shift
            ;;
        --commit)
            DO_COMMIT=true
            shift
            ;;
        --guided)
            GUIDED=true
            shift
            ;;
        -h|--help|--info)
            usage
            exit 0
            ;;
        -*)
            echo -e "${RED}âœ— Unknown option: $1${NC}\n"
            usage
            exit 1
            ;;
        *)
            if [ -z "$PROJECT_NAME" ]; then
                PROJECT_NAME="$1"
            else
                echo -e "${RED}âœ— Too many arguments${NC}\n"
                usage
                exit 1
            fi
            shift
            ;;
    esac
done

# Validate project name
if [ -z "$PROJECT_NAME" ]; then
    echo -e "${RED}âœ— Project name required${NC}\n"
    usage
    exit 1
fi

PROJECT_DIR="$WORKSPACE_DIR/$PROJECT_NAME"

# Validate project directory exists
if [ ! -d "$PROJECT_DIR" ]; then
    echo -e "${RED}âœ— Project directory does not exist: $PROJECT_DIR${NC}"
    echo -e ""
    echo -e "Create it first:"
    echo -e "  ${GREEN}dir-create $PROJECT_NAME${NC}"
    echo -e ""
    exit 1
fi

# Validate project type
case $PROJECT_TYPE in
    ml|cv|nlp|rl)
        ;;
    *)
        echo -e "${RED}âœ— Invalid project type: $PROJECT_TYPE${NC}"
        echo -e "  Valid types: ml, cv, nlp, rl\n"
        usage
        exit 1
        ;;
esac

# Show guided introduction
if [ "$GUIDED" = true ]; then
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${BOLD}Creating Project Documentation${NC}"
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e ""
    echo -e "${BOLD}Next We'll Create:${NC}"
    echo -e ""
    echo -e "  1. ${CYAN}README.md${NC} - Project documentation"
    echo -e "     â€¢ GitHub will automatically display this file (public facing doc)"
    echo -e "     â€¢ We have pre-populated with info for getting set up on DS01's workflow"
    echo -e "     â€¢ You'll later develop this as you develop your project!"
    echo -e ""
    echo -e "  2. ${CYAN}requirements.txt${NC} - Python dependencies"
    echo -e "     â€¢ Core packages (numpy, pandas, jupyter)"
    echo -e "     â€¢ Type-specific packages for $PROJECT_TYPE"
    echo -e "     â€¢ Install with: pip install -r requirements.txt"
    #echo -e ""
    #echo -e "  3. ${CYAN}configs/experiment.yaml${NC} - Example config"
    #echo -e "     â€¢ Training hyperparameters"
    #echo -e "     â€¢ Data settings"
    #echo -e "     â€¢ Logging configuration"
    #echo -e ""
    #echo -e "${YELLOW}ğŸ’¡ Good Documentation:${NC}"
    #echo -e "   â€¢ Helps collaborators understand your work"
    #echo -e "   â€¢ Reminds you of setup steps after breaks"
    #echo -e "   â€¢ Makes your research reproducible"
    echo -e ""
    read -p "Press Enter to create project files..." </dev/tty
fi

echo -e ""
echo -e "${BOLD}Creating Project Files${NC}"
echo -e ""

# Create README based on structure type
if [ "$STRUCTURE_TYPE" = "blank" ]; then
    echo -e "${BLUE}Creating README.md...${NC}"
    cat > "$PROJECT_DIR/README.md" <<READMEEOF
# $PROJECT_NAME

$([ -n "$PROJECT_DESC" ] && echo -e "$PROJECT_DESC")

**Author:** $USERNAME
**Created:** $(date +"%Y-%m-%d")
**Type:** $PROJECT_TYPE

## Getting Started

1. **Deploy your container:**
   \`\`\`bash
   container deploy $PROJECT_NAME
   \`\`\`

2. **Navigate to your project:**
   \`\`\`bash
   cd /workspace/$PROJECT_NAME
   \`\`\`

3. **Start working!**

4. **When done, retire the container:**
   \`\`\`bash
   container retire $PROJECT_NAME
   \`\`\`

## Workflow

- **Workspace** (~/workspace): Your files persist here - this is permanent storage
- **Container**: Your computing environment with GPU access - ephemeral (can be recreated anytime)
- Edit code in VS Code, run in container, results save to workspace
- Your workspace files are **always safe**, even when you retire the container

## Key Commands

\`\`\`bash
container deploy <name>    # Create and start a container
container attach <name>    # Enter a running container
container retire <name>    # Stop + remove + free GPU
container-list             # See all your containers
check-limits               # View your resource quotas
\`\`\`

## Notes

- This directory persists across container restarts
- Save all your work here
- Use Git for version control

**Full documentation:** https://github.com/hertie-data-science-lab/ds01-user-docs

READMEEOF
else
    # Comprehensive README for data science structure
    cat > "$PROJECT_DIR/README.md" <<READMEEOF
# $PROJECT_NAME

$([ -n "$PROJECT_DESC" ] && echo -e "$PROJECT_DESC")

**Author:** $USERNAME
**Created:** $(date +"%Y-%m-%d")
**Type:** $PROJECT_TYPE

## Project Structure

\`\`\`
$PROJECT_NAME/
â”œâ”€â”€ data/
â”‚   â”œâ”€â”€ raw/              # Original, immutable data
â”‚   â”œâ”€â”€ processed/        # Cleaned, transformed data
â”‚   â””â”€â”€ external/         # External datasets
â”œâ”€â”€ models/
â”‚   â””â”€â”€ checkpoints/      # Model checkpoints
â”œâ”€â”€ notebooks/            # Jupyter notebooks for exploration
â”œâ”€â”€ scripts/              # Python scripts for training/inference
â”œâ”€â”€ configs/              # Configuration files (YAML, JSON)
â”œâ”€â”€ outputs/              # Training logs, plots, results
â”‚   â”œâ”€â”€ logs/
â”‚   â””â”€â”€ figures/
â””â”€â”€ tests/                # Unit tests
\`\`\`

## Getting Started

### On the DS01 Server

1. **Deploy your container:**
   \`\`\`bash
   container deploy $PROJECT_NAME
   \`\`\`
   This creates and starts your Docker container with GPU access.

2. **Navigate to your project:**
   \`\`\`bash
   cd /workspace/$PROJECT_NAME
   \`\`\`

3. **Start working!**
   - Run Jupyter: \`jupyter lab\`
   - Train models: \`python scripts/train.py\`
   - Run experiments in notebooks/

4. **When done, retire the container:**
   \`\`\`bash
   container retire $PROJECT_NAME
   \`\`\`
   This stops and removes the container, freeing up GPU resources.

### Understanding the Workflow

**Containers vs. Workspace:**
- Your **workspace** (~/workspace) persists - all files saved here are permanent
- **Containers** are ephemeral environments - they can be created/retired anytime
- Think of containers as your "computer" you turn on/off, workspace as your "hard drive"

**Key Commands:**
\`\`\`bash
# Container management (Orchestration Interface)
container deploy <name>     # Create and start container
container attach <name>     # Enter a running container
container retire <name>     # Stop + remove + free GPU
container-list              # See all your containers
container-stats             # Check resource usage

# Resource management
check-limits                # View your GPU/container quotas

# Image management
image-list                  # See available Docker images
image-create                # Build a new custom image
\`\`\`

**GPU Usage:**
- Check GPU: \`nvidia-smi\`
- Your container has access to assigned GPUs automatically
- View your limits: \`check-limits\`

## Working with Data

- **Raw data:** Goes in \`data/raw/\` (never modify original files)
- **Processed data:** Save cleaned/transformed data to \`data/processed/\`
- **Large files:** Use \`.gitignore\` to exclude from Git (see below)

## Saving Models

\`\`\`python
# Save checkpoints regularly
torch.save(model.state_dict(), 'models/checkpoints/model_epoch_10.pth')
\`\`\`

## Notes

- **All work in this directory persists** across container restarts
- **Checkpoint models regularly** to avoid losing progress
- **Document your experiments** in notebooks or logs
- **Use Git for version control** (recommended)

## Next Steps

- Start experimenting in notebooks/
- Move production code to scripts/
- Commit often with Git

**Full documentation:** https://github.com/hertie-data-science-lab/ds01-user-docs

READMEEOF
fi

echo -e "${BLUE}Creating requirements.txt...${NC}"

# Create requirements.txt with core packages
cat > "$PROJECT_DIR/requirements.txt" <<REQEOF
# DS01 Project Requirements
# Install with: pip install -r requirements.txt

# Core
numpy
pandas
matplotlib
seaborn
scikit-learn
jupyter
jupyterlab
ipykernel
tqdm
tensorboard

REQEOF

# Add type-specific packages
case $PROJECT_TYPE in
    cv)
        cat >> "$PROJECT_DIR/requirements.txt" <<CVEOF
# Computer Vision
torch
torchvision
opencv-python
albumentations
timm
Pillow
CVEOF
        ;;
    nlp)
        cat >> "$PROJECT_DIR/requirements.txt" <<NLPEOF
# NLP
torch
transformers
datasets
tokenizers
accelerate
sentencepiece
NLPEOF
        ;;
    rl)
        cat >> "$PROJECT_DIR/requirements.txt" <<RLEOF
# Reinforcement Learning
torch
gymnasium
stable-baselines3
RLEOF
        ;;
    ml)
        cat >> "$PROJECT_DIR/requirements.txt" <<MLEOF
# Machine Learning
torch
scipy
xgboost
lightgbm
MLEOF
        ;;
esac

# Create example config (only if configs directory exists)
if [ -d "$PROJECT_DIR/configs" ]; then
    echo -e "${BLUE}Creating example config...${NC}"
    cat > "$PROJECT_DIR/configs/experiment.yaml" <<'YAMLEOF'
# Experiment configuration
experiment:
  name: "baseline"
  seed: 42

data:
  batch_size: 32
  num_workers: 4

training:
  epochs: 100
  learning_rate: 0.001
  optimizer: "adam"

logging:
  log_dir: "outputs/logs"
  checkpoint_dir: "models/checkpoints"
YAMLEOF
fi

echo -e "${GREEN}âœ“${NC} README.md created"
echo -e "${GREEN}âœ“${NC} requirements.txt created"
if [ -d "$PROJECT_DIR/configs" ]; then
    echo -e "${GREEN}âœ“${NC} configs/experiment.yaml created"
fi

# Initial Git commit (optional)
if [ "$DO_COMMIT" = true ]; then
    if [ -d "$PROJECT_DIR/.git" ]; then
        echo -e ""
        echo -e "${BLUE}Creating initial Git commit...${NC}"
        cd "$PROJECT_DIR"
        git add . 2>/dev/null
        git commit -q -m "Initial project structure

Created by readme-create
Type: $PROJECT_TYPE
$([ -n "$PROJECT_DESC" ] && echo -e "Description: $PROJECT_DESC")" 2>/dev/null || true
        echo -e "${GREEN}âœ“${NC} Initial commit created"
    else
        echo -e ""
        echo -e "${YELLOW}âš ${NC} Git not initialized, skipping commit"
        if [ "$GUIDED" = true ]; then
            echo -e "  Initialize Git first:"
            echo -e "    ${GREEN}git-init $PROJECT_NAME${NC}"
        fi
    fi
fi

echo -e ""
echo -e "${GREEN}âœ“ Project files created${NC}"

# Summary
if [ "$GUIDED" = true ]; then
    echo -e ""
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${BOLD}Project Documentation Ready${NC}"
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e ""
fi

exit 0
