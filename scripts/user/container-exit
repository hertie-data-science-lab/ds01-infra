#!/bin/bash
# Information about exiting containers - accurate for docker exec behavior
# DS01 uses docker exec, not docker attach, so Ctrl+P, Ctrl+Q does NOT work

BLUE='\033[94m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
CYAN='\033[0;36m'
BOLD='\033[1m'
DIM='\033[2m'
NC='\033[0m'

USERNAME=$(whoami)

# Parse arguments
GUIDED=false

for arg in "$@"; do
    case $arg in
        --guided)
            GUIDED=true
            shift
            ;;
        --info)
            # --info is the default behavior, just show info
            shift
            ;;
        -h|--help|--info)
            echo ""
            echo -e "${BOLD}DS01 Container Exit Info${NC}"
            echo ""
            echo -e "${CYAN}Usage:${NC}"
            echo "  container-exit [options]"
            echo ""
            echo -e "${CYAN}Options:${NC}"
            echo "  --guided    Show detailed explanations"
            echo "  --info      Show exit information (default)"
            echo "  -h, --help  Show this help message"
            echo ""
            echo -e "${CYAN}Description:${NC}"
            echo "  Displays information about how to exit containers"
            echo "  and the difference between exiting and stopping."
            echo ""
            exit 0
            ;;
        *)
            ;;
    esac
done

get_idle_timeout() {
    local username="$1"
    local script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
    local infra_root="$(dirname "$(dirname "$script_dir")")"
    local resource_parser="$infra_root/scripts/docker/get_resource_limits.py"

    if [ -f "$resource_parser" ]; then
        python3 "$resource_parser" "$username" --idle-timeout 2>/dev/null || echo "48h"
    else
        echo "48h"
    fi
}

if [ "$GUIDED" = true ]; then
    echo ""
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${BOLD}Understanding Container Exit Behavior${NC}"
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
    echo -e "${BOLD}How DS01 Containers Work:${NC}"
    echo ""
    echo "  DS01 uses ${CYAN}docker exec${NC} to enter containers."
    echo "  This means when you type ${GREEN}exit${NC}, the container"
    echo "  ${BOLD}keeps running${NC} in the background!"
    echo ""
    echo -e "${BOLD}Key Difference from Docker Attach:${NC}"
    echo ""
    echo "  â€¢ ${YELLOW}docker attach${NC}: Ctrl+P, Ctrl+Q works to detach"
    echo "  â€¢ ${CYAN}docker exec${NC} (DS01): Just type ${GREEN}exit${NC} - container keeps running"
    echo ""
    echo "  ${DIM}Note: Ctrl+P, Ctrl+Q does NOT work with docker exec${NC}"
    echo ""
    read -p "Press Enter to see exit options..." </dev/tty
fi

echo ""
echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${CYAN}${BOLD}    How to Exit Containers${NC}"
echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""

echo -e "${BOLD}When inside a container:${NC}"
echo ""
echo -e "  ${GREEN}${BOLD}exit${NC} or ${GREEN}${BOLD}Ctrl+D${NC}"
echo "  â†’ Exit your session"
echo "  â†’ Container ${BOLD}keeps running${NC} in the background"
echo "  â†’ All processes continue (training, Jupyter, etc.)"
echo ""

if [ "$GUIDED" = true ]; then
    echo -e "${BOLD}What Actually Happens:${NC}"
    echo ""
    echo "  1. Your shell session inside the container ends"
    echo "  2. The container itself continues running"
    echo "  3. Any background processes (Python scripts, Jupyter) keep going"
    echo "  4. You can reconnect anytime with ${GREEN}container-run <name>${NC}"
    echo ""
fi

echo -e "${DIM}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
echo ""
echo -e "${BOLD}Container Status After Exit:${NC}"
echo ""
echo -e "  ${GREEN}âœ“${NC} Container keeps running"
echo -e "  ${GREEN}âœ“${NC} All processes continue"
echo -e "  ${GREEN}âœ“${NC} GPU allocation remains"
echo -e "  ${GREEN}âœ“${NC} You can reconnect anytime"
echo ""

echo -e "${BOLD}Auto-Stop Policy:${NC}"
echo -e "  ${YELLOW}$(get_idle_timeout "$USERNAME")${NC} of idle GPU time"
echo -e "  ${DIM}(Container auto-stops after this period of no GPU activity)${NC}"
echo ""

echo -e "${DIM}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
echo ""
echo -e "${BOLD}Essential Commands:${NC}"
echo ""
echo -e "  ${GREEN}container-run <name>${NC}      Reconnect to running container"
echo -e "  ${GREEN}container-stop <name>${NC}     Stop a running container"
echo -e "  ${GREEN}container-list${NC}            See all your containers"
echo -e "  ${GREEN}container-stats${NC}           Check resource usage"
echo ""

if [ "$GUIDED" = true ]; then
    echo -e "${DIM}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
    echo ""
    echo -e "${BOLD}Exit vs. Stop - What's the Difference?${NC}"
    echo ""
    echo -e "  ${CYAN}exit${NC} (from inside container):"
    echo "    â€¢ Ends your shell session"
    echo "    â€¢ Container keeps running"
    echo "    â€¢ Background processes continue"
    echo "    â€¢ Use for: Long training jobs, Jupyter servers"
    echo ""
    echo -e "  ${CYAN}container-stop <name>${NC} (from host):"
    echo "    â€¢ Stops the entire container"
    echo "    â€¢ All processes terminate"
    echo "    â€¢ Releases GPU resources"
    echo "    â€¢ Use for: When completely done, freeing resources"
    echo ""
fi

echo -e "${DIM}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
echo ""
echo -e "${YELLOW}ğŸ’¡ Best Practices:${NC}"
echo ""
echo -e "  â€¢ ${BOLD}Long training jobs:${NC} Just ${GREEN}exit${NC} - job continues running"
echo "    Reconnect later to check progress"
echo ""
echo -e "  â€¢ ${BOLD}Quick tasks:${NC} Use ${GREEN}container-stop${NC} when done"
echo "    Frees resources for others"
echo ""
echo -e "  â€¢ ${BOLD}Before logging off:${NC} Check ${GREEN}container-list${NC}"
echo "    See what's still running and consuming resources"
echo ""

echo -e "${DIM}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
echo ""
echo -e "${BOLD}Example Workflows:${NC}"
echo ""
echo -e "  ${DIM}# Scenario 1: Long training job${NC}"
echo "  container-run my-project"
echo -e "  ${DIM}(inside container)${NC} python train.py --epochs 100 &  ${DIM}# Run in background${NC}"
echo -e "  ${GREEN}exit${NC}  ${DIM}# Leave container, training continues${NC}"
echo ""
echo -e "  ${DIM}# Later: Check on it${NC}"
echo "  container-run my-project  ${DIM}# Reconnect${NC}"
echo "  tail -f outputs/logs/training.log  ${DIM}# Check progress${NC}"
echo ""
echo -e "  ${DIM}# Scenario 2: Quick debugging${NC}"
echo "  container-run my-project"
echo -e "  ${DIM}(test some code, fix bugs)${NC}"
echo -e "  ${GREEN}exit${NC}"
echo -e "  container-stop my-project  ${DIM}# Stop to free resources${NC}"
echo ""

echo -e "${DIM}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
echo ""
echo -e "${RED}âš  Important Reminders:${NC}"
echo ""
echo "  â€¢ Containers share server GPU resources"
echo "  â€¢ Idle containers will auto-stop to free resources"
echo "  â€¢ Please stop containers when not actively using them"
echo -e "  â€¢ Use ${GREEN}container-stats${NC} to monitor your resource usage"
echo ""

if [ "$GUIDED" = true ]; then
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${BOLD}Common Misconceptions${NC}"
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
    echo -e "  ${RED}âœ—${NC} Ctrl+P, Ctrl+Q ${BOLD}does NOT work${NC} on DS01"
    echo "    (This only works with 'docker attach', not 'docker exec')"
    echo ""
    echo -e "  ${RED}âœ—${NC} Typing 'exit' ${BOLD}does NOT stop${NC} the container"
    echo "    (It only ends your session, container keeps running)"
    echo ""
    echo -e "  ${GREEN}âœ“${NC} Use ${GREEN}exit${NC} to leave but keep running"
    echo -e "  ${GREEN}âœ“${NC} Use ${GREEN}container-stop${NC} to actually stop"
    echo ""
fi

echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""
