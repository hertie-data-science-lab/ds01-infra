#!/bin/bash
# Information about exiting containers without stopping them

BLUE='\033[94m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
CYAN='\033[0;36m'
BOLD='\033[1m'
DIM='\033[2m'
NC='\033[0m'

USERNAME=$(whoami)

get_idle_timeout() {
    local username="$1"
    local script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
    local infra_root="$(dirname "$script_dir")"
    local resource_parser="$infra_root/docker/get_resource_limits.py"

    if [ -f "$resource_parser" ]; then
        python3 "$resource_parser" "$username" --idle-timeout 2>/dev/null || echo "48h"
    else
        echo "48h"
    fi
}

echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${CYAN}${BOLD}    Exit Container (Without Stopping)${NC}"
echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""
echo -e "${BOLD}When attached to a container, use:${NC}"
echo ""
echo -e "  ${GREEN}${BOLD}Ctrl+P, Ctrl+Q${NC}  â†’  Detach and leave container running"
echo ""
echo -e "${DIM}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
echo ""
echo -e "${BOLD}What happens:${NC}"
echo -e "  ${GREEN}âœ“${NC} Container keeps running in background"
echo -e "  ${GREEN}âœ“${NC} All processes continue (training, Jupyter, etc.)"
echo -e "  ${GREEN}âœ“${NC} You can reconnect anytime"
echo ""
echo -e "${BOLD}Auto-stop timeout:${NC}"
echo -e "  ${YELLOW}$(get_idle_timeout "$USERNAME")${NC} of idle GPU time"
echo -e "  ${DIM}(After this period of no GPU activity, container auto-stops)${NC}"
echo ""
echo -e "${DIM}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
echo ""
echo -e "${BOLD}Reconnect later:${NC}"
echo -e "  ${GREEN}container-run <name>${NC}"
echo ""
echo -e "${BOLD}Stop manually:${NC}"
echo -e "  ${GREEN}container-stop <name>${NC}"
echo ""
echo -e "${BOLD}Check status:${NC}"
echo -e "  ${GREEN}container-list${NC}"
echo ""
echo -e "${DIM}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
echo ""
echo -e "${BOLD}Comparison:${NC}"
echo ""
echo -e "  ${GREEN}Ctrl+P, Ctrl+Q${NC}  â†’  Exit without stopping"
echo -e "                      ${DIM}(Container keeps running)${NC}"
echo ""
echo -e "  ${YELLOW}exit${NC} or ${YELLOW}Ctrl+D${NC}  â†’  Exit and stop container"
echo -e "                      ${DIM}(Container terminates)${NC}"
echo ""
echo -e "${DIM}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
echo ""
echo -e "${YELLOW}ğŸ’¡ Best Practices:${NC}"
echo ""
echo -e "  â€¢ ${BOLD}For long training:${NC} Use ${GREEN}Ctrl+P, Ctrl+Q${NC} to detach"
echo "    Your job continues running"
echo ""
echo -e "  â€¢ ${BOLD}Quick tasks:${NC} Just ${YELLOW}exit${NC} when done"
echo "    Saves resources for others"
echo ""
echo -e "  â€¢ ${BOLD}Check before closing:${NC} Use ${GREEN}container-list${NC}"
echo "    See what's still running"
echo ""
echo -e "${DIM}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
echo ""
echo -e "${BOLD}Examples:${NC}"
echo ""
echo -e "  ${DIM}# Start long training${NC}"
echo "  container-run my-project"
echo -e "  ${DIM}(in container)${NC} python train.py --epochs 100"
echo -e "  ${GREEN}Ctrl+P, Ctrl+Q${NC}  ${DIM}# Detach, training continues${NC}"
echo ""
echo -e "  ${DIM}# Check on it later${NC}"
echo -e "  container-list  ${DIM}# See it's still running${NC}"
echo -e "  container-run my-project  ${DIM}# Reconnect${NC}"
echo ""
echo -e "${DIM}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
echo ""
echo -e "${RED}âš  Important:${NC}"
echo -e "  Containers are ${BOLD}not${NC} VMs - they share server resources"
echo "  Please stop containers when not in use:"
echo -e "    ${GREEN}container-stop <name>${NC}"
echo ""
