#!/bin/bash
# DS01 New Project Setup
# Quick workflow for creating additional projects (no SSH setup)

set -e

BLUE='\033[0;36m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m'

USERNAME=$(whoami)
USER_ID=$(id -u)
GROUP_ID=$(id -g)

# Header
echo ""
echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "  ${BOLD}DS01 New Project Setup${NC}"
echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""

# Step 1: Project Setup
echo -e "${BOLD}Step 1: Project Directory${NC}"
echo ""
echo -e "${YELLOW}Note:${NC} Creates standard ML project layout (data/, models/, notebooks/,"
echo "scripts/, outputs/). This is an industry-standard template - customize as needed."
echo ""

read -p "Project name (e.g., thesis, cv-experiments, nlp-project): " PROJECT_NAME
PROJECT_NAME=$(echo "$PROJECT_NAME" | tr ' ' '-' | tr '[:upper:]' '[:lower:]')

PROJECT_DIR="$HOME/workspace/$PROJECT_NAME"

if [ -d "$PROJECT_DIR" ]; then
    echo -e "${YELLOW}âš   Project directory already exists: $PROJECT_DIR${NC}"
    read -p "Use existing directory? [Y/n]: " USE_EXISTING
    if [[ ! "$USE_EXISTING" =~ ^[Yy] ]]; then
        exit 1
    fi
else
    mkdir -p "$PROJECT_DIR"
    mkdir -p "$PROJECT_DIR"/{data,models,notebooks,scripts,outputs}

    # Create basic README
    cat > "$PROJECT_DIR/README.md" <<'READMEEOF'
# PROJECT_NAME_PLACEHOLDER

Created: DATE_PLACEHOLDER
Author: USERNAME_PLACEHOLDER

## Project Structure

```
PROJECT_NAME_PLACEHOLDER/
â”œâ”€â”€ data/           # Raw and processed datasets
â”œâ”€â”€ models/         # Saved model checkpoints
â”œâ”€â”€ notebooks/      # Jupyter notebooks
â”œâ”€â”€ scripts/        # Python scripts
â”œâ”€â”€ outputs/        # Training logs, plots, results
â””â”€â”€ README.md       # This file
```

## Getting Started

1. Start container: `container-run PROJECT_NAME_PLACEHOLDER-image`
2. Navigate to project: `cd /workspace/PROJECT_NAME_PLACEHOLDER`
3. Start coding!

## Notes

- Save all work in this directory (it persists)
- Checkpoint models regularly
- Document your experiments
READMEEOF

    # Replace placeholders
    sed -i "s/PROJECT_NAME_PLACEHOLDER/$PROJECT_NAME/g" "$PROJECT_DIR/README.md"
    sed -i "s/USERNAME_PLACEHOLDER/$USERNAME/g" "$PROJECT_DIR/README.md"
    sed -i "s/DATE_PLACEHOLDER/$(date)/g" "$PROJECT_DIR/README.md"

    echo -e "${GREEN}âœ“ Project created${NC}"
    echo -e "  Location: ${BLUE}$PROJECT_DIR${NC}"
fi

# Step 2: Image Creation
echo ""
echo -e "${BOLD}Step 2: Docker Image${NC}"
echo ""

read -p "Create a custom Docker image? [Y/n]: " CREATE_IMAGE
CREATE_IMAGE=${CREATE_IMAGE:-Y}

if [[ "$CREATE_IMAGE" =~ ^[Yy] ]]; then

    # Image naming (without username prefix)
    IMAGE_NAME="${PROJECT_NAME}-image"

    echo ""
    echo -e "${BOLD}Image name: ${CYAN}${IMAGE_NAME}${NC}"
    echo ""

    # Framework selection
    echo "Select framework:"
    echo -e "  ${BOLD}1)${NC} PyTorch 2.5.1 + CUDA 11.8 ${GREEN}(recommended)${NC}"
    echo -e "  ${BOLD}2)${NC} TensorFlow 2.14.0 + CUDA 11.8"
    echo -e "  ${BOLD}3)${NC} PyTorch 2.5.1 (CPU only)"
    read -p "Choice [1-3, default: 1]: " FRAMEWORK_CHOICE

    case $FRAMEWORK_CHOICE in
        2)
            BASE_IMAGE="tensorflow/tensorflow:2.14.0-gpu"
            FRAMEWORK="tensorflow"
            ;;
        3)
            BASE_IMAGE="pytorch/pytorch:2.5.1-cpu"
            FRAMEWORK="pytorch-cpu"
            ;;
        *)
            BASE_IMAGE="pytorch/pytorch:2.5.1-cuda11.8-cudnn9-runtime"
            FRAMEWORK="pytorch"
            ;;
    esac

    # Use case packages
    echo ""
    echo "Select package bundle:"
    echo -e "  ${BOLD}1)${NC} Computer Vision (timm, albumentations, opencv)"
    echo -e "  ${BOLD}2)${NC} NLP (transformers, datasets, tokenizers)"
    echo -e "  ${BOLD}3)${NC} Reinforcement Learning (gymnasium, stable-baselines3)"
    echo -e "  ${BOLD}4)${NC} General ML ${GREEN}(default)${NC}"
    echo -e "  ${BOLD}5)${NC} Custom packages"
    read -p "Choice [1-5, default: 4]: " USECASE_CHOICE

    USECASE_PACKAGES=""
    case $USECASE_CHOICE in
        1)
            USECASE_PACKAGES="timm albumentations opencv-python-headless torchvision"
            USECASE_NAME="Computer Vision"
            ;;
        2)
            USECASE_PACKAGES="transformers datasets tokenizers accelerate"
            USECASE_NAME="NLP"
            ;;
        3)
            USECASE_PACKAGES="gymnasium stable-baselines3 tensorboard"
            USECASE_NAME="Reinforcement Learning"
            ;;
        5)
            read -p "Enter packages (space-separated): " USECASE_PACKAGES
            USECASE_NAME="Custom"
            ;;
        *)
            USECASE_PACKAGES=""
            USECASE_NAME="General ML"
            ;;
    esac

    # Additional packages
    echo ""
    read -p "Additional packages? (space-separated, or press Enter): " ADDITIONAL_PACKAGES

    # System packages
    echo ""
    read -p "System packages (apt)? (or press Enter): " SYSTEM_PACKAGES

    # Generate Dockerfile
    mkdir -p ~/docker-images
    DOCKERFILE_PATH=~/docker-images/${IMAGE_NAME}.Dockerfile

    cat > "$DOCKERFILE_PATH" <<DOCKERFILEEOF
# DS01 Custom Image: $IMAGE_NAME
# Created: $(date)
# Use case: $USECASE_NAME
# Author: $USERNAME

FROM $BASE_IMAGE

# Docker labels for ownership tracking
LABEL ds01.owner="$USERNAME"
LABEL ds01.project="$PROJECT_NAME"
LABEL ds01.framework="$FRAMEWORK"
LABEL ds01.usecase="$USECASE_NAME"
LABEL ds01.created="$(date -Iseconds)"

WORKDIR /workspace

# System packages
RUN apt-get update && apt-get install -y --no-install-recommends \\
    git \\
    curl \\
    wget \\
    vim \\
    ${SYSTEM_PACKAGES} \\
    && rm -rf /var/lib/apt/lists/*

# Core Python packages
RUN pip install --no-cache-dir \\
    jupyter \\
    jupyterlab \\
    ipykernel \\
    numpy \\
    pandas \\
    matplotlib \\
    seaborn \\
    scikit-learn \\
    scipy \\
    tqdm \\
    tensorboard \\
    Pillow

# Use case specific packages
$([ -n "$USECASE_PACKAGES" ] && echo "RUN pip install --no-cache-dir $USECASE_PACKAGES")

# Additional user packages
$([ -n "$ADDITIONAL_PACKAGES" ] && echo "RUN pip install --no-cache-dir $ADDITIONAL_PACKAGES")

# Configure Jupyter
RUN jupyter lab --generate-config && \\
    echo "c.ServerApp.ip = '0.0.0.0'" >> /root/.jupyter/jupyter_lab_config.py && \\
    echo "c.ServerApp.allow_root = True" >> /root/.jupyter/jupyter_lab_config.py && \\
    echo "c.ServerApp.open_browser = False" >> /root/.jupyter/jupyter_lab_config.py

# IPython kernel
RUN python -m ipykernel install --user \\
    --name=$IMAGE_NAME \\
    --display-name="$PROJECT_NAME (GPU)"

# Environment
ENV PYTHONUNBUFFERED=1
ENV CUDA_DEVICE_ORDER=PCI_BUS_ID
ENV HF_HOME=/workspace/.cache/huggingface

CMD ["/bin/bash"]
DOCKERFILEEOF

    echo ""
    echo -e "${GREEN}âœ“ Dockerfile created${NC}"
    echo -e "  ${BLUE}$DOCKERFILE_PATH${NC}"
    echo ""

    # Build image
    read -p "Build image now? (takes 3-5 minutes) [Y/n]: " BUILD_NOW
    BUILD_NOW=${BUILD_NOW:-Y}

    if [[ "$BUILD_NOW" =~ ^[Yy] ]]; then
        echo ""
        echo -e "${CYAN}Building image...${NC}"
        echo ""

        docker build -t "$IMAGE_NAME" -f "$DOCKERFILE_PATH" ~/docker-images/

        if [ $? -eq 0 ]; then
            echo ""
            echo -e "${GREEN}âœ“ Image built: ${IMAGE_NAME}${NC}"
            echo ""

            # Save image metadata
            mkdir -p ~/ds01-config/images
            cat > ~/ds01-config/images/${IMAGE_NAME}.info <<INFOEOF
Image: $IMAGE_NAME
Project: $PROJECT_NAME
Owner: $USERNAME
Framework: $FRAMEWORK
Use Case: $USECASE_NAME
Created: $(date)
Dockerfile: $DOCKERFILE_PATH

Commands:
- Create container: container-create ${PROJECT_NAME} ${IMAGE_NAME}
- Run container: container-run ${PROJECT_NAME}
- Rebuild image: docker build -t $IMAGE_NAME -f $DOCKERFILE_PATH ~/docker-images/
INFOEOF

        else
            echo ""
            echo -e "${RED}âœ— Build failed${NC}"
            echo "Check: $DOCKERFILE_PATH"
            exit 1
        fi
    else
        echo ""
        echo "Build later:"
        echo -e "  ${CYAN}docker build -t $IMAGE_NAME -f $DOCKERFILE_PATH ~/docker-images/${NC}"
        echo ""
    fi
else
    IMAGE_NAME=""
fi

# Summary
echo ""
echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${GREEN}${BOLD}âœ“ Setup Complete!${NC}"
echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""
echo -e "${BOLD}Project:${NC} $PROJECT_NAME"
echo -e "${BOLD}Location:${NC} $PROJECT_DIR"
if [ -n "$IMAGE_NAME" ]; then
    echo -e "${BOLD}Image:${NC} $IMAGE_NAME"
fi
echo ""

if [ -n "$IMAGE_NAME" ]; then
    echo -e "${YELLOW}Next steps:${NC}"
    echo -e "  ${GREEN}container-create $PROJECT_NAME $IMAGE_NAME${NC}"
    echo -e "  ${GREEN}container-run $PROJECT_NAME${NC}"
    echo ""
fi

echo -e "${CYAN}ðŸ’¡ View all commands: ${BOLD}alias-list${NC}"
echo ""
