#!/bin/bash
# List Docker images for DS01 user

set -e

# Source DS01 context library for conditional output
[[ -f "/opt/ds01-infra/scripts/lib/ds01-context.sh" ]] && \
    source /opt/ds01-infra/scripts/lib/ds01-context.sh

BLUE='\033[0;34m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m'

USERNAME=$(whoami)

usage() {
    echo ""
    echo -e "${BOLD}Docker Image List${NC}"
    echo ""
    echo -e "${CYAN}Usage:${NC}"
    echo "  image-list [options]"
    echo ""
    echo -e "${CYAN}Options:${NC}"
    echo "  --guided        Show detailed explanations for beginners"
    echo "  -a, --all       Show all images (not just yours)"
    echo "  -s, --size      Show image sizes"
    echo "  -d, --detailed  Show detailed information"
    echo "  -h, --help      Show this help message"
    echo ""
    echo -e "${CYAN}Examples:${NC}"
    echo "  image-list              # List your images"
    echo "  image-list --all        # List all images on server"
    echo "  image-list --detailed   # Show detailed info with Dockerfile locations"
    echo ""
    echo -e "${DIM}Run 'help' or 'commands' anytime to see available commands.${NC}"
    echo ""
}

detailed_help() {
    echo ""
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${BOLD}Docker Image List - Full Reference${NC}"
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
    echo -e "${BOLD}Usage:${NC}"
    echo "  image-list [options]"
    echo ""
    echo -e "${BOLD}Options:${NC}"
    echo "  --guided        Show explanations (educational)"
    echo "  -a, --all       Show all images (including system/base images)"
    echo "  -s, --size      Show image sizes"
    echo "  -d, --detailed  Show detailed info (metadata, containers)"
    echo "  --concepts      Show pre-run educational content"
    echo "  --info          Show this detailed reference"
    echo "  -h, --help      Show quick reference"
    echo ""
    echo -e "${BOLD}Output Columns:${NC}"
    echo "  Repository      Image name (ds01-<uid>/<project>)"
    echo "  Tag             Version label (usually 'latest')"
    echo "  Size            Disk space used (with -s flag)"
    echo "  Created         Time since image was built"
    echo ""
    echo -e "${BOLD}Naming Convention:${NC}"
    echo "  DS01 images follow the pattern: ds01-<user-id>/<project-name>"
    echo "  Example: ds01-1001/my-ml-project"
    echo ""
    echo -e "${BOLD}Examples:${NC}"
    echo ""
    echo -e "  ${DIM}# List your images (default)${NC}"
    echo "  image-list"
    echo ""
    echo -e "  ${DIM}# List with sizes${NC}"
    echo "  image-list --size"
    echo ""
    echo -e "  ${DIM}# Detailed view (shows Dockerfile locations, containers)${NC}"
    echo "  image-list --detailed"
    echo ""
    echo -e "  ${DIM}# Show all images on system (including base images)${NC}"
    echo "  image-list --all"
    echo ""
    echo -e "${BOLD}Related Commands:${NC}"
    echo -e "  ${GREEN}image-create${NC}    Create a new image"
    echo -e "  ${GREEN}image-update${NC}    Modify/rebuild an image"
    echo -e "  ${GREEN}image-delete${NC}    Remove an image"
    echo ""
}

show_concepts() {
    echo ""
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${BOLD}Understanding Docker Images${NC}"
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
    echo -e "${BOLD}What is a Docker Image?${NC}"
    echo "  A Docker image is a template/blueprint containing:"
    echo "  â€¢ Operating system (Ubuntu Linux)"
    echo "  â€¢ Programming languages (Python)"
    echo "  â€¢ Frameworks (PyTorch, TensorFlow)"
    echo "  â€¢ Your custom packages"
    echo ""
    echo -e "${BOLD}Key Terms:${NC}"
    echo -e "  â€¢ ${CYAN}Image${NC} - Static blueprint (frozen, reusable)"
    echo -e "  â€¢ ${CYAN}Container${NC} - Running instance from an image"
    echo -e "  â€¢ ${CYAN}Tag${NC} - Version label (usually 'latest')"
    echo ""
    echo -e "${CYAN}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
    echo ""
    echo -e "${BOLD}Image vs Container:${NC}"
    echo ""
    echo "  One image can create multiple containers."
    echo "  Think of it like:"
    echo "  â€¢ Image = Recipe (same recipe, can cook many times)"
    echo "  â€¢ Container = Cooked dish (actual running environment)"
    echo ""
    echo -e "${CYAN}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
    echo ""
    echo -e "${BOLD}DS01 Naming Convention:${NC}"
    echo ""
    echo "  Format: ds01-<user-id>/<project-name>"
    echo "  Example: ds01-1001/my-ml-project"
    echo ""
    echo "  This ensures images are organized by user and easily identifiable."
    echo ""
    echo -e "${CYAN}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
    echo ""
    echo -e "${BOLD}Common Workflows:${NC}"
    echo ""
    echo -e "  ${GREEN}image-create${NC}    â†’ Build new image from scratch"
    echo -e "  ${GREEN}image-list${NC}      â†’ See what images you have"
    echo -e "  ${GREEN}image-update${NC}    â†’ Add packages to existing image"
    echo -e "  ${GREEN}image-delete${NC}    â†’ Remove unused images"
    echo ""
    echo -e "${BOLD}Ready to view your images?${NC}"
    echo -e "  Run: ${GREEN}image-list${NC}            (simple view)"
    echo -e "  Run: ${GREEN}image-list --detailed${NC} (with metadata)"
    echo ""
}

show_detailed() {
    local filter="$1"

    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${CYAN}${BOLD}Your Docker Images${NC}"
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"

    local images
    if [ "$filter" = "all" ]; then
        images=$(docker images --format "{{.Repository}}" | grep -v "^<none>$" || true)
    else
        # Filter by DS01 naming pattern: ds01-{user-id}/*
        images=$(docker images --format "{{.Repository}}" | grep "^ds01-$(id -u)/" || true)
    fi

    if [ -z "$images" ]; then
        echo -e "${YELLOW}No images found${NC}"
        echo ""
        echo -e "Create your first image with: ${GREEN}image-create my-project${NC}"
        exit 0
    fi

    local count=0
    while IFS= read -r image_name; do
        [ -z "$image_name" ] && continue
        count=$((count + 1))

        local size=$(docker images --format "{{.Size}}" "$image_name" | head -1)
        local created=$(docker images --format "{{.CreatedAt}}" "$image_name" | head -1)
        local image_id=$(docker images --format "{{.ID}}" "$image_name" | head -1)

        echo -e "${BOLD}$count. ${CYAN}$image_name${NC}"
        echo "   Size:    $size"
        echo "   Created: $created"
        echo "   ID:      $image_id"

        # Check for metadata
        local info_file="$HOME/ds01-config/images/${image_name}.info"
        if [ -f "$info_file" ]; then
            local framework=$(grep "^Framework:" "$info_file" | cut -d: -f2- | xargs)
            local usecase=$(grep "^Use Case:" "$info_file" | cut -d: -f2- | xargs)
            local dockerfile=$(grep "^Dockerfile:" "$info_file" | cut -d: -f2- | xargs)

            [ -n "$framework" ] && echo "   Framework: $framework"
            [ -n "$usecase" ] && echo "   Use case: $usecase"
            [ -n "$dockerfile" ] && [ -f "$dockerfile" ] && echo -e "   Dockerfile: ${BLUE}$dockerfile${NC}"
        fi

        # Check for containers using this image
        local containers=$(docker ps -a --filter "ancestor=$image_name" --format "{{.Names}}" | wc -l)
        if [ "$containers" -gt 0 ]; then
            echo -e "   Containers: ${GREEN}$containers${NC}"
        fi

        echo ""
    done <<< "$images"

    echo -e "${BOLD}Total:${NC} $count image(s)"
}

show_simple() {
    local filter="$1"
    local show_size="$2"

    if [ "$GUIDED" = true ]; then
        echo ""
        echo -e "${CYAN}â„¹ ${NC}${BOLD}Understanding Docker Images:${NC}"
        echo -e "  A Docker image is like a template or snapshot that contains:"
        echo -e "  â€¢ Operating system (usually Ubuntu)"
        echo -e "  â€¢ Programming languages (Python, etc.)"
        echo -e "  â€¢ Libraries and frameworks (PyTorch, TensorFlow, etc.)"
        echo -e "  â€¢ Your custom packages and configurations"
        echo ""
        echo -e "${CYAN}â„¹ ${NC}${BOLD}What the columns show:${NC}"
        echo -e "  â€¢ ${BOLD}Repository${NC} - The image name (e.g., project-username-image)"
        echo -e "  â€¢ ${BOLD}Tag${NC} - The version (usually 'latest' for most recent)"
        echo -e "  â€¢ ${BOLD}Size${NC} - Disk space used by the image (if --size flag used)"
        echo -e "  â€¢ ${BOLD}Created${NC} - How long ago the image was built"
        echo ""
        echo -e "${CYAN}â„¹ ${NC}Containers are created FROM images. One image can be used"
        echo -e "  to create multiple containers."
        echo ""
    fi

    if [ "$filter" = "all" ]; then
        if [ "$show_size" = "true" ]; then
            docker images --format "table {{.Repository}}\t{{.Tag}}\t{{.Size}}\t{{.CreatedSince}}"
        else
            docker images --format "table {{.Repository}}\t{{.Tag}}\t{{.CreatedSince}}"
        fi
    else
        echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
        echo -e "${CYAN}${BOLD}Your Docker Images${NC}"
        echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"

        # Filter by DS01 naming pattern: ds01-{user-id}/*
        local user_id=$(id -u)
        if [ "$show_size" = "true" ]; then
            docker images --format "table {{.Repository}}\t{{.Tag}}\t{{.Size}}\t{{.CreatedSince}}" | \
                awk -v uid="$user_id" 'NR==1 || $1 ~ "^ds01-"uid"/"'
        else
            docker images --format "table {{.Repository}}\t{{.Tag}}\t{{.CreatedSince}}" | \
                awk -v uid="$user_id" 'NR==1 || $1 ~ "^ds01-"uid"/"'
        fi

        local count=$(docker images --format "{{.Repository}}" | grep "^ds01-$user_id/" | wc -l)

        echo ""
        if [ "$count" -eq 0 ]; then
            echo -e "${YELLOW}No images found${NC}"
            echo ""
            echo -e "Create your first image with: ${GREEN}image-create my-project${NC}"
        else
            echo -e "${BOLD}Total:${NC} $count image(s)"
            echo ""
            
            if [ "$GUIDED" = true ]; then
                echo -e "${YELLOW}ğŸ’¡ Tips:${NC}"
                echo -e "  â€¢ Deploy container: ${GREEN}container-deploy <image-name>${NC}"
                echo -e "  â€¢ Update image: ${GREEN}image-update <image-name>${NC}"
                echo -e "  â€¢ Delete image: ${GREEN}image-delete <image-name>${NC}"
                echo -e "  â€¢ Detailed view: ${GREEN}image-list --detailed${NC}"
            fi
        fi
    fi
}

# Parse arguments
GUIDED=false
FILTER="user"
SHOW_SIZE=false
DETAILED=false

while [[ $# -gt 0 ]]; do
    case $1 in
        --guided)
            GUIDED=true
            shift
            ;;
        -a|--all)
            FILTER="all"
            shift
            ;;
        -s|--size)
            SHOW_SIZE=true
            shift
            ;;
        -d|--detailed)
            DETAILED=true
            shift
            ;;
        -h|--help)
            usage
            exit 0
            ;;
        --info)
            detailed_help
            exit 0
            ;;
        --concepts)
            show_concepts
            exit 0
            ;;
        *)
            echo -e "${RED}Unknown option: $1${NC}\n"
            usage
            exit 1
            ;;
    esac
done

# Show images
if [ "$DETAILED" = true ]; then
    show_detailed "$FILTER"
else
    show_simple "$FILTER" "$SHOW_SIZE"
fi
