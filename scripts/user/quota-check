#!/bin/bash
# /opt/ds01-infra/scripts/user/quota-check
# DS01 Disk Quota Check - Show current disk usage vs quota
#
# Usage:
#   quota-check              # Check your quota
#   quota-check --all        # Check all users (admin only)

set -e

INFRA_ROOT="/opt/ds01-infra"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

format_size() {
    local kb=$1
    if [[ $kb -ge 1073741824 ]]; then
        echo "$((kb / 1073741824))T"
    elif [[ $kb -ge 1048576 ]]; then
        echo "$((kb / 1048576))G"
    elif [[ $kb -ge 1024 ]]; then
        echo "$((kb / 1024))M"
    else
        echo "${kb}K"
    fi
}

check_user_quota() {
    local username="${1:-$USER}"

    echo -e "\n${BLUE}Disk Quota for ${username}${NC}"
    echo "================================"

    # Check if quota system is enabled
    if ! command -v quota &>/dev/null; then
        echo -e "${YELLOW}Quota tools not installed${NC}"
        echo ""
        echo "Showing disk usage instead:"
        du -sh "/home/$username" 2>/dev/null || du -sh "$HOME"
        return
    fi

    # Get quota info
    local quota_info
    quota_info=$(quota -u "$username" 2>/dev/null) || true

    if echo "$quota_info" | grep -q "none"; then
        echo -e "${YELLOW}No quota set for $username${NC}"
    elif [[ -z "$quota_info" ]] || echo "$quota_info" | grep -q "cannot"; then
        echo -e "${YELLOW}Quota system not enabled on this filesystem${NC}"
    else
        echo "$quota_info"
    fi

    echo ""

    # Show actual usage
    echo "Current disk usage:"
    local home_usage
    if [[ -d "/home/$username" ]]; then
        home_usage=$(du -sh "/home/$username" 2>/dev/null | cut -f1)
        echo "  Home directory: $home_usage"
    fi

    # Get configured limit from resource-limits.yaml
    local configured_limit
    configured_limit=$(python3 "$INFRA_ROOT/scripts/docker/get_resource_limits.py" "$username" 2>/dev/null | \
        grep -oP 'storage_workspace:\s*\K[0-9]+[GMTK]?' || echo "100G")

    echo ""
    echo -e "Configured limit: ${GREEN}${configured_limit}${NC}"

    # Warn if over 80%
    local usage_bytes
    usage_bytes=$(du -sb "/home/$username" 2>/dev/null | cut -f1 || echo 0)
    local limit_bytes=$((${configured_limit%[GMTK]*} * 1024 * 1024 * 1024))

    if [[ $usage_bytes -gt 0 ]] && [[ $limit_bytes -gt 0 ]]; then
        local percent=$((usage_bytes * 100 / limit_bytes))
        if [[ $percent -ge 90 ]]; then
            echo -e "${RED}WARNING: You are using ${percent}% of your quota!${NC}"
        elif [[ $percent -ge 80 ]]; then
            echo -e "${YELLOW}Notice: You are using ${percent}% of your quota${NC}"
        else
            echo -e "Usage: ${percent}%"
        fi
    fi
}

case "${1:-}" in
    --all)
        if [[ $EUID -ne 0 ]]; then
            echo "Admin view requires root access"
            exit 1
        fi
        echo "Quota Report for All Users"
        echo "=========================="
        repquota -u / 2>/dev/null || echo "Quota system not enabled"
        ;;
    --help|-h)
        echo "DS01 Disk Quota Check"
        echo ""
        echo "Usage: quota-check [options]"
        echo ""
        echo "Options:"
        echo "  (none)     Check your quota"
        echo "  --all      Check all users (admin only)"
        echo "  --help     Show this help"
        ;;
    *)
        check_user_quota "${1:-$USER}"
        ;;
esac
