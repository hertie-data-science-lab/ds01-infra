#!/bin/bash
# Show resource usage statistics for user's containers

BLUE='\033[94m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
CYAN='\033[0;36m'
BOLD='\033[1m'
DIM='\033[2m'
NC='\033[0m'

USERNAME=$(whoami)
USER_ID=$(id -u)

usage() {
    echo ""
    echo -e "${BOLD}Container Resource Statistics${NC}"
    echo ""
    echo -e "${CYAN}Usage:${NC}"
    echo "  container-stats [name] [options]"
    echo ""
    echo -e "${CYAN}Arguments:${NC}"
    echo "  name              Specific container to show (optional)"
    echo ""
    echo -e "${CYAN}Options:${NC}"
    echo "  -w, --watch       Continuous monitoring (refresh every 2s)"
    echo "  -g, --gpu         Show GPU stats (if available)"
    echo "  --no-trunc        Don't truncate output"
    echo "  -h, --help        Show this help message"
    echo ""
    echo -e "${CYAN}Examples:${NC}"
    echo "  container-stats               # Show all your containers"
    echo "  container-stats my-project    # Show specific container"
    echo "  container-stats --watch       # Live monitoring"
    echo "  container-stats --gpu         # Include GPU stats"
    echo ""
    echo -e "${CYAN}Metrics shown:${NC}"
    echo "  â€¢ CPU usage (%)"
    echo "  â€¢ Memory usage / limit"
    echo "  â€¢ Network I/O"
    echo "  â€¢ Block I/O"
    echo "  â€¢ PIDs (processes)"
    echo ""
}

get_color_for_percentage() {
    local percent="$1"
    local value=${percent%\%}

    if (( $(echo "$value >= 90" | bc -l 2>/dev/null || echo "0") )); then
        echo "$RED"
    elif (( $(echo "$value >= 70" | bc -l 2>/dev/null || echo "0") )); then
        echo "$YELLOW"
    else
        echo "$GREEN"
    fi
}

format_bytes() {
    local bytes="$1"
    if [ -z "$bytes" ] || [ "$bytes" = "0" ]; then
        echo "0B"
        return
    fi

    local units=("B" "KB" "MB" "GB" "TB")
    local unit=0
    local size=$bytes

    while (( $(echo "$size >= 1024" | bc -l 2>/dev/null || echo "0") )) && [ $unit -lt 4 ]; do
        size=$(echo "scale=2; $size / 1024" | bc)
        unit=$((unit + 1))
    done

    echo "${size}${units[$unit]}"
}

show_gpu_stats() {
    if ! command -v nvidia-smi &> /dev/null; then
        return
    fi

    echo -e "\n${CYAN}â”â”â” GPU Statistics â”â”â”${NC}\n"

    # Get GPU info
    nvidia-smi --query-gpu=index,name,utilization.gpu,memory.used,memory.total,temperature.gpu \
        --format=csv,noheader,nounits 2>/dev/null | while IFS=, read -r idx name util mem_used mem_total temp; do

        # Trim whitespace
        idx=$(echo "$idx" | xargs)
        name=$(echo "$name" | xargs)
        util=$(echo "$util" | xargs)
        mem_used=$(echo "$mem_used" | xargs)
        mem_total=$(echo "$mem_total" | xargs)
        temp=$(echo "$temp" | xargs)

        # Color code based on utilization
        local color=$(get_color_for_percentage "${util}%")

        echo -e "${BOLD}GPU $idx:${NC} ${DIM}$name${NC}"
        echo -e "  Utilization: ${color}${util}%${NC}"
        echo -e "  Memory:      ${GREEN}${mem_used}MB${NC} / ${DIM}${mem_total}MB${NC}"
        echo -e "  Temperature: ${YELLOW}${temp}Â°C${NC}"
        echo ""
    done
}

show_container_stats() {
    local container_name="$1"
    local watch_mode="$2"
    local show_gpu="$3"

    local filter=""
    if [ -n "$container_name" ]; then
        local container_tag="${container_name}._.$USER_ID"
        filter="--filter name=^${container_tag}$"
    else
        filter="--filter name=._.$USER_ID"
    fi

    # Header
    if [ "$watch_mode" != "true" ]; then
        echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
        echo -e "${CYAN}${BOLD}    Container Resource Usage${NC}"
        echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}\n"
    else
        clear
        echo -e "${CYAN}${BOLD}Live Container Stats${NC} ${DIM}(Ctrl+C to exit)${NC}\n"
    fi

    # Get running containers
    local containers=$(docker ps --format "{{.Names}}" $filter 2>/dev/null)

    if [ -z "$containers" ]; then
        echo -e "${YELLOW}No running containers found${NC}\n"
        if [ -n "$container_name" ]; then
            echo "Start container: ${GREEN}container-run $container_name${NC}"
        else
            echo "View all containers: ${GREEN}container-list --all${NC}"
        fi
        echo ""
        return
    fi

    # Get stats
    docker stats --no-stream --format "table {{.Name}}\t{{.CPUPerc}}\t{{.MemUsage}}\t{{.MemPerc}}\t{{.NetIO}}\t{{.BlockIO}}\t{{.PIDs}}" $filter | \
    while IFS= read -r line; do
        # Skip header
        if [[ "$line" =~ ^NAME ]]; then
            echo -e "${BOLD}${line}${NC}" | sed "s/\._\.$USER_ID//g"
            continue
        fi

        # Parse line
        IFS=$'\t' read -r name cpu mem mem_perc net block pids <<< "$line"

        # Remove user ID from name
        name=$(echo "$name" | sed "s/\._\.$USER_ID//")

        # Color code CPU
        cpu_color=$(get_color_for_percentage "$cpu")

        # Color code memory
        mem_color=$(get_color_for_percentage "$mem_perc")

        echo -e "${CYAN}$name${NC}\t${cpu_color}${cpu}${NC}\t${mem_color}${mem}${NC}\t${mem_color}${mem_perc}${NC}\t${DIM}${net}${NC}\t${DIM}${block}${NC}\t${pids}"
    done

    # Resource limits
    if [ "$watch_mode" != "true" ] && [ -n "$container_name" ]; then
        echo ""
        echo -e "${CYAN}â”â”â” Resource Limits â”â”â”${NC}\n"

        local container_tag="${container_name}._.$USER_ID"
        local cpu_limit=$(docker inspect --format "{{.HostConfig.NanoCpus}}" "$container_tag" 2>/dev/null)
        local mem_limit=$(docker inspect --format "{{.HostConfig.Memory}}" "$container_tag" 2>/dev/null)

        if [ "$cpu_limit" != "0" ] && [ -n "$cpu_limit" ]; then
            cpu_limit=$((cpu_limit / 1000000000))
            echo -e "  CPU Limit:    ${GREEN}$cpu_limit cores${NC}"
        fi

        if [ "$mem_limit" != "0" ] && [ -n "$mem_limit" ]; then
            mem_limit=$((mem_limit / 1024 / 1024 / 1024))
            echo -e "  Memory Limit: ${GREEN}${mem_limit}GB${NC}"
        fi

        echo ""
    fi

    # GPU stats
    if [ "$show_gpu" = "true" ]; then
        show_gpu_stats
    fi

    # Summary
    if [ "$watch_mode" != "true" ]; then
        local total=$(echo "$containers" | wc -l | tr -d ' ')
        echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
        echo -e "${BOLD}Total running:${NC} $total container(s)"
        echo ""

        echo -e "${YELLOW}ğŸ’¡ Tips:${NC}"
        echo -e "   Live view:  ${GREEN}container-stats --watch${NC}"
        echo -e "   With GPU:   ${GREEN}container-stats --gpu${NC}"
        echo -e "   All info:   ${GREEN}container-list --detailed${NC}"
        echo ""
    fi
}

# Parse arguments
CONTAINER_NAME=""
WATCH_MODE=false
SHOW_GPU=false

while [[ $# -gt 0 ]]; do
    case $1 in
        -w|--watch)
            WATCH_MODE=true
            shift
            ;;
        -g|--gpu)
            SHOW_GPU=true
            shift
            ;;
        --no-trunc)
            # Docker stats option, pass through
            shift
            ;;
        -h|--help)
            usage
            exit 0
            ;;
        -*)
            echo -e "${RED}âœ— Unknown option: $1${NC}\n"
            usage
            exit 1
            ;;
        *)
            if [ -z "$CONTAINER_NAME" ]; then
                CONTAINER_NAME="$1"
            else
                echo -e "${RED}âœ— Too many arguments${NC}\n"
                usage
                exit 1
            fi
            shift
            ;;
    esac
done

# Watch mode
if [ "$WATCH_MODE" = true ]; then
    while true; do
        show_container_stats "$CONTAINER_NAME" "true" "$SHOW_GPU"
        sleep 2
    done
else
    show_container_stats "$CONTAINER_NAME" "false" "$SHOW_GPU"
fi
