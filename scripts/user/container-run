#!/bin/bash
# DS01 Container Run - Starts and attaches to containers via mlc-open
# Tier 2 Command - Can be used standalone or called by orchestrators

set -e

# Colors
BLUE='\033[94m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
CYAN='\033[0;36m'
BOLD='\033[1m'
DIM='\033[2m'
NC='\033[0m'

USERNAME=$(whoami)
USER_ID=$(id -u)

# Script paths
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
INFRA_ROOT="$(dirname "$SCRIPT_DIR")"
MLC_OPEN="/opt/aime-ml-containers/mlc-open"
RESOURCE_PARSER="$INFRA_ROOT/docker/get_resource_limits.py"

usage() {
    echo ""
    echo -e "${BOLD}DS01 Container Run${NC}"
    echo ""
    echo -e "${CYAN}Usage:${NC}"
    echo "  container-run <name> [options]"
    echo ""
    echo -e "${CYAN}Arguments:${NC}"
    echo "  name              Container name (required)"
    echo ""
    echo -e "${CYAN}Options:${NC}"
    echo "  --guided          Show detailed explanations for beginners"
    echo "  -h, --help        Show this help message"
    echo ""
    echo -e "${CYAN}Examples:${NC}"
    echo -e "  ${DIM}# Start and enter container${NC}"
    echo "  container-run my-project"
    echo ""
    echo -e "  ${DIM}# With guided explanations${NC}"
    echo "  container-run my-project --guided"
    echo ""
    echo -e "${YELLOW}ğŸ’¡ Inside the container:${NC}"
    echo -e "  â€¢ Your workspace: ${CYAN}/workspace${NC}"
    echo -e "  â€¢ Start Jupyter: ${GREEN}jlab${NC}"
    echo -e "  â€¢ Check GPU: ${GREEN}gpu${NC}"
    echo -e "  â€¢ Exit session: ${GREEN}exit${NC} (container keeps running)"
    echo ""
}

# Parse arguments
CONTAINER_NAME=""
GUIDED=false

while [[ $# -gt 0 ]]; do
    case $1 in
        --guided)
            GUIDED=true
            shift
            ;;
        -h|--help)
            usage
            exit 0
            ;;
        -*)
            echo -e "${RED}âœ— Unknown option: $1${NC}\n"
            usage
            exit 1
            ;;
        *)
            if [ -z "$CONTAINER_NAME" ]; then
                CONTAINER_NAME="$1"
            else
                echo -e "${RED}âœ— Too many arguments${NC}\n"
                usage
                exit 1
            fi
            shift
            ;;
    esac
done

# Validate container name
if [ -z "$CONTAINER_NAME" ]; then
    echo -e "${RED}âœ— Container name required${NC}\n"
    usage
    exit 1
fi

# Container tag (how docker sees it)
CONTAINER_TAG="${CONTAINER_NAME}._.${USER_ID}"

# Check if container exists
if ! docker ps -a --format "{{.Names}}" 2>/dev/null | grep -q "^${CONTAINER_TAG}$"; then
    echo -e "${RED}âœ— Container '$CONTAINER_NAME' does not exist${NC}"
    echo ""
    echo -e "${YELLOW}Create it first:${NC}"
    echo -e "  ${GREEN}container-create $CONTAINER_NAME${NC}"
    echo ""
    echo -e "${YELLOW}Or list your containers:${NC}"
    echo -e "  ${GREEN}container-list${NC}"
    echo ""
    exit 1
fi

# Show guided introduction
if [ "$GUIDED" = true ]; then
    echo ""
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${BOLD}Entering Container${NC}"
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
    echo -e "${BOLD}What's About to Happen:${NC}"
    echo ""
    echo "  You're about to enter your container's bash shell."
    echo "  This is like SSH-ing into your computing environment."
    echo ""
    echo -e "${BOLD}Inside the Container:${NC}"
    echo ""
    echo "  â€¢ Your workspace is at: ${CYAN}/workspace${NC}"
    echo "  â€¢ All your project files are there"
    echo "  â€¢ You have Python, PyTorch/TensorFlow, and GPU access"
    echo "  â€¢ You can run scripts, start Jupyter, train models, etc."
    echo ""
    echo -e "${BOLD}Helpful Commands Inside:${NC}"
    echo ""
    echo -e "  ${GREEN}gpu${NC}          Check GPU status (nvidia-smi)"
    echo -e "  ${GREEN}jlab${NC}         Start Jupyter Lab"
    echo -e "  ${GREEN}ws${NC}           Go to /workspace"
    echo -e "  ${GREEN}ll${NC}           List files"
    echo -e "  ${GREEN}exit-help${NC}    Show exit options"
    echo ""
    echo -e "${BOLD}How to Exit:${NC}"
    echo ""
    echo -e "  ${YELLOW}Important: There are different ways to exit!${NC}"
    echo ""
    echo "  ${BOLD}Option 1: Exit Session (Container Keeps Running)${NC}"
    echo -e "    â€¢ Type ${GREEN}exit${NC} or press ${GREEN}Ctrl+D${NC}"
    echo "    â€¢ Your bash session ends"
    echo "    â€¢ ${CYAN}Container keeps running in background${NC}"
    echo "    â€¢ You can re-enter anytime with: container-run $CONTAINER_NAME"
    echo "    â€¢ ${BOLD}Use this most of the time!${NC}"
    echo ""
    echo "  ${BOLD}Option 2: Stop Container (Free Resources)${NC}"
    echo "    â€¢ Exit first (type 'exit')"
    echo -e "    â€¢ Then run on host: ${GREEN}container-stop $CONTAINER_NAME${NC}"
    echo "    â€¢ Frees GPU and resources for others"
    echo "    â€¢ ${BOLD}Use this when you're done for the day${NC}"
    echo ""
    echo -e "${YELLOW}ğŸ’¡ Remember:${NC} Your files in /workspace are ${BOLD}always safe${NC}"
    echo "   Stopping a container doesn't delete your files!"
    echo ""
    read -p "Press Enter to enter the container..." </dev/tty
    echo ""
fi

# Check if mlc-open exists (base system)
if [ -f "$MLC_OPEN" ] && [ -x "$MLC_OPEN" ]; then
    # Use base system mlc-open
    if [ "$GUIDED" = false ]; then
        echo -e "${CYAN}Opening container '${CONTAINER_NAME}'...${NC}"
        echo ""
    fi

    # Call mlc-open
    bash "$MLC_OPEN" "$CONTAINER_NAME"
    EXIT_CODE=$?

else
    # Fallback to direct docker exec (if base system not available)
    if [ "$GUIDED" = false ]; then
        echo -e "${CYAN}Opening container '${CONTAINER_NAME}'...${NC}"
        echo ""
    fi

    # Start container if not running
    if ! docker ps --format "{{.Names}}" 2>/dev/null | grep -q "^${CONTAINER_TAG}$"; then
        docker start "$CONTAINER_TAG" >/dev/null 2>&1 || true
    fi

    # Check if ds01-init script is available
    INIT_AVAILABLE=$(docker exec "$CONTAINER_TAG" test -f /usr/local/bin/ds01-init 2>/dev/null && echo "yes" || echo "no")

    if [ "$INIT_AVAILABLE" = "yes" ]; then
        docker exec -it "$CONTAINER_TAG" /usr/local/bin/ds01-init
    else
        docker exec -it "$CONTAINER_TAG" /bin/bash
    fi
    EXIT_CODE=$?
fi

# Post-exit handling
echo ""

if [ "$GUIDED" = true ]; then
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${YELLOW}${BOLD}You've Exited the Container${NC}"
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
    echo -e "${BOLD}What Just Happened?${NC}"
    echo ""
    echo "  â€¢ Your bash session inside the container ended"
    echo "  â€¢ The container is ${GREEN}still running${NC} in the background"
    echo "  â€¢ All your files in /workspace are ${BOLD}safe${NC}"
    echo "  â€¢ GPU is still allocated to this container"
    echo ""
    echo -e "${BOLD}What You Can Do Now:${NC}"
    echo ""
    echo -e "  ${BOLD}1) Re-enter the Container${NC}"
    echo -e "     ${GREEN}container-run $CONTAINER_NAME${NC}"
    echo "     Continue working where you left off"
    echo "     Your Python environment, processes, everything is still there"
    echo ""
    echo -e "  ${BOLD}2) Stop the Container (Free Resources)${NC}"
    echo -e "     ${GREEN}container-stop $CONTAINER_NAME${NC}"
    echo "     Frees up GPU and resources for others"
    echo "     ${DIM}Do this when you're done for the day${NC}"
    echo ""
    echo -e "  ${BOLD}3) Check Container Status${NC}"
    echo -e "     ${GREEN}container-list${NC}"
    echo "     See all your containers and their status"
    echo ""
    echo -e "  ${BOLD}4) Check Resource Usage${NC}"
    echo -e "     ${GREEN}container-stats${NC}"
    echo "     See GPU and CPU usage"
    echo ""
    echo -e "${YELLOW}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${BOLD}Important Reminders:${NC}"
    echo ""
    echo "  â€¢ ${CYAN}Container running${NC} = GPU is allocated (even if idle)"
    echo "  â€¢ ${CYAN}Stopping container${NC} = Frees GPU for others"
    echo "  â€¢ ${GREEN}Your files are ALWAYS safe${NC} in ~/workspace/$CONTAINER_NAME"
    echo "  â€¢ ${GREEN}You can restart${NC} anytime without losing work"
    echo ""
    echo -e "${DIM}Be a good citizen: Stop containers when not actively using them!${NC}"
    echo ""

else
    # Non-guided: brief status
    # Check if container is still running
    if docker ps --format "{{.Names}}" 2>/dev/null | grep -q "^${CONTAINER_TAG}$"; then
        echo -e "${GREEN}âœ“${NC} Container still running"
        echo ""
        echo -e "${BOLD}Reconnect:${NC}      ${GREEN}container-run $CONTAINER_NAME${NC}"
        echo -e "${BOLD}Stop:${NC}          ${GREEN}container-stop $CONTAINER_NAME${NC}"
        echo -e "${BOLD}View status:${NC}   ${GREEN}container-list${NC}"
        echo ""
    else
        echo -e "${DIM}Container stopped${NC}"
        echo ""
        echo -e "${BOLD}Restart:${NC}       ${GREEN}container-run $CONTAINER_NAME${NC}"
        echo ""
    fi
fi

# Get idle timeout info
get_idle_timeout() {
    local username="$1"
    if [ -f "$RESOURCE_PARSER" ]; then
        python3 "$RESOURCE_PARSER" "$username" --idle-timeout 2>/dev/null || echo "48h"
    else
        echo "48h"
    fi
}

# Show idle timeout reminder
if docker ps --format "{{.Names}}" 2>/dev/null | grep -q "^${CONTAINER_TAG}$"; then
    IDLE_TIMEOUT=$(get_idle_timeout "$USERNAME")
    if [ "$IDLE_TIMEOUT" != "null" ] && [ "$IDLE_TIMEOUT" != "None" ]; then
        if [ "$GUIDED" = false ]; then
            echo -e "${DIM}Auto-stop after ${IDLE_TIMEOUT} of idle GPU time${NC}"
            echo ""
        fi
    fi
fi

exit $EXIT_CODE
