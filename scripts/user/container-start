#!/bin/bash
# DS01 Container Start - Starts stopped containers via mlc-start with DS01 UX
# Tier 2 Command - Wraps AIME mlc-start with interactive GUI and status display

set -e

# Script paths
SCRIPT_DIR="$(cd "$(dirname "$(readlink -f "${BASH_SOURCE[0]}")")" && pwd)"
INFRA_ROOT="$(dirname "$(dirname "$SCRIPT_DIR")")"
MLC_START="$INFRA_ROOT/aime-ml-containers/mlc-start"
RESOURCE_PARSER="$INFRA_ROOT/scripts/docker/get_resource_limits.py"

# Source interactive library
source /usr/local/lib/interactive-select.sh

BLUE='\033[94m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
CYAN='\033[0;36m'
BOLD='\033[1m'
DIM='\033[2m'
NC='\033[0m'

USERNAME=$(whoami)
USER_ID=$(id -u)

# Helper function to get user's resource limits
get_user_lifecycle_limits() {
    local username="$1"
    if [ ! -f "$RESOURCE_PARSER" ]; then
        echo "None|None|None"
        return
    fi

    local idle_timeout=$(python3 "$RESOURCE_PARSER" "$username" --idle-timeout 2>/dev/null || echo "None")
    local max_runtime=$(python3 "$RESOURCE_PARSER" "$username" --max-runtime 2>/dev/null || echo "None")
    local gpu_hold=$(python3 "$RESOURCE_PARSER" "$username" --gpu-hold-time 2>/dev/null || echo "None")

    echo "${idle_timeout}|${max_runtime}|${gpu_hold}"
}

usage() {
    echo ""
    echo -e "${BOLD}DS01 Container Start${NC}"
    echo ""
    echo -e "${CYAN}Usage:${NC}"
    echo "  container-start [name] [options]"
    echo "  container-start                  # Prompts to select stopped container (if none specified)"
    echo ""
    echo -e "${CYAN}Arguments:${NC}"
    echo "  name              Container name (optional - will prompt if not provided)"
    echo ""
    echo -e "${CYAN}Options:${NC}"
    echo "  --guided          Show detailed explanations for beginners"
    echo "  -h, --help        Show this help message"
    echo ""
    echo -e "${CYAN}Description:${NC}"
    echo "  Starts a stopped container without entering it."
    echo -e "  The container will run in the background."
    echo -e "  To enter the container, use: ${GREEN}container-run <name>${NC}"
    echo ""
    echo -e "${CYAN}Examples:${NC}"
    echo -e "  ${DIM}# Start a stopped container${NC}"
    echo "  container-start my-project"
    echo ""
    echo -e "  ${DIM}# With guided explanations${NC}"
    echo "  container-start my-project --guided"
    echo ""
    echo -e "  ${DIM}# Interactive selection${NC}"
    echo "  container-start"
    echo ""
    echo -e "${YELLOW}ğŸ’¡ Tip:${NC}"
    echo -e "  â€¢ To start AND enter: ${GREEN}container-run <name>${NC}"
    echo -e "  â€¢ To check status: ${GREEN}container-list${NC}"
    echo ""
    echo -e "${CYAN}After starting:${NC}"
    echo -e "  â€¢ Enter container: ${GREEN}container-run <name>${NC}"
    echo -e "  â€¢ View status:     ${GREEN}container-list${NC}"
    echo -e "  â€¢ Stop container:  ${GREEN}container-stop <name>${NC}"
    echo ""
}

start_container() {
    local container_name="$1"
    local container_tag="${container_name}._.$USER_ID"

    # Check if container exists
    if ! docker ps -a --format "{{.Names}}" | grep -q "^${container_tag}$"; then
        echo -e "${RED}âœ—${NC} Container '$container_name' not found"
        return 1
    fi

    # Check if already running
    if docker ps --format "{{.Names}}" | grep -q "^${container_tag}$"; then
        echo -e "${YELLOW}â—‹${NC} Container '$container_name' is already running"
        return 0
    fi

    # Get container info (DS01 display)
    local status=$(docker ps -a --format "{{.Status}}" --filter "name=^${container_tag}$" 2>/dev/null)
    local image=$(docker inspect --format "{{.Config.Image}}" "$container_tag" 2>/dev/null)

    echo -e "${BOLD}Container:${NC} ${CYAN}$container_name${NC}"
    echo -e "${BOLD}Status:${NC}    $status"
    echo -e "${BOLD}Image:${NC}     $image"
    echo ""

    # Check GPU availability before starting (Docker labels + validation)
    # Get container's allocated GPU from Docker labels
    ALLOCATED_GPU=$(docker inspect --format '{{index .Config.Labels "ds01.gpu.allocated"}}' "$container_tag" 2>/dev/null)
    GPU_UUID=$(docker inspect --format '{{index .Config.Labels "ds01.gpu.uuid"}}' "$container_tag" 2>/dev/null)

    if [ -n "$ALLOCATED_GPU" ] && [ "$ALLOCATED_GPU" != "<no value>" ]; then
        # Container has GPU allocated - verify it still exists

        # Check if GPU UUID exists in nvidia-smi output
        if [ -n "$GPU_UUID" ] && [ "$GPU_UUID" != "<no value>" ]; then
            if ! nvidia-smi -L 2>/dev/null | grep -q "$GPU_UUID"; then
                echo ""
                echo -e "${YELLOW}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
                echo -e "${YELLOW}${BOLD}    âš  GPU No Longer Available${NC}"
                echo -e "${YELLOW}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
                echo ""
                echo -e "${BOLD}This container was allocated:${NC} GPU $ALLOCATED_GPU ($GPU_UUID)"
                echo "That GPU is no longer available (MIG reconfiguration or system change)."
                echo ""
                echo -e "${BOLD}Options:${NC}"
                echo "  1. Recreate container with fresh GPU allocation"
                echo -e "     ${GREEN}container-remove $container_name && container-create $container_name <framework>${NC}"
                echo ""
                echo "  2. Start without GPU (if this is a CPU-only workload)"
                echo -e "     ${DIM}# Contact admin to modify container${NC}"
                echo ""
                echo -e "${GREEN}âœ“${NC} Your workspace files are safe in: ${DIM}~/workspace/$container_name/${NC}"
                echo ""

                # Check if auto-reallocation is possible
                AVAILABILITY_CHECKER="$INFRA_ROOT/scripts/docker/gpu-availability-checker.py"
                RESOURCE_PARSER="$INFRA_ROOT/scripts/docker/get_resource_limits.py"

                if [ -f "$AVAILABILITY_CHECKER" ] && [ -f "$RESOURCE_PARSER" ]; then
                    # Check if GPUs are available
                    MAX_GPUS=$(python3 "$RESOURCE_PARSER" "$USERNAME" --max-gpus 2>/dev/null || echo "1")
                    AVAILABLE_CHECK=$(python3 "$AVAILABILITY_CHECKER" check-user "$USERNAME" "$MAX_GPUS" 2>/dev/null || echo "")

                    if echo "$AVAILABLE_CHECK" | grep -q "CAN_ALLOCATE"; then
                        echo -e "${BOLD}Auto-reallocation available:${NC}"
                        echo "  GPUs are currently available. You can automatically reallocate."
                        echo ""
                        read -p "  Reallocate GPU and recreate container? (y/N): " -n 1 -r
                        echo ""

                        if [[ $REPLY =~ ^[Yy]$ ]]; then
                            echo ""
                            echo -e "${CYAN}Reallocating GPU and recreating container...${NC}"

                            # Get framework from container
                            FRAMEWORK=$(docker inspect --format '{{index .Config.Labels "aime.mlc.FRAMEWORK"}}' "$container_tag" 2>/dev/null | cut -d'-' -f1)

                            if [ -n "$FRAMEWORK" ] && [ "$FRAMEWORK" != "<no value>" ]; then
                                # Remove and recreate
                                echo -e "${DIM}Removing old container...${NC}"
                                container-remove "$container_name" --force 2>/dev/null || docker rm -f "$container_tag" 2>/dev/null || true

                                echo -e "${DIM}Creating new container with fresh GPU allocation...${NC}"
                                if container-create "$container_name" "$FRAMEWORK"; then
                                    echo ""
                                    echo -e "${GREEN}âœ“${NC} Container recreated successfully with new GPU"
                                    return 0
                                else
                                    echo -e "${RED}âœ—${NC} Failed to recreate container"
                                    return 1
                                fi
                            else
                                echo -e "${YELLOW}Could not detect framework - manual recreation required${NC}"
                            fi
                        fi
                    fi
                fi

                return 1
            fi
        fi
    fi

    # Check if mlc-start exists
    if [ ! -f "$MLC_START" ]; then
        # Fallback to docker start
        echo -e "${CYAN}Starting container...${NC}\n"
        if docker start "$container_tag" > /dev/null 2>&1; then
            echo -e "${GREEN}âœ“${NC} Container started"
            return 0
        else
            echo -e "${RED}âœ—${NC} Failed to start container"
            return 1
        fi
    fi

    # Start container via mlc-start (AIME Tier 1)
    echo -e "${CYAN}Starting container...${NC}"
    if bash "$MLC_START" "$container_name" -s > /dev/null 2>&1; then
        echo -e "${GREEN}âœ“${NC} Container started"
        return 0
    else
        # Fallback to docker start
        if docker start "$container_tag" > /dev/null 2>&1; then
            echo -e "${GREEN}âœ“${NC} Container started"
            return 0
        else
            echo -e "${RED}âœ—${NC} Failed to start container"
            return 1
        fi
    fi
}

# Parse arguments
CONTAINER_NAME=""
GUIDED=false

while [[ $# -gt 0 ]]; do
    case $1 in
        --guided)
            GUIDED=true
            shift
            ;;
        -h|--help|--info)
            usage
            exit 0
            ;;
        -*)
            echo -e "${RED}âœ— Unknown option: $1${NC}\n"
            usage
            exit 1
            ;;
        *)
            if [ -z "$CONTAINER_NAME" ]; then
                CONTAINER_NAME="$1"
            else
                echo -e "${RED}âœ— Too many arguments${NC}\n"
                usage
                exit 1
            fi
            shift
            ;;
    esac
done

echo ""
echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${CYAN}${BOLD}    Starting Container${NC}"
echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}\n"

# Show guided explanation BEFORE selection
if [ "$GUIDED" = true ] && [ -z "$CONTAINER_NAME" ]; then
    echo -e "${CYAN}â„¹ ${NC}${BOLD}What does starting mean?${NC}"
    echo ""
    echo -e "  Starting a container resumes it from a stopped state."
    echo -e "  This will:"
    echo -e "  â€¢ Allocate necessary resources (CPU, GPU, memory)"
    echo -e "  â€¢ Boot up the container's operating system"
    echo -e "  â€¢ Restore the container to its previous state"
    echo -e "  â€¢ Make it available for connections"
    echo -e "  â€¢ The container will be available for ${GREEN}container-run${NC} immediately"
    echo ""
    echo -e "  ${YELLOW}Note:${NC} This ${BOLD}does not${NC} automatically connect you to the container."
    echo -e "  To enter the container, use: ${GREEN}container-run <name>${NC}"
    echo ""
fi

# If no container name provided, prompt to select stopped container (DS01 UX)
if [ -z "$CONTAINER_NAME" ]; then
    CONTAINER_NAME=$(select_container "stopped")
    if [ -z "$CONTAINER_NAME" ]; then
        echo "No selection made. Exiting."
        exit 0
    fi
    echo ""
fi

# Validate container name
if [ -z "$CONTAINER_NAME" ]; then
    echo -e "${RED}âœ— Container name is required${NC}\n"
    usage
    exit 1
fi

# Start container
if start_container "$CONTAINER_NAME"; then
    echo ""
    echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${GREEN}${BOLD}    âœ“ Container Started${NC}"
    echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}\n"

    IFS='|' read -r idle_timeout max_runtime gpu_hold <<< "$(get_user_lifecycle_limits "$USERNAME")"


    echo -e "${CYAN}â„¹ ${NC}${BOLD}Your resource limits:${NC}"
    if [ "$max_runtime" != "None" ] && [ "$max_runtime" != "null" ]; then
        echo -e "  â€¢ Max continuous runtime: ${CYAN}$max_runtime${NC}"
    fi
    if [ "$idle_timeout" != "None" ] && [ "$idle_timeout" != "null" ]; then
        echo -e "  â€¢ Idle timeout: ${CYAN}$idle_timeout${NC} ${DIM}(auto-stop after GPU idle)${NC}"
    fi
    if [ "$gpu_hold" != "None" ] && [ "$gpu_hold" != "null" ] && [ "$gpu_hold" != "indefinite" ]; then
        echo -e "  â€¢ Restart window: ${CYAN}$gpu_hold${NC} ${DIM}(Container / GPU hold after stop)${NC}"
    elif [ "$gpu_hold" = "indefinite" ]; then
        echo -e "  â€¢ GPU held indefinitely until cleanup"
    fi
    echo ""

    echo -e "${BOLD}Next Steps:${NC}"
    echo -e "  â€¢ Enter container: ${GREEN}container-run $CONTAINER_NAME${NC}"
    echo -e "  â€¢ View status:     ${GREEN}container-list${NC}"
    echo -e "  â€¢ Stop container:  ${GREEN}container-stop $CONTAINER_NAME${NC}"
    echo ""
else
    echo ""
    echo -e "${RED}Failed to start container${NC}\n"
    echo -e "${BOLD}Try:${NC}"
    echo -e "  â€¢ Check status: ${GREEN}container-list --all${NC}"
    echo -e "  â€¢ Check logs:   ${BLUE}docker logs ${CONTAINER_NAME}._.$USER_ID${NC}"
    echo ""
    exit 1
fi
