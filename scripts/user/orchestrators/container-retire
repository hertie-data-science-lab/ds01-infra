#!/bin/bash
# DS01 Container Retire - L3 Orchestrator
# Streamlined workflow: Stop container â†’ Remove container (single command)
# Combines container-stop + container-remove with unified messaging

set -e

# Source DS01 standard library (colors, paths, utilities)
source "${DS01_ROOT:-/opt/ds01-infra}/scripts/lib/init.sh"

# Source DS01 context library
if [[ -f "${DS01_LIB}/ds01-context.sh" ]]; then
    source "${DS01_LIB}/ds01-context.sh"
fi

# Set orchestration context - suppresses atomic command "Next steps" output
export DS01_CONTEXT="orchestration"
export DS01_INTERFACE="orchestration"

# Legacy compatibility
export DS01_ORCHESTRATOR=retire

USERNAME=$(whoami)
USER_ID=$(id -u)

# Script paths
SCRIPT_DIR="/opt/ds01-infra/scripts/user"
INFRA_ROOT="/opt/ds01-infra"
CONTAINER_STOP="$SCRIPT_DIR/atomic/container-stop"
CONTAINER_REMOVE="$SCRIPT_DIR/atomic/container-remove"

# Source interactive library (with fallback for development)
if [ -f "/usr/local/lib/interactive-select.sh" ]; then
    source /usr/local/lib/interactive-select.sh
elif [ -f "$INFRA_ROOT/scripts/lib/interactive-select.sh" ]; then
    source "$INFRA_ROOT/scripts/lib/interactive-select.sh"
else
    echo "Error: interactive-select.sh not found"
    exit 1
fi

# Detect new pip packages installed in container vs base image
# Returns newline-separated list of new packages, or empty if none
detect_new_packages() {
    local container_tag="$1"
    local image="$2"

    # Get pip packages from container (only names, not versions)
    local container_pkgs
    container_pkgs=$(docker exec "$container_tag" pip list --format=freeze 2>/dev/null | cut -d= -f1 | sort -u)
    if [ -z "$container_pkgs" ]; then
        return
    fi

    # Get pip packages from base image (run temp container)
    local image_pkgs
    image_pkgs=$(docker run --rm --entrypoint pip "$image" list --format=freeze 2>/dev/null | cut -d= -f1 | sort -u)
    if [ -z "$image_pkgs" ]; then
        return
    fi

    # Find packages in container but not in image
    comm -23 <(echo "$container_pkgs") <(echo "$image_pkgs") 2>/dev/null
}

usage() {
    echo ""
    echo -e "${BOLD}DS01 Container Retire${NC}"
    echo -e "${DIM}L3 Orchestrator - Stops and removes containers in one command${NC}"
    echo ""
    echo -e "${CYAN}Usage:${NC}"
    echo "  container-retire [name] [options]"
    echo "  container-retire                  # Interactive mode - prompts to select"
    echo ""
    echo -e "${CYAN}Arguments:${NC}"
    echo "  name              Container name (optional - will prompt if not provided)"
    echo ""
    echo -e "${CYAN}Options:${NC}"
    echo "  --guided          Show detailed explanations for beginners"
    echo "  -f, --force       Skip confirmation and save prompts (non-interactive)"
    echo "  --save-packages   Automatically save new packages to image (no prompt)"
    echo "  --images          Also remove the Docker image after retiring"
    echo "  --dry-run         Show what would be done"
    echo "  -h, --help        Show this help message"
    echo ""
    echo -e "${CYAN}What this does:${NC}"
    echo "  1. Stops the container (if running)"
    echo "  2. Prompts to save changes to image (optional, via docker commit)"
    echo "  3. Removes the container"
    echo "  4. Releases GPU immediately"
    echo ""
    echo -e "${CYAN}What is preserved:${NC}"
    echo -e "  ${GREEN}âœ“${NC} Workspace files (~/workspace/<project>/)"
    echo -e "  ${GREEN}âœ“${NC} Dockerfiles (~/dockerfiles/)"
    echo -e "  ${GREEN}âœ“${NC} Docker images"
    echo -e "  ${GREEN}âœ“${NC} Project configuration files"
    echo ""
    echo -e "${CYAN}Examples:${NC}"
    echo -e "  ${DIM}# Retire specific container (interactive)${NC}"
    echo "  container-retire my-old-project"
    echo ""
    echo -e "  ${DIM}# Interactive selection${NC}"
    echo "  container-retire"
    echo ""
    echo -e "  ${DIM}# Skip confirmations${NC}"
    echo "  container-retire my-project --force"
    echo ""
    echo -e "  ${DIM}# Guided mode for beginners${NC}"
    echo "  container-retire --guided"
    echo ""
    echo -e "${CYAN}Advanced (L2 Atomic commands):${NC}"
    echo "  For granular control over container lifecycle:"
    echo -e "  1. ${GREEN}container-stop <name>${NC}    # Stop container"
    echo -e "  2. ${GREEN}container-remove <name>${NC}  # Remove container"
    echo -e "  ${DIM}See: help --atomic${NC}"
    echo ""
    echo -e "${YELLOW}ğŸ’¡ Saving changes - Best practices:${NC}"
    echo -e "  ${BOLD}Recommended:${NC} Update Dockerfile first"
    echo -e "    ${GREEN}image-update <name> --add \"package1 package2\"${NC}"
    echo -e "    Then rebuild image and redeploy container"
    echo -e "    ${DIM}(Reproducible, version-controlled, team-shareable)${NC}"
    echo ""
    echo -e "  ${BOLD}Quick option:${NC} Save via docker commit (during retirement)"
    echo -e "    Prompts during container-retire to commit changes to image"
    echo -e "    ${DIM}(Fast but not in Dockerfile - gets overwritten on next rebuild)${NC}"
    echo ""
    echo -e "${YELLOW}ğŸ’¡ Use this when:${NC}"
    echo "  â€¢ Completely done with a container"
    echo "  â€¢ Want to free GPU immediately for others"
    echo "  â€¢ Need to recreate container from scratch"
    echo ""
    echo -e "${DIM}Run 'help' or 'commands' anytime to see available commands.${NC}"
    echo ""
}

detailed_help() {
    echo ""
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${BOLD}DS01 Container Retire - Full Reference${NC}"
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
    echo -e "${DIM}L3 Orchestrator - Combines stop + remove in one command${NC}"
    echo ""
    echo -e "${BOLD}Usage:${NC}"
    echo "  container-retire [name] [options]"
    echo "  container-retire                  # Interactive selection"
    echo ""
    echo -e "${BOLD}Positional Arguments:${NC}"
    echo "  name              Container to retire (optional - prompts if omitted)"
    echo ""
    echo -e "${BOLD}Options:${NC}"
    echo "  --guided          Step-by-step with explanations"
    echo "  -f, --force       Skip all confirmations"
    echo "  --save-packages   Auto-save new packages to image (no prompt)"
    echo "  --images          Also remove Docker image after retiring"
    echo "  --dry-run         Preview without executing"
    echo "  --concepts        Show pre-run educational content"
    echo "  --info            Show this detailed reference"
    echo "  -h, --help        Show quick reference"
    echo ""
    echo -e "${BOLD}Workflow:${NC}"
    echo "  container-retire performs:"
    echo "  1. container-stop - Stops the container"
    echo "  2. Optionally prompts to commit changes to image"
    echo "  3. container-remove - Removes the container"
    echo "  4. Releases GPU allocation immediately"
    echo ""
    echo -e "${BOLD}What's Preserved:${NC}"
    echo -e "  ${GREEN}âœ“${NC} Workspace files (~/workspace/<project>/)"
    echo -e "  ${GREEN}âœ“${NC} Dockerfiles (~/dockerfiles/)"
    echo -e "  ${GREEN}âœ“${NC} Docker images"
    echo ""
    echo -e "${BOLD}What's Removed:${NC}"
    echo -e "  ${RED}âœ—${NC} Container instance (easily recreated)"
    echo -e "  ${RED}âœ—${NC} GPU allocation (freed for others)"
    echo ""
    echo -e "${BOLD}Examples:${NC}"
    echo ""
    echo -e "  ${DIM}# Interactive mode (select from list)${NC}"
    echo "  container-retire"
    echo ""
    echo -e "  ${DIM}# Retire specific container${NC}"
    echo "  container-retire my-project"
    echo ""
    echo -e "  ${DIM}# Quick retire (no prompts)${NC}"
    echo "  container-retire my-project --force"
    echo ""
    echo -e "  ${DIM}# Preview what would happen${NC}"
    echo "  container-retire my-project --dry-run"
    echo ""
    echo -e "${BOLD}Saving Changes:${NC}"
    echo ""
    echo -e "  ${CYAN}Recommended:${NC} Update Dockerfile + rebuild"
    echo "    1. image-update <name> --add \"new-packages\""
    echo "    2. container-retire <name>"
    echo "    3. container-deploy <name>"
    echo "    (Reproducible, version-controlled)"
    echo ""
    echo -e "  ${CYAN}Quick option:${NC} docker commit during retire"
    echo "    Prompts to save container state to image"
    echo "    (Fast but not in Dockerfile)"
    echo ""
    echo -e "${BOLD}Related Commands:${NC}"
    echo -e "  ${GREEN}container-deploy${NC}    Create + start (opposite of retire)"
    echo -e "  ${GREEN}container-list${NC}      View your containers"
    echo ""
}

show_concepts() {
    echo ""
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${BOLD}Understanding Container Retirement${NC}"
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
    echo -e "${BOLD}What does container-retire do?${NC}"
    echo "  Cleanly shuts down and removes a container:"
    echo "  1. Stops the container (if running)"
    echo "  2. Optionally saves changes to the image"
    echo "  3. Removes the container"
    echo "  4. Frees GPU for others immediately"
    echo ""
    echo -e "${BOLD}Key Terms:${NC}"
    echo -e "  â€¢ ${CYAN}Retire${NC} - Stop + remove in one step"
    echo -e "  â€¢ ${CYAN}GPU Release${NC} - GPU becomes available for others"
    echo -e "  â€¢ ${CYAN}Commit${NC} - Save container changes to image"
    echo ""
    echo -e "${CYAN}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
    echo ""
    echo -e "${BOLD}Deploy vs Retire:${NC}"
    echo ""
    echo -e "  ${GREEN}container-deploy${NC}  = Create + Start"
    echo -e "  ${YELLOW}container-retire${NC}  = Stop + Remove"
    echo ""
    echo "  They are opposites - deploy to start working,"
    echo "  retire when you're done to free resources."
    echo ""
    echo -e "${CYAN}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
    echo ""
    echo -e "${BOLD}Your Data is Safe:${NC}"
    echo ""
    echo "  Retiring a container does NOT delete:"
    echo -e "  ${GREEN}âœ“${NC} Your workspace files"
    echo -e "  ${GREEN}âœ“${NC} Your Dockerfiles"
    echo -e "  ${GREEN}âœ“${NC} Your Docker images"
    echo ""
    echo "  You can always recreate the container:"
    echo -e "  ${GREEN}container-deploy my-project${NC}"
    echo ""
    echo -e "${CYAN}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
    echo ""
    echo -e "${BOLD}When to Retire:${NC}"
    echo ""
    echo "  â€¢ Done working for the day"
    echo "  â€¢ Need to free GPU for others"
    echo "  â€¢ Want a fresh container start"
    echo "  â€¢ Switching to a different project"
    echo ""
    echo -e "${BOLD}Ready to retire a container?${NC}"
    echo -e "  Run: ${GREEN}container-retire${NC}              (interactive selection)"
    echo -e "  Run: ${GREEN}container-retire my-project${NC}   (specific container)"
    echo ""
}

# Parse arguments
CONTAINER_NAME=""
GUIDED=false
FORCE=false
SKIP_INITIAL_CONFIRM=false
DRY_RUN=false
SAVE_PACKAGES=false
REMOVE_IMAGE=false

while [[ $# -gt 0 ]]; do
    case $1 in
        --guided)
            GUIDED=true
            shift
            ;;
        -f|--force)
            FORCE=true
            shift
            ;;
        --skip-initial-confirm)
            # Skip only the "Continue? [y/N]" prompt, but show save/image prompts
            # Used when called from container-deploy option 2 (user already confirmed)
            SKIP_INITIAL_CONFIRM=true
            shift
            ;;
        --dry-run)
            DRY_RUN=true
            shift
            ;;
        --save-packages)
            # Automatically save new packages via docker commit (no prompt)
            SAVE_PACKAGES=true
            shift
            ;;
        --images)
            # Also remove the Docker image after retiring
            REMOVE_IMAGE=true
            shift
            ;;
        -h|--help)
            usage
            exit 0
            ;;
        --info)
            detailed_help
            exit 0
            ;;
        --concepts)
            show_concepts
            exit 0
            ;;
        -*)
            echo -e "${RED}âœ— Unknown option: $1${NC}\n"
            usage
            exit 1
            ;;
        *)
            if [ -z "$CONTAINER_NAME" ]; then
                CONTAINER_NAME="$1"
            else
                echo -e "${RED}âœ— Too many arguments${NC}\n"
                usage
                exit 1
            fi
            shift
            ;;
    esac
done

echo ""
echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${BOLD}DS01 Container Retire${NC}"
echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""

if [ "$GUIDED" = true ]; then
    echo -e "${CYAN}â„¹ ${NC}${BOLD}What does retiring mean?${NC}"
    echo ""
    echo "  Retiring a container means:"
    echo -e "  â€¢ ${BOLD}Stop${NC} all running processes inside the container"
    echo -e "  â€¢ ${BOLD}Remove${NC} the container instance completely"
    echo -e "  â€¢ ${BOLD}Release${NC} GPU allocation immediately for others"
    echo ""
    echo -e "${BOLD}What stays safe:${NC}"
    echo -e "  â€¢ ${GREEN}âœ“${NC} All workspace files (~/workspace/<project>/)"
    echo -e "  â€¢ ${GREEN}âœ“${NC} Dockerfiles (~/dockerfiles/)"
    echo -e "  â€¢ ${GREEN}âœ“${NC} Docker images (your blueprints)"
    echo ""
    echo -e "${BOLD}You can recreate anytime:${NC}"
    echo -e "  ${GREEN}container deploy <name>${NC}  ${DIM}# Recreate from image${NC}"
    echo ""
    echo -e "${YELLOW}ğŸ’¡ Think of it:${NC} Shutting down a laptop (container) but keeping your files (workspace)"
    echo ""
    read -r -t 0.1 -n 10000 discard </dev/tty 2>/dev/null || true
    read -p "Press Enter to continue..." </dev/tty
    echo ""
fi

# If no container name, prompt for selection
if [ -z "$CONTAINER_NAME" ]; then
    echo -e "${CYAN}Select container to retire:${NC}"
    echo ""
    CONTAINER_NAME=$(select_container "running")

    if [ -z "$CONTAINER_NAME" ]; then
        # No running containers, try stopped
        echo ""
        echo -e "${YELLOW}No running containers found.${NC}"
        echo ""
        CONTAINER_NAME=$(select_container "stopped")

        if [ -z "$CONTAINER_NAME" ]; then
            echo ""
            echo -e "${YELLOW}No containers to retire.${NC}"
            exit 0
        fi
    fi
    echo ""
fi

# Validate container exists
CONTAINER_TAG="${CONTAINER_NAME}._.${USER_ID}"
if ! docker ps -a --format "{{.Names}}" 2>/dev/null | grep -q "^${CONTAINER_TAG}$"; then
    echo -e "${RED}âœ— Container '$CONTAINER_NAME' not found${NC}"
    exit 1
fi

# Check if container is running or stopped
CONTAINER_STATUS=$(docker inspect -f '{{.State.Status}}' "$CONTAINER_TAG" 2>/dev/null || echo "")

if [ "$DRY_RUN" = true ]; then
    echo -e "${YELLOW}â”â”â” DRY RUN MODE â”â”â”${NC}"
    echo ""
    echo -e "Would retire container: ${CYAN}$CONTAINER_NAME${NC}"
    echo ""
    if [ "$CONTAINER_STATUS" = "running" ]; then
        echo -e "  ${DIM}1. Stop container${NC}"
    fi
    echo -e "  ${DIM}2. Prompt to save changes to image${NC}"
    echo -e "  ${DIM}3. Remove container${NC}"
    echo -e "  ${DIM}4. Release GPU allocation${NC}"
    echo ""
    exit 0
fi

# Confirm retirement (unless --force or --skip-initial-confirm)
if [ "$FORCE" != "true" ] && [ "$SKIP_INITIAL_CONFIRM" != "true" ]; then
    echo -e "${YELLOW}âš  This will stop & remove container: ${BOLD}$CONTAINER_NAME${NC}\n"
    if [ "$GUIDED" = "true" ]; then
        echo -e "${BOLD}What will happen:${NC}"
        if [ "$CONTAINER_STATUS" = "running" ]; then
            echo "  1. Container will be stopped"
            echo "  2. All running processes will be terminated"
            echo "  3. You'll be prompted to save changes to image (optional)"
            echo "  4. Container will be removed"
            echo "  5. GPU will be released immediately"
        else
            echo "  1. You'll be prompted to save changes to image (optional)"
            echo "  2. Container will be removed"
            echo "  3. GPU will be released immediately"
        fi
        echo ""
        echo -e "${BOLD}What stays safe:${NC}"
        echo -e "  â€¢ ${GREEN}Workspace files${NC} in ~/workspace/$CONTAINER_NAME/"
        echo -e "  â€¢ ${GREEN}Dockerfiles${NC} in ~/dockerfiles/"
        echo -e "  â€¢ ${GREEN}Docker images${NC}"
        echo ""
    fi

    read -r -t 0.1 -n 10000 discard </dev/tty 2>/dev/null || true
    read -p "Continue? [y/N]: " CONFIRM </dev/tty
    if [[ ! "$CONFIRM" =~ ^[Yy]$ ]]; then
        echo "Cancelled."
        exit 0
    fi
    echo ""
fi

# Check for new packages BEFORE stopping (while container is still running)
PACKAGES_SAVED=false
if [ "$CONTAINER_STATUS" = "running" ] && [ "$FORCE" != "true" ]; then
    # Get the image used by this container
    IMAGE=$(docker inspect --format "{{.Config.Image}}" "$CONTAINER_TAG" 2>/dev/null || echo "")

    if [ -n "$IMAGE" ]; then
        # Detect new packages
        NEW_PACKAGES=$(detect_new_packages "$CONTAINER_TAG" "$IMAGE")
        PKG_COUNT=$(echo "$NEW_PACKAGES" | grep -c . 2>/dev/null) || PKG_COUNT=0
        # Fix: grep -c can include newline in output
        PKG_COUNT=$(echo "$PKG_COUNT" | tr -d '[:space:]')

        if [ "$PKG_COUNT" -gt 0 ] 2>/dev/null; then
            echo -e "${CYAN}â”â”â” New Packages Detected â”â”â”${NC}"
            echo ""

            # Format packages for display and command
            PKG_LIST=$(echo "$NEW_PACKAGES" | tr '\n' ' ' | sed 's/ $//')

            echo -e "${YELLOW}Found ${BOLD}$PKG_COUNT${NC} new package(s) installed:"
            echo ""
            if [ "$PKG_COUNT" -le 10 ]; then
                echo "$NEW_PACKAGES" | while read -r pkg; do
                    [ -n "$pkg" ] && echo -e "  - ${CYAN}$pkg${NC}"
                done
            else
                echo "$NEW_PACKAGES" | head -8 | while read -r pkg; do
                    [ -n "$pkg" ] && echo -e "  - ${CYAN}$pkg${NC}"
                done
                echo -e "  ${DIM}... and $((PKG_COUNT - 8)) more${NC}"
            fi
            echo ""

            # Handle --save-packages flag (auto-save without prompt)
            if [ "$SAVE_PACKAGES" = true ]; then
                echo -e "${CYAN}Committing changes to image (--save-packages)...${NC}"
                if docker commit "$CONTAINER_TAG" "$IMAGE" > /dev/null 2>&1; then
                    echo -e "${GREEN}OK${NC} Changes saved to image"
                    PACKAGES_SAVED=true
                else
                    echo -e "${YELLOW}Warning:${NC} Failed to commit changes"
                fi
                echo ""
            else
                # Interactive prompt
                if [ "$GUIDED" = true ]; then
                    echo -e "${BOLD}Options to preserve these packages:${NC}"
                    echo ""
                    echo -e "  ${BOLD}1. Update Dockerfile (Recommended)${NC}"
                    echo "     Reproducible, version-controlled, shareable"
                    echo ""
                    echo -e "  ${BOLD}2. Docker commit (Quick but fragile)${NC}"
                    echo "     Fast, but lost on next Dockerfile rebuild"
                    echo ""
                fi

                echo -e "${BOLD}Recommended:${NC} Update Dockerfile with:"
                echo -e "  ${GREEN}image-update $CONTAINER_NAME --add \"$PKG_LIST\"${NC}"
                echo ""
                read -r -t 0.1 -n 10000 discard </dev/tty 2>/dev/null || true
                read -p "Save via docker commit instead? [y/N]: " SAVE_IMAGE </dev/tty

                if [[ "$SAVE_IMAGE" =~ ^[Yy]$ ]]; then
                    echo ""
                    echo -e "${CYAN}Committing changes to image...${NC}"
                    if docker commit "$CONTAINER_TAG" "$IMAGE" > /dev/null 2>&1; then
                        echo -e "${GREEN}OK${NC} Changes saved to image"
                        PACKAGES_SAVED=true
                    else
                        echo -e "${YELLOW}Warning:${NC} Failed to commit changes"
                    fi
                else
                    echo ""
                    echo -e "Skipped. To add permanently: ${GREEN}image-update $CONTAINER_NAME --add \"$PKG_LIST\"${NC}"
                fi
                echo ""
            fi
        fi
    fi
fi

# Step 1: Stop container (if running)
if [ "$CONTAINER_STATUS" = "running" ]; then
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${BOLD}Step 1/2: Stopping Container${NC}"
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""

    if [ "$GUIDED" = true ]; then
        echo -e "${CYAN}â„¹ ${NC}${BOLD}Stopping the container...${NC}"
        echo ""
        echo "  This will gracefully shut down all processes."
        echo ""
    fi

    # Clean up any keep-alive processes (defensive - usually already cleaned up)
    docker exec "$CONTAINER_TAG" pkill -f "\[ds01-keep-alive\]" 2>/dev/null || true

    echo -e "${CYAN}Stopping container...${NC}"
    if docker stop -t 10 "$CONTAINER_TAG" > /dev/null 2>&1; then
        echo -e "${GREEN}âœ“${NC} Container stopped"
        echo ""
    else
        echo -e "${RED}âœ— Failed to stop container${NC}"
        exit 1
    fi
fi

# Step 2: Remove container (which includes save image prompt if in interactive mode)
echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
if [ "$CONTAINER_STATUS" = "running" ]; then
    echo -e "${BOLD}Step 2/2: Removing Container${NC}"
else
    echo -e "${BOLD}Removing Container${NC}"
fi
echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""

# Call container-remove with flags to skip prompts we already handled
# --skip-removal-confirm: we already confirmed above
# --skip-save-prompt: we already handled package detection above
REMOVE_ARGS=("--skip-removal-confirm" "--skip-save-prompt")
if [ "$GUIDED" = true ]; then
    REMOVE_ARGS+=("--guided")
fi
if [ "$FORCE" = true ]; then
    REMOVE_ARGS+=("--force")
fi

if "$CONTAINER_REMOVE" "$CONTAINER_NAME" "${REMOVE_ARGS[@]}"; then
    echo ""
    echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${GREEN}${BOLD}âœ“ Container Retired Successfully!${NC}"
    echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""

    if [ "$GUIDED" = true ]; then
        echo -e "${BOLD}What was done:${NC}"
        echo ""
        if [ "$CONTAINER_STATUS" = "running" ]; then
            echo -e "  ${GREEN}âœ“${NC} Container stopped"
        fi
        echo -e "  ${GREEN}âœ“${NC} Container removed"
        echo -e "  ${GREEN}âœ“${NC} GPU released immediately"
        echo ""
        echo -e "${BOLD}Your data is safe:${NC}"
        echo -e "  ${GREEN}âœ“${NC} Workspace: ~/workspace/$CONTAINER_NAME/"
        echo -e "  ${GREEN}âœ“${NC} Dockerfile: ~/dockerfiles/"
        echo -e "  ${GREEN}âœ“${NC} Docker image: Available for redeployment"
        echo ""
        echo -e "${BOLD}To recreate:${NC}"
        echo -e "  ${GREEN}container deploy $CONTAINER_NAME${NC}"
        echo ""
        echo -e "${YELLOW}ğŸ’¡ Tip:${NC}"
        echo "  You can quickly recreate this container anytime."
        echo "  All your workspace files are safe and waiting."
        echo ""
    else
        echo -e "${BOLD}Summary:${NC}"
        if [ "$CONTAINER_STATUS" = "running" ]; then
            echo -e "  ${GREEN}âœ“${NC} Container stopped and removed"
        else
            echo -e "  ${GREEN}âœ“${NC} Container removed"
        fi
        echo -e "  ${GREEN}âœ“${NC} GPU freed immediately"
        echo ""
        echo -e "${DIM}Workspace files safe in: ~/workspace/$CONTAINER_NAME/${NC}"
        echo ""
        echo -e "${BOLD}To recreate:${NC}  ${GREEN}container deploy $CONTAINER_NAME${NC}"
        echo ""
    fi

    # Handle image removal (--images flag or interactive prompt)
    # --force skips container confirmations but not this prompt (unless --images is used)
    {
        # Get image info
        IMAGE_NAME="ds01-$(id -u)/$CONTAINER_NAME:latest"
        IMAGE_SIZE=$(docker images "$IMAGE_NAME" --format "{{.Size}}" 2>/dev/null)
        DOCKERFILE="$HOME/dockerfiles/${CONTAINER_NAME}.Dockerfile"
        DOCKERFILE_SIZE=""
        if [ -f "$DOCKERFILE" ]; then
            DOCKERFILE_SIZE=$(du -h "$DOCKERFILE" 2>/dev/null | cut -f1)
        fi

        if [ -n "$IMAGE_SIZE" ]; then
            # Handle --images flag (auto-remove without prompt)
            if [ "$REMOVE_IMAGE" = true ]; then
                echo -e "${CYAN}â”â”â” Removing Docker Image (--images) â”â”â”${NC}"
                echo ""
                echo -e "  Image: ${BOLD}$IMAGE_NAME${NC} (${IMAGE_SIZE})"
                if docker rmi "$IMAGE_NAME" > /dev/null 2>&1; then
                    echo -e "${GREEN}OK${NC} Image removed"
                    if [ -n "$DOCKERFILE_SIZE" ]; then
                        echo -e "${DIM}  (Can rebuild with: image-create $CONTAINER_NAME)${NC}"
                    fi
                else
                    echo -e "${YELLOW}Warning:${NC} Could not remove image (may be in use)"
                fi
                echo ""
            elif [ "$FORCE" != "true" ]; then
                # Interactive prompt (unless --force)
                echo -e "${CYAN}â”â”â” Image Cleanup (Optional) â”â”â”${NC}"
                echo ""

                if [ "$GUIDED" = true ]; then
                    echo -e "${CYAN}i${NC} ${BOLD}About Docker Images:${NC}"
                    echo "  - An image is like an executable built from your Dockerfile"
                    echo "  - It can be rebuilt anytime from the Dockerfile"
                    echo "  - Keeping it means faster container-deploy (no rebuild needed)"
                    echo "  - Removing it frees disk space but requires rebuild next time"
                    echo ""
                fi

                echo -e "  Image: ${BOLD}$IMAGE_NAME${NC} (${IMAGE_SIZE})"
                if [ -n "$DOCKERFILE_SIZE" ]; then
                    echo -e "  Dockerfile: ${GREEN}OK${NC} ~/dockerfiles/${CONTAINER_NAME}.Dockerfile (${DOCKERFILE_SIZE})"
                fi
                echo ""
                echo -e "  ${GREEN}Default: Keep image${NC} (faster next deploy)"
                read -r -t 0.1 -n 10000 discard </dev/tty 2>/dev/null || true
                read -p "Also remove the Docker image? [y/N]: " REMOVE_IMAGE_PROMPT </dev/tty

                if [[ "$REMOVE_IMAGE_PROMPT" =~ ^[Yy]$ ]]; then
                    if docker rmi "$IMAGE_NAME" > /dev/null 2>&1; then
                        echo -e "${GREEN}OK${NC} Image removed"
                        if [ -n "$DOCKERFILE_SIZE" ]; then
                            echo -e "${DIM}  (Can rebuild with: image-create $CONTAINER_NAME)${NC}"
                        fi
                    else
                        echo -e "${YELLOW}Warning:${NC} Could not remove image (may be in use)"
                    fi
                else
                    echo -e "${DIM}Image kept for faster redeployment${NC}"
                fi
                echo ""
            fi
        fi
    }
else
    echo ""
    echo -e "${RED}âœ— Container retirement failed${NC}"
    echo ""
    echo -e "${YELLOW}Try manually:${NC}"
    echo -e "  ${GREEN}container-stop $CONTAINER_NAME${NC}"
    echo -e "  ${GREEN}container-remove $CONTAINER_NAME${NC}"
    echo ""
    exit 1
fi
