#!/bin/bash
# List containers with beautiful formatting

BLUE='\033[94m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
CYAN='\033[0;36m'
BOLD='\033[1m'
DIM='\033[2m'
NC='\033[0m'

USERNAME=$(whoami)
USER_ID=$(id -u)

usage() {
    echo ""
    echo -e "${BOLD}Container List${NC}"
    echo ""
    echo -e "${CYAN}Usage:${NC}"
    echo "  container-list [options]"
    echo ""
    echo -e "${CYAN}Options:${NC}"
    echo "  --guided        Show detailed explanations for beginners"
    echo "  -a, --all       Show all containers (not just running)"
    echo "  -d, --detailed  Show detailed information"
    echo "  --format FORMAT Output format (table, simple, json)"
    echo "  -h, --help      Show this help message"
    echo ""
    echo -e "${CYAN}Examples:${NC}"
    echo "  container-list               # Show running containers"
    echo "  container-list --all         # Show all containers (including stopped)"
    echo "  container-list --detailed    # Show detailed info"
    echo ""
}

format_status() {
    local status="$1"
    case $status in
        Up*)
            echo -e "${GREEN}â—${NC} Running"
            ;;
        Exited*)
            echo -e "${DIM}â—‹${NC} Stopped"
            ;;
        Created)
            echo -e "${BLUE}â—‹${NC} Created"
            ;;
        Paused)
            echo -e "${YELLOW}â—${NC} Paused"
            ;;
        *)
            echo -e "${DIM}$status${NC}"
            ;;
    esac
}

format_uptime() {
    local status="$1"
    # Extract uptime from status string like "Up 2 hours" or "Exited (0) 5 minutes ago"
    echo "$status" | sed 's/Up //' | sed 's/Exited.*/stopped/'
}

show_simple() {
    local show_all="$1"
    local filter_args=""

    if [ "$show_all" != "true" ]; then
        filter_args="--filter status=running"
    fi

    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${CYAN}${BOLD}    Your Containers${NC}"
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}\n"

    if [ "$GUIDED" = true ]; then
        echo -e "${CYAN}â„¹ ${NC}${BOLD}Understanding Container Status:${NC}"
        echo -e "  â€¢ ${GREEN}Running${NC} - Container is active and ready for work"
        echo -e "  â€¢ ${DIM}Stopped${NC} - Container is paused but can be restarted"
        echo -e "  â€¢ ${BLUE}Created${NC} - Container created but never started"
        echo ""
        echo -e "${CYAN}â„¹ ${NC}${BOLD}What the columns show:${NC}"
        echo -e "  â€¢ Status - Whether container is running or stopped"
        echo -e "  â€¢ Image - The Docker image used (contains software and libraries)"
        echo -e "  â€¢ Time - How long container has been running (or when it stopped)"
        echo -e "  â€¢ GPU - Whether a GPU is allocated to this container"
        echo ""
    fi

    # Get containers
    local containers=$(docker ps -a $filter_args --format "{{.Names}}" --filter "name=._.$USER_ID" 2>/dev/null)

    if [ -z "$containers" ]; then
        if [ "$show_all" = "true" ]; then
            echo -e "${YELLOW}No containers found${NC}\n"
        else
            echo -e "${YELLOW}No running containers${NC}\n"
            echo -e "${DIM}Show all containers: ${GREEN}container-list --all${NC}"
            echo ""
        fi
        echo -e "${BOLD}Create a container:${NC}"
        echo -e "  ${GREEN}container-create my-project${NC}"
        echo ""
        return
    fi

    # Count
    local total=$(echo "$containers" | wc -l | tr -d ' ')
    local running=$(docker ps --format "{{.Names}}" --filter "name=._.$USER_ID" 2>/dev/null | wc -l | tr -d ' ')

    # Display each container
    local count=0
    while IFS= read -r full_name; do
        [ -z "$full_name" ] && continue
        count=$((count + 1))

        # Extract short name
        local name=$(echo "$full_name" | sed "s/\._\.$USER_ID//")

        # Get info
        local status=$(docker ps -a --format "{{.Status}}" --filter "name=^${full_name}$" 2>/dev/null)
        local image=$(docker inspect --format "{{.Config.Image}}" "$full_name" 2>/dev/null | cut -d: -f1)
        local uptime=$(format_uptime "$status")

        # Status indicator
        echo -e "${BOLD}$count. ${CYAN}$name${NC}"
        echo -e "   Status: $(format_status "$status")"
        echo -e "   Image:  ${DIM}$image${NC}"
        echo -e "   Time:   ${DIM}$uptime${NC}"

        # Show GPU if running
        if [[ "$status" == Up* ]]; then
            local gpu=$(docker inspect --format "{{.HostConfig.DeviceRequests}}" "$full_name" 2>/dev/null)
            if [[ "$gpu" != "[]" ]] && [[ "$gpu" != "<no value>" ]]; then
                echo -e "   GPU:    ${GREEN}Allocated${NC}"
            fi
        fi

        echo ""
    done <<< "$containers"

    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${BOLD}Total:${NC} $total container(s)  â€¢  ${GREEN}$running running${NC}"

    if [ "$show_all" = "true" ]; then
        local stopped=$((total - running))
        if [ "$stopped" -gt 0 ]; then
            echo -e "       ${DIM}$stopped stopped${NC}"
        fi
    fi

    echo ""

    # Tips
    echo -e "${YELLOW}ðŸ’¡ Quick Commands:${NC}"
    echo -e "   Start:    ${GREEN}container-run <name>${NC}"
    echo -e "   Stop:     ${GREEN}container-stop <name>${NC}"
    echo -e "   Stats:    ${GREEN}container-stats${NC}"
    echo -e "   Cleanup:  ${GREEN}container-cleanup${NC}"
    echo ""
}

show_detailed() {
    local show_all="$1"
    local filter_args=""

    if [ "$show_all" != "true" ]; then
        filter_args="--filter status=running"
    fi

    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${CYAN}${BOLD}    Detailed Container Information${NC}"
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}\n"

    # Get containers
    local containers=$(docker ps -a $filter_args --format "{{.Names}}" --filter "name=._.$USER_ID" 2>/dev/null)

    if [ -z "$containers" ]; then
        echo -e "${YELLOW}No containers found${NC}\n"
        return
    fi

    local count=0
    while IFS= read -r full_name; do
        [ -z "$full_name" ] && continue
        count=$((count + 1))

        local name=$(echo "$full_name" | sed "s/\._\.$USER_ID//")

        echo -e "${BOLD}â”â”â” Container #$count: ${CYAN}$name${NC} ${BOLD}â”â”â”${NC}\n"

        # Basic info
        local status=$(docker ps -a --format "{{.Status}}" --filter "name=^${full_name}$" 2>/dev/null)
        local image=$(docker inspect --format "{{.Config.Image}}" "$full_name" 2>/dev/null)
        local created=$(docker inspect --format "{{.Created}}" "$full_name" 2>/dev/null | cut -d. -f1 | sed 's/T/ /')
        local id=$(docker inspect --format "{{.Id}}" "$full_name" 2>/dev/null | cut -c1-12)

        echo -e "${BOLD}General:${NC}"
        echo -e "  Name:       $name"
        echo -e "  Full Name:  ${DIM}$full_name${NC}"
        echo -e "  ID:         ${DIM}$id${NC}"
        echo -e "  Status:     $(format_status "$status")"
        echo -e "  Created:    ${DIM}$created${NC}"
        echo -e "  Image:      $image"

        # Resources
        echo -e "\n${BOLD}Resources:${NC}"
        local cpus=$(docker inspect --format "{{.HostConfig.NanoCpus}}" "$full_name" 2>/dev/null)
        if [ "$cpus" != "0" ] && [ -n "$cpus" ]; then
            cpus=$((cpus / 1000000000))
            echo -e "  CPUs:       ${GREEN}$cpus cores${NC}"
        fi

        local memory=$(docker inspect --format "{{.HostConfig.Memory}}" "$full_name" 2>/dev/null)
        if [ "$memory" != "0" ] && [ -n "$memory" ]; then
            memory=$((memory / 1024 / 1024 / 1024))
            echo -e "  Memory:     ${GREEN}${memory}GB${NC}"
        fi

        local gpu=$(docker inspect --format "{{.HostConfig.DeviceRequests}}" "$full_name" 2>/dev/null)
        if [[ "$gpu" != "[]" ]] && [[ "$gpu" != "<no value>" ]]; then
            echo -e "  GPU:        ${GREEN}Enabled${NC}"
        else
            echo -e "  GPU:        ${DIM}CPU-only${NC}"
        fi

        # Mounts
        local workspace=$(docker inspect --format "{{range .Mounts}}{{if eq .Destination \"/workspace\"}}{{.Source}}{{end}}{{end}}" "$full_name" 2>/dev/null)
        if [ -n "$workspace" ]; then
            echo -e "\n${BOLD}Mounts:${NC}"
            echo -e "  Workspace:  ${BLUE}$workspace${NC}"
            local data=$(docker inspect --format "{{range .Mounts}}{{if eq .Destination \"/data\"}}{{.Source}}{{end}}{{end}}" "$full_name" 2>/dev/null)
            if [ -n "$data" ]; then
                echo -e "  Data:       ${BLUE}$data${NC}"
            fi
        fi

        # Ports
        local ports=$(docker port "$full_name" 2>/dev/null)
        if [ -n "$ports" ]; then
            echo -e "\n${BOLD}Ports:${NC}"
            echo "$ports" | while read -r port; do
                echo -e "  ${GREEN}$port${NC}"
            done
        fi

        # Metadata
        local info_file="$HOME/ds01-config/containers/${name}.info"
        if [ -f "$info_file" ]; then
            local created_date=$(grep "^Created:" "$info_file" | cut -d: -f2- | xargs)
            if [ -n "$created_date" ]; then
                echo -e "\n${BOLD}Metadata:${NC}"
                echo -e "  Created:    ${DIM}$created_date${NC}"
            fi
        fi

        echo ""
    done <<< "$containers"
}

# Parse arguments
GUIDED=false
SHOW_ALL=false
DETAILED=false
FORMAT="simple"

while [[ $# -gt 0 ]]; do
    case $1 in
        --guided)
            GUIDED=true
            shift
            ;;
        -a|--all)
            SHOW_ALL=true
            shift
            ;;
        -d|--detailed)
            DETAILED=true
            shift
            ;;
        --format)
            FORMAT="$2"
            shift 2
            ;;
        -h|--help|--info)
            usage
            exit 0
            ;;
        *)
            echo -e "${RED}âœ— Unknown option: $1${NC}\n"
            usage
            exit 1
            ;;
    esac
done

# Display
if [ "$DETAILED" = true ]; then
    show_detailed "$SHOW_ALL"
else
    show_simple "$SHOW_ALL"
fi
