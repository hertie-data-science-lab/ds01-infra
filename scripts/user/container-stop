#!/bin/bash
# Stop a running container

BLUE='\033[94m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
CYAN='\033[0;36m'
BOLD='\033[1m'
DIM='\033[2m'
NC='\033[0m'

USERNAME=$(whoami)
USER_ID=$(id -u)

usage() {
    echo ""
    echo -e "${BOLD}Container Stopper${NC}"
    echo ""
    echo -e "${CYAN}Usage:${NC}"
    echo "  container-stop <name> [options]"
    echo ""
    echo -e "${CYAN}Options:${NC}"
    echo "  -f, --force     Force stop (kill immediately)"
    echo "  -t, --timeout   Timeout in seconds (default: 10)"
    echo "  -a, --all       Stop all your containers"
    echo "  -h, --help      Show this help message"
    echo ""
    echo -e "${CYAN}Description:${NC}"
    echo "  Gracefully stops a running container, allowing processes"
    echo "  to save state and clean up. The container can be restarted"
    echo -e "  later with ${GREEN}container-run${NC}."
    echo ""
    echo -e "${RED}âš  Important:${NC}"
    echo -e "  This ${BOLD}completely stops${NC} the container, including:"
    echo "  â€¢ All running processes"
    echo "  â€¢ Jupyter sessions"
    echo "  â€¢ Training jobs"
    echo "  â€¢ SSH connections"
    echo ""
    echo -e "${YELLOW}ğŸ’¡ Alternative:${NC}"
    echo -e "  To exit without stopping, use: ${GREEN}Ctrl+P, Ctrl+Q${NC} when attached"
    echo ""
    echo -e "${CYAN}Examples:${NC}"
    echo "  container-stop my-project              # Graceful stop"
    echo "  container-stop training --force        # Force stop immediately"
    echo "  container-stop --all                   # Stop all your containers"
    echo ""
    echo -e "${CYAN}After stopping:${NC}"
    echo -e "  â€¢ Restart: ${GREEN}container-run <name>${NC}"
    echo -e "  â€¢ Remove:  ${GREEN}container-cleanup <name>${NC}"
    echo -e "  â€¢ Status:  ${GREEN}container-list${NC}"
    echo ""
}

stop_container() {
    local container_name="$1"
    local force="$2"
    local timeout="$3"

    local container_tag="${container_name}._.$USER_ID"

    # Check if container exists
    if ! docker ps -a --format "{{.Names}}" | grep -q "^${container_tag}$"; then
        echo -e "${RED}âœ—${NC} Container '$container_name' not found"
        return 1
    fi

    # Check if running
    if ! docker ps --format "{{.Names}}" | grep -q "^${container_tag}$"; then
        echo -e "${DIM}â—‹${NC} Container '$container_name' already stopped"
        return 0
    fi

    # Get container info
    local uptime=$(docker ps --format "{{.Status}}" --filter "name=^${container_tag}$")
    local image=$(docker inspect --format "{{.Config.Image}}" "$container_tag" 2>/dev/null)

    echo -e "${BOLD}Container:${NC} ${CYAN}$container_name${NC}"
    echo -e "${BOLD}Uptime:${NC}    $uptime"
    echo -e "${BOLD}Image:${NC}     $image"
    echo ""

    # Warning about running processes
    local process_count=$(docker exec "$container_tag" ps aux 2>/dev/null | wc -l)
    if [ "$process_count" -gt 5 ]; then
        echo -e "${YELLOW}âš  Warning: Container has running processes${NC}"
        echo ""
    fi

    # Stop container
    if [ "$force" = true ]; then
        echo -e "${YELLOW}Force stopping...${NC}"
        if docker kill "$container_tag" > /dev/null 2>&1; then
            echo -e "${GREEN}âœ“${NC} Container force stopped"
            return 0
        else
            echo -e "${RED}âœ—${NC} Failed to stop container"
            return 1
        fi
    else
        echo -e "${CYAN}Stopping gracefully (timeout: ${timeout}s)...${NC}"
        if docker stop -t "$timeout" "$container_tag" > /dev/null 2>&1; then
            echo -e "${GREEN}âœ“${NC} Container stopped"
            return 0
        else
            echo -e "${RED}âœ—${NC} Failed to stop container"
            return 1
        fi
    fi
}

# Parse arguments
CONTAINER_NAME=""
FORCE=false
TIMEOUT=10
STOP_ALL=false

while [[ $# -gt 0 ]]; do
    case $1 in
        -f|--force)
            FORCE=true
            shift
            ;;
        -t|--timeout)
            TIMEOUT="$2"
            shift 2
            ;;
        -a|--all)
            STOP_ALL=true
            shift
            ;;
        -h|--help)
            usage
            exit 0
            ;;
        -*)
            echo -e "${RED}âœ— Unknown option: $1${NC}\n"
            usage
            exit 1
            ;;
        *)
            if [ -z "$CONTAINER_NAME" ]; then
                CONTAINER_NAME="$1"
            else
                echo -e "${RED}âœ— Too many arguments${NC}\n"
                usage
                exit 1
            fi
            shift
            ;;
    esac
done

echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${CYAN}${BOLD}    Stopping Container${NC}"
echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}\n"

# Stop all containers
if [ "$STOP_ALL" = true ]; then
    CONTAINERS=$(docker ps --format "{{.Names}}" --filter "name=._.$USER_ID" | sed "s/\._\.$USER_ID//")

    if [ -z "$CONTAINERS" ]; then
        echo -e "${YELLOW}No running containers found${NC}\n"
        exit 0
    fi

    echo -e "${BOLD}Stopping all your containers:${NC}\n"

    SUCCESS_COUNT=0
    FAIL_COUNT=0

    while IFS= read -r name; do
        [ -z "$name" ] && continue
        if stop_container "$name" "$FORCE" "$TIMEOUT"; then
            SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
        else
            FAIL_COUNT=$((FAIL_COUNT + 1))
        fi
        echo ""
    done <<< "$CONTAINERS"

    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${BOLD}Summary:${NC}"
    echo -e "  Stopped: ${GREEN}$SUCCESS_COUNT${NC}"
    if [ "$FAIL_COUNT" -gt 0 ]; then
        echo -e "  Failed:  ${RED}$FAIL_COUNT${NC}"
    fi
    echo ""
    exit 0
fi

# Validate container name
if [ -z "$CONTAINER_NAME" ]; then
    echo -e "${RED}âœ— Container name is required${NC}\n"
    usage
    exit 1
fi

# Warning message
echo -e "${RED}âš  This will STOP the container${NC}"
echo -e "${BOLD}All processes will be terminated, including:${NC}"
echo -e "  â€¢ Training jobs"
echo -e "  â€¢ Jupyter sessions  "
echo -e "  â€¢ SSH connections"
echo ""
echo -e "${YELLOW}ğŸ’¡ Tip:${NC} To exit without stopping, use ${GREEN}Ctrl+P, Ctrl+Q${NC} instead"
echo ""

read -p "Continue? [y/N]: " CONFIRM
if [[ ! "$CONFIRM" =~ ^[Yy]$ ]]; then
    echo "Cancelled."
    exit 0
fi
echo ""

# Stop container
if stop_container "$CONTAINER_NAME" "$FORCE" "$TIMEOUT"; then
    echo ""
    echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${GREEN}${BOLD}    âœ“ Container Stopped${NC}"
    echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}\n"

    echo -e "${BOLD}Next Steps:${NC}"
    echo -e "  â€¢ Restart:   ${GREEN}container-run $CONTAINER_NAME${NC}"
    echo -e "  â€¢ Remove:    ${GREEN}container-cleanup $CONTAINER_NAME${NC}"
    echo -e "  â€¢ View all:  ${GREEN}container-list${NC}"
    echo ""
else
    echo ""
    echo -e "${RED}Failed to stop container${NC}\n"
    echo -e "${BOLD}Try:${NC}"
    echo -e "  â€¢ Force stop: ${YELLOW}container-stop $CONTAINER_NAME --force${NC}"
    echo -e "  â€¢ Check logs: ${BLUE}docker logs ${CONTAINER_NAME}._.$USER_ID${NC}"
    echo ""
    exit 1
fi
