#!/bin/bash
# DS01 Container Stop - Stops containers via mlc-stop with DS01 UX
# Tier 2 Command - Wraps AIME mlc-stop with interactive GUI and safety checks

set -e

# Script paths
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
INFRA_ROOT="$(dirname "$SCRIPT_DIR")"
MLC_STOP="$INFRA_ROOT/aime-ml-containers/mlc-stop"
RESOURCE_PARSER="$INFRA_ROOT/scripts/docker/get_resource_limits.py"
GPU_ALLOCATOR="$INFRA_ROOT/scripts/docker/gpu_allocator.py"

# Source interactive library
source /usr/local/lib/interactive-select.sh

BLUE='\033[94m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
CYAN='\033[0;36m'
BOLD='\033[1m'
DIM='\033[2m'
NC='\033[0m'

USERNAME=$(whoami)
USER_ID=$(id -u)

usage() {
    echo ""
    echo -e "${BOLD}DS01 Container Stop${NC}"
    echo ""
    echo -e "${CYAN}Usage:${NC}"
    echo "  container-stop [name] [options]"
    echo "  container-stop                   # Prompts to select running container (if none specified)"
    echo ""
    echo -e "${CYAN}Options:${NC}"
    echo "  --guided        Show detailed explanations for beginners"
    echo "  -f, --force     Force stop (kill immediately)"
    echo "  -t, --timeout   Timeout in seconds (default: 10)"
    echo "  -a, --all       Stop all your containers"
    echo "  -h, --help      Show this help message"
    echo ""
    echo -e "${CYAN}Description:${NC}"
    echo "  Gracefully stops a running container, allowing processes"
    echo "  to save state and clean up. The container can be restarted"
    echo -e "  later with ${GREEN}container-run${NC}."
    echo ""
    echo -e "${RED}âš  Important:${NC}"
    echo -e "  This ${BOLD}completely stops${NC} the container, including:"
    echo "  â€¢ All running processes"
    echo "  â€¢ Jupyter sessions"
    echo "  â€¢ Training jobs"
    echo "  â€¢ SSH connections"
    echo ""
    echo -e "${YELLOW}ğŸ’¡ Alternative:${NC}"
    echo -e "  To exit without stopping: Just type ${GREEN}exit${NC} (container keeps running)"
    echo -e "  Reconnect later with: ${GREEN}container-run <name>${NC}"
    echo ""
    echo -e "${CYAN}Examples:${NC}"
    echo "  container-stop my-project              # Graceful stop"
    echo "  container-stop training --force        # Force stop immediately"
    echo "  container-stop --all                   # Stop all your containers"
    echo ""
    echo -e "${CYAN}After stopping:${NC}"
    echo -e "  â€¢ Restart: ${GREEN}container-run <name>${NC}"
    echo -e "  â€¢ Remove:  ${GREEN}container-cleanup <name>${NC}"
    echo -e "  â€¢ Status:  ${GREEN}container-list${NC}"
    echo ""
    echo -e "${YELLOW}ğŸ’¡ Tip:${NC} This command uses AIME's mlc-stop for container stopping"
    echo ""
}

stop_container() {
    local container_name="$1"
    local force="$2"
    local timeout="$3"

    local container_tag="${container_name}._.$USER_ID"

    # Check if container exists
    if ! docker ps -a --format "{{.Names}}" | grep -q "^${container_tag}$"; then
        echo -e "${RED}âœ—${NC} Container '$container_name' not found"
        return 1
    fi

    # Check if running
    if ! docker ps --format "{{.Names}}" | grep -q "^${container_tag}$"; then
        echo -e "${DIM}â—‹${NC} Container '$container_name' already stopped"
        return 0
    fi

    # Get container info (DS01 display)
    local uptime=$(docker ps --format "{{.Status}}" --filter "name=^${container_tag}$")
    local image=$(docker inspect --format "{{.Config.Image}}" "$container_tag" 2>/dev/null)

    echo -e "${BOLD}Container:${NC} ${CYAN}$container_name${NC}"
    echo -e "${BOLD}Uptime:${NC}    $uptime"
    echo -e "${BOLD}Image:${NC}     $image"
    echo ""

    # Warning about running processes (DS01-specific)
    local process_count=$(docker exec "$container_tag" ps aux 2>/dev/null | wc -l)
    if [ "$process_count" -gt 5 ]; then
        echo -e "${YELLOW}âš  Warning: Container has running processes${NC}"
        if [ "$GUIDED" = true ]; then
            echo -e "${CYAN}â„¹ ${NC}This means training jobs, Jupyter notebooks, or other programs are still running."
            echo -e "  They will be terminated when the container stops."
        fi
        echo ""
    fi

    # Check if mlc-stop exists
    if [ ! -f "$MLC_STOP" ]; then
        # Fallback to docker directly
        if [ "$force" = true ]; then
            echo -e "${YELLOW}Force stopping...${NC}"
            if docker kill "$container_tag" > /dev/null 2>&1; then
                echo -e "${GREEN}âœ“${NC} Container force stopped"
                return 0
            else
                echo -e "${RED}âœ—${NC} Failed to stop container"
                return 1
            fi
        else
            echo -e "${CYAN}Stopping gracefully (timeout: ${timeout}s)...${NC}"
            if docker stop -t "$timeout" "$container_tag" > /dev/null 2>&1; then
                echo -e "${GREEN}âœ“${NC} Container stopped"
                return 0
            else
                echo -e "${RED}âœ—${NC} Failed to stop container"
                return 1
            fi
        fi
    fi

    # Stop container via mlc-stop (AIME Tier 1)
    if [ "$force" = true ]; then
        echo -e "${YELLOW}Force stopping...${NC}"
        if [ "$GUIDED" = true ]; then
            echo -e "${CYAN}â„¹ ${NC}Force stop sends SIGKILL, immediately terminating all processes without cleanup."
        fi
        # mlc-stop -f for force
        if bash "$MLC_STOP" "$container_name" -f -s > /dev/null 2>&1; then
            echo -e "${GREEN}âœ“${NC} Container force stopped (via mlc-stop)"
            return 0
        else
            # Fallback to docker kill
            if docker kill "$container_tag" > /dev/null 2>&1; then
                echo -e "${GREEN}âœ“${NC} Container force stopped"
                return 0
            else
                echo -e "${RED}âœ—${NC} Failed to stop container"
                return 1
            fi
        fi
    else
        echo -e "${CYAN}Stopping gracefully (timeout: ${timeout}s)...${NC}"
        if [ "$GUIDED" = true ]; then
            echo -e "${CYAN}â„¹ ${NC}Graceful stop sends SIGTERM, allowing processes to save state and exit cleanly."
        fi
        # Call mlc-stop with script mode (-s for non-interactive)
        if bash "$MLC_STOP" "$container_name" -s > /dev/null 2>&1; then
            echo -e "${GREEN}âœ“${NC} Container stopped (via mlc-stop)"
            return 0
        else
            # Fallback to docker stop
            if docker stop -t "$timeout" "$container_tag" > /dev/null 2>&1; then
                echo -e "${GREEN}âœ“${NC} Container stopped"
                return 0
            else
                echo -e "${RED}âœ—${NC} Failed to stop container"
                return 1
            fi
        fi
    fi
}

# Parse arguments
CONTAINER_NAME=""
GUIDED=false
FORCE=false
TIMEOUT=10
STOP_ALL=false

while [[ $# -gt 0 ]]; do
    case $1 in
        --guided)
            GUIDED=true
            shift
            ;;
        -f|--force)
            FORCE=true
            shift
            ;;
        -t|--timeout)
            TIMEOUT="$2"
            shift 2
            ;;
        -a|--all)
            STOP_ALL=true
            shift
            ;;
        -h|--help|--info)
            usage
            exit 0
            ;;
        -*)
            echo -e "${RED}âœ— Unknown option: $1${NC}\n"
            usage
            exit 1
            ;;
        *)
            if [ -z "$CONTAINER_NAME" ]; then
                CONTAINER_NAME="$1"
            else
                echo -e "${RED}âœ— Too many arguments${NC}\n"
                usage
                exit 1
            fi
            shift
            ;;
    esac
done

echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${CYAN}${BOLD}    Stopping Container${NC}"
echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}\n"

# Stop all containers
if [ "$STOP_ALL" = true ]; then
    CONTAINERS=$(docker ps --format "{{.Names}}" --filter "name=._.$USER_ID" | sed "s/\._\.$USER_ID//")

    if [ -z "$CONTAINERS" ]; then
        echo -e "${YELLOW}No running containers found${NC}\n"
        exit 0
    fi

    echo -e "${BOLD}Stopping all your containers:${NC}\n"

    SUCCESS_COUNT=0
    FAIL_COUNT=0

    while IFS= read -r name; do
        [ -z "$name" ] && continue
        if stop_container "$name" "$FORCE" "$TIMEOUT"; then
            SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
        else
            FAIL_COUNT=$((FAIL_COUNT + 1))
        fi
        echo ""
    done <<< "$CONTAINERS"

    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${BOLD}Summary:${NC}"
    echo -e "  Stopped: ${GREEN}$SUCCESS_COUNT${NC}"
    if [ "$FAIL_COUNT" -gt 0 ]; then
        echo -e "  Failed:  ${RED}$FAIL_COUNT${NC}"
    fi
    echo ""
    exit 0
fi

# Show guided explanation BEFORE selection
if [ "$GUIDED" = true ] && [ -z "$CONTAINER_NAME" ] && [ "$STOP_ALL" = false ]; then
    echo -e "${CYAN}â„¹ ${NC}${BOLD}What does stopping mean?${NC}"
    echo -e "  Stopping a container halts all processes inside it, but preserves:"
    echo -e "  â€¢ All your files and data in the workspace"
    echo -e "  â€¢ The container configuration"
    echo -e "  â€¢ Any changes you made inside the container"
    echo -e "  You can restart it later with ${GREEN}container-run${NC} and continue where you left off."
    echo ""
    echo -e "${CYAN}â„¹ ${NC}${BOLD}GPU allocation after stop:${NC}"
    echo -e "  â€¢ Your GPU is held for 1h after stopping"
    echo -e "  â€¢ Restart within 1h â†’ GPU still yours (no re-competing)"
    echo -e "  â€¢ After 1h â†’ GPU auto-released for others"
    echo -e "  â€¢ Need GPU freed immediately? Use ${GREEN}container-cleanup${NC}"
    echo ""
    echo -e "${CYAN}â„¹ ${NC}${BOLD}System automation:${NC}"
    echo -e "  â€¢ Idle containers auto-stopped after 24h GPU inactivity"
    echo -e "  â€¢ Stopped containers' GPUs auto-released after 1h hold time"
    echo ""
    echo -e "${CYAN}â„¹ ${NC}${BOLD}Behind the scenes:${NC}"
    echo -e "  â€¢ DS01 uses AIME's ${GREEN}mlc-stop${NC} for the actual stopping operation"
    echo -e "  â€¢ This ensures consistent container lifecycle management"
    echo -e "  â€¢ DS01 adds safety checks and user confirmations"
    echo ""
fi

# If no container name provided, prompt to select running containers (DS01 UX)
if [ -z "$CONTAINER_NAME" ] && [ "$STOP_ALL" = false ]; then
    CONTAINER_NAME=$(select_container "running")
    if [ -z "$CONTAINER_NAME" ]; then
        echo "No selection made. Exiting."
        exit 0
    fi
    echo ""
fi

# Validate container name
if [ -z "$CONTAINER_NAME" ] && [ "$STOP_ALL" = false ]; then
    echo -e "${RED}âœ— Container name is required${NC}\n"
    usage
    exit 1
fi

# Warning message (DS01 safety check)
echo -e "${RED}âš  This will STOP the container${NC}"
echo -e "${BOLD}All processes will be terminated, including:${NC}"
echo -e "  â€¢ Training jobs"
echo -e "  â€¢ Jupyter sessions"
echo -e "  â€¢ SSH connections"
echo ""
echo -e "${YELLOW}ğŸ’¡ Tip:${NC} To exit without stopping: Just type ${GREEN}exit${NC} (container keeps running)"
echo ""

read -p "Continue? [y/N]: " CONFIRM
if [[ ! "$CONFIRM" =~ ^[Yy]$ ]]; then
    echo "Cancelled."
    exit 0
fi
echo ""

# Stop container
if stop_container "$CONTAINER_NAME" "$FORCE" "$TIMEOUT"; then
    echo ""
    echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${GREEN}${BOLD}    âœ“ Container Stopped${NC}"
    echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}\n"

    # Mark container as stopped (starts GPU hold timer)
    CONTAINER_TAG="${CONTAINER_NAME}._.${USER_ID}"
    if [ -f "$GPU_ALLOCATOR" ]; then
        python3 "$GPU_ALLOCATOR" mark-stopped "$CONTAINER_TAG" >/dev/null 2>&1 || true
    fi

    # Check if container has GPU allocated and show warning
    if [ -f "$GPU_ALLOCATOR" ]; then
        GPU_INFO=$(python3 "$GPU_ALLOCATOR" user-status "$USERNAME" 2>/dev/null | grep "$CONTAINER_TAG" || true)

        if [ -n "$GPU_INFO" ]; then
            # Get GPU hold time from config
            GPU_HOLD_TIME="24h"  # default
            if [ -f "$RESOURCE_PARSER" ]; then
                GPU_HOLD_TIME=$(python3 "$RESOURCE_PARSER" "$USERNAME" --gpu-hold-time 2>/dev/null || echo "24h")
            fi

            echo -e "${YELLOW}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
            echo -e "${YELLOW}${BOLD}    âš  GPU Still Allocated${NC}"
            echo -e "${YELLOW}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}\n"

            echo -e "${BOLD}Important:${NC} Your container still has a GPU allocated!"
            echo ""

            if [ "$GPU_HOLD_TIME" = "indefinite" ] || [ "$GPU_HOLD_TIME" = "null" ]; then
                echo -e "  â€¢ GPU will be held ${CYAN}indefinitely${NC} (until you cleanup)"
            else
                echo -e "  â€¢ GPU will be held for ${CYAN}$GPU_HOLD_TIME${NC}"
                echo -e "  â€¢ After that, GPU will be auto-released"
            fi
            echo -e "  â€¢ Other users cannot use this GPU during this time"
            echo ""

            echo -e "${BOLD}Be a good citizen:${NC}"
            echo -e "  If you're done with this container, release the GPU now:"
            echo -e "    ${GREEN}container-cleanup $CONTAINER_NAME${NC}"
            echo ""
            echo -e "  This removes the container and ${BOLD}immediately frees the GPU${NC} for others."
            echo ""
            echo -e "${CYAN}â„¹ ${NC}${DIM}Your workspace files are always safe - cleanup only removes the container.${NC}"
            echo ""
        fi
    fi

    echo -e "${BOLD}Next Steps:${NC}"
    echo -e "  â€¢ Restart:   ${GREEN}container-run $CONTAINER_NAME${NC}"
    echo -e "  â€¢ Cleanup:   ${GREEN}container-cleanup $CONTAINER_NAME${NC} ${DIM}(releases GPU)${NC}"
    echo -e "  â€¢ View all:  ${GREEN}container-list${NC}"
    echo ""
else
    echo ""
    echo -e "${RED}Failed to stop container${NC}\n"
    echo -e "${BOLD}Try:${NC}"
    echo -e "  â€¢ Force stop: ${YELLOW}container-stop $CONTAINER_NAME --force${NC}"
    echo -e "  â€¢ Check logs: ${BLUE}docker logs ${CONTAINER_NAME}._.$USER_ID${NC}"
    echo ""
    exit 1
fi
