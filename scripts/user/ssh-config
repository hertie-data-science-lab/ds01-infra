#!/bin/bash
# SSH Configuration Manager for DS01
# Handles SSH key generation, testing, and configuration for VS Code Remote

BLUE='\033[94m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m'

USERNAME=$(whoami)
SSH_DIR="$HOME/.ssh"
KEY_FILE="$SSH_DIR/id_ed25519"
SERVER_IP=$(hostname -I | awk '{print $1}')

usage() {
    echo ""
    echo -e "${BOLD}SSH Configuration Manager${NC}"
    echo ""
    echo -e "${CYAN}Usage:${NC}"
    echo "  ssh-config [command]"
    echo ""
    echo -e "${CYAN}Commands:${NC}"
    echo "  generate    Generate new SSH keys (ed25519)"
    echo "  test        Test SSH connection to localhost"
    echo "  show        Display public key and connection info"
    echo "  vscode      Show VS Code Remote-SSH setup instructions"
    echo "  help        Show this help message"
    echo ""
    echo -e "${CYAN}Examples:${NC}"
    echo "  ssh-config generate    # Create new SSH keys"
    echo "  ssh-config test        # Test if SSH is working"
    echo "  ssh-config show        # Display your public key"
    echo "  ssh-config vscode      # Get VS Code setup instructions"
    echo ""
}

generate_keys() {
    echo -e "${CYAN}‚îÅ‚îÅ‚îÅ Generating SSH Keys ‚îÅ‚îÅ‚îÅ${NC}\n"

    if [ -f "$KEY_FILE" ]; then
        echo -e "${YELLOW}‚ö† SSH keys already exist at $KEY_FILE${NC}"
        read -p "Overwrite existing keys? [y/N]: " OVERWRITE
        if [[ ! "$OVERWRITE" =~ ^[Yy]$ ]]; then
            echo "Cancelled."
            exit 0
        fi
        echo ""
    fi

    mkdir -p "$SSH_DIR"
    chmod 700 "$SSH_DIR"

    echo "Generating ed25519 key..."
    ssh-keygen -t ed25519 -C "${USERNAME}@ds01-server" -f "$KEY_FILE" -N ""

    if [ $? -eq 0 ]; then
        echo ""
        echo -e "${GREEN}‚úì SSH keys generated successfully${NC}\n"

        # Add to authorized_keys
        cat "${KEY_FILE}.pub" >> "$SSH_DIR/authorized_keys"
        chmod 600 "$SSH_DIR/authorized_keys"

        echo -e "${GREEN}‚úì Public key added to authorized_keys${NC}\n"
        show_key
    else
        echo -e "\n${RED}‚úó Key generation failed${NC}"
        exit 1
    fi
}

test_ssh() {
    echo -e "${CYAN}‚îÅ‚îÅ‚îÅ Testing SSH Connection ‚îÅ‚îÅ‚îÅ${NC}\n"

    if [ ! -f "$KEY_FILE" ]; then
        echo -e "${RED}‚úó No SSH keys found${NC}"
        echo "Run: ssh-config generate"
        exit 1
    fi

    echo "Testing connection to localhost..."
    if ssh -o BatchMode=yes -o ConnectTimeout=5 localhost exit 2>/dev/null; then
        echo -e "${GREEN}‚úì SSH connection successful${NC}\n"
        echo "You can connect from VS Code using:"
        echo -e "  ${BLUE}ssh ${USERNAME}@${SERVER_IP}${NC}"
    else
        echo -e "${RED}‚úó SSH connection failed${NC}\n"
        echo "Troubleshooting steps:"
        echo "  1. Check if sshd is running: systemctl status sshd"
        echo "  2. Verify authorized_keys: cat ~/.ssh/authorized_keys"
        echo "  3. Check permissions: ls -la ~/.ssh/"
        exit 1
    fi
}

show_key() {
    echo -e "${CYAN}‚îÅ‚îÅ‚îÅ SSH Configuration ‚îÅ‚îÅ‚îÅ${NC}\n"

    if [ ! -f "${KEY_FILE}.pub" ]; then
        echo -e "${RED}‚úó No SSH keys found${NC}"
        echo "Run: ssh-config generate"
        exit 1
    fi

    echo -e "${BOLD}Public Key:${NC}"
    echo -e "${BLUE}$(cat ${KEY_FILE}.pub)${NC}\n"

    echo -e "${BOLD}Connection Info:${NC}"
    echo -e "  Server IP:  ${CYAN}${SERVER_IP}${NC}"
    echo -e "  Username:   ${CYAN}${USERNAME}${NC}"
    echo -e "  Key Type:   ${CYAN}ed25519${NC}"
    echo -e "  Key File:   ${CYAN}${KEY_FILE}${NC}\n"

    echo -e "${BOLD}Connect from terminal:${NC}"
    echo -e "  ${GREEN}ssh ${USERNAME}@${SERVER_IP}${NC}\n"

    echo -e "${YELLOW}üí° Tip: Use 'ssh-config vscode' for VS Code setup instructions${NC}"
}

show_vscode_setup() {
    echo -e "${CYAN}‚îÅ‚îÅ‚îÅ VS Code Remote-SSH Setup ‚îÅ‚îÅ‚îÅ${NC}\n"
    echo ""
    echo -e "${BOLD}Step 1: Install Extensions${NC}"
    echo "  In VS Code, install:"
    echo "  ‚Ä¢ Remote - SSH"
    echo "  ‚Ä¢ Python"
    echo "  ‚Ä¢ Jupyter"
    echo "  ‚Ä¢ Docker (optional)"
    echo ""
    echo -e "${BOLD}Step 2: Configure SSH Connection${NC}"
    echo -e "  1. Open Command Palette (${CYAN}Cmd/Ctrl+Shift+P${NC})"
    echo -e "  2. Type: ${CYAN}Remote-SSH: Open SSH Configuration File${NC}"
    echo "  3. Select your config file (usually ~/.ssh/config)"
    echo "  4. Add this entry:"
    echo ""
    echo -e "  ${BLUE}Host ds01"
    echo "      HostName ${SERVER_IP}"
    echo "      User ${USERNAME}"
    echo "      ForwardAgent yes"
    echo "      ServerAliveInterval 60"
    echo -e "      ServerAliveCountMax 3${NC}"
    echo ""
    echo -e "${BOLD}Step 3: Connect${NC}"
    echo -e "  1. Open Command Palette (${CYAN}Cmd/Ctrl+Shift+P${NC})"
    echo -e "  2. Type: ${CYAN}Remote-SSH: Connect to Host${NC}"
    echo -e "  3. Select ${CYAN}ds01${NC}"
    echo "  4. Wait for connection to establish"
    echo ""
    echo -e "${BOLD}Step 4: Open Your Workspace${NC}"
    echo "  ‚Ä¢ File ‚Üí Open Folder"
    echo -e "  ‚Ä¢ Navigate to: ${CYAN}/home/${USERNAME}/workspace${NC}"
    echo ""
    echo -e "${BOLD}Step 5: Work in Container${NC}"
    echo "  Open terminal in VS Code and run:"
    echo -e "  ${GREEN}container-run <container-name>${NC}"
    echo ""
    echo -e "${YELLOW}üí° Troubleshooting:${NC}"
    echo -e "  ‚Ä¢ Test connection first: ${CYAN}ssh-config test${NC}"
    echo -e "  ‚Ä¢ View your key: ${CYAN}ssh-config show${NC}"
    echo -e "  ‚Ä¢ Regenerate keys: ${CYAN}ssh-config generate${NC}"
    echo ""
}

# Main command router
case "${1:-help}" in
    generate)
        generate_keys
        ;;
    test)
        test_ssh
        ;;
    show)
        show_key
        ;;
    vscode)
        show_vscode_setup
        ;;
    help|-h|--help)
        usage
        ;;
    *)
        echo -e "${RED}Unknown command: $1${NC}\n"
        usage
        exit 1
        ;;
esac
