#!/bin/bash
# DS01 Onboarding Document Creator
# Creates ~/ONBOARDING.md for new users
# Tier 2 Command - Called by user-setup orchestrator
# File: /opt/ds01-infra/scripts/user/onboarding-create

set -e

# Colors
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
BOLD='\033[1m'
DIM='\033[2m'
NC='\033[0m'

USERNAME=$(whoami)
ONBOARDING_FILE="$HOME/ONBOARDING.md"

# Contact info placeholders - edit these for your deployment
ENGINEER_EMAIL="[ENGINEER_EMAIL]"
LAB_EMAIL="[LAB_EMAIL]"
USER_DOCS_URL="https://github.com/hertie-data-science-lab/ds01-user-docs"

usage() {
    echo ""
    echo -e "${BOLD}DS01 Onboarding Document Creator${NC}"
    echo ""
    echo -e "${CYAN}Usage:${NC}"
    echo "  onboarding-create [options]"
    echo ""
    echo -e "${CYAN}Options:${NC}"
    echo "  --force        Recreate even if file exists"
    echo "  -h, --help     Show this help message"
    echo ""
    echo -e "${CYAN}Description:${NC}"
    echo "  Creates ~/ONBOARDING.md with DS01 quick reference guide."
    echo ""
}

# Parse arguments
FORCE=false

while [[ $# -gt 0 ]]; do
    case $1 in
        --force)
            FORCE=true
            shift
            ;;
        -h|--help)
            usage
            exit 0
            ;;
        *)
            shift
            ;;
    esac
done

# Check if already exists
if [ -f "$ONBOARDING_FILE" ] && [ "$FORCE" = false ]; then
    echo -e "${GREEN}✓${NC} ONBOARDING.md already exists"
    echo -e "  ${DIM}Location: $ONBOARDING_FILE${NC}"
    exit 0
fi

# Get current date
CURRENT_DATE=$(date +"%Y-%m-%d")

# Get server IP for SSH config
SERVER_IP=$(hostname -I | awk '{print $1}')

# Create ONBOARDING.md
cat > "$ONBOARDING_FILE" << EOF
# DS01 Onboarding Guide

Welcome to DS01 - Hertie's HPC Server for Data Science!

## Quick Reference

| Task | Command |
|------|---------|
| Deploy container | \`container deploy my-project\` |
| Enter container | \`container attach my-project\` |
| Retire container | \`container retire my-project\` |
| Check your limits | \`check-limits\` |
| List containers | \`container-list\` |
| Create new project | \`project-init\` |
| Run setup again | \`user-setup\` |

## Understanding DS01

### Workspace vs Container

- **Workspace** (\`~/workspace/\`): Your permanent file storage
- **Container**: Temporary compute environment with GPU access

Think of it like:
- Workspace = your hard drive (files persist forever)
- Container = your computer (can restart/replace anytime)

### Getting Started Workflow

1. Create a project: \`project-init my-thesis\`
2. Deploy container: \`container deploy my-thesis\`
3. Work in container (VS Code or terminal)
4. Retire when done: \`container retire my-thesis\`

Your files in \`~/workspace/\` are **always safe**, even if you retire the container.

### Resource Limits

Run \`check-limits\` to see your quotas for:
- GPU allocations
- Container count
- Memory/CPU per container

### Jupyter Lab

- **VS Code** (recommended): Use the Jupyter extension
  1. Install 'Jupyter' extension in VS Code
  2. Connect to DS01 via Remote-SSH
  3. Open any .ipynb file

- **Browser**: Run \`jupyter-setup --guided\` for port forwarding setup

## SSH Configuration

### Keys Location (on the server)

- **Private key**: \`~/.ssh/id_ed25519\`
- **Public key**: \`~/.ssh/id_ed25519.pub\`

### Step 1: Copy Private Key to Your LOCAL Machine

Run this on your LOCAL terminal (laptop/desktop):

\`\`\`bash
scp ${USERNAME}@${SERVER_IP}:~/.ssh/id_ed25519 ~/.ssh/ds01_id_ed25519
chmod 600 ~/.ssh/ds01_id_ed25519
\`\`\`

### Step 2: Add SSH Config on Your LOCAL Machine

Add this to \`~/.ssh/config\` on your LOCAL machine:

\`\`\`
Host ds01
    HostName ${SERVER_IP}
    User ${USERNAME}
    IdentityFile ~/.ssh/ds01_id_ed25519
    ForwardAgent yes
    ServerAliveInterval 60
\`\`\`

### How to Connect

- **Terminal**: \`ssh ds01\`
- **VS Code**: Remote-SSH: Connect to Host → ds01

### Need to Review Your Keys?

Run \`ssh-setup\` on the server to view your keys and instructions again.

## Documentation & Help

- **User docs**: ${USER_DOCS_URL}
- **Command help**: \`<command> --help\`

### For Advanced Users

- **Granular commands**: The user docs repo includes documentation for atomic commands
  (\`container-create\`, \`container-start\`, \`container-stop\`, etc.) that offer more fine-grained control.
- **Docker commands**: Standard \`docker\` commands remain available for users with prior Docker experience.
  All containers are still subject to DS01 resource limits regardless of how they're launched.

## Getting Help

- **DSL Research Engineer**: ${ENGINEER_EMAIL}
- **Data Science Lab**: ${LAB_EMAIL}

---
Generated by DS01 Setup Wizard | Last updated: ${CURRENT_DATE}
EOF

echo -e "${GREEN}✓${NC} Created ONBOARDING.md"
echo -e "  ${DIM}Location: $ONBOARDING_FILE${NC}"
echo ""
echo -e "${YELLOW}Tip:${NC} This file is in your home directory."
echo "     You'll see it when you first open VS Code on the server."
