#!/bin/bash
# DS01 Project Launch - L4 Wizard
# Smart workflow: Select project -> Ensure image exists -> Deploy container
# Usage: project launch [project-name] [options]

set -e

# Source DS01 libraries
if [[ -f "/opt/ds01-infra/scripts/lib/ds01-context.sh" ]]; then
    source /opt/ds01-infra/scripts/lib/ds01-context.sh
fi

if [[ -f "/opt/ds01-infra/scripts/lib/project-metadata.sh" ]]; then
    source /opt/ds01-infra/scripts/lib/project-metadata.sh
fi

# Set orchestration context
export DS01_CONTEXT="orchestration"
export DS01_INTERFACE="orchestration"

# Colors
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
CYAN='\033[0;36m'
BOLD='\033[1m'
DIM='\033[2m'
NC='\033[0m'

USERNAME=$(whoami)
USER_ID=$(id -u)
WORKSPACE_DIR="$HOME/workspace"

# =============================================================================
# HELP FUNCTIONS
# =============================================================================

show_help() {
    echo -e ""
    echo -e "${BOLD}DS01 Project Launch${NC}"
    echo -e "${DIM}L4 Wizard - Launch containers for existing projects${NC}"
    echo -e ""
    echo -e "${CYAN}Usage:${NC}"
    echo -e "  project launch [project-name] [options]"
    echo -e ""
    echo -e "${CYAN}Options:${NC}"
    echo -e "  --guided          Show detailed explanations"
    echo -e "  --background      Start in background (don't enter terminal)"
    echo -e "  --open            Start and open terminal (skip prompt)"
    echo -e "  -h, --help        Quick reference"
    echo -e "  --info            Full reference"
    echo -e "  --concepts        Learn about project launch"
    echo -e ""
    echo -e "${CYAN}Examples:${NC}"
    echo -e "  project launch                    # Interactive project selection"
    echo -e "  project launch my-thesis          # Launch specific project"
    echo -e "  project launch my-thesis --open   # Launch and enter terminal"
    echo -e ""
}

show_info() {
    echo -e ""
    echo -e "${BOLD}DS01 Project Launch - Full Reference${NC}"
    echo -e "${DIM}L4 Wizard: Launch containers from existing projects${NC}"
    echo -e ""
    echo -e "${CYAN}What it does:${NC}"
    echo -e "  1. Shows menu of projects in ~/workspace/"
    echo -e "  2. Checks if Docker image exists for selected project"
    echo -e "  3. If no image: offers to create one (runs image-create)"
    echo -e "  4. Deploys container with project workspace mounted"
    echo -e ""
    echo -e "${CYAN}Usage:${NC}"
    echo -e "  project launch [project-name] [options]"
    echo -e ""
    echo -e "${CYAN}Arguments:${NC}"
    echo -e "  project-name      Name of project in ~/workspace/"
    echo -e "                    If omitted, shows interactive selection menu"
    echo -e ""
    echo -e "${CYAN}Options:${NC}"
    echo -e "  --guided          Include detailed explanations"
    echo -e "  --background      Start container in background (skip prompt)"
    echo -e "  --open            Start and enter terminal (skip prompt)"
    echo -e "  --rebuild         Force rebuild image even if exists"
    echo -e ""
    echo -e "${CYAN}Workflow:${NC}"
    echo -e "  project init my-thesis --type=cv   # Create project (once)"
    echo -e "  project launch my-thesis           # Launch container (daily)"
    echo -e "  container retire my-thesis         # Cleanup when done"
    echo -e ""
}

show_concepts() {
    echo -e ""
    echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "${BOLD}Understanding Project Launch${NC}"
    echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e ""
    echo -e "${BOLD}What is 'project launch'?${NC}"
    echo -e ""
    echo -e "It's a smart wizard that ensures your project has everything"
    echo -e "it needs to run, then starts a container for you."
    echo -e ""
    echo -e "${BOLD}What happens when you run it:${NC}"
    echo -e ""
    echo -e "  ${GREEN}1. Project Selection${NC}"
    echo -e "     If you don't specify a project, shows a menu of available ones"
    echo -e ""
    echo -e "  ${GREEN}2. Image Check${NC}"
    echo -e "     Looks for Docker image: ds01-${USER_ID}/<project>:latest"
    echo -e "     If missing, offers to build it from project's Dockerfile"
    echo -e ""
    echo -e "  ${GREEN}3. Container Deploy${NC}"
    echo -e "     Creates and starts container with your project mounted"
    echo -e "     Opens terminal so you can start working"
    echo -e ""
    echo -e "${BOLD}When to use it:${NC}"
    echo -e ""
    echo -e "  - Daily: Return to work on existing project"
    echo -e "  - After creating a new project with 'project init'"
    echo -e "  - After modifying requirements.txt (will prompt to rebuild)"
    echo -e ""
    echo -e "${BOLD}Comparison:${NC}"
    echo -e ""
    echo -e "  ${CYAN}project launch${NC}     Smart - handles image creation automatically"
    echo -e "  ${CYAN}container deploy${NC}   Direct - requires image to exist already"
    echo -e ""
    echo -e "${DIM}Ready? Run: project launch [name]${NC}"
    echo -e ""
}

# =============================================================================
# PARSE ARGUMENTS
# =============================================================================

PROJECT_NAME=""
GUIDED=false
OPEN_MODE=true
BACKGROUND=false
REBUILD=false
DEPLOY_ARGS=()

while [[ $# -gt 0 ]]; do
    case $1 in
        --guided)
            GUIDED=true
            DEPLOY_ARGS+=("--guided")
            shift
            ;;
        --background)
            BACKGROUND=true
            OPEN_MODE=false
            DEPLOY_ARGS+=("--background")
            shift
            ;;
        --open)
            OPEN_MODE=true
            DEPLOY_ARGS+=("--open")
            shift
            ;;
        --rebuild)
            REBUILD=true
            shift
            ;;
        -h|--help)
            show_help
            exit 0
            ;;
        --info)
            show_info
            exit 0
            ;;
        --concepts)
            show_concepts
            exit 0
            ;;
        -*)
            echo -e "${RED}Unknown option: $1${NC}"
            show_help
            exit 1
            ;;
        *)
            if [[ -z "$PROJECT_NAME" ]]; then
                PROJECT_NAME="$1"
            fi
            shift
            ;;
    esac
done

# =============================================================================
# INTERACTIVE PROJECT SELECTION
# =============================================================================

select_project() {
    echo -e ""
    echo -e "${BOLD}Available Projects:${NC}"
    echo -e ""

    local projects=()
    local i=1

    # Scan workspace directory
    if [[ ! -d "$WORKSPACE_DIR" ]]; then
        echo -e "${YELLOW}No workspace directory found: $WORKSPACE_DIR${NC}"
        echo -e ""
        echo -e "Create a project first:"
        echo -e "  ${GREEN}project init${NC}"
        exit 0
    fi

    for project_dir in "$WORKSPACE_DIR"/*/; do
        [[ -d "$project_dir" ]] || continue
        local name
        name=$(basename "$project_dir")

        # Skip hidden directories
        [[ "$name" == .* ]] && continue

        projects+=("$name")

        # Check if image exists
        local image_status=""
        local image_name="ds01-${USER_ID}/${name}:latest"
        if docker images -q "$image_name" 2>/dev/null | grep -q .; then
            image_status="${GREEN}(image ready)${NC}"
        else
            image_status="${YELLOW}(needs image)${NC}"
        fi

        # Check project type from metadata
        local project_type=""
        if has_project_metadata "$project_dir" 2>/dev/null; then
            project_type=$(read_project_metadata "$project_dir" "type" 2>/dev/null)
            project_type=" ${DIM}[$project_type]${NC}"
        fi

        echo -e "  ${BOLD}$i)${NC} $name$project_type $image_status"
        ((i++))
    done

    if [[ ${#projects[@]} -eq 0 ]]; then
        echo -e "${YELLOW}No projects found in ~/workspace/${NC}"
        echo -e ""
        read -p "Create a new project? [Y/n]: " CREATE_PROJECT </dev/tty
        CREATE_PROJECT=${CREATE_PROJECT:-Y}
        if [[ "$CREATE_PROJECT" =~ ^[Yy]$ ]]; then
            exec project-init
        else
            echo -e ""
            echo -e "Run ${GREEN}project init${NC} when ready to create a project."
            exit 0
        fi
    fi

    echo -e ""
    echo -e "  ${BOLD}0)${NC} Create new project ${DIM}(runs project-init)${NC}"
    echo -e ""

    read -p "Choice [0-$((i-1))]: " CHOICE </dev/tty

    if [[ "$CHOICE" == "0" ]]; then
        exec project-init
    fi

    if [[ "$CHOICE" =~ ^[0-9]+$ ]] && [[ "$CHOICE" -ge 1 ]] && [[ "$CHOICE" -le ${#projects[@]} ]]; then
        PROJECT_NAME="${projects[$((CHOICE-1))]}"
    else
        echo -e "${RED}Invalid selection${NC}"
        exit 1
    fi
}

# =============================================================================
# HEADER
# =============================================================================

echo -e ""
echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo -e "${BOLD}DS01 Project Launch${NC}"
echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"

if [ "$GUIDED" = true ]; then
    echo -e ""
    echo -e "This orchestrator will:"
    echo -e "  1. Select a project from your workspace"
    echo -e "  2. Build Docker image (if needed)"
    echo -e "  3. Deploy and start container"
fi

# =============================================================================
# STEP 1: SELECT PROJECT
# =============================================================================

if [[ -z "$PROJECT_NAME" ]]; then
    select_project
fi

PROJECT_DIR="$WORKSPACE_DIR/$PROJECT_NAME"

# Validate project exists
if [[ ! -d "$PROJECT_DIR" ]]; then
    echo -e ""
    echo -e "${RED}Project not found: $PROJECT_DIR${NC}"
    echo -e ""
    echo -e "Create it first:"
    echo -e "  ${GREEN}project init $PROJECT_NAME${NC}"
    exit 1
fi

echo -e ""
echo -e "${BOLD}Launching:${NC} ${CYAN}$PROJECT_NAME${NC}"

# =============================================================================
# STEP 2: CHECK IMAGE
# =============================================================================

echo -e ""
echo -e "${BOLD}Checking image...${NC}"

EXPECTED_IMAGE="ds01-${USER_ID}/${PROJECT_NAME}:latest"
IMAGE_EXISTS=false

if docker images -q "$EXPECTED_IMAGE" 2>/dev/null | grep -q .; then
    IMAGE_EXISTS=true
    echo -e "  ${GREEN}Found:${NC} $EXPECTED_IMAGE"
fi

# Rebuild if requested
if [ "$REBUILD" = true ] && [ "$IMAGE_EXISTS" = true ]; then
    echo -e ""
    echo -e "${YELLOW}--rebuild flag: Will rebuild image${NC}"
    IMAGE_EXISTS=false
fi

# Create image if needed
if [ "$IMAGE_EXISTS" = false ]; then
    echo -e ""
    echo -e "${YELLOW}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "${BOLD}Image Required${NC}"
    echo -e "${YELLOW}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e ""
    echo -e "No image found: ${CYAN}$EXPECTED_IMAGE${NC}"
    echo -e ""

    if [ "$GUIDED" = true ]; then
        echo -e "A Docker image is required to create a container."
        echo -e "The image will be built from your project's Dockerfile"
        echo -e "and requirements.txt."
        echo -e ""
    fi

    read -p "Create image now? [Y/n]: " CREATE_IMAGE </dev/tty
    CREATE_IMAGE=${CREATE_IMAGE:-Y}

    if [[ "$CREATE_IMAGE" =~ ^[Yy]$ ]]; then
        echo -e ""

        # Check for per-project Dockerfile first, then centralized
        DOCKERFILE=""
        if [[ -f "$PROJECT_DIR/Dockerfile" ]]; then
            DOCKERFILE="$PROJECT_DIR/Dockerfile"
            echo -e "${GREEN}Found:${NC} $PROJECT_DIR/Dockerfile"
        elif [[ -f "$HOME/dockerfiles/${PROJECT_NAME}.Dockerfile" ]]; then
            DOCKERFILE="$HOME/dockerfiles/${PROJECT_NAME}.Dockerfile"
            echo -e "${GREEN}Found:${NC} $DOCKERFILE"
        fi

        # Check for requirements.txt
        REQ_FILE=""
        if [[ -f "$PROJECT_DIR/requirements.txt" ]]; then
            REQ_FILE="$PROJECT_DIR/requirements.txt"
            echo -e "${GREEN}Found:${NC} requirements.txt"
        fi

        # Build arguments for image-create
        IMAGE_ARGS=("$PROJECT_NAME")
        if [[ -n "$REQ_FILE" ]]; then
            IMAGE_ARGS+=("-r" "$REQ_FILE")
        fi
        if [[ -n "$DOCKERFILE" ]]; then
            IMAGE_ARGS+=("--dockerfile=$DOCKERFILE")
        fi
        if [ "$GUIDED" = true ]; then
            IMAGE_ARGS+=("--guided")
        fi

        echo -e ""
        echo -e "${BOLD}Building image...${NC}"
        echo -e ""

        # Run image-create
        image-create "${IMAGE_ARGS[@]}"

        # Verify image was created
        if ! docker images -q "$EXPECTED_IMAGE" 2>/dev/null | grep -q .; then
            echo -e ""
            echo -e "${RED}Image creation failed${NC}"
            exit 1
        fi

        echo -e ""
        echo -e "${GREEN}Image created successfully${NC}"
    else
        echo -e ""
        echo -e "Cancelled. Create an image first:"
        echo -e "  ${GREEN}image-create $PROJECT_NAME${NC}"
        exit 0
    fi
fi

# =============================================================================
# STEP 3: DEPLOY CONTAINER
# =============================================================================

echo -e ""
echo -e "${BOLD}Deploying container...${NC}"
echo -e ""

# Run container-deploy (let it handle --open/--background interactively if not specified)
container-deploy "$PROJECT_NAME" "${DEPLOY_ARGS[@]}"
