#!/bin/bash
# DS01 Get Limits - User resource dashboard
# Shows user's limits AND current usage across all containers

set -e

# Script paths
SCRIPT_DIR="$(cd "$(dirname "$(readlink -f "${BASH_SOURCE[0]}")")" && pwd)"
INFRA_ROOT="$(cd "$SCRIPT_DIR/../.." && pwd)"
RESOURCE_PARSER="$INFRA_ROOT/scripts/docker/get_resource_limits.py"
GPU_ALLOCATOR="$INFRA_ROOT/scripts/docker/gpu_allocator.py"

# Colors
BLUE='\033[94m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
CYAN='\033[0;36m'
BOLD='\033[1m'
DIM='\033[2m'
NC='\033[0m'

USERNAME=$(whoami)
USER_ID=$(id -u)

usage() {
    echo ""
    echo -e "${BOLD}DS01 Get Limits - Resource Dashboard${NC}"
    echo ""
    echo -e "${CYAN}Usage:${NC}"
    echo "  user get-limits [options]"
    echo "  get-limits [options]"
    echo ""
    echo -e "${CYAN}Options:${NC}"
    echo "  --guided          Show detailed explanations for beginners"
    echo "  -h, --help        Show this help message"
    echo ""
    echo -e "${CYAN}Description:${NC}"
    echo "  Displays your resource limits and current usage across all containers."
    echo "  This is your personal resource dashboard."
    echo ""
    echo -e "${CYAN}What you'll see:${NC}"
    echo "  • Your configured resource limits (GPU, CPU, memory)"
    echo "  • Current GPU allocations (which containers, which GPUs)"
    echo "  • Container count (active vs limit)"
    echo "  • CPU and memory usage per container"
    echo "  • Lifecycle policy limits (idle timeout, max runtime)"
    echo ""
    echo -e "${CYAN}Examples:${NC}"
    echo "  user get-limits                # Show resource dashboard"
    echo "  user get-limits --guided       # With detailed explanations"
    echo "  get-limits                     # Short alias"
    echo ""
}

# Parse arguments
GUIDED=false

while [[ $# -gt 0 ]]; do
    case $1 in
        --guided)
            GUIDED=true
            shift
            ;;
        -h|--help|--info)
            usage
            exit 0
            ;;
        *)
            echo -e "${RED}✗ Unknown option: $1${NC}\n"
            usage
            exit 1
            ;;
    esac
done

# Header
echo ""
echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo -e "${CYAN}${BOLD}    Resource Dashboard for $USERNAME${NC}"
echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo ""

if [ "$GUIDED" = true ]; then
    echo -e "${CYAN}ℹ ${NC}${BOLD}What is this dashboard?${NC}"
    echo "  This shows your personal resource limits and how much you're"
    echo "  currently using across all your containers."
    echo ""
    echo -e "${BOLD}Why does this matter?${NC}"
    echo "  • Know your limits before creating containers"
    echo "  • See which containers are using resources"
    echo "  • Identify containers you can clean up to free resources"
    echo "  • Understand system policies (timeouts, auto-stop, etc.)"
    echo ""
    read -p "Press Enter to see your dashboard..." </dev/tty
    echo ""
fi

# Get user's limits
if [ ! -f "$RESOURCE_PARSER" ]; then
    echo -e "${RED}✗ Resource parser not found${NC}"
    exit 1
fi

USER_GROUP=$(python3 "$RESOURCE_PARSER" "$USERNAME" --group 2>/dev/null || echo "unknown")
MAX_GPUS=$(python3 "$RESOURCE_PARSER" "$USERNAME" --max-gpus 2>/dev/null || echo "1")
PRIORITY=$(python3 "$RESOURCE_PARSER" "$USERNAME" --priority 2>/dev/null || echo "10")
IDLE_TIMEOUT=$(python3 "$RESOURCE_PARSER" "$USERNAME" --idle-timeout 2>/dev/null || echo "None")
MAX_RUNTIME=$(python3 "$RESOURCE_PARSER" "$USERNAME" --max-runtime 2>/dev/null || echo "None")
GPU_HOLD=$(python3 "$RESOURCE_PARSER" "$USERNAME" --gpu-hold-time 2>/dev/null || echo "None")

# Parse full limits for compute resources
LIMITS_OUTPUT=$(python3 "$RESOURCE_PARSER" "$USERNAME" 2>/dev/null)
MAX_CPUS=$(echo "$LIMITS_OUTPUT" | grep "CPU cores:" | awk '{print $3}')
MAX_MEMORY=$(echo "$LIMITS_OUTPUT" | grep "RAM:" | awk '{print $2}')
MAX_CONTAINERS=$(echo "$LIMITS_OUTPUT" | grep "Max containers:" | awk '{print $3}')

# ============ SECTION 1: YOUR LIMITS ============
echo -e "${BOLD}═══ Your Resource Limits ═══${NC}"
echo ""
echo -e "${BOLD}Group:${NC} ${CYAN}$USER_GROUP${NC}"
echo ""

# GPU Limits
echo -e "${BOLD}GPU Resources:${NC}"
if [ "$MAX_GPUS" = "unlimited" ]; then
    echo -e "  • Max GPUs: ${GREEN}Unlimited${NC}"
else
    echo -e "  • Max GPUs: ${CYAN}$MAX_GPUS${NC}"
fi
echo -e "  • Priority: ${CYAN}$PRIORITY${NC} (higher = more priority in allocation)"
echo ""

# Compute Limits (per container)
echo -e "${BOLD}Per-Container Limits:${NC}"
echo -e "  • CPU cores: ${CYAN}$MAX_CPUS${NC}"
echo -e "  • RAM: ${CYAN}$MAX_MEMORY${NC}"
echo ""

# Lifecycle Policies
echo -e "${BOLD}Lifecycle Policies:${NC}"
if [ "$IDLE_TIMEOUT" != "None" ] && [ "$IDLE_TIMEOUT" != "null" ]; then
    echo -e "  • Idle timeout: ${CYAN}$IDLE_TIMEOUT${NC} (auto-stop after GPU idle)"
else
    echo -e "  • Idle timeout: ${GREEN}None${NC} (no auto-stop)"
fi

if [ "$MAX_RUNTIME" != "None" ] && [ "$MAX_RUNTIME" != "null" ]; then
    echo -e "  • Max runtime: ${CYAN}$MAX_RUNTIME${NC} (absolute max container lifetime)"
else
    echo -e "  • Max runtime: ${GREEN}None${NC} (no limit)"
fi

if [ "$GPU_HOLD" != "None" ] && [ "$GPU_HOLD" != "null" ] && [ "$GPU_HOLD" != "indefinite" ]; then
    echo -e "  • GPU hold after stop: ${CYAN}$GPU_HOLD${NC} (restart window)"
elif [ "$GPU_HOLD" = "indefinite" ]; then
    echo -e "  • GPU hold after stop: ${CYAN}Indefinite${NC}"
else
    echo -e "  • GPU hold after stop: ${CYAN}None${NC}"
fi

echo -e "  • Max containers: ${CYAN}$MAX_CONTAINERS${NC}"
echo ""

# ============ SECTION 2: CURRENT USAGE ============
echo -e "${BOLD}═══ Your Current Usage ═══${NC}"
echo ""

# Count containers
ALL_CONTAINERS=$(docker ps -a --filter "name=._.$USER_ID" --format "{{.Names}}" 2>/dev/null | wc -l)
RUNNING_CONTAINERS=$(docker ps --filter "name=._.$USER_ID" --format "{{.Names}}" 2>/dev/null | wc -l)
STOPPED_CONTAINERS=$((ALL_CONTAINERS - RUNNING_CONTAINERS))

# Container count summary
echo -e "${BOLD}Containers:${NC}"
if [ $ALL_CONTAINERS -eq 0 ]; then
    echo -e "  ${DIM}No containers yet${NC}"
else
    # Color code based on usage
    if [ "$MAX_CONTAINERS" != "unlimited" ] && [ $ALL_CONTAINERS -ge $MAX_CONTAINERS ]; then
        CONTAINER_COLOR="$RED"
        WARNING=" ${RED}(AT LIMIT!)${NC}"
    elif [ "$MAX_CONTAINERS" != "unlimited" ] && [ $ALL_CONTAINERS -ge $((MAX_CONTAINERS * 80 / 100)) ]; then
        CONTAINER_COLOR="$YELLOW"
        WARNING=" ${YELLOW}(approaching limit)${NC}"
    else
        CONTAINER_COLOR="$GREEN"
        WARNING=""
    fi
    
    echo -e "  • Total: ${CONTAINER_COLOR}$ALL_CONTAINERS${NC} / ${CYAN}$MAX_CONTAINERS${NC}$WARNING"
    echo -e "  • Running: ${GREEN}$RUNNING_CONTAINERS${NC}"
    if [ $STOPPED_CONTAINERS -gt 0 ]; then
        echo -e "  • Stopped: ${DIM}$STOPPED_CONTAINERS${NC} ${YELLOW}(cleanup to free space)${NC}"
    fi
fi
echo ""

# GPU Usage
echo -e "${BOLD}GPU Allocations:${NC}"
if [ -f "$GPU_ALLOCATOR" ]; then
    GPU_STATUS=$(python3 "$GPU_ALLOCATOR" user-status "$USERNAME" 2>/dev/null || echo "")
    
    if [ -z "$GPU_STATUS" ]; then
        echo -e "  ${DIM}No GPUs currently allocated${NC}"
    else
        # Parse GPU status to count
        GPU_COUNT=$(echo "$GPU_STATUS" | grep -c "GPU/MIG" || echo "0")
        
        # Color code GPU usage
        if [ "$MAX_GPUS" = "unlimited" ]; then
            GPU_COLOR="$GREEN"
            GPU_LIMIT_TEXT="unlimited"
            WARNING=""
        elif [ $GPU_COUNT -ge $MAX_GPUS ]; then
            GPU_COLOR="$RED"
            GPU_LIMIT_TEXT="$MAX_GPUS"
            WARNING=" ${RED}(AT LIMIT!)${NC}"
        elif [ $GPU_COUNT -ge $((MAX_GPUS * 80 / 100)) ]; then
            GPU_COLOR="$YELLOW"
            GPU_LIMIT_TEXT="$MAX_GPUS"
            WARNING=" ${YELLOW}(approaching limit)${NC}"
        else
            GPU_COLOR="$GREEN"
            GPU_LIMIT_TEXT="$MAX_GPUS"
            WARNING=""
        fi
        
        echo -e "  • Allocated: ${GPU_COLOR}$GPU_COUNT${NC} / ${CYAN}$GPU_LIMIT_TEXT${NC}$WARNING"
        echo ""
        echo -e "  ${BOLD}Details:${NC}"
        # Display GPU allocations with container names
        echo "$GPU_STATUS" | while IFS= read -r line; do
            if [[ $line =~ Container:\ ([^\ ]+) ]]; then
                CONTAINER_TAG="${BASH_REMATCH[1]}"
                CONTAINER_NAME=$(echo "$CONTAINER_TAG" | sed "s/\._\.$USER_ID//")
                echo -e "    ${CYAN}$CONTAINER_NAME${NC}"
            elif [[ $line =~ GPU/MIG:\ ([^\ ]+) ]]; then
                GPU_ID="${BASH_REMATCH[1]}"
                echo -e "      └─ GPU/MIG: ${GREEN}$GPU_ID${NC}"
            fi
        done
    fi
else
    echo -e "  ${DIM}GPU allocator not available${NC}"
fi
echo ""

# ============ SECTION 3: CONTAINER DETAILS ============
if [ $ALL_CONTAINERS -gt 0 ]; then
    echo -e "${BOLD}═══ Container Details ═══${NC}"
    echo ""
    
    # Get all user's containers
    CONTAINERS=$(docker ps -a --filter "name=._.$USER_ID" --format "{{.Names}}" 2>/dev/null)
    
    for CONTAINER_TAG in $CONTAINERS; do
        CONTAINER_NAME=$(echo "$CONTAINER_TAG" | sed "s/\._\.$USER_ID//")
        STATUS=$(docker inspect --format='{{.State.Status}}' "$CONTAINER_TAG" 2>/dev/null)
        
        # Status color
        if [ "$STATUS" = "running" ]; then
            STATUS_COLOR="$GREEN"
            STATUS_ICON="●"
        else
            STATUS_COLOR="$DIM"
            STATUS_ICON="○"
        fi
        
        echo -e "${STATUS_COLOR}${STATUS_ICON}${NC} ${BOLD}${CYAN}$CONTAINER_NAME${NC} ${STATUS_COLOR}($STATUS)${NC}"
        
        # Get container stats if running
        if [ "$STATUS" = "running" ]; then
            # CPU and Memory usage
            STATS=$(docker stats "$CONTAINER_TAG" --no-stream --format "{{.CPUPerc}} {{.MemUsage}}" 2>/dev/null || echo "N/A N/A")
            CPU_USAGE=$(echo "$STATS" | awk '{print $1}')
            MEM_USAGE=$(echo "$STATS" | awk '{print $2}')
            
            echo -e "  CPU: ${CYAN}$CPU_USAGE${NC}"
            echo -e "  Memory: ${CYAN}$MEM_USAGE${NC}"
            
            # Check for GPU allocation
            if [ -f "$GPU_ALLOCATOR" ]; then
                GPU_INFO=$(python3 "$GPU_ALLOCATOR" user-status "$USERNAME" 2>/dev/null | grep -A 1 "Container: $CONTAINER_TAG" | grep "GPU/MIG:" || echo "")
                if [ -n "$GPU_INFO" ]; then
                    GPU_ID=$(echo "$GPU_INFO" | awk '{print $2}')
                    echo -e "  GPU: ${GREEN}$GPU_ID${NC}"
                else
                    echo -e "  GPU: ${DIM}None${NC}"
                fi
            fi
            
            # Uptime
            STARTED=$(docker inspect --format='{{.State.StartedAt}}' "$CONTAINER_TAG" 2>/dev/null | cut -d'.' -f1)
            echo -e "  Started: ${DIM}$STARTED${NC}"
        fi
        echo ""
    done
fi

# ============ SECTION 4: RECOMMENDATIONS ============
if [ "$GUIDED" = true ] || [ $STOPPED_CONTAINERS -gt 0 ]; then
    echo -e "${BOLD}═══ Recommendations ═══${NC}"
    echo ""
    
    if [ $STOPPED_CONTAINERS -gt 0 ]; then
        echo -e "${YELLOW}●${NC} You have ${YELLOW}$STOPPED_CONTAINERS${NC} stopped container(s)"
        echo -e "  Consider cleaning up: ${GREEN}container-remove --all${NC}"
        echo ""
    fi
    
    if [ "$GPU_COUNT" -gt 0 ] && [ $STOPPED_CONTAINERS -gt 0 ]; then
        echo -e "${YELLOW}●${NC} Some stopped containers may still hold GPU allocations"
        echo -e "  Check: ${GREEN}container-list${NC}"
        echo ""
    fi
    
    if [ "$GUIDED" = true ]; then
        echo -e "${CYAN}ℹ ${NC}${BOLD}Managing your resources:${NC}"
        echo ""
        echo -e "  ${GREEN}container-list${NC}        See all your containers"
        echo -e "  ${GREEN}container-stop${NC}        Stop a running container"
        echo -e "  ${GREEN}container-remove${NC}     Remove stopped containers"
        echo -e "  ${GREEN}container-stats${NC}       Real-time resource monitoring"
        echo ""
    fi
fi

echo -e "${DIM}────────────────────────────────────────────────${NC}"
echo ""
