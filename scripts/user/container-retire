#!/bin/bash
# DS01 Container Retire - Tier 3 Orchestrator
# Streamlined workflow: Stop container â†’ Remove container (single command)
# Combines container-stop + container-remove with unified messaging

set -e

# Export orchestrator flag for coordinated behavior
export DS01_ORCHESTRATOR=retire

# Colors
BLUE='\033[94m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
CYAN='\033[0;36m'
BOLD='\033[1m'
DIM='\033[2m'
NC='\033[0m'

USERNAME=$(whoami)
USER_ID=$(id -u)

# Script paths
SCRIPT_DIR="$(cd "$(dirname "$(readlink -f "${BASH_SOURCE[0]}")")" && pwd)"
INFRA_ROOT="$(dirname "$(dirname "$SCRIPT_DIR")")"
CONTAINER_STOP="$SCRIPT_DIR/container-stop"
CONTAINER_REMOVE="$SCRIPT_DIR/container-remove"

# Source interactive library (with fallback for development)
if [ -f "/usr/local/lib/interactive-select.sh" ]; then
    source /usr/local/lib/interactive-select.sh
elif [ -f "$INFRA_ROOT/scripts/lib/interactive-select.sh" ]; then
    source "$INFRA_ROOT/scripts/lib/interactive-select.sh"
else
    echo "Error: interactive-select.sh not found"
    exit 1
fi

usage() {
    echo ""
    echo -e "${BOLD}DS01 Container Retire${NC}"
    echo -e "${DIM}Tier 3 Orchestrator - Stops and removes containers in one command${NC}"
    echo ""
    echo -e "${CYAN}Usage:${NC}"
    echo "  container-retire [name] [options]"
    echo "  container-retire                  # Interactive mode - prompts to select"
    echo ""
    echo -e "${CYAN}Arguments:${NC}"
    echo "  name              Container name (optional - will prompt if not provided)"
    echo ""
    echo -e "${CYAN}Options:${NC}"
    echo "  --guided          Show detailed explanations for beginners"
    echo "  -f, --force       Skip confirmation and save prompts (non-interactive)"
    echo "  --dry-run         Show what would be done"
    echo "  -h, --help        Show this help message"
    echo ""
    echo -e "${CYAN}What this does:${NC}"
    echo "  1. Stops the container (if running)"
    echo "  2. Prompts to save changes to image (optional, via docker commit)"
    echo "  3. Removes the container"
    echo "  4. Releases GPU immediately"
    echo ""
    echo -e "${CYAN}What is preserved:${NC}"
    echo -e "  ${GREEN}âœ“${NC} Workspace files (~/workspace/<project>/)"
    echo -e "  ${GREEN}âœ“${NC} Dockerfiles (~/dockerfiles/)"
    echo -e "  ${GREEN}âœ“${NC} Docker images"
    echo -e "  ${GREEN}âœ“${NC} Project configuration files"
    echo ""
    echo -e "${CYAN}Examples:${NC}"
    echo -e "  ${DIM}# Retire specific container (interactive)${NC}"
    echo "  container-retire my-old-project"
    echo ""
    echo -e "  ${DIM}# Interactive selection${NC}"
    echo "  container-retire"
    echo ""
    echo -e "  ${DIM}# Skip confirmations${NC}"
    echo "  container-retire my-project --force"
    echo ""
    echo -e "  ${DIM}# Guided mode for beginners${NC}"
    echo "  container-retire --guided"
    echo ""
    echo -e "${CYAN}Alternative (Tier 2 commands):${NC}"
    echo "  If you prefer step-by-step control:"
    echo -e "  1. ${GREEN}container-stop <name>${NC}    # Stop container"
    echo -e "  2. ${GREEN}container-remove <name>${NC}  # Remove container"
    echo ""
    echo -e "${YELLOW}ğŸ’¡ Saving changes - Best practices:${NC}"
    echo -e "  ${BOLD}Recommended:${NC} Update Dockerfile first"
    echo -e "    ${GREEN}image-update <name> --add \"package1 package2\"${NC}"
    echo -e "    Then rebuild image and redeploy container"
    echo -e "    ${DIM}(Reproducible, version-controlled, team-shareable)${NC}"
    echo ""
    echo -e "  ${BOLD}Quick option:${NC} Save via docker commit (during retirement)"
    echo -e "    Prompts during container-retire to commit changes to image"
    echo -e "    ${DIM}(Fast but not in Dockerfile - gets overwritten on next rebuild)${NC}"
    echo ""
    echo -e "${YELLOW}ğŸ’¡ Use this when:${NC}"
    echo "  â€¢ Completely done with a container"
    echo "  â€¢ Want to free GPU immediately for others"
    echo "  â€¢ Need to recreate container from scratch"
    echo ""
}

# Parse arguments
CONTAINER_NAME=""
GUIDED=false
FORCE=false
DRY_RUN=false

while [[ $# -gt 0 ]]; do
    case $1 in
        --guided)
            GUIDED=true
            shift
            ;;
        -f|--force)
            FORCE=true
            shift
            ;;
        --dry-run)
            DRY_RUN=true
            shift
            ;;
        -h|--help|--info)
            usage
            exit 0
            ;;
        -*)
            echo -e "${RED}âœ— Unknown option: $1${NC}\n"
            usage
            exit 1
            ;;
        *)
            if [ -z "$CONTAINER_NAME" ]; then
                CONTAINER_NAME="$1"
            else
                echo -e "${RED}âœ— Too many arguments${NC}\n"
                usage
                exit 1
            fi
            shift
            ;;
    esac
done

echo ""
echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${BOLD}DS01 Container Retire${NC}"
echo -e "${DIM}Ephemeral containers - Retire when done${NC}"
echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""

if [ "$GUIDED" = true ]; then
    echo -e "${CYAN}â„¹ ${NC}${BOLD}What does retiring mean?${NC}"
    echo ""
    echo "  Retiring a container means:"
    echo -e "  â€¢ ${BOLD}Stop${NC} all running processes inside the container"
    echo -e "  â€¢ ${BOLD}Remove${NC} the container instance completely"
    echo -e "  â€¢ ${BOLD}Release${NC} GPU allocation immediately for others"
    echo ""
    echo -e "${BOLD}What stays safe:${NC}"
    echo -e "  â€¢ ${GREEN}âœ“${NC} All workspace files (~/workspace/<project>/)"
    echo -e "  â€¢ ${GREEN}âœ“${NC} Dockerfiles (~/dockerfiles/)"
    echo -e "  â€¢ ${GREEN}âœ“${NC} Docker images (your blueprints)"
    echo ""
    echo -e "${BOLD}You can recreate anytime:${NC}"
    echo -e "  ${GREEN}container deploy <name>${NC}  ${DIM}# Recreate from image${NC}"
    echo ""
    echo -e "${YELLOW}ğŸ’¡ Think of it:${NC} Shutting down a laptop (container) but keeping your files (workspace)"
    echo ""
    read -p "Press Enter to continue..." </dev/tty
    echo ""
fi

# If no container name, prompt for selection
if [ -z "$CONTAINER_NAME" ]; then
    echo -e "${CYAN}Select container to retire:${NC}"
    echo ""
    CONTAINER_NAME=$(select_container "running")

    if [ -z "$CONTAINER_NAME" ]; then
        # No running containers, try stopped
        echo ""
        echo -e "${YELLOW}No running containers found.${NC}"
        echo ""
        CONTAINER_NAME=$(select_container "stopped")

        if [ -z "$CONTAINER_NAME" ]; then
            echo ""
            echo -e "${YELLOW}No containers to retire.${NC}"
            exit 0
        fi
    fi
    echo ""
fi

# Validate container exists
CONTAINER_TAG="${CONTAINER_NAME}._.${USER_ID}"
if ! docker ps -a --format "{{.Names}}" 2>/dev/null | grep -q "^${CONTAINER_TAG}$"; then
    echo -e "${RED}âœ— Container '$CONTAINER_NAME' not found${NC}"
    exit 1
fi

# Check if container is running or stopped
CONTAINER_STATUS=$(docker inspect -f '{{.State.Status}}' "$CONTAINER_TAG" 2>/dev/null || echo "")

if [ "$DRY_RUN" = true ]; then
    echo -e "${YELLOW}â”â”â” DRY RUN MODE â”â”â”${NC}"
    echo ""
    echo "Would retire container: ${CYAN}$CONTAINER_NAME${NC}"
    echo ""
    if [ "$CONTAINER_STATUS" = "running" ]; then
        echo -e "  ${DIM}1. Stop container${NC}"
    fi
    echo -e "  ${DIM}2. Prompt to save changes to image${NC}"
    echo -e "  ${DIM}3. Remove container${NC}"
    echo -e "  ${DIM}4. Release GPU allocation${NC}"
    echo ""
    exit 0
fi

# Confirm retirement (unless --force)
if [ "$FORCE" != "true" ]; then
    echo -e "${YELLOW}âš  This will stop & remove container: ${BOLD}$CONTAINER_NAME${NC}"
    if [ "$GUIDED" = "true" ]; then
        echo -e "${BOLD}What will happen:${NC}"
        if [ "$CONTAINER_STATUS" = "running" ]; then
            echo "  1. Container will be stopped"
            echo "  2. All running processes will be terminated"
            echo "  3. You'll be prompted to save changes to image (optional)"
            echo "  4. Container will be removed"
            echo "  5. GPU will be released immediately"
        else
            echo "  1. You'll be prompted to save changes to image (optional)"
            echo "  2. Container will be removed"
            echo "  3. GPU will be released immediately"
        fi
        echo ""
        echo -e "${BOLD}What stays safe:${NC}"
        echo -e "  â€¢ ${GREEN}Workspace files${NC} in ~/workspace/$CONTAINER_NAME/"
        echo -e "  â€¢ ${GREEN}Dockerfiles${NC} in ~/dockerfiles/"
        echo -e "  â€¢ ${GREEN}Docker images${NC}"
        echo ""
    fi
    
    read -p "Continue with retirement? [y/N]: " CONFIRM </dev/tty
    if [[ ! "$CONFIRM" =~ ^[Yy]$ ]]; then
        echo "Cancelled."
        exit 0
    fi
    echo ""
fi

# Step 1: Stop container (if running)
if [ "$CONTAINER_STATUS" = "running" ]; then
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${BOLD}Step 1/2: Stopping Container${NC}"
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""

    if [ "$GUIDED" = true ]; then
        echo -e "${CYAN}â„¹ ${NC}${BOLD}Stopping the container...${NC}"
        echo ""
        echo "  This will gracefully shut down all processes."
        echo ""
    fi

    echo -e "${CYAN}Stopping container...${NC}"
    if docker stop -t 10 "$CONTAINER_TAG" > /dev/null 2>&1; then
        echo -e "${GREEN}âœ“${NC} Container stopped"
        echo ""
    else
        echo -e "${RED}âœ— Failed to stop container${NC}"
        exit 1
    fi
fi

# Step 2: Remove container (which includes save image prompt if in interactive mode)
echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
if [ "$CONTAINER_STATUS" = "running" ]; then
    echo -e "${BOLD}Step 2/2: Removing Container${NC}"
else
    echo -e "${BOLD}Removing Container${NC}"
fi
echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""

# Call container-remove with --skip-removal-confirm to skip its removal confirmation
# (we already confirmed above), but container-remove will still show the save image prompt
REMOVE_ARGS=("--skip-removal-confirm")
if [ "$GUIDED" = true ]; then
    REMOVE_ARGS+=("--guided")
fi

if "$CONTAINER_REMOVE" "$CONTAINER_NAME" "${REMOVE_ARGS[@]}"; then
    echo ""
    echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${GREEN}${BOLD}âœ“ Container Retired Successfully!${NC}"
    echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""

    if [ "$GUIDED" = true ]; then
        echo -e "${BOLD}What was done:${NC}"
        echo ""
        if [ "$CONTAINER_STATUS" = "running" ]; then
            echo -e "  ${GREEN}âœ“${NC} Container stopped"
        fi
        echo -e "  ${GREEN}âœ“${NC} Container removed"
        echo -e "  ${GREEN}âœ“${NC} GPU released immediately"
        echo ""
        echo -e "${BOLD}Your data is safe:${NC}"
        echo -e "  ${GREEN}âœ“${NC} Workspace: ~/workspace/$CONTAINER_NAME/"
        echo -e "  ${GREEN}âœ“${NC} Dockerfile: ~/dockerfiles/"
        echo -e "  ${GREEN}âœ“${NC} Docker image: Available for redeployment"
        echo ""
        echo -e "${BOLD}To recreate:${NC}"
        echo -e "  ${GREEN}container deploy $CONTAINER_NAME${NC}"
        echo ""
        echo -e "${YELLOW}ğŸ’¡ Tip:${NC}"
        echo "  You can quickly recreate this container anytime."
        echo "  All your workspace files are safe and waiting."
        echo ""
    else
        echo -e "${BOLD}Summary:${NC}"
        if [ "$CONTAINER_STATUS" = "running" ]; then
            echo -e "  ${GREEN}âœ“${NC} Container stopped and removed"
        else
            echo -e "  ${GREEN}âœ“${NC} Container removed"
        fi
        echo -e "  ${GREEN}âœ“${NC} GPU freed immediately"
        echo ""
        echo -e "${DIM}Workspace files safe in: ~/workspace/$CONTAINER_NAME/${NC}"
        echo ""
        echo -e "${BOLD}To recreate:${NC}  ${GREEN}container deploy $CONTAINER_NAME${NC}"
        echo ""
    fi
else
    echo ""
    echo -e "${RED}âœ— Container retirement failed${NC}"
    echo ""
    echo -e "${YELLOW}Try manually:${NC}"
    echo -e "  ${GREEN}container-stop $CONTAINER_NAME${NC}"
    echo -e "  ${GREEN}container-remove $CONTAINER_NAME${NC}"
    echo ""
    exit 1
fi
