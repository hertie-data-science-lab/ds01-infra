#!/bin/bash
# DS01 Container Retire - L3 Orchestrator
# Streamlined workflow: Stop container ‚Üí Remove container (single command)
# Combines container-stop + container-remove with unified messaging

set -e

# Source DS01 context library
if [[ -f "/opt/ds01-infra/scripts/lib/ds01-context.sh" ]]; then
    source /opt/ds01-infra/scripts/lib/ds01-context.sh
fi

# Set orchestration context - suppresses atomic command "Next steps" output
export DS01_CONTEXT="orchestration"
export DS01_INTERFACE="orchestration"

# Legacy compatibility
export DS01_ORCHESTRATOR=retire

# Colors
BLUE='\033[94m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
CYAN='\033[0;36m'
BOLD='\033[1m'
DIM='\033[2m'
NC='\033[0m'

USERNAME=$(whoami)
USER_ID=$(id -u)

# Script paths
SCRIPT_DIR="/opt/ds01-infra/scripts/user"
INFRA_ROOT="/opt/ds01-infra"
CONTAINER_STOP="$SCRIPT_DIR/container-stop"
CONTAINER_REMOVE="$SCRIPT_DIR/container-remove"

# Source interactive library (with fallback for development)
if [ -f "/usr/local/lib/interactive-select.sh" ]; then
    source /usr/local/lib/interactive-select.sh
elif [ -f "$INFRA_ROOT/scripts/lib/interactive-select.sh" ]; then
    source "$INFRA_ROOT/scripts/lib/interactive-select.sh"
else
    echo "Error: interactive-select.sh not found"
    exit 1
fi

usage() {
    echo ""
    echo -e "${BOLD}DS01 Container Retire${NC}"
    echo -e "${DIM}L3 Orchestrator - Stops and removes containers in one command${NC}"
    echo ""
    echo -e "${CYAN}Usage:${NC}"
    echo "  container-retire [name] [options]"
    echo "  container-retire                  # Interactive mode - prompts to select"
    echo ""
    echo -e "${CYAN}Arguments:${NC}"
    echo "  name              Container name (optional - will prompt if not provided)"
    echo ""
    echo -e "${CYAN}Options:${NC}"
    echo "  --guided          Show detailed explanations for beginners"
    echo "  -f, --force       Skip confirmation and save prompts (non-interactive)"
    echo "  --dry-run         Show what would be done"
    echo "  -h, --help        Show this help message"
    echo ""
    echo -e "${CYAN}What this does:${NC}"
    echo "  1. Stops the container (if running)"
    echo "  2. Prompts to save changes to image (optional, via docker commit)"
    echo "  3. Removes the container"
    echo "  4. Releases GPU immediately"
    echo ""
    echo -e "${CYAN}What is preserved:${NC}"
    echo -e "  ${GREEN}‚úì${NC} Workspace files (~/workspace/<project>/)"
    echo -e "  ${GREEN}‚úì${NC} Dockerfiles (~/dockerfiles/)"
    echo -e "  ${GREEN}‚úì${NC} Docker images"
    echo -e "  ${GREEN}‚úì${NC} Project configuration files"
    echo ""
    echo -e "${CYAN}Examples:${NC}"
    echo -e "  ${DIM}# Retire specific container (interactive)${NC}"
    echo "  container-retire my-old-project"
    echo ""
    echo -e "  ${DIM}# Interactive selection${NC}"
    echo "  container-retire"
    echo ""
    echo -e "  ${DIM}# Skip confirmations${NC}"
    echo "  container-retire my-project --force"
    echo ""
    echo -e "  ${DIM}# Guided mode for beginners${NC}"
    echo "  container-retire --guided"
    echo ""
    echo -e "${CYAN}Advanced (L2 Atomic commands):${NC}"
    echo "  For granular control over container lifecycle:"
    echo -e "  1. ${GREEN}container-stop <name>${NC}    # Stop container"
    echo -e "  2. ${GREEN}container-remove <name>${NC}  # Remove container"
    echo -e "  ${DIM}See: help --atomic${NC}"
    echo ""
    echo -e "${YELLOW}üí° Saving changes - Best practices:${NC}"
    echo -e "  ${BOLD}Recommended:${NC} Update Dockerfile first"
    echo -e "    ${GREEN}image-update <name> --add \"package1 package2\"${NC}"
    echo -e "    Then rebuild image and redeploy container"
    echo -e "    ${DIM}(Reproducible, version-controlled, team-shareable)${NC}"
    echo ""
    echo -e "  ${BOLD}Quick option:${NC} Save via docker commit (during retirement)"
    echo -e "    Prompts during container-retire to commit changes to image"
    echo -e "    ${DIM}(Fast but not in Dockerfile - gets overwritten on next rebuild)${NC}"
    echo ""
    echo -e "${YELLOW}üí° Use this when:${NC}"
    echo "  ‚Ä¢ Completely done with a container"
    echo "  ‚Ä¢ Want to free GPU immediately for others"
    echo "  ‚Ä¢ Need to recreate container from scratch"
    echo ""
    echo -e "${DIM}Run 'help' or 'commands' anytime to see available commands.${NC}"
    echo ""
}

# Parse arguments
CONTAINER_NAME=""
GUIDED=false
FORCE=false
SKIP_INITIAL_CONFIRM=false
DRY_RUN=false

while [[ $# -gt 0 ]]; do
    case $1 in
        --guided)
            GUIDED=true
            shift
            ;;
        -f|--force)
            FORCE=true
            shift
            ;;
        --skip-initial-confirm)
            # Skip only the "Continue? [y/N]" prompt, but show save/image prompts
            # Used when called from container-deploy option 2 (user already confirmed)
            SKIP_INITIAL_CONFIRM=true
            shift
            ;;
        --dry-run)
            DRY_RUN=true
            shift
            ;;
        -h|--help|--info)
            usage
            exit 0
            ;;
        -*)
            echo -e "${RED}‚úó Unknown option: $1${NC}\n"
            usage
            exit 1
            ;;
        *)
            if [ -z "$CONTAINER_NAME" ]; then
                CONTAINER_NAME="$1"
            else
                echo -e "${RED}‚úó Too many arguments${NC}\n"
                usage
                exit 1
            fi
            shift
            ;;
    esac
done

echo ""
echo -e "${CYAN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
echo -e "${BOLD}DS01 Container Retire${NC}"
echo -e "${CYAN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
echo ""

if [ "$GUIDED" = true ]; then
    echo -e "${CYAN}‚Ñπ ${NC}${BOLD}What does retiring mean?${NC}"
    echo ""
    echo "  Retiring a container means:"
    echo -e "  ‚Ä¢ ${BOLD}Stop${NC} all running processes inside the container"
    echo -e "  ‚Ä¢ ${BOLD}Remove${NC} the container instance completely"
    echo -e "  ‚Ä¢ ${BOLD}Release${NC} GPU allocation immediately for others"
    echo ""
    echo -e "${BOLD}What stays safe:${NC}"
    echo -e "  ‚Ä¢ ${GREEN}‚úì${NC} All workspace files (~/workspace/<project>/)"
    echo -e "  ‚Ä¢ ${GREEN}‚úì${NC} Dockerfiles (~/dockerfiles/)"
    echo -e "  ‚Ä¢ ${GREEN}‚úì${NC} Docker images (your blueprints)"
    echo ""
    echo -e "${BOLD}You can recreate anytime:${NC}"
    echo -e "  ${GREEN}container deploy <name>${NC}  ${DIM}# Recreate from image${NC}"
    echo ""
    echo -e "${YELLOW}üí° Think of it:${NC} Shutting down a laptop (container) but keeping your files (workspace)"
    echo ""
    read -p "Press Enter to continue..." </dev/tty
    echo ""
fi

# If no container name, prompt for selection
if [ -z "$CONTAINER_NAME" ]; then
    echo -e "${CYAN}Select container to retire:${NC}"
    echo ""
    CONTAINER_NAME=$(select_container "running")

    if [ -z "$CONTAINER_NAME" ]; then
        # No running containers, try stopped
        echo ""
        echo -e "${YELLOW}No running containers found.${NC}"
        echo ""
        CONTAINER_NAME=$(select_container "stopped")

        if [ -z "$CONTAINER_NAME" ]; then
            echo ""
            echo -e "${YELLOW}No containers to retire.${NC}"
            exit 0
        fi
    fi
    echo ""
fi

# Validate container exists
CONTAINER_TAG="${CONTAINER_NAME}._.${USER_ID}"
if ! docker ps -a --format "{{.Names}}" 2>/dev/null | grep -q "^${CONTAINER_TAG}$"; then
    echo -e "${RED}‚úó Container '$CONTAINER_NAME' not found${NC}"
    exit 1
fi

# Check if container is running or stopped
CONTAINER_STATUS=$(docker inspect -f '{{.State.Status}}' "$CONTAINER_TAG" 2>/dev/null || echo "")

if [ "$DRY_RUN" = true ]; then
    echo -e "${YELLOW}‚îÅ‚îÅ‚îÅ DRY RUN MODE ‚îÅ‚îÅ‚îÅ${NC}"
    echo ""
    echo "Would retire container: ${CYAN}$CONTAINER_NAME${NC}"
    echo ""
    if [ "$CONTAINER_STATUS" = "running" ]; then
        echo -e "  ${DIM}1. Stop container${NC}"
    fi
    echo -e "  ${DIM}2. Prompt to save changes to image${NC}"
    echo -e "  ${DIM}3. Remove container${NC}"
    echo -e "  ${DIM}4. Release GPU allocation${NC}"
    echo ""
    exit 0
fi

# Confirm retirement (unless --force or --skip-initial-confirm)
if [ "$FORCE" != "true" ] && [ "$SKIP_INITIAL_CONFIRM" != "true" ]; then
    echo -e "${YELLOW}‚ö† This will stop & remove container: ${BOLD}$CONTAINER_NAME${NC}\n"
    if [ "$GUIDED" = "true" ]; then
        echo -e "${BOLD}What will happen:${NC}"
        if [ "$CONTAINER_STATUS" = "running" ]; then
            echo "  1. Container will be stopped"
            echo "  2. All running processes will be terminated"
            echo "  3. You'll be prompted to save changes to image (optional)"
            echo "  4. Container will be removed"
            echo "  5. GPU will be released immediately"
        else
            echo "  1. You'll be prompted to save changes to image (optional)"
            echo "  2. Container will be removed"
            echo "  3. GPU will be released immediately"
        fi
        echo ""
        echo -e "${BOLD}What stays safe:${NC}"
        echo -e "  ‚Ä¢ ${GREEN}Workspace files${NC} in ~/workspace/$CONTAINER_NAME/"
        echo -e "  ‚Ä¢ ${GREEN}Dockerfiles${NC} in ~/dockerfiles/"
        echo -e "  ‚Ä¢ ${GREEN}Docker images${NC}"
        echo ""
    fi

    read -p "Continue? [y/N]: " CONFIRM </dev/tty
    if [[ ! "$CONFIRM" =~ ^[Yy]$ ]]; then
        echo "Cancelled."
        exit 0
    fi
    echo ""
fi

# Step 1: Stop container (if running)
if [ "$CONTAINER_STATUS" = "running" ]; then
    echo -e "${CYAN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
    echo -e "${BOLD}Step 1/2: Stopping Container${NC}"
    echo -e "${CYAN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
    echo ""

    if [ "$GUIDED" = true ]; then
        echo -e "${CYAN}‚Ñπ ${NC}${BOLD}Stopping the container...${NC}"
        echo ""
        echo "  This will gracefully shut down all processes."
        echo ""
    fi

    # Clean up any keep-alive processes (defensive - usually already cleaned up)
    docker exec "$CONTAINER_TAG" pkill -f "\[ds01-keep-alive\]" 2>/dev/null || true

    echo -e "${CYAN}Stopping container...${NC}"
    if docker stop -t 10 "$CONTAINER_TAG" > /dev/null 2>&1; then
        echo -e "${GREEN}‚úì${NC} Container stopped"
        echo ""
    else
        echo -e "${RED}‚úó Failed to stop container${NC}"
        exit 1
    fi
fi

# Step 2: Remove container (which includes save image prompt if in interactive mode)
echo -e "${CYAN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
if [ "$CONTAINER_STATUS" = "running" ]; then
    echo -e "${BOLD}Step 2/2: Removing Container${NC}"
else
    echo -e "${BOLD}Removing Container${NC}"
fi
echo -e "${CYAN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
echo ""

# Call container-remove with --skip-removal-confirm to skip its removal confirmation
# (we already confirmed above), and pass --force to skip save image prompt in automated contexts
REMOVE_ARGS=("--skip-removal-confirm")
if [ "$GUIDED" = true ]; then
    REMOVE_ARGS+=("--guided")
fi
if [ "$FORCE" = true ]; then
    REMOVE_ARGS+=("--force")
fi

if "$CONTAINER_REMOVE" "$CONTAINER_NAME" "${REMOVE_ARGS[@]}"; then
    echo ""
    echo -e "${GREEN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
    echo -e "${GREEN}${BOLD}‚úì Container Retired Successfully!${NC}"
    echo -e "${GREEN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
    echo ""

    if [ "$GUIDED" = true ]; then
        echo -e "${BOLD}What was done:${NC}"
        echo ""
        if [ "$CONTAINER_STATUS" = "running" ]; then
            echo -e "  ${GREEN}‚úì${NC} Container stopped"
        fi
        echo -e "  ${GREEN}‚úì${NC} Container removed"
        echo -e "  ${GREEN}‚úì${NC} GPU released immediately"
        echo ""
        echo -e "${BOLD}Your data is safe:${NC}"
        echo -e "  ${GREEN}‚úì${NC} Workspace: ~/workspace/$CONTAINER_NAME/"
        echo -e "  ${GREEN}‚úì${NC} Dockerfile: ~/dockerfiles/"
        echo -e "  ${GREEN}‚úì${NC} Docker image: Available for redeployment"
        echo ""
        echo -e "${BOLD}To recreate:${NC}"
        echo -e "  ${GREEN}container deploy $CONTAINER_NAME${NC}"
        echo ""
        echo -e "${YELLOW}üí° Tip:${NC}"
        echo "  You can quickly recreate this container anytime."
        echo "  All your workspace files are safe and waiting."
        echo ""
    else
        echo -e "${BOLD}Summary:${NC}"
        if [ "$CONTAINER_STATUS" = "running" ]; then
            echo -e "  ${GREEN}‚úì${NC} Container stopped and removed"
        else
            echo -e "  ${GREEN}‚úì${NC} Container removed"
        fi
        echo -e "  ${GREEN}‚úì${NC} GPU freed immediately"
        echo ""
        echo -e "${DIM}Workspace files safe in: ~/workspace/$CONTAINER_NAME/${NC}"
        echo ""
        echo -e "${BOLD}To recreate:${NC}  ${GREEN}container deploy $CONTAINER_NAME${NC}"
        echo ""
    fi

    # Prompt for optional image deletion (always shown when custom image exists)
    # --force skips container confirmations but not this prompt
    {
        # Get image info
        IMAGE_NAME="ds01-$(id -u)/$CONTAINER_NAME:latest"
        IMAGE_SIZE=$(docker images "$IMAGE_NAME" --format "{{.Size}}" 2>/dev/null)
        DOCKERFILE="$HOME/dockerfiles/${CONTAINER_NAME}.Dockerfile"
        DOCKERFILE_SIZE=""
        if [ -f "$DOCKERFILE" ]; then
            DOCKERFILE_SIZE=$(du -h "$DOCKERFILE" 2>/dev/null | cut -f1)
        fi

        if [ -n "$IMAGE_SIZE" ]; then
            echo -e "${CYAN}‚îÅ‚îÅ‚îÅ Image Cleanup (Optional) ‚îÅ‚îÅ‚îÅ${NC}"
            echo ""

            if [ "$GUIDED" = true ]; then
                echo -e "${CYAN}‚Ñπ${NC} ${BOLD}About Docker Images:${NC}"
                echo "  ‚Ä¢ An image is like an executable built from your Dockerfile"
                echo "  ‚Ä¢ It can be rebuilt anytime from the Dockerfile"
                echo "  ‚Ä¢ Keeping it means faster container-deploy (no rebuild needed)"
                echo "  ‚Ä¢ Removing it frees disk space but requires rebuild next time"
                echo ""
            fi

            echo -e "  Image: ${BOLD}$IMAGE_NAME${NC} (${IMAGE_SIZE})"
            if [ -n "$DOCKERFILE_SIZE" ]; then
                echo -e "  Dockerfile: ${GREEN}‚úì${NC} ~/dockerfiles/${CONTAINER_NAME}.Dockerfile (${DOCKERFILE_SIZE})"
            fi
            echo ""
            echo -e "  ${GREEN}Default: Keep image${NC} (faster next deploy)"
            read -p "Also remove the Docker image? [y/N]: " REMOVE_IMAGE </dev/tty

            if [[ "$REMOVE_IMAGE" =~ ^[Yy]$ ]]; then
                if docker rmi "$IMAGE_NAME" > /dev/null 2>&1; then
                    echo -e "${GREEN}‚úì${NC} Image removed"
                    if [ -n "$DOCKERFILE_SIZE" ]; then
                        echo -e "${DIM}  (Can rebuild with: image-create $CONTAINER_NAME)${NC}"
                    fi
                else
                    echo -e "${YELLOW}‚ö†${NC} Could not remove image (may be in use)"
                fi
            else
                echo -e "${DIM}Image kept for faster redeployment${NC}"
            fi
            echo ""
        fi
    }
else
    echo ""
    echo -e "${RED}‚úó Container retirement failed${NC}"
    echo ""
    echo -e "${YELLOW}Try manually:${NC}"
    echo -e "  ${GREEN}container-stop $CONTAINER_NAME${NC}"
    echo -e "  ${GREEN}container-remove $CONTAINER_NAME${NC}"
    echo ""
    exit 1
fi
