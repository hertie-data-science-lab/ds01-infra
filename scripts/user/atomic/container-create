#!/bin/bash
# DS01 Container Create - L2 Atomic Command
# Creates containers via mlc-create-wrapper
# Can be used standalone or called by orchestrators

set -e

# Source DS01 standard library (colors, paths, utilities)
source "${DS01_ROOT:-/opt/ds01-infra}/scripts/lib/init.sh"

# Source DS01 context library for conditional output
if [[ -f "${DS01_LIB}/ds01-context.sh" ]]; then
    source "${DS01_LIB}/ds01-context.sh"
fi

USERNAME=$(whoami)
USER_ID=$(id -u)

# Script paths - resolve symlinks to get real path
SCRIPT_PATH="${BASH_SOURCE[0]}"
# Follow symlink if this script is a symlink
if [ -L "$SCRIPT_PATH" ]; then
    SCRIPT_PATH="$(readlink -f "$SCRIPT_PATH")"
fi
SCRIPT_DIR="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)"
INFRA_ROOT="/opt/ds01-infra"
RESOURCE_PARSER="$INFRA_ROOT/scripts/docker/get_resource_limits.py"
MLC_WRAPPER="$INFRA_ROOT/scripts/docker/mlc-create-wrapper.sh"

usage() {
    echo ""
    echo -e "${BOLD}DS01 Container Create${NC}"
    echo -e "${DIM}L2 Atomic Command - For granular control. Most users should use: container-deploy${NC}"
    echo ""
    echo -e "${CYAN}Usage:${NC}"
    echo "  container-create [name] [image] [options]"
    echo "  container-create              # Interactive wizard (no arguments)"
    echo ""
    echo -e "${CYAN}Arguments:${NC}"
    echo "  name              Container name (optional - wizard starts if omitted)"
    echo "  image             Docker image or framework (pytorch, tensorflow)"
    echo ""
    echo -e "${CYAN}Options:${NC}"
    echo "  --guided          Show detailed explanations for beginners"
    echo "  --cpu-only        Create CPU-only container (no GPU)"
    echo "  --num-migs=N      Request N MIG partitions (default: 1)"
    echo "  --prefer-full     Prefer full GPU over MIG partitions"
    echo "  -w, --workspace   Workspace directory (default: ~/workspace/<name>)"
    echo "  -d, --data        Additional data directory to mount"
    echo "  --dry-run         Show what would be created"
    echo "  -h, --help        Show this help message"
    echo ""
    echo -e "${CYAN}Examples:${NC}"
    echo -e "  ${DIM}# Interactive mode (recommended for first time)${NC}"
    echo "  container-create"
    echo ""
    echo -e "  ${DIM}# Quick create with PyTorch (default)${NC}"
    echo "  container-create my-project"
    echo ""
    echo -e "  ${DIM}# Create from custom image${NC}"
    echo "  container-create my-project my-project-image"
    echo ""
    echo -e "  ${DIM}# Create with TensorFlow${NC}"
    echo "  container-create my-project tensorflow"
    echo ""
    echo -e "  ${DIM}# Guided mode for beginners${NC}"
    echo "  container-create my-project --guided"
    echo ""
    echo -e "  ${DIM}# CPU-only for preprocessing${NC}"
    echo "  container-create preprocessing --cpu-only"
    echo ""
    echo -e "${YELLOW}üí° After creation:${NC}"
    echo -e "  ‚Ä¢ Start container: ${GREEN}container-run <name>${NC}"
    echo -e "  ‚Ä¢ View containers: ${GREEN}container-list${NC}"
    echo -e "  ‚Ä¢ Check resources: ${GREEN}container-stats${NC}"
    echo ""
    echo -e "${DIM}Run 'help --atomic' to see all atomic container commands.${NC}"
    echo ""
}

detailed_help() {
    echo ""
    echo -e "${CYAN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
    echo -e "${BOLD}DS01 Container Create - Full Reference${NC}"
    echo -e "${CYAN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
    echo ""
    echo -e "${DIM}L2 Atomic Command - For granular control. Most users should use: container-deploy${NC}"
    echo ""
    echo -e "${BOLD}Usage:${NC}"
    echo "  container-create [name] [image] [options]"
    echo "  container-create              # Interactive wizard"
    echo ""
    echo -e "${BOLD}Positional Arguments:${NC}"
    echo "  name              Container name (determines workspace directory)"
    echo "  image             Docker image to use. Can be:"
    echo "                    ‚Ä¢ Custom image name (e.g., my-project-image)"
    echo "                    ‚Ä¢ Full image path (e.g., ds01-1001/my-project)"
    echo "                    ‚Ä¢ Framework name (pytorch, tensorflow)"
    echo ""
    echo -e "${BOLD}Options:${NC}"
    echo "  --guided          Interactive mode with detailed explanations"
    echo "  --cpu-only        Create CPU-only container (no GPU allocation)"
    echo "  -w, --workspace   Custom workspace directory"
    echo "                    Default: ~/workspace/<container-name>"
    echo "  -d, --data        Additional data directory to mount (read-only)"
    echo "  --dry-run         Preview creation without executing"
    echo "  --concepts        Show pre-run educational content"
    echo "  --info            Show this detailed reference"
    echo "  -h, --help        Show quick reference"
    echo ""
    echo -e "${BOLD}Framework Shortcuts:${NC}"
    echo "  pytorch           Latest PyTorch from AIME catalog (default)"
    echo "  tensorflow        Latest TensorFlow from AIME catalog"
    echo ""
    echo -e "${BOLD}Container Naming:${NC}"
    echo "  Internal format:  <name>._.${USER_ID}"
    echo "  Display format:   <name> (user-friendly)"
    echo "  Example:          my-project ‚Üí my-project._.1001"
    echo ""
    echo -e "${BOLD}Resource Allocation:${NC}"
    echo "  Containers receive resources based on your user group:"
    echo "  ‚Ä¢ CPUs, Memory, Shared Memory - Per-container limits"
    echo "  ‚Ä¢ GPU/MIG instances - Allocated from available pool"
    echo -e "  ‚Ä¢ Check your limits: ${GREEN}check-limits${NC}"
    echo ""
    echo -e "${BOLD}Examples:${NC}"
    echo ""
    echo -e "  ${DIM}# Interactive wizard (recommended for first time)${NC}"
    echo "  container-create"
    echo ""
    echo -e "  ${DIM}# Create with default PyTorch framework${NC}"
    echo "  container-create my-project"
    echo ""
    echo -e "  ${DIM}# Create from a custom image you built${NC}"
    echo "  container-create my-project ds01-${USER_ID}/my-project-image"
    echo ""
    echo -e "  ${DIM}# Create with TensorFlow framework${NC}"
    echo "  container-create ml-project tensorflow"
    echo ""
    echo -e "  ${DIM}# CPU-only for preprocessing/data work${NC}"
    echo "  container-create data-prep --cpu-only"
    echo ""
    echo -e "  ${DIM}# Custom workspace location${NC}"
    echo "  container-create experiment --workspace ~/projects/experiment"
    echo ""
    echo -e "  ${DIM}# Mount additional data directory${NC}"
    echo "  container-create training --data /shared/datasets"
    echo ""
    echo -e "  ${DIM}# Preview without creating${NC}"
    echo "  container-create my-project --dry-run"
    echo ""
    echo -e "${BOLD}After Creation:${NC}"
    echo -e "  ${GREEN}container-run <name>${NC}      Enter container"
    echo -e "  ${GREEN}container-start <name>${NC}   Start container (background)"
    echo -e "  ${GREEN}container-list${NC}           View your containers"
    echo -e "  ${GREEN}container-stats${NC}          Check resource usage"
    echo ""
    echo -e "${BOLD}Related Commands:${NC}"
    echo -e "  ${GREEN}container-deploy${NC}     Create + start (recommended workflow)"
    echo -e "  ${GREEN}image-create${NC}         Build a custom image first"
    echo -e "  ${GREEN}image-list${NC}           View available images"
    echo ""
}

show_concepts() {
    echo ""
    echo -e "${CYAN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
    echo -e "${BOLD}Understanding Containers${NC}"
    echo -e "${CYAN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
    echo ""
    echo -e "${BOLD}What is a Container?${NC}"
    echo "  A container is an isolated computing environment with:"
    echo "  ‚Ä¢ Operating system (Ubuntu Linux)"
    echo "  ‚Ä¢ Pre-installed software (Python, frameworks, libraries)"
    echo "  ‚Ä¢ GPU access for machine learning"
    echo "  ‚Ä¢ Your workspace files mounted"
    echo ""
    echo -e "${BOLD}Key Terms:${NC}"
    echo -e "  ‚Ä¢ ${CYAN}Image${NC} - Blueprint/template (static, reusable)"
    echo -e "  ‚Ä¢ ${CYAN}Container${NC} - Running instance (where you work)"
    echo -e "  ‚Ä¢ ${CYAN}Workspace${NC} - Your files (~/workspace/<project>/, always safe)"
    echo ""
    echo -e "${BOLD}Important:${NC} Your workspace files are SEPARATE from containers."
    echo "  Containers can be deleted and recreated; your files remain."
    echo ""
    echo -e "${CYAN}‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ${NC}"
    echo ""
    echo -e "${BOLD}Container Lifecycle:${NC}"
    echo ""
    echo -e "  ${GREEN}Created${NC} ‚Üí ${GREEN}Running${NC} ‚Üí ${YELLOW}Stopped${NC} ‚Üí ${RED}Removed${NC}"
    echo ""
    echo "  ‚Ä¢ Created: Container exists but not started"
    echo "  ‚Ä¢ Running: Active, consuming resources, GPU allocated"
    echo "  ‚Ä¢ Stopped: Paused, GPU released (after timeout)"
    echo "  ‚Ä¢ Removed: Deleted (can be recreated from image)"
    echo ""
    echo -e "${CYAN}‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ${NC}"
    echo ""
    echo -e "${BOLD}Resource Allocation:${NC}"
    echo "  DS01 automatically assigns resources based on your group:"
    echo "  ‚Ä¢ CPUs - Processing power"
    echo "  ‚Ä¢ Memory (RAM) - Working memory"
    echo "  ‚Ä¢ GPU/MIG - GPU instances for training"
    echo "  ‚Ä¢ Shared memory - For fast data loading"
    echo ""
    echo -e "  Check your limits: ${GREEN}check-limits${NC}"
    echo ""
    echo -e "${CYAN}‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ${NC}"
    echo ""
    echo -e "${BOLD}Recommended Workflow:${NC}"
    echo ""
    echo -e "  1. Build custom image:    ${GREEN}image-create my-project${NC}"
    echo -e "  2. Deploy container:      ${GREEN}container-deploy my-project${NC}"
    echo "  3. Work in container"
    echo -e "  4. When done:             ${GREEN}container-retire my-project${NC}"
    echo ""
    echo -e "${DIM}Or use atomic commands for fine-grained control:${NC}"
    echo "  container-create ‚Üí container-start ‚Üí container-stop ‚Üí container-remove"
    echo ""
    echo -e "${BOLD}Ready to start?${NC}"
    echo -e "  Run: ${GREEN}container-create${NC}            (interactive wizard)"
    echo -e "  Run: ${GREEN}container-create --guided${NC}   (step-by-step explanations)"
    echo ""
}

# Parse arguments
CONTAINER_NAME=""
IMAGE_OR_FRAMEWORK=""
GUIDED=false
CPU_ONLY=false
WORKSPACE_DIR=""
DATA_DIR=""
DRY_RUN=false
NUM_MIGS=1              # Number of MIG-equivalents (CLI override)
PREFER_FULL=false       # Prefer full GPU over MIGs

while [[ $# -gt 0 ]]; do
    case $1 in
        --guided)
            GUIDED=true
            shift
            ;;
        --cpu-only)
            CPU_ONLY=true
            shift
            ;;
        -w|--workspace)
            WORKSPACE_DIR="$2"
            shift 2
            ;;
        -d|--data)
            DATA_DIR="$2"
            shift 2
            ;;
        --dry-run)
            DRY_RUN=true
            shift
            ;;
        --num-migs=*)
            NUM_MIGS="${1#*=}"
            shift
            ;;
        --prefer-full)
            PREFER_FULL=true
            shift
            ;;
        -h|--help)
            usage
            exit 0
            ;;
        --info)
            detailed_help
            exit 0
            ;;
        --concepts)
            show_concepts
            exit 0
            ;;
        -*)
            echo -e "${RED}‚úó Unknown option: $1${NC}\n"
            usage
            exit 1
            ;;
        *)
            if [ -z "$CONTAINER_NAME" ]; then
                CONTAINER_NAME="$1"
            elif [ -z "$IMAGE_OR_FRAMEWORK" ]; then
                IMAGE_OR_FRAMEWORK="$1"
            else
                echo -e "${RED}‚úó Too many arguments${NC}\n"
                usage
                exit 1
            fi
            shift
            ;;
    esac
done

# Interactive mode if no container name provided
if [ -z "$CONTAINER_NAME" ]; then
    # Show header only in atomic context
    if [[ -z "$DS01_ORCHESTRATOR" && "${DS01_CONTEXT:-atomic}" == "atomic" ]]; then
        echo ""
        echo -e "${CYAN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
        echo -e "${BOLD}DS01 Container Creation Wizard${NC}"
        echo -e "${CYAN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
        echo ""
    fi

    if [ "$GUIDED" = true ]; then
        echo -e "${BOLD}What is container-create?${NC}"
        echo ""
        echo "This command creates containers from Docker images."
        echo ""
        echo "If you don't have a custom image yet, create one first:"
        echo -e "  ${GREEN}image-create my-project${NC}"
        echo ""
        echo "Then come back and run:"
        echo -e "  ${GREEN}container-create my-project${NC}"
        echo ""
        echo -e "  ${CYAN}Workflow:${NC}"
        echo -e "    1. ${BOLD}image-create${NC} ‚Üí Build a custom Docker image (with packages)"
        echo -e "    2. ${BOLD}container-create${NC} ‚Üí Create a container from that image"
        echo -e "    3. ${BOLD}container-run${NC} ‚Üí Enter and use the container"
        echo ""
        read -r -t 0.1 -n 10000 discard </dev/tty 2>/dev/null || true
        read -p "Press Enter to continue..." </dev/tty
        echo ""

        echo -e "${CYAN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
        echo -e "${BOLD}Understanding Containers${NC}"
        echo -e "${CYAN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
        echo ""
        echo -e "${BOLD}What is a Container?${NC}"
        echo "  A container is your computing environment that includes:"
        echo "  ‚Ä¢ Operating system (Ubuntu Linux)"
        echo "  ‚Ä¢ Software pre-installed (Python, PyTorch, TensorFlow, etc.)"
        echo "  ‚Ä¢ GPU access for machine learning"
        echo "  ‚Ä¢ Tools like Jupyter, Git, and more"
        echo ""
        echo -e "${BOLD}Container vs Image:${NC}"
        echo -e "  ${CYAN}Image${NC}     = Template (like a blueprint; build once, reuse many times)"
        echo -e "  ${CYAN}Container${NC} = Running instance (where you do your work)"
        echo ""
        echo -e "${BOLD}Container vs Workspace:${NC}"
        echo -e "  ${CYAN}Container${NC}  = Your computing environment (can be stopped/restarted)"
        echo -e "  ${CYAN}Workspace${NC} = Your files (permanent storage)"
        echo ""
        echo "  Think of it like:"
        echo "  ‚Ä¢ Container = The computer you work on"
        echo "  ‚Ä¢ Workspace = Your hard drive with all your files"
        echo ""
        echo -e "${BOLD}Resource Allocation:${NC}"
        echo "  DS01 automatically assigns resources to your container:"
        echo "  ‚Ä¢ CPUs for computation"
        echo "  ‚Ä¢ Memory (RAM)"
        echo "  ‚Ä¢ GPU/MIG instances for training"
        echo "  ‚Ä¢ Shared memory for data loading"
        echo ""
        echo "  These limits are based on your user group and ensure fair"
        echo "  resource sharing among all users."
        echo ""
        read -r -t 0.1 -n 10000 discard </dev/tty 2>/dev/null || true
        read -p "Press Enter to continue..." </dev/tty
        echo ""
        echo -e "${CYAN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
        echo -e "${BOLD}Step 1: Select Docker Image${NC}"
        echo -e "${CYAN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
        echo ""
        echo "Containers are created from Docker images as blueprints."
        echo ""
    fi

    # Step 1: Image source
    echo -e "  ${BOLD}1) Use existing custom image${NC} ${GREEN}(recommended)${NC}"
    echo "     Select from images you've built with image-create"
    echo ""
    echo -e "  ${BOLD}2) Use base framework${NC} (PyTorch/TensorFlow from AIME catalog)"
    echo "     Quick start with standard frameworks (no customisation)"
    echo ""
    read -r -t 0.1 -n 10000 discard </dev/tty 2>/dev/null || true
    read -p "Choice [1-2, default: 1]: " IMAGE_CHOICE </dev/tty
    IMAGE_CHOICE=${IMAGE_CHOICE:-1}
    echo ""

    case $IMAGE_CHOICE in
        1)
            # Use existing image
            echo -e "${CYAN}‚îÅ‚îÅ‚îÅ Available Images ‚îÅ‚îÅ‚îÅ${NC}"
            echo ""

            # List available images
            if command -v docker &>/dev/null; then
                # Get only user's custom images (using DS01 naming pattern, same as image-list)
                USER_ID_LOCAL=$(id -u)
                mapfile -t IMAGE_ARRAY < <(docker images --format "{{.Repository}}" 2>/dev/null | grep "^ds01-$USER_ID_LOCAL/" | grep -v "^<none>$" | sort -u)
                IMAGE_COUNT=${#IMAGE_ARRAY[@]}

                if [ "$IMAGE_COUNT" -gt 0 ]; then

                    # Display with numbers
                    for i in "${!IMAGE_ARRAY[@]}"; do
                        IMG_REPO="${IMAGE_ARRAY[$i]}"
                        echo -e "  ${BOLD}$((i+1)))${NC} $IMG_REPO"
                    done
                    echo ""

                    read -r -t 0.1 -n 10000 discard </dev/tty 2>/dev/null || true
                    read -p "Select image [1-$IMAGE_COUNT]: " IMG_SELECTION </dev/tty

                    # Default to 1 if empty (common case: only one image available)
                    IMG_SELECTION=${IMG_SELECTION:-1}

                    if [[ "$IMG_SELECTION" =~ ^[0-9]+$ ]] && [ "$IMG_SELECTION" -ge 1 ] && [ "$IMG_SELECTION" -le "$IMAGE_COUNT" ]; then
                        IMAGE_OR_FRAMEWORK="${IMAGE_ARRAY[$((IMG_SELECTION-1))]}"

                        echo ""
                        echo -e "${GREEN}‚úì${NC} Selected image: ${CYAN}$IMAGE_OR_FRAMEWORK${NC}"
                        echo ""

                        # Derive container name from image name
                        # Images are named: ds01-{user-id}/{project} (e.g., ds01-1001/my-project)
                        # Extract project name from repository path
                        CONTAINER_NAME="${IMAGE_OR_FRAMEWORK##*/}"  # Extract everything after last /
                        CONTAINER_NAME="${CONTAINER_NAME%-image}"   # Remove -image suffix if present

                        echo -e "${BOLD}Step 2: Container Name${NC}"
                        echo ""
                        echo -e "Default container name based on image: ${CYAN}$CONTAINER_NAME${NC}"
                        echo ""
                        read -r -t 0.1 -n 10000 discard </dev/tty 2>/dev/null || true
                        read -p "Use this name or enter a different one [$CONTAINER_NAME]: " CUSTOM_NAME </dev/tty

                        if [ -n "$CUSTOM_NAME" ]; then
                            CONTAINER_NAME="$CUSTOM_NAME"
                        fi

                        # Check if container with this name already exists
                        TEMP_TAG="${CONTAINER_NAME}._.${USER_ID}"
                        if docker ps -a --format "{{.Names}}" 2>/dev/null | grep -q "^${TEMP_TAG}$"; then
                            echo ""
                            echo -e "${YELLOW}‚ö† Container '$CONTAINER_NAME' already exists${NC}"
                            echo ""
                            echo -e "${BOLD}What would you like to do?${NC}"
                            echo ""
                            echo -e "  ${GREEN}1${NC}) ${BOLD}Use existing container${NC}"
                            echo -e "     ${DIM}Start the existing container instead${NC}"
                            echo ""
                            echo -e "  ${GREEN}2${NC}) ${BOLD}Recreate container${NC}"
                            echo -e "     ${DIM}Delete existing and create fresh (GPU will be released & reallocated)${NC}"
                            echo ""
                            echo -e "  ${GREEN}3${NC}) ${BOLD}Create with different name${NC}"
                            echo -e "     ${DIM}Keep existing, create new with another name${NC}"
                            echo ""
                            read -r -t 0.1 -n 10000 discard </dev/tty 2>/dev/null || true
                            read -p "Choice [1-3]: " CHOICE </dev/tty
                            echo ""

                            case $CHOICE in
                                1)
                                    echo "Using existing container '$CONTAINER_NAME'"

                                    # If called from orchestrator, don't exit - let orchestrator handle starting
                                    if [[ -n "$DS01_ORCHESTRATOR" || "${DS01_CONTEXT:-atomic}" == "orchestration" ]]; then
                                        export SKIP_CREATE=true
                                        # Continue to skip creation but allow orchestrator to start container
                                    else
                                        echo -e "${GREEN}Start it with: container-run $CONTAINER_NAME${NC}"
                                        echo ""
                                        exit 0
                                    fi
                                    ;;
                                2)
                                    echo -e "${CYAN}Recreating container '$CONTAINER_NAME'...${NC}"
                                    echo ""

                                    # Stop container if running
                                    CONTAINER_STATUS=$(docker inspect -f '{{.State.Status}}' "$TEMP_TAG" 2>/dev/null || echo "")
                                    if [ "$CONTAINER_STATUS" = "running" ]; then
                                        echo -e "${YELLOW}‚ö†${NC} Stopping running container..."
                                        docker stop "$TEMP_TAG" &>/dev/null || true
                                        echo -e "${GREEN}‚úì${NC} Container stopped"
                                    fi

                                    # Release GPU allocation if exists
                                    GPU_ALLOCATOR="$INFRA_ROOT/scripts/docker/gpu-allocator-smart.py"
                                    if [ -f "$GPU_ALLOCATOR" ]; then
                                        echo -e "${YELLOW}‚ö†${NC} Releasing GPU allocation..."
                                        if python3 "$GPU_ALLOCATOR" release "$TEMP_TAG" 2>&1; then
                                            echo -e "${GREEN}‚úì${NC} GPU released"
                                        else
                                            echo -e "${YELLOW}‚ö†${NC} No GPU to release (or already released)"
                                        fi
                                    fi

                                    # Remove container
                                    echo -e "${YELLOW}‚ö†${NC} Removing existing container..."
                                    if docker rm -f "$TEMP_TAG" &>/dev/null; then
                                        echo -e "${GREEN}‚úì${NC} Container removed"
                                    fi

                                    # Clean up metadata
                                    METADATA_FILE="/var/lib/ds01/container-metadata/${TEMP_TAG}.json"
                                    if [ -f "$METADATA_FILE" ]; then
                                        sudo rm -f "$METADATA_FILE" 2>/dev/null || true
                                    fi

                                    echo ""
                                    echo -e "${GREEN}‚úì${NC} Ready to create new container..."
                                    echo ""
                                    ;;
                                3)
                                    echo -e "${CYAN}Create with different name${NC}"
                                    echo ""
                                    read -r -t 0.1 -n 10000 discard </dev/tty 2>/dev/null || true
                                    read -p "New container name: " NEW_NAME </dev/tty

                                    if [ -z "$NEW_NAME" ]; then
                                        echo -e "${RED}‚úó Container name cannot be empty${NC}"
                                        exit 1
                                    fi

                                    CONTAINER_NAME=$(echo "$NEW_NAME" | tr '[:upper:]' '[:lower:]' | tr ' ' '-')
                                    TEMP_TAG="${CONTAINER_NAME}._.${USER_ID}"

                                    # Check if new name also exists
                                    if docker ps -a --format "{{.Names}}" 2>/dev/null | grep -q "^${TEMP_TAG}$"; then
                                        echo -e "${RED}‚úó Container '$CONTAINER_NAME' also exists!${NC}"
                                        echo -e "${YELLOW}‚Ñπ${NC} Run the command again to choose another name"
                                        exit 1
                                    fi

                                    echo -e "${GREEN}‚úì${NC} Will create container '$CONTAINER_NAME'"
                                    echo ""
                                    ;;
                                *)
                                    echo -e "${RED}‚úó Invalid choice${NC}"
                                    exit 1
                                    ;;
                            esac
                        fi

                        echo ""
                    else
                        echo -e "${RED}‚úó Invalid selection${NC}"
                        exit 1
                    fi
                else
                    echo -e "${YELLOW}No custom images found.${NC}"
                    echo ""

                    if [ "$GUIDED" = true ]; then
                        echo "You need to create a Docker image first before creating a container."
                        echo ""
                        echo -e "${BOLD}Why?${NC}"
                        echo "‚Ä¢ An image is the blueprint (contains your frameworks & packages)"
                        echo "‚Ä¢ A container is a running instance created from that blueprint"
                        echo ""
                        echo -e "${BOLD}Next step:${NC}"
                        echo -e "  ${GREEN}image create${NC}"
                        echo ""
                        echo "This will guide you through creating a custom image with your"
                        echo "preferred framework (PyTorch, TensorFlow, etc.) and packages."
                        echo ""
                        echo "After that, come back and run:"
                        echo -e "  ${GREEN}container create${NC}"
                        echo ""
                    else
                        echo "Create an image first:"
                        echo -e "  ${GREEN}image create${NC}"
                        echo ""
                    fi
                    # Exit with code 1 to signal error (no images available)
                    # This prevents container-deploy from continuing to "Step 2/2"
                    exit 1
                fi
            else
                echo -e "${RED}‚úó Docker not available${NC}"
                exit 1
            fi

            # Skip to GPU mode if we selected an existing image
            if [ "$IMAGE_CHOICE" = "1" ] && [ -n "$IMAGE_OR_FRAMEWORK" ]; then
                # Jump to GPU mode section
                :  # No-op, we'll handle GPU mode after the case statement
            fi
            ;;

        2)
            # Use base framework from AIME catalog
            echo -e "${CYAN}‚îÅ‚îÅ‚îÅ Base Framework Selection ‚îÅ‚îÅ‚îÅ${NC}"
            echo ""
            echo -e "${BOLD}Select Framework:${NC}"
            echo ""
            echo -e "  ${BOLD}1)${NC} PyTorch (latest from AIME catalog) ${GREEN}(recommended)${NC}"
            echo -e "  ${BOLD}2)${NC} TensorFlow (latest from AIME catalog)"
            echo ""
            read -r -t 0.1 -n 10000 discard </dev/tty 2>/dev/null || true
            read -p "Framework [1-2, default: 1]: " FW_CHOICE </dev/tty
            FW_CHOICE=${FW_CHOICE:-1}

            if [ "$FW_CHOICE" = "2" ]; then
                IMAGE_OR_FRAMEWORK="tensorflow"
            else
                IMAGE_OR_FRAMEWORK="pytorch"
            fi
            echo ""

            # Ask for container name (loop until valid)
            echo -e "${BOLD}Container Name${NC}"
            echo ""
            while true; do
                read -r -t 0.1 -n 10000 discard </dev/tty 2>/dev/null || true
                read -p "Container name: " CONTAINER_NAME </dev/tty
                if [ -z "$CONTAINER_NAME" ]; then
                    echo -e "${YELLOW}Container name required. Please try again.${NC}"
                    continue
                fi
                break
            done

            # Sanitize name
            CONTAINER_NAME=$(echo "$CONTAINER_NAME" | tr '[:upper:]' '[:lower:]' | tr ' ' '-')

            # Check if container with this name already exists
            TEMP_TAG="${CONTAINER_NAME}._.${USER_ID}"
            if docker ps -a --format "{{.Names}}" 2>/dev/null | grep -q "^${TEMP_TAG}$"; then
                echo ""
                echo -e "${YELLOW}‚ö† Container '$CONTAINER_NAME' already exists${NC}"
                echo ""
                echo -e "${BOLD}What would you like to do?${NC}"
                echo ""
                echo -e "  ${GREEN}1${NC}) ${BOLD}Use existing container${NC}"
                echo -e "     ${DIM}Start the existing container instead${NC}"
                echo ""
                echo -e "  ${GREEN}2${NC}) ${BOLD}Recreate container${NC}"
                echo -e "     ${DIM}Delete existing and create fresh (GPU will be released & reallocated)${NC}"
                echo ""
                echo -e "  ${GREEN}3${NC}) ${BOLD}Create with different name${NC}"
                echo -e "     ${DIM}Keep existing, create new with another name${NC}"
                echo ""
                read -r -t 0.1 -n 10000 discard </dev/tty 2>/dev/null || true
                read -p "Choice [1-3]: " CHOICE </dev/tty
                echo ""

                case $CHOICE in
                    1)
                        echo "Using existing container '$CONTAINER_NAME'"
                        echo -e "${GREEN}Start it with: container-run $CONTAINER_NAME${NC}"
                        echo ""
                        exit 0
                        ;;
                    2)
                        echo -e "${CYAN}Recreating container '$CONTAINER_NAME'...${NC}"
                        echo ""

                        # Stop container if running
                        CONTAINER_STATUS=$(docker inspect -f '{{.State.Status}}' "$TEMP_TAG" 2>/dev/null || echo "")
                        if [ "$CONTAINER_STATUS" = "running" ]; then
                            echo -e "${YELLOW}‚ö†${NC} Stopping running container..."
                            docker stop "$TEMP_TAG" &>/dev/null || true
                            echo -e "${GREEN}‚úì${NC} Container stopped"
                        fi

                        # Release GPU allocation if exists
                        GPU_ALLOCATOR="$INFRA_ROOT/scripts/docker/gpu-allocator-smart.py"
                        if [ -f "$GPU_ALLOCATOR" ]; then
                            echo -e "${YELLOW}‚ö†${NC} Releasing GPU allocation..."
                            if python3 "$GPU_ALLOCATOR" release "$TEMP_TAG" 2>&1; then
                                echo -e "${GREEN}‚úì${NC} GPU released"
                            else
                                echo -e "${YELLOW}‚ö†${NC} No GPU to release (or already released)"
                            fi
                        fi

                        # Remove container
                        echo -e "${YELLOW}‚ö†${NC} Removing existing container..."
                        if docker rm -f "$TEMP_TAG" &>/dev/null; then
                            echo -e "${GREEN}‚úì${NC} Container removed"
                        fi

                        # Clean up metadata
                        METADATA_FILE="/var/lib/ds01/container-metadata/${TEMP_TAG}.json"
                        if [ -f "$METADATA_FILE" ]; then
                            sudo rm -f "$METADATA_FILE" 2>/dev/null || true
                        fi

                        echo ""
                        echo -e "${GREEN}‚úì${NC} Ready to create new container..."
                        echo ""
                        ;;
                    3)
                        echo -e "${CYAN}Create with different name${NC}"
                        echo ""
                        read -r -t 0.1 -n 10000 discard </dev/tty 2>/dev/null || true
                        read -p "New container name: " NEW_NAME </dev/tty

                        if [ -z "$NEW_NAME" ]; then
                            echo -e "${RED}‚úó Container name cannot be empty${NC}"
                            exit 1
                        fi

                        CONTAINER_NAME=$(echo "$NEW_NAME" | tr '[:upper:]' '[:lower:]' | tr ' ' '-')
                        TEMP_TAG="${CONTAINER_NAME}._.${USER_ID}"

                        # Check if new name also exists
                        if docker ps -a --format "{{.Names}}" 2>/dev/null | grep -q "^${TEMP_TAG}$"; then
                            echo -e "${RED}‚úó Container '$CONTAINER_NAME' also exists!${NC}"
                            echo -e "${YELLOW}‚Ñπ${NC} Run the command again to choose another name"
                            exit 1
                        fi

                        echo -e "${GREEN}‚úì${NC} Will create container '$CONTAINER_NAME'"
                        echo ""
                        ;;
                    *)
                        echo -e "${RED}‚úó Invalid choice${NC}"
                        exit 1
                        ;;
                esac
            fi
            echo ""

            if [ "$GUIDED" = true ]; then
                echo -e "${YELLOW}üí° Note:${NC} You're using a base framework without customisation."
                echo ""
                echo "For custom packages (jupyter, pandas, transformers, etc.), create"
                echo "a custom image first:"
                echo -e "  ${GREEN}image-create $CONTAINER_NAME${NC}"
                echo ""
                echo "Then create container from that image:"
                echo -e "  ${GREEN}container-create $CONTAINER_NAME${NC}"
                echo ""
            fi
            ;;

        *)
            echo -e "${RED}‚úó Invalid choice${NC}"
            exit 1
            ;;
    esac

    # Optional: CPU-only mode
    echo -e "${BOLD}GPU Mode:${NC}"
    echo ""
    echo -e "  ${BOLD}1)${NC} GPU enabled ${GREEN}(recommended for training)${NC}"
    echo -e "  ${BOLD}2)${NC} CPU only (for preprocessing/testing)"
    echo ""
    read -r -t 0.1 -n 10000 discard </dev/tty 2>/dev/null || true
    read -p "Choice [1-2, default: 1]: " GPU_CHOICE </dev/tty
    GPU_CHOICE=${GPU_CHOICE:-1}

    if [ "$GPU_CHOICE" = "2" ]; then
        CPU_ONLY=true
    fi
    echo ""
fi

# Sanitize container name
CONTAINER_NAME=$(echo "$CONTAINER_NAME" | tr '[:upper:]' '[:lower:]' | tr ' ' '-')

# Container tag (how docker sees it)
CONTAINER_TAG="${CONTAINER_NAME}._.${USER_ID}"

# =============================================================================
# MIG/GPU Count Selection (for GPU-enabled containers)
# =============================================================================
# Shows for all users with multi-GPU permissions, unless:
# - CPU_ONLY mode is selected
# - User already specified --num-migs on command line

if [ "$CPU_ONLY" != true ] && [ "$NUM_MIGS" -eq 1 ]; then
    # Get user's limits
    MAX_MIG_PER_CONTAINER=$(python3 "$RESOURCE_PARSER" "$USERNAME" --max-mig-per-container 2>/dev/null || echo "1")
    MAX_MIG_TOTAL=$(python3 "$RESOURCE_PARSER" "$USERNAME" --max-gpus 2>/dev/null || echo "2")
    ALLOW_FULL_GPU=$(python3 "$RESOURCE_PARSER" "$USERNAME" --allow-full-gpu 2>/dev/null || echo "false")
    MIG_PER_GPU=$(python3 "$RESOURCE_PARSER" "$USERNAME" --mig-instances-per-gpu 2>/dev/null || echo "4")

    # Get user's current allocation count
    CURRENT_ALLOC=$(python3 "$INFRA_ROOT/scripts/docker/gpu-state-reader.py" user-mig-total "$USERNAME" 2>/dev/null || echo "0")

    # Calculate remaining quota
    if [ "$MAX_MIG_TOTAL" = "unlimited" ] || [ "$MAX_MIG_TOTAL" = "null" ]; then
        REMAINING_QUOTA=999
    else
        REMAINING_QUOTA=$((MAX_MIG_TOTAL - CURRENT_ALLOC))
        [ "$REMAINING_QUOTA" -lt 0 ] && REMAINING_QUOTA=0
    fi

    # Only show MIG selection if user can have more than 1 MIG per container
    if [ "$MAX_MIG_PER_CONTAINER" != "1" ] && [ "$MAX_MIG_PER_CONTAINER" != "" ]; then
        # Get total available MIGs on system
        TOTAL_MIGS=$(nvidia-smi -L 2>/dev/null | grep -c MIG || echo "4")

        # Determine max option: min(per_container_limit, remaining_quota, system_available)
        if [ "$MAX_MIG_PER_CONTAINER" = "unlimited" ] || [ "$MAX_MIG_PER_CONTAINER" = "null" ]; then
            MAX_OPTION=$REMAINING_QUOTA
        else
            MAX_OPTION=$MAX_MIG_PER_CONTAINER
            [ "$MAX_OPTION" -gt "$REMAINING_QUOTA" ] && MAX_OPTION=$REMAINING_QUOTA
        fi
        [ "$MAX_OPTION" -gt "$TOTAL_MIGS" ] && MAX_OPTION=$TOTAL_MIGS

        # Check if user has any remaining quota
        if [ "$MAX_OPTION" -le 0 ]; then
            echo -e "${RED}Cannot allocate GPU resources.${NC}"
            echo ""
            echo "Your limits:"
            echo "  ‚Ä¢ Per container: up to $MAX_MIG_PER_CONTAINER MIG partition(s)"
            echo "  ‚Ä¢ Total (all containers): up to $MAX_MIG_TOTAL MIG partition(s)"
            echo ""
            echo "Current usage:"
            echo "  ‚Ä¢ You have $CURRENT_ALLOC MIG partition(s) allocated"
            echo "  ‚Ä¢ Remaining quota: $REMAINING_QUOTA"
            echo ""
            echo -e "${CYAN}To free up resources:${NC}"
            echo "  container-retire <name>   # Remove a container and free its GPU"
            echo "  check-limits              # View your current usage"
            exit 1
        fi

        # Only show selection menu if user can allocate more than 1
        if [ "$MAX_OPTION" -gt 1 ]; then
            echo -e "${BOLD}GPU Allocation:${NC}"
            echo ""
            if [ "$CURRENT_ALLOC" -gt 0 ]; then
                echo "Current allocation: $CURRENT_ALLOC MIG partition(s)"
            fi
            echo "Available for this container: up to $MAX_OPTION MIG partition(s)"
            echo ""
            echo "How many MIG partitions do you need? (1 full GPU = $MIG_PER_GPU MIGs)"
            echo ""

            # Show dynamic options based on available MIGs
            for i in $(seq 1 $MAX_OPTION); do
                GPU_EQUIV=""
                if [ "$((i % MIG_PER_GPU))" -eq 0 ]; then
                    GPU_COUNT=$((i / MIG_PER_GPU))
                    GPU_EQUIV=" = ${GPU_COUNT} full GPU(s)"
                fi
                if [ "$i" -eq 1 ]; then
                    echo -e "  ${BOLD}${i})${NC} ${i} MIG${GPU_EQUIV} ${GREEN}(recommended)${NC}"
                else
                    echo -e "  ${BOLD}${i})${NC} ${i} MIGs${GPU_EQUIV}"
                fi
            done
            echo ""
            read -r -t 0.1 -n 10000 discard </dev/tty 2>/dev/null || true
            read -p "Enter number of MIGs [1-$MAX_OPTION, default: 1]: " MIG_CHOICE </dev/tty
            MIG_CHOICE=${MIG_CHOICE:-1}
        else
            # User can only allocate 1 MIG, skip selection
            MIG_CHOICE=1
        fi

        # Validate choice
        if [[ "$MIG_CHOICE" =~ ^[0-9]+$ ]] && [ "$MIG_CHOICE" -ge 1 ] && [ "$MIG_CHOICE" -le "$MAX_OPTION" ]; then
            NUM_MIGS=$MIG_CHOICE
        else
            NUM_MIGS=1
        fi
        echo ""

        # Full GPU option (only if user has allow_full_gpu and requesting 4+ MIGs)
        if [ "$ALLOW_FULL_GPU" = "true" ] && [ "$NUM_MIGS" -ge "$MIG_PER_GPU" ]; then
            # Calculate full GPUs and remaining MIGs dynamically
            num_full_gpus=$((NUM_MIGS / MIG_PER_GPU))
            remaining_migs=$((NUM_MIGS % MIG_PER_GPU))

            # Build description for option 2
            full_gpu_desc=""
            if [ "$num_full_gpus" -eq 1 ]; then
                full_gpu_desc="1 Full GPU"
            else
                full_gpu_desc="$num_full_gpus Full GPUs"
            fi
            if [ "$remaining_migs" -gt 0 ]; then
                full_gpu_desc="$full_gpu_desc + $remaining_migs MIG partition(s)"
            fi

            echo -e "${BOLD}GPU Type Preference:${NC}"
            echo ""
            echo -e "  ${BOLD}1)${NC} $NUM_MIGS distributed MIG partitions ${GREEN}(default - better for shared resources)${NC}"
            echo -e "  ${BOLD}2)${NC} $full_gpu_desc (better memory bandwidth, NVLink)"
            echo ""
            read -r -t 0.1 -n 10000 discard </dev/tty 2>/dev/null || true
            read -p "Choice [1-2, default: 1]: " FULL_CHOICE </dev/tty
            FULL_CHOICE=${FULL_CHOICE:-1}

            if [ "$FULL_CHOICE" = "2" ]; then
                PREFER_FULL=true
                echo -e "${GREEN}‚úì${NC} Using $full_gpu_desc"
            fi
            echo ""
        fi

        # Warning for multi-GPU requests
        if [ "$NUM_MIGS" -gt 1 ]; then
            echo -e "${YELLOW}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
            echo -e "${YELLOW}‚ö†  IMPORTANT: Multi-MIG Limitation${NC}"
            echo -e "${YELLOW}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
            echo ""
            echo -e "  Requesting: ${BOLD}$NUM_MIGS MIG partitions${NC}"
            echo ""
            echo -e "  ${RED}CUDA only exposes ONE MIG device per process.${NC}"
            echo -e "  PyTorch/TensorFlow will see: ${BOLD}1 GPU (not $NUM_MIGS)${NC}"
            echo ""
            echo -e "  ${CYAN}Multi-MIG is useful for:${NC}"
            echo -e "    ‚Ä¢ Running multiple independent experiments in parallel"
            echo -e "    ‚Ä¢ Hyperparameter sweeps (each process on separate MIG)"
            echo -e "    ‚Ä¢ Requires multi-process architecture (MPI, subprocess)"
            echo ""
            echo -e "  ${CYAN}For single large model training:${NC}"
            echo -e "    ‚Ä¢ Request a ${BOLD}full GPU${NC} instead (40GB VRAM)"
            echo -e "    ‚Ä¢ Or reduce batch size to fit single MIG (10GB)"
            echo ""
            echo -e "  ${DIM}See: https://ds01-hub.hertie-school.org/docs/multi-mig-training${NC}"
            echo ""
            read -r -t 0.1 -n 10000 discard </dev/tty 2>/dev/null || true
            read -p "Proceed with multi-MIG? [Y/n, default: Y]: " CONFIRM </dev/tty
            CONFIRM=${CONFIRM:-Y}
            if [[ "${CONFIRM,,}" != "y" && "${CONFIRM,,}" != "yes" && -n "$CONFIRM" ]]; then
                echo -e "${CYAN}Cancelled${NC}"
                exit 0
            fi
            echo ""
        fi
    fi
fi

# Default workspace
if [ -z "$WORKSPACE_DIR" ]; then
    WORKSPACE_DIR="$HOME/workspace/$CONTAINER_NAME"
fi

# Check if wrapper exists
if [ ! -f "$MLC_WRAPPER" ]; then
    echo -e "${RED}‚úó mlc-create-wrapper not found${NC}"
    echo ""
    echo -e "${YELLOW}Expected location:${NC} $MLC_WRAPPER"
    echo ""
    echo -e "${YELLOW}Debugging info:${NC}"
    echo "  SCRIPT_DIR: $SCRIPT_DIR"
    echo "  INFRA_ROOT: $INFRA_ROOT"
    echo ""
    echo "The system may not be fully configured."
    echo "Please contact your administrator."
    echo ""
    exit 1
fi

# Check if container already exists (for non-interactive mode with args)
# Note: Interactive mode already checks for duplicates earlier
if docker ps -a --format "{{.Names}}" 2>/dev/null | grep -q "^${CONTAINER_TAG}$"; then
    echo ""
    echo -e "${YELLOW}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
    echo -e "${YELLOW}‚ö†  Container '$CONTAINER_NAME' already exists${NC}"
    echo -e "${YELLOW}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
    echo ""

    # Check GPU allocation status
    GPU_ALLOCATOR="$INFRA_ROOT/scripts/docker/gpu-allocator-smart.py"
    GPU_STATUS=""
    if [ -f "$GPU_ALLOCATOR" ]; then
        GPU_INFO=$(python3 "$GPU_ALLOCATOR" status 2>/dev/null | grep -A1 "$CONTAINER_TAG" || echo "")
        if [ -n "$GPU_INFO" ]; then
            GPU_STATUS=" ${DIM}(with GPU allocated)${NC}"
        fi
    fi

    echo -e "${BOLD}What would you like to do?${NC}"
    echo ""
    echo -e "  ${GREEN}1${NC}) ${BOLD}Use existing container${NC}"
    echo -e "     ${DIM}Start the existing container instead${NC}"
    echo ""
    echo -e "  ${GREEN}2${NC}) ${BOLD}Recreate container${NC}${GPU_STATUS}"
    echo -e "     ${DIM}Delete existing and create fresh (GPU will be released & reallocated)${NC}"
    echo ""
    echo -e "  ${GREEN}3${NC}) ${BOLD}Create with different name${NC}"
    echo -e "     ${DIM}Keep existing, create new with another name${NC}"
    echo ""
    echo -e "  ${GREEN}4${NC}) ${BOLD}Cancel${NC}"
    echo ""
    read -r -t 0.1 -n 10000 discard </dev/tty 2>/dev/null || true
    read -p "Choice [1-4]: " -n 1 -r CHOICE </dev/tty
    echo ""

    case $CHOICE in
        1)
            echo -e "${CYAN}Starting existing container...${NC}"
            echo ""
            exec container-run "$CONTAINER_NAME"
            ;;
        2)
            echo -e "${CYAN}Recreating container '$CONTAINER_NAME'...${NC}"
            echo ""

            # Stop container if running
            CONTAINER_STATUS=$(docker inspect -f '{{.State.Status}}' "$CONTAINER_TAG" 2>/dev/null || echo "")
            if [ "$CONTAINER_STATUS" = "running" ]; then
                echo -e "${YELLOW}‚ö†${NC} Stopping running container..."
                docker stop "$CONTAINER_TAG" &>/dev/null || true
                echo -e "${GREEN}‚úì${NC} Container stopped"
            fi

            # Release GPU allocation if exists
            if [ -f "$GPU_ALLOCATOR" ]; then
                echo -e "${YELLOW}‚ö†${NC} Releasing GPU allocation..."
                if python3 "$GPU_ALLOCATOR" release "$CONTAINER_TAG" 2>&1; then
                    echo -e "${GREEN}‚úì${NC} GPU released"
                else
                    echo -e "${YELLOW}‚ö†${NC} No GPU to release (or already released)"
                fi
            fi

            # Remove container
            echo -e "${YELLOW}‚ö†${NC} Removing existing container..."
            if docker rm -f "$CONTAINER_TAG" &>/dev/null; then
                echo -e "${GREEN}‚úì${NC} Container removed"
            fi

            # Clean up metadata
            METADATA_FILE="/var/lib/ds01/container-metadata/${CONTAINER_TAG}.json"
            if [ -f "$METADATA_FILE" ]; then
                sudo rm -f "$METADATA_FILE" 2>/dev/null || true
            fi

            echo ""
            echo -e "${GREEN}‚úì${NC} Ready to create new container..."
            echo ""
            ;;
        3)
            echo -e "${CYAN}Create with different name${NC}"
            echo ""
            read -r -t 0.1 -n 10000 discard </dev/tty 2>/dev/null || true
            read -p "New container name: " NEW_NAME </dev/tty

            # Validate new name
            if [[ -z "$NEW_NAME" ]]; then
                echo -e "${RED}‚úó Container name cannot be empty${NC}"
                exit 1
            fi

            if [[ ! "$NEW_NAME" =~ ^[a-zA-Z0-9_-]+$ ]]; then
                echo -e "${RED}‚úó Invalid name: use only letters, numbers, hyphens, underscores${NC}"
                exit 1
            fi

            # Check if new name already exists
            NEW_TAG="${NEW_NAME}._.${USER_ID}"
            if docker ps -a --format "{{.Names}}" 2>/dev/null | grep -q "^${NEW_TAG}$"; then
                echo -e "${RED}‚úó Container '$NEW_NAME' also exists!${NC}"
                echo -e "${YELLOW}‚Ñπ${NC} Please choose a different name or select option 2 to recreate"
                exit 1
            fi

            # Update container name for creation
            CONTAINER_NAME="$NEW_NAME"
            CONTAINER_TAG="$NEW_TAG"
            echo -e "${GREEN}‚úì${NC} Will create container '$CONTAINER_NAME'"
            echo ""
            ;;
        4|*)
            echo -e "${CYAN}Cancelled${NC}"
            exit 0
            ;;
    esac
fi

# Determine framework/image
FRAMEWORK="Pytorch"  # Default with proper capitalization for AIME
IMAGE_NAME=""

if [ -n "$IMAGE_OR_FRAMEWORK" ]; then
    # Check if it's a framework name or custom image
    case "${IMAGE_OR_FRAMEWORK,,}" in
        pytorch|torch)
            FRAMEWORK="Pytorch"  # Capitalized for AIME compatibility
            ;;
        tensorflow|tf)
            FRAMEWORK="Tensorflow"  # Capitalized for AIME compatibility
            ;;
        *)
            # Assume it's a custom image name
            # If not prefixed with ds01-, add it
            USER_ID_CHECK=$(id -u)
            check_name="$IMAGE_OR_FRAMEWORK"
            if [[ ! "$check_name" =~ ^ds01- ]]; then
                check_name="ds01-${USER_ID_CHECK}/${IMAGE_OR_FRAMEWORK}"
            fi

            # Check if image exists locally
            if docker image inspect "$check_name" &>/dev/null; then
                # Use full image name, add :latest only if no tag present
                if [[ "$check_name" == *:* ]]; then
                    IMAGE_NAME="$check_name"
                else
                    IMAGE_NAME="$check_name:latest"
                fi
                # Try to detect framework from image labels
                FRAMEWORK=$(docker inspect --format '{{index .Config.Labels "aime.mlc.DS01_FRAMEWORK"}}' "$check_name" 2>/dev/null || echo "Pytorch")
                if [ -z "$FRAMEWORK" ]; then
                    FRAMEWORK="Pytorch"
                fi
                # Ensure framework is capitalized (labels might be lowercase)
                case "${FRAMEWORK,,}" in
                    pytorch|torch) FRAMEWORK="Pytorch" ;;
                    tensorflow|tf) FRAMEWORK="Tensorflow" ;;
                esac
            else
                echo -e "${YELLOW}‚ö† Image '$check_name' not found locally${NC}"
                echo ""
                echo "Using as framework name: $IMAGE_OR_FRAMEWORK"
                FRAMEWORK="$IMAGE_OR_FRAMEWORK"
            fi
            ;;
    esac
fi

# DS01 FIX: Auto-detect matching custom image by container name
# If no image was explicitly specified, check if ds01-{userid}/{container-name} exists
if [ -z "$IMAGE_NAME" ] && [ -n "$CONTAINER_NAME" ]; then
    USER_ID_CHECK=$(id -u)
    AUTO_IMAGE="ds01-${USER_ID_CHECK}/${CONTAINER_NAME}"
    if docker image inspect "$AUTO_IMAGE" &>/dev/null; then
        IMAGE_NAME="${AUTO_IMAGE}:latest"
        echo -e "${GREEN}‚úì${NC} Found matching image: ${CYAN}$IMAGE_NAME${NC}"
        # Try to detect framework from image (for proper mlc handling)
        DETECTED_FRAMEWORK=$(docker inspect --format '{{index .Config.Labels "aime.mlc.DS01_FRAMEWORK"}}' "$AUTO_IMAGE" 2>/dev/null || echo "")
        if [ -n "$DETECTED_FRAMEWORK" ]; then
            case "${DETECTED_FRAMEWORK,,}" in
                pytorch|torch) FRAMEWORK="Pytorch" ;;
                tensorflow|tf) FRAMEWORK="Tensorflow" ;;
            esac
        fi
    fi
fi

# Create workspace directory if it doesn't exist
if [ ! -d "$WORKSPACE_DIR" ]; then
    if [ "$GUIDED" = true ]; then
        echo -e "${CYAN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
        echo -e "${BOLD}Creating Workspace Directory${NC}"
        echo -e "${CYAN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
        echo ""
        echo "Your workspace doesn't exist yet. Creating:"
        echo -e "  ${CYAN}$WORKSPACE_DIR${NC}"
        echo ""
        echo "This directory will be mounted inside the container at:"
        echo -e "  ${CYAN}/workspace${NC}"
        echo ""
        echo "All files you save in /workspace will be stored here permanently."
        echo ""
    fi
    mkdir -p "$WORKSPACE_DIR"
    echo -e "${GREEN}‚úì${NC} Workspace directory created: $WORKSPACE_DIR"
    echo ""
fi

# Show creation summary
echo ""
echo -e "${BOLD}Name:${NC}       $CONTAINER_NAME"
echo -e "${BOLD}Framework:${NC}  $FRAMEWORK"
if [ -n "$IMAGE_NAME" ]; then
    echo -e "${BOLD}Image:${NC}      $IMAGE_NAME"
fi
echo -e "${BOLD}Workspace:${NC}  $WORKSPACE_DIR"
if [ "$CPU_ONLY" = true ]; then
    echo -e "${BOLD}GPU:${NC}        ${YELLOW}CPU only${NC}"
else
    if [ -n "$NUM_MIGS" ] && [ "$NUM_MIGS" -gt 1 ] 2>/dev/null; then
        if [ "$PREFER_FULL" = true ]; then
            echo -e "${BOLD}GPU:${NC}        ${GREEN}Full GPU preferred (${NUM_MIGS} MIG-equiv)${NC}"
        else
            echo -e "${BOLD}GPU:${NC}        ${GREEN}${NUM_MIGS} MIG partitions${NC}"
        fi
    else
        echo -e "${BOLD}GPU:${NC}        ${GREEN}Enabled (auto-allocated)${NC}"
    fi
fi
echo ""

if [ "$DRY_RUN" = true ]; then
    echo -e "${YELLOW}[DRY RUN] Would create container with mlc-create-wrapper${NC}"
    echo ""
    echo "Command that would be executed:"
    echo -e "  ${CYAN}bash $MLC_WRAPPER $CONTAINER_NAME $FRAMEWORK -w=\"$WORKSPACE_DIR\"${NC}"
    if [ "$CPU_ONLY" = true ]; then
        echo -e "  ${CYAN}--cpu-only${NC}"
    fi
    echo ""
    exit 0
fi

# Build arguments for mlc-create-wrapper
WRAPPER_ARGS=("$CONTAINER_NAME" "$FRAMEWORK")

# Add workspace
WRAPPER_ARGS+=("-w=$WORKSPACE_DIR")

# Add data directory if specified
if [ -n "$DATA_DIR" ]; then
    WRAPPER_ARGS+=("-d=$DATA_DIR")
fi

# Add CPU-only flag
if [ "$CPU_ONLY" = true ]; then
    WRAPPER_ARGS+=("--cpu-only")
fi

# Add custom image flag (CRITICAL: tells wrapper to use custom image instead of AIME base)
if [ -n "$IMAGE_NAME" ]; then
    WRAPPER_ARGS+=("--image=$IMAGE_NAME")
fi

# Add multi-GPU allocation flags (distributed containers)
if [ -n "$NUM_MIGS" ] && [ "$NUM_MIGS" -gt 1 ] 2>/dev/null; then
    WRAPPER_ARGS+=("--num-migs=$NUM_MIGS")
fi

if [ "$PREFER_FULL" = true ]; then
    WRAPPER_ARGS+=("--prefer-full")
fi

# Show what we're doing
if [ "$GUIDED" = true ]; then
    echo -e "${CYAN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
    echo -e "${BOLD}What Happens Next${NC}"
    echo -e "${CYAN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
    echo ""
    echo "The system will now:"
    echo ""
    echo -e "  1. ${BOLD}Check your resource limits${NC}"
    echo "     Based on your user group configuration"
    echo ""
    echo -e "  2. ${BOLD}Allocate GPU resources${NC}"
    echo "     Assign GPU/MIG instances if available"
    echo ""
    echo -e "  3. ${BOLD}Download/prepare the Docker image${NC}"
    echo -e "     Get the $FRAMEWORK image (may take a few minutes first time)"
    echo ""
    echo -e "  4. ${BOLD}Create the container${NC}"
    echo "     Set up your computing environment with all software"
    echo ""
    echo -e "  5. ${BOLD}Apply resource limits${NC}"
    echo "     Ensure fair resource sharing"
    echo ""
    echo -e "${DIM}This may take 3-5 minutes on first run (downloading base image)${NC}"
    echo ""
    read -r -t 0.1 -n 10000 discard </dev/tty 2>/dev/null || true
    read -p "Press Enter to continue..." </dev/tty
    echo ""
fi

# Skip creation if using existing container (orchestrator mode)
if [ "$SKIP_CREATE" = "true" ]; then
    echo ""
    # Write container name to temp file for orchestrator to read
    if [ -n "$DS01_CONTAINER_NAME_FILE" ]; then
        echo "$CONTAINER_NAME" > "$DS01_CONTAINER_NAME_FILE"
    fi
    # Exit successfully - orchestrator will handle starting the container
    exit 0
fi

# Call mlc-create-wrapper
echo -e "${CYAN}Creating container via mlc-create-wrapper...${NC}"

if bash "$MLC_WRAPPER" "${WRAPPER_ARGS[@]}"; then
    # Show success banner only in atomic context
    if [[ -z "$DS01_ORCHESTRATOR" && "${DS01_CONTEXT:-atomic}" == "atomic" ]]; then
        echo -e ""
        echo -e "${CYAN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
        echo -e "${GREEN}${BOLD}‚úì Container Created Successfully!${NC}"
        echo -e "${CYAN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
    else
        echo -e "${GREEN}‚úì${NC} Container created"
    fi

    # Only show L2 "Next steps" when NOT called from orchestrator
    # Check both DS01_CONTEXT (new) and DS01_ORCHESTRATOR (legacy)
    if [[ -z "$DS01_ORCHESTRATOR" && "${DS01_CONTEXT:-atomic}" == "atomic" ]]; then
        if [ "$GUIDED" = true ]; then
            echo ""
            echo -e "${BOLD}What Just Happened?${NC}"
            echo ""
            echo "Your container has been created but is not started yet."
            echo ""
            echo -e "${BOLD}Container State:${NC}"
            echo -e "  ‚Ä¢ ${YELLOW}Created${NC} - Container exists but isn't running"
            echo "  ‚Ä¢ No resources are being used yet"
            echo "  ‚Ä¢ Your workspace is ready to be mounted"
            echo ""
            echo -e "${BOLD}Next Steps:${NC}"
            echo ""
            echo -e "  1. ${BOLD}Start the container${NC}"
            echo -e "     ${GREEN}container-run $CONTAINER_NAME${NC}"
            echo "     This starts the container and opens a shell inside"
            echo ""
            echo -e "  2. ${BOLD}Inside the container${NC}"
            echo "     ‚Ä¢ Your workspace is at: /workspace"
            echo "     ‚Ä¢ Run Python scripts: python train.py"
            echo "     ‚Ä¢ Start Jupyter: jlab"
            echo "     ‚Ä¢ Attach IDE to container session"
            echo ""
            echo -e "  3. ${BOLD}Exit the container${NC}"
            echo "     ‚Ä¢ Type 'exit' or press Ctrl+D"
            echo "     ‚Ä¢ Container keeps running in background (until auto-stopped at max-time - TODO HB pass max_runtime here)"
            echo -e "     ‚Ä¢ Re-enter: container-run $CONTAINER_NAME"
            echo ""
            echo -e "  4. ${BOLD}Stop & Remove the container${NC}"
            echo -e "     ${GREEN}container-stop $CONTAINER_NAME${NC}"
            echo -e "     ${GREEN}container-remove $CONTAINER_NAME${NC}"
            echo "     Frees up GPU and resources for others"
            echo ""
            echo -e "${YELLOW}üí° Remember:${NC} Treat containers as ephemeral compute environments; your files in /workspace are safe and persist!"
            echo ""
        else
            echo -e "${BOLD}Next steps:${NC}"
            echo -e "  ‚Ä¢ Start container: ${GREEN}container-start $CONTAINER_NAME${NC}"
            echo -e "  ‚Ä¢ Run container (enter): ${GREEN}container-run $CONTAINER_NAME${NC}"
            echo -e "  ‚Ä¢ View containers: ${GREEN}container-list${NC}"
            echo -e "  ‚Ä¢ Check resources: ${GREEN}container-stats${NC}"
            echo ""
        fi
    fi
else
    EXIT_CODE=$?
    # Detailed error message should already be shown by mlc-create-wrapper
    # Just exit with the same code - don't add confusing generic messages
    exit $EXIT_CODE
fi
