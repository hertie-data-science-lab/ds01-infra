#!/bin/bash
# DS01 Container List - Lists containers via mlc-list with DS01 UX
# L2 Atomic Command - Wraps AIME mlc-list with interactive GUI and formatting

set -e

# Script paths
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
INFRA_ROOT="/opt/ds01-infra"
MLC_LIST="$INFRA_ROOT/aime-ml-containers/mlc-list"

# Source shared libraries
source "$INFRA_ROOT/scripts/lib/init.sh"
[[ -f "$INFRA_ROOT/scripts/lib/ds01-context.sh" ]] && \
    source "$INFRA_ROOT/scripts/lib/ds01-context.sh"

USERNAME=$(whoami)
USER_ID=$(id -u)

usage() {
    echo ""
    echo -e "${BOLD}DS01 Container List${NC}"
    echo ""
    echo -e "${CYAN}Usage:${NC}"
    echo "  container-list [options]"
    echo ""
    echo -e "${CYAN}Options:${NC}"
    echo "  --guided        Show detailed explanations for beginners"
    echo "  -a, --all       Show all containers (not just running)"
    echo "  -d, --detailed  Show detailed information"
    echo "  --format FORMAT Output format (table, simple, json)"
    echo "  -h, --help      Show this help message"
    echo ""
    echo -e "${CYAN}Examples:${NC}"
    echo "  container-list               # Show running containers"
    echo "  container-list --all         # Show all containers (including stopped)"
    echo "  container-list --detailed    # Show detailed info"
    echo ""
    echo -e "${YELLOW}ðŸ’¡ Tip:${NC} This command uses AIME's mlc-list for container discovery"
    echo ""
    echo -e "${DIM}Run 'help' or 'commands' anytime to see available commands.${NC}"
    echo ""
}

format_status() {
    local status="$1"
    case $status in
        Up*)
            echo -e "${GREEN}â—${NC} Running"
            ;;
        Exited*)
            echo -e "${DIM}â—‹${NC} Stopped"
            ;;
        Created)
            echo -e "${BLUE}â—‹${NC} Created"
            ;;
        Paused)
            echo -e "${YELLOW}â—${NC} Paused"
            ;;
        *)
            echo -e "${DIM}$status${NC}"
            ;;
    esac
}

format_uptime() {
    local status="$1"
    # Extract uptime from status string like "Up 2 hours" or "Exited (0) 5 minutes ago"
    echo "$status" | sed 's/Up //' | sed 's/Exited.*/stopped/'
}

# Real docker binary (bypass wrapper filtering to see all containers)
DOCKER_BIN="/usr/bin/docker"

get_user_containers() {
    local show_all="$1"
    local with_type="${2:-false}"  # Set to "true" to output name|type format

    # Get all containers with multiple owner label sources
    # Then filter for current user using robust multi-label detection
    local status_filter=""
    if [ "$show_all" != "true" ]; then
        status_filter="--filter status=running"
    fi

    # Query containers with all relevant owner labels + container type
    # Format: name|ds01.user|aime.mlc.USER|aime.mlc.username|devcontainer.local_folder|ds01.container_type
    $DOCKER_BIN ps -a $status_filter --format \
        '{{.Names}}|{{.Label "ds01.user"}}|{{.Label "aime.mlc.USER"}}|{{.Label "aime.mlc.username"}}|{{.Label "devcontainer.local_folder"}}|{{.Label "ds01.container_type"}}' 2>/dev/null | \
    while IFS='|' read -r name ds01_user aime_user_upper aime_username devcontainer_path container_type; do
        [ -z "$name" ] && continue

        local is_owner=false
        local detected_type="ds01"

        # Check ds01.user label
        if [ "$ds01_user" = "$USERNAME" ]; then
            is_owner=true
        fi

        # Check aime.mlc.USER label (uppercase)
        if [ "$aime_user_upper" = "$USERNAME" ]; then
            is_owner=true
        fi

        # Check aime.mlc.username label (lowercase)
        if [ "$aime_username" = "$USERNAME" ]; then
            is_owner=true
        fi

        # Check devcontainer.local_folder path for /home/USERNAME/
        if [[ "$devcontainer_path" == "/home/$USERNAME/"* ]]; then
            is_owner=true
            # If detected via devcontainer path, it's a devcontainer
            [ -z "$container_type" ] && detected_type="devcontainer"
        fi

        if [ "$is_owner" = true ]; then
            # Use explicit label if set, otherwise use detected type
            local final_type="${container_type:-$detected_type}"

            if [ "$with_type" = "true" ]; then
                echo "$name|$final_type"
            else
                echo "$name"
            fi
        fi
    done
}

# Legacy function name for compatibility
get_container_list_via_mlc() {
    get_user_containers "$1"
}

show_simple() {
    local show_all="$1"

    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${CYAN}${BOLD}    Your Containers${NC}"
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}\n"

    if [ "$GUIDED" = true ]; then
        echo -e "${CYAN}â„¹ ${NC}${BOLD}Understanding Container Status:${NC}"
        echo -e "  â€¢ ${GREEN}Running${NC} - Container is active and ready for work"
        echo -e "  â€¢ ${DIM}Stopped${NC} - Container is paused but can be restarted"
        echo -e "  â€¢ ${BLUE}Created${NC} - Container created but never started"
        echo ""
        echo -e "${CYAN}â„¹ ${NC}${BOLD}What the columns show:${NC}"
        echo -e "  â€¢ Status - Whether container is running or stopped"
        echo -e "  â€¢ Image - The Docker image used (contains software and libraries)"
        echo -e "  â€¢ Time - How long container has been running (or when it stopped)"
        echo -e "  â€¢ GPU - Whether a GPU is allocated to this container"
        echo ""
        echo -e "${CYAN}â„¹ ${NC}${BOLD}Behind the scenes:${NC}"
        echo -e "  â€¢ Containers are filtered using AIME labels (${DIM}aime.mlc.USER${NC})"
        echo ""
    fi

    # Get containers via mlc-list (or docker fallback)
    local containers=$(get_container_list_via_mlc "$show_all")

    if [ -z "$containers" ]; then
        if [ "$show_all" = "true" ]; then
            echo -e "${YELLOW}No containers found${NC}\n"
        else
            echo -e "${YELLOW}No running containers${NC}\n"
            echo -e "${DIM}Show all containers: ${GREEN}container-list --all${NC}"
            echo ""
        fi
        echo -e "${BOLD}Deploy a container:${NC}"
        echo -e "  ${GREEN}container-deploy my-project${NC}"
        echo ""
        return
    fi

    # Filter for running only if needed
    local filtered_containers=""
    if [ "$show_all" = "true" ]; then
        filtered_containers="$containers"
    else
        # Only show running containers
        while IFS= read -r full_name; do
            [ -z "$full_name" ] && continue
            local status=$(docker ps -a --format "{{.Status}}" --filter "name=^${full_name}$" 2>/dev/null)
            if [[ "$status" == Up* ]]; then
                filtered_containers="${filtered_containers}${full_name}\n"
            fi
        done <<< "$containers"
        filtered_containers=$(echo -e "$filtered_containers" | grep -v "^$")
    fi

    if [ -z "$filtered_containers" ]; then
        echo -e "${YELLOW}No running containers${NC}\n"
        echo -e "${DIM}Show all containers: ${GREEN}container-list --all${NC}"
        echo ""
        return
    fi

    # Count
    local total=$(echo "$filtered_containers" | grep -v "^$" | wc -l | tr -d ' ')
    local running=$(docker ps --format "{{.Names}}" --filter "name=._.$USER_ID" 2>/dev/null | wc -l | tr -d ' ')

    # Display each container
    local count=0
    while IFS= read -r full_name; do
        [ -z "$full_name" ] && continue
        count=$((count + 1))

        # Extract short name (strip ._.UID suffix if present)
        local name=$(echo "$full_name" | sed "s/\._\.$USER_ID//")

        # Get info via docker inspect (DS01-specific display)
        local status=$(docker ps -a --format "{{.Status}}" --filter "name=^${full_name}$" 2>/dev/null)
        local image=$(docker inspect --format "{{.Config.Image}}" "$full_name" 2>/dev/null | cut -d: -f1)
        local uptime=$(format_uptime "$status")

        # Detect container type from ds01.container_type label (set by docker-wrapper)
        local container_type=$(docker inspect --format "{{index .Config.Labels \"ds01.container_type\"}}" "$full_name" 2>/dev/null)
        if [ -z "$container_type" ] || [ "$container_type" = "<no value>" ]; then
            container_type="ds01"
        fi
        # orchestration/atomic are both native ds01 containers
        if [ "$container_type" = "orchestration" ] || [ "$container_type" = "atomic" ]; then
            container_type="ds01"
        fi

        # Check GPU allocation status
        local has_gpu=false
        if [[ "$status" == Up* ]]; then
            local gpu=$(docker inspect --format "{{.HostConfig.DeviceRequests}}" "$full_name" 2>/dev/null)
            if [[ "$gpu" != "[]" ]] && [[ "$gpu" != "<no value>" ]]; then
                has_gpu=true
            fi
        fi

        # Format type display
        local type_display=""
        case "$container_type" in
            devcontainer)
                type_display=" ${DIM}(dev container)${NC}"
                ;;
            compose)
                type_display=" ${DIM}(compose)${NC}"
                ;;
            docker)
                type_display=" ${DIM}(docker)${NC}"
                ;;
            *)
                # ds01 is default, don't show label
                type_display=""
                ;;
        esac

        # Status indicator with type
        echo -e "${BOLD}$count. ${CYAN}$name${NC}${type_display}"
        echo -e "   Status: $(format_status "$status")"
        echo -e "   Image:  ${DIM}$image${NC}"
        echo -e "   Time:   ${DIM}$uptime${NC}"

        # Show GPU if running (already checked above for classification)
        if [ "$has_gpu" = true ]; then
            echo -e "   GPU:    ${GREEN}Allocated${NC}"
        fi

        echo ""
    done <<< "$filtered_containers"

    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${BOLD}Total:${NC} $total container(s)  â€¢  ${GREEN}$running running${NC}"

    if [ "$show_all" = "true" ]; then
        local stopped=$((total - running))
        if [ "$stopped" -gt 0 ]; then
            echo -e "       ${DIM}$stopped stopped${NC}"
        fi
    fi

    echo ""

    # Tips
    echo -e "${YELLOW}ðŸ’¡ For More Info:${NC}"
    echo -e "   Also stopped:           ${GREEN}container list --all${NC}"
    echo -e "   Detailed metadata:      ${GREEN}container list --detailed${NC}"
    echo -e "   With walkthrough:       ${GREEN}container list --guided${NC}"
    echo ""

    if [ "$GUIDED" = true ]; then
        echo ""

        # Tips
        echo -e "${YELLOW}ðŸ’¡ Further Quick Commands:${NC}"
        echo -e "   Start:    ${GREEN}container-run <name>${NC}"
        echo -e "   Stop:     ${GREEN}container-stop <name>${NC}"
        echo -e "   Stats:    ${GREEN}container-stats${NC}"
        echo -e "   Cleanup:  ${GREEN}container-remove${NC}"
        echo ""
    fi
}

show_detailed() {
    local show_all="$1"

    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${CYAN}${BOLD}    Detailed Container Information${NC}"
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}\n"

    # Get containers via mlc-list
    local containers=$(get_container_list_via_mlc "$show_all")

    if [ -z "$containers" ]; then
        echo -e "${YELLOW}No containers found${NC}\n"
        return
    fi

    # Filter for running only if needed
    local filtered_containers=""
    if [ "$show_all" = "true" ]; then
        filtered_containers="$containers"
    else
        while IFS= read -r full_name; do
            [ -z "$full_name" ] && continue
            local status=$(docker ps -a --format "{{.Status}}" --filter "name=^${full_name}$" 2>/dev/null)
            if [[ "$status" == Up* ]]; then
                filtered_containers="${filtered_containers}${full_name}\n"
            fi
        done <<< "$containers"
        filtered_containers=$(echo -e "$filtered_containers" | grep -v "^$")
    fi

    local count=0
    while IFS= read -r full_name; do
        [ -z "$full_name" ] && continue
        count=$((count + 1))

        local name=$(echo "$full_name" | sed "s/\._\.$USER_ID//")

        echo -e "${BOLD}â”â”â” Container #$count: ${CYAN}$name${NC} ${BOLD}â”â”â”${NC}\n"

        # Basic info (all via docker inspect - DS01 specific)
        local status=$(docker ps -a --format "{{.Status}}" --filter "name=^${full_name}$" 2>/dev/null)
        local image=$(docker inspect --format "{{.Config.Image}}" "$full_name" 2>/dev/null)
        local created=$(docker inspect --format "{{.Created}}" "$full_name" 2>/dev/null | cut -d. -f1 | sed 's/T/ /')
        local id=$(docker inspect --format "{{.Id}}" "$full_name" 2>/dev/null | cut -c1-12)

        echo -e "${BOLD}General:${NC}"
        echo -e "  Name:       $name"
        echo -e "  Full Name:  ${DIM}$full_name${NC}"
        echo -e "  ID:         ${DIM}$id${NC}"
        echo -e "  Status:     $(format_status "$status")"
        echo -e "  Created:    ${DIM}$created${NC}"
        echo -e "  Image:      $image"

        # Check for AIME labels (verify mlc-list integration)
        local aime_framework=$(docker inspect --format "{{index .Config.Labels \"aime.mlc.FRAMEWORK\"}}" "$full_name" 2>/dev/null)
        if [ -n "$aime_framework" ] && [ "$aime_framework" != "<no value>" ]; then
            echo -e "  Framework:  ${GREEN}$aime_framework${NC} ${DIM}(via AIME)${NC}"
        fi

        # Resources
        echo -e "\n${BOLD}Resources:${NC}"
        local cpus=$(docker inspect --format "{{.HostConfig.NanoCpus}}" "$full_name" 2>/dev/null)
        if [ "$cpus" != "0" ] && [ -n "$cpus" ]; then
            cpus=$((cpus / 1000000000))
            echo -e "  CPUs:       ${GREEN}$cpus cores${NC}"
        fi

        local memory=$(docker inspect --format "{{.HostConfig.Memory}}" "$full_name" 2>/dev/null)
        if [ "$memory" != "0" ] && [ -n "$memory" ]; then
            memory=$((memory / 1024 / 1024 / 1024))
            echo -e "  Memory:     ${GREEN}${memory}GB${NC}"
        fi

        local gpu=$(docker inspect --format "{{.HostConfig.DeviceRequests}}" "$full_name" 2>/dev/null)
        if [[ "$gpu" != "[]" ]] && [[ "$gpu" != "<no value>" ]]; then
            echo -e "  GPU:        ${GREEN}Enabled${NC}"
        else
            echo -e "  GPU:        ${DIM}CPU-only${NC}"
        fi

        # Mounts
        local workspace=$(docker inspect --format "{{range .Mounts}}{{if eq .Destination \"/workspace\"}}{{.Source}}{{end}}{{end}}" "$full_name" 2>/dev/null)
        if [ -n "$workspace" ]; then
            echo -e "\n${BOLD}Mounts:${NC}"
            echo -e "  Workspace:  ${BLUE}$workspace${NC}"
            local data=$(docker inspect --format "{{range .Mounts}}{{if eq .Destination \"/data\"}}{{.Source}}{{end}}{{end}}" "$full_name" 2>/dev/null)
            if [ -n "$data" ]; then
                echo -e "  Data:       ${BLUE}$data${NC}"
            fi
            local models=$(docker inspect --format "{{range .Mounts}}{{if eq .Destination \"/models\"}}{{.Source}}{{end}}{{end}}" "$full_name" 2>/dev/null)
            if [ -n "$models" ]; then
                echo -e "  Models:     ${BLUE}$models${NC} ${DIM}(AIME v2)${NC}"
            fi
        fi

        # Ports
        local ports=$(docker port "$full_name" 2>/dev/null)
        if [ -n "$ports" ]; then
            echo -e "\n${BOLD}Ports:${NC}"
            echo "$ports" | while read -r port; do
                echo -e "  ${GREEN}$port${NC}"
            done
        fi

        # Metadata
        local info_file="$HOME/ds01-config/containers/${name}.info"
        if [ -f "$info_file" ]; then
            local created_date=$(grep "^Created:" "$info_file" | cut -d: -f2- | xargs)
            if [ -n "$created_date" ]; then
                echo -e "\n${BOLD}Metadata:${NC}"
                echo -e "  Created:    ${DIM}$created_date${NC}"
            fi
        fi

        echo ""
    done <<< "$filtered_containers"
}

# Parse arguments
GUIDED=false
SHOW_ALL=false
DETAILED=false
FORMAT="simple"

while [[ $# -gt 0 ]]; do
    case $1 in
        --guided)
            GUIDED=true
            shift
            ;;
        -a|--all)
            SHOW_ALL=true
            shift
            ;;
        -d|--detailed)
            DETAILED=true
            shift
            ;;
        --format)
            FORMAT="$2"
            shift 2
            ;;
        -h|--help|--info)
            usage
            exit 0
            ;;
        *)
            echo -e "${RED}âœ— Unknown option: $1${NC}\n"
            usage
            exit 1
            ;;
    esac
done

# Display
if [ "$DETAILED" = true ]; then
    show_detailed "$SHOW_ALL"
else
    show_simple "$SHOW_ALL"
fi
