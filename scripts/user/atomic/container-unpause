#!/bin/bash
# DS01 Container Unpause - Resumes paused containers
# L2 Atomic Command - Resumes frozen container processes

set -e

# Script paths
SCRIPT_DIR="/opt/ds01-infra/scripts/user"
INFRA_ROOT="/opt/ds01-infra"

# Source interactive library (with fallback for development)
if [ -f "/usr/local/lib/interactive-select.sh" ]; then
    source /usr/local/lib/interactive-select.sh
elif [ -f "$INFRA_ROOT/scripts/lib/interactive-select.sh" ]; then
    source "$INFRA_ROOT/scripts/lib/interactive-select.sh"
else
    echo "Error: interactive-select.sh not found"
    exit 1
fi

# Colors
BLUE='\033[94m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
CYAN='\033[0;36m'
BOLD='\033[1m'
DIM='\033[2m'
NC='\033[0m'

USERNAME=$(whoami)
USER_ID=$(id -u)

usage() {
    echo -e ""
    echo -e "${BOLD}DS01 Container Unpause${NC}"
    echo -e ""
    echo -e "${CYAN}Usage:${NC}"
    echo -e "  container-unpause [name] [options]"
    echo -e "  container-unpause                  # Interactive mode - prompts to select"
    echo -e ""
    echo -e "${CYAN}Options:${NC}"
    echo -e "  --guided        Show detailed explanations for beginners"
    echo -e "  -a, --all       Unpause all your paused containers"
    echo -e "  -h, --help      Show this help message"
    echo -e ""
    echo -e "${CYAN}Description:${NC}"
    echo -e "  Resumes a paused (frozen) container."
    echo -e "  All suspended processes continue from where they left off."
    echo -e ""
    echo -e "${CYAN}What happens when unpaused:${NC}"
    echo -e "  ${BOLD}Resumed:${NC}"
    echo -e "    • All processes continue executing"
    echo -e "    • Training resumes from exact point"
    echo -e "    • Network connections restored"
    echo -e ""
    echo -e "${CYAN}Examples:${NC}"
    echo -e "  container-unpause my-project"
    echo -e "  container-unpause --all"
    echo -e ""
}

unpause_container() {
    local container_name="$1"
    local guided="$2"
    local container_tag="${container_name}._.$USER_ID"

    # Check if container exists
    if ! docker ps -a --format "{{.Names}}" | grep -q "^${container_tag}$"; then
        echo -e "${RED}✗${NC} Container '$container_name' not found"
        return 1
    fi

    # Check if paused
    local status=$(docker inspect -f '{{.State.Status}}' "$container_tag" 2>/dev/null)
    if [ "$status" != "paused" ]; then
        if [ "$status" = "running" ]; then
            echo -e "${YELLOW}○${NC} Container '$container_name' is already running"
        else
            echo -e "${YELLOW}○${NC} Container '$container_name' is not paused (status: $status)"
            echo -e "   Start with: ${GREEN}container-run $container_name${NC}"
        fi
        return 0
    fi

    # Show info
    echo -e "${BOLD}Container:${NC} ${CYAN}$container_name${NC}"
    echo -e ""

    if [ "$guided" = "true" ]; then
        echo -e "${CYAN}ℹ ${NC}${BOLD}What is unpausing?${NC}"
        echo -e ""
        echo -e "  Unpausing resumes all frozen processes."
        echo -e "  It's like pressing play after pausing a video:"
        echo -e ""
        echo -e "  • All programs continue from where they stopped"
        echo -e "  • Training resumes mid-batch"
        echo -e "  • State is exactly preserved"
        echo -e ""
    fi

    # Unpause container
    echo -e "${CYAN}Resuming container...${NC}"

    if docker unpause "$container_tag" > /dev/null 2>&1; then
        echo -e "${GREEN}✓${NC} Container resumed"
        echo -e ""

        echo -e "${BOLD}Container is now running.${NC}"
        echo -e ""
        echo -e "${BOLD}To attach:${NC}"
        echo -e "  ${GREEN}container-attach $container_name${NC}"
        echo -e ""

        return 0
    else
        echo -e "${RED}✗${NC} Failed to unpause container"
        return 1
    fi
}

# Parse arguments
CONTAINER_NAME=""
GUIDED=false
UNPAUSE_ALL=false

while [[ $# -gt 0 ]]; do
    case $1 in
        --guided)
            GUIDED=true
            shift
            ;;
        -a|--all)
            UNPAUSE_ALL=true
            shift
            ;;
        -h|--help|--info)
            usage
            exit 0
            ;;
        -*)
            echo -e "${RED}✗ Unknown option: $1${NC}\n"
            usage
            exit 1
            ;;
        *)
            if [ -z "$CONTAINER_NAME" ]; then
                CONTAINER_NAME="$1"
            else
                echo -e "${RED}✗ Too many arguments${NC}\n"
                usage
                exit 1
            fi
            shift
            ;;
    esac
done

echo -e ""
echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo -e "${CYAN}${BOLD}    Resuming Container${NC}"
echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo -e ""

# Unpause all containers
if [ "$UNPAUSE_ALL" = true ]; then
    # Get paused containers
    CONTAINERS=$(docker ps -a --format "{{.Names}}\t{{.State}}" --filter "name=._.$USER_ID" | grep "paused" | cut -f1 | sed "s/\._\.$USER_ID//")

    if [ -z "$CONTAINERS" ]; then
        echo -e "${YELLOW}No paused containers found${NC}\n"
        exit 0
    fi

    echo -e "${BOLD}Resuming all your paused containers:${NC}\n"

    SUCCESS_COUNT=0
    FAIL_COUNT=0

    while IFS= read -r name; do
        [ -z "$name" ] && continue
        if unpause_container "$name" "$GUIDED"; then
            SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
        else
            FAIL_COUNT=$((FAIL_COUNT + 1))
        fi
        echo -e ""
    done <<< "$CONTAINERS"

    echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "${BOLD}Summary:${NC}"
    echo -e "  Resumed: ${GREEN}$SUCCESS_COUNT${NC}"
    if [ "$FAIL_COUNT" -gt 0 ]; then
        echo -e "  Failed: ${RED}$FAIL_COUNT${NC}"
    fi
    echo -e ""
    exit 0
fi

# If no container name, prompt for selection
if [ -z "$CONTAINER_NAME" ]; then
    echo -e "${CYAN}Select container to unpause:${NC}"
    echo -e ""

    # Get paused containers only
    PAUSED_CONTAINERS=$(docker ps -a --format "{{.Names}}" --filter "status=paused" --filter "name=._.$USER_ID" | sed "s/\._\.$USER_ID//")

    if [ -z "$PAUSED_CONTAINERS" ]; then
        echo -e "${YELLOW}No paused containers found.${NC}"
        echo -e ""
        exit 0
    fi

    # Simple selection for paused containers
    echo -e "$PAUSED_CONTAINERS" | nl -w2 -s") "
    echo -e ""
    read -p "Select container (number): " selection
    CONTAINER_NAME=$(echo "$PAUSED_CONTAINERS" | sed -n "${selection}p")

    if [ -z "$CONTAINER_NAME" ]; then
        echo -e "${RED}✗ Invalid selection${NC}"
        exit 1
    fi
    echo -e ""
fi

# Validate container name
if [ -z "$CONTAINER_NAME" ] && [ "$UNPAUSE_ALL" = false ]; then
    echo -e "${RED}✗ Container name is required${NC}\n"
    usage
    exit 1
fi

# Unpause container
unpause_container "$CONTAINER_NAME" "$GUIDED"
