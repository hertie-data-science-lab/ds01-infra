#!/bin/bash
# DS01 VS Code Setup - Configure VS Code Remote-SSH connection
# L2 Atomic Command - Can be used standalone or called by orchestrators

set -e

# Colors
BLUE='\033[0;34m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
CYAN='\033[0;36m'
BOLD='\033[1m'
DIM='\033[2m'
NC='\033[0m'

USERNAME=$(whoami)
USER_ID=$(id -u)

# Check if we're in orchestration context (called by user-setup)
IS_ORCHESTRATED=false
if [[ "${DS01_CONTEXT:-}" == "orchestration" ]]; then
    IS_ORCHESTRATED=true
fi

usage() {
    echo ""
    echo -e "${BOLD}Connecting Your IDE (VS Code) To DS01${NC}"
    echo ""
    echo -e "${CYAN}Usage:${NC}"
    echo "  vscode-setup [options]"
    echo ""
    echo -e "${CYAN}Options:${NC}"
    echo "  --project=NAME     Project name (for specific instructions)"
    echo "  --container=NAME   Container name (for specific instructions)"
    echo "  --guided           Show detailed explanations for beginners"
    echo "  -h, --help         Show this help message"
    echo ""
    echo -e "${CYAN}Description:${NC}"
    echo "  Provides VS Code Remote-SSH setup instructions and generates"
    echo "  SSH config snippets for connecting to the DS01 server."
    echo ""
    echo -e "${CYAN}Examples:${NC}"
    echo -e "  ${DIM}# General VS Code setup guide${NC}"
    echo "  vscode-setup"
    echo ""
    echo -e "  ${DIM}# With project-specific instructions${NC}"
    echo "  vscode-setup --project=my-thesis"
    echo ""
    echo -e "  ${DIM}# With guided explanations${NC}"
    echo "  vscode-setup --guided"
    echo ""
}

# Parse arguments
PROJECT_NAME=""
CONTAINER_NAME=""
GUIDED=false

while [[ $# -gt 0 ]]; do
    case $1 in
        --project=*)
            PROJECT_NAME="${1#*=}"
            shift
            ;;
        --container=*)
            CONTAINER_NAME="${1#*=}"
            shift
            ;;
        --guided)
            GUIDED=true
            shift
            ;;
        -h|--help|--info)
            usage
            exit 0
            ;;
        *)
            echo -e "${RED}âœ— Unknown option: $1${NC}\n"
            usage
            exit 1
            ;;
    esac
done

# Use skill level if set (from user-setup's skill assessment)
# DS01_SKILL_REMOTE: 0=beginner, 2=expert
if [[ "${DS01_SKILL_REMOTE:-}" == "0" ]]; then
    GUIDED=true
fi

# Get server IP
SERVER_IP=$(hostname -I | awk '{print $1}')

# Show guided introduction
if [ "$GUIDED" = true ]; then
    echo ""
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${BOLD}Connecting Your IDE (VS Code) To DS01${NC}"
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
    echo -e "${BOLD}We'll be using the 'Remote SSH' & 'Dev Containers' exentsions, among others${NC}"
    echo ""
    echo "  These let you:"
    echo "  â€¢ Edit files on the DS01 server from your local computer"
    echo "  â€¢ Use all VS Code features (debugging, IntelliSense, extensions)"
    echo "  â€¢ Access the server's GPUs and computing power"
    echo "  â€¢ Work as if the files were local"
    echo ""
    echo -e "${BOLD}How It Works:${NC}"
    echo ""
    echo "  1. VS Code on your computer connects via SSH"
    echo "  2. It installs a VS Code Server on DS01 (automatic)"
    echo "  3. You edit files, they're saved on the server"
    echo "  4. You can run terminals, debug code, use Jupyter"
    echo ""
    echo -e "${BOLD}Requirements:${NC}"
    echo ""
    echo -e "  â€¢ VS Code installed on your local computer"
    echo -e "  â€¢ SSH keys set up (run ${GREEN}ssh-setup${NC} if not done)"
    echo -e "  â€¢ SSH - Remote & Dev Containers extension installed in VS Code"
    echo ""
    read -r -t 0.1 -n 10000 discard </dev/tty 2>/dev/null || true
    read -p "Press Enter to see setup instructions..." </dev/tty
    echo ""
fi

echo ""
echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${BOLD}VS Code Remote-SSH Setup${NC}"
echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""

# Step 1: Extensions
echo -e "${YELLOW}${BOLD}Step 1: Install VS Code Extensions${NC}"
echo ""
echo "  Open VS Code and install these extensions:"
echo ""
echo -e "  ${BOLD}Required:${NC}"
echo -e "    â€¢ Remote - SSH ${DIM}(ms-vscode-remote.remote-ssh)${NC}"
echo -e "    â€¢ Remote - SSH: ${DIM}Editing Configuration Files (ms-vscode-remote.remote-ssh-edit)${NC}"
echo -e "    â€¢ Dev-Containers ${DIM}(ms-vscode-remote.remote-containers)${NC}"
echo ""
echo -e "  ${BOLD}Recommended:${NC}"
echo -e "    â€¢ Python ${DIM}(ms-python.python)${NC}"
echo -e "    â€¢ Jupyter ${DIM}(ms-toolsai.jupyter)${NC}"
echo -e "    â€¢ Docker ${DIM}(ms-azuretools.vscode-docker)${NC}"
echo -e "    â€¢ GitLens ${DIM}(eamodio.gitlens)${NC}"
echo ""

if [ "$GUIDED" = true ]; then
    echo -e "  ${DIM}You can install extensions via:${NC}"
    echo -e "    ${DIM}â€¢ VS Code: View â†’ Extensions (Ctrl+Shift+X)${NC}"
    echo -e "    ${DIM}â€¢ Search for extension name and click Install${NC}"
    echo ""
fi

read -r -t 0.1 -n 10000 discard </dev/tty 2>/dev/null || true
read -p "Press Enter when extensions are installed..." </dev/tty
echo ""

# Step 2: SSH Config
echo -e "${YELLOW}${BOLD}Step 2: Configure SSH Connection${NC}"
echo ""
echo "  In VS Code:"
echo -e "    ${CYAN}Command Palette${NC} (Ctrl+Shift+P / Cmd+Shift+P)"
echo -e "    â†’ Type: ${CYAN}\"Remote-SSH: Open SSH Configuration File\"${NC}"
echo -e "    â†’ Select your SSH config file (usually ${CYAN}~/.ssh/config${NC})"
echo ""
echo "  Add this configuration:"
echo ""
echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
cat << SSHCONFIG
Host ds01
    HostName $SERVER_IP
    User $USERNAME
    IdentityFile ~/.ssh/ds01_id_ed25519
    ForwardAgent yes
    ServerAliveInterval 60
    ServerAliveCountMax 3
SSHCONFIG
echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""

if [ "$GUIDED" = true ]; then
    echo -e "  ${BOLD}What do these settings mean?${NC}"
    echo ""
    echo -e "    ${CYAN}HostName${NC} - The server's IP address"
    echo -e "    ${CYAN}User${NC} - Your username on the server"
    echo -e "    ${CYAN}IdentityFile${NC} - Your private SSH key"
    echo -e "    ${CYAN}ForwardAgent${NC} - Allows using your local SSH keys on the server"
    echo -e "    ${CYAN}ServerAliveInterval${NC} - Keeps connection alive (sends ping every 60s)"
    echo ""
fi

read -r -t 0.1 -n 10000 discard </dev/tty 2>/dev/null || true
read -p "Press Enter when SSH config is saved..." </dev/tty
echo ""

# Step 3: Connect
echo -e "${YELLOW}${BOLD}Step 3: Connect to DS01${NC}"
echo ""
echo "  In VS Code:"
echo -e "    ${CYAN}Command Palette${NC} â†’ ${CYAN}\"Remote-SSH: Connect to Host\"${NC}"
echo -e "    â†’ Select: ${GREEN}ds01${NC}"
echo ""
echo "  The first connection will:"
echo "    â€¢ Install VS Code Server on DS01 (automatic, takes ~1 minute)"
echo "    â€¢ Open a new VS Code window connected to the server"
echo ""

if [ "$GUIDED" = true ]; then
    echo -e "  ${YELLOW}ğŸ’¡ Tip:${NC} Look at the bottom-left corner of VS Code."
    echo -e "     It should show: ${GREEN}SSH: ds01${NC}"
    echo ""
fi

read -r -t 0.1 -n 10000 discard </dev/tty 2>/dev/null || true
read -p "Press Enter after connecting..." </dev/tty
echo ""

# Step 4: Open Project
echo -e "${YELLOW}${BOLD}Step 4: Open Your Project in Terminal${NC}"
echo ""

if [ -n "$PROJECT_NAME" ]; then
    PROJECT_DIR="/home/$USERNAME/workspace/$PROJECT_NAME"
    echo "  In the connected VS Code window:"
    echo -e "    ${CYAN}File â†’ Open Folder${NC}"
    echo -e "    â†’ Navigate to: ${GREEN}$PROJECT_DIR${NC}"
    echo -e "    â†’ Click ${CYAN}OK${NC}"
    echo ""

    if [ "$GUIDED" = true ]; then
        echo -e "  ${BOLD}What happens now:${NC}"
        echo "    â€¢ VS Code opens your project folder"
        echo "    â€¢ You can edit files, create new ones"
        echo "    â€¢ All changes are saved on the server"
        echo "    â€¢ You can use the integrated terminal (Ctrl+\`)"
        echo ""
    fi
else
    echo "  In the connected VS Code window:"
    echo -e "    ${CYAN}File â†’ Open Folder${NC}"
    echo -e "    â†’ Navigate to: ${GREEN}$PROJECT_DIR${NC}"
    echo "    â†’ Select your project folder"
    echo ""
fi

# Step 5: Working in Container
echo ""
echo -e "${YELLOW}${BOLD}Step 5: Attach Your IDE to the Running Container ${NC}"
echo ""

if [ -n "$CONTAINER_NAME" ]; then
    echo "  ${BOLD}Option A: Using VS Code Terminal${NC}"
    echo "    1. Open terminal in VS Code (Ctrl+\` or Terminal â†’ New Terminal)"
    echo -e "    2. Enter container: ${GREEN}container-attach $CONTAINER_NAME${NC}"
    echo -e "    3. Navigate to: ${GREEN}$PROJECT_DIR${NC}"
    echo "    4. Start coding!"
    echo ""
    echo "  ${BOLD}Option B: Using Dev Containers Extension (Advanced)${NC}"
    echo "    1. Install 'Dev Containers' extension in VS Code"
    echo -e "    2. Command Palette â†’ ${CYAN}\"Dev Containers: Attach to Running Container\"${NC}"
    echo -e "    3. Select container: ${GREEN}${USERNAME}._.$USER_ID${NC}"
    echo "    4. Entire VS Code session runs inside the container"
    echo ""
else
    echo -e "  ${BOLD}Option A: Using VS Code Terminal${NC}"
    echo -e "    1. Open terminal in VS Code (Ctrl+\` or Terminal â†’ New Terminal)"
    echo -e "    2. Enter container: ${GREEN}container-attach <container_name>${NC}"
    echo -e "    3. Navigate: ${GREEN}cd /workspace/$PROJECT_NAME${NC}"
    echo "    4. Start coding!"
    echo ""
    echo -e "  ${BOLD}Option B: Using Dev Containers Extension ${GREEN}(Recommended!)${NC}"
    echo -e "  ${DIM}(If you have the 'Dev Containers' extension in VS Code${NC})"
    echo -e "    1. Command Palette â†’ ${CYAN}\"Dev Containers: Attach to Running Container\"${NC}"
    echo -e "    2. Select: ${GREEN}${CONTAINER_NAME}._.$USER_ID${NC}"
    echo "    3. Entire VS Code session runs inside the container"
    echo ""
    echo -e "  ${YELLOW}ğŸ’¡ Tip:${NC} Even easier, just use the 'Dev Containers' GUI directly (LHS)"
fi

# Summary
echo ""
echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${GREEN}${BOLD}âœ“ VS Code Setup Complete!${NC}"
echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""

echo -e "${BOLD}Quick Reference:${NC}"
echo ""
echo -e "  ${CYAN}Connect:${NC}       Command Palette â†’ Remote-SSH: Connect to Host â†’ ds01"
echo -e "  ${CYAN}Disconnect:${NC}    Command Palette â†’ Remote-SSH: Close Remote Connection"
echo -e "  ${CYAN}Terminal:${NC}      Ctrl+\` (or Terminal â†’ New Terminal)"
if [ -n "$PROJECT_NAME" ]; then
    echo -e "  ${CYAN}Project:${NC}       /home/$USERNAME/workspace/$PROJECT_NAME"
fi
if [ -n "$CONTAINER_NAME" ]; then
    echo -e "  ${CYAN}Container:${NC}     container attach $CONTAINER_NAME"
fi
echo ""

# Create setup summary file
SUMMARY_FILE="$HOME/ds01-config/vscode-setup-summary.txt"
mkdir -p "$HOME/ds01-config"

cat > "$SUMMARY_FILE" << SUMMARYEOF
DS01 VS Code Setup Summary
==========================
Date: $(date)
User: $USERNAME
Server: $SERVER_IP

SSH Configuration:
-----------------
Host ds01
    HostName $SERVER_IP
    User $USERNAME
    IdentityFile ~/.ssh/ds01_id_ed25519
    ForwardAgent yes
    ServerAliveInterval 60

VS Code Extensions:
------------------
- Remote - SSH (required)
- Remote - SSH: Editing Configuration Files (required)
- Dev-Containers (required)
- Python (recommended)
- Jupyter (recommended)
- Docker (recommended)
- GitLens (recommended)

Connection Steps:
----------------
1. Open VS Code
2. Command Palette â†’ "Remote-SSH: Connect to Host"
3. Select "ds01"
4. (Optional) Open your project folder:
   File â†’ Open Folder â†’ /home/$USERNAME/workspace/$PROJECT_NAME
5. Enter your container:
    a) Open terminal â†’ container attach $CONTAINER_NAME
    b) (Recommended) Use Dev Containers extension to attach to container
    Command Palette â†’ "Dev Containers: Attach to Running Container"

$([ -n "$PROJECT_NAME" ] && echo "Project Information:
-------------------
Name: $PROJECT_NAME
Location: /home/$USERNAME/workspace/$PROJECT_NAME")

$([ -n "$CONTAINER_NAME" ] && echo "Container Information:
---------------------
Name: $CONTAINER_NAME
Enter: container attach $CONTAINER_NAME")

Quick Commands:
--------------
SSH:
  ssh ds01                           # Connect via terminal

VS Code:
  Remote-SSH: Connect to Host        # Connect to DS01
  Remote-SSH: Close Remote Connection  # Disconnect
  Dev Containers: Attach to Running Container  # Open VS Code in container

Container Management:
  container deploy <name>            # Create and start container
  container attach <name>            # Enter a running container
  container retire <name>            # Stop and remove container
  container-list                     # List your containers
  check-limits                       # View your resource quotas

Inside Container:
----------------
cd /workspace/<project>              # Navigate to project
nvidia-smi                           # Check GPU status
jupyter lab                          # Start Jupyter Lab
python train.py                      # Run training scripts

SUMMARYEOF

echo -e "A summary of all of this was saved to: ${BLUE}$SUMMARY_FILE${NC} for easy reference"
echo ""
