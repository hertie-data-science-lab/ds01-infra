#!/bin/bash
# DS01 Container Deploy - Tier 3 Orchestrator
# Streamlined workflow: Create container â†’ Start/Run container (single command)
# Combines container-create + container-start/run with unified messaging

set -e

# Export orchestrator flag to suppress Tier 2 "Next steps" output
export DS01_ORCHESTRATOR=deploy

# Colors
BLUE='\033[94m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
CYAN='\033[0;36m'
BOLD='\033[1m'
DIM='\033[2m'
NC='\033[0m'

USERNAME=$(whoami)
USER_ID=$(id -u)

# Script paths
SCRIPT_DIR="$(cd "$(dirname "$(readlink -f "${BASH_SOURCE[0]}")")" && pwd)"
INFRA_ROOT="$(dirname "$(dirname "$SCRIPT_DIR")")"
CONTAINER_CREATE="$SCRIPT_DIR/container-create"
CONTAINER_START="$SCRIPT_DIR/container-start"
CONTAINER_RUN="$SCRIPT_DIR/container-run"

usage() {
    echo ""
    echo -e "${BOLD}DS01 Container Deploy${NC}"
    echo -e "${DIM}Tier 3 Orchestrator - Creates and starts containers in one command${NC}"
    echo ""
    echo -e "${CYAN}Usage:${NC}"
    echo "  container-deploy [name] [image] [options]"
    echo "  container-deploy                  # Interactive wizard"
    echo ""
    echo -e "${CYAN}Arguments:${NC}"
    echo "  name              Container name (optional - wizard starts if omitted)"
    echo "  image             Docker image or framework (pytorch, tensorflow)"
    echo ""
    echo -e "${CYAN}Options:${NC}"
    echo "  --guided          Show detailed explanations for beginners"
    echo "  --cpu-only        Create CPU-only container (no GPU)"
    echo "  -w, --workspace   Workspace directory (default: ~/workspace/<name>)"
    echo "  -d, --data        Additional data directory to mount"
    echo "  --background      Start in background (don't open terminal)"
    echo "  --open            Start and open terminal immediately"
    echo "  --dry-run         Show what would be created"
    echo "  -h, --help        Show this help message"
    echo ""
    echo -e "${CYAN}What this does:${NC}"
    echo "  1. Creates container (via container-create)"
    echo "  2. Prompts: Start in background or open terminal?"
    echo "  3. Starts container (via container-start or container-run)"
    echo ""
    echo -e "${CYAN}Examples:${NC}"
    echo -e "  ${DIM}# Interactive mode (recommended)${NC}"
    echo "  container-deploy"
    echo ""
    echo -e "  ${DIM}# Quick deploy with PyTorch${NC}"
    echo "  container-deploy my-project"
    echo ""
    echo -e "  ${DIM}# Deploy from custom image and open terminal${NC}"
    echo "  container-deploy my-project my-project-image --open"
    echo ""
    echo -e "  ${DIM}# Deploy in background for SSH access${NC}"
    echo "  container-deploy my-project --background"
    echo ""
    echo -e "  ${DIM}# Guided mode for beginners${NC}"
    echo "  container-deploy --guided"
    echo ""
    echo -e "${CYAN}Alternative (Tier 2 commands):${NC}"
    echo "  If you prefer step-by-step control:"
    echo -e "  1. ${GREEN}container-create <name>${NC}   # Create container"
    echo -e "  2. ${GREEN}container-run <name>${NC}      # Start and enter"
    echo ""
}

# Parse arguments
CREATE_ARGS=()
START_MODE=""  # "background", "open", or "" (prompt)
CONTAINER_NAME=""
GUIDED=false

while [[ $# -gt 0 ]]; do
    case $1 in
        --background)
            START_MODE="background"
            shift
            ;;
        --open)
            START_MODE="open"
            shift
            ;;
        --guided)
            GUIDED=true
            CREATE_ARGS+=("$1")
            shift
            ;;
        -h|--help|--info)
            usage
            exit 0
            ;;
        *)
            # Pass all other args to container-create
            CREATE_ARGS+=("$1")
            # Capture container name (first positional arg that's not a flag)
            if [[ ! "$1" =~ ^- ]] && [ -z "$CONTAINER_NAME" ]; then
                CONTAINER_NAME="$1"
            fi
            shift
            ;;
    esac
done

echo ""
echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${BOLD}DS01 Container Deploy${NC}"
echo -e "${DIM}Ephemeral containers w/ persistent workspaces${NC}"
echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""

if [ "$GUIDED" = true ]; then
    echo -e "${CYAN}â„¹ ${NC}${BOLD}What is 'deploy'?${NC}"
    echo ""
    echo "Deploy is a streamlined workflow that:"
    echo "  1. Creates a new container from an image"
    echo "  2. Starts the container (background or with terminal)"
    echo ""
    echo "This combines two Tier 2 commands:"
    echo -e "  ${DIM}container-create + container-start/run${NC}"
    echo ""
    echo "But with unified output referencing only Tier 3 workflows."
    echo ""
    read -p "Press Enter to continue..." </dev/tty
    echo ""
fi

# Step 1: Create container
echo -e "${BOLD}Step 1/2: Creating Container${NC}"
echo ""

# Use a temp file to communicate container name from container-create (for "use existing" case)
CONTAINER_NAME_FILE="/tmp/ds01-deploy-container-$$"
export DS01_CONTAINER_NAME_FILE="$CONTAINER_NAME_FILE"

# Run container-create normally (NOT capturing output - breaks interactive prompts)
if ! "$CONTAINER_CREATE" "${CREATE_ARGS[@]}"; then
    rm -f "$CONTAINER_NAME_FILE"
    echo ""
    echo -e "${RED}âœ— Container creation failed${NC}"
    exit 1
fi

# Check if container-create wrote the container name to the temp file
if [ -f "$CONTAINER_NAME_FILE" ]; then
    CONTAINER_NAME=$(cat "$CONTAINER_NAME_FILE")
    rm -f "$CONTAINER_NAME_FILE"
fi

# Extract container name if we don't have it yet
# Strategy: Get most recently created container for this user
if [ -z "$CONTAINER_NAME" ]; then
    # Get most recently created container (by creation time)
    CONTAINER_TAG=$(docker ps -a --filter "name=._.$USER_ID" --format "{{.CreatedAt}}\t{{.Names}}" | sort -r | head -1 | cut -f2)

    if [ -n "$CONTAINER_TAG" ]; then
        # Strip the ._.USER_ID suffix to get the container name
        CONTAINER_NAME="${CONTAINER_TAG%._.${USER_ID}}"
    else
        echo ""
        echo -e "${RED}âœ— Could not determine container name${NC}"
        echo ""
        echo "Please run again with explicit name:"
        echo -e "  ${GREEN}container-deploy <name>${NC}"
        echo ""
        exit 1
    fi
fi

echo ""
echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${BOLD}Step 2/2: Starting Container${NC}"
echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""

# If start mode not specified, prompt
if [ -z "$START_MODE" ]; then
    if [ "$GUIDED" = true ]; then
        echo -e "${CYAN}â„¹ ${NC}${BOLD}How to start the container?${NC}"
        echo ""
        echo "You have two options:"
        echo ""
    fi

    echo -e "${BOLD}How would you like to start the container?${NC}"
    echo ""
    echo -e "  ${BOLD}1)${NC} ${GREEN}Start in background${NC}"
    echo -e "     ${DIM}Container runs in background, access via SSH/IDE${NC}"
    echo -e "     ${DIM}Uses: container-start${NC}"
    echo ""
    echo -e "  ${BOLD}2)${NC} ${GREEN}Start and open terminal${NC} (recommended)"
    echo -e "     ${DIM}Opens interactive shell inside container${NC}"
    echo -e "     ${DIM}Uses: container-run${NC}"
    echo ""
    read -p "Choice [1-2, default: 2]: " CHOICE </dev/tty
    CHOICE=${CHOICE:-2}

    case $CHOICE in
        1)
            START_MODE="background"
            ;;
        2|*)
            START_MODE="open"
            ;;
    esac
    echo ""
fi

# Step 2: Start container
case $START_MODE in
    background)
        echo -e "${CYAN}Starting container in background...${NC}"
        echo ""

        # Pass --guided if set
        START_ARGS=()
        if [ "$GUIDED" = true ]; then
            START_ARGS+=("--guided")
        fi

        if "$CONTAINER_START" "$CONTAINER_NAME" "${START_ARGS[@]}"; then
            echo ""
            echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
            echo -e "${GREEN}${BOLD}âœ“ Container Deployed Successfully!${NC}"
            echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
            echo ""

            if [ "$GUIDED" = true ]; then
                echo -e "${BOLD}What Just Happened?${NC}"
                echo ""
                echo "  âœ“ Container created with resources allocated"
                echo "  âœ“ Container started in background"
                echo "  âœ“ Ready for SSH/IDE access"
                echo ""
                echo -e "${BOLD}Next Steps:${NC}"
                echo ""
                echo -e "  ${BOLD}Enter the container:${NC}"
                echo -e "     ${GREEN}container-deploy $CONTAINER_NAME${NC}"
                echo "     (Or use the 'open' option next time)"
                echo ""
                echo -e "  ${BOLD}Check status:${NC}"
                echo -e "     ${GREEN}container-list${NC}"
                echo ""
                echo -e "  ${BOLD}When done:${NC}"
                echo -e "     ${GREEN}container-retire $CONTAINER_NAME${NC}"
                echo "     (Stops and removes container, frees GPU)"
                echo ""
            else
                echo -e "${BOLD}Next steps:${NC}"
                echo -e "  â€¢ Access container: ${GREEN}container-deploy $CONTAINER_NAME --open${NC}"
                echo -e "  â€¢ Check status:     ${GREEN}container-list${NC}"
                echo -e "  â€¢ View stats:       ${GREEN}container-stats${NC}"
                echo ""
                echo -e "${YELLOW}ğŸ’¡ When done:${NC} ${GREEN}container-retire $CONTAINER_NAME${NC} ${DIM}(cleanup)${NC}"
                echo ""
            fi
        else
            echo ""
            echo -e "${RED}âœ— Container start failed${NC}"
            exit 1
        fi
        ;;
    open)
        echo -e "${CYAN}Starting container and opening terminal...${NC}"
        echo ""

        # Pass --guided if set
        RUN_ARGS=()
        if [ "$GUIDED" = true ]; then
            RUN_ARGS+=("--guided")
        fi

        # container-run will exec into the container (this script won't return until user exits)
        "$CONTAINER_RUN" "$CONTAINER_NAME" "${RUN_ARGS[@]}"
        EXIT_CODE=$?

        # Post-exit messaging (Tier 3 specific - only references deploy/retire)
        echo ""
        echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
        echo -e "${YELLOW}${BOLD}You've Exited the Container${NC}"
        echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
        echo ""

        if [ "$GUIDED" = true ]; then
            echo -e "${BOLD}What Just Happened?${NC}"
            echo ""
            echo "  â€¢ Your bash session inside the container ended"
            echo -e "  â€¢ The container is ${GREEN}still running${NC} in the background"
            echo -e "  â€¢ All your files in /workspace are ${BOLD}safe${NC}"
            echo "  â€¢ GPU is still allocated to this container"
            echo ""
            echo -e "${BOLD}What You Can Do Now:${NC}"
            echo ""
            echo -e "  ${BOLD}1) Re-enter the Container${NC}"
            echo -e "     ${GREEN}container-deploy $CONTAINER_NAME --open${NC}"
            echo "     Continue working where you left off"
            echo ""
            echo -e "  ${BOLD}2) Retire the Container (Cleanup)${NC}"
            echo -e "     ${GREEN}container-retire $CONTAINER_NAME${NC}"
            echo "     Stops container and frees GPU immediately"
            echo -e "     ${BOLD}Do this when you're done!${NC} Be a good citizen."
            echo ""
            echo -e "  ${BOLD}3) Check Status${NC}"
            echo -e "     ${GREEN}container-list${NC}      View all containers"
            echo ""
            echo -e "${YELLOW}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
            echo -e "${BOLD}Important Reminders:${NC}"
            echo ""
            echo -e "  â€¢ ${GREEN}Your files are ALWAYS safe${NC} in ~/workspace/$CONTAINER_NAME"
            echo "  â€¢ Container keeps running until you retire it or it hits timeout"
            echo -e "  â€¢ Use ${GREEN}container-retire${NC} when done to free GPU for others"
            echo ""
        else
            echo -e "${DIM}Container still running in background${NC}"
            echo ""
            echo -e "${BOLD}Quick actions:${NC}"
            echo -e "  â€¢ Re-enter:  ${GREEN}container-deploy $CONTAINER_NAME --open${NC}"
            echo -e "  â€¢ Cleanup:   ${GREEN}container-retire $CONTAINER_NAME${NC} ${DIM}(stop + remove, frees GPU)${NC}"
            echo -e "  â€¢ Status:    ${GREEN}container-list${NC}"
            echo ""
        fi

        exit $EXIT_CODE
        ;;
esac
