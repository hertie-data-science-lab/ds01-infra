#!/bin/bash
# DS01 Container Deploy - L3 Orchestrator
# Streamlined workflow: Create container â†’ Start/Run container (single command)
# Combines container-create + container-start/run with unified messaging

set -e

# Source DS01 context library
if [[ -f "/opt/ds01-infra/scripts/lib/ds01-context.sh" ]]; then
    source /opt/ds01-infra/scripts/lib/ds01-context.sh
fi

# Set orchestration context - suppresses atomic command "Next steps" output
export DS01_CONTEXT="orchestration"
export DS01_INTERFACE="orchestration"

# Legacy compatibility
export DS01_ORCHESTRATOR=deploy

# Colors
BLUE='\033[94m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
CYAN='\033[0;36m'
BOLD='\033[1m'
DIM='\033[2m'
NC='\033[0m'

USERNAME=$(whoami)
USER_ID=$(id -u)

# Script paths
SCRIPT_DIR="/opt/ds01-infra/scripts/user"
INFRA_ROOT="/opt/ds01-infra"
CONTAINER_CREATE="$SCRIPT_DIR/container-create"
CONTAINER_START="$SCRIPT_DIR/container-start"
CONTAINER_RUN="$SCRIPT_DIR/container-run"

usage() {
    echo ""
    echo -e "${BOLD}DS01 Container Deploy${NC}"
    echo -e "${DIM}L3 Orchestrator - Creates and starts containers in one command${NC}"
    echo ""
    echo -e "${CYAN}Usage:${NC}"
    echo "  container-deploy [name] [image] [options]"
    echo "  container-deploy                  # Interactive wizard"
    echo ""
    echo -e "${CYAN}Arguments:${NC}"
    echo "  name              Container name (optional - wizard starts if omitted)"
    echo "  image             Docker image or framework (pytorch, tensorflow)"
    echo ""
    echo -e "${CYAN}Options:${NC}"
    echo "  --guided          Show detailed explanations for beginners"
    echo "  --cpu-only        Create CPU-only container (no GPU)"
    echo "  -w, --workspace   Workspace directory (default: ~/workspace/<name>)"
    echo "  -d, --data        Additional data directory to mount"
    echo "  --background      Start in background (don't open terminal)"
    echo "  --open            Start and open terminal immediately"
    echo "  --dry-run         Show what would be created"
    echo "  -h, --help        Show this help message"
    echo ""
    echo -e "${CYAN}What this does:${NC}"
    echo "  1. Creates container (via container-create)"
    echo "  2. Prompts: Start in background or open terminal?"
    echo "  3. Starts container (via container-start or container-run)"
    echo ""
    echo -e "${CYAN}Examples:${NC}"
    echo -e "  ${DIM}# Interactive mode (recommended)${NC}"
    echo "  container-deploy"
    echo ""
    echo -e "  ${DIM}# Quick deploy with PyTorch${NC}"
    echo "  container-deploy my-project"
    echo ""
    echo -e "  ${DIM}# Deploy from custom image and open terminal${NC}"
    echo "  container-deploy my-project my-project-image && container-attach my-project"
    echo ""
    echo -e "  ${DIM}# Deploy in background for SSH access${NC}"
    echo "  container-deploy my-project --background"
    echo ""
    echo -e "  ${DIM}# Guided mode for beginners${NC}"
    echo "  container-deploy --guided"
    echo ""
    echo -e "${CYAN}Advanced (L2 Atomic commands):${NC}"
    echo "  For granular control over container lifecycle:"
    echo -e "  1. ${GREEN}container-create <name>${NC}   # Create container"
    echo -e "  2. ${GREEN}container-run <name>${NC}      # Start and enter"
    echo -e "  ${DIM}See: help --atomic${NC}"
    echo ""
    echo -e "${DIM}Run 'help' or 'commands' anytime to see available commands.${NC}"
    echo ""
}

# Parse arguments
CREATE_ARGS=()
START_MODE=""  # "background", "open", or "" (prompt)
CONTAINER_NAME=""
GUIDED=false

while [[ $# -gt 0 ]]; do
    case $1 in
        --background)
            START_MODE="background"
            shift
            ;;
        --open)
            START_MODE="open"
            shift
            ;;
        --guided)
            GUIDED=true
            CREATE_ARGS+=("$1")
            shift
            ;;
        -h|--help|--info)
            usage
            exit 0
            ;;
        *)
            # Pass all other args to container-create
            CREATE_ARGS+=("$1")
            # Capture container name (first positional arg that's not a flag)
            if [[ ! "$1" =~ ^- ]] && [ -z "$CONTAINER_NAME" ]; then
                CONTAINER_NAME="$1"
            fi
            shift
            ;;
    esac
done

echo ""
echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${BOLD}DS01 Container Deploy${NC}"
echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""

if [ "$GUIDED" = true ]; then
    echo -e "${CYAN}â„¹ ${NC}${BOLD}What is 'deploy'?${NC}"
    echo ""
    echo "Deploy is a streamlined workflow that:"
    echo "  1. Creates a new container from an image"
    echo "  2. Starts the container (background or with terminal)"
    echo ""
    read -p "Press Enter to continue..." </dev/tty
    echo ""
fi

# Step 1: Create container
echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${BOLD}Step 1/2: Creating Container${NC}"
echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e ""

# Use a temp file to communicate container name from container-create (for "use existing" case)
CONTAINER_NAME_FILE="/tmp/ds01-deploy-container-$$"
export DS01_CONTAINER_NAME_FILE="$CONTAINER_NAME_FILE"

# Run container-create normally (NOT capturing output - breaks interactive prompts)
if ! "$CONTAINER_CREATE" "${CREATE_ARGS[@]}"; then
    rm -f "$CONTAINER_NAME_FILE"
    echo ""
    echo -e "${RED}âœ— Container creation failed${NC}"
    exit 1
fi

# Check if container-create wrote the container name to the temp file
if [ -f "$CONTAINER_NAME_FILE" ]; then
    CONTAINER_NAME=$(cat "$CONTAINER_NAME_FILE")
    rm -f "$CONTAINER_NAME_FILE"
fi

# Extract container name if we don't have it yet
# Strategy: Get most recently created container for this user
if [ -z "$CONTAINER_NAME" ]; then
    # Get most recently created container (by creation time)
    CONTAINER_TAG=$(docker ps -a --filter "name=._.$USER_ID" --format "{{.CreatedAt}}\t{{.Names}}" | sort -r | head -1 | cut -f2)

    if [ -n "$CONTAINER_TAG" ]; then
        # Strip the ._.USER_ID suffix to get the container name
        CONTAINER_NAME="${CONTAINER_TAG%._.${USER_ID}}"
    else
        echo ""
        echo -e "${RED}âœ— Could not determine container name${NC}"
        echo ""
        echo "Please run again with explicit name:"
        echo -e "  ${GREEN}container-deploy <name>${NC}"
        echo ""
        exit 1
    fi
fi

echo ""
echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${BOLD}Step 2/2: Starting Container${NC}"
echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""

# If start mode not specified, prompt
if [ -z "$START_MODE" ]; then
    # Require explicit flag in non-interactive mode
    if [ ! -t 0 ] || [ ! -t 1 ]; then
        echo -e "${RED}Error: Non-interactive mode requires --background or --open flag${NC}"
        echo ""
        echo "Usage:"
        echo "  container-deploy my-project --background  # Start in background"
        echo "  container-deploy my-project --open        # Start and attach immediately"
        exit 1
    fi

    if [ "$GUIDED" = true ]; then
        echo -e "${CYAN}â„¹ ${NC}${BOLD}How to start the container?${NC}"
        echo ""
        echo "You have two options:"
        echo ""
    fi

    echo -e "${BOLD}How would you like to start the container?${NC}"
    echo ""
    echo -e "  ${BOLD}1)${NC} ${GREEN}Start in background${NC}"
    echo -e "     ${DIM}Container runs in background, access via SSH/IDE${NC}"
    echo -e "     ${DIM}Uses: container-start${NC}"
    echo ""
    echo -e "  ${BOLD}2)${NC} ${GREEN}Start and open terminal${NC} (recommended)"
    echo -e "     ${DIM}Opens interactive shell inside container${NC}"
    echo -e "     ${DIM}Uses: container-run${NC}"
    echo ""
    read -p "Choice [1-2, default: 2]: " CHOICE </dev/tty
    CHOICE=${CHOICE:-2}

    case $CHOICE in
        1)
            START_MODE="background"
            ;;
        2|*)
            START_MODE="open"
            ;;
    esac
    echo ""
fi

# Step 2: Start container
case $START_MODE in
    background)
        echo -e "${CYAN}Starting container in background...${NC}"
        echo ""

        # Pass --guided if set
        START_ARGS=()
        if [ "$GUIDED" = true ]; then
            START_ARGS+=("--guided")
        fi

        if "$CONTAINER_START" "$CONTAINER_NAME" "${START_ARGS[@]}"; then
            echo ""
            echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
            echo -e "${GREEN}${BOLD}âœ“ Container Deployed Successfully!${NC}"
            echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
            echo ""

            if [ "$GUIDED" = true ]; then
                echo -e "${BOLD}What Just Happened?${NC}"
                echo ""
                echo "  âœ“ Container created with resources allocated"
                echo "  âœ“ Container started in background"
                echo "  âœ“ Ready for SSH/IDE access"
                echo ""

                echo -e "${CYAN}â”â”â” Attaching Your IDE â”â”â”${NC}"
                echo ""
                echo "Your container is now running. Here's how to connect VS Code:"
                echo ""
                echo -e "${BOLD}Option A: Using Terminal${NC}"
                echo -e "  1. Run: ${GREEN}container-attach $CONTAINER_NAME${NC}"
                echo "  2. Navigate: cd /workspace"
                echo "  3. Start coding!"
                echo ""
                echo -e "${BOLD}Option B: Using Dev Containers ${GREEN}(Recommended)${NC}"
                echo "  1. Command Palette â†’ \"Dev Containers: Attach to Running Container\""
                echo "  2. Select your container"
                echo "  3. VS Code reopens inside the container"
                echo ""
                echo -e "${YELLOW}Tip:${NC} The Dev Containers sidebar (left) shows all running containers"
                echo ""
                echo -e "${BOLD}When done:${NC}"
                echo -e "  ${GREEN}container-retire $CONTAINER_NAME${NC}"
                echo "  (Stops and removes container, frees GPU)"
                echo ""
            else
                echo -e "${BOLD}Next steps:${NC}"
                echo -e "  â€¢ Attach to container: ${GREEN}container-attach $CONTAINER_NAME${NC}"
                echo -e "  â€¢ Check status:     ${GREEN}container-list${NC}"
                echo -e "  â€¢ View stats:       ${GREEN}container-stats${NC}"
                echo ""
                echo -e "${YELLOW}ğŸ’¡ When done:${NC} ${GREEN}container-retire $CONTAINER_NAME${NC} ${DIM}(cleanup)${NC}"
                echo ""
            fi
        else
            echo ""
            echo -e "${RED}âœ— Container start failed${NC}"
            exit 1
        fi
        ;;
    open)
        echo -e "${CYAN}Starting container and opening terminal...${NC}"
        echo ""

        # Pass --guided if set
        RUN_ARGS=()
        if [ "$GUIDED" = true ]; then
            RUN_ARGS+=("--guided")
        fi

        # container-run will exec into the container (this script won't return until user exits)
        # Capture exit code without letting set -e terminate the script
        EXIT_CODE=0
        "$CONTAINER_RUN" "$CONTAINER_NAME" "${RUN_ARGS[@]}" || EXIT_CODE=$?

        # Post-exit messaging with interactive prompt
        echo ""
        echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
        echo -e "${BOLD}Container Session Ended${NC}"
        echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
        echo ""

        # Get container status
        CONTAINER_TAG="${CONTAINER_NAME}._.${USER_ID}"
        CONTAINER_STATUS=$(docker inspect -f '{{.State.Status}}' "$CONTAINER_TAG" 2>/dev/null || echo "missing")

        if [ "$CONTAINER_STATUS" = "running" ]; then
            echo -e "${GREEN}âœ“${NC} Container is still running with resources allocated"
            echo ""

            # Get user's lifecycle limits
            RESOURCE_PARSER="$INFRA_ROOT/scripts/docker/get_resource_limits.py"
            if [ -f "$RESOURCE_PARSER" ]; then
                idle_timeout=$(python3 "$RESOURCE_PARSER" "$USERNAME" --idle-timeout 2>/dev/null || echo "None")
                max_runtime=$(python3 "$RESOURCE_PARSER" "$USERNAME" --max-runtime 2>/dev/null || echo "None")
            else
                idle_timeout="None"
                max_runtime="None"
            fi

            # Flush any leftover stdin from container session
            read -t 0.1 -n 10000 discard </dev/tty 2>/dev/null || true

            echo -e "${BOLD}What would you like to do?${NC}"
            echo ""
            echo -e "${CYAN}1)${NC} ${BOLD}Keep running${NC} (exit session, container stays active)"
            echo "   â€¢ You can reconnect anytime"
            echo "   â€¢ GPU remains allocated to this container"
            if [ "$idle_timeout" != "None" ] && [ "$idle_timeout" != "null" ]; then
                echo -e "   â€¢ Will auto-stop after ${CYAN}$idle_timeout${NC} of GPU inactivity"
            fi
            if [ "$max_runtime" != "None" ] && [ "$max_runtime" != "null" ]; then
                echo -e "   â€¢ Max runtime: ${CYAN}$max_runtime${NC}"
            fi
            echo ""
            echo -e "${CYAN}2)${NC} ${BOLD}Retire container${NC} (stop + remove, free GPU immediately)"
            echo "   â€¢ Removes container instance"
            echo "   â€¢ GPU freed immediately for others"
            echo "   â€¢ Workspace files remain safe"
            echo -e "   â€¢ Can recreate anytime with: ${GREEN}container-deploy $CONTAINER_NAME${NC}"
            echo ""

            # Show guided explanation before prompt (if guided mode)
            if [ "$GUIDED" = true ]; then
                echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
                echo -e "${BOLD}Understanding Your Options${NC}"
                echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
                echo ""
                echo -e "${BOLD}Option 1: Keep Running${NC}"
                echo "  â€¢ Container stays active in the background"
                echo "  â€¢ All processes, environments, and data preserved"
                echo "  â€¢ GPU remains allocated to you (other users cannot use it)"
                echo "  â€¢ You can reconnect anytime with same state"
                echo "  â€¢ Container will auto-retire at max runtime limit"
                echo ""
                echo -e "${BOLD}Option 2: Retire Container${NC}"
                echo "  â€¢ Stops all processes and removes container instance"
                echo "  â€¢ GPU freed immediately for other users"
                echo "  â€¢ Workspace files remain 100% safe"
                echo "  â€¢ Can recreate container from image anytime"
                echo "  â€¢ Be a good citizen - frees resources quickly!"
                echo ""
                echo -e "${YELLOW}ğŸ’¡ Think of it like:${NC}"
                echo "  Keep running = leave laptop on but close the lid"
                echo "  Retire = shut down laptop (files still on disk)"
                echo ""
                read -p "Press Enter to choose..." </dev/tty
                echo ""
            fi

            # Prompt with default to Keep running (safest - prevents accidental removal)
            read -p "Choose [1=keep, 2=retire] (default: 1): " CHOICE </dev/tty
            echo ""

            # Default to keep running if empty input
            CHOICE=${CHOICE:-1}

            case "$CHOICE" in
                1)
                    echo -e "${GREEN}âœ“${NC} Container kept running"
                    echo ""

                    if [ "$GUIDED" = true ]; then
                        echo -e "${CYAN}â”â”â” Reconnecting to Your Container â”â”â”${NC}"
                        echo ""
                        echo -e "${BOLD}Option A: Using Terminal${NC}"
                        echo -e "  ${GREEN}container-attach $CONTAINER_NAME${NC}"
                        echo ""
                        echo -e "${BOLD}Option B: Using Dev Containers (Recommended)${NC}"
                        echo "  1. Command Palette â†’ \"Dev Containers: Attach to Running Container\""
                        echo "  2. Select your container"
                        echo ""
                    else
                        echo -e "${BOLD}Next steps:${NC}"
                        echo -e "  Reconnect: ${GREEN}container-attach $CONTAINER_NAME${NC}"
                        echo -e "  Status:    ${GREEN}container-list${NC}"
                        echo ""
                    fi

                    if [ "$max_runtime" != "None" ] && [ "$max_runtime" != "null" ]; then
                        echo -e "${CYAN}â„¹${NC} ${DIM}Container will auto-retire at max runtime (${max_runtime})${NC}"
                        echo ""
                    fi
                    echo -e "${YELLOW}ğŸ’¡ Tip:${NC} When completely done, ${GREEN}container-retire $CONTAINER_NAME${NC}"
                    echo "   (frees GPU for others)"
                    echo ""
                    ;;
                2)
                    echo -e "${YELLOW}Retiring container...${NC}"
                    echo ""

                    # Clean up keep-alive before retiring
                    docker exec "$CONTAINER_TAG" pkill -f "\[ds01-keep-alive\]" 2>/dev/null || true

                    # Call container-retire with --skip-initial-confirm
                    # (user already confirmed by choosing option 2, but they should still
                    # get the save-packages and image-deletion prompts)
                    CONTAINER_RETIRE="$SCRIPT_DIR/container-retire"
                    if [ -f "$CONTAINER_RETIRE" ]; then
                        bash "$CONTAINER_RETIRE" "$CONTAINER_NAME" --skip-initial-confirm
                    else
                        echo -e "${RED}âœ—${NC} container-retire not found"
                        echo -e "Manual cleanup: ${GREEN}container-retire $CONTAINER_NAME${NC}"
                    fi
                    ;;
                *)
                    echo -e "${YELLOW}Invalid choice. Keeping container running (default).${NC}"
                    echo ""
                    echo -e "To retire later: ${GREEN}container-retire $CONTAINER_NAME${NC}"
                    echo ""
                    ;;
            esac
        else
            # Container stopped (shouldn't happen with keep-alive)
            echo -e "${YELLOW}âš ${NC} Container was stopped unexpectedly"
            echo ""
            echo -e "${BOLD}Retiring container to avoid ambiguous stopped state...${NC}"
            echo ""

            # Auto-retire to follow "running or removed" principle
            # Use --skip-initial-confirm for consistent prompts (save packages, image deletion)
            CONTAINER_RETIRE="$SCRIPT_DIR/container-retire"
            if [ -f "$CONTAINER_RETIRE" ]; then
                bash "$CONTAINER_RETIRE" "$CONTAINER_NAME" --skip-initial-confirm
            fi
        fi

        exit $EXIT_CODE
        ;;
esac
