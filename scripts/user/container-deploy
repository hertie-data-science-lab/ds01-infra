#!/bin/bash
# DS01 Container Deploy - Tier 3 Orchestrator
# Streamlined workflow: Create container â†’ Run container (single command)
# Tier 3 Command - Orchestrates container-create and container-run

set -e

# Export orchestrator flag to suppress Tier 2 "Next steps" output
export DS01_ORCHESTRATOR=deploy

# Colors
BLUE='\033[94m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
CYAN='\033[0;36m'
BOLD='\033[1m'
DIM='\033[2m'
NC='\033[0m'

USERNAME=$(whoami)
USER_ID=$(id -u)

# Script paths - resolve symlinks to get real path
SCRIPT_PATH="${BASH_SOURCE[0]}"
if [ -L "$SCRIPT_PATH" ]; then
    SCRIPT_PATH="$(readlink -f "$SCRIPT_PATH")"
fi
SCRIPT_DIR="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)"
INFRA_ROOT="$(dirname "$(dirname "$SCRIPT_DIR")")"

usage() {
    echo ""
    echo -e "${BOLD}DS01 Container Deploy${NC}"
    echo ""
    echo -e "${CYAN}Description:${NC}"
    echo "  Streamlined workflow to create and immediately enter a container."
    echo "  Combines container-create + container-run in one command."
    echo ""
    echo -e "${CYAN}Usage:${NC}"
    echo "  container deploy [name] [image] [options]"
    echo "  container deploy              # Interactive wizard"
    echo ""
    echo -e "${CYAN}Arguments:${NC}"
    echo "  name              Container name (optional - wizard starts if omitted)"
    echo "  image             Docker image or framework (pytorch, tensorflow)"
    echo ""
    echo -e "${CYAN}Options:${NC}"
    echo "  --guided          Show detailed explanations for beginners"
    echo "  --cpu-only        Create CPU-only container (no GPU)"
    echo "  -w, --workspace   Workspace directory (default: ~/workspace/<name>)"
    echo "  -d, --data        Additional data directory to mount"
    echo "  -h, --help        Show this help message"
    echo ""
    echo -e "${CYAN}Examples:${NC}"
    echo -e "  ${DIM}# Interactive mode (recommended for first time)${NC}"
    echo "  container deploy"
    echo ""
    echo -e "  ${DIM}# Quick deploy with PyTorch${NC}"
    echo "  container deploy my-project"
    echo ""
    echo -e "  ${DIM}# Deploy from custom image${NC}"
    echo "  container deploy my-project my-project-image"
    echo ""
    echo -e "  ${DIM}# Deploy with guided mode${NC}"
    echo "  container deploy my-project --guided"
    echo ""
    echo -e "${YELLOW}ğŸ’¡ What happens:${NC}"
    echo "  1. Creates container with resource allocation"
    echo "  2. Enters container immediately (you'll be inside)"
    echo "  3. When you exit, container keeps running (use 'container retire' to cleanup)"
    echo ""
    echo -e "${CYAN}Alternative commands:${NC}"
    echo -e "  ${DIM}# Step-by-step (Tier 2 modular commands)${NC}"
    echo "  container-create my-project    # Create only"
    echo "  container-run my-project       # Enter later"
    echo ""
    echo -e "  ${DIM}# Cleanup when done${NC}"
    echo "  container retire my-project    # Stop + Remove (frees GPU)"
    echo ""
}

# Parse arguments (pass through to container-create)
CONTAINER_ARGS=()
GUIDED_FLAG=""

while [[ $# -gt 0 ]]; do
    case $1 in
        --guided)
            GUIDED_FLAG="--guided"
            CONTAINER_ARGS+=("$1")
            shift
            ;;
        -h|--help|--info)
            usage
            exit 0
            ;;
        *)
            CONTAINER_ARGS+=("$1")
            shift
            ;;
    esac
done

echo ""
echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${BOLD}Container Deploy${NC}"
echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""

if [ -n "$GUIDED_FLAG" ]; then
    echo -e "${CYAN}â„¹ ${NC}${BOLD}What is 'deploy'?${NC}"
    echo ""
    echo "Deploy is a streamlined workflow that:"
    echo "  1. Creates a new container from an image"
    echo "  2. Immediately enters the container so you can start working"
    echo ""
    echo "This is equivalent to running:"
    echo -e "  ${DIM}container-create <name>${NC}"
    echo -e "  ${DIM}container-run <name>${NC}"
    echo ""
    echo "But in a single command with unified output."
    echo ""
    read -p "Press Enter to continue..." </dev/tty
    echo ""
fi

# Step 1: Create container
echo -e "${CYAN}â”â”â” Step 1/2: Creating Container â”â”â”${NC}"
echo ""

if ! container-create "${CONTAINER_ARGS[@]}"; then
    echo ""
    echo -e "${RED}âœ— Container creation failed${NC}"
    echo ""
    echo -e "${YELLOW}Troubleshooting:${NC}"
    echo -e "  â€¢ Check resource availability: ${GREEN}container-list${NC}"
    echo -e "  â€¢ View your limits: ${GREEN}get-limits${NC}"
    echo ""
    exit 1
fi

# Extract container name from args (needed for container-run)
# Find first non-flag argument
CONTAINER_NAME=""
for arg in "${CONTAINER_ARGS[@]}"; do
    if [[ ! "$arg" =~ ^- ]]; then
        CONTAINER_NAME="$arg"
        break
    fi
done

# If still no name, container-create ran in interactive mode
# We need to find the most recently created container
if [ -z "$CONTAINER_NAME" ]; then
    # Get most recently created container for this user
    CONTAINER_TAG=$(docker ps -a --filter "name=._.$USER_ID" --format "{{.Names}}" --latest 2>/dev/null | head -1)
    if [ -n "$CONTAINER_TAG" ]; then
        CONTAINER_NAME=$(echo "$CONTAINER_TAG" | sed "s/\._\.$USER_ID//")
    else
        echo ""
        echo -e "${RED}âœ— Could not determine container name${NC}"
        exit 1
    fi
fi

echo ""
echo -e "${CYAN}â”â”â” Step 2/2: Entering Container â”â”â”${NC}"
echo ""

if [ -n "$GUIDED_FLAG" ]; then
    echo -e "${CYAN}â„¹ ${NC}${BOLD}You're about to enter the container${NC}"
    echo ""
    echo "Inside the container, you'll have:"
    echo "  â€¢ Full access to your computing environment"
    echo "  â€¢ GPU resources for training"
    echo "  â€¢ Your workspace mounted at /workspace"
    echo "  â€¢ All pre-installed software (Python, PyTorch, etc.)"
    echo ""
    echo -e "${BOLD}Helpful commands inside:${NC}"
    echo -e "  ${GREEN}gpu${NC}       Check GPU status"
    echo -e "  ${GREEN}jlab${NC}      Start Jupyter Lab"
    echo -e "  ${GREEN}ws${NC}        Go to /workspace"
    echo -e "  ${GREEN}exit${NC}      Exit (container keeps running)"
    echo ""
    read -p "Press Enter to enter the container..." </dev/tty
    echo ""
fi

echo -e "${DIM}Entering container '${CONTAINER_NAME}'...${NC}"
echo ""

# Run container (will attach to shell)
container-run $GUIDED_FLAG "$CONTAINER_NAME"
EXIT_CODE=$?

# Post-exit messaging (Tier 3 specific)
echo ""
echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${YELLOW}${BOLD}You've Exited the Container${NC}"
echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""

if [ -n "$GUIDED_FLAG" ]; then
    echo -e "${BOLD}What Just Happened?${NC}"
    echo ""
    echo "  â€¢ Your bash session inside the container ended"
    echo -e "  â€¢ The container is ${GREEN}still running${NC} in the background"
    echo -e "  â€¢ All your files in /workspace are ${BOLD}safe${NC}"
    echo "  â€¢ GPU is still allocated to this container"
    echo ""
    echo -e "${BOLD}What You Can Do Now:${NC}"
    echo ""
    echo -e "  ${BOLD}1) Re-enter the Container${NC}"
    echo -e "     ${GREEN}container deploy $CONTAINER_NAME${NC} or ${GREEN}container-run $CONTAINER_NAME${NC}"
    echo "     Continue working where you left off"
    echo ""
    echo -e "  ${BOLD}2) Retire the Container (Cleanup)${NC}"
    echo -e "     ${GREEN}container retire $CONTAINER_NAME${NC}"
    echo "     Stops container and frees GPU immediately"
    echo -e "     ${BOLD}Do this when you're done!${NC} Be a good citizen."
    echo ""
    echo -e "  ${BOLD}3) Check Status${NC}"
    echo -e "     ${GREEN}container-list${NC}      View all containers"
    echo -e "     ${GREEN}container-stats${NC}     Check resource usage"
    echo ""
    echo -e "${YELLOW}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${BOLD}Important Reminders:${NC}"
    echo ""
    echo -e "  â€¢ ${GREEN}Your files are ALWAYS safe${NC} in ~/workspace/$CONTAINER_NAME"
    echo -e "  â€¢ Container keeps running until you retire it or it hits timeout"
    echo -e "  â€¢ Use ${GREEN}container retire${NC} when done to free GPU for others"
    echo ""
else
    echo -e "${DIM}Container still running in background${NC}"
    echo ""
    echo -e "${BOLD}Quick actions:${NC}"
    echo -e "  â€¢ Re-enter:  ${GREEN}container deploy $CONTAINER_NAME${NC}"
    echo -e "  â€¢ Cleanup:   ${GREEN}container retire $CONTAINER_NAME${NC} ${DIM}(stop + remove, frees GPU)${NC}"
    echo -e "  â€¢ Status:    ${GREEN}container-list${NC}"
    echo ""
fi

exit $EXIT_CODE
