#!/bin/bash
# Delete Docker images for DS01 user

# Source interactive library
source /usr/local/lib/interactive-select.sh

BLUE='\033[94m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m'

USERNAME=$(whoami)

usage() {
    echo ""
    echo -e "${BOLD}Docker Image Remover${NC}"
    echo ""
    echo -e "${CYAN}Usage:${NC}"
    echo "  image-delete [image-name...] [options]"
    echo "  image-delete                           # Prompts to select image (if none specified)"
    echo "  image-delete img1 img2 img3            # Bulk delete multiple images"
    echo "  (also: 'remove' as alias for delete)"
    echo ""
    echo -e "${CYAN}Options:${NC}"
    echo "  --all               Delete all user images (requires confirmation)"
    echo "  --guided            Show detailed explanations for beginners"
    echo "  -f, --force         Force removal (stop/remove containers first)"
    echo "  --keep-dockerfile   Don't delete the Dockerfile"
    echo "  -h, --help          Show this help message"
    echo ""
    echo -e "${CYAN}Description:${NC}"
    echo "  Removes a Docker image and optionally its Dockerfile."
    echo "  Will warn if containers are using the image."
    echo ""
    echo -e "${CYAN}Examples:${NC}"
    echo "  image-delete my-old-project              # Remove image (with confirmation)"
    echo "  image-delete my-project --force          # Force remove (stop containers first)"
    echo "  image-delete test-image --keep-dockerfile  # Keep Dockerfile for later"
    echo "  image-delete --all                       # Remove all user images (with confirmation)"
    echo ""
    echo -e "${CYAN}Safety:${NC}"
    echo "  ‚Ä¢ Warns before deletion"
    echo "  ‚Ä¢ Shows containers using the image"
    echo "  ‚Ä¢ Requires confirmation (unless --force)"
    echo "  ‚Ä¢ Backs up Dockerfile metadata"
    echo ""
    echo -e "${YELLOW}‚ö† Warning:${NC} This action cannot be undone!"
    echo ""
}

# Parse arguments
IMAGE_NAMES=()
GUIDED=false
FORCE=false
KEEP_DOCKERFILE=false
ALL_IMAGES=false

while [[ $# -gt 0 ]]; do
    case $1 in
        --all)
            ALL_IMAGES=true
            shift
            ;;
        --guided)
            GUIDED=true
            shift
            ;;
        -f|--force)
            FORCE=true
            shift
            ;;
        --keep-dockerfile)
            KEEP_DOCKERFILE=true
            shift
            ;;
        -h|--help|--info)
            usage
            exit 0
            ;;
        -*)
            echo -e "${RED}Unknown option: $1${NC}\n"
            usage
            exit 1
            ;;
        *)
            IMAGE_NAMES+=("$1")
            shift
            ;;
    esac
done

# Handle --all flag
if [ "$ALL_IMAGES" = true ]; then
    USER_ID=$(id -u)
    echo ""
    echo -e "${CYAN}Finding all user images...${NC}"
    echo ""

    # Get all user images
    mapfile -t ALL_USER_IMAGES < <(docker images --format "{{.Repository}}" 2>/dev/null | grep "^ds01-$USER_ID/" | grep -v "^<none>$" | sort -u)

    if [ ${#ALL_USER_IMAGES[@]} -eq 0 ]; then
        echo -e "${YELLOW}No images found to delete${NC}"
        exit 0
    fi

    # Show list and confirm
    echo -e "${BOLD}Found ${#ALL_USER_IMAGES[@]} image(s):${NC}"
    echo ""
    for img in "${ALL_USER_IMAGES[@]}"; do
        echo "  ‚Ä¢ $img"
    done
    echo ""

    if [ "$FORCE" != true ]; then
        echo -e "${YELLOW}‚ö† This will delete ALL your images!${NC}"
        echo ""
        read -p "Are you sure? Type 'yes' to confirm: " CONFIRM </dev/tty
        if [ "$CONFIRM" != "yes" ]; then
            echo "Cancelled."
            exit 0
        fi
        echo ""
    fi

    IMAGE_NAMES=("${ALL_USER_IMAGES[@]}")
fi

# Custom select_image function that filters by user's images
select_user_image() {
    local images=()
    local user_id=$(id -u)

    # Get user's images using DS01 naming pattern (same as image-list)
    mapfile -t images < <(docker images --format "{{.Repository}}" 2>/dev/null | grep "^ds01-$user_id/" | grep -v "^<none>$" | sort -u)

    # Check if we found any images
    if [ ${#images[@]} -eq 0 ]; then
        echo -e "${YELLOW}No images found${NC}" >&2
        echo ""
        echo -e "Create an image with: ${GREEN}image-create my-project${NC}" >&2
        return 1
    fi

    # Select image using library function
    select_from_list "Select image to delete:" "${images[@]}"
}

# Show guided explanation BEFORE selection
if [ "$GUIDED" = true ] && [ ${#IMAGE_NAMES[@]} -eq 0 ]; then
    echo ""
    echo -e "${CYAN}‚Ñπ ${NC}${BOLD}What happens when you delete an image:${NC}"
    echo -e "  ‚Ä¢ The image file is permanently removed from disk"
    echo -e "  ‚Ä¢ Any containers using this image will need to be removed first"
    echo -e "  ‚Ä¢ The Dockerfile is backed up (unless --keep-dockerfile is used)"
    echo -e "  ‚Ä¢ You can rebuild the image later using the Dockerfile"
    echo ""
    echo -e "${RED}‚ö† Important:${NC} ${BOLD}What is NOT deleted:${NC}"
    echo -e "  ‚Ä¢ ${GREEN}‚úì${NC} Your workspace files and data (always safe)"
    echo -e "  ‚Ä¢ ${GREEN}‚úì${NC} Dockerfile (backed up to ds01-config/images/deleted/)"
    echo -e "  ‚Ä¢ ${GREEN}‚úì${NC} Container configurations"
    echo ""
    echo -e "${CYAN}‚Ñπ ${NC}${BOLD}Why delete images?${NC}"
    echo -e "  Images can be large (several GB). Deleting unused images"
    echo -e "  frees disk space. You can always rebuild from the Dockerfile."
    echo ""
fi

# If no image names provided, prompt to select
if [ ${#IMAGE_NAMES[@]} -eq 0 ]; then
    SELECTED=$(select_user_image)
    if [ -z "$SELECTED" ]; then
        echo "No selection made. Exiting."
        exit 0
    fi
    IMAGE_NAMES=("$SELECTED")
    echo ""
fi

# Validate at least one image name
if [ ${#IMAGE_NAMES[@]} -eq 0 ]; then
    echo -e "${RED}Error: At least one image name is required${NC}\n"
    usage
    exit 1
fi

# Function to delete a single image
delete_single_image() {
    local IMAGE_NAME="$1"
    local USER_ID=$(id -u)

    # Convert to new naming format if needed
    if [[ ! "$IMAGE_NAME" =~ ^ds01- ]]; then
        # Add DS01 prefix: ds01-{user-id}/{project}
        IMAGE_NAME="ds01-${USER_ID}/${IMAGE_NAME}"
    fi

    # Check if image exists
    if ! docker images --format "{{.Repository}}" | grep -q "^${IMAGE_NAME}$"; then
        echo -e "${RED}‚úó Image '$IMAGE_NAME' not found${NC}"
        echo "Skipping..."
        echo ""
        return 1
    fi

    echo ""
    echo -e "${CYAN}‚îÅ‚îÅ‚îÅ Deleting Image: ${BOLD}$IMAGE_NAME${NC} ${CYAN}‚îÅ‚îÅ‚îÅ${NC}"
    echo ""

    # Show image info
SIZE=$(docker images --format "{{.Size}}" "$IMAGE_NAME" | head -1)
CREATED=$(docker images --format "{{.CreatedAt}}" "$IMAGE_NAME" | head -1)
IMAGE_ID=$(docker images --format "{{.ID}}" "$IMAGE_NAME" | head -1)

echo -e "${BOLD}Image details:${NC}"
echo "  Name:    $IMAGE_NAME"
echo "  ID:      $IMAGE_ID"
echo "  Size:    $SIZE"
echo "  Created: $CREATED"
echo ""

# Check for containers
CONTAINERS=$(docker ps -a --filter "ancestor=$IMAGE_NAME" --format "{{.Names}}" 2>/dev/null)
CONTAINER_COUNT=$(echo "$CONTAINERS" | grep -v "^$" | wc -l)

if [ "$CONTAINER_COUNT" -gt 0 ]; then
    echo -e "${YELLOW}‚ö† This image is used by $CONTAINER_COUNT container(s):${NC}"
    echo "$CONTAINERS" | while read -r container; do
        [ -z "$container" ] && continue
        STATUS=$(docker ps -a --filter "name=$container" --format "{{.Status}}")
        echo "  ‚Ä¢ $container ($STATUS)"
    done
    echo ""

    if [ "$FORCE" = false ]; then
        echo -e "${RED}Cannot delete image while containers exist${NC}"
        echo ""
        echo "Options:"
        echo "  1. Stop and remove containers first:"
        echo "     ${GREEN}container-stop <name> && container-remove${NC}"
        echo ""
        echo "  2. Force delete (stops/removes containers):"
        echo "     ${YELLOW}image-delete $IMAGE_NAME --force${NC}"
        echo ""
        return 1
    else
        echo -e "${YELLOW}--force specified: Removing containers...${NC}"
        echo ""

        # Stop and remove containers
        echo "$CONTAINERS" | while read -r container; do
            [ -z "$container" ] && continue
            echo "  Stopping $container..."
            docker stop "$container" 2>/dev/null || true
            echo "  Removing $container..."
            docker rm "$container" 2>/dev/null || true
        done
        echo ""
    fi
fi

# Confirm deletion
if [ "$FORCE" = false ]; then
    echo -e "${YELLOW}‚ö† This will permanently delete the image${NC}"
    echo ""
    read -p "Are you sure? [y/N]: " CONFIRM
    if [[ ! "$CONFIRM" =~ ^[Yy]$ ]]; then
        echo "Deletion cancelled."
        echo ""
        return 1
    fi
    echo ""
fi

# Remove image
echo "Removing image..."
if docker rmi "$IMAGE_NAME"; then
    echo -e "${GREEN}‚úì Image removed${NC}\n"

    # Handle Dockerfile
    DOCKERFILES_DIR="$HOME/dockerfiles"
    # Extract project name from image (ds01-1001/my-project ‚Üí my-project)
    PROJECT_NAME="${IMAGE_NAME##*/}"
    DOCKERFILE="$DOCKERFILES_DIR/${PROJECT_NAME}.Dockerfile"

    # Sanitize metadata filename (replace / with _)
    METADATA_FILE=$(echo "$IMAGE_NAME" | tr '/' '_')
    INFO_FILE="$HOME/ds01-config/images/${METADATA_FILE}.info"

    # Check info file for custom Dockerfile location
    if [ -f "$INFO_FILE" ]; then
        CUSTOM_DF=$(grep "^Dockerfile:" "$INFO_FILE" | cut -d: -f2- | xargs)
        [ -n "$CUSTOM_DF" ] && DOCKERFILE="$CUSTOM_DF"
    fi

    if [ "$KEEP_DOCKERFILE" = false ]; then
        if [ -f "$DOCKERFILE" ]; then
            # Create backup (sanitize filename)
            BACKUP_DIR="$HOME/ds01-config/images/deleted"
            mkdir -p "$BACKUP_DIR"
            BACKUP_NAME=$(echo "$IMAGE_NAME" | tr '/' '_')
            BACKUP_FILE="$BACKUP_DIR/${BACKUP_NAME}-$(date +%Y%m%d-%H%M%S).Dockerfile"

            cp "$DOCKERFILE" "$BACKUP_FILE"
            rm "$DOCKERFILE"

            echo -e "${YELLOW}üìÑ Dockerfile backed up to:${NC}"
            echo -e "   ${BLUE}$BACKUP_FILE${NC}"
            echo ""
        fi

        # Remove metadata
        if [ -f "$INFO_FILE" ]; then
            rm "$INFO_FILE"
        fi
    else
        echo -e "${YELLOW}üìÑ Dockerfile kept at:${NC}"
        echo "   ${BLUE}$DOCKERFILE${NC}"
        echo ""
        echo "Rebuild later with: ${GREEN}image-update $IMAGE_NAME${NC}"
        echo ""
    fi

    # Show final status
    REMAINING=$(docker images --format "{{.Repository}}" | grep "^ds01-$USER_ID/" | wc -l)
    echo -e "${BOLD}Summary:${NC}"
    echo "  Deleted:   $IMAGE_NAME"
    echo "  Freed:     $SIZE"
    echo "  Remaining: $REMAINING image(s)"
    echo ""

    # Suggest cleanup
else
    echo -e "\n${RED}‚úó Failed to remove image${NC}"
    echo ""
    echo "Troubleshooting:"
    echo "  1. Check for running containers: ${GREEN}container-list${NC}"
    echo "  2. Force deletion: ${YELLOW}image-delete $IMAGE_NAME --force${NC}"
    echo "  3. Manual removal: ${BLUE}docker rmi $IMAGE_ID${NC}"
    return 1
fi

    echo ""
}

# Main execution: Process all images
DELETED_COUNT=0
FAILED_COUNT=0
SKIPPED_COUNT=0
TOTAL_COUNT=${#IMAGE_NAMES[@]}

# Show bulk operation header if multiple images
if [ ${#IMAGE_NAMES[@]} -gt 1 ]; then
    echo ""
    echo -e "${CYAN}‚îÅ‚îÅ‚îÅ Bulk Image Deletion ‚îÅ‚îÅ‚îÅ${NC}"
    echo ""
    echo -e "Processing ${BOLD}${TOTAL_COUNT}${NC} image(s)..."
    echo ""
fi

# Process each image
for IMAGE_NAME in "${IMAGE_NAMES[@]}"; do
    if delete_single_image "$IMAGE_NAME"; then
        DELETED_COUNT=$((DELETED_COUNT + 1))
    else
        # Check if it was skipped (not found) or failed (error during deletion)
        USER_ID=$(id -u)
        if ! docker images --format "{{.Repository}}" | grep -q "^ds01-${USER_ID}/${IMAGE_NAME}$" && \
           ! docker images --format "{{.Repository}}" | grep -q "^${IMAGE_NAME}$"; then
            SKIPPED_COUNT=$((SKIPPED_COUNT + 1))
        else
            FAILED_COUNT=$((FAILED_COUNT + 1))
        fi
    fi
done

# Show summary for bulk operations
if [ ${#IMAGE_NAMES[@]} -gt 1 ]; then
    echo ""
    echo -e "${CYAN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
    echo -e "${BOLD}Bulk Deletion Summary${NC}"
    echo -e "${CYAN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
    echo ""
    echo "  Total processed: $TOTAL_COUNT"
    echo -e "  ${GREEN}‚úì Deleted:${NC}       $DELETED_COUNT"

    if [ $SKIPPED_COUNT -gt 0 ]; then
        echo -e "  ${YELLOW}‚äò Skipped:${NC}       $SKIPPED_COUNT (not found)"
    fi

    if [ $FAILED_COUNT -gt 0 ]; then
        echo -e "  ${RED}‚úó Failed:${NC}        $FAILED_COUNT"
    fi

    echo ""

    # Show final status
    if [ $DELETED_COUNT -eq $TOTAL_COUNT ]; then
        echo -e "${GREEN}All images deleted successfully!${NC}"
    elif [ $DELETED_COUNT -gt 0 ]; then
        echo -e "${YELLOW}Partial success: $DELETED_COUNT of $TOTAL_COUNT deleted${NC}"
    else
        echo -e "${RED}No images were deleted${NC}"
    fi

    echo ""
fi
