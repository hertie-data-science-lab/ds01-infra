#!/bin/bash
# DS01 Container Create - Creates containers via mlc-create-wrapper
# Tier 2 Command - Can be used standalone or called by orchestrators

set -e

# Colors
BLUE='\033[94m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
CYAN='\033[0;36m'
BOLD='\033[1m'
DIM='\033[2m'
NC='\033[0m'

USERNAME=$(whoami)
USER_ID=$(id -u)

# Script paths - resolve symlinks to get real path
SCRIPT_PATH="${BASH_SOURCE[0]}"
# Follow symlink if this script is a symlink
if [ -L "$SCRIPT_PATH" ]; then
    SCRIPT_PATH="$(readlink -f "$SCRIPT_PATH")"
fi
SCRIPT_DIR="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)"
INFRA_ROOT="$(dirname "$(dirname "$SCRIPT_DIR")")"  # Go up two levels: user -> scripts -> infra
RESOURCE_PARSER="$INFRA_ROOT/scripts/docker/get_resource_limits.py"
MLC_WRAPPER="$INFRA_ROOT/scripts/docker/mlc-create-wrapper.sh"

usage() {
    echo ""
    echo -e "${BOLD}DS01 Container Create${NC}"
    echo ""
    echo -e "${CYAN}Usage:${NC}"
    echo "  container-create [name] [image] [options]"
    echo "  container-create              # Interactive wizard (no arguments)"
    echo ""
    echo -e "${CYAN}Arguments:${NC}"
    echo "  name              Container name (optional - wizard starts if omitted)"
    echo "  image             Docker image or framework (pytorch, tensorflow)"
    echo ""
    echo -e "${CYAN}Options:${NC}"
    echo "  --guided          Show detailed explanations for beginners"
    echo "  --cpu-only        Create CPU-only container (no GPU)"
    echo "  -w, --workspace   Workspace directory (default: ~/workspace/<name>)"
    echo "  -d, --data        Additional data directory to mount"
    echo "  --dry-run         Show what would be created"
    echo "  -h, --help        Show this help message"
    echo ""
    echo -e "${CYAN}Examples:${NC}"
    echo -e "  ${DIM}# Interactive mode (recommended for first time)${NC}"
    echo "  container-create"
    echo ""
    echo -e "  ${DIM}# Quick create with PyTorch (default)${NC}"
    echo "  container-create my-project"
    echo ""
    echo -e "  ${DIM}# Create from custom image${NC}"
    echo "  container-create my-project my-project-image"
    echo ""
    echo -e "  ${DIM}# Create with TensorFlow${NC}"
    echo "  container-create my-project tensorflow"
    echo ""
    echo -e "  ${DIM}# Guided mode for beginners${NC}"
    echo "  container-create my-project --guided"
    echo ""
    echo -e "  ${DIM}# CPU-only for preprocessing${NC}"
    echo "  container-create preprocessing --cpu-only"
    echo ""
    echo -e "${YELLOW}ğŸ’¡ After creation:${NC}"
    echo -e "  â€¢ Start container: ${GREEN}container-run <name>${NC}"
    echo -e "  â€¢ View containers: ${GREEN}container-list${NC}"
    echo -e "  â€¢ Check resources: ${GREEN}container-stats${NC}"
    echo ""
}

# Parse arguments
CONTAINER_NAME=""
IMAGE_OR_FRAMEWORK=""
GUIDED=false
CPU_ONLY=false
WORKSPACE_DIR=""
DATA_DIR=""
DRY_RUN=false

while [[ $# -gt 0 ]]; do
    case $1 in
        --guided)
            GUIDED=true
            shift
            ;;
        --cpu-only)
            CPU_ONLY=true
            shift
            ;;
        -w|--workspace)
            WORKSPACE_DIR="$2"
            shift 2
            ;;
        -d|--data)
            DATA_DIR="$2"
            shift 2
            ;;
        --dry-run)
            DRY_RUN=true
            shift
            ;;
        -h|--help)
            usage
            exit 0
            ;;
        -*)
            echo -e "${RED}âœ— Unknown option: $1${NC}\n"
            usage
            exit 1
            ;;
        *)
            if [ -z "$CONTAINER_NAME" ]; then
                CONTAINER_NAME="$1"
            elif [ -z "$IMAGE_OR_FRAMEWORK" ]; then
                IMAGE_OR_FRAMEWORK="$1"
            else
                echo -e "${RED}âœ— Too many arguments${NC}\n"
                usage
                exit 1
            fi
            shift
            ;;
    esac
done

# Interactive mode if no container name provided
if [ -z "$CONTAINER_NAME" ]; then
    echo ""
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${BOLD}DS01 Container Creation Wizard${NC}"
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
    echo "Let's create your container step-by-step."
    echo ""

    # Step 1: Image source (CHANGED: now comes first!)
    echo -e "${BOLD}Step 1: Docker Image${NC}"
    echo ""
    echo "Containers are created from Docker images (blueprints with all software)."
    echo ""
    echo "Choose an option:"
    echo ""
    echo -e "  ${BOLD}1)${NC} Use existing image ${GREEN}(recommended if you have one)${NC}"
    echo "     Select from images already built on this system"
    echo ""
    echo -e "  ${BOLD}2)${NC} Create custom image"
    echo "     Build a new image with your choice of framework and packages"
    echo ""
    echo -e "  ${BOLD}3)${NC} Use base framework (PyTorch/TensorFlow)"
    echo "     Quick start with standard frameworks (no customization)"
    echo ""
    read -p "Choice [1-3, default: 1]: " IMAGE_CHOICE </dev/tty
    IMAGE_CHOICE=${IMAGE_CHOICE:-1}
    echo ""

    case $IMAGE_CHOICE in
        1)
            # Use existing image
            echo -e "${CYAN}â”â”â” Available Images â”â”â”${NC}"
            echo ""

            # List available images
            if command -v docker &>/dev/null; then
                # Get all images with username prefix or standard frameworks
                AVAILABLE_IMAGES=$(docker images --format "{{.Repository}}:{{.Tag}}" | grep -E "$USERNAME-|pytorch|tensorflow" | grep -v "<none>" | sort)

                if [ -n "$AVAILABLE_IMAGES" ]; then
                    echo "Your images:"
                    echo ""

                    # Create array and display with numbers
                    mapfile -t IMAGE_ARRAY <<< "$AVAILABLE_IMAGES"
                    IMAGE_COUNT=${#IMAGE_ARRAY[@]}

                    for i in "${!IMAGE_ARRAY[@]}"; do
                        IMG="${IMAGE_ARRAY[$i]}"
                        # Extract just the repository name (remove tag)
                        IMG_REPO="${IMG%:*}"
                        echo -e "  ${BOLD}$((i+1)))${NC} $IMG_REPO"
                    done
                    echo ""

                    read -p "Select image [1-$IMAGE_COUNT]: " IMG_SELECTION </dev/tty

                    if [[ "$IMG_SELECTION" =~ ^[0-9]+$ ]] && [ "$IMG_SELECTION" -ge 1 ] && [ "$IMG_SELECTION" -le "$IMAGE_COUNT" ]; then
                        SELECTED_IMAGE="${IMAGE_ARRAY[$((IMG_SELECTION-1))]}"
                        # Extract repository name only (no tag)
                        IMAGE_OR_FRAMEWORK="${SELECTED_IMAGE%:*}"

                        echo ""
                        echo -e "${GREEN}âœ“${NC} Selected image: ${CYAN}$IMAGE_OR_FRAMEWORK${NC}"
                        echo ""

                        # Derive container name from image name
                        # Remove username prefix and -image suffix if present
                        CONTAINER_NAME="$IMAGE_OR_FRAMEWORK"
                        CONTAINER_NAME="${CONTAINER_NAME#$USERNAME-}"  # Remove username prefix
                        CONTAINER_NAME="${CONTAINER_NAME%-image}"      # Remove -image suffix

                        echo -e "${BOLD}Step 2: Container Name${NC}"
                        echo ""
                        echo -e "Default name based on image: ${CYAN}$CONTAINER_NAME${NC}"
                        echo ""
                        read -p "Use this name or enter a different one [$CONTAINER_NAME]: " CUSTOM_NAME </dev/tty

                        if [ -n "$CUSTOM_NAME" ]; then
                            CONTAINER_NAME="$CUSTOM_NAME"
                        fi
                        echo ""
                    else
                        echo -e "${RED}âœ— Invalid selection${NC}"
                        exit 1
                    fi
                else
                    echo "No custom images found."
                    echo ""
                    echo "Would you like to create a new image instead?"
                    read -p "Create new image? [Y/n]: " CREATE_NEW </dev/tty
                    if [[ ! "$CREATE_NEW" =~ ^[Yy]$ ]] && [[ ! -z "$CREATE_NEW" ]]; then
                        echo "Cancelled."
                        exit 0
                    fi
                    # Fall through to create custom image
                    IMAGE_CHOICE=2
                    echo ""
                fi
            else
                echo -e "${RED}âœ— Docker not available${NC}"
                exit 1
            fi

            # Skip to GPU mode if we selected an existing image
            if [ "$IMAGE_CHOICE" = "1" ] && [ -n "$IMAGE_OR_FRAMEWORK" ]; then
                # Jump to GPU mode section
                :  # No-op, we'll handle GPU mode after the case statement
            fi
            ;;

        2)
            # Create custom image
            echo -e "${CYAN}â”â”â” Creating Custom Image â”â”â”${NC}"
            echo ""

            # Image name (ask first!)
            echo -e "${BOLD}Image Name${NC}"
            echo ""
            echo "Choose a name for your image (e.g., my-project, thesis-cv, nlp-exp)"
            echo ""
            read -p "Image name: " IMAGE_BASE_NAME </dev/tty

            if [ -z "$IMAGE_BASE_NAME" ]; then
                echo -e "${RED}âœ— Image name cannot be empty${NC}"
                exit 1
            fi

            # Sanitize image name
            IMAGE_BASE_NAME=$(echo "$IMAGE_BASE_NAME" | tr '[:upper:]' '[:lower:]' | tr ' ' '-')
            echo ""

            # Framework selection
            echo -e "${BOLD}Select Framework:${NC}"
            echo ""
            echo -e "  ${BOLD}1)${NC} PyTorch 2.5.1 + CUDA 11.8 ${GREEN}(recommended)${NC}"
            echo -e "  ${BOLD}2)${NC} TensorFlow 2.14.0 + CUDA 11.8"
            echo ""
            read -p "Framework [1-2, default: 1]: " FW_CHOICE </dev/tty
            FW_CHOICE=${FW_CHOICE:-1}

            FRAMEWORK_NAME="pytorch"
            if [ "$FW_CHOICE" = "2" ]; then
                FRAMEWORK_NAME="tensorflow"
            fi
            echo ""

            # Use case selection
            echo -e "${BOLD}Select Use Case:${NC}"
            echo ""
            echo -e "  ${BOLD}1)${NC} General ML (scikit-learn, xgboost, lightgbm) ${GREEN}(default)${NC}"
            echo -e "  ${BOLD}2)${NC} Computer Vision (timm, albumentations, opencv)"
            echo -e "  ${BOLD}3)${NC} NLP (transformers, datasets, tokenizers)"
            echo -e "  ${BOLD}4)${NC} Reinforcement Learning (gymnasium, stable-baselines3)"
            echo -e "  ${BOLD}5)${NC} Minimal (just basics, add packages later)"
            echo ""
            read -p "Use case [1-5, default: 1]: " UC_CHOICE </dev/tty
            UC_CHOICE=${UC_CHOICE:-1}

            USE_CASE_TYPE="ml"
            case $UC_CHOICE in
                2) USE_CASE_TYPE="cv" ;;
                3) USE_CASE_TYPE="nlp" ;;
                4) USE_CASE_TYPE="rl" ;;
                5) USE_CASE_TYPE="custom" ;;
                *) USE_CASE_TYPE="ml" ;;
            esac
            echo ""

            # Additional packages
            echo -e "${BOLD}Additional Python Packages?${NC} ${DIM}(optional)${NC}"
            echo "Examples: wandb optuna pytorch-lightning tensorboardX"
            echo ""
            read -p "Extra packages (space-separated, or Enter to skip): " EXTRA_PACKAGES </dev/tty
            echo ""

            # Build the image
            echo -e "${CYAN}Building custom image...${NC}"
            echo ""

            IMAGE_BUILD_ARGS=("${IMAGE_BASE_NAME}-image" "-f" "$FRAMEWORK_NAME" "-t" "$USE_CASE_TYPE")

            if [ -n "$EXTRA_PACKAGES" ]; then
                IMAGE_BUILD_ARGS+=("-p" "$EXTRA_PACKAGES")
            fi

            # Check if image-create exists
            if [ -x "$SCRIPT_DIR/image-create" ]; then
                if "$SCRIPT_DIR/image-create" "${IMAGE_BUILD_ARGS[@]}"; then
                    IMAGE_OR_FRAMEWORK="$USERNAME-${IMAGE_BASE_NAME}-image"
                    echo ""
                    echo -e "${GREEN}âœ“${NC} Image created: ${CYAN}$IMAGE_OR_FRAMEWORK${NC}"
                    echo ""

                    # Derive container name from image name
                    CONTAINER_NAME="$IMAGE_BASE_NAME"

                    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
                    echo -e "${BOLD}Create Container from Image?${NC}"
                    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
                    echo ""
                    echo "Your custom image is ready! Would you like to create"
                    echo "a container from it now?"
                    echo ""
                    echo -e "Default container name: ${CYAN}$CONTAINER_NAME${NC}"
                    echo ""
                    echo -e "  ${BOLD}Y)${NC} Yes, create container ${GREEN}(recommended)${NC}"
                    echo -e "  ${BOLD}N)${NC} No, I'll create it later"
                    echo -e "  ${BOLD}C)${NC} Choose a different container name"
                    echo ""
                    read -p "Continue with container creation? [Y/n/c]: " CREATE_CONTAINER </dev/tty
                    CREATE_CONTAINER=${CREATE_CONTAINER:-Y}
                    echo ""

                    if [[ "$CREATE_CONTAINER" =~ ^[Cc]$ ]]; then
                        read -p "Enter container name: " CUSTOM_CONTAINER_NAME </dev/tty
                        if [ -n "$CUSTOM_CONTAINER_NAME" ]; then
                            CONTAINER_NAME="$CUSTOM_CONTAINER_NAME"
                        fi
                        echo ""
                    elif [[ ! "$CREATE_CONTAINER" =~ ^[Yy]$ ]]; then
                        echo -e "${YELLOW}Container creation skipped${NC}"
                        echo ""
                        echo -e "${BOLD}To create a container later, run:${NC}"
                        echo -e "  ${GREEN}container-create $CONTAINER_NAME $IMAGE_OR_FRAMEWORK${NC}"
                        echo ""
                        exit 0
                    fi
                else
                    echo -e "${RED}âœ— Image creation failed${NC}"
                    exit 1
                fi
            else
                echo -e "${RED}âœ— image-create command not found${NC}"
                echo "Falling back to PyTorch framework"
                IMAGE_OR_FRAMEWORK="pytorch"
                # Still need to ask for container name if falling back
                read -p "Container name: " CONTAINER_NAME </dev/tty
                if [ -z "$CONTAINER_NAME" ]; then
                    echo -e "${RED}âœ— Container name required${NC}"
                    exit 1
                fi
            fi
            ;;

        3)
            # Use base framework
            echo -e "${CYAN}â”â”â” Base Framework â”â”â”${NC}"
            echo ""

            echo -e "${BOLD}Select Framework:${NC}"
            echo ""
            echo -e "  ${BOLD}1)${NC} PyTorch (default)"
            echo -e "  ${BOLD}2)${NC} TensorFlow"
            echo ""
            read -p "Framework [1-2, default: 1]: " FW_CHOICE </dev/tty
            FW_CHOICE=${FW_CHOICE:-1}

            IMAGE_OR_FRAMEWORK="pytorch"
            if [ "$FW_CHOICE" = "2" ]; then
                IMAGE_OR_FRAMEWORK="tensorflow"
            fi
            echo ""

            # Ask for container name
            echo -e "${BOLD}Step 2: Container Name${NC}"
            echo ""
            echo "Choose a name for your container (e.g., my-project, preprocessing)"
            echo ""
            read -p "Container name: " CONTAINER_NAME </dev/tty

            if [ -z "$CONTAINER_NAME" ]; then
                echo -e "${RED}âœ— Container name cannot be empty${NC}"
                exit 1
            fi
            echo ""
            ;;

        *)
            echo -e "${RED}âœ— Invalid choice${NC}"
            exit 1
            ;;
    esac

    # Optional: CPU-only mode
    echo -e "${BOLD}GPU Mode:${NC}"
    echo ""
    echo -e "  ${BOLD}1)${NC} GPU enabled ${GREEN}(recommended for training)${NC}"
    echo -e "  ${BOLD}2)${NC} CPU only (for preprocessing/testing)"
    echo ""
    read -p "Choice [1-2, default: 1]: " GPU_CHOICE </dev/tty
    GPU_CHOICE=${GPU_CHOICE:-1}

    if [ "$GPU_CHOICE" = "2" ]; then
        CPU_ONLY=true
    fi
    echo ""
fi

# Sanitize container name
CONTAINER_NAME=$(echo "$CONTAINER_NAME" | tr '[:upper:]' '[:lower:]' | tr ' ' '-')

# Container tag (how docker sees it)
CONTAINER_TAG="${CONTAINER_NAME}._.${USER_ID}"

# Default workspace
if [ -z "$WORKSPACE_DIR" ]; then
    WORKSPACE_DIR="$HOME/workspace/$CONTAINER_NAME"
fi

# Show guided introduction
if [ "$GUIDED" = true ]; then
    echo ""
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${BOLD}Understanding Containers${NC}"
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
    echo -e "${BOLD}What is a Container?${NC}"
    echo "  A container is your computing environment that includes:"
    echo "  â€¢ Operating system (Ubuntu Linux)"
    echo "  â€¢ Software pre-installed (Python, PyTorch, TensorFlow, etc.)"
    echo "  â€¢ GPU access for machine learning"
    echo "  â€¢ Tools like Jupyter, Git, and more"
    echo ""
    echo -e "${BOLD}Container vs Image:${NC}"
    echo -e "  ${CYAN}Image${NC}     = Template (like a blueprint)"
    echo -e "  ${CYAN}Container${NC} = Running instance (like a building from that blueprint)"
    echo ""
    echo -e "${BOLD}Container vs Workspace:${NC}"
    echo -e "  ${CYAN}Container${NC}  = Your computing environment (can be stopped/restarted)"
    echo -e "  ${CYAN}Workspace${NC} = Your files (permanent storage)"
    echo ""
    echo "  Think of it like:"
    echo "  â€¢ Container = The computer you work on"
    echo "  â€¢ Workspace = Your hard drive with all your files"
    echo ""
    echo -e "${BOLD}Resource Allocation:${NC}"
    echo "  DS01 automatically assigns resources to your container:"
    echo "  â€¢ CPUs for computation"
    echo "  â€¢ Memory (RAM)"
    echo "  â€¢ GPU/MIG instances for training"
    echo "  â€¢ Shared memory for data loading"
    echo ""
    echo "  These limits are based on your user group and ensure fair"
    echo "  resource sharing among all users."
    echo ""
    read -p "Press Enter to continue..." </dev/tty
    echo ""
fi

# Check if wrapper exists
if [ ! -f "$MLC_WRAPPER" ]; then
    echo -e "${RED}âœ— mlc-create-wrapper not found${NC}"
    echo ""
    echo -e "${YELLOW}Expected location:${NC} $MLC_WRAPPER"
    echo ""
    echo -e "${YELLOW}Debugging info:${NC}"
    echo "  SCRIPT_DIR: $SCRIPT_DIR"
    echo "  INFRA_ROOT: $INFRA_ROOT"
    echo ""
    echo "The system may not be fully configured."
    echo "Please contact your administrator."
    echo ""
    exit 1
fi

# Check if container already exists
if docker ps -a --format "{{.Names}}" 2>/dev/null | grep -q "^${CONTAINER_TAG}$"; then
    echo -e "${YELLOW}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${YELLOW}âš   Container '${CONTAINER_NAME}' already exists${NC}"
    echo -e "${YELLOW}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
    echo "What would you like to do?"
    echo ""
    echo -e "  ${BOLD}1)${NC} Use existing container ${GREEN}(recommended)${NC}"
    echo "     Continue using the container that already exists"
    echo ""
    echo -e "  ${BOLD}2)${NC} Remove and recreate it"
    echo "     Delete the old container and create a new one"
    echo "     ${RED}âš  WARNING: This will delete the container (workspace files are safe)${NC}"
    echo ""
    echo -e "  ${BOLD}3)${NC} Create with a different name"
    echo "     Choose a new name for this container"
    echo ""
    echo -e "  ${BOLD}4)${NC} Cancel"
    echo "     Exit without doing anything"
    echo ""
    read -p "Choice [1-4, default: 1]: " RECOVERY_CHOICE </dev/tty
    RECOVERY_CHOICE=${RECOVERY_CHOICE:-1}

    case $RECOVERY_CHOICE in
        1)
            echo ""
            echo -e "${GREEN}âœ“${NC} Using existing container"
            echo ""
            echo -e "${BOLD}Next steps:${NC}"
            echo -e "  Start container: ${GREEN}container-run $CONTAINER_NAME${NC}"
            echo ""
            exit 0
            ;;
        2)
            echo ""
            echo -e "${YELLOW}Removing existing container...${NC}"
            # Stop if running
            docker stop "$CONTAINER_TAG" 2>/dev/null || true
            # Remove container
            docker rm "$CONTAINER_TAG" 2>/dev/null || true
            echo -e "${GREEN}âœ“${NC} Container removed"
            echo ""
            echo "Continuing with creation..."
            echo ""
            ;;
        3)
            echo ""
            read -p "New container name: " NEW_NAME </dev/tty
            if [ -n "$NEW_NAME" ]; then
                CONTAINER_NAME=$(echo "$NEW_NAME" | tr '[:upper:]' '[:lower:]' | tr ' ' '-')
                CONTAINER_TAG="${CONTAINER_NAME}._.${USER_ID}"
                if [ -z "$WORKSPACE_DIR" ] || [ "$WORKSPACE_DIR" == "$HOME/workspace/$CONTAINER_NAME" ]; then
                    WORKSPACE_DIR="$HOME/workspace/$CONTAINER_NAME"
                fi
                echo ""
                echo "Creating with name: $CONTAINER_NAME"
                echo ""
            else
                echo -e "${RED}âœ— Invalid name${NC}"
                exit 1
            fi
            ;;
        4|*)
            echo ""
            echo "Cancelled"
            exit 0
            ;;
    esac
fi

# Determine framework/image
FRAMEWORK="pytorch"
IMAGE_NAME=""

if [ -n "$IMAGE_OR_FRAMEWORK" ]; then
    # Check if it's a framework name or custom image
    case "${IMAGE_OR_FRAMEWORK,,}" in
        pytorch|torch)
            FRAMEWORK="pytorch"
            ;;
        tensorflow|tf)
            FRAMEWORK="tensorflow"
            ;;
        *)
            # Assume it's a custom image name
            # Check if image exists locally
            if docker image inspect "$IMAGE_OR_FRAMEWORK" &>/dev/null; then
                IMAGE_NAME="$IMAGE_OR_FRAMEWORK"
                # Try to detect framework from image labels
                FRAMEWORK=$(docker inspect --format '{{index .Config.Labels "ds01.framework"}}' "$IMAGE_NAME" 2>/dev/null || echo "pytorch")
                if [ -z "$FRAMEWORK" ]; then
                    FRAMEWORK="pytorch"
                fi
            else
                echo -e "${YELLOW}âš  Image '$IMAGE_OR_FRAMEWORK' not found locally${NC}"
                echo ""
                echo "Using as framework name: $IMAGE_OR_FRAMEWORK"
                FRAMEWORK="$IMAGE_OR_FRAMEWORK"
            fi
            ;;
    esac
fi

# Create workspace directory if it doesn't exist
if [ ! -d "$WORKSPACE_DIR" ]; then
    if [ "$GUIDED" = true ]; then
        echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
        echo -e "${BOLD}Creating Workspace Directory${NC}"
        echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
        echo ""
        echo "Your workspace doesn't exist yet. Creating:"
        echo -e "  ${CYAN}$WORKSPACE_DIR${NC}"
        echo ""
        echo "This directory will be mounted inside the container at:"
        echo -e "  ${CYAN}/workspace${NC}"
        echo ""
        echo "All files you save in /workspace will be stored here permanently."
        echo ""
    fi
    mkdir -p "$WORKSPACE_DIR"
    echo -e "${GREEN}âœ“${NC} Workspace directory created: $WORKSPACE_DIR"
    echo ""
fi

# Show creation summary
echo ""
echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${BOLD}Container Creation Summary${NC}"
echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""
echo -e "${BOLD}Name:${NC}       $CONTAINER_NAME"
echo -e "${BOLD}Framework:${NC}  $FRAMEWORK"
if [ -n "$IMAGE_NAME" ]; then
    echo -e "${BOLD}Image:${NC}      $IMAGE_NAME"
fi
echo -e "${BOLD}Workspace:${NC}  $WORKSPACE_DIR"
if [ "$CPU_ONLY" = true ]; then
    echo -e "${BOLD}GPU:${NC}        ${YELLOW}CPU only${NC}"
else
    echo -e "${BOLD}GPU:${NC}        ${GREEN}Enabled (auto-allocated)${NC}"
fi
echo ""

if [ "$DRY_RUN" = true ]; then
    echo -e "${YELLOW}[DRY RUN] Would create container with mlc-create-wrapper${NC}"
    echo ""
    echo "Command that would be executed:"
    echo -e "  ${CYAN}bash $MLC_WRAPPER $CONTAINER_NAME $FRAMEWORK -w=\"$WORKSPACE_DIR\"${NC}"
    if [ "$CPU_ONLY" = true ]; then
        echo "  ${CYAN}--cpu-only${NC}"
    fi
    echo ""
    exit 0
fi

# Build arguments for mlc-create-wrapper
WRAPPER_ARGS=("$CONTAINER_NAME" "$FRAMEWORK")

# Add workspace
WRAPPER_ARGS+=("-w=$WORKSPACE_DIR")

# Add data directory if specified
if [ -n "$DATA_DIR" ]; then
    WRAPPER_ARGS+=("-d=$DATA_DIR")
fi

# Add CPU-only flag
if [ "$CPU_ONLY" = true ]; then
    WRAPPER_ARGS+=("--cpu-only")
fi

# Show what we're doing
if [ "$GUIDED" = true ]; then
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${BOLD}What Happens Next${NC}"
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
    echo "The system will now:"
    echo ""
    echo "  1. ${BOLD}Check your resource limits${NC}"
    echo "     Based on your user group configuration"
    echo ""
    echo "  2. ${BOLD}Allocate GPU resources${NC}"
    echo "     Assign GPU/MIG instances if available"
    echo ""
    echo "  3. ${BOLD}Download/prepare the Docker image${NC}"
    echo "     Get the $FRAMEWORK image (may take a few minutes first time)"
    echo ""
    echo "  4. ${BOLD}Create the container${NC}"
    echo "     Set up your computing environment with all software"
    echo ""
    echo "  5. ${BOLD}Apply resource limits${NC}"
    echo "     Ensure fair resource sharing"
    echo ""
    echo -e "${DIM}This may take 3-5 minutes on first run (downloading base image)${NC}"
    echo ""
    read -p "Press Enter to continue..." </dev/tty
    echo ""
fi

# Call mlc-create-wrapper
echo -e "${CYAN}Creating container via mlc-create-wrapper...${NC}"
echo ""

if bash "$MLC_WRAPPER" "${WRAPPER_ARGS[@]}"; then
    echo ""
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${GREEN}${BOLD}âœ“ Container Created Successfully!${NC}"
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""

    if [ "$GUIDED" = true ]; then
        echo -e "${BOLD}What Just Happened?${NC}"
        echo ""
        echo "Your container has been created but is not started yet."
        echo ""
        echo -e "${BOLD}Container State:${NC}"
        echo -e "  â€¢ ${YELLOW}Created${NC} - Container exists but isn't running"
        echo "  â€¢ No resources are being used yet"
        echo "  â€¢ Your workspace is ready to be mounted"
        echo ""
        echo -e "${BOLD}Next Steps:${NC}"
        echo ""
        echo "  1. ${BOLD}Start the container${NC}"
        echo -e "     ${GREEN}container-run $CONTAINER_NAME${NC}"
        echo "     This starts the container and opens a shell inside"
        echo ""
        echo "  2. ${BOLD}Inside the container${NC}"
        echo "     â€¢ Your workspace is at: /workspace"
        echo "     â€¢ Run Python scripts: python train.py"
        echo "     â€¢ Start Jupyter: jlab"
        echo "     â€¢ Check GPU: gpu"
        echo ""
        echo "  3. ${BOLD}Exit the container${NC}"
        echo "     â€¢ Type 'exit' or press Ctrl+D"
        echo "     â€¢ Container keeps running in background"
        echo "     â€¢ Re-enter anytime: container-run $CONTAINER_NAME"
        echo ""
        echo "  4. ${BOLD}Stop the container (when done)${NC}"
        echo -e "     ${GREEN}container-stop $CONTAINER_NAME${NC}"
        echo "     Frees up GPU and resources for others"
        echo ""
        echo -e "${YELLOW}ğŸ’¡ Remember:${NC} Your files in /workspace are safe and persist!"
        echo ""
    else
        echo -e "${BOLD}Next steps:${NC}"
        echo -e "  â€¢ Start container: ${GREEN}container-run $CONTAINER_NAME${NC}"
        echo -e "  â€¢ View containers: ${GREEN}container-list${NC}"
        echo -e "  â€¢ Check resources: ${GREEN}container-stats${NC}"
        echo ""
    fi
else
    EXIT_CODE=$?
    echo ""
    echo -e "${RED}âœ— Container creation failed (exit code: $EXIT_CODE)${NC}"
    echo ""
    echo -e "${YELLOW}Common issues:${NC}"
    echo "  â€¢ Docker permission denied: Ask admin to add you to docker group"
    echo "  â€¢ Workspace path doesn't exist: Check -w option"
    echo "  â€¢ Out of disk space: Contact admin"
    echo "  â€¢ GPU unavailable: Try --cpu-only"
    echo ""
    exit $EXIT_CODE
fi
