#!/bin/bash
# Create container with resource limits and GPU allocation

BLUE='\033[94m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
CYAN='\033[0;36m'
BOLD='\033[1m'
DIM='\033[2m'
NC='\033[0m'

USERNAME=$(whoami)
USER_ID=$(id -u)

# Try to find the resource limit scripts
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
INFRA_ROOT="$(dirname "$SCRIPT_DIR")"
RESOURCE_PARSER="$INFRA_ROOT/docker/get_resource_limits.py"

usage() {
    echo ""
    echo -e "${BOLD}Container Creator${NC}"
    echo ""
    echo -e "${CYAN}Usage:${NC}"
    echo "  container-create <name> [image] [options]"
    echo ""
    echo -e "${CYAN}Arguments:${NC}"
    echo "  name              Container name (required)"
    echo "  image             Docker image to use (default: auto-detect from name)"
    echo ""
    echo -e "${CYAN}Options:${NC}"
    echo "  -g, --gpu ID      Request specific GPU (admin only)"
    echo "  -n, --num-gpus N  Number of MIG instances (default: 1)"
    echo "  --cpu-only        Create CPU-only container"
    echo "  -w, --workspace   Workspace directory (default: ~/workspace/<name>)"
    echo "  -d, --data        Additional data directory to mount"
    echo "  --dry-run         Show what would be created"
    echo "  -h, --help        Show this help message"
    echo ""
    echo -e "${CYAN}Examples:${NC}"
    echo -e "  ${DIM}# Create from existing image${NC}"
    echo "  container-create my-project ${USERNAME}-my-project-image"
    echo ""
    echo -e "  ${DIM}# Auto-detect image from name${NC}"
    echo "  container-create my-cv-project"
    echo ""
    echo -e "  ${DIM}# Create with 2 MIG instances${NC}"
    echo "  container-create training -n 2"
    echo ""
    echo -e "  ${DIM}# CPU-only for preprocessing${NC}"
    echo "  container-create preprocessing --cpu-only"
    echo ""
    echo -e "  ${DIM}# Custom workspace location${NC}"
    echo "  container-create analysis -w ~/projects/analysis"
    echo ""
    echo -e "${CYAN}How it works:${NC}"
    echo "  1. Checks your resource limits and GPU availability"
    echo "  2. Allocates GPU/MIG instances based on priority"
    echo "  3. Creates container with proper resource constraints"
    echo "  4. Mounts your workspace directory"
    echo ""
    echo -e "${YELLOW}üí° After creation:${NC}"
    echo -e "  ‚Ä¢ Start container: ${GREEN}container-run <name>${NC}"
    echo -e "  ‚Ä¢ View containers: ${GREEN}container-list${NC}"
    echo -e "  ‚Ä¢ Check resources: ${GREEN}container-stats${NC}"
    echo ""
}

check_gpu_availability() {
    local num_gpus="$1"

    if ! command -v nvidia-smi &> /dev/null; then
        return 1
    fi

    # Get user's max GPUs from config
    local max_gpus=1
    if [ -f "$RESOURCE_PARSER" ]; then
        max_gpus=$(python3 "$RESOURCE_PARSER" "$USERNAME" --max-mig-instances 2>/dev/null || echo "1")
    fi

    if [ "$num_gpus" -gt "$max_gpus" ]; then
        return 2
    fi

    return 0
}

get_user_limits() {
    if [ ! -f "$RESOURCE_PARSER" ]; then
        echo "--cpus=16 --memory=32g --shm-size=16g"
        return
    fi

    python3 "$RESOURCE_PARSER" "$USERNAME" --docker-args 2>/dev/null || echo "--cpus=16 --memory=32g --shm-size=16g"
}

format_size() {
    local size="$1"
    if [[ "$size" =~ ^[0-9]+$ ]]; then
        echo "${size}g"
    else
        echo "$size"
    fi
}

# Parse arguments
CONTAINER_NAME=""
IMAGE_NAME=""
REQUESTED_GPU=""
NUM_GPUS=1
CPU_ONLY=false
WORKSPACE_DIR=""
DATA_DIR=""
DRY_RUN=false

while [[ $# -gt 0 ]]; do
    case $1 in
        -g|--gpu)
            REQUESTED_GPU="$2"
            shift 2
            ;;
        -n|--num-gpus)
            NUM_GPUS="$2"
            shift 2
            ;;
        --cpu-only)
            CPU_ONLY=true
            shift
            ;;
        -w|--workspace)
            WORKSPACE_DIR="$2"
            shift 2
            ;;
        -d|--data)
            DATA_DIR="$2"
            shift 2
            ;;
        --dry-run)
            DRY_RUN=true
            shift
            ;;
        -h|--help)
            usage
            exit 0
            ;;
        -*)
            echo -e "${RED}‚úó Unknown option: $1${NC}\n"
            usage
            exit 1
            ;;
        *)
            if [ -z "$CONTAINER_NAME" ]; then
                CONTAINER_NAME="$1"
            elif [ -z "$IMAGE_NAME" ]; then
                IMAGE_NAME="$1"
            else
                echo -e "${RED}‚úó Too many arguments${NC}\n"
                usage
                exit 1
            fi
            shift
            ;;
    esac
done

# Validate container name
if [ -z "$CONTAINER_NAME" ]; then
    echo -e "${RED}‚úó Container name is required${NC}\n"
    usage
    exit 1
fi

# Sanitize container name
CONTAINER_NAME=$(echo "$CONTAINER_NAME" | tr ' ' '-' | tr '[:upper:]' '[:lower:]' | tr -cd '[:alnum:]-_')
CONTAINER_TAG="${CONTAINER_NAME}._.$USER_ID"

echo -e "${CYAN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
echo -e "${CYAN}${BOLD}    Container Creation${NC}"
echo -e "${CYAN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}\n"

# Check if container already exists
if docker ps -a --format "{{.Names}}" | grep -q "^${CONTAINER_TAG}$"; then
    echo -e "${RED}‚úó Container '$CONTAINER_NAME' already exists${NC}\n"
    echo -e "${BOLD}Options:${NC}"
    echo -e "  ‚Ä¢ View status: ${GREEN}container-list${NC}"
    echo -e "  ‚Ä¢ Start it:    ${GREEN}container-run $CONTAINER_NAME${NC}"
    echo -e "  ‚Ä¢ Remove it:   ${GREEN}container-cleanup $CONTAINER_NAME${NC}"
    echo ""
    exit 1
fi

# Auto-detect image if not specified
if [ -z "$IMAGE_NAME" ]; then
    # Try username-prefixed image
    CANDIDATE="${USERNAME}-${CONTAINER_NAME}"
    if docker images --format "{{.Repository}}" | grep -q "^${CANDIDATE}$"; then
        IMAGE_NAME="$CANDIDATE"
        echo -e "${GREEN}‚úì${NC} Auto-detected image: ${CYAN}$IMAGE_NAME${NC}"
    else
        echo -e "${YELLOW}‚ö†${NC} No image specified and couldn't auto-detect\n"
        echo -e "${BOLD}Your images:${NC}"
        docker images --format "  ‚Ä¢ {{.Repository}}" --filter "reference=${USERNAME}-*" | head -5
        echo ""
        read -p "Enter image name (or press Enter to create one): " IMAGE_NAME

        if [ -z "$IMAGE_NAME" ]; then
            echo -e "\n${CYAN}Let's create an image first...${NC}\n"
            exec "$SCRIPT_DIR/image-create" "$CONTAINER_NAME"
            exit $?
        fi
    fi
fi

# Set default workspace
if [ -z "$WORKSPACE_DIR" ]; then
    WORKSPACE_DIR="$HOME/workspace/$CONTAINER_NAME"
fi

# Create workspace if it doesn't exist
mkdir -p "$WORKSPACE_DIR"

echo -e "\n${BOLD}Configuration:${NC}"
echo -e "  Container:  ${CYAN}$CONTAINER_NAME${NC}"
echo -e "  Image:      ${CYAN}$IMAGE_NAME${NC}"
echo -e "  Workspace:  ${BLUE}$WORKSPACE_DIR${NC}"
if [ -n "$DATA_DIR" ]; then
    echo -e "  Data:       ${BLUE}$DATA_DIR${NC}"
fi

# Get resource limits
echo -e "\n${BOLD}Resource Allocation:${NC}"
LIMITS=$(get_user_limits)

# Parse limits for display
CPUS=$(echo "$LIMITS" | grep -oP '(?<=--cpus=)[^ ]+' || echo "16")
MEMORY=$(echo "$LIMITS" | grep -oP '(?<=--memory=)[^ ]+' || echo "32g")
SHM_SIZE=$(echo "$LIMITS" | grep -oP '(?<=--shm-size=)[^ ]+' || echo "16g")

echo -e "  CPUs:       ${GREEN}$CPUS cores${NC}"
echo -e "  Memory:     ${GREEN}$MEMORY${NC}"
echo -e "  Shared mem: ${GREEN}$SHM_SIZE${NC}"

# GPU allocation
if [ "$CPU_ONLY" = true ]; then
    echo -e "  GPU:        ${DIM}CPU-only mode${NC}"
    GPU_ARGS=""
else
    echo -e "  GPU:        ${GREEN}$NUM_GPUS MIG instance(s)${NC} ${DIM}(auto-allocated)${NC}"

    # Check GPU availability
    check_gpu_availability "$NUM_GPUS"
    GPU_CHECK=$?

    if [ $GPU_CHECK -eq 2 ]; then
        echo -e "\n${YELLOW}‚ö† Warning: Requesting $NUM_GPUS GPUs exceeds your limit${NC}"
        # Will be caught by allocation script
    fi

    GPU_ARGS="--gpus=1"  # Placeholder, actual allocation happens via gpu_allocator.py
fi

echo ""

# Dry run mode
if [ "$DRY_RUN" = true ]; then
    echo -e "${YELLOW}‚îÅ‚îÅ‚îÅ DRY RUN MODE ‚îÅ‚îÅ‚îÅ${NC}\n"
    echo -e "${BOLD}Would create container:${NC}"
    echo -e "  Full name: ${CYAN}$CONTAINER_TAG${NC}"
    echo -e "  Image:     ${CYAN}$IMAGE_NAME${NC}"
    echo ""
    echo -e "${BOLD}Docker command:${NC}"
    echo -e "  ${DIM}docker create \\"
    echo -e "    --name $CONTAINER_TAG \\"
    echo -e "    --user $USER_ID \\"
    echo -e "    $LIMITS \\"
    if [ -n "$GPU_ARGS" ]; then
        echo -e "    $GPU_ARGS \\"
    fi
    echo -e "    -v $WORKSPACE_DIR:/workspace \\"
    if [ -n "$DATA_DIR" ]; then
        echo -e "    -v $DATA_DIR:/data \\"
    fi
    echo -e "    $IMAGE_NAME${NC}"
    echo ""
    exit 0
fi

# Create container
echo -e "${CYAN}Creating container...${NC}"

# Build docker create command
DOCKER_CMD=(docker create)
DOCKER_CMD+=(--name "$CONTAINER_TAG")
DOCKER_CMD+=(--hostname "${CONTAINER_NAME}")
DOCKER_CMD+=(--user "$USER_ID")
DOCKER_CMD+=(-it)

# Add resource limits
for limit in $LIMITS; do
    case $limit in
        --cpus=*)
            DOCKER_CMD+=(--cpus="${limit#*=}")
            ;;
        --memory=*)
            DOCKER_CMD+=(--memory="${limit#*=}")
            ;;
        --memory-swap=*)
            DOCKER_CMD+=(--memory-swap="${limit#*=}")
            ;;
        --shm-size=*)
            DOCKER_CMD+=(--shm-size="${limit#*=}")
            ;;
        --pids-limit=*)
            DOCKER_CMD+=(--pids-limit="${limit#*=}")
            ;;
    esac
done

# Add GPU if not CPU-only
if [ "$CPU_ONLY" = false ]; then
    DOCKER_CMD+=(--gpus=1)  # Placeholder
fi

# Add volumes
DOCKER_CMD+=(-v "$WORKSPACE_DIR:/workspace")
if [ -n "$DATA_DIR" ]; then
    DOCKER_CMD+=(-v "$DATA_DIR:/data")
fi

# Mount init script for container setup
INIT_SCRIPT="$INFRA_ROOT/docker/container-init.sh"
if [ -f "$INIT_SCRIPT" ]; then
    DOCKER_CMD+=(-v "$INIT_SCRIPT:/usr/local/bin/ds01-init:ro")
fi

# Mount central alias configuration (single source of truth for all users)
ALIAS_CONFIG="$INFRA_ROOT/../config/container-aliases.sh"
if [ -f "$ALIAS_CONFIG" ]; then
    DOCKER_CMD+=(-v "$ALIAS_CONFIG:/etc/ds01/container-aliases.sh:ro")
fi

# Add labels
DOCKER_CMD+=(--label "ds01.user=$USERNAME")
DOCKER_CMD+=(--label "ds01.container=$CONTAINER_NAME")
DOCKER_CMD+=(--label "ds01.created=$(date -Iseconds)")

# Add image
DOCKER_CMD+=("$IMAGE_NAME")

# Create container
if "${DOCKER_CMD[@]}" > /dev/null 2>&1; then
    echo -e "${GREEN}‚úì${NC} Container created"
else
    echo -e "${RED}‚úó${NC} Container creation failed\n"
    echo -e "${BOLD}Troubleshooting:${NC}"
    echo -e "  ‚Ä¢ Check image exists: ${GREEN}image-list${NC}"
    echo -e "  ‚Ä¢ Verify Docker running: ${BLUE}docker info${NC}"
    echo -e "  ‚Ä¢ Check permissions: ${BLUE}groups | grep docker${NC}"
    exit 1
fi

# Save container metadata
mkdir -p "$HOME/ds01-config/containers"
cat > "$HOME/ds01-config/containers/${CONTAINER_NAME}.info" << INFOEOF
Container: $CONTAINER_NAME
Full Name: $CONTAINER_TAG
Image: $IMAGE_NAME
Workspace: $WORKSPACE_DIR
$([ -n "$DATA_DIR" ] && echo "Data: $DATA_DIR")
Created: $(date)
User: $USERNAME
INFOEOF

echo -e "${GREEN}‚úì${NC} Metadata saved"

echo ""
echo -e "${GREEN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
echo -e "${GREEN}${BOLD}    ‚úì Container Created Successfully!${NC}"
echo -e "${GREEN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}\n"

echo -e "${BOLD}Next Steps:${NC}"
echo -e "  ${GREEN}1.${NC} Start container:     ${GREEN}container-run $CONTAINER_NAME${NC}"
echo -e "  ${GREEN}2.${NC} View all containers: ${GREEN}container-list${NC}"
echo -e "  ${GREEN}3.${NC} Check resources:     ${GREEN}container-stats${NC}"
echo ""

echo -e "${BOLD}Your workspace:${NC}"
echo -e "  Host:      ${BLUE}$WORKSPACE_DIR${NC}"
echo -e "  Container: ${BLUE}/workspace${NC}"
echo ""

echo -e "${YELLOW}üí° Tip:${NC} Files in /workspace persist across container restarts"
echo ""
