#!/bin/bash
# Create custom Docker image for DS01
# Interactive wizard for building personalized ML/DL images

BLUE='\033[94m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m'

USERNAME=$(whoami)
USER_ID=$(id -u)
IMAGES_DIR="$HOME/docker-images"

usage() {
    echo ""
    echo -e "${BOLD}Docker Image Creator${NC}"
    echo ""
    echo -e "${CYAN}Usage:${NC}"
    echo "  image-create [image-name] [options]"
    echo ""
    echo -e "${CYAN}Options:${NC}"
    echo "  -f, --framework FRAMEWORK   Base framework (pytorch, tensorflow, jax)"
    echo "  -t, --type TYPE            Use case type (cv, nlp, rl, ml, custom)"
    echo "  -p, --packages PACKAGES    Additional Python packages (space-separated)"
    echo "  -s, --system PACKAGES      System packages via apt (space-separated)"
    echo "  --no-build                 Create Dockerfile only, don't build"
    echo "  --guided                   Show detailed explanations for beginners"
    echo "  -h, --help                 Show this help message"
    echo ""
    echo -e "${CYAN}Frameworks:${NC}"
    echo "  pytorch      PyTorch 2.5.1 + CUDA 11.8 (default)"
    echo "  tensorflow   TensorFlow 2.14.0 + CUDA 11.8"
    echo "  jax          JAX + CUDA"
    echo ""
    echo -e "${CYAN}Use Case Types:${NC}"
    echo "  cv       Computer Vision (includes: timm, albumentations, opencv)"
    echo "  nlp      Natural Language Processing (includes: transformers, datasets)"
    echo "  rl       Reinforcement Learning (includes: gymnasium, stable-baselines3)"
    echo "  ml       General ML (scikit-learn, xgboost, lightgbm)"
    echo "  custom   Specify all packages manually"
    echo ""
    echo -e "${CYAN}Examples:${NC}"
    echo "  image-create my-cv-project                    # Interactive mode"
    echo "  image-create thesis-model -f pytorch -t cv    # CV project with PyTorch"
    echo "  image-create nlp-exp -f pytorch -t nlp -p \"wandb optuna\"  # With extra packages"
    echo "  image-create custom-setup -t custom --no-build  # Just create Dockerfile"
    echo ""
    echo -e "${CYAN}Quick Start:${NC}"
    echo -e "  1. Run: ${GREEN}image-create my-project${NC}"
    echo "  2. Answer prompts to customize"
    echo "  3. Wait 3-5 minutes for build"
    echo -e "  4. Create container: ${GREEN}container-create my-project${NC}"
    echo ""
}

get_base_image() {
    local framework="$1"
    case $framework in
        tensorflow|tf)
            echo "tensorflow/tensorflow:2.14.0-gpu"
            ;;
        jax)
            echo "nvcr.io/nvidia/jax:23.10-py3"
            ;;
        pytorch-cpu)
            echo "pytorch/pytorch:2.5.1-cpu"
            ;;
        *)
            echo "pytorch/pytorch:2.5.1-cuda11.8-cudnn9-runtime"
            ;;
    esac
}

get_usecase_packages() {
    local usecase="$1"
    case $usecase in
        cv)
            echo "timm albumentations opencv-python-headless torchvision"
            ;;
        nlp)
            echo "transformers datasets tokenizers accelerate sentencepiece"
            ;;
        rl)
            echo "gymnasium stable-baselines3 tensorboard"
            ;;
        ml)
            echo "xgboost lightgbm catboost optuna"
            ;;
        *)
            echo ""
            ;;
    esac
}

interactive_mode() {
    echo -e "${CYAN}â”â”â” Image Creation Wizard â”â”â”${NC}\n"

    # Image name
    if [ -z "$IMAGE_NAME" ]; then
        read -p "Image name (e.g., my-project, thesis-cv): " IMAGE_NAME
        IMAGE_NAME=$(echo "$IMAGE_NAME" | tr ' ' '-' | tr '[:upper:]' '[:lower:]')
    fi
    FULL_IMAGE_NAME="${USERNAME}-${IMAGE_NAME}"

    # Check if exists
    if docker images --format "{{.Repository}}" | grep -q "^${FULL_IMAGE_NAME}$"; then
        echo -e "${YELLOW}âš  Image '$FULL_IMAGE_NAME' already exists${NC}"
        read -p "Overwrite? [y/N]: " OVERWRITE
        if [[ ! "$OVERWRITE" =~ ^[Yy]$ ]]; then
            echo "Cancelled."
            exit 0
        fi
    fi

    echo -e "\n${BOLD}Image will be named: ${CYAN}${FULL_IMAGE_NAME}${NC}\n"

    # Framework
    if [ -z "$FRAMEWORK" ]; then
        if [ "$GUIDED" = true ]; then
            echo -e "${BOLD}Choosing a Framework${NC}"
            echo ""
            echo "A framework is the foundation for your ML/DL work:"
            echo ""
            echo "â€¢ ${CYAN}PyTorch${NC} - Most popular, great community, PyTorch + torchvision"
            echo "  Used by: Most research, computer vision, NLP"
            echo ""
            echo "â€¢ ${CYAN}TensorFlow${NC} - Google's framework, production-ready"
            echo "  Used by: Industry applications, deployment"
            echo ""
            echo "â€¢ ${CYAN}JAX${NC} - High-performance, functional approach"
            echo "  Used by: Research, custom algorithms"
            echo ""
            echo "â€¢ ${CYAN}PyTorch CPU${NC} - No GPU, for testing or CPU-only work"
            echo ""
            echo -e "${YELLOW}ğŸ’¡ Recommendation:${NC} Choose PyTorch unless you have specific needs"
            echo ""
        fi

        echo "Select base framework:"
        echo -e "  ${BOLD}1)${NC} PyTorch 2.5.1 + CUDA 11.8 (${GREEN}recommended${NC})"
        echo -e "  ${BOLD}2)${NC} TensorFlow 2.14.0 + CUDA 11.8"
        echo -e "  ${BOLD}3)${NC} JAX + CUDA"
        echo -e "  ${BOLD}4)${NC} PyTorch CPU-only"
        read -p "Choice [1-4, default: 1]: " FW_CHOICE

        case $FW_CHOICE in
            2) FRAMEWORK="tensorflow" ;;
            3) FRAMEWORK="jax" ;;
            4) FRAMEWORK="pytorch-cpu" ;;
            *) FRAMEWORK="pytorch" ;;
        esac
    fi

    # Use case
    if [ -z "$USECASE" ]; then
        if [ "$GUIDED" = true ]; then
            echo ""
            echo -e "${BOLD}Choosing a Use Case${NC}"
            echo ""
            echo "This determines which specialized packages get installed:"
            echo ""
            echo "â€¢ ${CYAN}Computer Vision (CV)${NC} - Images, videos, object detection"
            echo "  Packages: timm, albumentations, opencv, torchvision"
            echo "  Example: Image classification, object detection, segmentation"
            echo ""
            echo "â€¢ ${CYAN}NLP${NC} - Text, language models, transformers"
            echo "  Packages: transformers, datasets, tokenizers, accelerate"
            echo "  Example: Text classification, translation, chatbots"
            echo ""
            echo "â€¢ ${CYAN}Reinforcement Learning${NC} - Agents, environments, decision making"
            echo "  Packages: gymnasium, stable-baselines3"
            echo "  Example: Game AI, robotics, optimization"
            echo ""
            echo "â€¢ ${CYAN}General ML${NC} - Traditional ML, tabular data, boosting"
            echo "  Packages: scikit-learn, xgboost, lightgbm"
            echo "  Example: Classification, regression, feature engineering"
            echo ""
            echo -e "${YELLOW}ğŸ’¡ Note:${NC} All options include: numpy, pandas, matplotlib, jupyter"
            echo ""
        fi

        echo -e "\n${BOLD}Select use case:${NC}"
        echo -e "  ${BOLD}1)${NC} Computer Vision (timm, albumentations, opencv)"
        echo -e "  ${BOLD}2)${NC} NLP (transformers, datasets, tokenizers)"
        echo -e "  ${BOLD}3)${NC} Reinforcement Learning (gymnasium, stable-baselines3)"
        echo -e "  ${BOLD}4)${NC} General ML (scikit-learn, xgboost, lightgbm) (${GREEN}default${NC})"
        echo -e "  ${BOLD}5)${NC} Custom (specify everything)"
        read -p "Choice [1-5, default: 4]: " UC_CHOICE

        case $UC_CHOICE in
            1) USECASE="cv" ;;
            2) USECASE="nlp" ;;
            3) USECASE="rl" ;;
            5) USECASE="custom" ;;
            *) USECASE="ml" ;;
        esac
    fi

    # Additional packages
    if [ -z "$ADDITIONAL_PACKAGES" ]; then
        echo -e "\n${BOLD}Additional Python packages?${NC} (space-separated, or press Enter to skip)"
        echo "Examples: wandb optuna pytorch-lightning tensorboardX"
        read -p "> " ADDITIONAL_PACKAGES
    fi

    # System packages
    if [ -z "$SYSTEM_PACKAGES" ]; then
        echo -e "\n${BOLD}System packages (apt)?${NC} (or press Enter to skip)"
        echo "Examples: htop tmux vim git-lfs"
        read -p "> " SYSTEM_PACKAGES
    fi
}

create_dockerfile() {
    local image_name="$1"
    local framework="$2"
    local usecase="$3"
    local additional="$4"
    local system_pkgs="$5"

    local base_image=$(get_base_image "$framework")
    local usecase_packages=$(get_usecase_packages "$usecase")

    mkdir -p "$IMAGES_DIR"
    local dockerfile="$IMAGES_DIR/${image_name}.Dockerfile"

    cat > "$dockerfile" << DOCKERFILEEOF
# DS01 Custom Image: $image_name
# Created: $(date)
# Framework: $framework
# Use case: $usecase
# Author: $USERNAME

FROM $base_image

LABEL maintainer="$USERNAME"
LABEL ds01.image="$image_name"
LABEL ds01.framework="$framework"
LABEL ds01.created="$(date -Iseconds)"

WORKDIR /workspace

# System packages
RUN apt-get update && apt-get install -y --no-install-recommends \\
    git \\
    curl \\
    wget \\
    vim \\
    htop \\
    $([ -n "$system_pkgs" ] && echo "$system_pkgs \\")
    && rm -rf /var/lib/apt/lists/*

# Core Python packages
RUN pip install --no-cache-dir \\
    jupyter \\
    jupyterlab \\
    ipykernel \\
    ipywidgets \\
    numpy \\
    pandas \\
    matplotlib \\
    seaborn \\
    scikit-learn \\
    scipy \\
    tqdm \\
    tensorboard \\
    Pillow

$([ -n "$usecase_packages" ] && echo "# Use case specific packages
RUN pip install --no-cache-dir $usecase_packages")

$([ -n "$additional" ] && echo "# Additional user packages
RUN pip install --no-cache-dir $additional")

# Configure Jupyter
RUN jupyter lab --generate-config && \\
    echo "c.ServerApp.ip = '0.0.0.0'" >> /root/.jupyter/jupyter_lab_config.py && \\
    echo "c.ServerApp.allow_root = True" >> /root/.jupyter/jupyter_lab_config.py && \\
    echo "c.ServerApp.open_browser = False" >> /root/.jupyter/jupyter_lab_config.py && \\
    echo "c.ServerApp.token = ''" >> /root/.jupyter/jupyter_lab_config.py && \\
    echo "c.ServerApp.password = ''" >> /root/.jupyter/jupyter_lab_config.py

# IPython kernel
RUN python -m ipykernel install --user \\
    --name=$image_name \\
    --display-name="$image_name ($framework)"

# Environment variables
ENV PYTHONUNBUFFERED=1
ENV CUDA_DEVICE_ORDER=PCI_BUS_ID
ENV HF_HOME=/workspace/.cache/huggingface
ENV TORCH_HOME=/workspace/.cache/torch
ENV MPLCONFIGDIR=/workspace/.cache/matplotlib

CMD ["/bin/bash"]
DOCKERFILEEOF

    echo "$dockerfile"
}

# Parse arguments
IMAGE_NAME=""
FRAMEWORK=""
USECASE=""
ADDITIONAL_PACKAGES=""
SYSTEM_PACKAGES=""
NO_BUILD=false
GUIDED=false

while [[ $# -gt 0 ]]; do
    case $1 in
        -f|--framework)
            FRAMEWORK="$2"
            shift 2
            ;;
        -t|--type)
            USECASE="$2"
            shift 2
            ;;
        -p|--packages)
            ADDITIONAL_PACKAGES="$2"
            shift 2
            ;;
        -s|--system)
            SYSTEM_PACKAGES="$2"
            shift 2
            ;;
        --no-build)
            NO_BUILD=true
            shift
            ;;
        --guided)
            GUIDED=true
            shift
            ;;
        -h|--help|--info)
            usage
            exit 0
            ;;
        -*)
            echo -e "${RED}Unknown option: $1${NC}\n"
            usage
            exit 1
            ;;
        *)
            if [ -z "$IMAGE_NAME" ]; then
                IMAGE_NAME="$1"
            else
                echo -e "${RED}Multiple image names specified${NC}\n"
                usage
                exit 1
            fi
            shift
            ;;
    esac
done

# Show guided introduction
if [ "$GUIDED" = true ]; then
    echo ""
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${BOLD}Docker Image Creation - Guided Mode${NC}"
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
    echo -e "${BOLD}What is a Docker Image?${NC}"
    echo ""
    echo "  A Docker image is a blueprint for your computing environment:"
    echo "  â€¢ Contains operating system (Ubuntu Linux)"
    echo "  â€¢ Pre-installed software (Python, PyTorch, TensorFlow, etc.)"
    echo "  â€¢ All libraries and dependencies"
    echo "  â€¢ Configuration and settings"
    echo ""
    echo -e "${BOLD}Why Create a Custom Image?${NC}"
    echo ""
    echo "  You create an image to:"
    echo "  â€¢ Install specific Python packages you need"
    echo "  â€¢ Set up your preferred ML/DL framework version"
    echo "  â€¢ Include domain-specific libraries (CV, NLP, RL)"
    echo "  â€¢ Save time - install once, use many times"
    echo ""
    echo -e "${BOLD}Image vs Container:${NC}"
    echo ""
    echo "  â€¢ ${CYAN}Image${NC} = Blueprint (like a recipe)"
    echo "  â€¢ ${CYAN}Container${NC} = Running instance (like the cooked dish)"
    echo "  â€¢ One image can create many containers"
    echo "  â€¢ Containers inherit everything from the image"
    echo ""
    echo -e "${BOLD}The Process:${NC}"
    echo ""
    echo "  1. Choose base framework (PyTorch, TensorFlow, JAX)"
    echo "  2. Select use case (CV, NLP, RL, or general ML)"
    echo "  3. Add extra packages if needed"
    echo "  4. Build image (takes 3-5 minutes)"
    echo "  5. Create containers from this image"
    echo ""
    echo -e "${YELLOW}ğŸ’¡ Pro Tip:${NC} Start with a simple setup first."
    echo "   You can always create more specialized images later!"
    echo ""
    read -p "Press Enter to start creating your image..." </dev/tty
    echo ""
fi

# Interactive mode if missing info
if [ -z "$IMAGE_NAME" ] || [ -z "$FRAMEWORK" ] || [ -z "$USECASE" ]; then
    interactive_mode
else
    # Non-interactive: sanitize image name
    IMAGE_NAME=$(echo "$IMAGE_NAME" | tr ' ' '-' | tr '[:upper:]' '[:lower:]')
    FULL_IMAGE_NAME="${USERNAME}-${IMAGE_NAME}"
fi

# Create Dockerfile
echo -e "\n${CYAN}Creating Dockerfile...${NC}"
DOCKERFILE=$(create_dockerfile "$FULL_IMAGE_NAME" "$FRAMEWORK" "$USECASE" "$ADDITIONAL_PACKAGES" "$SYSTEM_PACKAGES")
echo -e "${GREEN}âœ“${NC} Dockerfile created: ${BLUE}$DOCKERFILE${NC}\n"

# Guided explanation of Dockerfile
if [ "$GUIDED" = true ]; then
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${BOLD}What is a Dockerfile?${NC}"
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
    echo "A Dockerfile is a recipe for building your image:"
    echo ""
    echo "  â€¢ ${CYAN}FROM${NC} - Start with a base image (PyTorch, TensorFlow, etc.)"
    echo "  â€¢ ${CYAN}RUN${NC} - Execute commands (install packages, configure)"
    echo "  â€¢ ${CYAN}ENV${NC} - Set environment variables"
    echo "  â€¢ ${CYAN}WORKDIR${NC} - Set working directory"
    echo ""
    echo "Your Dockerfile is saved at:"
    echo -e "  ${BLUE}$DOCKERFILE${NC}"
    echo ""
    echo "You can edit it later to:"
    echo "  â€¢ Add more packages"
    echo "  â€¢ Change configurations"
    echo "  â€¢ Install system tools"
    echo ""
    echo -e "Then rebuild with: ${GREEN}image-update $FULL_IMAGE_NAME${NC}"
    echo ""
    echo -e "${BOLD}Now Building the Image${NC}"
    echo ""
    echo "This will:"
    echo "  1. Download base image (~2 GB)"
    echo "  2. Install all packages"
    echo "  3. Configure Jupyter and Python"
    echo "  4. Save final image (~4-5 GB)"
    echo ""
    echo "Time: 3-5 minutes (depending on packages and network)"
    echo ""
    read -p "Press Enter to start the build..." </dev/tty
    echo ""
fi

# Build image
if [ "$NO_BUILD" = false ]; then
    echo -e "${CYAN}Building image... (this takes 3-5 minutes)${NC}\n"

    if docker build -t "$FULL_IMAGE_NAME" -f "$DOCKERFILE" "$IMAGES_DIR/"; then
        echo -e "\n${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
        echo -e "${GREEN}${BOLD}âœ“ Image built successfully!${NC}"
        echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}\n"

        # Save metadata
        mkdir -p "$HOME/ds01-config/images"
        cat > "$HOME/ds01-config/images/${FULL_IMAGE_NAME}.info" << INFOEOF
Image: $FULL_IMAGE_NAME
Framework: $FRAMEWORK
Use Case: $USECASE
Created: $(date)
Dockerfile: $DOCKERFILE

Packages:
$([ -n "$(get_usecase_packages $USECASE)" ] && echo "- Use case: $(get_usecase_packages $USECASE)")
$([ -n "$ADDITIONAL_PACKAGES" ] && echo "- Additional: $ADDITIONAL_PACKAGES")
$([ -n "$SYSTEM_PACKAGES" ] && echo "- System: $SYSTEM_PACKAGES")
INFOEOF

        if [ "$GUIDED" = true ]; then
            echo ""
            echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
            echo -e "${BOLD}Image Created Successfully!${NC}"
            echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
            echo ""
            echo -e "${BOLD}What Just Happened?${NC}"
            echo ""
            echo "  âœ“ Downloaded base image with $FRAMEWORK"
            echo "  âœ“ Installed all requested packages"
            echo "  âœ“ Configured Jupyter Lab"
            echo "  âœ“ Set up Python environment"
            echo "  âœ“ Saved image: ${CYAN}$FULL_IMAGE_NAME${NC}"
            echo ""
            echo -e "${BOLD}What Can You Do Now?${NC}"
            echo ""
            echo "  ${BOLD}1) View your images:${NC}"
            echo -e "     ${GREEN}image-list${NC}"
            echo "     See all available Docker images"
            echo ""
            echo "  ${BOLD}2) Create a container from this image:${NC}"
            echo -e "     ${GREEN}container-create $IMAGE_NAME${NC}"
            echo "     This creates a running environment from your image"
            echo ""
            echo "  ${BOLD}3) Start and enter the container:${NC}"
            echo -e "     ${GREEN}container-run $IMAGE_NAME${NC}"
            echo "     Opens a shell inside the container"
            echo ""
            echo -e "${BOLD}Remember:${NC}"
            echo "  â€¢ ${CYAN}Image${NC} = Blueprint (what you just created)"
            echo "  â€¢ ${CYAN}Container${NC} = Running instance (what you'll work in)"
            echo "  â€¢ One image can create many containers"
            echo ""
            echo -e "${BOLD}Updating the Image Later:${NC}"
            echo ""
            echo "  If you need to add more packages:"
            echo -e "  1. Edit Dockerfile: ${GREEN}vim $DOCKERFILE${NC}"
            echo -e "  2. Rebuild image: ${GREEN}image-update $FULL_IMAGE_NAME${NC}"
            echo ""
        else
            echo -e "${BOLD}Next Steps:${NC}"
            echo -e "  1. List images:       ${GREEN}image-list${NC}"
            echo -e "  2. Create container:  ${GREEN}container-create $IMAGE_NAME${NC}"
            echo -e "  3. Start container:   ${GREEN}container-run $IMAGE_NAME${NC}"
            echo ""
            echo -e "${YELLOW}ğŸ’¡ Update packages: Edit ${BLUE}$DOCKERFILE${NC}"
            echo -e "   ${YELLOW}Then rebuild: ${GREEN}image-update $FULL_IMAGE_NAME${NC}"
        fi
    else
        echo -e "\n${RED}âœ— Build failed${NC}"
        echo "Check Dockerfile: $DOCKERFILE"
        exit 1
    fi
else
    echo -e "${YELLOW}Build skipped (--no-build)${NC}"
    echo "Build later with: ${GREEN}docker build -t $FULL_IMAGE_NAME -f $DOCKERFILE $IMAGES_DIR/${NC}"
fi

echo ""
