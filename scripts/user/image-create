#!/bin/bash
# Create custom Docker image for DS01
# Interactive wizard for building personalized ML/DL images

BLUE='\033[94m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m'

USERNAME=$(whoami)
USER_ID=$(id -u)
DOCKERFILES_DIR="$HOME/dockerfiles"
PROJECT_DOCKERFILE=false

usage() {
    echo ""
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${BOLD}Docker Image Creator${NC}"
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
    echo -e "${CYAN}Usage:${NC}"
    echo "  image-create [image-name] [options]"
    echo ""
    echo -e "${CYAN}Options:${NC}"
    echo "  -f, --framework FRAMEWORK   Base framework (pytorch, tensorflow, jax)"
    echo "  -t, --type TYPE            Use case type (cv, nlp, rl, ml, custom)"
    echo "  -p, --packages PACKAGES    Additional Python packages (space-separated)"
    echo "  -s, --system PACKAGES      System packages via apt (space-separated)"
    echo "  --project-dockerfile       Store Dockerfile in project dir (~/workspace/<project>/)"
    echo "  --no-build                 Create Dockerfile only, don't build image"
    echo "  --guided                   Show detailed explanations for beginners"
    echo "  -h, --help                 Show this help message"
    echo ""
    echo -e "${CYAN}Frameworks:${NC}"
    echo "  pytorch      PyTorch 2.5.1 + CUDA 11.8 (default)"
    echo "  tensorflow   TensorFlow 2.14.0 + CUDA 11.8"
    echo "  jax          JAX + CUDA"
    echo ""
    echo -e "${CYAN}Use Case Types:${NC}"
    echo "  cv       Computer Vision (includes: timm, albumentations, opencv)"
    echo "  nlp      Natural Language Processing (includes: transformers, datasets)"
    echo "  rl       Reinforcement Learning (includes: gymnasium, stable-baselines3)"
    echo "  ml       General ML (scikit-learn, xgboost, lightgbm)"
    echo "  custom   Specify all packages manually"
    echo ""
    echo -e "${CYAN}Examples:${NC}"
    echo "  image-create my-cv-project                    # Interactive mode"
    echo "  image-create thesis-model -f pytorch -t cv    # CV project with PyTorch"
    echo "  image-create nlp-exp -f pytorch -t nlp -p \"wandb optuna\"  # With extra packages"
    echo "  image-create custom-setup -t custom --no-build  # Just create Dockerfile"
    echo ""
    echo -e "${CYAN}Quick Start:${NC}"
    echo -e "  1. Run: ${GREEN}image-create my-project${NC}"
    echo "  2. Answer prompts to customize"
    echo "  3. Wait a few minutes for build"
    echo -e "  4. Create container: ${GREEN}container-create my-project${NC}"
    echo ""
}

get_base_image() {
    local framework="$1"
    local custom_image="$2"
    case $framework in
        tensorflow|tf)
            echo "tensorflow/tensorflow:2.14.0-gpu"
            ;;
        jax)
            echo "nvcr.io/nvidia/jax:23.10-py3"
            ;;
        pytorch-cpu)
            echo "pytorch/pytorch:2.5.1-cpu"
            ;;
        custom)
            echo "$custom_image"
            ;;
        *)
            echo "pytorch/pytorch:2.5.1-cuda11.8-cudnn9-runtime"
            ;;
    esac
}

get_base_packages() {
    # Core data science packages installed by default
    echo "jupyter jupyterlab ipykernel ipywidgets numpy pandas matplotlib seaborn scikit-learn scipy tqdm tensorboard Pillow python-dotenv"
}

check_user_limits() {
    # Check user's resource limits and provide helpful information
    local limits_script="/opt/ds01-infra/scripts/docker/get_resource_limits.py"

    if [ ! -f "$limits_script" ]; then
        # Silently skip if script not available
        return 0
    fi

    # Get user's limits
    local limit_info=$(python3 "$limits_script" "$USERNAME" 2>/dev/null)

    if [ $? -eq 0 ] && [ -n "$limit_info" ]; then
        # Parse limits from the formatted output
        local group=$(echo "$limit_info" | head -1 | sed -n 's/.*group: \([^)]*\).*/\1/p')
        local max_containers=$(echo "$limit_info" | grep "Max containers:" | awk '{print $NF}')
        local max_gpus=$(echo "$limit_info" | grep "Max GPUs (simultaneous):" | awk '{print $NF}')

        # Count current containers
        local current_containers=$(docker ps -a --filter "label=maintainer=$USERNAME" --format "{{.ID}}" 2>/dev/null | wc -l)

        # Only show if we got valid data
        if [ -n "$group" ] && [ -n "$max_containers" ]; then
            echo ""
            echo -e "${CYAN}â”â”â” Your Resource Limits â”â”â”${NC}"
            echo ""
            echo -e "${BOLD}Group:${NC} $group"
            echo -e "${BOLD}Max Containers:${NC} $max_containers (currently have: $current_containers)"
            echo -e "${BOLD}Max GPUs/MIGs:${NC} $max_gpus"
            echo ""

            # Warning if approaching limits
            if [ "$max_containers" != "unlimited" ] && [ "$current_containers" -ge "$max_containers" ] 2>/dev/null; then
                echo -e "${RED}âš  WARNING: Container Limit Reached${NC}"
                echo ""
                echo "You already have $current_containers containers (limit: $max_containers)."
                echo "You won't be able to create a new container from this image"
                echo "until you stop/remove an existing container."
                echo ""
                echo -e "View containers: ${GREEN}container-list${NC}"
                echo -e "Stop container:  ${GREEN}container-stop <name>${NC}"
                echo -e "Remove container: ${GREEN}container-cleanup <name>${NC}"
                echo ""
                read -p "Continue creating image anyway? [y/N]: " CONTINUE
                if [[ ! "$CONTINUE" =~ ^[Yy]$ ]]; then
                    echo "Cancelled."
                    exit 0
                fi
            elif [ "$max_containers" != "unlimited" ] && [ "$current_containers" -ge $((max_containers - 1)) ] 2>/dev/null; then
                echo -e "${YELLOW}âš  Note: You're at $current_containers/$max_containers containers.${NC}"
                echo "  You can create this image, but may need to stop a container"
                echo "  before creating a new one from it."
                echo ""
            fi

            # Info about GPU-based images
            if [ "$FRAMEWORK" != "pytorch-cpu" ] && [ "$FRAMEWORK" != "custom" ]; then
                echo -e "${BOLD}GPU Access:${NC}"
                echo "  This image includes CUDA/GPU support."
                if [ "$max_gpus" = "unlimited" ]; then
                    echo "  You have unlimited GPU access."
                else
                    echo "  You can allocate up to $max_gpus GPU(s) across all containers."
                fi
                echo ""
            fi
        fi
    fi
}

get_usecase_packages() {
    local usecase="$1"
    case $usecase in
        cv)
            echo "timm albumentations opencv-python-headless torchvision"
            ;;
        nlp)
            echo "transformers datasets tokenizers accelerate sentencepiece"
            ;;
        rl)
            echo "gymnasium stable-baselines3 tensorboard"
            ;;
        ml)
            echo "xgboost lightgbm catboost optuna"
            ;;
        *)
            echo ""
            ;;
    esac
}

interactive_mode() {
    echo -e "${CYAN}â”â”â” Image Creation Wizard â”â”â”${NC}\n"

    # Image name
    if [ -z "$IMAGE_NAME" ]; then
        read -p "Image name (e.g., my-project, thesis-cv): " IMAGE_NAME
        IMAGE_NAME=$(echo "$IMAGE_NAME" | tr ' ' '-' | tr '[:upper:]' '[:lower:]')
    fi
    FULL_IMAGE_NAME="${IMAGE_NAME}-${USERNAME}"

    # Check if exists
    if docker images --format "{{.Repository}}" | grep -q "^${FULL_IMAGE_NAME}$"; then
        echo -e "${YELLOW}âš  Image '$FULL_IMAGE_NAME' already exists${NC}"
        read -p "Overwrite? [y/N]: " OVERWRITE
        if [[ ! "$OVERWRITE" =~ ^[Yy]$ ]]; then
            echo "Cancelled."
            exit 0
        fi
    fi

    echo -e "\n${BOLD}Image will be named: ${CYAN}${FULL_IMAGE_NAME}${NC}\n"

    # Framework
    if [ -z "$FRAMEWORK" ]; then
        if [ "$GUIDED" = true ]; then
            echo -e "${BOLD}Choosing a Framework${NC}"
            echo ""
            echo "A framework is the foundation for your ML/DL work:"
            echo ""
            echo "â€¢ ${CYAN}PyTorch${NC} - Most popular, great community, PyTorch + torchvision"
            echo "  Used by: Most research, computer vision, NLP"
            echo ""
            echo "â€¢ ${CYAN}TensorFlow${NC} - Google's framework, production-ready"
            echo "  Used by: Industry applications, deployment"
            echo ""
            echo "â€¢ ${CYAN}JAX${NC} - High-performance, functional approach"
            echo "  Used by: Research, custom algorithms"
            echo ""
            echo "â€¢ ${CYAN}PyTorch CPU${NC} - No GPU, for testing or CPU-only work"
            echo ""
            echo "â€¢ ${CYAN}Custom${NC} - Specify your own base image (advanced)"
            echo "  Use any Docker image as base (e.g., ubuntu:22.04, python:3.11)"
            echo ""
            echo -e "${YELLOW}ğŸ’¡ Recommendation:${NC} Choose PyTorch unless you have specific needs"
            echo ""
        fi

        echo -e "${BOLD}Select base framework:${NC}"
        echo -e "  ${BOLD}1)${NC} PyTorch 2.5.1 + CUDA 11.8 (${GREEN}recommended${NC})"
        echo -e "  ${BOLD}2)${NC} TensorFlow 2.14.0 + CUDA 11.8"
        echo -e "  ${BOLD}3)${NC} JAX + CUDA"
        echo -e "  ${BOLD}4)${NC} PyTorch CPU-only"
        echo -e "  ${BOLD}5)${NC} Custom (specify base image)"
        read -p "Choice [1-5, default: 1]: " FW_CHOICE

        case $FW_CHOICE in
            2) FRAMEWORK="tensorflow" ;;
            3) FRAMEWORK="jax" ;;
            4) FRAMEWORK="pytorch-cpu" ;;
            5)
                FRAMEWORK="custom"
                echo ""
                echo -e "${BOLD}Custom Base Image${NC}"
                echo "Enter Docker image (e.g., ubuntu:22.04, python:3.11-slim, nvidia/cuda:12.0-runtime)"
                read -p "> " CUSTOM_BASE_IMAGE
                if [ -z "$CUSTOM_BASE_IMAGE" ]; then
                    echo -e "${RED}Error: Base image cannot be empty${NC}"
                    exit 1
                fi
                echo -e "${YELLOW}âš  Custom base: No default packages will be installed${NC}"
                SKIP_BASE_PACKAGES=true
                ;;
            *) FRAMEWORK="pytorch" ;;
        esac
    fi

    # Base packages selection (new tier)
    if [ -z "$BASE_PACKAGES_CHOICE" ] && [ "$SKIP_BASE_PACKAGES" != true ]; then
        if [ "$GUIDED" = true ]; then
            echo ""
            echo -e "${BOLD}Base Data Science Packages${NC}"
            echo ""
            echo "These are core packages used in most data science workflows:"
            echo ""
            echo "  ${CYAN}Default packages:${NC}"
            echo "  â€¢ Jupyter Lab (interactive notebooks)"
            echo "  â€¢ NumPy, Pandas (data manipulation)"
            echo "  â€¢ Matplotlib, Seaborn (visualization)"
            echo "  â€¢ Scikit-learn (traditional ML)"
            echo "  â€¢ TensorBoard (experiment tracking)"
            echo ""
            echo -e "${YELLOW}ğŸ’¡ Recommendation:${NC} Install defaults unless you need minimal setup"
            echo ""
        fi

        echo -e "\n${BOLD}Install base data science Python packages? (jupyter, ipykernel, etc.) ${NC}"
        echo -e "  ${BOLD}1)${NC} Yes - Install defaults (${GREEN}recommended${NC})"
        echo -e "  ${BOLD}2)${NC} No - Skip Python base packages"
        echo -e "  ${BOLD}3)${NC} Custom - Specify base Python packages manually"
        read -p "Choice [1-3, default: 1]: " BASE_PKG_CHOICE

        case $BASE_PKG_CHOICE in
            2)
                BASE_PACKAGES_CHOICE="skip"
                echo -e "${YELLOW}âš  Skipping base packages${NC}"
                ;;
            3)
                BASE_PACKAGES_CHOICE="custom"
                echo ""
                echo -e "${BOLD}Specify base Python packages:${NC} (space-separated)"
                read -p "> " CUSTOM_BASE_PACKAGES
                ;;
            *)
                BASE_PACKAGES_CHOICE="default"
                ;;
        esac
    fi

    # Use case
    if [ -z "$USECASE" ] && [ "$SKIP_BASE_PACKAGES" != true ]; then
        if [ "$GUIDED" = true ]; then
            echo ""
            echo -e "${BOLD}Choosing a Use Case${NC}"
            echo ""
            echo "This determines which specialized packages get installed:"
            echo ""
            echo "â€¢ ${CYAN}Computer Vision (CV)${NC} - Images, videos, object detection"
            echo "  Packages: timm, albumentations, opencv, torchvision"
            echo "  Example: Image classification, object detection, segmentation"
            echo ""
            echo "â€¢ ${CYAN}NLP${NC} - Text, language models, transformers"
            echo "  Packages: transformers, datasets, tokenizers, accelerate"
            echo "  Example: Text classification, translation, chatbots"
            echo ""
            echo "â€¢ ${CYAN}Reinforcement Learning${NC} - Agents, environments, decision making"
            echo "  Packages: gymnasium, stable-baselines3"
            echo "  Example: Game AI, robotics, optimization"
            echo ""
            echo "â€¢ ${CYAN}General ML${NC} - Advanced ML with boosting algorithms"
            echo "  Packages: xgboost, lightgbm, catboost, optuna"
            echo "  Example: Classification, regression, hyperparameter tuning"
            echo ""
            echo "â€¢ ${CYAN}Custom${NC} - Skip use case packages or specify manually"
            echo ""
        fi

        echo -e "\n${BOLD}Select use case (additional domain-specific packages):${NC}"
        echo -e "  ${BOLD}1)${NC} None/Custom (skip or specify manually)"
        echo -e "  ${BOLD}2)${NC} General ML (xgboost, lightgbm, catboost) (${GREEN}default${NC})"
        echo -e "  ${BOLD}3)${NC} Computer Vision (timm, albumentations, opencv)"
        echo -e "  ${BOLD}4)${NC} NLP (transformers, datasets, tokenizers)"
        echo -e "  ${BOLD}5)${NC} Reinforcement Learning (gymnasium, stable-baselines3)"

        read -p "Choice [1-5, default: 2]: " UC_CHOICE

        case $UC_CHOICE in
            1)
                USECASE="custom"
                echo ""
                echo -e "${BOLD}Custom Use Case Packages${NC}"
                echo "Specify packages (space-separated), or press Enter to skip:"
                read -p "> " CUSTOM_USECASE_PACKAGES
                ;;
            3) USECASE="cv" ;;
            4) USECASE="nlp" ;;
            5) USECASE="rl" ;;
            2|"") USECASE="ml" ;;
            *)
                echo "Invalid choice. Setting to default: General ML."
                USECASE="ml"
                ;;
        esac
    fi

    # Display included packages before asking for additional
    if [ "$SKIP_BASE_PACKAGES" != true ]; then
        echo ""
        echo -e "${CYAN}â”â”â” Packages To Be Installed â”â”â”${NC}"
        echo ""

        # Base packages
        if [ "$BASE_PACKAGES_CHOICE" = "default" ] || [ -z "$BASE_PACKAGES_CHOICE" ]; then
            echo -e "${BOLD}Base Packages:${NC}"
            echo "  jupyter, jupyterlab, ipykernel, numpy, pandas, matplotlib,"
            echo "  seaborn, scikit-learn, scipy, tqdm, tensorboard, Pillow"
            echo ""
        elif [ "$BASE_PACKAGES_CHOICE" = "custom" ]; then
            echo -e "${BOLD}Base Packages (custom):${NC}"
            echo "  $CUSTOM_BASE_PACKAGES"
            echo ""
        fi

        # Use case packages
        if [ "$USECASE" != "custom" ] && [ -n "$USECASE" ]; then
            local uc_pkgs=$(get_usecase_packages "$USECASE")
            if [ -n "$uc_pkgs" ]; then
                echo -e "${BOLD}Use Case Packages ($USECASE):${NC}"
                echo "  $uc_pkgs"
                echo ""
            fi
        elif [ "$USECASE" = "custom" ] && [ -n "$CUSTOM_USECASE_PACKAGES" ]; then
            echo -e "${BOLD}Use Case Packages (custom):${NC}"
            echo "  $CUSTOM_USECASE_PACKAGES"
            echo ""
        fi
    fi

    # Additional packages
    if [ -z "$ADDITIONAL_PACKAGES" ]; then
        echo -e "${BOLD}Additional Python packages?${NC} (space-separated, or press Enter to skip)"
        echo "Examples: wandb optuna pytorch-lightning tensorboardX"
        read -p "> " ADDITIONAL_PACKAGES
    fi

    # System packages
    if [ -z "$SYSTEM_PACKAGES" ]; then
        echo -e "\n${BOLD}System packages (apt)?${NC} (or press Enter to skip)"
        echo "Examples: htop tmux vim git-lfs"
        read -p "> " SYSTEM_PACKAGES
    fi
}

create_dockerfile() {
    local image_name="$1"
    local framework="$2"
    local usecase="$3"
    local additional="$4"
    local system_pkgs="$5"
    local custom_base="$6"
    local base_pkg_choice="$7"
    local custom_base_pkgs="$8"
    local custom_usecase_pkgs="$9"
    local skip_base="${10}"

    local base_image=$(get_base_image "$framework" "$custom_base")
    local usecase_packages=$(get_usecase_packages "$usecase")

    # Handle custom use case packages
    if [ "$usecase" = "custom" ] && [ -n "$custom_usecase_pkgs" ]; then
        usecase_packages="$custom_usecase_pkgs"
    elif [ "$usecase" = "custom" ]; then
        usecase_packages=""
    fi

    # Determine Dockerfile location based on flag
    local dockerfile_dir="$DOCKERFILES_DIR"
    if [ "$PROJECT_DOCKERFILE" = true ] && [ -n "$PROJECT_DIR" ]; then
        dockerfile_dir="$PROJECT_DIR"
    fi

    mkdir -p "$dockerfile_dir"
    local dockerfile="$dockerfile_dir/${image_name}.Dockerfile"

    cat > "$dockerfile" << DOCKERFILEEOF
# DS01 Custom Image: $image_name
# Created: $(date)
# Framework: $framework
# Use case: $usecase
# Author: $USERNAME

FROM $base_image

LABEL maintainer="$USERNAME"
LABEL maintainer.id="$USER_ID"
LABEL ds01.image="$image_name"
LABEL ds01.framework="$framework"
LABEL ds01.created="$(date -Iseconds)"

WORKDIR /workspace

DOCKERFILEEOF

    # Only add system packages and Python packages if not using fully custom base
    if [ "$skip_base" != true ]; then
        cat >> "$dockerfile" << DOCKERFILEEOF
# System packages
RUN apt-get update && apt-get install -y --no-install-recommends \\
    git \\
    curl \\
    wget \\
    vim \\
    htop \\
    $([ -n "$system_pkgs" ] && echo "$system_pkgs \\")
    && rm -rf /var/lib/apt/lists/*

DOCKERFILEEOF

        # Base Python packages
        if [ "$base_pkg_choice" = "skip" ]; then
            echo "# Base packages skipped by user" >> "$dockerfile"
        elif [ "$base_pkg_choice" = "custom" ] && [ -n "$custom_base_pkgs" ]; then
            # Convert custom packages to multi-line format
            echo "# Core Python packages" >> "$dockerfile"
            echo "RUN pip install --no-cache-dir \\" >> "$dockerfile"
            local pkg_array=($custom_base_pkgs)
            local pkg_count=${#pkg_array[@]}
            local i=0
            for pkg in "${pkg_array[@]}"; do
                ((i++))
                if [ $i -lt $pkg_count ]; then
                    echo "    $pkg \\" >> "$dockerfile"
                else
                    echo "    $pkg" >> "$dockerfile"
                fi
            done
            echo "" >> "$dockerfile"
        else
            # Default base packages - convert to one-per-line format
            local base_packages=$(get_base_packages)
            echo "# Core Python packages" >> "$dockerfile"
            echo "RUN pip install --no-cache-dir \\" >> "$dockerfile"
            local pkg_array=($base_packages)
            local pkg_count=${#pkg_array[@]}
            local i=0
            for pkg in "${pkg_array[@]}"; do
                ((i++))
                if [ $i -lt $pkg_count ]; then
                    echo "    $pkg \\" >> "$dockerfile"
                else
                    echo "    $pkg" >> "$dockerfile"
                fi
            done
            echo "" >> "$dockerfile"
        fi

        # Use case specific packages
        if [ -n "$usecase_packages" ]; then
            echo "# Use case specific packages" >> "$dockerfile"
            echo "RUN pip install --no-cache-dir \\" >> "$dockerfile"
            local pkg_array=($usecase_packages)
            local pkg_count=${#pkg_array[@]}
            local i=0
            for pkg in "${pkg_array[@]}"; do
                ((i++))
                if [ $i -lt $pkg_count ]; then
                    echo "    $pkg \\" >> "$dockerfile"
                else
                    echo "    $pkg" >> "$dockerfile"
                fi
            done
            echo "" >> "$dockerfile"
        fi

        # Additional user packages
        if [ -n "$additional" ]; then
            echo "# Additional user packages" >> "$dockerfile"
            echo "RUN pip install --no-cache-dir \\" >> "$dockerfile"
            local pkg_array=($additional)
            local pkg_count=${#pkg_array[@]}
            local i=0
            for pkg in "${pkg_array[@]}"; do
                ((i++))
                if [ $i -lt $pkg_count ]; then
                    echo "    $pkg \\" >> "$dockerfile"
                else
                    echo "    $pkg" >> "$dockerfile"
                fi
            done
            echo "" >> "$dockerfile"
        fi

        # Always add custom section for future additions
        cat >> "$dockerfile" << DOCKERFILEEOF
# Custom additional packages

DOCKERFILEEOF
    else
        echo "# Custom base image - no default packages installed" >> "$dockerfile"
        echo "" >> "$dockerfile"
    fi

    # Jupyter configuration and environment (only if base packages included)
    if [ "$skip_base" != true ] && [ "$base_pkg_choice" != "skip" ]; then
        cat >> "$dockerfile" << DOCKERFILEEOF
# Configure Jupyter
RUN jupyter lab --generate-config && \\
    echo "c.ServerApp.ip = '0.0.0.0'" >> /root/.jupyter/jupyter_lab_config.py && \\
    echo "c.ServerApp.allow_root = True" >> /root/.jupyter/jupyter_lab_config.py && \\
    echo "c.ServerApp.open_browser = False" >> /root/.jupyter/jupyter_lab_config.py && \\
    echo "c.ServerApp.token = ''" >> /root/.jupyter/jupyter_lab_config.py && \\
    echo "c.ServerApp.password = ''" >> /root/.jupyter/jupyter_lab_config.py

# IPython kernel
RUN python -m ipykernel install --user \\
    --name=$image_name \\
    --display-name="$image_name ($framework)"

DOCKERFILEEOF
    fi

    # Final environment variables and CMD
    cat >> "$dockerfile" << DOCKERFILEEOF
# Environment variables
ENV PYTHONUNBUFFERED=1
ENV CUDA_DEVICE_ORDER=PCI_BUS_ID
ENV HF_HOME=/workspace/.cache/huggingface
ENV TORCH_HOME=/workspace/.cache/torch
ENV MPLCONFIGDIR=/workspace/.cache/matplotlib

CMD ["/bin/bash"]
DOCKERFILEEOF

    echo "$dockerfile"
}

# Parse arguments
IMAGE_NAME=""
FRAMEWORK=""
USECASE=""
ADDITIONAL_PACKAGES=""
SYSTEM_PACKAGES=""
CUSTOM_BASE_IMAGE=""
BASE_PACKAGES_CHOICE=""
CUSTOM_BASE_PACKAGES=""
CUSTOM_USECASE_PACKAGES=""
SKIP_BASE_PACKAGES=false
NO_BUILD=false
GUIDED=false

while [[ $# -gt 0 ]]; do
    case $1 in
        -f|--framework)
            FRAMEWORK="$2"
            shift 2
            ;;
        -t|--type|--type=*)
            if [[ "$1" == --type=* ]]; then
                USECASE="${1#*=}"
                shift
            else
                USECASE="$2"
                shift 2
            fi
            ;;
        -p|--packages)
            ADDITIONAL_PACKAGES="$2"
            shift 2
            ;;
        -s|--system)
            SYSTEM_PACKAGES="$2"
            shift 2
            ;;
        --project-dockerfile)
            PROJECT_DOCKERFILE=true
            shift
            ;;
        --no-build)
            NO_BUILD=true
            shift
            ;;
        --guided)
            GUIDED=true
            shift
            ;;
        -h|--help|--info)
            usage
            exit 0
            ;;
        -*)
            echo -e "${RED}Unknown option: $1${NC}\n"
            usage
            exit 1
            ;;
        *)
            if [ -z "$IMAGE_NAME" ]; then
                IMAGE_NAME="$1"
            else
                echo -e "${RED}Multiple image names specified${NC}\n"
                usage
                exit 1
            fi
            shift
            ;;
    esac
done

# Handle --project-dockerfile flag
if [ "$PROJECT_DOCKERFILE" = true ]; then
    # Try to determine project name from image name
    if [ -n "$IMAGE_NAME" ]; then
        # Remove -image suffix if present
        PROJECT_NAME="${IMAGE_NAME%-image}"
        PROJECT_DIR="$HOME/workspace/$PROJECT_NAME"

        # Create project directory if it doesn't exist
        if [ ! -d "$PROJECT_DIR" ]; then
            echo -e "${YELLOW}âš  Project directory does not exist: $PROJECT_DIR${NC}"
            read -p "Create it now? [Y/n]: " CREATE_DIR </dev/tty
            CREATE_DIR=${CREATE_DIR:-Y}
            if [[ "$CREATE_DIR" =~ ^[Yy]$ ]]; then
                mkdir -p "$PROJECT_DIR"
                echo -e "${GREEN}âœ“ Created $PROJECT_DIR${NC}"
            else
                echo -e "${RED}Cannot use --project-dockerfile without project directory${NC}"
                echo "Falling back to centralized location: ~/dockerfiles/"
                PROJECT_DOCKERFILE=false
                PROJECT_DIR=""
            fi
        fi
    else
        echo -e "${YELLOW}âš  --project-dockerfile requires an image name${NC}"
        PROJECT_DOCKERFILE=false
    fi
fi

# Show guided introduction
if [ "$GUIDED" = true ]; then
    echo ""
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${BOLD}Docker Image Creation - Guided Mode${NC}"
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
    echo -e "${BOLD}What is a Docker Image?${NC}"
    echo ""
    echo "  A Docker image is a blueprint for your computing environment:"
    echo "  â€¢ Contains operating system (Ubuntu Linux)"
    echo "  â€¢ Pre-installed software (Python, PyTorch, TensorFlow, etc.)"
    echo "  â€¢ All libraries and dependencies"
    echo "  â€¢ Configuration and settings"
    echo ""
    echo -e "${BOLD}Why Create a Custom Image?${NC}"
    echo ""
    echo "  You create an image to:"
    echo "  â€¢ Install specific Python packages you need"
    echo "  â€¢ Set up your preferred ML/DL framework version"
    echo "  â€¢ Include domain-specific libraries (CV, NLP, RL)"
    echo "  â€¢ Save time - install once, use many times"
    echo ""
    echo -e "${BOLD}Image vs Container:${NC}"
    echo ""
    echo "  â€¢ ${CYAN}Image${NC} = Blueprint (like a recipe)"
    echo "  â€¢ ${CYAN}Container${NC} = Running instance (like the cooked dish)"
    echo "  â€¢ One image can create many containers"
    echo "  â€¢ Containers inherit everything from the image"
    echo ""
    echo -e "${BOLD}The Process:${NC}"
    echo ""
    echo "  1. Choose base framework (PyTorch, TensorFlow, JAX)"
    echo "  2. Select use case (CV, NLP, RL, or general ML)"
    echo "  3. Add extra packages if needed"
    echo "  4. Build image (takes 3-5 minutes)"
    echo "  5. Create containers from this image"
    echo ""
    echo -e "${YELLOW}ğŸ’¡ Pro Tip:${NC} Start with a simple setup first."
    echo "   You can always create more specialized images later!"
    echo ""
    read -p "Press Enter to start creating your image..." </dev/tty
    echo ""
fi

# Interactive mode if missing info
if [ -z "$IMAGE_NAME" ] || [ -z "$FRAMEWORK" ] || [ -z "$USECASE" ]; then
    interactive_mode
else
    # Non-interactive: sanitize image name
    IMAGE_NAME=$(echo "$IMAGE_NAME" | tr ' ' '-' | tr '[:upper:]' '[:lower:]')
    FULL_IMAGE_NAME="${IMAGE_NAME}-${USERNAME}"
fi

# Check user's resource limits and provide helpful info
check_user_limits

# Create Dockerfile
echo -e "\n${CYAN}Creating Dockerfile...${NC}"
DOCKERFILE=$(create_dockerfile "$FULL_IMAGE_NAME" "$FRAMEWORK" "$USECASE" "$ADDITIONAL_PACKAGES" "$SYSTEM_PACKAGES" "$CUSTOM_BASE_IMAGE" "$BASE_PACKAGES_CHOICE" "$CUSTOM_BASE_PACKAGES" "$CUSTOM_USECASE_PACKAGES" "$SKIP_BASE_PACKAGES")
echo -e "${GREEN}âœ“${NC} Dockerfile created: ${BLUE}$DOCKERFILE${NC}\n"

# Guided explanation of Dockerfile
if [ "$GUIDED" = true ]; then
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${BOLD}What is a Dockerfile?${NC}"
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
    echo "A Dockerfile is a recipe for building your image:"
    echo ""
    echo "  â€¢ ${CYAN}FROM${NC} - Start with a base image (PyTorch, TensorFlow, etc.)"
    echo "  â€¢ ${CYAN}RUN${NC} - Execute commands (install packages, configure)"
    echo "  â€¢ ${CYAN}ENV${NC} - Set environment variables"
    echo "  â€¢ ${CYAN}WORKDIR${NC} - Set working directory"
    echo ""
    echo "Your Dockerfile is saved at:"
    echo -e "  ${BLUE}$DOCKERFILE${NC}"
    echo ""
    echo "You can edit it later to:"
    echo "  â€¢ Add more packages"
    echo "  â€¢ Change configurations"
    echo "  â€¢ Install system tools"
    echo ""
    echo -e "Then rebuild with: ${GREEN}image-update $FULL_IMAGE_NAME${NC}"
    echo ""
fi

# Phase 1: Dockerfile Created âœ“
echo ""
echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${GREEN}${BOLD}âœ“ Phase 1/3: Dockerfile Created${NC}"
echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""
echo -e "Location: ${BLUE}$DOCKERFILE${NC}"
echo ""

# Phase 2: Build Image?
BUILD_IMAGE=true
if [ "$NO_BUILD" = true ]; then
    BUILD_IMAGE=false
    echo -e "${YELLOW}Build skipped (--no-build flag)${NC}"
    echo ""
    local build_context=$(dirname "$DOCKERFILE")
    echo "Build later with:"
    echo -e "  ${GREEN}docker build -t $FULL_IMAGE_NAME -f $DOCKERFILE $build_context/${NC}"
    echo ""
else
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${BOLD}Phase 2/3: Build Docker Image?${NC}"
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
    echo "This will:"
    echo "  â€¢ Download base image (~2 GB)"
    echo "  â€¢ Install all packages"
    echo "  â€¢ Configure Jupyter and Python"
    echo "  â€¢ Save final image (~4-5 GB)"
    echo ""
    echo -e "${DIM}This can take a few minutes${NC}"
    echo ""
    read -p "Build image now? [Y/n]: " BUILD_CONFIRM </dev/tty
    BUILD_CONFIRM=${BUILD_CONFIRM:-Y}
    echo ""

    if [[ ! "$BUILD_CONFIRM" =~ ^[Yy]$ ]]; then
        BUILD_IMAGE=false
        echo "Build skipped."
        echo ""
        local build_context=$(dirname "$DOCKERFILE")
        echo "Build later with:"
        echo -e "  ${GREEN}docker build -t $FULL_IMAGE_NAME -f $DOCKERFILE $build_context/${NC}"
        echo ""
    fi
fi

# Build image if confirmed
IMAGE_BUILT=false
if [ "$BUILD_IMAGE" = true ]; then
    echo -e "${CYAN}Building image... (this takes 3-5 minutes)${NC}\n"

    # Use the directory containing the Dockerfile as build context
    local build_context=$(dirname "$DOCKERFILE")
    if docker build -t "$FULL_IMAGE_NAME" -f "$DOCKERFILE" "$build_context/"; then
        IMAGE_BUILT=true

        # Save metadata
        mkdir -p "$HOME/ds01-config/images"
        cat > "$HOME/ds01-config/images/${FULL_IMAGE_NAME}.info" << INFOEOF
Image: $FULL_IMAGE_NAME
Framework: $FRAMEWORK
Use Case: $USECASE
Created: $(date)
Dockerfile: $DOCKERFILE

Packages:
$([ -n "$(get_usecase_packages $USECASE)" ] && echo "- Use case: $(get_usecase_packages $USECASE)")
$([ -n "$ADDITIONAL_PACKAGES" ] && echo "- Additional: $ADDITIONAL_PACKAGES")
$([ -n "$SYSTEM_PACKAGES" ] && echo "- System: $SYSTEM_PACKAGES")
INFOEOF

        echo ""
        echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
        echo -e "${GREEN}${BOLD}âœ“ Phase 2/3: Docker Image Built${NC}"
        echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
        echo ""
        echo -e "Image: ${CYAN}$FULL_IMAGE_NAME${NC}"
        echo ""

        if [ "$GUIDED" = true ]; then
            echo -e "${BOLD}What Just Happened?${NC}"
            echo ""
            echo "  âœ“ Downloaded base image with $FRAMEWORK"
            echo "  âœ“ Installed all requested packages"
            echo "  âœ“ Configured Jupyter Lab"
            echo "  âœ“ Set up Python environment"
            echo ""
        fi
    else
        echo ""
        echo -e "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
        echo -e "${RED}${BOLD}âœ— Phase 2/3: Build Failed${NC}"
        echo -e "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
        echo ""
        echo "Check Dockerfile: $DOCKERFILE"
        echo ""
        exit 1
    fi
fi

# Phase 3: Create Container?
if [ "$IMAGE_BUILT" = true ]; then
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${BOLD}Phase 3/3: Create Container?${NC}"
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
    echo "A container is a running instance of your image where you'll"
    echo "actually do your work (run code, train models, etc.)."
    echo ""
    echo "This will:"
    echo "  â€¢ Create container: $IMAGE_NAME"
    echo "  â€¢ Allocate GPU resources"
    echo "  â€¢ Mount your workspace directory"
    echo "  â€¢ Apply resource limits"
    echo ""
    read -p "Create container now? [Y/n]: " CONTAINER_CONFIRM </dev/tty
    CONTAINER_CONFIRM=${CONTAINER_CONFIRM:-Y}
    echo ""

    if [[ "$CONTAINER_CONFIRM" =~ ^[Yy]$ ]]; then
        echo -e "${CYAN}Creating container...${NC}"
        echo ""

        if command -v container-create &>/dev/null; then
            if container-create "$IMAGE_NAME"; then
                echo ""
                echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
                echo -e "${GREEN}${BOLD}âœ“ Phase 3/3: Container Created${NC}"
                echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
                echo ""
                echo -e "${BOLD}All Done! ğŸ‰${NC}"
                echo ""
                echo "Start working:"
                echo -e "  ${GREEN}container-run $IMAGE_NAME${NC}"
                echo ""
            else
                echo ""
                echo -e "${YELLOW}Container creation failed${NC}"
                echo "You can create it manually later:"
                echo -e "  ${GREEN}container-create $IMAGE_NAME${NC}"
                echo ""
            fi
        else
            echo -e "${RED}âœ— container-create command not found${NC}"
            echo "Create container manually:"
            echo -e "  ${GREEN}container-create $IMAGE_NAME${NC}"
            echo ""
        fi
    else
        echo "Container creation skipped."
        echo ""
        echo "Create container later:"
        echo -e "  ${GREEN}container-create $IMAGE_NAME${NC}"
        echo ""
    fi

    if [ "$GUIDED" = true ]; then
        echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
        echo -e "${BOLD}Remember:${NC}"
        echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
        echo ""
        echo "  â€¢ ${CYAN}Dockerfile${NC} = Recipe (text file with instructions)"
        echo "  â€¢ ${CYAN}Image${NC} = Blueprint (built from Dockerfile)"
        echo "  â€¢ ${CYAN}Container${NC} = Running instance (where you work)"
        echo ""
        echo -e "${BOLD}Useful Commands:${NC}"
        echo -e "  ${GREEN}image-list${NC}          List all images"
        echo -e "  ${GREEN}container-list${NC}      List all containers"
        echo -e "  ${GREEN}container-run${NC}       Enter a container"
        echo -e "  ${GREEN}image-update${NC}        Update Dockerfile & rebuild image"
        echo ""
    fi
fi

echo ""
