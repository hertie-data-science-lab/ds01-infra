#!/bin/bash
# DS01 Project Init - Unified workflow with optional --guided mode
# Usage: project-init [project-name] [--guided]

set -e

BLUE='\033[0;36m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
CYAN='\033[0;36m'
BOLD='\033[1m'
DIM='\033[2m'
NC='\033[0m'

USERNAME=$(whoami)
USER_ID=$(id -u)
GROUP_ID=$(id -g)

# Parse command line arguments
PROJECT_NAME_ARG=""
GUIDED=false
INTERACTIVE=true

for arg in "$@"; do
    case $arg in
        --guided)
            GUIDED=true
            shift
            ;;
        -h|--help)
            echo ""
            echo -e "${BOLD}DS01 Project Init${NC}"
            echo ""
            echo -e "${CYAN}Usage:${NC}"
            echo "  project-init [project-name] [--guided]"
            echo "  project init [project-name] [--guided]"
            echo ""
            echo -e "${CYAN}Options:${NC}"
            echo "  --guided    Include detailed explanations for beginners"
            echo "  -h, --help  Show this help message"
            echo ""
            echo -e "${CYAN}Examples:${NC}"
            echo "  project-init                    # Quick interactive setup"
            echo "  project-init --guided           # Beginner-friendly with explanations"
            echo "  project-init my-thesis          # Create 'my-thesis' project"
            echo "  project init                    # Same as project-init"
            echo ""
            exit 0
            ;;
        *)
            if [ -z "$PROJECT_NAME_ARG" ]; then
                PROJECT_NAME_ARG="$arg"
            fi
            ;;
    esac
done

# Check if project name was provided
if [ -n "$PROJECT_NAME_ARG" ]; then
    INTERACTIVE=false
fi

# Header
echo ""
echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
if [ "$GUIDED" = true ]; then
    echo -e "  ${BOLD}DS01 Project Init (Guided Mode)${NC}"
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
    echo -e "${GREEN}${BOLD}Welcome to DS01!${NC}"
    echo -e "  This wizard will walk you through creating a complete ML project."
    echo -e "  ${DIM}For experienced users: run without --guided flag${NC}"
else
    echo -e "  ${BOLD}DS01 Project Init${NC}"
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
fi
echo ""

if [ "$INTERACTIVE" = true ] && [ "$GUIDED" = false ]; then
    echo -e "${BOLD}Project Setup${NC}"
    echo -e "${DIM}Tip: Add --guided flag for detailed explanations${NC}"
    echo ""
fi

# Step 1: Project Name and Type
echo -e "${BOLD}Step 1: Project Information${NC}"

if [ "$GUIDED" = true ]; then
    echo ""
    echo -e "${DIM}A project is your workspace directory containing:"
    echo -e "  â€¢ Your code (scripts, notebooks)"
    echo -e "  â€¢ Your data (datasets, outputs)"
    echo -e "  â€¢ Configuration files"
    echo -e "  â€¢ Everything persists across container restarts${NC}"
fi
echo ""

if [ -n "$PROJECT_NAME_ARG" ]; then
    PROJECT_NAME="$PROJECT_NAME_ARG"
    PROJECT_NAME=$(echo "$PROJECT_NAME" | tr ' ' '-' | tr '[:upper:]' '[:lower:]')
    echo -e "Project name: ${CYAN}$PROJECT_NAME${NC}"
else
    read -p "Project name (e.g., thesis, cv-experiments, nlp-project): " PROJECT_NAME
    PROJECT_NAME=$(echo "$PROJECT_NAME" | tr ' ' '-' | tr '[:upper:]' '[:lower:]')
fi

PROJECT_DIR="$HOME/workspace/$PROJECT_NAME"

# Check if exists
if [ -d "$PROJECT_DIR" ]; then
    echo -e "${YELLOW}âš   Project directory already exists: $PROJECT_DIR${NC}"
    read -p "Use existing directory? [Y/n]: " USE_EXISTING
    if [[ ! "$USE_EXISTING" =~ ^[Yy] ]]; then
        exit 1
    fi
    EXISTING_PROJECT=true
else
    EXISTING_PROJECT=false
fi

# Project type selection
if [ "$INTERACTIVE" = true ]; then
    echo ""
    echo "Select project type:"
    echo -e "  ${BOLD}1)${NC} General ML ${DIM}(just the basics) ${GREEN}(Default)${NC}"
    echo -e "  ${BOLD}2)${NC} Computer Vision ${DIM}(timm, albumentations, opencv)${NC}"
    echo -e "  ${BOLD}3)${NC} NLP ${DIM}(transformers, datasets, tokenizers)${NC}"
    echo -e "  ${BOLD}4)${NC} Reinforcement Learning ${DIM}(gymnasium, stable-baselines3)${NC}"
    echo -e "  ${BOLD}5)${NC} Custom ${DIM}(specify packages manually)${NC}"
    read -p "Choice [1-5, default: 1]: " TYPE_CHOICE

    case $TYPE_CHOICE in
        2) PROJECT_TYPE="cv" ;;
        3) PROJECT_TYPE="nlp" ;;
        4) PROJECT_TYPE="rl" ;;
        5) PROJECT_TYPE="custom" ;;
        *) PROJECT_TYPE="ml" ;;
    esac
else
    PROJECT_TYPE="ml"
fi

# Project description
if [ "$INTERACTIVE" = true ]; then
    echo ""
    read -p "Project description (optional, press Enter to skip): " PROJECT_DESC
else
    PROJECT_DESC=""
fi

# Step 2: Create Project Directory Structure
if [ "$EXISTING_PROJECT" = false ]; then
    echo ""
    echo -e "${BOLD}Step 2: Creating Project Structure${NC}"
    echo ""

    if [ "$INTERACTIVE" = true ]; then
        # Directory structure choice
        echo -e "${BOLD}Choose directory structure:${NC}"
        echo -e "  ${BOLD}1)${NC} Data Science structure ${GREEN}(recommended)${NC}"
        echo -e "     ${DIM}Organized folders: data/, models/, notebooks/, scripts/, outputs/${NC}"
        echo -e "  ${BOLD}2)${NC} Blank directory"
        echo -e "     ${BOLD}Empty project folder - set up your own structure${NC}"
        read -p "Choice [1-2, default: 1]: " STRUCTURE_CHOICE
    else
        STRUCTURE_CHOICE="1"
    fi

    if [ "$STRUCTURE_CHOICE" = "2" ]; then
        STRUCTURE_TYPE="blank"
    else
        STRUCTURE_TYPE="data-science"
    fi

    # Call Tier 2 module: dir-create
    GUIDED_FLAG=""
    if [ "$GUIDED" = true ]; then
        GUIDED_FLAG="--guided"
    fi

    dir-create "$PROJECT_NAME" --type="$STRUCTURE_TYPE" $GUIDED_FLAG
else
    echo ""
    echo -e "${BOLD}Step 2: Using Existing Project${NC}"
    echo -e "${GREEN}âœ“ Using existing directory${NC}"
    STRUCTURE_TYPE="existing"
fi

# Step 3: Git Setup
echo ""
echo -e "${BOLD}Step 3: Git Version Control${NC}"
echo ""

SKIP_GIT=false

if [ "$INTERACTIVE" = true ]; then
    read -p "Initialize Git repository? [Y/n]: " INIT_GIT
    INIT_GIT=${INIT_GIT:-Y}
else
    INIT_GIT="Y"
fi

if [[ "$INIT_GIT" =~ ^[Yy] ]]; then
    # Call Tier 2 module: git-init
    GUIDED_FLAG=""
    if [ "$GUIDED" = true ]; then
        GUIDED_FLAG="--guided"
    fi

    git-init "$PROJECT_NAME" $GUIDED_FLAG
else
    SKIP_GIT=true
fi

# Step 4: Create README and requirements.txt
if [ "$EXISTING_PROJECT" = false ]; then
    echo ""
    echo -e "${BOLD}Step 4: Creating Project Files${NC}"
    echo ""

    # Call Tier 2 module: readme-create
    GUIDED_FLAG=""
    COMMIT_FLAG=""
    if [ "$GUIDED" = true ]; then
        GUIDED_FLAG="--guided"
    fi
    if [ "$SKIP_GIT" = false ]; then
        COMMIT_FLAG="--commit"
    fi

    readme-create "$PROJECT_NAME" \
        --type="$PROJECT_TYPE" \
        --structure="$STRUCTURE_TYPE" \
        --desc="$PROJECT_DESC" \
        $COMMIT_FLAG \
        $GUIDED_FLAG
else
    echo ""
    echo -e "${BOLD}Step 4: Skipping File Creation${NC}"
    echo -e "${YELLOW}Using existing project files${NC}"
fi

# Step 5: Docker Image Creation
echo ""
echo -e "${BOLD}Step 5: Docker Image${NC}"
echo ""

IMAGE_NAME=""
if [ "$INTERACTIVE" = true ]; then
    read -p "Create a custom Docker image? [Y/n]: " CREATE_IMAGE
    CREATE_IMAGE=${CREATE_IMAGE:-Y}
else
    CREATE_IMAGE="n"
fi

if [[ "$CREATE_IMAGE" =~ ^[Yy] ]]; then
    IMAGE_NAME="${PROJECT_NAME}-image"

    # Call Tier 2 module: image-create
    GUIDED_FLAG=""
    if [ "$GUIDED" = true ]; then
        GUIDED_FLAG="--guided"
    fi

    image-create "$IMAGE_NAME" --type="$PROJECT_TYPE" $GUIDED_FLAG
fi

# Show Summary BEFORE entering container
echo ""
echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${GREEN}${BOLD}âœ“ Setup Complete!${NC}"
echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""
echo -e "${BOLD}Project:${NC} $PROJECT_NAME"
echo -e "${BOLD}Type:${NC} $PROJECT_TYPE"
echo -e "${BOLD}Location:${NC} $PROJECT_DIR"
if [ -n "$IMAGE_NAME" ]; then
    echo -e "${BOLD}Image:${NC} $IMAGE_NAME"
fi
echo ""

if [ "$GUIDED" = true ]; then
    echo -e "${YELLOW}${BOLD}â”â”â” Understanding Containers (for beginners) â”â”â”${NC}\n"
    echo -e "${BOLD}What is a Container?${NC}"
    echo "  Think of a container like a 'computing environment' that:"
    echo "  â€¢ Has all your tools pre-installed (Python, PyTorch, etc.)"
    echo "  â€¢ Can access GPUs for machine learning"
    echo "  â€¢ Can be started, stopped, and restarted anytime"
    echo "  â€¢ Is separate from your files (which live in workspace)"
    echo ""
    echo -e "${BOLD}Container vs. Workspace:${NC}"
    echo -e "  ${CYAN}Workspace${NC} (~/workspace/$PROJECT_NAME)"
    echo "    â†’ Your PERMANENT storage - all files saved here persist"
    echo "    â†’ Edit code here (in VS Code, PyCharm, or directly)"
    echo "    â†’ This is like your 'hard drive'"
    echo ""
    echo -e "  ${CYAN}Container${NC} (your-project)"
    echo "    â†’ Your COMPUTING environment with GPU access"
    echo "    â†’ Can be stopped/restarted without losing workspace files"
    echo "    â†’ This is like your 'computer' that you can turn on/off"
    echo ""
    echo -e "${BOLD}The Workflow:${NC}"
    echo "  1. Write/edit code in your workspace (via VS Code SSH or directly)"
    echo "  2. Run code inside container (which has GPUs and software)"
    echo "  3. Results save back to workspace (persistent storage)"
    echo ""
    echo -e "${BOLD}Key Concepts:${NC}"
    echo "  â€¢ ${GREEN}Enter container${NC}:  Work with GPUs, run experiments"
    echo "  â€¢ ${GREEN}Exit container${NC}:   Your files stay in workspace, container keeps running"
    echo "  â€¢ ${GREEN}Stop container${NC}:   Turn off container (saves GPU resources)"
    echo "  â€¢ ${GREEN}Restart container${NC}: Pick up where you left off"
    echo ""
fi

echo -e "${YELLOW}${BOLD}â”â”â” Your Next Steps â”â”â”${NC}\n"

if [ -z "$IMAGE_NAME" ]; then
    echo -e "${BOLD}1. Create Docker image:${NC}"
    echo -e "   ${GREEN}image-create $PROJECT_NAME${NC}"
    echo ""
    echo -e "${BOLD}2. Create and start container:${NC}"
    echo -e "   ${GREEN}container-create $PROJECT_NAME <image-name>${NC}"
    echo -e "   ${GREEN}container-run $PROJECT_NAME${NC}"
    echo ""
else
    echo -e "${BOLD}1. Create a container${NC} (if you haven't already)"
    echo -e "${BOLD}2. Enter the container${NC} to start working"
    echo ""
fi

echo -e "${BOLD}Helpful Commands:${NC}"
echo -e "  ${CYAN}container-list${NC}       See your containers"
echo -e "  ${CYAN}container-run <name>${NC}  Enter a container"
echo -e "  ${CYAN}container-stop <name>${NC} Stop a container"
echo -e "  ${CYAN}container-stats${NC}      Check GPU/CPU usage"
echo -e "  ${CYAN}alias-list${NC}           See all available commands"
echo ""

echo -e "${BOLD}Inside the Container:${NC}"
echo "  â€¢ Your workspace: ${CYAN}/workspace${NC}"
echo "  â€¢ Start Jupyter: ${CYAN}jlab${NC}"
echo "  â€¢ Check GPU: ${CYAN}gpu${NC}"
echo "  â€¢ Exit (container keeps running): Type ${CYAN}exit${NC}"
echo "  â€¢ Stop container: ${CYAN}container-stop <name>${NC} (on host)"
echo ""

if [ -f "$PROJECT_DIR/README.md" ]; then
    echo -e "${YELLOW}ğŸ“– Read your project README:${NC} ${CYAN}cat $PROJECT_DIR/README.md${NC}"
    echo ""
fi

# Step 6: Container Deployment (AFTER showing summary)
if [ -n "$IMAGE_NAME" ] && [ "$INTERACTIVE" = true ]; then
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
    read -p "Would you like to deploy a container now? [Y/n]: " DEPLOY_CONTAINER
    DEPLOY_CONTAINER=${DEPLOY_CONTAINER:-Y}

    if [[ "$DEPLOY_CONTAINER" =~ ^[Yy] ]]; then
        echo ""

        # Deploy container using Tier 3 orchestrator (create + start/run)
        GUIDED_FLAG=""
        if [ "$GUIDED" = true ]; then
            GUIDED_FLAG="--guided"
        fi

        if command -v container-deploy &> /dev/null; then
            # container-deploy handles: create container + prompt for background/terminal
            container-deploy "$PROJECT_NAME" "$IMAGE_NAME" $GUIDED_FLAG || true

            # Show reminder after exiting (if user chose to enter terminal)
            echo ""
            echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
            echo -e "${BOLD}Reminder: Your project is in ${CYAN}$PROJECT_DIR${NC}"
            echo -e "${BOLD}Re-enter container: ${GREEN}container-run $PROJECT_NAME${NC}"
            echo ""
        else
            echo -e "${YELLOW}Container deploy command not found${NC}"
            echo "Deploy manually with: container-deploy $PROJECT_NAME $IMAGE_NAME"
        fi
    fi
fi
