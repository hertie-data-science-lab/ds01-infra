#!/bin/bash
# Project Initialization Tool for DS01
# Creates structured project directories with optional Git integration

BLUE='\033[94m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m'

USERNAME=$(whoami)
WORKSPACE_DIR="$HOME/workspace"

usage() {
    echo ""
    echo -e "${BOLD}Project Initialization Tool${NC}"
    echo ""
    echo -e "${CYAN}Usage:${NC}"
    echo "  project-init [project-name] [options]"
    echo ""
    echo -e "${CYAN}Options:${NC}"
    echo "  -g, --git URL       Initialize Git and link to remote repository"
    echo "  -t, --type TYPE     Project template (ml, cv, nlp, rl, general)"
    echo "  -d, --description   Project description"
    echo "  -h, --help          Show this help message"
    echo ""
    echo -e "${CYAN}Project Types:${NC}"
    echo "  ml      General machine learning (default)"
    echo "  cv      Computer vision"
    echo "  nlp     Natural language processing"
    echo "  rl      Reinforcement learning"
    echo "  general Basic project structure"
    echo ""
    echo -e "${CYAN}Examples:${NC}"
    echo "  project-init my-thesis                              # Basic ML project"
    echo "  project-init cv-project -t cv                       # Computer vision project"
    echo "  project-init my-research -g git@github.com:user/repo.git   # With Git remote"
    echo "  project-init nlp-experiments -t nlp -d \"BERT fine-tuning\"  # With description"
    echo ""
    echo -e "${CYAN}What it creates:${NC}"
    echo "  â€¢ Organized directory structure"
    echo "  â€¢ README.md with project info"
    echo "  â€¢ .gitignore for data science projects"
    echo "  â€¢ requirements.txt template"
    echo "  â€¢ Example configuration files"
    echo ""
}

create_gitignore() {
    local project_dir="$1"

    cat > "$project_dir/.gitignore" << 'GITIGNOREEOF'
# Python
__pycache__/
*.py[cod]
*$py.class
*.so
.Python
*.egg-info/
dist/
build/

# Jupyter Notebook
.ipynb_checkpoints
*.ipynb_checkpoints

# Data
data/raw/*
data/processed/*
!data/raw/.gitkeep
!data/processed/.gitkeep
*.csv
*.h5
*.hdf5
*.pkl
*.pickle

# Models
models/*.pth
models/*.pt
models/*.h5
models/*.ckpt
models/*.pb
!models/.gitkeep

# Logs and outputs
logs/
outputs/
runs/
wandb/
*.log
tensorboard/

# Environment
.env
.venv
venv/
ENV/

# IDE
.vscode/
.idea/
*.swp
*.swo
*~

# OS
.DS_Store
Thumbs.db

# Checkpoints
checkpoints/
*.ckpt
GITIGNOREEOF
}

create_requirements() {
    local project_dir="$1"
    local project_type="$2"

    local base_requirements="numpy
pandas
matplotlib
seaborn
scikit-learn
jupyter
jupyterlab
ipykernel
tqdm
tensorboard"

    case $project_type in
        cv)
            base_requirements="$base_requirements
torch
torchvision
opencv-python
albumentations
timm
Pillow"
            ;;
        nlp)
            base_requirements="$base_requirements
torch
transformers
datasets
tokenizers
accelerate
sentencepiece"
            ;;
        rl)
            base_requirements="$base_requirements
torch
gymnasium
stable-baselines3
tensorboard"
            ;;
        ml)
            base_requirements="$base_requirements
torch
scikit-learn
scipy
xgboost
lightgbm"
            ;;
    esac

    echo "$base_requirements" > "$project_dir/requirements.txt"
}

create_readme() {
    local project_dir="$1"
    local project_name="$2"
    local project_type="$3"
    local description="$4"

    cat > "$project_dir/README.md" << READMEEOF
# $project_name

${description:+**Description:** $description}

**Author:** $USERNAME
**Created:** $(date +"%Y-%m-%d")
**Type:** $project_type

## Project Structure

\`\`\`
$project_name/
â”œâ”€â”€ data/
â”‚   â”œâ”€â”€ raw/              # Original, immutable data
â”‚   â””â”€â”€ processed/        # Cleaned, transformed data
â”œâ”€â”€ models/               # Trained model checkpoints
â”œâ”€â”€ notebooks/            # Jupyter notebooks for exploration
â”œâ”€â”€ scripts/              # Python scripts for training/inference
â”‚   â”œâ”€â”€ train.py
â”‚   â”œâ”€â”€ evaluate.py
â”‚   â””â”€â”€ preprocess.py
â”œâ”€â”€ configs/              # Configuration files (YAML, JSON)
â”œâ”€â”€ outputs/              # Training logs, plots, results
â”‚   â”œâ”€â”€ logs/
â”‚   â””â”€â”€ figures/
â”œâ”€â”€ tests/                # Unit tests
â”œâ”€â”€ requirements.txt      # Python dependencies
â”œâ”€â”€ .gitignore
â””â”€â”€ README.md             # This file
\`\`\`

## Quick Start

### 1. Set up environment

\`\`\`bash
# Create and start container
container-create $project_name pytorch
container-run $project_name

# Inside container
pip install -r requirements.txt
\`\`\`

### 2. Run experiments

\`\`\`bash
# Explore data
jupyter lab notebooks/

# Train model
python scripts/train.py --config configs/experiment.yaml

# Evaluate
python scripts/evaluate.py --checkpoint models/best_model.pth
\`\`\`

## Dataset

<!-- Describe your dataset here -->
- Source:
- Size:
- Format:

## Model

<!-- Describe your model architecture -->

## Results

<!-- Document your results here -->

## Notes

- All data files are gitignored by default
- Checkpoint models regularly in \`models/\`
- Document experiments in notebooks
- Keep configs versioned for reproducibility

## References

<!-- Add papers, repos, resources -->

READMEEOF
}

create_config_example() {
    local project_dir="$1"

    cat > "$project_dir/configs/experiment.yaml" << 'YAMLEOF'
# Experiment configuration
experiment:
  name: "baseline"
  seed: 42

data:
  train_path: "data/processed/train.csv"
  val_path: "data/processed/val.csv"
  batch_size: 32
  num_workers: 4

model:
  architecture: "resnet50"
  pretrained: true
  num_classes: 10

training:
  epochs: 100
  learning_rate: 0.001
  optimizer: "adam"
  scheduler: "cosine"
  early_stopping_patience: 10

logging:
  log_dir: "outputs/logs"
  checkpoint_dir: "models"
  save_frequency: 5
YAMLEOF
}

create_train_template() {
    local project_dir="$1"

    cat > "$project_dir/scripts/train.py" << 'PYTHONEOF'
#!/usr/bin/env python3
"""
Training script template
"""

import argparse
from pathlib import Path

def parse_args():
    parser = argparse.ArgumentParser(description='Train model')
    parser.add_argument('--config', type=str, required=True,
                       help='Path to config file')
    parser.add_argument('--checkpoint', type=str, default=None,
                       help='Path to checkpoint for resuming')
    parser.add_argument('--gpu', type=int, default=0,
                       help='GPU ID to use')
    return parser.parse_args()

def main():
    args = parse_args()

    # TODO: Implement training loop
    print(f"Training with config: {args.config}")
    print(f"Using GPU: {args.gpu}")

    # Load data
    # Build model
    # Train loop
    # Save checkpoints

if __name__ == '__main__':
    main()
PYTHONEOF

    chmod +x "$project_dir/scripts/train.py"
}

# Parse arguments
PROJECT_NAME=""
GIT_URL=""
PROJECT_TYPE="ml"
DESCRIPTION=""

while [[ $# -gt 0 ]]; do
    case $1 in
        -g|--git)
            GIT_URL="$2"
            shift 2
            ;;
        -t|--type)
            PROJECT_TYPE="$2"
            shift 2
            ;;
        -d|--description)
            DESCRIPTION="$2"
            shift 2
            ;;
        -h|--help)
            usage
            exit 0
            ;;
        -*)
            echo -e "${RED}Unknown option: $1${NC}\n"
            usage
            exit 1
            ;;
        *)
            if [ -z "$PROJECT_NAME" ]; then
                PROJECT_NAME="$1"
            else
                echo -e "${RED}Multiple project names specified${NC}\n"
                usage
                exit 1
            fi
            shift
            ;;
    esac
done

# Validate project name
if [ -z "$PROJECT_NAME" ]; then
    echo -e "${RED}Error: Project name is required${NC}\n"
    usage
    exit 1
fi

# Sanitize project name
PROJECT_NAME=$(echo "$PROJECT_NAME" | tr ' ' '-' | tr '[:upper:]' '[:lower:]' | tr -cd '[:alnum:]-_')

PROJECT_DIR="$WORKSPACE_DIR/$PROJECT_NAME"

echo -e "${CYAN}â”â”â” Creating Project: ${BOLD}$PROJECT_NAME${NC} ${CYAN}â”â”â”${NC}\n"

# Check if project exists
if [ -d "$PROJECT_DIR" ]; then
    echo -e "${RED}âœ— Project directory already exists: $PROJECT_DIR${NC}"
    echo "Use a different name or remove the existing directory"
    exit 1
fi

# Create directory structure
echo "Creating directory structure..."
mkdir -p "$PROJECT_DIR"/{data/{raw,processed},models,notebooks,scripts,configs,outputs/{logs,figures},tests}

# Create placeholder files
touch "$PROJECT_DIR/data/raw/.gitkeep"
touch "$PROJECT_DIR/data/processed/.gitkeep"
touch "$PROJECT_DIR/models/.gitkeep"
touch "$PROJECT_DIR/outputs/logs/.gitkeep"
touch "$PROJECT_DIR/outputs/figures/.gitkeep"

echo -e "${GREEN}âœ“${NC} Directory structure created"

# Create files
echo "Creating project files..."
create_gitignore "$PROJECT_DIR"
create_requirements "$PROJECT_DIR" "$PROJECT_TYPE"
create_readme "$PROJECT_DIR" "$PROJECT_NAME" "$PROJECT_TYPE" "$DESCRIPTION"
create_config_example "$PROJECT_DIR"
create_train_template "$PROJECT_DIR"

echo -e "${GREEN}âœ“${NC} Project files created"

# Initialize Git
if [ -n "$GIT_URL" ] || command -v git &> /dev/null; then
    echo "Initializing Git repository..."
    cd "$PROJECT_DIR"
    git init -q

    if [ -n "$GIT_URL" ]; then
        git remote add origin "$GIT_URL"
        echo -e "${GREEN}âœ“${NC} Git repository initialized with remote: $GIT_URL"
    else
        echo -e "${GREEN}âœ“${NC} Git repository initialized"
    fi

    # Initial commit
    git add .
    git commit -q -m "Initial project structure

Created by project-init on $(date)
Type: $PROJECT_TYPE
${DESCRIPTION:+Description: $DESCRIPTION}"

    echo -e "${GREEN}âœ“${NC} Initial commit created"
fi

# Summary
echo ""
echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${GREEN}${BOLD}âœ“ Project created successfully!${NC}"
echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}\n"

echo -e "${BOLD}Project Details:${NC}"
echo -e "  Name:     ${CYAN}$PROJECT_NAME${NC}"
echo -e "  Type:     ${CYAN}$PROJECT_TYPE${NC}"
echo -e "  Location: ${CYAN}$PROJECT_DIR${NC}"
if [ -n "$GIT_URL" ]; then
    echo -e "  Remote:   ${CYAN}$GIT_URL${NC}"
fi

echo ""
echo -e "${BOLD}Next Steps:${NC}"
echo -e "  1. Navigate to project:  ${GREEN}cd $PROJECT_DIR${NC}"
echo -e "  2. Review README:        ${GREEN}cat README.md${NC}"
echo -e "  3. Create container:     ${GREEN}container-create $PROJECT_NAME${NC}"
echo -e "  4. Start working:        ${GREEN}container-run $PROJECT_NAME${NC}"

if [ -n "$GIT_URL" ]; then
    echo ""
    echo -e "${YELLOW}ğŸ’¡ Don't forget to push your initial commit:${NC}"
    echo -e "     ${BLUE}cd $PROJECT_DIR && git push -u origin main${NC}"
fi

echo ""
