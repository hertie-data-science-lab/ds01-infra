#!/bin/bash
# DS01 Project Init - L4 Wizard
# Complete project initialization workflow
# Usage: project-init [project-name] [--guided]

set -e

# Source DS01 context library
if [[ -f "/opt/ds01-infra/scripts/lib/ds01-context.sh" ]]; then
    source /opt/ds01-infra/scripts/lib/ds01-context.sh
fi

# Source skill assessment library for helper functions
if [[ -f "/opt/ds01-infra/scripts/lib/skill-assessment.sh" ]]; then
    source /opt/ds01-infra/scripts/lib/skill-assessment.sh
fi

# Set orchestration context - suppresses atomic command "Next steps" output
export DS01_CONTEXT="orchestration"
export DS01_INTERFACE="orchestration"

BLUE='\033[0;36m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
CYAN='\033[0;36m'
BOLD='\033[1m'
DIM='\033[2m'
NC='\033[0m'

USERNAME=$(whoami)
USER_ID=$(id -u)
GROUP_ID=$(id -g)

# Parse command line arguments
PROJECT_NAME_ARG=""
GUIDED=false
INTERACTIVE=true

for arg in "$@"; do
    case $arg in
        --guided)
            GUIDED=true
            shift
            ;;
        -h|--help)
            echo -e ""
            echo -e "${BOLD}DS01 Project Init${NC}"
            echo -e "${DIM}Part of workflow: user-setup â†’ project-init â†’ image-create â†’ container-deploy${NC}"
            echo -e ""
            echo -e "${CYAN}Usage:${NC}"
            echo -e "  project-init [project-name] [--guided]"
            echo -e ""
            echo -e "${CYAN}Options:${NC}"
            echo -e "  --guided    Include detailed explanations for beginners"
            echo -e "  -h, --help  Show this help message"
            echo -e ""
            echo -e "${CYAN}Examples:${NC}"
            echo -e "  project-init                    # Quick interactive setup"
            echo -e "  project-init --guided           # Beginner-friendly with explanations"
            echo -e "  project-init my-thesis          # Create 'my-thesis' project"
            echo -e ""
            echo -e "${DIM}Run 'help' or 'commands' anytime to see available commands.${NC}"
            echo -e ""
            exit 0
            ;;
        *)
            if [ -z "$PROJECT_NAME_ARG" ]; then
                PROJECT_NAME_ARG="$arg"
            fi
            ;;
    esac
done

# Check if project name was provided
if [ -n "$PROJECT_NAME_ARG" ]; then
    INTERACTIVE=false
fi

# Use skill level if set (from user-setup's skill assessment)
# DS01_SKILL_HPC: 0=beginner, 2=expert
if [[ "${DS01_SKILL_HPC:-}" == "0" ]]; then
    GUIDED=true
fi

# Helper functions for skill-aware output (if not already defined)
if ! type is_beginner &>/dev/null; then
    is_beginner() {
        local area="${1:-HPC}"
        case "$area" in
            REMOTE) [[ "${DS01_SKILL_REMOTE:-0}" == "0" ]] ;;
            GIT)    [[ "${DS01_SKILL_GIT:-0}" == "0" ]] ;;
            HPC)    [[ "${DS01_SKILL_HPC:-0}" == "0" ]] ;;
        esac
    }
fi

# Header
echo -e ""
echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
if [ "$GUIDED" = true ]; then
    echo -e "  ${BOLD}DS01 Project Init (Guided Mode)${NC}"
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e ""
    echo -e "${GREEN}${BOLD}Welcome to DS01!${NC}"
    echo -e "  This wizard will walk you through creating a complete ML project."
    echo -e "  ${DIM}For experienced users: run without --guided flag${NC}"
else
    echo -e "  ${BOLD}DS01 Project Init${NC}"
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
fi
echo -e ""

if [ "$INTERACTIVE" = true ] && [ "$GUIDED" = false ]; then
    echo -e "${BOLD}Project Setup${NC}"
    echo -e "${DIM}Tip: Add --guided flag for detailed explanations${NC}"
    echo -e ""
fi

# Step 1: Project Name and Type
echo -e "${BOLD}Step 1: Project Information${NC}"

if [ "$GUIDED" = true ]; then
    echo ""
    echo -e "A project is your workspace directory containing:"
    echo -e "  â€¢ Your code ${DIM}(scripts, notebooks)${NC}"
    echo -e "  â€¢ Your data ${DIM}(datasets, trained models)${NC}"
    echo -e "  â€¢ Configuration files"
    echo -e "  â€¢ Research outpits ${DIM}(visualisations, outputs)${NC}"
    echo ""
    echo -e "${YELLOW} Everything persists across container restarts${NC}"
fi
echo -e ""

if [ -n "$PROJECT_NAME_ARG" ]; then
    PROJECT_NAME="$PROJECT_NAME_ARG"
    PROJECT_NAME=$(echo -e "$PROJECT_NAME" | tr ' ' '-' | tr '[:upper:]' '[:lower:]')
    echo -e "Project name: ${CYAN}$PROJECT_NAME${NC}"
else
    # Loop until valid project name is provided
    while true; do
        read -p "Project name (e.g., thesis, cv-experiments, nlp-project): " PROJECT_NAME </dev/tty
        PROJECT_NAME=$(echo -e "$PROJECT_NAME" | tr ' ' '-' | tr '[:upper:]' '[:lower:]')

        if [ -z "$PROJECT_NAME" ]; then
            echo -e "${RED}âœ— Project name cannot be empty${NC}"
            echo -e ""
            continue
        fi
        break
    done
fi

PROJECT_DIR="$HOME/workspace/$PROJECT_NAME"

# Check if exists
if [ -d "$PROJECT_DIR" ]; then
    echo -e "${YELLOW}âš   Project directory already exists: $PROJECT_DIR${NC}"
    read -p "Use existing directory? [Y/n]: " USE_EXISTING
    if [[ ! "$USE_EXISTING" =~ ^[Yy] ]]; then
        exit 1
    fi
    EXISTING_PROJECT=true
else
    EXISTING_PROJECT=false
fi

# Project type selection
if [ "$INTERACTIVE" = true ]; then
    echo -e ""
    echo -e "Select project type:"
    echo -e "  ${BOLD}1)${NC} General ML ${DIM}(just the basics) ${GREEN}(Default)${NC}"
    echo -e "  ${BOLD}2)${NC} Computer Vision ${DIM}(timm, albumentations, opencv)${NC}"
    echo -e "  ${BOLD}3)${NC} NLP ${DIM}(transformers, datasets, tokenizers)${NC}"
    echo -e "  ${BOLD}4)${NC} Reinforcement Learning ${DIM}(gymnasium, stable-baselines3)${NC}"
    echo -e "  ${BOLD}5)${NC} Custom ${DIM}(specify packages manually)${NC}"
    echo -e ""
    read -p "Choice [1-5, default: 1]: " TYPE_CHOICE

    case $TYPE_CHOICE in
        2) PROJECT_TYPE="cv" ;;
        3) PROJECT_TYPE="nlp" ;;
        4) PROJECT_TYPE="rl" ;;
        5) PROJECT_TYPE="custom" ;;
        *) PROJECT_TYPE="ml" ;;
    esac
else
    PROJECT_TYPE="ml"
fi

# Project description
if [ "$INTERACTIVE" = true ]; then
    echo -e ""
    read -p "Project description (optional, press Enter to skip): " PROJECT_DESC
else
    PROJECT_DESC=""
fi

# Step 2: Create Project Directory Structure
if [ "$EXISTING_PROJECT" = false ]; then
    echo -e ""
    echo -e "${BOLD}Step 2: Creating Project Structure${NC}"
    echo -e ""

# Show guided introduction
if [ "$GUIDED" = true ]; then
    echo -e "Why use a standardised DS/ML template structure?"
    echo "  â€¢ Collaborate with others easily"
    echo "  â€¢ Follow ML/DS best practices"
    echo "  â€¢ Keep raw data separate from processed data"
    echo "  â€¢ Track experiments and results"
    echo ""

    read -p "Press Enter to create the directory structure..." </dev/tty
    echo ""
fi


    if [ "$INTERACTIVE" = true ]; then
        # Directory structure choice
        echo -e "${BOLD}Choose directory structure:${NC}"
        echo -e "  ${BOLD}1)${NC} Data Science structure ${GREEN}(recommended)${NC}"
        echo -e "     ${DIM}Organized folders: data/, models/, notebooks/, scripts/, outputs/${NC}"
        echo -e "  ${BOLD}2)${NC} Blank directory"
        echo -e "     ${DIM}Empty project folder - set up your own structure${NC}"
        echo -e ""
        read -p "Choice [1-2, default: 1]: " STRUCTURE_CHOICE
    else
        STRUCTURE_CHOICE="1"
    fi

    if [ "$STRUCTURE_CHOICE" = "2" ]; then
        STRUCTURE_TYPE="blank"
    else
        STRUCTURE_TYPE="data-science"
    fi

    # Call L2 atomic module: dir-create
    GUIDED_FLAG=""
    if [ "$GUIDED" = true ]; then
        GUIDED_FLAG="--guided"
    fi

    dir-create "$PROJECT_NAME" --type="$STRUCTURE_TYPE" $GUIDED_FLAG
else
    echo -e ""
    echo -e "${BOLD}Step 2: Using Existing Project${NC}"
    echo -e "${GREEN}âœ“ Using existing directory${NC}"
    STRUCTURE_TYPE="existing"
fi

# Step 3: Git Setup
echo -e ""
echo -e "${BOLD}Step 3: Git Version Control${NC}"
echo -e ""

SKIP_GIT=false

if [ "$INTERACTIVE" = true ]; then
    read -p "Initialize Git repository? [Y/n]: " INIT_GIT
    INIT_GIT=${INIT_GIT:-Y}
else
    INIT_GIT="Y"
fi

if [[ "$INIT_GIT" =~ ^[Yy] ]]; then
    # Call L2 atomic module: git-init (handles remote setup in guided mode)
    GUIDED_FLAG=""
    if [ "$GUIDED" = true ]; then
        GUIDED_FLAG="--guided"
    fi

    git-init "$PROJECT_NAME" $GUIDED_FLAG
else
    SKIP_GIT=true
fi

# Step 4: Create README and requirements.txt
if [ "$EXISTING_PROJECT" = false ]; then
    echo -e ""
    echo -e "${BOLD}Step 4: Creating Project Files${NC}"
    echo -e ""

    # Call L2 atomic module: readme-create
    GUIDED_FLAG=""
    COMMIT_FLAG=""
    if [ "$GUIDED" = true ]; then
        GUIDED_FLAG="--guided"
    fi
    if [ "$SKIP_GIT" = false ]; then
        COMMIT_FLAG="--commit"
    fi

    readme-create "$PROJECT_NAME" \
        --type="$PROJECT_TYPE" \
        --structure="$STRUCTURE_TYPE" \
        --desc="$PROJECT_DESC" \
        $COMMIT_FLAG \
        $GUIDED_FLAG
else
    echo -e ""
    echo -e "${BOLD}Step 4: File Creation${NC}"
    echo -e "${GREEN}Using existing project files${NC}"
fi


if [ -f "$PROJECT_DIR/README.md" ]; then
    echo -e "${YELLOW}ğŸ“– Read your project README:${NC} ${CYAN}cat $PROJECT_DIR/README.md${NC}"
fi

# ============================================================================
# FINAL SUMMARY
# ============================================================================

echo -e ""
echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${GREEN}${BOLD}âœ“ Project Setup Complete!${NC}"
echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e ""

echo -e "${BOLD}Next Steps:${NC}"
echo -e "  1. Create a Docker image:        ${GREEN}image-create --guided${NC}"
echo -e "  2. Deploy a container:           ${GREEN}container-deploy --guided${NC}"
echo -e ""
