#!/bin/bash
# DS01 Project Init - L4 Wizard
# Complete project initialization workflow
# Usage: project-init [project-name] [--guided]

set -e

# Source DS01 context library
if [[ -f "/opt/ds01-infra/scripts/lib/ds01-context.sh" ]]; then
    source /opt/ds01-infra/scripts/lib/ds01-context.sh
fi

# Source skill assessment library for helper functions
if [[ -f "/opt/ds01-infra/scripts/lib/skill-assessment.sh" ]]; then
    source /opt/ds01-infra/scripts/lib/skill-assessment.sh
fi

# Set orchestration context - suppresses atomic command "Next steps" output
export DS01_CONTEXT="orchestration"
export DS01_INTERFACE="orchestration"

BLUE='\033[0;36m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
CYAN='\033[0;36m'
BOLD='\033[1m'
DIM='\033[2m'
NC='\033[0m'

USERNAME=$(whoami)
USER_ID=$(id -u)
GROUP_ID=$(id -g)

# Parse command line arguments
PROJECT_NAME_ARG=""
GUIDED=false
INTERACTIVE=true

for arg in "$@"; do
    case $arg in
        --guided)
            GUIDED=true
            shift
            ;;
        -h|--help)
            echo ""
            echo -e "${BOLD}DS01 Project Init${NC}"
            echo ""
            echo -e "${CYAN}Usage:${NC}"
            echo "  project-init [project-name] [--guided]"
            echo "  project init [project-name] [--guided]"
            echo ""
            echo -e "${CYAN}Options:${NC}"
            echo "  --guided    Include detailed explanations for beginners"
            echo "  -h, --help  Show this help message"
            echo ""
            echo -e "${CYAN}Examples:${NC}"
            echo "  project-init                    # Quick interactive setup"
            echo "  project-init --guided           # Beginner-friendly with explanations"
            echo "  project-init my-thesis          # Create 'my-thesis' project"
            echo "  project init                    # Same as project-init"
            echo ""
            exit 0
            ;;
        *)
            if [ -z "$PROJECT_NAME_ARG" ]; then
                PROJECT_NAME_ARG="$arg"
            fi
            ;;
    esac
done

# Check if project name was provided
if [ -n "$PROJECT_NAME_ARG" ]; then
    INTERACTIVE=false
fi

# Use skill level if set (from user-setup's skill assessment)
# DS01_SKILL_HPC: 0=beginner, 2=expert
if [[ "${DS01_SKILL_HPC:-}" == "0" ]]; then
    GUIDED=true
fi

# Helper functions for skill-aware output (if not already defined)
if ! type is_beginner &>/dev/null; then
    is_beginner() {
        local area="${1:-HPC}"
        case "$area" in
            REMOTE) [[ "${DS01_SKILL_REMOTE:-0}" == "0" ]] ;;
            GIT)    [[ "${DS01_SKILL_GIT:-0}" == "0" ]] ;;
            HPC)    [[ "${DS01_SKILL_HPC:-0}" == "0" ]] ;;
        esac
    }
fi

# Header
echo ""
echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
if [ "$GUIDED" = true ]; then
    echo -e "  ${BOLD}DS01 Project Init (Guided Mode)${NC}"
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
    echo -e "${GREEN}${BOLD}Welcome to DS01!${NC}"
    echo -e "  This wizard will walk you through creating a complete ML project."
    echo -e "  ${DIM}For experienced users: run without --guided flag${NC}"
else
    echo -e "  ${BOLD}DS01 Project Init${NC}"
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
fi
echo ""

if [ "$INTERACTIVE" = true ] && [ "$GUIDED" = false ]; then
    echo -e "${BOLD}Project Setup${NC}"
    echo -e "${DIM}Tip: Add --guided flag for detailed explanations${NC}"
    echo ""
fi

# Step 1: Project Name and Type
echo -e "${BOLD}Step 1: Project Information${NC}"

if [ "$GUIDED" = true ]; then
    echo ""
    echo -e "A project is your workspace directory containing:"
    echo -e "  â€¢ Your code ${DIM}(scripts, notebooks)${NC}"
    echo -e "  â€¢ Your data ${DIM}(datasets, outputs)${NC}"
    echo -e "  â€¢ Configuration files"
    echo -e "  â€¢ Everything persists across container restarts"
fi
echo ""

if [ -n "$PROJECT_NAME_ARG" ]; then
    PROJECT_NAME="$PROJECT_NAME_ARG"
    PROJECT_NAME=$(echo "$PROJECT_NAME" | tr ' ' '-' | tr '[:upper:]' '[:lower:]')
    echo -e "Project name: ${CYAN}$PROJECT_NAME${NC}"
else
    # Loop until valid project name is provided
    while true; do
        read -p "Project name (e.g., thesis, cv-experiments, nlp-project): " PROJECT_NAME </dev/tty
        PROJECT_NAME=$(echo "$PROJECT_NAME" | tr ' ' '-' | tr '[:upper:]' '[:lower:]')

        if [ -z "$PROJECT_NAME" ]; then
            echo -e "${RED}âœ— Project name cannot be empty${NC}"
            echo ""
            continue
        fi
        break
    done
fi

PROJECT_DIR="$HOME/workspace/$PROJECT_NAME"

# Check if exists
if [ -d "$PROJECT_DIR" ]; then
    echo -e "${YELLOW}âš   Project directory already exists: $PROJECT_DIR${NC}"
    read -p "Use existing directory? [Y/n]: " USE_EXISTING
    if [[ ! "$USE_EXISTING" =~ ^[Yy] ]]; then
        exit 1
    fi
    EXISTING_PROJECT=true
else
    EXISTING_PROJECT=false
fi

# Project type selection
if [ "$INTERACTIVE" = true ]; then
    echo ""
    echo "Select project type:"
    echo -e "  ${BOLD}1)${NC} General ML ${DIM}(just the basics) ${GREEN}(Default)${NC}"
    echo -e "  ${BOLD}2)${NC} Computer Vision ${DIM}(timm, albumentations, opencv)${NC}"
    echo -e "  ${BOLD}3)${NC} NLP ${DIM}(transformers, datasets, tokenizers)${NC}"
    echo -e "  ${BOLD}4)${NC} Reinforcement Learning ${DIM}(gymnasium, stable-baselines3)${NC}"
    echo -e "  ${BOLD}5)${NC} Custom ${DIM}(specify packages manually)${NC}"
    echo ""
    read -p "Choice [1-5, default: 1]: " TYPE_CHOICE

    case $TYPE_CHOICE in
        2) PROJECT_TYPE="cv" ;;
        3) PROJECT_TYPE="nlp" ;;
        4) PROJECT_TYPE="rl" ;;
        5) PROJECT_TYPE="custom" ;;
        *) PROJECT_TYPE="ml" ;;
    esac
else
    PROJECT_TYPE="ml"
fi

# Project description
if [ "$INTERACTIVE" = true ]; then
    echo ""
    read -p "Project description (optional, press Enter to skip): " PROJECT_DESC
else
    PROJECT_DESC=""
fi

# Step 2: Create Project Directory Structure
if [ "$EXISTING_PROJECT" = false ]; then
    echo ""
    echo -e "${BOLD}Step 2: Creating Project Structure${NC}"
    echo ""

    if [ "$INTERACTIVE" = true ]; then
        # Directory structure choice
        echo -e "${BOLD}Choose directory structure:${NC}"
        echo -e "  ${BOLD}1)${NC} Data Science structure ${GREEN}(recommended)${NC}"
        echo -e "     ${DIM}Organized folders: data/, models/, notebooks/, scripts/, outputs/${NC}"
        echo -e "  ${BOLD}2)${NC} Blank directory"
        echo -e "     ${DIM}Empty project folder - set up your own structure${NC}"
        read -p "Choice [1-2, default: 1]: " STRUCTURE_CHOICE
    else
        STRUCTURE_CHOICE="1"
    fi

    if [ "$STRUCTURE_CHOICE" = "2" ]; then
        STRUCTURE_TYPE="blank"
    else
        STRUCTURE_TYPE="data-science"
    fi

    # Call Tier 2 module: dir-create
    GUIDED_FLAG=""
    if [ "$GUIDED" = true ]; then
        GUIDED_FLAG="--guided"
    fi

    dir-create "$PROJECT_NAME" --type="$STRUCTURE_TYPE" $GUIDED_FLAG
else
    echo ""
    echo -e "${BOLD}Step 2: Using Existing Project${NC}"
    echo -e "${GREEN}âœ“ Using existing directory${NC}"
    STRUCTURE_TYPE="existing"
fi

# Step 3: Git Setup
echo ""
echo -e "${BOLD}Step 3: Git Version Control${NC}"
echo ""

SKIP_GIT=false

if [ "$INTERACTIVE" = true ]; then
    read -p "Initialize Git repository? [Y/n]: " INIT_GIT
    INIT_GIT=${INIT_GIT:-Y}
else
    INIT_GIT="Y"
fi

if [[ "$INIT_GIT" =~ ^[Yy] ]]; then
    # Call Tier 2 module: git-init
    GUIDED_FLAG=""
    if [ "$GUIDED" = true ]; then
        GUIDED_FLAG="--guided"
    fi

    git-init "$PROJECT_NAME" $GUIDED_FLAG

    # Git remote setup (optional)
    if [ "$INTERACTIVE" = true ]; then
        echo ""
        if is_beginner "GIT"; then
            echo -e "${DIM}A Git remote lets you backup your code to GitHub/GitLab${NC}"
            echo -e "${DIM}and collaborate with others. You can add this later too.${NC}"
            echo ""
        fi
        read -p "Add a Git remote (e.g., GitHub URL)? [y/N]: " ADD_REMOTE </dev/tty
        if [[ "$ADD_REMOTE" =~ ^[Yy]$ ]]; then
            echo ""
            echo "Enter the remote URL (e.g., git@github.com:username/repo.git)"
            read -p "Remote URL: " REMOTE_URL </dev/tty
            if [ -n "$REMOTE_URL" ]; then
                cd "$PROJECT_DIR"
                if git remote add origin "$REMOTE_URL" 2>/dev/null; then
                    echo -e "${GREEN}âœ“${NC} Remote 'origin' added: $REMOTE_URL"
                    echo ""
                    echo "Push your code later with:"
                    echo -e "  ${GREEN}cd $PROJECT_DIR && git push -u origin main${NC}"
                else
                    echo -e "${YELLOW}âš ${NC} Could not add remote (may already exist)"
                fi
                cd - >/dev/null
            fi
        fi
    fi
else
    SKIP_GIT=true
fi

read -p "Press Enter to continue..." </dev/tty

# Step 4: Create README and requirements.txt
if [ "$EXISTING_PROJECT" = false ]; then
    echo ""
    echo -e "${BOLD}Step 4: Creating Project Files${NC}"
    echo ""

    # Call Tier 2 module: readme-create
    GUIDED_FLAG=""
    COMMIT_FLAG=""
    if [ "$GUIDED" = true ]; then
        GUIDED_FLAG="--guided"
    fi
    if [ "$SKIP_GIT" = false ]; then
        COMMIT_FLAG="--commit"
    fi

    readme-create "$PROJECT_NAME" \
        --type="$PROJECT_TYPE" \
        --structure="$STRUCTURE_TYPE" \
        --desc="$PROJECT_DESC" \
        $COMMIT_FLAG \
        $GUIDED_FLAG
else
    echo ""
    echo -e "${BOLD}Step 4: File Creation${NC}"
    echo -e "${GREEN}Using existing project files${NC}"
fi


if [ -f "$PROJECT_DIR/README.md" ]; then
    echo -e "${YELLOW}ğŸ“– Read your project README:${NC} ${CYAN}cat $PROJECT_DIR/README.md${NC}"
    echo ""
fi

# ============================================================================
# FINAL SUMMARY
# ============================================================================

echo ""
echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${GREEN}${BOLD}âœ“ Project Setup Complete!${NC}"
echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""

echo -e "${BOLD}What we created:${NC}"
echo ""
echo -e "  ${GREEN}âœ“${NC} Project directory: ~/workspace/$PROJECT_NAME"
if [ "$SKIP_GIT" = false ]; then
    echo -e "  ${GREEN}âœ“${NC} Git repository initialized"
fi
if [ -f "$PROJECT_DIR/README.md" ]; then
    echo -e "  ${GREEN}âœ“${NC} README.md with project template"
fi
echo ""

echo -e "${BOLD}Next Steps:${NC}"
echo -e "  1. Create a Docker image:        ${GREEN}image-create${NC}"
echo -e "  2. Deploy a container:           ${GREEN}container-deploy${NC}"
echo -e "  3. For guided setup:             ${GREEN}container-deploy --guided${NC}"
echo ""
