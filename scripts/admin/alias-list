#!/bin/bash
# help - DS01 Command Reference
# Aliases: help, commands
# Usage: help [--admin] [--atomic] [--inside] [--full]

set -e

# Colors
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
CYAN='\033[0;36m'
BOLD='\033[1m'
DIM='\033[2m'
NC='\033[0m'

# Parse flags
SHOW_FULL=false
SHOW_INSIDE=false
SHOW_ADMIN=false
SHOW_ATOMIC=false

for arg in "$@"; do
    case "$arg" in
        --full)
            SHOW_FULL=true
            ;;
        --inside-container|--inside)
            SHOW_INSIDE=true
            ;;
        --admin)
            SHOW_ADMIN=true
            ;;
        --atomic)
            SHOW_ATOMIC=true
            ;;
        -h|--help|--info)
            echo "Usage: help [OPTIONS]"
            echo ""
            echo "Show available DS01 commands."
            echo ""
            echo "Options:"
            echo "  --atomic             Show atomic container commands (advanced)"
            echo "  --admin              Show admin commands (ds01-* prefix)"
            echo "  --inside             Show inside-container commands"
            echo "  --full               Show everything"
            echo "  -h, --help           Show this message"
            echo ""
            exit 0
            ;;
        *)
            echo -e "${RED}Error:${NC} Unknown option: $arg"
            echo "Use --help for usage information"
            exit 1
            ;;
    esac
done

# Auto-detect if we're inside a container
IN_CONTAINER=false
if [ -f /.dockerenv ] || grep -q docker /proc/1/cgroup 2>/dev/null; then
    IN_CONTAINER=true
fi

# If inside container and no explicit flags, show inside-container commands
if [ "$IN_CONTAINER" = true ] && [ "$SHOW_FULL" = false ] && [ "$SHOW_ADMIN" = false ] && [ "$SHOW_ATOMIC" = false ]; then
    SHOW_INSIDE=true
fi

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# USER COMMANDS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

show_user_commands() {
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${BOLD}                    DS01 COMMAND REFERENCE${NC}"
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
    echo -e "${DIM}Workflow: user-setup â†’ project-init â†’ image-create â†’ container-deploy â†’ container-retire${NC}"
    echo ""

    # --- First-Time Setup ---
    echo -e "${BOLD}FIRST-TIME SETUP${NC} ${DIM}(run once)${NC}"
    echo -e "${CYAN}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
    echo -e "  ${GREEN}user-setup${NC}           Complete onboarding wizard"
    echo -e "                       ${DIM}(includes shell, ssh, vscode setup)${NC}"
    echo ""

    # --- Per-Project Setup ---
    echo -e "${BOLD}NEW PROJECT${NC} ${DIM}(run once per project)${NC}"
    echo -e "${CYAN}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
    echo -e "  ${GREEN}project-init${NC}         Create new project"
    echo -e "                       ${DIM}(sets up directory, git, dockerfile)${NC}"
    echo ""

    # --- Image Commands ---
    echo -e "${BOLD}IMAGE COMMANDS${NC}"
    echo -e "${CYAN}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
    echo -e "  ${GREEN}image-create${NC}         Build custom Docker image"
    echo -e "  ${GREEN}image-update${NC}         Rebuild/update image (edit Dockerfile)"
    echo -e "  ${GREEN}image-install${NC}        Quick: pip install packages + commit"
    echo -e "  ${GREEN}image-list${NC}           List available images"
    echo -e "  ${GREEN}image-delete${NC}         Remove an image"
    echo ""

    # --- Container Commands ---
    echo -e "${BOLD}CONTAINER COMMANDS${NC}"
    echo -e "${CYAN}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
    echo -e "  ${GREEN}container-deploy${NC}     Create + start container ${DIM}(begin working)${NC}"
    echo -e "  ${GREEN}container-retire${NC}     Stop + remove + free GPU ${DIM}(done for the day)${NC}"
    echo -e "  ${GREEN}container-list${NC}       List your containers"
    echo ""
    echo -e "  ${DIM}ğŸ’¡ For granular control: help --atomic (advanced users)${NC}"
    echo ""

    # --- Dashboard ---
    echo -e "${BOLD}DASHBOARD${NC}"
    echo -e "${CYAN}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
    echo -e "  ${GREEN}dashboard${NC}            System overview (GPUs, containers, usage)"
    echo -e "  ${GREEN}dashboard gpu${NC}        GPU allocation + utilization + MIG"
    echo -e "  ${GREEN}dashboard containers${NC} All containers with stats"
    echo -e "  ${GREEN}dashboard queue${NC}      GPU queue status"
    echo ""

    # --- Resource Info ---
    echo -e "${BOLD}RESOURCE INFO${NC}"
    echo -e "${CYAN}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
    echo -e "  ${GREEN}check-limits${NC}         Show your quotas and usage"
    echo -e "  ${GREEN}gpu-queue status${NC}     Check your queue position"
    echo -e "  ${GREEN}gpu-queue join${NC}       Join queue when GPUs unavailable"
    echo ""

    # --- Help ---
    echo -e "${BOLD}HELP${NC}"
    echo -e "${CYAN}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
    echo -e "  ${GREEN}help${NC}                 Show this reference"
    echo -e "  ${GREEN}help --atomic${NC}        Show atomic container commands"
    echo -e "  ${GREEN}help --admin${NC}         Show admin commands"
    echo -e "  ${GREEN}version${NC}              DS01 version"
    echo ""

    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${YELLOW}ğŸ’¡ Run 'help' or 'commands' anytime to see this list${NC}"
    echo ""
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ATOMIC CONTAINER COMMANDS (advanced)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

show_atomic_commands() {
    echo -e "${BOLD}ATOMIC CONTAINER COMMANDS${NC} ${DIM}(advanced - granular control)${NC}"
    echo -e "${CYAN}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
    echo ""
    echo -e "  ${GREEN}container-create${NC}     Create container (without starting)"
    echo -e "  ${GREEN}container-start${NC}      Start container in background"
    echo -e "  ${GREEN}container-run${NC}        Start + attach to container"
    echo -e "  ${GREEN}container-attach${NC}     Attach to running container"
    echo -e "  ${GREEN}container-stop${NC}       Stop a running container"
    echo -e "  ${GREEN}container-remove${NC}     Remove a stopped container"
    echo -e "  ${GREEN}container-pause${NC}      Pause a container"
    echo -e "  ${GREEN}container-unpause${NC}    Unpause (resume) a container"
    echo -e "  ${GREEN}container-stats${NC}      Show resource usage"
    echo -e "  ${GREEN}container-exit${NC}       Exit/detach from container"
    echo ""
    echo -e "  ${DIM}These commands give you fine-grained control over the container${NC}"
    echo -e "  ${DIM}lifecycle. Most users should use container-deploy/retire instead.${NC}"
    echo ""
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# INSIDE-CONTAINER COMMANDS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

show_inside_container_commands() {
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${BOLD}              INSIDE CONTAINER COMMANDS${NC}"
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""

    echo -e "${BOLD}Exit & Navigation:${NC}"
    echo -e "  ${GREEN}exit${NC}                 Exit container"
    echo -e "  ${GREEN}ws${NC} / ${GREEN}cdw${NC}             Go to /workspace"
    echo -e "  ${GREEN}ll${NC}                   List files (ls -lah)"
    echo ""

    echo -e "${BOLD}GPU & Development:${NC}"
    echo -e "  ${GREEN}gpu${NC}                  Check GPU status (nvidia-smi)"
    echo -e "  ${GREEN}gpu-watch${NC}            Watch GPU status (live)"
    echo -e "  ${GREEN}jlab${NC}                 Start Jupyter Lab"
    echo -e "  ${GREEN}jnb${NC}                  Start Jupyter Notebook"
    echo -e "  ${GREEN}tb${NC}                   Start TensorBoard"
    echo ""

    echo -e "${BOLD}Git Shortcuts:${NC}"
    echo -e "  ${GREEN}gs${NC}                   git status"
    echo -e "  ${GREEN}ga${NC}                   git add"
    echo -e "  ${GREEN}gc${NC}                   git commit"
    echo -e "  ${GREEN}gp${NC}                   git push"
    echo -e "  ${GREEN}gl${NC}                   git log (last 10)"
    echo -e "  ${GREEN}gd${NC}                   git diff"
    echo ""
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ADMIN COMMANDS (ds01-* prefix)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

show_admin_commands() {
    echo -e "${BOLD}ADMIN COMMANDS${NC} ${YELLOW}(ds01-* prefix)${NC}"
    echo -e "${CYAN}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
    echo ""

    echo -e "${BOLD}Deployment:${NC}"
    echo -e "  ${GREEN}sudo deploy${NC}          Redeploy all commands + fix permissions"
    echo ""

    echo -e "${BOLD}Dashboards:${NC}"
    echo -e "  ${GREEN}ds01-dashboard${NC}       Admin dashboard (superset of user)"
    echo -e "  ${GREEN}ds01-gpu${NC}             GPU allocation details"
    echo -e "  ${GREEN}ds01-containers${NC}      Container statistics"
    echo -e "  ${GREEN}ds01-gpu-util${NC}        Real-time GPU utilization"
    echo -e "  ${GREEN}ds01-mig-util${NC}        MIG instance utilization"
    echo ""

    echo -e "${BOLD}System:${NC}"
    echo -e "  ${GREEN}ds01-users${NC}           User management"
    echo -e "  ${GREEN}ds01-logs${NC}            Infrastructure logs"
    echo -e "  ${GREEN}ds01-events${NC}          Centralized event log"
    echo -e "  ${GREEN}ds01-mig-partition${NC}   Configure MIG partitioning"
    echo -e "  ${GREEN}ds01-who${NC}             Who owns which containers"
    echo -e "  ${GREEN}ds01-health${NC}          System health check"
    echo ""

    echo -e "${BOLD}Auditing:${NC}"
    echo -e "  ${GREEN}ds01-audit${NC}           System-wide audit"
    echo -e "  ${GREEN}ds01-audit-docker${NC}    Docker audit"
    echo -e "  ${GREEN}ds01-audit-container${NC} Container audit"
    echo ""

    echo -e "${BOLD}Resources:${NC}"
    echo -e "  ${GREEN}ds01-gpu-queue${NC}       GPU queue management (admin)"
    echo -e "  ${GREEN}ds01-alerts${NC}          Resource alerts"
    echo -e "  ${GREEN}ds01-idle${NC}            Check idle containers"
    echo ""

    echo -e "${BOLD}Maintenance:${NC}"
    echo -e "  ${GREEN}ds01-backup${NC}          Archive logs"
    echo ""
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# MAIN LOGIC
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

if [ "$SHOW_FULL" = true ]; then
    show_user_commands
    show_atomic_commands
    show_inside_container_commands
    show_admin_commands
elif [ "$SHOW_INSIDE" = true ] && [ "$SHOW_ADMIN" = false ] && [ "$SHOW_ATOMIC" = false ]; then
    show_inside_container_commands
else
    # Default: show user commands
    if [ "$SHOW_ADMIN" = false ] && [ "$SHOW_ATOMIC" = false ]; then
        show_user_commands
    fi

    # Show atomic if requested
    if [ "$SHOW_ATOMIC" = true ]; then
        show_atomic_commands
    fi

    # Show admin if requested
    if [ "$SHOW_ADMIN" = true ]; then
        show_admin_commands
    fi
fi
