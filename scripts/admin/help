#!/bin/bash
# help - Interactive help menu with examples

set -e

# Colors
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m'

show_main_menu() {
    clear
    cat << EOF
${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}
${BOLD}              DS01 INTERACTIVE HELP${NC}
${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}

${BOLD}Select a topic:${NC}

  ${GREEN}1${NC}) Getting Started (New Users)
  ${GREEN}2${NC}) Container Management
  ${GREEN}3${NC}) Image Management
  ${GREEN}4${NC}) GPU & Resources
  ${GREEN}5${NC}) Project & GitHub Setup
  ${GREEN}6${NC}) VS Code Remote Connection
  ${GREEN}7${NC}) Troubleshooting
  ${GREEN}8${NC}) Admin Commands
  ${GREEN}9${NC}) Quick Reference

  ${YELLOW}0${NC}) Exit

${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}
EOF
    echo -n "Choice: "
}

show_getting_started() {
    cat << EOF
${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}
${BOLD}GETTING STARTED${NC}
${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}

${BOLD}For New Users:${NC}

1. Run the setup wizard:
   ${CYAN}new-user-setup${NC}

   This will guide you through:
   - SSH key generation
   - Project creation
   - Custom Docker image

   For additional projects:
   ${CYAN}new-project-setup${NC}
   - VS Code setup

2. After setup, create your first container:
   ${CYAN}container create my-project pytorch${NC}

3. Start working:
   ${CYAN}container run my-project${NC}

4. Check GPU status:
   ${CYAN}nvidia-smi${NC}

${BOLD}Quick Commands:${NC}
  ${CYAN}alias-list${NC}          See all available commands
  ${CYAN}container --help${NC}    Container management help
  ${CYAN}image --help${NC}        Image management help

Press Enter to continue...
EOF
    read
}

show_containers() {
    cat << EOF
${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}
${BOLD}CONTAINER MANAGEMENT${NC}
${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}

${BOLD}Create a container:${NC}
  ${CYAN}container create <name> <framework>${NC}

  Examples:
    container create my-project pytorch
    container create cv-work tensorflow
    container create analysis pytorch --cpu-only

${BOLD}Start container:${NC}
  ${CYAN}container run <name>${NC}

${BOLD}Stop container:${NC}
  ${CYAN}container stop <name>${NC}

${BOLD}Exit without stopping:${NC}
  ${CYAN}container exit${NC}
  ${CYAN}Ctrl+P, Ctrl+Q${NC}  (keyboard shortcut)

${BOLD}List containers:${NC}
  ${CYAN}container list${NC}

${BOLD}Resource usage:${NC}
  ${CYAN}container stats${NC}

${BOLD}Clean up stopped containers:${NC}
  ${CYAN}container cleanup${NC}

Press Enter to continue...
EOF
    read
}

show_images() {
    cat << EOF
${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}
${BOLD}IMAGE MANAGEMENT${NC}
${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}

${BOLD}Create custom image:${NC}
  ${CYAN}image create${NC}

  Interactive wizard will ask about:
  - Base framework (PyTorch/TensorFlow)
  - Use case (CV/NLP/RL/General)
  - Additional packages
  - System packages

${BOLD}List images:${NC}
  ${CYAN}image list${NC}

${BOLD}Update/rebuild image:${NC}
  ${CYAN}image update <image-name>${NC}

${BOLD}Delete image:${NC}
  ${CYAN}image delete <image-name>${NC}

${BOLD}Using custom images:${NC}
  After creating an image, create a container from it:
  ${CYAN}container create my-container my-custom-image${NC}

Press Enter to continue...
EOF
    read
}

show_gpu() {
    cat << EOF
${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}
${BOLD}GPU & RESOURCES${NC}
${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}

${BOLD}Check GPU status:${NC}
  ${CYAN}nvidia-smi${NC}

${BOLD}Monitor GPU in real-time:${NC}
  ${CYAN}watch -n 1 nvidia-smi${NC}

${BOLD}Check your resource limits:${NC}
  ${CYAN}container create --show-limits${NC}

${BOLD}View container resource usage:${NC}
  ${CYAN}container stats${NC}

${BOLD}MIG Instances:${NC}
  This server uses MIG (Multi-Instance GPU) partitioning:
  - Each GPU is split into multiple instances
  - Students typically get 1-2 MIG instances
  - Researchers get 2-4 MIG instances
  - Admins can use full GPUs

${BOLD}Resource Quotas:${NC}
  Your resource limits are defined in:
  /opt/ds01-infra/config/resource-limits.yaml

  Contact admin to request changes.

Press Enter to continue...
EOF
    read
}

show_projects() {
    cat << EOF
${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}
${BOLD}PROJECT & GITHUB SETUP${NC}
${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}

${BOLD}Create new project:${NC}
  ${CYAN}project init${NC}

  This creates:
  - Project directory structure
  - README.md template
  - Optional GitHub integration

${BOLD}Project structure:${NC}
  my-project/
  ├── data/           # Datasets
  ├── models/         # Saved models
  ├── notebooks/      # Jupyter notebooks
  ├── scripts/        # Python scripts
  ├── outputs/        # Results
  └── README.md

${BOLD}Configure SSH for GitHub:${NC}
  ${CYAN}ssh-config${NC}

${BOLD}Best practices:${NC}
  - Keep all work in ~/workspace/<project>/
  - This directory persists across container restarts
  - Use git for version control
  - Checkpoint models regularly

Press Enter to continue...
EOF
    read
}

show_vscode() {
    cat << EOF
${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}
${BOLD}VS CODE REMOTE CONNECTION${NC}
${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}

${BOLD}1. Install VS Code Extensions:${NC}
   - Remote - SSH
   - Docker
   - Python
   - Jupyter

${BOLD}2. Configure SSH:${NC}
   On your local machine, edit ~/.ssh/config:

   ${CYAN}Host ds01
       HostName <server-ip>
       User <your-username>
       ForwardAgent yes
       ServerAliveInterval 60${NC}

${BOLD}3. Connect:${NC}
   - Command Palette (Ctrl+Shift+P)
   - "Remote-SSH: Connect to Host"
   - Select "ds01"

${BOLD}4. Work in Container:${NC}
   Open terminal in VS Code, then:
   ${CYAN}container run my-project${NC}

   Your workspace is mounted at /workspace

${BOLD}Get SSH key:${NC}
  ${CYAN}ssh-config${NC}

Press Enter to continue...
EOF
    read
}

show_troubleshooting() {
    cat << EOF
${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}
${BOLD}TROUBLESHOOTING${NC}
${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}

${BOLD}Container won't start:${NC}
  1. Check if it exists: ${CYAN}container list${NC}
  2. Check GPU availability: ${CYAN}nvidia-smi${NC}
  3. Check logs: ${CYAN}docker logs <container-name>${NC}

${BOLD}Out of GPU memory:${NC}
  - Reduce batch size
  - Use gradient accumulation
  - Check if other processes are using GPU
  - Stop unused containers

${BOLD}Permission denied:${NC}
  - Ensure you're in docker group:
    ${CYAN}groups${NC}
  - If not: ${CYAN}sudo usermod -aG docker \$USER${NC}
  - Logout and login again

${BOLD}Docker command not found:${NC}
  - Check if Docker is installed
  - Check PATH includes /usr/local/bin
  - Run: ${CYAN}alias-list${NC} to see available commands

${BOLD}Can't access /workspace:${NC}
  - Workspace is only accessible inside containers
  - Make sure you're inside a running container

${BOLD}Need help?${NC}
  - Check logs: ${CYAN}ds01-logs${NC}
  - See documentation in /home/shared/docs/
  - Contact admin or office hours

Press Enter to continue...
EOF
    read
}

show_admin() {
    cat << EOF
${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}
${BOLD}ADMIN COMMANDS${NC}
${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}

${BOLD}System overview:${NC}
  ${CYAN}ds01-dashboard${NC}

  Shows:
  - GPU/MIG status
  - Container statistics
  - Active users
  - Resource usage
  - System health

${BOLD}View logs:${NC}
  ${CYAN}ds01-logs${NC}             All recent logs
  ${CYAN}ds01-logs gpu${NC}         GPU allocation logs
  ${CYAN}ds01-logs gpu -f${NC}      Follow GPU logs
  ${CYAN}ds01-logs cleanup${NC}     Cleanup logs

${BOLD}User activity:${NC}
  ${CYAN}ds01-users${NC}            Active users summary
  ${CYAN}ds01-users -d${NC}         Detailed per-user stats

${BOLD}Command management:${NC}
  ${CYAN}alias-list${NC}            List all commands
  ${CYAN}alias-create${NC}          Create custom aliases

Press Enter to continue...
EOF
    read
}

show_quick_reference() {
    cat << EOF
${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}
${BOLD}QUICK REFERENCE${NC}
${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}

${BOLD}Most Common Commands:${NC}

${GREEN}container list${NC}             List my containers
${GREEN}container create <name> pytorch${NC}    Create container
${GREEN}container run <name>${NC}       Start container
${GREEN}container stop <name>${NC}      Stop container
${GREEN}container stats${NC}            Resource usage

${GREEN}image list${NC}                 List available images
${GREEN}image create${NC}               Build custom image

${GREEN}nvidia-smi${NC}                 Check GPU status
${GREEN}new-user-setup${NC}             First-time setup wizard
${GREEN}new-project-setup${NC}          Create new project
${GREEN}git-ml-repo-setup${NC}          Initialize Git for ML project

${GREEN}alias-list${NC}                 See all commands
${GREEN}help${NC}                       This help menu

${BOLD}Admin Commands:${NC}
${GREEN}ds01-dashboard${NC}             System overview
${GREEN}ds01-logs${NC}                  View logs
${GREEN}ds01-users${NC}                 Active users

Press Enter to continue...
EOF
    read
}

# Main loop
while true; do
    show_main_menu
    read choice

    case $choice in
        1) show_getting_started ;;
        2) show_containers ;;
        3) show_images ;;
        4) show_gpu ;;
        5) show_projects ;;
        6) show_vscode ;;
        7) show_troubleshooting ;;
        8) show_admin ;;
        9) show_quick_reference ;;
        0) echo ""; echo "Goodbye!"; echo ""; exit 0 ;;
        *) echo -e "${RED}Invalid choice${NC}"; sleep 1 ;;
    esac
done
