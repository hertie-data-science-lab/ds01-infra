#!/bin/bash
# version - Show DS01 infrastructure version and system info

set -e

# Colors
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m'

# Get DS01 version
INFRA_DIR="/opt/ds01-infra"
VERSION_FILE="$INFRA_DIR/VERSION"

# Read version from VERSION file (source of truth)
if [ -f "$VERSION_FILE" ]; then
    DS01_VERSION="v$(cat "$VERSION_FILE")"
else
    DS01_VERSION="unknown"
fi

# Get git info for commit hash
if [ -d "$INFRA_DIR/.git" ]; then
    cd "$INFRA_DIR"
    GIT_COMMIT=$(git rev-parse --short HEAD 2>/dev/null || echo "unknown")
    GIT_BRANCH=$(git branch --show-current 2>/dev/null || echo "unknown")
    GIT_DATE=$(git log -1 --format=%cd --date=short 2>/dev/null || echo "unknown")
else
    GIT_COMMIT="unknown"
    GIT_BRANCH="unknown"
    GIT_DATE="unknown"
fi

echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo -e "${BOLD}              DS01 GPU SERVER INFRASTRUCTURE${NC}"
echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo ""

# DS01 Version
echo -e "${BOLD}DS01 Infrastructure:${NC}"
echo -e "  Version:      ${GREEN}${DS01_VERSION}${NC} (${GIT_BRANCH}@${GIT_COMMIT})"
echo -e "  Last update:  ${GIT_DATE}"
echo -e "  Location:     ${INFRA_DIR}"
echo ""

# Base system
if [ -d "$INFRA_ROOT/aime-ml-containers" ]; then
    echo -e "${BOLD}Base System:${NC}"
    echo -e "  aime-ml-containers: ${GREEN}installed${NC}"
    echo -e "  Location: $INFRA_ROOT/aime-ml-containers"
    echo ""
fi

# System info
echo -e "${BOLD}System:${NC}"
echo -e "  Hostname:     $(hostname)"
echo -e "  OS:           $(lsb_release -d 2>/dev/null | cut -f2 || uname -s)"
echo -e "  Kernel:       $(uname -r)"
echo ""

# Docker
if command -v docker &>/dev/null; then
    DOCKER_VERSION=$(docker --version | cut -d' ' -f3 | tr -d ',')
    echo -e "${BOLD}Docker:${NC}"
    echo -e "  Version:      ${GREEN}${DOCKER_VERSION}${NC}"

    if command -v nvidia-docker &>/dev/null || docker run --rm --gpus all nvidia/cuda:11.0-base nvidia-smi &>/dev/null 2>&1; then
        echo -e "  NVIDIA Runtime: ${GREEN}enabled${NC}"
    else
        echo -e "  NVIDIA Runtime: ${YELLOW}not detected${NC}"
    fi
    echo ""
fi

# GPU
if command -v nvidia-smi &>/dev/null; then
    echo -e "${BOLD}NVIDIA GPUs:${NC}"
    GPU_COUNT=$(nvidia-smi --query-gpu=count --format=csv,noheader | head -1)
    GPU_DRIVER=$(nvidia-smi --query-gpu=driver_version --format=csv,noheader | head -1)
    GPU_CUDA=$(nvidia-smi --query-gpu=cuda_version --format=csv,noheader | head -1)

    echo -e "  Count:        ${GREEN}${GPU_COUNT}${NC}"
    echo -e "  Driver:       ${GPU_DRIVER}"
    echo -e "  CUDA:         ${GPU_CUDA}"

    # MIG status
    if nvidia-smi -L | grep -q "MIG"; then
        MIG_COUNT=$(nvidia-smi mig -lgi 2>/dev/null | grep -c "MIG") || MIG_COUNT=0
        echo -e "  MIG Instances: ${GREEN}${MIG_COUNT}${NC} (enabled)"
    fi
    echo ""
fi

# Python
if command -v python3 &>/dev/null; then
    PYTHON_VERSION=$(python3 --version | cut -d' ' -f2)
    echo -e "${BOLD}Python:${NC}"
    echo -e "  Version:      ${GREEN}${PYTHON_VERSION}${NC}"

    if python3 -c "import yaml" 2>/dev/null; then
        echo -e "  PyYAML:       ${GREEN}installed${NC}"
    else
        echo -e "  PyYAML:       ${RED}missing${NC}"
    fi
    echo ""
fi

# Resource limits config
CONFIG_FILE="${INFRA_DIR}/config/runtime/resource-limits.yaml"
if [ -f "$CONFIG_FILE" ]; then
    echo -e "${BOLD}Configuration:${NC}"
    echo -e "  Config file:  ${GREEN}found${NC}"
    echo -e "  Location:     ${CONFIG_FILE}"

    # Count groups
    if command -v yq &>/dev/null; then
        GROUP_COUNT=$(yq eval '.groups | keys | length' "$CONFIG_FILE" 2>/dev/null || echo "?")
        echo -e "  User groups:  ${GROUP_COUNT}"
    fi
    echo ""
fi

echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo ""
echo -e "${BOLD}Useful commands:${NC}"
echo "  alias-list          List all available commands"
echo "  ds01-dashboard      System overview"
echo "  help                Interactive help menu"
echo ""
