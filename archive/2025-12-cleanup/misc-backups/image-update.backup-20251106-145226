#!/bin/bash
# Rebuild/update Docker image from existing Dockerfile

BLUE='\033[94m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m'

USERNAME=$(whoami)
IMAGES_DIR="$HOME/docker-images"

usage() {
    echo ""
    echo -e "${BOLD}Docker Image Updater${NC}"
    echo ""
    echo -e "${CYAN}Usage:${NC}"
    echo "  image-update <image-name> [options]"
    echo ""
    echo -e "${CYAN}Options:${NC}"
    echo "  --edit          Edit Dockerfile before rebuilding"
    echo "  --no-cache      Build without using cache (clean rebuild)"
    echo "  -h, --help      Show this help message"
    echo ""
    echo -e "${CYAN}Description:${NC}"
    echo "  Rebuilds an existing Docker image from its Dockerfile."
    echo "  Useful for updating packages or modifying configuration."
    echo ""
    echo -e "${CYAN}Examples:${NC}"
    echo "  image-update my-project                # Rebuild from existing Dockerfile"
    echo "  image-update my-project --edit         # Edit Dockerfile first, then rebuild"
    echo "  image-update my-project --no-cache     # Clean rebuild (ignores cache)"
    echo ""
    echo -e "${CYAN}Common Updates:${NC}"
    echo "  ‚Ä¢ Add packages: Edit Dockerfile, add to RUN pip install line"
    echo "  ‚Ä¢ Update versions: Change version numbers in FROM or RUN commands"
    echo "  ‚Ä¢ Add system tools: Add to apt-get install line"
    echo ""
    echo -e "${YELLOW}üí° Tip:${NC} After updating, recreate containers to use the new image:"
    echo -e "     ${GREEN}container-cleanup my-project${NC}"
    echo -e "     ${GREEN}container-create my-project${NC}"
    echo ""
}

# Parse arguments
IMAGE_NAME=""
EDIT_FIRST=false
NO_CACHE=false

while [[ $# -gt 0 ]]; do
    case $1 in
        --edit)
            EDIT_FIRST=true
            shift
            ;;
        --no-cache)
            NO_CACHE=true
            shift
            ;;
        -h|--help)
            usage
            exit 0
            ;;
        -*)
            echo -e "${RED}Unknown option: $1${NC}\n"
            usage
            exit 1
            ;;
        *)
            if [ -z "$IMAGE_NAME" ]; then
                IMAGE_NAME="$1"
            else
                echo -e "${RED}Multiple image names specified${NC}\n"
                usage
                exit 1
            fi
            shift
            ;;
    esac
done

# Validate image name
if [ -z "$IMAGE_NAME" ]; then
    echo -e "${RED}Error: Image name is required${NC}\n"
    usage
    exit 1
fi

# Add username prefix if not present
if [[ ! "$IMAGE_NAME" =~ ^${USERNAME}- ]]; then
    IMAGE_NAME="${USERNAME}-${IMAGE_NAME}"
fi

# Check if image exists
if ! docker images --format "{{.Repository}}" | grep -q "^${IMAGE_NAME}$"; then
    echo -e "${RED}‚úó Image '$IMAGE_NAME' not found${NC}\n"
    echo "Available images:"
    docker images --format "  {{.Repository}}" --filter "reference=${USERNAME}-*"
    echo ""
    echo "Create new image with: ${GREEN}image-create${NC}"
    exit 1
fi

# Find Dockerfile
DOCKERFILE=""

# Check info file first
INFO_FILE="$HOME/ds01-config/images/${IMAGE_NAME}.info"
if [ -f "$INFO_FILE" ]; then
    DOCKERFILE=$(grep "^Dockerfile:" "$INFO_FILE" | cut -d: -f2- | xargs)
fi

# Fallback to standard location
if [ -z "$DOCKERFILE" ] || [ ! -f "$DOCKERFILE" ]; then
    DOCKERFILE="$IMAGES_DIR/${IMAGE_NAME}.Dockerfile"
fi

# Check if Dockerfile exists
if [ ! -f "$DOCKERFILE" ]; then
    echo -e "${RED}‚úó Dockerfile not found${NC}"
    echo "Expected location: $DOCKERFILE"
    echo ""
    read -p "Enter path to Dockerfile: " CUSTOM_PATH
    if [ -f "$CUSTOM_PATH" ]; then
        DOCKERFILE="$CUSTOM_PATH"
    else
        echo -e "${RED}‚úó File not found: $CUSTOM_PATH${NC}"
        exit 1
    fi
fi

echo -e "${CYAN}‚îÅ‚îÅ‚îÅ Updating Image: ${BOLD}$IMAGE_NAME${NC} ${CYAN}‚îÅ‚îÅ‚îÅ${NC}\n"
echo -e "Dockerfile: ${BLUE}$DOCKERFILE${NC}\n"

# Show current image info
CURRENT_SIZE=$(docker images --format "{{.Size}}" "$IMAGE_NAME" | head -1)
CURRENT_CREATED=$(docker images --format "{{.CreatedAt}}" "$IMAGE_NAME" | head -1)

echo -e "${BOLD}Current image:${NC}"
echo "  Size:    $CURRENT_SIZE"
echo "  Created: $CURRENT_CREATED"
echo ""

# Edit Dockerfile if requested
if [ "$EDIT_FIRST" = true ]; then
    echo -e "${YELLOW}Opening Dockerfile in editor...${NC}"
    ${EDITOR:-vim} "$DOCKERFILE"
    echo ""
fi

# Confirm rebuild
echo -e "${YELLOW}‚ö† This will rebuild the image from the Dockerfile${NC}"
if [ "$NO_CACHE" = true ]; then
    echo -e "${YELLOW}‚ö† Building without cache (clean rebuild)${NC}"
fi
echo ""
read -p "Continue? [Y/n]: " CONFIRM
CONFIRM=${CONFIRM:-Y}

if [[ ! "$CONFIRM" =~ ^[Yy]$ ]]; then
    echo "Cancelled."
    exit 0
fi

# Build command
BUILD_CMD="docker build -t $IMAGE_NAME -f $DOCKERFILE"
if [ "$NO_CACHE" = true ]; then
    BUILD_CMD="$BUILD_CMD --no-cache"
fi
BUILD_CMD="$BUILD_CMD $IMAGES_DIR/"

echo -e "\n${CYAN}Building image...${NC}"
echo -e "${YELLOW}This may take 3-5 minutes${NC}\n"

# Build
if eval "$BUILD_CMD"; then
    echo -e "\n${GREEN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
    echo -e "${GREEN}${BOLD}‚úì Image updated successfully!${NC}"
    echo -e "${GREEN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}\n"

    # Show new image info
    NEW_SIZE=$(docker images --format "{{.Size}}" "$IMAGE_NAME" | head -1)
    NEW_CREATED=$(docker images --format "{{.CreatedAt}}" "$IMAGE_NAME" | head -1)

    echo -e "${BOLD}Updated image:${NC}"
    echo "  Size:    $NEW_SIZE"
    echo "  Created: $NEW_CREATED"
    echo ""

    # Update metadata
    if [ -f "$INFO_FILE" ]; then
        sed -i.bak "s/^Created:.*/Created: $(date)/" "$INFO_FILE"
        rm -f "${INFO_FILE}.bak"
    fi

    # Check for containers using old image
    OLD_CONTAINERS=$(docker ps -a --filter "ancestor=$IMAGE_NAME" --format "{{.Names}}" | wc -l)
    if [ "$OLD_CONTAINERS" -gt 0 ]; then
        echo -e "${YELLOW}‚ö† $OLD_CONTAINERS container(s) still use the old image${NC}\n"
        echo "To use the updated image, recreate your containers:"
        echo "  1. List containers: ${GREEN}container-list${NC}"
        echo "  2. Stop old containers: ${GREEN}container-stop <name>${NC}"
        echo "  3. Remove old containers: ${GREEN}container-cleanup${NC}"
        echo "  4. Create new container: ${GREEN}container-create <name>${NC}"
        echo ""
    fi

    echo -e "${YELLOW}üí° Tip:${NC} Run ${GREEN}image-list --detailed${NC} to see all your images"
else
    echo -e "\n${RED}‚úó Build failed${NC}"
    echo ""
    echo "Troubleshooting:"
    echo "  1. Check Dockerfile syntax: ${BLUE}cat $DOCKERFILE${NC}"
    echo "  2. Edit Dockerfile: ${GREEN}image-update $IMAGE_NAME --edit${NC}"
    echo "  3. Try clean rebuild: ${GREEN}image-update $IMAGE_NAME --no-cache${NC}"
    exit 1
fi

echo ""
