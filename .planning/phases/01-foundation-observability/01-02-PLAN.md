---
phase: 01-foundation-observability
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - monitoring/docker-compose.yaml
  - config/deploy/systemd/ds01-dcgm-exporter.service
autonomous: true

must_haves:
  truths:
    - "DCGM exporter has a systemd service with Restart=always and explicit ExecStop to prevent hangs"
    - "DCGM exporter auto-restarts on failure without manual intervention"
    - "Monitoring stack docker-compose still works with DCGM managed by systemd"
  artifacts:
    - path: "config/deploy/systemd/ds01-dcgm-exporter.service"
      provides: "Systemd service unit for DCGM exporter"
      contains: "ExecStop"
      min_lines: 15
    - path: "monitoring/docker-compose.yaml"
      provides: "Updated monitoring stack without DCGM in docker-compose restart management"
  key_links:
    - from: "config/deploy/systemd/ds01-dcgm-exporter.service"
      to: "docker"
      via: "ExecStart docker start -a"
      pattern: "docker start.*dcgm"
---

<objective>
Fix DCGM exporter stability by creating a proper systemd service with restart policies and explicit stop handling.

Purpose: DCGM exporter crashes periodically (known issue, blocker noted in STATE.md). Research identified the root cause: missing ExecStop directive causes systemd restart hangs (GitHub Issue #606). Also, race conditions with MIG-enabled GPUs during concurrent restart need sequencing via systemd dependencies. The fix is a robust systemd service file that replaces docker-compose restart management for DCGM.

Output: `config/deploy/systemd/ds01-dcgm-exporter.service` systemd unit file, updated `monitoring/docker-compose.yaml` to stop managing DCGM restarts (container still defined for creation, but restart policy delegated to systemd).
</objective>

<execution_context>
@/home/datasciencelab/.claude/get-shit-done/workflows/execute-plan.md
@/home/datasciencelab/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-observability/01-CONTEXT.md
@.planning/phases/01-foundation-observability/01-RESEARCH.md
@monitoring/docker-compose.yaml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create DCGM exporter systemd service</name>
  <files>config/deploy/systemd/ds01-dcgm-exporter.service</files>
  <action>
Create `config/deploy/systemd/ds01-dcgm-exporter.service` with robust restart and stop handling.

**Requirements from research (Pattern 4, Pitfalls 1 and 3):**

```ini
[Unit]
Description=DS01 DCGM Exporter (GPU metrics)
Documentation=https://github.com/NVIDIA/dcgm-exporter
After=network-online.target docker.service
Wants=network-online.target
Requires=docker.service

[Service]
Type=simple
Restart=always
RestartSec=10s
ExecStartPre=/usr/bin/docker pull nvcr.io/nvidia/k8s/dcgm-exporter:3.3.0-3.2.0-ubuntu22.04 || true
ExecStart=/usr/bin/docker start -a ds01-dcgm-exporter
ExecStop=/usr/bin/docker stop -t 30 ds01-dcgm-exporter
TimeoutStopSec=45s
TimeoutStartSec=120s

# Restart limits
StartLimitIntervalSec=300
StartLimitBurst=5

[Install]
WantedBy=multi-user.target
```

**Key decisions (from research):**
- `ExecStop` with explicit `docker stop` prevents the hang described in GitHub Issue #606
- `TimeoutStopSec=45s` gives 30s for graceful stop + 15s buffer before SIGKILL
- `RestartSec=10s` brief delay prevents rapid restart loops
- `StartLimitBurst=5` in 300s prevents infinite restart if fundamentally broken
- `ExecStartPre` with `|| true` attempts pull but doesn't fail if offline
- Uses `/usr/bin/docker` (real Docker binary, not the DS01 wrapper) — DCGM container is infrastructure, not user workload
- `After=docker.service` ensures Docker is ready; no `After=nvidia-dcgm.service` needed since we're not running standalone DCGM host engine (Pitfall 3 about MIG race conditions applies to k8s device plugin, not our setup)

**Important:** The container `ds01-dcgm-exporter` is created by docker-compose but its restart lifecycle is managed by this systemd service. This is the same hybrid pattern already used for `ds01-exporter.service`.

Include a comment header explaining: this service manages the restart lifecycle of the ds01-dcgm-exporter container created by docker-compose. Deploy with `sudo cp` to `/etc/systemd/system/` and `sudo systemctl enable ds01-dcgm-exporter`.
  </action>
  <verify>
Validate the unit file: `systemd-analyze verify /opt/ds01-infra/config/deploy/systemd/ds01-dcgm-exporter.service 2>&1` should show no critical errors (warnings about missing targets are acceptable on non-systemd machines).
Check required directives: `grep -c "ExecStop\|Restart=always\|TimeoutStopSec" /opt/ds01-infra/config/deploy/systemd/ds01-dcgm-exporter.service` should be >= 3.
  </verify>
  <done>
- Systemd service file exists at `config/deploy/systemd/ds01-dcgm-exporter.service`
- Contains ExecStop with explicit docker stop command
- Contains Restart=always policy
- Contains TimeoutStopSec for force-kill fallback
- Contains restart rate limiting (StartLimitBurst)
  </done>
</task>

<task type="auto">
  <name>Task 2: Update docker-compose to delegate DCGM restart to systemd</name>
  <files>monitoring/docker-compose.yaml</files>
  <action>
Update `monitoring/docker-compose.yaml` to change the DCGM exporter's restart policy.

**Change:** In the `dcgm-exporter` service, change `restart: unless-stopped` to `restart: "no"`.

**Rationale:** The systemd service (`ds01-dcgm-exporter.service`) now manages restart lifecycle. Having docker-compose also manage restarts creates conflicts — both will try to restart the container, potentially triggering the MIG race condition (Pitfall 3).

**Also add a comment** above the dcgm-exporter service explaining:
```yaml
  # DCGM Exporter - restart lifecycle managed by systemd service
  # See: config/deploy/systemd/ds01-dcgm-exporter.service
  # docker-compose creates the container; systemd manages restarts
```

**Do NOT change anything else** in docker-compose.yaml. The container definition (image, ports, volumes, labels, etc.) stays the same — docker-compose still creates the container.
  </action>
  <verify>
Check the restart policy: `grep -A1 "dcgm-exporter:" /opt/ds01-infra/monitoring/docker-compose.yaml | head -5` and `grep 'restart:' /opt/ds01-infra/monitoring/docker-compose.yaml` — DCGM should show `restart: "no"`, other services should still show `restart: unless-stopped`.
  </verify>
  <done>
- DCGM exporter restart policy changed to "no" in docker-compose.yaml
- Comment explains systemd manages restarts
- All other services unchanged
- docker-compose still creates the DCGM container (image, ports, env, labels preserved)
  </done>
</task>

</tasks>

<verification>
1. Systemd service file: `test -f /opt/ds01-infra/config/deploy/systemd/ds01-dcgm-exporter.service && echo "EXISTS"`
2. Required directives: `grep -E "ExecStop|Restart=always|TimeoutStopSec" /opt/ds01-infra/config/deploy/systemd/ds01-dcgm-exporter.service`
3. Docker-compose DCGM restart: `python3 -c "import yaml; d=yaml.safe_load(open('/opt/ds01-infra/monitoring/docker-compose.yaml')); print(d['services']['dcgm-exporter']['restart'])"` should print "no"
4. Other services unchanged: `python3 -c "import yaml; d=yaml.safe_load(open('/opt/ds01-infra/monitoring/docker-compose.yaml')); print(d['services']['prometheus']['restart'])"` should print "unless-stopped"
</verification>

<success_criteria>
- DCGM exporter has a systemd service file with robust restart and stop handling
- docker-compose delegates restart management to systemd for DCGM
- All other monitoring services in docker-compose remain unchanged
- Service file ready for deployment (sudo cp + systemctl enable)
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-observability/01-02-SUMMARY.md`
</output>
