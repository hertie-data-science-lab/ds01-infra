---
phase: 01-foundation-observability
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - .github/workflows/release.yml
  - .github/workflows/lint.yml
  - .releaserc.json
autonomous: true

must_haves:
  truths:
    - "Merging a conventional commit to main triggers semantic version bump and GitHub release"
    - "Pull requests to main run ruff linting checks"
    - "CHANGELOG.md is auto-generated from conventional commit history on each release"
    - "Version tags follow vMAJOR.MINOR.PATCH format"
  artifacts:
    - path: ".github/workflows/release.yml"
      provides: "Automated semantic versioning on merge to main"
      contains: "semantic-release"
      min_lines: 30
    - path: ".github/workflows/lint.yml"
      provides: "Ruff linting on pull requests"
      contains: "ruff"
      min_lines: 15
    - path: ".releaserc.json"
      provides: "semantic-release configuration"
      contains: "commit-analyzer"
  key_links:
    - from: ".github/workflows/release.yml"
      to: ".releaserc.json"
      via: "npx semantic-release reads config"
      pattern: "semantic-release"
    - from: ".github/workflows/lint.yml"
      to: "pyproject.toml"
      via: "ruff reads config"
      pattern: "ruff"
---

<objective>
Replace the fragile commitizen-based release workflow with semantic-release for robust automated versioning, and add a ruff linting workflow for PRs.

Purpose: CICD-01 requirement — "Automated semantic versioning via CI pipeline produces correct version tags on merge to main." The current release.yml uses commitizen with workflow_dispatch (manual trigger only), which the CONTEXT.md notes as "fragile." Replace with semantic-release that automatically runs on push to main, determines version bump from conventional commits, generates CHANGELOG.md, and creates GitHub releases.

Output: Rewritten `.github/workflows/release.yml` (semantic-release, auto on merge), new `.github/workflows/lint.yml` (ruff on PRs), new `.releaserc.json` (semantic-release config).
</objective>

<execution_context>
@/home/datasciencelab/.claude/get-shit-done/workflows/execute-plan.md
@/home/datasciencelab/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-observability/01-CONTEXT.md
@.planning/phases/01-foundation-observability/01-RESEARCH.md
@.github/workflows/release.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace release workflow with semantic-release</name>
  <files>.github/workflows/release.yml, .releaserc.json</files>
  <action>
**Part A: Rewrite `.github/workflows/release.yml`**

Replace the current commitizen-based workflow with semantic-release. The workflow should:

1. **Trigger on push to main** (automatic on merge, not workflow_dispatch)
2. Also support `workflow_dispatch` for manual releases with dry-run option
3. Use Node.js + semantic-release (not Python commitizen)

```yaml
name: Release

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (preview without releasing)'
        type: boolean
        default: false

jobs:
  release:
    name: Semantic Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'

      - name: Install semantic-release
        run: npm install -g semantic-release @semantic-release/changelog @semantic-release/git @semantic-release/exec

      - name: Dry run
        if: ${{ github.event.inputs.dry_run == 'true' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: npx semantic-release --dry-run

      - name: Release
        if: ${{ github.event.inputs.dry_run != 'true' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: npx semantic-release
```

**Part B: Create `.releaserc.json`**

```json
{
  "branches": ["main"],
  "plugins": [
    "@semantic-release/commit-analyzer",
    "@semantic-release/release-notes-generator",
    ["@semantic-release/changelog", {
      "changelogFile": "CHANGELOG.md"
    }],
    ["@semantic-release/exec", {
      "prepareCmd": "echo ${nextRelease.version} > VERSION"
    }],
    ["@semantic-release/git", {
      "assets": ["CHANGELOG.md", "VERSION"],
      "message": "chore(release): ${nextRelease.version} [skip ci]\n\n${nextRelease.notes}"
    }],
    "@semantic-release/github"
  ]
}
```

**Key decisions from CONTEXT.md:**
- Hybrid: semantic-release auto-suggests bump from conventional commits; the `[skip ci]` in the release commit prevents infinite loops
- Auto-generated CHANGELOG.md from commit history
- VERSION file updated (preserves compatibility with existing tooling)
- `@semantic-release/exec` updates the VERSION file
- `@semantic-release/github` creates GitHub releases with release notes

**Important:** Remove all commitizen references. The `cz bump` commands are replaced by semantic-release's `@semantic-release/commit-analyzer` which reads conventional commits to determine bump type.
  </action>
  <verify>
YAML validity: `python3 -c "import yaml; yaml.safe_load(open('/opt/ds01-infra/.github/workflows/release.yml'))"`
JSON validity: `python3 -c "import json; json.load(open('/opt/ds01-infra/.releaserc.json'))"`
Check trigger: `grep "push:" /opt/ds01-infra/.github/workflows/release.yml`
Check semantic-release: `grep "semantic-release" /opt/ds01-infra/.github/workflows/release.yml`
Check no commitizen: `grep -c "commitizen\|cz bump" /opt/ds01-infra/.github/workflows/release.yml` should be 0.
  </verify>
  <done>
- release.yml triggers on push to main (automatic) + workflow_dispatch (manual)
- Uses semantic-release with commit-analyzer, changelog, git, github plugins
- .releaserc.json configures plugins and CHANGELOG/VERSION file management
- No commitizen references remain
- Dry-run option preserved for manual verification
  </done>
</task>

<task type="auto">
  <name>Task 2: Create ruff linting workflow for PRs</name>
  <files>.github/workflows/lint.yml</files>
  <action>
Create `.github/workflows/lint.yml` for ruff linting on pull requests.

```yaml
name: Lint

on:
  pull_request:
    branches: [main]
    paths:
      - '**.py'
      - 'pyproject.toml'

jobs:
  ruff:
    name: Ruff Lint & Format Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install ruff
        run: pip install ruff

      - name: Ruff format check
        run: ruff format --check .

      - name: Ruff lint
        run: ruff check .
```

**Scope from CONTEXT.md:** "Ruff linting on PRs" — only run on Python file changes (paths filter). Two checks: format (would ruff change anything?) and lint (rule violations).

This workflow only runs on PRs to main, matching the project's branch workflow.
  </action>
  <verify>
YAML validity: `python3 -c "import yaml; yaml.safe_load(open('/opt/ds01-infra/.github/workflows/lint.yml'))"`
Check trigger: `grep "pull_request:" /opt/ds01-infra/.github/workflows/lint.yml`
Check ruff: `grep -c "ruff" /opt/ds01-infra/.github/workflows/lint.yml` should be >= 3.
  </verify>
  <done>
- lint.yml triggers on PRs to main affecting Python files
- Runs ruff format check and ruff lint
- Uses Python 3.11 matching project conventions
  </done>
</task>

</tasks>

<verification>
1. Release workflow: `grep "semantic-release" /opt/ds01-infra/.github/workflows/release.yml`
2. Auto-trigger: `grep -A1 "push:" /opt/ds01-infra/.github/workflows/release.yml | grep "main"`
3. Config valid: `python3 -c "import json; c=json.load(open('/opt/ds01-infra/.releaserc.json')); print(len(c['plugins']), 'plugins')"` should show 6 plugins
4. Lint workflow: `grep "ruff" /opt/ds01-infra/.github/workflows/lint.yml`
5. No commitizen: `grep -r "commitizen\|cz bump" /opt/ds01-infra/.github/workflows/` should return nothing
</verification>

<success_criteria>
- Semantic-release replaces commitizen for automated versioning
- Push to main automatically triggers version bump + GitHub release
- CHANGELOG.md auto-generated from conventional commits
- VERSION file updated on each release
- Ruff linting runs on all PRs to main
- Manual dry-run option available via workflow_dispatch
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-observability/01-04-SUMMARY.md`
</output>
