---
phase: 02-awareness-layer
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - config/deploy/systemd/ds01-workload-detector.timer
  - config/deploy/systemd/ds01-workload-detector.service
  - scripts/system/deploy.sh
autonomous: true

must_haves:
  truths:
    - "Systemd timer triggers workload detection every 30 seconds with 1s accuracy"
    - "Service runs detect-workloads.py as oneshot with 25s timeout"
    - "Timer and service can be installed via deploy script"
    - "Timer starts on boot and runs continuously"
  artifacts:
    - path: "config/deploy/systemd/ds01-workload-detector.timer"
      provides: "Systemd timer unit for periodic scanning"
      contains: "OnUnitActiveSec=30s"
    - path: "config/deploy/systemd/ds01-workload-detector.service"
      provides: "Systemd service unit for oneshot scan"
      contains: "Type=oneshot"
    - path: "scripts/system/deploy.sh"
      provides: "Updated deployment script"
      contains: "workload-detector"
  key_links:
    - from: "config/deploy/systemd/ds01-workload-detector.service"
      to: "scripts/monitoring/detect-workloads.py"
      via: "ExecStart path"
      pattern: "ExecStart=.*detect-workloads\\.py"
    - from: "config/deploy/systemd/ds01-workload-detector.timer"
      to: "config/deploy/systemd/ds01-workload-detector.service"
      via: "Requires directive"
      pattern: "Requires=ds01-workload-detector\\.service"
---

<objective>
Create the systemd timer and service units for periodic workload scanning, and update the deployment script to install them.

Purpose: The detection scanner must run every 30 seconds automatically. Systemd timers provide self-healing scheduling (restarts on failure, logs via journald, precise timing with AccuracySec). The deploy script must be updated so these units get installed to /etc/systemd/system/ during deployment.

Output: Two systemd unit files in `config/deploy/systemd/` and an updated `deploy.sh`.
</objective>

<execution_context>
@/home/datasciencelab/.claude/get-shit-done/workflows/execute-plan.md
@/home/datasciencelab/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-awareness-layer/02-CONTEXT.md
@.planning/phases/02-awareness-layer/02-RESEARCH.md
@scripts/system/deploy.sh
@config/deploy/systemd/
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create systemd timer and service units</name>
  <files>config/deploy/systemd/ds01-workload-detector.timer, config/deploy/systemd/ds01-workload-detector.service</files>
  <action>
**Create timer unit** at `config/deploy/systemd/ds01-workload-detector.timer`:

```ini
[Unit]
Description=DS01 Workload Detection Timer
Documentation=https://github.com/your-org/ds01-infra
Requires=ds01-workload-detector.service

[Timer]
OnBootSec=30s
OnUnitActiveSec=30s
AccuracySec=1s
Persistent=false

[Install]
WantedBy=timers.target
```

Key settings:
- `OnBootSec=30s` — first scan 30s after boot (give Docker time to start)
- `OnUnitActiveSec=30s` — subsequent scans every 30s after last completion
- `AccuracySec=1s` — CRITICAL: override default 1min accuracy for precise 30s intervals
- `Persistent=false` — don't catch up missed runs on boot (fresh scan is better)

**Create service unit** at `config/deploy/systemd/ds01-workload-detector.service`:

```ini
[Unit]
Description=DS01 Workload Detection Scanner
Documentation=https://github.com/your-org/ds01-infra
After=docker.service
Wants=docker.service

[Service]
Type=oneshot
ExecStart=/opt/ds01-infra/scripts/monitoring/detect-workloads.py
TimeoutSec=25s
Nice=10
IOSchedulingClass=idle

# Environment
Environment=PYTHONPATH=/opt/ds01-infra/scripts/lib

# Logging
StandardOutput=journal
StandardError=journal
SyslogIdentifier=ds01-workload-detector
```

Key settings:
- `Type=oneshot` — runs once and exits (timer handles repetition)
- `TimeoutSec=25s` — must be shorter than 30s timer interval to prevent overlap
- `After=docker.service` — ensure Docker is available
- `Nice=10` and `IOSchedulingClass=idle` — lower priority to not impact user workloads
- `PYTHONPATH` set so detect-workloads.py can import ds01_events from scripts/lib
  </action>
  <verify>
Verify both files exist and have correct syntax:
```bash
ls -la config/deploy/systemd/ds01-workload-detector.*
```

Verify timer has `AccuracySec=1s` (critical for 30s precision):
```bash
grep AccuracySec config/deploy/systemd/ds01-workload-detector.timer
```

Verify service references correct script path:
```bash
grep ExecStart config/deploy/systemd/ds01-workload-detector.service
```
  </verify>
  <done>
Timer unit triggers every 30s with 1s accuracy. Service unit runs detect-workloads.py as oneshot with 25s timeout, lower priority (Nice=10), and proper Python path for ds01_events import.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update deploy script and ensure dependencies</name>
  <files>scripts/system/deploy.sh</files>
  <action>
Read the existing `scripts/system/deploy.sh` to understand how it deploys systemd units (look for existing patterns like the DCGM exporter service from Phase 1).

Add a section for the workload detector that:

1. **Copies systemd units** to `/etc/systemd/system/`:
   - `cp config/deploy/systemd/ds01-workload-detector.timer /etc/systemd/system/`
   - `cp config/deploy/systemd/ds01-workload-detector.service /etc/systemd/system/`

2. **Creates state directory** if not exists:
   - `mkdir -p /var/lib/ds01`
   - Ensure proper ownership (root:docker or root:root — match existing pattern)

3. **Ensures Python docker package** is available:
   - Add a check: `python3 -c "import docker" 2>/dev/null || pip3 install docker`
   - Add a comment explaining this is required for the workload detector

4. **Reloads systemd** and enables+starts the timer:
   - `systemctl daemon-reload`
   - `systemctl enable ds01-workload-detector.timer`
   - `systemctl start ds01-workload-detector.timer`

5. **Prints status** confirmation:
   - Show timer status after enabling

Follow the existing deployment patterns in deploy.sh exactly. Don't restructure the file — just add the new section in the appropriate place alongside existing systemd unit deployment.

Also ensure `scripts/monitoring/detect-workloads.py` has execute permission set in the deploy script if not already handled.
  </action>
  <verify>
Run `bash -n scripts/system/deploy.sh` to verify no syntax errors.

Verify the deploy script references both new systemd files:
```bash
grep -c "workload-detector" scripts/system/deploy.sh
```
Should return 4+ (timer + service + enable + start).

Verify the docker Python package check is present:
```bash
grep "import docker" scripts/system/deploy.sh
```
  </verify>
  <done>
Deploy script updated with workload detector systemd unit installation, state directory creation, Python docker package check, and timer enable/start commands. Follows existing deployment patterns.
  </done>
</task>

</tasks>

<verification>
1. Both systemd unit files exist in `config/deploy/systemd/`
2. Timer configured for 30s intervals with AccuracySec=1s
3. Service configured as oneshot with 25s timeout
4. Deploy script has no bash syntax errors
5. Deploy script includes workload detector deployment section
</verification>

<success_criteria>
- Timer and service unit files ready for deployment
- Deploy script updated to install, enable, and start the timer
- Python docker package dependency handled in deploy script
- State directory /var/lib/ds01/ creation included
</success_criteria>

<output>
After completion, create `.planning/phases/02-awareness-layer/02-02-SUMMARY.md`
</output>
