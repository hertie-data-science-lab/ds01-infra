---
phase: 09-command-bug-fixes
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/user/wizards/user-setup
autonomous: true

must_haves:
  truths:
    - "user-setup lists existing ds01-{UID}/ images by name when images exist"
    - "user-setup Next Steps section offers to skip image creation when images exist"
    - "user-setup onboarding continues regardless of image detection (SSH, workspace, etc.)"
    - "user-setup only detects ds01-{UID}/ images (not manually built images)"
  artifacts:
    - path: "scripts/user/wizards/user-setup"
      provides: "Image name listing and skip-creation option for returning users"
      contains: "USER_IMAGE_NAMES"
  key_links:
    - from: "scripts/user/wizards/user-setup"
      to: "docker images"
      via: "docker images --format with grep filter"
      pattern: "ds01-.*USER_ID"
---

<objective>
Enhance user-setup image awareness (FIX-04) — list existing images by name and offer skip option.

Purpose: user-setup currently shows only image count. Returning users with existing images should see their image names and be offered the option to skip image creation (going directly to container-deploy instead of project-init). The rest of onboarding (SSH, workspace, project init) still runs regardless.

Output: user-setup with image name listing and conditional Next Steps section.
</objective>

<execution_context>
@/home/datasciencelab/.claude/get-shit-done/workflows/execute-plan.md
@/home/datasciencelab/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-command-bug-fixes/09-RESEARCH.md
@scripts/user/wizards/user-setup
</context>

<tasks>

<task type="auto">
  <name>Task 1: List existing images by name and update Next Steps</name>
  <files>scripts/user/wizards/user-setup</files>
  <action>
  Two changes to `scripts/user/wizards/user-setup`:

  **Change A: Collect and display image names (lines 223-234)**

  Replace the current image detection block:
  ```bash
  USER_IMAGES=$(docker images --format "{{.Repository}}" 2>/dev/null | grep -c "^ds01-${USER_ID}/" 2>/dev/null || true)
  USER_IMAGES=${USER_IMAGES:-0}
  # Ensure it's a valid integer
  if ! [[ "$USER_IMAGES" =~ ^[0-9]+$ ]]; then
      USER_IMAGES=0
  fi
  if [ "$USER_IMAGES" -eq 0 ]; then
      echo -e "${GREEN}✓${NC} Docker access configured"
      echo -e "${YELLOW}○${NC} No custom images yet (will create one)"
  else
      echo -e "${GREEN}✓${NC} Docker access configured ($USER_IMAGES custom image(s))"
  fi
  ```

  With:
  ```bash
  USER_IMAGE_NAMES=$(docker images --format "{{.Repository}}" 2>/dev/null | grep "^ds01-${USER_ID}/" | sort -u || true)
  USER_IMAGES=$(echo "$USER_IMAGE_NAMES" | grep -c . 2>/dev/null || echo 0)
  if ! [[ "$USER_IMAGES" =~ ^[0-9]+$ ]]; then
      USER_IMAGES=0
  fi
  if [ "$USER_IMAGES" -eq 0 ]; then
      echo -e "${GREEN}✓${NC} Docker access configured"
      echo -e "${YELLOW}○${NC} No custom images yet (will create one)"
  else
      echo -e "${GREEN}✓${NC} Docker access configured ($USER_IMAGES custom image(s)):"
      while IFS= read -r img; do
          [ -n "$img" ] && echo -e "    ${DIM}• $img${NC}"
      done <<< "$USER_IMAGE_NAMES"
  fi
  ```

  This collects image names (not just count), then displays them indented with bullet points. Uses `sort -u` to deduplicate (same repo can appear for multiple tags). The `|| true` on grep prevents `set -e` issues with zero matches.

  **Change B: Conditional Next Steps section (lines 462-477)**

  Replace the current unconditional Next Steps block:
  ```bash
  echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
  echo -e "${BOLD}Next Steps${NC}"
  echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
  echo -e ""
  echo -e "  Create your first project:"
  echo -e "    ${GREEN}project-init --guided${NC}"
  echo -e ""
  echo -e "  Or for quick setup (experienced users):"
  echo -e "    ${GREEN}project-init my-project${NC}"
  echo -e ""
  ```

  With a conditional block that acknowledges returning users:
  ```bash
  echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
  echo -e "${BOLD}Next Steps${NC}"
  echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
  echo -e ""
  if [ "$USER_IMAGES" -gt 0 ]; then
      echo -e "  You already have $USER_IMAGES image(s). You can:"
      echo -e "    ${GREEN}container-deploy <project-name>${NC}  — deploy an existing image"
      echo -e "    ${GREEN}project-init my-new-project${NC}      — create a new project"
      echo -e ""
  else
      echo -e "  Create your first project:"
      echo -e "    ${GREEN}project-init --guided${NC}"
      echo -e ""
      echo -e "  Or for quick setup (experienced users):"
      echo -e "    ${GREEN}project-init my-project${NC}"
      echo -e ""
  fi
  ```

  Note: The `USER_IMAGES` variable is set earlier in the script (around line 223) and remains in scope for the Next Steps section. No additional Docker queries needed.

  **Important:** Do NOT change the onboarding flow — SSH setup, workspace creation, VS Code setup, and all other sections between image detection and Next Steps still run unconditionally.
  </action>
  <verify>
  Run `bash -n scripts/user/wizards/user-setup` — must pass clean.
  Grep for `USER_IMAGE_NAMES` — should appear in the image detection section.
  Grep for `container-deploy` — should appear in the Next Steps conditional block.
  Grep for `You already have` — should appear in the returning-user path.
  </verify>
  <done>
  user-setup lists existing ds01-{UID}/ images by name (not just count). Next Steps section acknowledges returning users and suggests container-deploy alongside project-init. All other onboarding steps (SSH, workspace, VS Code, etc.) run unchanged. Script passes bash -n.
  </done>
</task>

</tasks>

<verification>
1. `bash -n scripts/user/wizards/user-setup` exits 0
2. Image names are listed with bullet points when images exist
3. Next Steps shows container-deploy option when images exist
4. Next Steps shows project-init --guided when no images exist
5. Rest of onboarding flow unchanged
</verification>

<success_criteria>
- Existing images listed by name (ds01-{UID}/ pattern only)
- Returning users see container-deploy as option in Next Steps
- New users see project-init --guided as before
- All onboarding sections still run regardless
- Script passes bash -n syntax check
</success_criteria>

<output>
After completion, create `.planning/phases/09-command-bug-fixes/09-03-SUMMARY.md`
</output>
