---
phase: 09-command-bug-fixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/user/atomic/container-stats
  - scripts/user/atomic/image-create
autonomous: true

must_haves:
  truths:
    - "container-stats --filter name=foo does not crash with 'unknown option' error"
    - "container-stats my-container shows stats for that specific container"
    - "container-stats (no args) runs one-shot and exits"
    - "container-stats --watch streams stats continuously"
    - "image-create Jupyter section only runs when skip_base is false (operator precedence correct)"
    - "image-create heredoc variable $project_name is properly quoted in Dockerfile output"
  artifacts:
    - path: "scripts/user/atomic/container-stats"
      provides: "Fixed flag handling — unknown flags silently ignored instead of crashing"
      contains: "shift"
    - path: "scripts/user/atomic/image-create"
      provides: "Fixed operator precedence and heredoc variable quoting"
      contains: "{ \\["
  key_links:
    - from: "scripts/user/atomic/container-stats"
      to: "docker stats"
      via: "show_container_stats function"
      pattern: "docker stats"
---

<objective>
Fix container-stats unknown flag crash (FIX-01) and image-create code quality bugs (FIX-02).

Purpose: Two independent surgical bug fixes in user-facing CLI tools. container-stats currently crashes on any unrecognised flag (e.g., --filter). image-create has an operator precedence bug and unquoted heredoc variable.

Output: Both scripts fixed and passing bash -n syntax check.
</objective>

<execution_context>
@/home/datasciencelab/.claude/get-shit-done/workflows/execute-plan.md
@/home/datasciencelab/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-command-bug-fixes/09-RESEARCH.md
@scripts/user/atomic/container-stats
@scripts/user/atomic/image-create
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix container-stats unknown flag handling</name>
  <files>scripts/user/atomic/container-stats</files>
  <action>
  In `scripts/user/atomic/container-stats`, replace the `-*)` catch-all case (lines 330-334) that crashes on unknown flags:

  Current (crashes):
  ```bash
  -*)
      echo -e "${RED}✗ Unknown option: $1${NC}\n"
      usage
      exit 1
      ;;
  ```

  Replace with silent pass-through per user decision ("let docker handle errors for flags the script doesn't recognise"):
  ```bash
  -*)
      # Unknown flag — silently ignore; docker will error if invalid
      shift
      ;;
  ```

  Verify existing functionality is preserved:
  - Positional arg handling at line 336 (CONTAINER_NAME) still works
  - `--watch` flag still sets WATCH_MODE=true
  - `--guided` flag still works
  - `-h|--help|--info` still shows usage
  - Default mode is one-shot (already correct — lines 354-356)
  </action>
  <verify>
  Run `bash -n scripts/user/atomic/container-stats` — must pass clean (exit 0).
  Visually confirm the `-*)` case now does `shift` instead of `exit 1`.
  </verify>
  <done>
  The `-*)` catch-all silently ignores unknown flags instead of crashing. All existing flag handling (--watch, --help, --guided, positional CONTAINER_NAME) unchanged. Script passes bash -n.
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix image-create operator precedence and heredoc quoting</name>
  <files>scripts/user/atomic/image-create</files>
  <action>
  In `scripts/user/atomic/image-create`, fix two confirmed code quality issues:

  **Fix A: Operator precedence at line 1364**

  Current (wrong precedence — `&&` binds tighter than `||`):
  ```bash
  if [ "$skip_base" != true ] && [ "$jupyter_choice" = "default" ] || [ "$jupyter_choice" = "custom" ]; then
  ```

  This evaluates as `(A && B) || C` but intent is `A && (B || C)`. When `skip_base=true` and `jupyter_choice=custom`, the Jupyter block incorrectly runs.

  Fix with explicit grouping:
  ```bash
  if [ "$skip_base" != true ] && { [ "$jupyter_choice" = "default" ] || [ "$jupyter_choice" = "custom" ]; }; then
  ```

  **Fix B: Unquoted variable in heredoc at lines 1375-1377**

  Current (breaks if project_name contains spaces):
  ```bash
  RUN python -m ipykernel install --user \\
      --name=$project_name \\
      --display-name="$project_name ($framework)"
  ```

  Fix by quoting the variable reference inside the heredoc:
  ```bash
  RUN python -m ipykernel install --user \\
      --name="${project_name}" \\
      --display-name="${project_name} (${framework})"
  ```

  Note: This is inside a `<< DOCKERFILEEOF` (unquoted delimiter) so variables expand. Do NOT change the delimiter quoting style — just add quotes around variable references.
  </action>
  <verify>
  Run `bash -n scripts/user/atomic/image-create` — must pass clean (exit 0).
  Visually confirm: line 1364 now has `{ [ ... ] || [ ... ]; };` grouping.
  Visually confirm: lines 1375-1377 now have `"${project_name}"` and `"${project_name} (${framework})"`.
  </verify>
  <done>
  Operator precedence bug fixed — Jupyter block correctly gated by `skip_base != true`. Heredoc variable properly quoted — `--name="${project_name}"` prevents Dockerfile syntax error if project name had spaces. Script passes bash -n.
  </done>
</task>

</tasks>

<verification>
1. `bash -n scripts/user/atomic/container-stats` exits 0
2. `bash -n scripts/user/atomic/image-create` exits 0
3. container-stats `-*)` case does shift (not exit 1)
4. image-create line 1364 has `{ [ ... ] || [ ... ]; };` grouping
5. image-create lines 1375-1377 have quoted `${project_name}` and `${framework}`
</verification>

<success_criteria>
- container-stats accepts unknown flags without crashing
- image-create operator precedence is correct (Jupyter block gated by skip_base)
- image-create heredoc variables are properly quoted
- Both scripts pass bash -n syntax check
</success_criteria>

<output>
After completion, create `.planning/phases/09-command-bug-fixes/09-01-SUMMARY.md`
</output>
