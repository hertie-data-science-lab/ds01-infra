---
phase: 09-command-bug-fixes
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/user/atomic/image-update
autonomous: true

must_haves:
  truths:
    - "User is prompted to rebuild exactly ONCE after modifying Dockerfile (not twice)"
    - "Diff of Dockerfile changes is shown before the rebuild prompt"
    - "On build failure, user is offered to revert Dockerfile to pre-session state"
    - "Session-start backup is taken once at the top of interactive_mode"
    - "Menu option 7 label says 'Save changes and rebuild image'"
  artifacts:
    - path: "scripts/user/atomic/image-update"
      provides: "Single rebuild prompt, diff display, revert on failure"
      contains: "diff.*\\.bak"
  key_links:
    - from: "scripts/user/atomic/image-update interactive_mode()"
      to: "main script Phase 2 rebuild prompt"
      via: "return 0 only from option 7 (not from options 2/3/4/5)"
      pattern: "return 0"
---

<objective>
Fix image-update double rebuild prompt (FIX-03) and add diff display + revert-on-failure.

Purpose: Users currently get asked "Rebuild now?" twice â€” once inside interactive_mode menu options (2/3/4/5) and again in the main script's Phase 2. Fix: remove in-menu rebuild prompts so the question is asked exactly once in Phase 2. Add Dockerfile diff display before rebuild and revert option on build failure.

Output: image-update with clean single-prompt rebuild flow, diff display, and backup/revert mechanism.
</objective>

<execution_context>
@/home/datasciencelab/.claude/get-shit-done/workflows/execute-plan.md
@/home/datasciencelab/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-command-bug-fixes/09-RESEARCH.md
@scripts/user/atomic/image-update
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove in-menu rebuild prompts and add session backup</name>
  <files>scripts/user/atomic/image-update</files>
  <action>
  Fix the double rebuild prompt in `scripts/user/atomic/image-update`. The structural issue: `interactive_mode()` options 2, 3, 4, 5 each ask "Rebuild now? [Y/n]" and `return 0` on yes, then the main script asks the same question again at line 1829 (Phase 2).

  **Step 1: Add session-start backup at top of interactive_mode()**

  At the beginning of `interactive_mode()`, before the `while true` loop, add:
  ```bash
  # Take session backup for diff display and revert-on-failure
  cp "$dockerfile" "${dockerfile}.bak"
  ```

  This replaces the per-function backups. The `.bak` file now represents the true pre-session state, not an intermediate state after multiple modifications.

  **Step 2: Remove "Rebuild now?" prompts from options 2, 3, 4, 5**

  For each of options 2, 3, 4, 5, remove the "Rebuild now?" read prompt and the early `return 0`. After the modification succeeds, the code should just inform the user and `break` or continue the menu loop. Specifically:

  **Option 2** (add Python packages, around lines 1299-1310): After `PACKAGES_ADDED_COUNT` check, remove the "Rebuild now?" prompt block. Keep the success message. Replace `return 0` path with just continuing the menu loop (remove the `break` as well since after adding packages user should see the menu again to make more changes or choose option 7).

  Actually â€” looking at the current code more carefully: after packages are added, the code shows a hint about rebuilding, asks "Rebuild now?", and if yes `return 0`, otherwise `break` (exits the inner duplicate-check while loop, returns to menu). The fix: remove the hint message, the read prompt, and the `return 0`. Just break out of the inner loop to return to the menu:

  Replace the block from `echo -e "${YELLOW}ðŸ’¡ To apply changes..."` through the `return 0` and `break` with just a `break` to exit the inner while loop.

  **Option 3** (import requirements.txt, around lines 1336-1346): Same pattern. After packages are added and confirmed, remove the "Rebuild now?" prompt and `return 0`. Let it fall through to continue the menu loop.

  **Option 4** (add system packages, around lines 1367-1377): Same pattern. Remove the "Rebuild now?" prompt and `return 0`.

  **Option 5** (remove packages, around lines 1414-1424): Same pattern. Remove the "Rebuild now?" prompt and `return 0`.

  **Step 3: Update menu option 7 label**

  Change line 1210 from:
  ```bash
  echo -e "  ${BOLD}7)${NC} Continue to rebuild ${BOLD}${YELLOW}(necessary to apply changes!)${NC}"
  ```
  To:
  ```bash
  echo -e "  ${BOLD}7)${NC} Save changes and rebuild image"
  ```

  Keep `return 0` for option 7 (line 1457) â€” this is correct.

  **Important:** Do NOT remove the `return 0` from option 7 (line 1457). Only remove the early `return 0` from options 2, 3, 4, 5.
  </action>
  <verify>
  Run `bash -n scripts/user/atomic/image-update` â€” must pass clean.
  Grep for "Rebuild now?" inside `interactive_mode` function â€” should find ZERO occurrences between the function definition and its closing `}`. The only "Rebuild" prompt should be in the main script's Phase 2 section (line ~1829).
  Grep for "Save changes and rebuild" â€” should appear in menu display.
  </verify>
  <done>
  interactive_mode() no longer asks "Rebuild now?" in options 2/3/4/5. Session backup taken once at function start. Option 7 label updated to "Save changes and rebuild image". The rebuild question is now asked exactly once in the main script's Phase 2 section.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add diff display before rebuild and revert on build failure</name>
  <files>scripts/user/atomic/image-update</files>
  <action>
  Two additions to the main script flow in `scripts/user/atomic/image-update`:

  **Addition A: Show diff before rebuild prompt (Phase 2 section)**

  Insert before the Phase 2 rebuild prompt (before the `echo -e "${CYAN}â”â”â”` line at ~1817), after the Phase 1 "Dockerfile Updated" confirmation:

  ```bash
  # Show changes made to Dockerfile
  if [ -f "${DOCKERFILE}.bak" ] && ! diff -q "${DOCKERFILE}.bak" "$DOCKERFILE" > /dev/null 2>&1; then
      echo -e "${CYAN}Changes made to Dockerfile:${NC}"
      echo ""
      diff "${DOCKERFILE}.bak" "$DOCKERFILE" || true
      echo ""
  fi
  ```

  This shows the unified diff between the pre-session backup and the current Dockerfile. The `|| true` prevents `diff` non-zero exit code (which it returns when files differ) from causing issues.

  **Addition B: Offer revert on build failure**

  Replace the build failure block (lines 2027-2038) from:
  ```bash
  else
      echo ""
      echo -e "${RED}âœ— Build failed${NC}"
      echo ""
      echo "Troubleshooting:"
      echo -e "  1. Check Dockerfile syntax: ${BLUE}cat $DOCKERFILE${NC}"
      echo -e "  2. View backup: ${BLUE}cat ${DOCKERFILE}.bak${NC}"
      echo -e "  3. Restore backup: ${GREEN}mv ${DOCKERFILE}.bak $DOCKERFILE${NC}"
      echo -e "  4. Try again: ${GREEN}image-update $IMAGE_NAME${NC}"
      echo ""
      exit 1
  fi
  ```

  With:
  ```bash
  else
      echo ""
      echo -e "${RED}âœ— Build failed${NC}"
      echo ""
      if [ -f "${DOCKERFILE}.bak" ]; then
          read -r -t 0.1 -n 10000 discard </dev/tty 2>/dev/null || true
          read -p "Revert Dockerfile to pre-update state? [Y/n]: " REVERT_CONFIRM </dev/tty
          REVERT_CONFIRM=${REVERT_CONFIRM:-Y}
          if [[ "$REVERT_CONFIRM" =~ ^[Yy]$ ]]; then
              mv "${DOCKERFILE}.bak" "$DOCKERFILE"
              echo -e "${GREEN}âœ“${NC} Dockerfile restored to previous state"
          else
              echo ""
              echo "Backup preserved at: ${DOCKERFILE}.bak"
              echo -e "  Restore manually: ${GREEN}mv ${DOCKERFILE}.bak $DOCKERFILE${NC}"
          fi
      fi
      echo ""
      echo "Troubleshooting:"
      echo -e "  1. Check Dockerfile syntax: ${BLUE}cat $DOCKERFILE${NC}"
      echo -e "  2. Try again: ${GREEN}image-update $IMAGE_NAME${NC}"
      echo ""
      exit 1
  fi
  ```

  This offers an interactive revert prompt instead of just showing manual instructions. Defaults to Y (revert). If user declines, preserves the backup and shows the manual restore command.
  </action>
  <verify>
  Run `bash -n scripts/user/atomic/image-update` â€” must pass clean.
  Grep for `diff.*\.bak` â€” should appear in the pre-rebuild section.
  Grep for `Revert Dockerfile` â€” should appear in the build failure section.
  </verify>
  <done>
  Dockerfile diff displayed before rebuild prompt (shows what changed in the session). Build failure offers interactive revert to pre-session state with backup preserved if declined. Script passes bash -n.
  </done>
</task>

</tasks>

<verification>
1. `bash -n scripts/user/atomic/image-update` exits 0
2. No "Rebuild now?" prompt inside interactive_mode() function body
3. Diff display appears between Phase 1 and Phase 2 sections
4. Build failure section offers revert prompt with ${DOCKERFILE}.bak
5. Menu option 7 says "Save changes and rebuild image"
6. Option 7 still has `return 0`
</verification>

<success_criteria>
- User is asked to rebuild exactly once (in Phase 2, not in interactive_mode)
- Dockerfile diff shown before rebuild prompt
- Build failure offers to revert Dockerfile
- Session-start backup taken once, used for diff and revert
- Script passes bash -n syntax check
</success_criteria>

<output>
After completion, create `.planning/phases/09-command-bug-fixes/09-02-SUMMARY.md`
</output>
