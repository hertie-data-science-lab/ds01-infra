---
phase: 05-lifecycle-bug-fixes
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/maintenance/cleanup-stale-containers.sh
autonomous: true

must_haves:
  truths:
    - "Containers in 'created' state (never started) are detected and removed after 30 minutes"
    - "Cleanup handles containers without DS01/AIME labels using ownership fallback chain"
    - "Ownership fallback: ds01.user -> aime.mlc.USER -> devcontainer.local_folder -> container name pattern -> unknown"
    - "Unattributable containers get strictest lifecycle rules (unknown type timeout)"
    - "Infrastructure containers (ds01.monitoring=true) are fully exempt from cleanup"
    - "Idle-stopped containers are removed immediately (no post-stop hold)"
  artifacts:
    - path: "scripts/maintenance/cleanup-stale-containers.sh"
      provides: "Universal container cleanup with created-state detection and unlabelled container handling"
      contains: "status=created"
  key_links:
    - from: "cleanup-stale-containers.sh"
      to: "docker ps --filter status=created"
      via: "Docker API query for created-state containers"
      pattern: "status=created"
    - from: "cleanup-stale-containers.sh"
      to: "gpu_allocator_v2.py"
      via: "GPU release for created-state containers that had GPU allocated"
      pattern: "gpu_allocator"
---

<objective>
Extend container cleanup to detect created-but-never-started containers, handle unlabelled/unattributable containers, and implement immediate removal for idle-stopped containers.

Purpose: LIFE-03 requires created-state containers cleaned up within 30 minutes. LIFE-04 requires cleanup scripts to handle containers without DS01/AIME labels. Current cleanup-stale-containers.sh only handles containers with `aime.mlc.USER` label and only in "exited" state.

Output: Updated cleanup-stale-containers.sh that handles all container states and all container types.
</objective>

<execution_context>
@/home/datasciencelab/.claude/get-shit-done/workflows/execute-plan.md
@/home/datasciencelab/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-lifecycle-bug-fixes/05-CONTEXT.md
@.planning/phases/05-lifecycle-bug-fixes/05-RESEARCH.md
@scripts/maintenance/cleanup-stale-containers.sh
@scripts/monitoring/check-idle-containers.sh
@scripts/docker/gpu_allocator_v2.py
@config/runtime/resource-limits.yaml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add created-state container cleanup</name>
  <files>scripts/maintenance/cleanup-stale-containers.sh</files>
  <action>
  Add a new function `cleanup_created_containers()` that:
  1. Finds all containers in "created" state: `docker ps -a --filter "status=created" --format "{{.Names}}\t{{.CreatedAt}}"`
  2. For each, calculates age from CreatedAt timestamp
  3. If age > 30 minutes (read from policies.created_container_timeout via python3 one-liner, default 30m), remove the container
  4. Before removal, check if the container had GPU allocated (inspect DeviceRequests for nvidia), and if so release the allocation via `python3 "$INFRA_ROOT/scripts/docker/gpu_allocator_v2.py" release "$container"` (the release command handles it)
  5. Skip infrastructure containers (check `ds01.monitoring=true` label)
  6. Log event via `log_event "container.cleanup" ...` with reason "created_never_started"
  7. Call this function at the start of the main cleanup logic (before the stopped-container loop)

  Implementation notes:
  - Use the same ownership detection as get_container_owner() from check-idle-containers.sh — copy the function here OR source it from a shared location. Since check-idle-containers.sh already has this function AND it's duplicated in enforce-max-runtime.sh, the best approach is to copy it into this script too (shared lib extraction is a separate refactor task, not Phase 5 scope).
  - For created containers, FinishedAt will be "0001-01-01T00:00:00Z" (never started), so use CreatedAt for age calculation
  - Created containers may or may not have labels — attempt ownership attribution via the fallback chain
  </action>
  <verify>bash -n scripts/maintenance/cleanup-stale-containers.sh && grep -c "status=created" scripts/maintenance/cleanup-stale-containers.sh</verify>
  <done>cleanup_created_containers function detects containers in "created" state older than 30 minutes, releases GPU if allocated, skips infrastructure containers, logs events</done>
</task>

<task type="auto">
  <name>Task 2: Handle unlabelled containers and universal cleanup</name>
  <files>scripts/maintenance/cleanup-stale-containers.sh</files>
  <action>
  Rewrite the main stopped-container loop to handle ALL stopped containers, not just those with `aime.mlc.USER` label:

  **1. Change container query to include all stopped containers:**
  - Replace `docker ps -a --filter "status=exited" --filter "label=aime.mlc.USER"` with `docker ps -a --filter "status=exited" --format "{{.Names}}"`
  - This captures all exited containers regardless of labelling

  **2. Add ownership detection fallback chain:**
  Add a `get_container_owner()` function (same as check-idle-containers.sh) with the full fallback:
  - ds01.user label
  - aime.mlc.USER label
  - devcontainer.local_folder path (extract username from /home/<user>/ path)
  - Container name pattern (name._.uid)
  - Fallback: "unknown"

  **3. Add container type detection:**
  Add `get_container_type()` function (same as check-idle-containers.sh).

  **4. Get hold timeout based on container type and owner:**
  - For containers with a known owner: use their group's `container_hold_after_stop` from get_resource_limits.py
  - For containers with unknown owner: use `container_types.unknown` config (strictest — currently the defaults `container_hold_after_stop: 0.5h`)
  - For idle-stopped containers (check for a marker — if check-idle-containers.sh removed immediately, these won't reach this script, which is correct per the CONTEXT decision "immediate removal after idle stop")

  **5. Skip infrastructure containers:**
  - Check `ds01.monitoring=true` label before processing
  - Also check `ds01.protected=true` label (infrastructure_label from config)
  - Log and skip

  **6. GPU release for containers with GPU allocation:**
  - After removing a container, if it had GPU access (check DeviceRequests), call gpu_allocator_v2.py release
  - This is belt-and-suspenders — cleanup-stale-gpu-allocations.sh handles this too, but catching it here prevents leaks

  **Important:** Keep the logging, error handling, and summary statistics patterns from the existing script. Just expand the scope from AIME-only to universal.
  </action>
  <verify>bash -n scripts/maintenance/cleanup-stale-containers.sh && echo "Syntax OK"</verify>
  <done>cleanup-stale-containers.sh handles all stopped containers regardless of labels, uses ownership fallback chain, detects container type for appropriate timeout, skips infrastructure containers, releases GPU on removal</done>
</task>

</tasks>

<verification>
1. `bash -n scripts/maintenance/cleanup-stale-containers.sh` — syntax check passes
2. `grep -c "status=created" scripts/maintenance/cleanup-stale-containers.sh` — at least 1 occurrence
3. Script does NOT contain `--filter "label=aime.mlc.USER"` as the only container filter (should handle all containers)
4. `grep "ds01.monitoring" scripts/maintenance/cleanup-stale-containers.sh` — infrastructure exemption present
5. `grep "get_container_owner\|ds01.user" scripts/maintenance/cleanup-stale-containers.sh` — ownership detection present
6. `grep "gpu_allocator" scripts/maintenance/cleanup-stale-containers.sh` — GPU release on removal present
7. `grep "created_never_started\|created.*state" scripts/maintenance/cleanup-stale-containers.sh` — created-state handling present
</verification>

<success_criteria>
- Created-state containers detected and removed after 30 minutes
- All stopped containers handled (not just AIME-labelled)
- Ownership fallback chain: ds01.user -> aime.mlc.USER -> devcontainer path -> name pattern -> unknown
- Infrastructure containers exempt
- GPU released on container removal
- Script passes bash -n syntax check
</success_criteria>

<output>
After completion, create `.planning/phases/05-lifecycle-bug-fixes/05-03-SUMMARY.md`
</output>
