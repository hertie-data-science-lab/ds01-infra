---
phase: 05-lifecycle-bug-fixes
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/maintenance/enforce-max-runtime.sh
autonomous: true

must_haves:
  truths:
    - "Max runtime warnings use wall messages, not files in $HOME or /workspace"
    - "Max runtime stop notifications use wall messages, not files in $HOME or /workspace"
    - "SIGTERM grace period is 60 seconds (not 10)"
    - "Dev containers respect their 168h max_runtime from container_types config"
    - "Max runtime enforcement works for all container types (ds01, devcontainer, compose, docker, unknown)"
  artifacts:
    - path: "scripts/maintenance/enforce-max-runtime.sh"
      provides: "Max runtime enforcement with wall notifications and 60s SIGTERM"
      contains: "wall"
  key_links:
    - from: "enforce-max-runtime.sh"
      to: "wall"
      via: "wall command for terminal broadcast"
      pattern: "wall"
---

<objective>
Update max runtime enforcement to use wall messages instead of file-based notifications, increase SIGTERM grace period to 60 seconds, and remove legacy backwards-compatibility function.

Purpose: LIFE-02 requires max runtime enforced for all container types. Current enforce-max-runtime.sh works correctly but uses file-based notifications (writing to $HOME) and has a 10-second SIGTERM timeout that's too short for GPU workloads to checkpoint.

Output: Updated enforce-max-runtime.sh with wall notifications, 60s SIGTERM, and cleaned-up code.
</objective>

<execution_context>
@/home/datasciencelab/.claude/get-shit-done/workflows/execute-plan.md
@/home/datasciencelab/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-lifecycle-bug-fixes/05-CONTEXT.md
@scripts/maintenance/enforce-max-runtime.sh
@config/runtime/resource-limits.yaml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update enforce-max-runtime.sh notifications and SIGTERM</name>
  <files>scripts/maintenance/enforce-max-runtime.sh</files>
  <action>
  **1. Replace file-based warning with wall message:**
  Rewrite `send_warning()` function:
  - Remove all file creation (`$user_home/.ds01-runtime-warning`, writing to `/workspace/.runtime-warning.txt`)
  - Replace with `wall` broadcast message
  - Plain text message (no emoji — terminal encoding issues with wall): include container name, time remaining, and what to do
  - Format:
    ```
    DS01 MAX RUNTIME WARNING

    Container: $container
    Status: Will auto-stop in ~${hours_until_stop} hours
    Reason: Maximum runtime limit approaching

    Save your work now:
      - Checkpoint your training/model state
      - Ensure results are saved to /workspace

    Your /workspace data persists after stop.
    ```
  - Use `echo "$message" | wall` (root cron has permission)

  **2. Replace file-based stop notification with wall message:**
  Rewrite the notification section in `stop_runtime_exceeded()`:
  - Remove all file creation (`$user_home/.ds01-runtime-exceeded`)
  - Replace with wall broadcast message on stop
  - Format:
    ```
    DS01 CONTAINER STOPPED - MAX RUNTIME EXCEEDED

    Container: $container_name
    Stopped: $(date)
    Reason: Maximum runtime limit reached (${runtime_hours}h)

    Your /workspace data is safe.
    To restart: container-run $container_name
    ```

  **3. Change SIGTERM grace period from 10s to 60s:**
  - In `stop_runtime_exceeded()`, change `docker stop -t 10` to `docker stop -t 60`
  - Read sigterm_grace_seconds from config if available (via python3 one-liner reading policies.sigterm_grace_seconds), fall back to 60

  **4. Remove legacy `process_container_runtime()` function:**
  - Delete the entire `process_container_runtime()` function (lines ~419-473) — it's marked as legacy backwards compatibility and is never called by `monitor_containers()` which uses `process_container_runtime_universal()`.

  **Important:** Keep the rest of the logic intact — the container type detection, owner detection, timeout calculation, state tracking, and event logging all work correctly.
  </action>
  <verify>bash -n scripts/maintenance/enforce-max-runtime.sh && echo "Syntax OK"</verify>
  <done>enforce-max-runtime.sh uses wall for warnings and stop notifications, 60s SIGTERM grace, no file creation in $HOME or /workspace, legacy function removed</done>
</task>

</tasks>

<verification>
1. `bash -n scripts/maintenance/enforce-max-runtime.sh` — syntax check passes
2. `grep -c "wall" scripts/maintenance/enforce-max-runtime.sh` — at least 2 occurrences (warning + stop)
3. `grep "docker stop -t 60" scripts/maintenance/enforce-max-runtime.sh` — 60s SIGTERM
4. No occurrences of `.ds01-runtime-warning` or `.ds01-runtime-exceeded` (file-based notifications removed)
5. No occurrences of `warning_file` or `notification_file` variable names
6. `grep "process_container_runtime_universal" scripts/maintenance/enforce-max-runtime.sh` — universal function present
7. No `process_container_runtime()` legacy function (only `process_container_runtime_universal()` should exist)
</verification>

<success_criteria>
- All notifications use wall (no file creation)
- SIGTERM grace is 60 seconds
- Legacy backwards-compat function removed
- Script passes bash -n syntax check
- Container type detection and timeout logic unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/05-lifecycle-bug-fixes/05-02-SUMMARY.md`
</output>
