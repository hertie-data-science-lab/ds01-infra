# Phase 7: Label Standards & Migration - Research

**Researched:** 2026-02-16
**Domain:** Docker container label namespace migration (codebase-internal)
**Confidence:** HIGH

## Summary

Phase 7 standardises all DS01 container labels from a mixed `aime.mlc.*` / `ds01.*` namespace to a unified `ds01.*` namespace. The research mapped all label usage across 76 script files, identified the label generation point (mlc-patched.py), and established the migration scope. This is a straightforward find-and-replace operation with a single ownership fallback function for backward compatibility.

The current mixed namespace exists because DS01 initially patched AIME's mlc.py which uses `aime.mlc.*` labels, while DS01-specific features added `ds01.*` labels. The migration will create a clean, consistent namespace while maintaining zero disruption to running containers through a lightweight fallback mechanism.

**Primary recommendation:** Patch mlc-patched.py label generation (lines 1644-1656), migrate all script references to `ds01.*` in one sweep, consolidate ownership fallback into docker-utils.sh and ds01_core.py.

## Current Label Landscape

### AIME Labels (from mlc-patched.py)

All AIME labels are generated in `scripts/docker/mlc-patched.py` at lines 1644-1656 in the `create_docker_container()` function. The `container_label` variable is hardcoded as `'aime.mlc'`.

| Label | Value Type | Purpose | Set By |
|-------|-----------|---------|--------|
| `aime.mlc` | username | Base label (equals username) | mlc-patched.py |
| `aime.mlc.USER` | username | Container owner (uppercase) | mlc-patched.py |
| `aime.mlc.NAME` | string | Display name for bash prompt | mlc-patched.py |
| `aime.mlc.ARCH` | "CUDA"/"ROCM" | GPU architecture | mlc-patched.py |
| `aime.mlc.MLC_VERSION` | integer | AIME MLC container version | mlc-patched.py |
| `aime.mlc.WORK_MOUNT` | path | Host workspace directory | mlc-patched.py |
| `aime.mlc.DATA_MOUNT` | path | Host data directory | mlc-patched.py |
| `aime.mlc.MODELS_MOUNT` | path | Host models directory | mlc-patched.py |
| `aime.mlc.FRAMEWORK` | string | Framework-version (e.g., "pytorch-2.0") | mlc-patched.py |
| `aime.mlc.GPUS` | string | GPU allocation string | mlc-patched.py |
| `aime.mlc.DS01_MANAGED` | "true" | DS01 management flag | mlc-patched.py (DS01 patch) |
| `aime.mlc.CUSTOM_IMAGE` | string | Custom image name or empty | mlc-patched.py (DS01 patch) |

**Note:** `aime.mlc.username` (lowercase) is referenced in some scripts but NOT generated by mlc-patched.py. This may be a legacy label from older AIME versions or a documentation error.

### DS01 Labels (from docker-wrapper.sh and other scripts)

| Label | Value Type | Purpose | Set By |
|-------|-----------|---------|--------|
| `ds01.user` | username | Container owner (authoritative) | docker-wrapper.sh |
| `ds01.managed` | "true" | DS01-managed container flag | docker-wrapper.sh |
| `ds01.interface` | "atomic"/"orchestration"/"devcontainer"/"compose"/"docker" | Creation interface | docker-wrapper.sh |
| `ds01.container_type` | string | Container type classification | docker-wrapper.sh |
| `ds01.slice` | string | Cgroup slice name | docker-wrapper.sh |
| `ds01.created_at` | ISO timestamp | Creation timestamp | Various scripts |
| `ds01.gpu.uuid` | UUID | Single GPU UUID | GPU allocator |
| `ds01.gpu.uuids` | UUID,UUID | Multiple GPU UUIDs | GPU allocator |
| `ds01.gpu.slots` | "0.1,0.2" | MIG slot identifiers | GPU allocator |
| `ds01.gpu.allocated` | string | Allocated GPU identifier | GPU allocator |
| `ds01.gpu_ephemeral` | "true" | Ephemeral GPU container flag | GPU allocator |
| `ds01.gpu_slot` | string | GPU slot identifier | GPU allocator |
| `ds01.protected` | "true" | Protected from auto-cleanup | Various scripts |

**GPU label naming inconsistency:** The codebase uses both `ds01.gpu.uuid` (singular) and `ds01.gpu.uuids` (plural), plus `ds01.gpu.slots` vs `ds01.gpu.allocated`. This should be standardised during the migration.

### External Labels (Preserved)

These labels are set by external tools and should NOT be migrated:

- `devcontainer.*` - VS Code Dev Containers
- `com.docker.compose.*` - Docker Compose
- `devcontainer.workspaceFolder` - Set by mlc-patched.py for VS Code integration (keep as-is)

## Migration Scope

### Files with aime.mlc.* References

**Total files:** 23 scripts across the codebase

**By directory:**
- `scripts/monitoring/` - 5 files (check-idle-containers.sh, detect-workloads.py, container-dashboard.sh, mlc-stats-wrapper.sh, who-owns-containers.sh)
- `scripts/maintenance/` - 2 files (cleanup-stale-containers.sh, enforce-max-runtime.sh)
- `scripts/docker/` - 9 files (mlc-patched.py, docker-wrapper.sh, ds01-resource-query.py, container-owner-tracker.py, sync-container-owners.py, gpu_allocator_v2.py, gpu-state-reader.py, README.md, enforce-containers.sh)
- `scripts/admin/` - 3 files (dashboard, ds01-dashboard, ds01-users)
- `scripts/lib/` - 1 file (docker-utils.sh)
- `scripts/user/atomic/` - 3 files (container-create, container-list, image-create)

**Documentation files:** README.md files and architecture docs also reference `aime.mlc.*` labels and need updating.

### Label Access Patterns

**1. Ownership detection (ownership fallback chain):**
```bash
# Current pattern (check-idle-containers.sh, cleanup-stale-containers.sh, etc.)
owner=$(docker inspect "$container" --format '{{index .Config.Labels "ds01.user"}}' 2>/dev/null)
if [ -z "$owner" ]; then
    owner=$(docker inspect "$container" --format '{{index .Config.Labels "aime.mlc.USER"}}' 2>/dev/null)
fi
```

**Consolidation target:** Single function in docker-utils.sh already exists (`ds01_get_container_owner()`), needs to be used consistently everywhere.

**2. Container filtering (user's containers):**
```bash
# Current pattern (ds01-users, mlc-patched.py)
docker ps --filter "label=aime.mlc.USER=$user"
```

**Migration:** Replace with `--filter "label=ds01.user=$user"`

**3. Multi-label queries (container-list, dashboard):**
```bash
# Current pattern (container-list)
docker ps --format '{{.Names}}|{{.Label "ds01.user"}}|{{.Label "aime.mlc.USER"}}|{{.Label "aime.mlc.username"}}|...'
```

**Migration:** Remove `aime.mlc.USER` and `aime.mlc.username` columns after fallback function is in place.

**4. Framework/metadata labels (container-list):**
```bash
# Current pattern
aime_framework=$(docker inspect --format "{{index .Config.Labels \"aime.mlc.FRAMEWORK\"}}" "$container")
```

**Migration:** These metadata labels (FRAMEWORK, ARCH, etc.) should migrate to `ds01.framework`, `ds01.arch`, etc.

## Architecture Patterns

### Label Generation (Root Fix)

**Single source of truth:** `scripts/docker/mlc-patched.py` lines 1644-1656

```python
# Current (lines 1644-1656)
base_docker_cmd = [
    'docker', 'create',
    '--label', f'{container_label}={user_name}',              # container_label = 'aime.mlc'
    '--label', f'{container_label}.NAME={validated_container_name}',
    '--label', f'{container_label}.USER={user_name}',
    '--label', f'{container_label}.ARCH={architecture}',
    '--label', f'{container_label}.MLC_VERSION={mlc_container_version}',
    '--label', f'{container_label}.WORK_MOUNT={workspace_dir}',
    '--label', f'{container_label}.DATA_MOUNT={data_dir}',
    '--label', f'{container_label}.MODELS_MOUNT={models_dir}',
    '--label', f'{container_label}.FRAMEWORK={selected_framework}-{selected_version}',
    '--label', f'{container_label}.GPUS={num_gpus}',
    '--label', f'{container_label}.DS01_MANAGED=true',
    '--label', f'{container_label}.CUSTOM_IMAGE={"" if selected_docker_image.startswith("aimehub/") else selected_docker_image}',
]
```

**Migration approach:**
1. Change `container_label = 'aime.mlc'` to `container_label = 'ds01'`
2. Update label names to lowercase with underscores:
   - `USER` → `user`
   - `NAME` → `name`
   - `ARCH` → `arch`
   - `MLC_VERSION` → `mlc_version`
   - `WORK_MOUNT` → `work_mount`
   - `DATA_MOUNT` → `data_mount`
   - `MODELS_MOUNT` → `models_mount`
   - `FRAMEWORK` → `framework`
   - `GPUS` → `gpus`
   - `DS01_MANAGED` → `managed`
   - `CUSTOM_IMAGE` → `custom_image`

**Result:** All new containers created via `container-create` will have `ds01.*` labels.

### Ownership Fallback (Backward Compatibility)

**Existing pattern:** `scripts/lib/docker-utils.sh` line 124-135 already implements the fallback:

```bash
ds01_get_container_owner() {
    # Get container owner from labels
    # Args: container_tag
    # Returns: username or empty
    local container="$1"
    local owner
    owner=$(ds01_get_container_label "$container" "ds01.user")
    if [[ -z "$owner" ]]; then
        owner=$(ds01_get_container_label "$container" "aime.mlc.USER")  # Fallback
    fi
    echo "$owner"
}
```

**Python equivalent:** Create in `scripts/lib/ds01_core.py`:

```python
def get_container_owner(container_name: str) -> str:
    """
    Get container owner with fallback for legacy labels.

    Checks ds01.user first, falls back to aime.mlc.USER for existing containers.

    TODO: Remove aime.mlc.USER fallback after all containers migrated
          (check: docker ps -a --filter label=aime.mlc.USER)
    """
    import subprocess

    # Try ds01.user first
    result = subprocess.run(
        ['docker', 'inspect', '--format', '{{index .Config.Labels "ds01.user"}}', container_name],
        capture_output=True, text=True
    )
    owner = result.stdout.strip()
    if owner and owner != "<no value>":
        return owner

    # Fallback to aime.mlc.USER (legacy containers)
    result = subprocess.run(
        ['docker', 'inspect', '--format', '{{index .Config.Labels "aime.mlc.USER"}}', container_name],
        capture_output=True, text=True
    )
    owner = result.stdout.strip()
    return owner if owner != "<no value>" else ""
```

**Usage pattern:** All scripts should migrate from direct label access to calling these functions.

### Container Type Consolidation

**Current situation:**
- `aime.mlc.TYPE` - Not found in mlc-patched.py, may be legacy or documentation error
- `ds01.container_type` - Set by docker-wrapper.sh
- `ds01.interface` - Set by docker-wrapper.sh

**Decision (from CONTEXT.md):** Claude's discretion to assess and consolidate.

**Recommendation:**
1. Keep `ds01.interface` as the authoritative field (already used consistently)
2. Deprecate `ds01.container_type` (rename to `ds01.interface` if different semantic)
3. Ignore `aime.mlc.TYPE` as it's not actively generated

**Semantic difference:**
- `ds01.interface`: How the container was created (atomic, orchestration, devcontainer, compose, docker)
- `ds01.container_type`: What type of container it is (could be semantic like "jupyter", "training", "serving")

If semantic distinction is needed, keep both. Otherwise consolidate to `ds01.interface`.

## Don't Hand-Roll

### Relabelling Running Containers

**Problem:** Temptation to relabel running containers using `docker update --label-add`.

**Don't do this because:**
1. `docker update` doesn't support label modification (labels are immutable after creation)
2. Would require stopping, removing, and recreating containers (disruptive)
3. Natural turnover is faster than coordinated relabelling (containers cycle within days/weeks)

**Use instead:** Fallback function for read operations, wait for natural container lifecycle.

### Complex Migration State Files

**Problem:** Temptation to track which containers have been migrated in state files.

**Don't do this because:**
1. Docker labels are the state (no need for secondary tracking)
2. Fallback function handles detection automatically (`ds01.user` present = migrated)
3. State files create synchronisation problems and stale data

**Use instead:** Query labels directly, let natural turnover handle migration.

## Common Pitfalls

### Pitfall 1: Case Sensitivity in Label Names

**What goes wrong:** Docker label names are case-sensitive. `aime.mlc.USER` and `ds01.user` use different cases.

**Why it happens:** AIME used uppercase for label leaf names, DS01 convention is lowercase.

**How to avoid:**
- Use exact string matches in grep/sed commands
- Test label access with actual containers
- Document the case convention in schema

**Warning signs:** Labels returning `<no value>` when they should exist.

### Pitfall 2: Incomplete Ownership Fallback

**What goes wrong:** Scripts use direct label access instead of calling the fallback function, leaving old containers inaccessible.

**Why it happens:** Not all scripts have been updated to use docker-utils.sh library functions.

**How to avoid:**
- Grep for all `"aime.mlc.USER"` and `"ds01.user"` string literals
- Replace with calls to `ds01_get_container_owner()` (bash) or `get_container_owner()` (python)
- Verify no direct label access remains

**Warning signs:** Some scripts work with old containers, others don't.

### Pitfall 3: Forgotten Docker Filters

**What goes wrong:** Container queries use `--filter label=aime.mlc.USER=$user` which misses new containers.

**Why it happens:** Filters are less obvious than direct label access.

**How to avoid:**
- Search for `--filter.*aime.mlc` patterns
- Update to `--filter label=ds01.user=$user`
- Test with both old and new containers

**Warning signs:** Container lists are incomplete after migration starts.

### Pitfall 4: Documentation Drift

**What goes wrong:** Documentation (README.md, architecture docs) still references `aime.mlc.*` labels.

**Why it happens:** Documentation files are easy to miss during code-focused migration.

**How to avoid:**
- Include `docs-admin/`, `docs-user/`, and `*.md` files in migration scope
- Search for `aime.mlc` in all text files, not just scripts
- Update examples and architecture diagrams

**Warning signs:** User confusion when documentation doesn't match behaviour.

### Pitfall 5: Testing Only New Containers

**What goes wrong:** Migration breaks access to existing containers because fallback wasn't tested.

**Why it happens:** Testing focuses on "happy path" with newly created containers.

**How to avoid:**
- Test ownership detection on containers with only `aime.mlc.USER` labels
- Test ownership detection on containers with only `ds01.user` labels
- Verify fallback function returns correct owner in both cases

**Warning signs:** UAT reveals old containers are inaccessible.

## Code Examples

### Ownership Detection (Standard Pattern)

```bash
# Bash - use docker-utils.sh function
source "${DS01_ROOT:-/opt/ds01-infra}/scripts/lib/docker-utils.sh"

# Get container owner (handles fallback automatically)
owner=$(ds01_get_container_owner "$container_tag")

# Check if container is owned by current user
if [[ "$owner" == "$(whoami)" ]]; then
    echo "You own this container"
fi
```

```python
# Python - use ds01_core.py function
import sys
sys.path.insert(0, '/opt/ds01-infra/scripts/lib')
from ds01_core import get_container_owner

# Get container owner (handles fallback automatically)
owner = get_container_owner(container_name)

# Check ownership
if owner == os.getenv('USER'):
    print("You own this container")
```

### Container Filtering (Updated Pattern)

```bash
# OLD: Filter by aime.mlc.USER
docker ps --filter "label=aime.mlc.USER=$username"

# NEW: Filter by ds01.user
docker ps --filter "label=ds01.user=$username"

# MIGRATION PERIOD: Query both (until fallback removed)
docker ps --filter "label=ds01.user=$username" && \
docker ps --filter "label=aime.mlc.USER=$username"
```

### Multi-Label Queries (Updated Pattern)

```bash
# OLD: Query multiple ownership labels
docker ps --format '{{.Names}}|{{.Label "ds01.user"}}|{{.Label "aime.mlc.USER"}}'

# NEW: Query single ownership label (post-migration)
docker ps --format '{{.Names}}|{{.Label "ds01.user"}}'

# Handle in script using fallback function instead of template
for container in $(docker ps --format '{{.Names}}'); do
    owner=$(ds01_get_container_owner "$container")
    echo "$container|$owner"
done
```

## Label Schema Document

**Target location:** `docs-admin/architecture/LABEL_SCHEMA.md`

**Purpose:** Single source of truth for all `ds01.*` labels.

**Structure:**
```markdown
# DS01 Container Label Schema

All DS01-managed containers use the `ds01.*` label namespace.

## Core Labels

| Label | Type | Required | Set By | Description |
|-------|------|----------|--------|-------------|
| `ds01.user` | string | Yes | docker-wrapper.sh | Container owner username |
| `ds01.managed` | boolean | Yes | docker-wrapper.sh | DS01 management flag |
| `ds01.interface` | enum | Yes | docker-wrapper.sh | Creation interface (atomic/orchestration/devcontainer/compose/docker) |
| ... | ... | ... | ... | ... |

## Metadata Labels (Optional)

These labels provide additional context but are not required for DS01 operation.

| Label | Type | Set By | Description |
|-------|------|--------|-------------|
| `ds01.framework` | string | mlc-patched.py | ML framework and version (e.g., "pytorch-2.0") |
| `ds01.arch` | string | mlc-patched.py | GPU architecture ("CUDA" or "ROCM") |
| ... | ... | ... | ... |

## Deprecated Labels

These labels are from legacy AIME integration and are deprecated. Use fallback functions to read them but do not write them.

| Label | Replacement | Removal Date |
|-------|-------------|--------------|
| `aime.mlc.USER` | `ds01.user` | TBD (when no containers remain) |
| `aime.mlc.FRAMEWORK` | `ds01.framework` | TBD |
| ... | ... | ... |

## Label Naming Convention

- Namespace: `ds01.*` (lowercase)
- Hierarchy separator: `.` (dot)
- Leaf name separator: `_` (underscore)
- Examples: `ds01.gpu.uuid`, `ds01.created_at`, `ds01.work_mount`
```

## State of the Art

### Label Namespace Evolution

| Approach | AIME Upstream | DS01 Current (Mixed) | DS01 Target |
|----------|---------------|----------------------|-------------|
| Namespace | `aime.mlc.*` | `aime.mlc.*` + `ds01.*` | `ds01.*` |
| Case convention | UPPERCASE leaf names | Mixed (UPPERCASE + lowercase) | lowercase |
| Ownership label | `aime.mlc.USER` | `ds01.user` + fallback | `ds01.user` |
| Management flag | N/A | `ds01.managed` | `ds01.managed` |
| Impact | Upstream compatible | Divergence started | Clean namespace |

**Timeline:**
- Pre-2025: Pure AIME labels (`aime.mlc.*`)
- 2025-2026: Mixed namespace (`aime.mlc.*` + `ds01.*`)
- Post-Phase-7: Pure DS01 labels (`ds01.*`)

**Deprecated patterns:**
- Direct label access without fallback (use library functions)
- UPPERCASE label names (use lowercase)
- `aime.mlc.*` namespace (migrate to `ds01.*`)

## Open Questions

### Question 1: MIG Label Naming Inconsistency

**What we know:**
- Current codebase uses `ds01.gpu.uuid` (singular) and `ds01.gpu.uuids` (plural)
- Also uses `ds01.gpu.slots` and `ds01.gpu.allocated` seemingly interchangeably
- gpu-state-reader.py and GPU allocator use different patterns

**What's unclear:**
- Which is the canonical label for multi-GPU/MIG allocation?
- Should we standardise on plural form always (`ds01.gpu.uuids`, `ds01.gpu.slots`) or context-dependent?

**Recommendation:**
- Use plural forms for consistency: `ds01.gpu.uuids`, `ds01.gpu.slots`
- Deprecate singular forms and `ds01.gpu.allocated`
- Update GPU allocator and reader scripts to use consistent naming
- Document in schema which labels are comma-separated lists

### Question 2: Container Type vs Interface Semantic

**What we know:**
- `ds01.interface` tracks how container was created (atomic/orchestration/devcontainer/compose/docker)
- `ds01.container_type` exists in some scripts but semantic is unclear
- User decision says "Claude's discretion to assess and consolidate"

**What's unclear:**
- Is there a meaningful semantic difference?
- Is `ds01.container_type` actively used or legacy?

**Recommendation:**
- Grep for `ds01.container_type` usage patterns
- If it's semantic (jupyter/training/serving), keep separate from `ds01.interface`
- If it's duplicating interface detection, consolidate to `ds01.interface`
- Document final decision in schema

### Question 3: Metadata Label Necessity

**What we know:**
- mlc-patched.py sets many metadata labels (FRAMEWORK, ARCH, mounts, etc.)
- These are informational, not used for access control or enforcement

**What's unclear:**
- Are these labels actively used by monitoring/reporting scripts?
- Could they be omitted to reduce label bloat?

**Recommendation:**
- Keep metadata labels for observability and debugging
- They're cheap (bytes per container) and useful for dashboards
- Migrate them to lowercase `ds01.*` namespace as planned
- Document which are required vs optional in schema

## Sources

### Primary (HIGH confidence)

- `/opt/ds01-infra/scripts/docker/mlc-patched.py` - Label generation source code (lines 1644-1656)
- `/opt/ds01-infra/scripts/lib/docker-utils.sh` - Ownership fallback implementation (lines 124-135)
- `/opt/ds01-infra/scripts/docker/docker-wrapper.sh` - DS01 label injection logic
- Grep results across 76 files showing `aime.mlc.*` and `ds01.*` usage patterns
- CONTEXT.md user decisions (7 locked decisions, 1 discretion area)

### Secondary (MEDIUM confidence)

- Phase 3 and Phase 5 planning documents - Ownership chain and fail-open patterns
- Architecture documentation in `docs-admin/architecture/` - Label usage context

### Tertiary (LOW confidence)

- None (codebase-internal research, no external sources)

## Metadata

**Confidence breakdown:**
- Label inventory: HIGH - Direct code inspection of mlc-patched.py and docker-wrapper.sh
- Migration scope: HIGH - Grep results across full codebase
- Ownership fallback: HIGH - Existing implementation in docker-utils.sh
- Label semantics: MEDIUM - Some ambiguity in container_type vs interface
- GPU label naming: MEDIUM - Inconsistent patterns observed, need consolidation

**Research date:** 2026-02-16
**Valid until:** Indefinite (codebase-internal, no external dependencies)

**Caveats:**
- This research is DS01-specific and doesn't apply to upstream AIME
- Label migration is a breaking divergence from AIME upstream
- Natural container turnover timeline depends on user behaviour (days to weeks typical)
