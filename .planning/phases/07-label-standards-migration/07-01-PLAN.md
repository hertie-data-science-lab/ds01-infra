---
phase: 07-label-standards-migration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - config/label-schema.yaml
  - scripts/docker/mlc-patched.py
  - scripts/lib/docker-utils.sh
  - scripts/lib/ds01_core.py
autonomous: true

must_haves:
  truths:
    - "mlc-patched.py generates ds01.* labels instead of aime.mlc.* for all new containers"
    - "Shared library fallback function checks ds01.user first, then aime.mlc.USER for backward compatibility"
    - "Python library has equivalent fallback function for ownership detection"
    - "Label schema document defines all valid ds01.* labels"
  artifacts:
    - path: "config/label-schema.yaml"
      provides: "Authoritative ds01.* label namespace schema"
      contains: "ds01.user"
    - path: "scripts/docker/mlc-patched.py"
      provides: "ds01.* label generation for new containers"
      contains: "container_label = \"ds01\""
    - path: "scripts/lib/docker-utils.sh"
      provides: "Bash ownership fallback (ds01.user -> aime.mlc.USER)"
      contains: "aime.mlc.USER"
    - path: "scripts/lib/ds01_core.py"
      provides: "Python ownership fallback function"
      contains: "get_container_owner_from_labels"
  key_links:
    - from: "scripts/docker/mlc-patched.py"
      to: "config/label-schema.yaml"
      via: "label names match schema"
      pattern: "ds01\\."
---

<objective>
Patch the label generation root (mlc-patched.py) from `aime.mlc.*` to `ds01.*` namespace and update all internal mlc-patched.py references. Create the authoritative label schema document. Add Python ownership fallback to ds01_core.py. Verify existing docker-utils.sh fallback is correct.

Purpose: This is the root fix — once mlc-patched.py writes ds01.* labels, all new containers get the correct namespace. The schema document becomes the single source of truth for the label namespace. The fallback functions provide backward compatibility for existing containers.

Output: Patched mlc-patched.py, label schema YAML, Python fallback function, verified Bash fallback.
</objective>

<execution_context>
@/home/datasciencelab/.claude/get-shit-done/workflows/execute-plan.md
@/home/datasciencelab/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-label-standards-migration/07-CONTEXT.md
@.planning/phases/07-label-standards-migration/07-RESEARCH.md
@scripts/docker/mlc-patched.py
@scripts/lib/docker-utils.sh
@scripts/lib/ds01_core.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create label schema document and patch mlc-patched.py label generation</name>
  <files>config/label-schema.yaml, scripts/docker/mlc-patched.py</files>
  <action>
  **1. Create `config/label-schema.yaml`** — the authoritative schema for all ds01.* labels.

  Structure as a YAML document with each label as a key containing: description, type, set_by, example. Include ALL labels from both the current aime.mlc.* set (mapped to ds01.*) and existing ds01.* labels.

  Label mapping (aime.mlc.* → ds01.*):
  - `aime.mlc` (base, =username) → `ds01.user` (already exists in docker-wrapper.sh)
  - `aime.mlc.USER` → `ds01.user` (consolidate with base)
  - `aime.mlc.NAME` → `ds01.name` (container display name)
  - `aime.mlc.ARCH` → `ds01.arch` (GPU architecture)
  - `aime.mlc.MLC_VERSION` → `ds01.mlc_version` (AIME MLC version)
  - `aime.mlc.WORK_MOUNT` → `ds01.work_mount` (workspace host dir)
  - `aime.mlc.DATA_MOUNT` → `ds01.data_mount` (data host dir)
  - `aime.mlc.MODELS_MOUNT` → `ds01.models_mount` (models host dir)
  - `aime.mlc.FRAMEWORK` → `ds01.framework` (framework-version)
  - `aime.mlc.GPUS` → `ds01.gpus` (GPU allocation string from mlc)
  - `aime.mlc.DS01_MANAGED` → `ds01.managed` (already exists)
  - `aime.mlc.CUSTOM_IMAGE` → `ds01.custom_image` (custom image name)

  Also include existing ds01.* labels already in use:
  - `ds01.user`, `ds01.managed`, `ds01.interface`, `ds01.container_type`, `ds01.slice`
  - `ds01.created_at`, `ds01.gpu.uuid`, `ds01.gpu.uuids`, `ds01.gpu.slots`
  - `ds01.gpu.allocated`, `ds01.gpu_ephemeral`, `ds01.gpu_slot`, `ds01.protected`

  And the DS01-specific labels from mlc-create-from-image.sh / image-create mapped:
  - `aime.mlc.DS01_USER` → `ds01.user` (consolidate)
  - `aime.mlc.DS01_USER_ID` → `ds01.user_id`
  - `aime.mlc.DS01_GROUP_ID` → `ds01.group_id`
  - `aime.mlc.DS01_CONTAINER` → `ds01.container_name`
  - `aime.mlc.DS01_IMAGE` → `ds01.image`
  - `aime.mlc.DS01_CREATED` → `ds01.created_at` (consolidate with existing)
  - `aime.mlc.DS01_TYPE` → `ds01.container_type` (consolidate with existing)
  - `aime.mlc.DS01_PROJECT` → `ds01.project`
  - `aime.mlc.DS01_WORKSPACE` → `ds01.workspace`
  - `aime.mlc.DS01_HAS_USER_SETUP` → `ds01.has_user_setup`
  - `aime.mlc.DS01_USERNAME` → `ds01.username` (sanitised username)
  - `aime.mlc.DS01_FRAMEWORK` → `ds01.framework` (consolidate)

  **2. Patch mlc-patched.py label generation** (the root fix):

  At line 2269, change:
  ```python
  container_label = "aime.mlc"
  ```
  to:
  ```python
  container_label = "ds01"
  ```

  Then update the label names in `create_docker_container()` (lines 1644-1656). The current pattern uses `{container_label}.UPPERCASE_NAME`. Change to lowercase:
  - `{container_label}={user_name}` → `{container_label}.user={user_name}` (was bare base label)
  - `.NAME=` → `.name=`
  - `.USER=` → `.user=` (note: this becomes a duplicate of the line above — REMOVE the bare `{container_label}={user_name}` line since `ds01.user` now serves that purpose)
  - `.ARCH=` → `.arch=`
  - `.MLC_VERSION=` → `.mlc_version=`
  - `.WORK_MOUNT=` → `.work_mount=`
  - `.DATA_MOUNT=` → `.data_mount=`
  - `.MODELS_MOUNT=` → `.models_mount=`
  - `.FRAMEWORK=` → `.framework=`
  - `.GPUS=` → `.gpus=`
  - `.DS01_MANAGED=` → `.managed=` (consolidate — docker-wrapper.sh already writes ds01.managed)
  - `.CUSTOM_IMAGE=` → `.custom_image=`

  **3. Update mlc-patched.py internal references** — all the places where mlc-patched.py reads aime.mlc.* labels:

  a) `columns_transcription` dict (line ~1275-1284): Change all `aime.mlc.NAME` → `ds01.name`, `aime.mlc.FRAMEWORK` → `ds01.framework`, `aime.mlc.USER` → `ds01.user`, etc.

  b) Container listing filter (line ~1221): Change `label=aime.mlc` to `label=ds01.user` (since the bare `aime.mlc` label no longer exists — use `ds01.user` as the filter label for MLC containers).

  c) Container check functions:
  - `check_container_tag()` line ~491: `'label=aime.mlc'` → `'label=ds01.user'`
  - `check_container_running()` line ~505: `'label=aime.mlc'` → `'label=ds01.user'`
  - `get_container_image()` line ~745: `'label=aime.mlc'` → `'label=ds01.user'`
  - Container listing at line ~599: `label=aime.mlc.USER=` → `label=ds01.user=`
  - Image get at line ~2584: `'label=aime.mlc'` → `'label=ds01.user'`

  d) Image inspect labels (line ~2234-2236): Change `aime.mlc.DS01_HAS_USER_SETUP` → `ds01.has_user_setup`, `aime.mlc.DS01_USER_ID` → `ds01.user_id`, `aime.mlc.DS01_GROUP_ID` → `ds01.group_id`.

  e) Comment at line ~19-26: Update comments referencing `aime.mlc.*` labels.

  f) Comment at line ~598: Update comment text.

  g) Comment at line ~666: Update comment text.
  </action>
  <verify>
  ```bash
  # No remaining aime.mlc references in mlc-patched.py (except possible comments about migration)
  grep -c "aime\.mlc" scripts/docker/mlc-patched.py
  # Should be 0 or only in backward-compat comments

  # container_label is now "ds01"
  grep 'container_label = "ds01"' scripts/docker/mlc-patched.py

  # Schema file exists and contains expected labels
  python3 -c "import yaml; d=yaml.safe_load(open('config/label-schema.yaml')); assert 'ds01.user' in d['labels']"

  # Python syntax check
  python3 -m py_compile scripts/docker/mlc-patched.py
  ```
  </verify>
  <done>mlc-patched.py generates ds01.* labels for new containers. All internal references updated. Label schema document exists with complete namespace definition.</done>
</task>

<task type="auto">
  <name>Task 2: Add Python ownership fallback and verify Bash fallback</name>
  <files>scripts/lib/ds01_core.py, scripts/lib/docker-utils.sh</files>
  <action>
  **1. Add `get_container_owner_from_labels()` to ds01_core.py:**

  Add a function that accepts a labels dict (from docker inspect) and returns the owner username using the fallback chain: `ds01.user` → `aime.mlc.USER` → None.

  ```python
  def get_container_owner_from_labels(labels: dict[str, str]) -> str | None:
      """Get container owner from Docker labels with backward-compatible fallback.

      Checks ds01.user first (new namespace), falls back to aime.mlc.USER
      (legacy AIME namespace) for containers created before Phase 7 migration.

      Args:
          labels: Docker container labels dict

      Returns:
          Username string or None if no ownership label found

      # TODO: Remove aime.mlc.USER fallback when no legacy containers remain
      # Check: docker ps --filter label=aime.mlc.USER returns nothing
      """
      owner = labels.get("ds01.user")
      if owner:
          return owner
      # Legacy fallback for pre-Phase-7 containers
      return labels.get("aime.mlc.USER") or None
  ```

  Also add a convenience `get_container_managed()` function:
  ```python
  def get_container_managed_from_labels(labels: dict[str, str]) -> bool:
      """Check if container is DS01-managed from labels.

      # TODO: Remove aime.mlc.DS01_MANAGED fallback when no legacy containers remain
      """
      return labels.get("ds01.managed") == "true" or labels.get("aime.mlc.DS01_MANAGED") == "true"
  ```

  **2. Verify docker-utils.sh `ds01_get_container_owner()`:**

  The existing function at line 124-135 already implements the correct fallback pattern (ds01.user → aime.mlc.USER). Verify it has the TODO comment for future removal. If not, add:
  ```bash
  # TODO: Remove aime.mlc.USER fallback when no legacy containers remain
  # Check: docker ps --filter label=aime.mlc.USER returns nothing
  ```

  No other changes needed to docker-utils.sh — the fallback is already correct.
  </action>
  <verify>
  ```bash
  # Python syntax check
  python3 -m py_compile scripts/lib/ds01_core.py

  # Function exists
  python3 -c "from ds01_core import get_container_owner_from_labels; print(get_container_owner_from_labels({'ds01.user': 'alice'}))"

  # Fallback works
  python3 -c "from ds01_core import get_container_owner_from_labels; print(get_container_owner_from_labels({'aime.mlc.USER': 'bob'}))"

  # TODO comment exists in docker-utils.sh
  grep -c "TODO.*aime.mlc.USER.*fallback" scripts/lib/docker-utils.sh
  ```
  </verify>
  <done>Python and Bash shared libraries both have ownership fallback functions with TODO markers for future removal. Scripts can import these instead of inline fallback logic.</done>
</task>

</tasks>

<verification>
```bash
# 1. mlc-patched.py compiles cleanly
python3 -m py_compile scripts/docker/mlc-patched.py

# 2. ds01_core.py compiles cleanly
python3 -m py_compile scripts/lib/ds01_core.py

# 3. No aime.mlc references remain in mlc-patched.py
grep -c "aime\.mlc" scripts/docker/mlc-patched.py  # Should be 0

# 4. Label schema exists
test -f config/label-schema.yaml && echo "OK" || echo "MISSING"

# 5. container_label changed
grep 'container_label = "ds01"' scripts/docker/mlc-patched.py

# 6. Fallback functions exist
grep "get_container_owner_from_labels" scripts/lib/ds01_core.py
grep "aime.mlc.USER" scripts/lib/docker-utils.sh
```
</verification>

<success_criteria>
- mlc-patched.py generates ds01.* labels (not aime.mlc.*)
- All mlc-patched.py internal filter/read references updated to ds01.*
- Label schema document defines complete ds01.* namespace
- Python and Bash fallback functions available in shared libraries
- All Python files compile without errors
</success_criteria>

<output>
After completion, create `.planning/phases/07-label-standards-migration/07-01-SUMMARY.md`
</output>
