---
phase: 07-label-standards-migration
plan: 03
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - scripts/monitoring/check-idle-containers.sh
  - scripts/monitoring/detect-workloads.py
  - scripts/monitoring/container-dashboard.sh
  - scripts/monitoring/who-owns-containers.sh
  - scripts/monitoring/mlc-stats-wrapper.sh
  - scripts/monitoring/track-user-processes.sh
  - scripts/monitoring/audit-container.sh
  - scripts/maintenance/cleanup-stale-containers.sh
  - scripts/maintenance/enforce-max-runtime.sh
  - scripts/admin/ds01-users
  - scripts/admin/ds01-dashboard
  - scripts/admin/dashboard
  - scripts/admin/user-activity-report
autonomous: true

must_haves:
  truths:
    - "Monitoring scripts filter and inspect containers using ds01.* labels"
    - "Maintenance scripts detect ownership via ds01.user with aime.mlc.USER fallback"
    - "Admin dashboards query ds01.* labels for container enumeration"
    - "Idle detection and max-runtime enforcement use ds01.* ownership detection"
  artifacts:
    - path: "scripts/monitoring/check-idle-containers.sh"
      provides: "Idle detection with ds01.user ownership"
      contains: "ds01.user"
    - path: "scripts/monitoring/detect-workloads.py"
      provides: "Workload detection with ds01.user primary"
      contains: "ds01.user"
    - path: "scripts/admin/ds01-dashboard"
      provides: "Admin dashboard using ds01.managed filter"
      contains: "ds01.managed"
    - path: "scripts/maintenance/cleanup-stale-containers.sh"
      provides: "Cleanup with ownership fallback"
      contains: "ds01.user"
  key_links:
    - from: "scripts/monitoring/check-idle-containers.sh"
      to: "scripts/lib/docker-utils.sh"
      via: "ownership fallback pattern"
      pattern: "ds01_get_container_owner|ds01\\.user"
    - from: "scripts/admin/ds01-dashboard"
      to: "config/label-schema.yaml"
      via: "label names match schema"
      pattern: "ds01\\."
---

<objective>
Migrate all monitoring, maintenance, and admin script references from aime.mlc.* to ds01.* labels. These are the operational scripts that read container labels for idle detection, cleanup, runtime enforcement, and admin dashboards.

Purpose: After Plans 01 and 02, this completes the full migration. Monitoring and admin scripts are the primary consumers of container labels for operational decisions. Runs in parallel with Plan 02 (no file overlap).

Output: 13 scripts migrated to ds01.* label namespace with backward-compatible fallbacks.
</objective>

<execution_context>
@/home/datasciencelab/.claude/get-shit-done/workflows/execute-plan.md
@/home/datasciencelab/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/07-label-standards-migration/07-CONTEXT.md
@.planning/phases/07-label-standards-migration/07-RESEARCH.md
@.planning/phases/07-label-standards-migration/07-01-SUMMARY.md
@config/label-schema.yaml
@scripts/lib/docker-utils.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate monitoring scripts</name>
  <files>scripts/monitoring/check-idle-containers.sh, scripts/monitoring/detect-workloads.py, scripts/monitoring/container-dashboard.sh, scripts/monitoring/who-owns-containers.sh, scripts/monitoring/mlc-stats-wrapper.sh, scripts/monitoring/track-user-processes.sh, scripts/monitoring/audit-container.sh</files>
  <action>
  For each monitoring script, replace `aime.mlc.*` references with `ds01.*` equivalents. Where scripts detect ownership, maintain the fallback pattern and add TODO comments.

  **scripts/monitoring/check-idle-containers.sh** (lines ~184-185):
  - The script already has ds01.user as primary. Lines 184-185 are the fallback: `aime.mlc.USER`. Keep the fallback, update the comment to say "Legacy fallback" and add TODO.

  **scripts/monitoring/detect-workloads.py** (lines ~163, ~181-182):
  - Line 163 comment: update to mention ds01.user primary
  - Lines 181-182: Currently checks `aime.mlc.USER` as a separate strategy. Reorder so `ds01.user` is checked first (it may already be — verify). Keep `aime.mlc.USER` as fallback. Add TODO comment.

  **scripts/monitoring/container-dashboard.sh** (lines ~96, ~106, ~180-181):
  - Line 96: `--filter "label=aime.mlc.DS01_USER=$current_user"` → `--filter "label=ds01.user=$current_user"`
  - Line 106: inspect `aime.mlc.DS01_USER` → inspect `ds01.user`
  - Lines 180-181: same filter pattern → `ds01.user=`

  **scripts/monitoring/who-owns-containers.sh** (lines ~11-12, ~45):
  - Line 11: `--filter "label=aime.mlc.DS01_USER"` → `--filter "label=ds01.user"`
  - Line 12 format: replace `aime.mlc.DS01_USER` → `ds01.user`, `aime.mlc.DS01_USER_ID` → `ds01.user_id`, `aime.mlc.DS01_PROJECT` → `ds01.project`
  - Line 45: same filter and format changes.

  **scripts/monitoring/mlc-stats-wrapper.sh** (lines ~16, ~26):
  - Line 16: `--filter "label=aime.mlc.DS01_USER=$USERNAME"` → `--filter "label=ds01.user=$USERNAME"`
  - Line 26: `aime.mlc.DS01_IMAGE` → `ds01.image`

  **scripts/monitoring/track-user-processes.sh** (lines ~11, ~25):
  - Line 11: `--filter "label=aime.mlc.DS01_USER"` → `--filter "label=ds01.user"`, format `aime.mlc.DS01_USER` → `ds01.user`
  - Line 25: `--filter "label=aime.mlc.DS01_USER=$user"` → `--filter "label=ds01.user=$user"`

  **scripts/monitoring/audit-container.sh** (lines ~15-17, ~59):
  - Lines 15-17: Replace `aime.mlc.DS01_USER` and `aime.mlc.DS01_USER_ID` with `ds01.user` and `ds01.user_id`
  - Line 59: Same replacement for the negative check.
  </action>
  <verify>
  ```bash
  # Count remaining aime.mlc references in monitoring scripts
  for f in scripts/monitoring/check-idle-containers.sh scripts/monitoring/container-dashboard.sh \
           scripts/monitoring/who-owns-containers.sh scripts/monitoring/mlc-stats-wrapper.sh \
           scripts/monitoring/track-user-processes.sh scripts/monitoring/audit-container.sh; do
    count=$(grep -c "aime\.mlc" "$f" 2>/dev/null || echo 0)
    echo "$f: $count"
  done
  # All should be 0 (no remaining aime.mlc references)

  # detect-workloads.py should only have fallback reference
  grep -c "aime\.mlc" scripts/monitoring/detect-workloads.py
  # Should be 1-2 (fallback lines only)

  # check-idle-containers.sh should only have fallback reference
  grep -c "aime\.mlc" scripts/monitoring/check-idle-containers.sh
  # Should be 1 (fallback line only)

  # Python syntax check
  python3 -m py_compile scripts/monitoring/detect-workloads.py

  # Bash syntax checks
  for f in scripts/monitoring/check-idle-containers.sh scripts/monitoring/container-dashboard.sh \
           scripts/monitoring/who-owns-containers.sh scripts/monitoring/mlc-stats-wrapper.sh \
           scripts/monitoring/track-user-processes.sh scripts/monitoring/audit-container.sh; do
    bash -n "$f" && echo "OK: $f" || echo "FAIL: $f"
  done
  ```
  </verify>
  <done>All 7 monitoring scripts migrated to ds01.* labels. Fallback retained only in ownership detection functions with TODO markers.</done>
</task>

<task type="auto">
  <name>Task 2: Migrate maintenance and admin scripts</name>
  <files>scripts/maintenance/cleanup-stale-containers.sh, scripts/maintenance/enforce-max-runtime.sh, scripts/admin/ds01-users, scripts/admin/ds01-dashboard, scripts/admin/dashboard, scripts/admin/user-activity-report</files>
  <action>
  **scripts/maintenance/cleanup-stale-containers.sh** (lines ~62-63):
  - The script already has ds01.user as primary. Lines 62-63 are the fallback: `aime.mlc.USER`. Keep the fallback, update comment to "Legacy fallback", add TODO.

  **scripts/maintenance/enforce-max-runtime.sh** (lines ~140-141):
  - Same pattern — ds01.user primary, aime.mlc.USER fallback. Keep fallback, add TODO comment.

  **scripts/admin/ds01-users** (lines ~61, ~75):
  - Line 61: `grep -o "aime.mlc.USER=[^,]*"` → Change to use ds01.user. New approach:
    ```bash
    USERS=$(docker ps --format "{{.Label \"ds01.user\"}}" | sort -u | grep -v '^$')
    ```
    If empty (no ds01.user labels on running containers), fallback:
    ```bash
    if [[ -z "$USERS" ]]; then
        USERS=$(docker ps --format "{{.Labels}}" | grep -o "aime.mlc.USER=[^,]*" | cut -d= -f2 | sort -u)
    fi
    ```
    Add TODO comment on fallback.
  - Line 75: `--filter "label=aime.mlc.USER=$user"` → `--filter "label=ds01.user=$user"`

  **scripts/admin/ds01-dashboard** (lines ~336-337, ~361-362):
  - Line 336: `--filter "label=aime.mlc.DS01_MANAGED=true"` → `--filter "label=ds01.managed=true"`
  - Line 337: `grep "aime.mlc.GPUS=device="` → `grep "ds01.gpus=device="` (Note: new label is `ds01.gpus`)
  - Line 361: `--filter "label=aime.mlc.DS01_MANAGED=true"` → `--filter "label=ds01.managed=true"`
  - Line 362: same pattern.

  **scripts/admin/dashboard** (Python script, lines ~328-329, ~363, ~430, ~960):
  - Lines 328-329: Update comment describing ownership detection order: `1. ds01.user (primary), 2. aime.mlc.USER (legacy fallback)`
  - Line 363: format string — change `aime.mlc.USER` to keep as fallback column, ensure `ds01.user` is primary. Keep both in the format string for backward compat.
  - Line 430: same format string update.
  - Line 960: same format string update.
  - Remove `aime.mlc.username` references if they only exist in this file (check — this appears to be a legacy label).

  **scripts/admin/user-activity-report** (line ~73):
  - `--filter "label=aime.mlc.USER=$username"` → `--filter "label=ds01.user=$username"`
  </action>
  <verify>
  ```bash
  # Count remaining aime.mlc in maintenance scripts (should be 0 or fallback only)
  for f in scripts/maintenance/cleanup-stale-containers.sh scripts/maintenance/enforce-max-runtime.sh; do
    count=$(grep -c "aime\.mlc" "$f" 2>/dev/null || echo 0)
    echo "$f: $count (expect 1 fallback)"
  done

  # Count in admin scripts
  for f in scripts/admin/ds01-users scripts/admin/ds01-dashboard scripts/admin/user-activity-report; do
    count=$(grep -c "aime\.mlc" "$f" 2>/dev/null || echo 0)
    echo "$f: $count"
  done
  # ds01-users: 1-2 (fallback), ds01-dashboard: 0, user-activity-report: 0

  # dashboard (Python) — should have aime.mlc.USER only in fallback format strings
  grep -c "aime\.mlc" scripts/admin/dashboard

  # Bash syntax checks
  for f in scripts/maintenance/cleanup-stale-containers.sh scripts/maintenance/enforce-max-runtime.sh \
           scripts/admin/ds01-users scripts/admin/ds01-dashboard scripts/admin/user-activity-report; do
    bash -n "$f" && echo "OK: $f" || echo "FAIL: $f"
  done
  ```
  </verify>
  <done>All 6 maintenance and admin scripts migrated to ds01.* labels. Admin dashboard filters on ds01.managed. User enumeration uses ds01.user primary with legacy fallback.</done>
</task>

</tasks>

<verification>
```bash
# 1. Full sweep — count all remaining aime.mlc references in scripts/
grep -r "aime\.mlc" scripts/ --include="*.sh" --include="*.py" -c 2>/dev/null | grep -v ":0$" | sort

# Expected: Only fallback lines remain in:
# - scripts/lib/docker-utils.sh (1 — ownership fallback)
# - scripts/docker/docker-wrapper.sh (1-2 — ownership fallback)
# - scripts/monitoring/check-idle-containers.sh (1 — ownership fallback)
# - scripts/monitoring/detect-workloads.py (1 — ownership fallback)
# - scripts/maintenance/cleanup-stale-containers.sh (1 — ownership fallback)
# - scripts/maintenance/enforce-max-runtime.sh (1 — ownership fallback)
# - scripts/docker/ds01-resource-query.py (2 — ownership fallback)
# - scripts/docker/gpu-state-reader.py (2 — ownership fallback)
# - scripts/docker/sync-container-owners.py (1-2 — ownership fallback)
# - scripts/docker/container-owner-tracker.py (2-3 — ownership + managed fallback)
# - scripts/user/atomic/container-list (1-2 — ownership fallback)
# - scripts/admin/dashboard (2-3 — ownership fallback in format strings)
# - scripts/admin/ds01-users (1 — fallback user enumeration)

# 2. All fallback lines have TODO comments
grep -r "aime\.mlc" scripts/ --include="*.sh" --include="*.py" -B1 | grep -c "TODO"

# 3. All Bash scripts pass syntax check
find scripts/ -name "*.sh" -exec bash -n {} \; 2>&1 | head -20

# 4. All Python scripts compile
find scripts/ -name "*.py" -exec python3 -m py_compile {} \; 2>&1 | head -20
```
</verification>

<success_criteria>
- All monitoring scripts (7 files) use ds01.* labels as primary
- All maintenance scripts (2 files) use ds01.* labels with ownership fallback
- All admin scripts (4 files) use ds01.* labels for filtering and display
- No non-fallback aime.mlc.* references remain in any script
- All remaining aime.mlc.* references are in ownership fallback code with TODO markers
- All files pass syntax checks
</success_criteria>

<output>
After completion, create `.planning/phases/07-label-standards-migration/07-03-SUMMARY.md`
</output>
