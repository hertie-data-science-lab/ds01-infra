---
phase: 07-label-standards-migration
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - scripts/docker/docker-wrapper.sh
  - scripts/docker/mlc-create-wrapper.sh
  - scripts/docker/mlc-create-from-image.sh
  - scripts/docker/enforce-containers.sh
  - scripts/docker/emergency-container-stop.sh
  - scripts/docker/ds01-resource-query.py
  - scripts/docker/gpu-state-reader.py
  - scripts/docker/sync-container-owners.py
  - scripts/docker/container-owner-tracker.py
  - scripts/user/atomic/container-list
  - scripts/user/atomic/container-create
  - scripts/user/atomic/image-create
  - scripts/lib/validate-resource-limits.sh
autonomous: true

must_haves:
  truths:
    - "Docker wrapper ownership detection uses ds01.user with aime.mlc.USER fallback"
    - "mlc-create-from-image.sh writes ds01.* labels for custom image containers"
    - "image-create writes ds01.* Dockerfile LABELs"
    - "All docker/ and user/ scripts filter on ds01.* labels with fallback where needed"
    - "container-list displays containers using ds01.* labels"
  artifacts:
    - path: "scripts/docker/mlc-create-from-image.sh"
      provides: "ds01.* label generation for custom image containers"
      contains: "ds01.user="
    - path: "scripts/user/atomic/image-create"
      provides: "ds01.* Dockerfile LABELs"
      contains: "ds01.has_user_setup"
    - path: "scripts/docker/docker-wrapper.sh"
      provides: "Ownership fallback in wrapper"
      contains: "aime.mlc.USER"
    - path: "scripts/docker/container-owner-tracker.py"
      provides: "Python ownership detection with ds01.user primary"
      contains: "ds01.user"
  key_links:
    - from: "scripts/docker/mlc-create-from-image.sh"
      to: "config/label-schema.yaml"
      via: "label names match schema"
      pattern: "ds01\\."
    - from: "scripts/docker/docker-wrapper.sh"
      to: "scripts/lib/docker-utils.sh"
      via: "consistent fallback pattern"
      pattern: "ds01\\.user.*aime\\.mlc\\.USER"
---

<objective>
Migrate all docker/, user/, and lib/ script references from aime.mlc.* to ds01.* labels. Update label generation in mlc-create-from-image.sh and image-create. Ensure backward-compatible fallback where scripts detect container ownership.

Purpose: After Plan 01 patched the root generation point (mlc-patched.py), this plan migrates all consumer scripts in the docker, user, and lib directories. These scripts create, filter, inspect, and enforce containers using labels.

Output: 13 scripts migrated to ds01.* label namespace with backward-compatible fallbacks.
</objective>

<execution_context>
@/home/datasciencelab/.claude/get-shit-done/workflows/execute-plan.md
@/home/datasciencelab/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/07-label-standards-migration/07-CONTEXT.md
@.planning/phases/07-label-standards-migration/07-RESEARCH.md
@.planning/phases/07-label-standards-migration/07-01-SUMMARY.md
@config/label-schema.yaml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate label generation scripts (mlc-create-from-image.sh, image-create) and Docker wrapper</name>
  <files>scripts/docker/mlc-create-from-image.sh, scripts/user/atomic/image-create, scripts/docker/docker-wrapper.sh</files>
  <action>
  **1. scripts/docker/mlc-create-from-image.sh** (lines 113-121):

  Replace all `aime.mlc.DS01_*` label writes with ds01.* equivalents:
  ```
  aime.mlc.DS01_USER=$USERNAME       → ds01.user=$USERNAME
  aime.mlc.DS01_USER_ID=$USER_ID     → ds01.user_id=$USER_ID
  aime.mlc.DS01_GROUP_ID=$GROUP_ID   → ds01.group_id=$GROUP_ID
  aime.mlc.DS01_CONTAINER=$NAME      → ds01.container_name=$CONTAINER_NAME
  aime.mlc.DS01_IMAGE=$IMAGE_NAME    → ds01.image=$IMAGE_NAME
  aime.mlc.DS01_CREATED=$(date ...)  → ds01.created_at=$(date -Iseconds)
  aime.mlc.DS01_TYPE=custom          → ds01.container_type=custom
  aime.mlc.DS01_PROJECT=$PROJECT     → ds01.project=$PROJECT_NAME
  aime.mlc.DS01_WORKSPACE=$WORKSPACE → ds01.workspace=$WORKSPACE_DIR
  ```
  Also add `--label "ds01.managed=true"` if not already present.

  **2. scripts/user/atomic/image-create** (lines 1445-1448):

  Replace Dockerfile LABEL lines:
  ```
  LABEL aime.mlc.DS01_HAS_USER_SETUP="true"  → LABEL ds01.has_user_setup="true"
  LABEL aime.mlc.DS01_USER_ID="$USER_ID"     → LABEL ds01.user_id="$USER_ID"
  LABEL aime.mlc.DS01_GROUP_ID="$GROUP_ID"   → LABEL ds01.group_id="$GROUP_ID"
  LABEL aime.mlc.DS01_USERNAME="$USERNAME"    → LABEL ds01.username="$SANITIZED_USERNAME"
  ```

  **3. scripts/docker/docker-wrapper.sh** (lines ~760-762):

  The ownership detection fallback already has the correct pattern (ds01.user primary, aime.mlc.USER fallback). Ensure:
  - The comment mentions this is a legacy fallback
  - Add a TODO comment: `# TODO: Remove aime.mlc.USER fallback when no legacy containers remain`
  - Keep the fallback logic intact — DO NOT remove it
  </action>
  <verify>
  ```bash
  # No aime.mlc references in mlc-create-from-image.sh
  grep -c "aime\.mlc" scripts/docker/mlc-create-from-image.sh  # Should be 0

  # No aime.mlc references in image-create (except possible backward-compat comments)
  grep -c "aime\.mlc" scripts/user/atomic/image-create  # Should be 0

  # docker-wrapper.sh still has fallback
  grep "aime.mlc.USER" scripts/docker/docker-wrapper.sh | head -2

  # Bash syntax check
  bash -n scripts/docker/mlc-create-from-image.sh
  ```
  </verify>
  <done>Label generation scripts write ds01.* labels. Docker wrapper maintains backward-compatible fallback. All with TODO markers for future cleanup.</done>
</task>

<task type="auto">
  <name>Task 2: Migrate remaining docker/, user/, and lib/ consumer scripts</name>
  <files>scripts/docker/mlc-create-wrapper.sh, scripts/docker/enforce-containers.sh, scripts/docker/emergency-container-stop.sh, scripts/docker/ds01-resource-query.py, scripts/docker/gpu-state-reader.py, scripts/docker/sync-container-owners.py, scripts/docker/container-owner-tracker.py, scripts/user/atomic/container-list, scripts/user/atomic/container-create, scripts/lib/validate-resource-limits.sh</files>
  <action>
  For each file, replace `aime.mlc.*` references with `ds01.*` equivalents. Where scripts detect ownership, use the fallback pattern (ds01.user first, aime.mlc.USER second) and add TODO comments.

  **scripts/docker/mlc-create-wrapper.sh** (line ~375):
  - `--filter "label=aime.mlc.USER=$CURRENT_USER"` → `--filter "label=ds01.user=$CURRENT_USER"`

  **scripts/docker/enforce-containers.sh** (lines ~61, ~131, ~145):
  - All `label=aime.mlc.DS01_USER=` → `label=ds01.user=`
  - `label=aime.mlc.DS01_USER=$(whoami)` → `label=ds01.user=$(whoami)`

  **scripts/docker/emergency-container-stop.sh** (lines ~16, ~17, ~23):
  - `--filter "label=aime.mlc.DS01_USER"` → `--filter "label=ds01.user"`
  - `aime.mlc.DS01_USER` inspect → `ds01.user` inspect

  **scripts/docker/ds01-resource-query.py** (lines ~94, ~187):
  - `labels.get('aime.mlc.USER', '')` → keep as fallback: `labels.get('ds01.user') or labels.get('aime.mlc.USER', '')`
  Wait — the current code already does `labels.get('ds01.user') or labels.get('aime.mlc.USER', '')`. This is the correct pattern. Add TODO comment only.

  **scripts/docker/gpu-state-reader.py** (lines ~280, ~633):
  - Same pattern: already has `labels.get('ds01.user') or labels.get('aime.mlc.USER', '')`. Add TODO comment.

  **scripts/docker/sync-container-owners.py** (lines ~69, ~79-80, ~241):
  - Line 79-80: `if "aime.mlc.USER" in labels: return labels["aime.mlc.USER"]` → change to check `ds01.user` first, then fallback to `aime.mlc.USER`. Use pattern: check `ds01.user` first.
  - Line 241: `labels.get("aime.mlc.DS01_MANAGED") == "true"` → `labels.get("ds01.managed") == "true" or labels.get("aime.mlc.DS01_MANAGED") == "true"`
  - Update docstring/comment at line ~69.

  **scripts/docker/container-owner-tracker.py** (lines ~232-234, ~355, ~391):
  - Lines 232-234: Move `ds01.user` check before `aime.mlc.USER` (it may already be — verify). Keep both as fallback chain.
  - Line 355: `labels.get("aime.mlc.DS01_MANAGED") == "true"` → `labels.get("ds01.managed") == "true" or labels.get("aime.mlc.DS01_MANAGED") == "true"`
  - Line 391: same managed check pattern.
  - Add TODO comments.

  **scripts/user/atomic/container-list** (lines ~87-89, ~101-106, ~156, ~355):
  - Line 89 format string: replace `aime.mlc.USER` → `ds01.user`, `aime.mlc.username` → keep as fallback (or remove if not used elsewhere), etc. The format should query `ds01.user` and keep `aime.mlc.USER` as fallback column.
  - Line 101-106: ownership checks — update labels.
  - Line 156: user message — update label name in display text.
  - Line 355: `aime.mlc.FRAMEWORK` → `ds01.framework`.

  **scripts/user/atomic/container-create** (lines ~1144, ~1172):
  - `aime.mlc.DS01_FRAMEWORK` → `ds01.framework`

  **scripts/lib/validate-resource-limits.sh** (line ~15):
  - `label=aime.mlc.DS01_USER=$username` → `label=ds01.user=$username`
  </action>
  <verify>
  ```bash
  # Count remaining aime.mlc references in each file (should be 0 or only in fallback/TODO comments)
  for f in scripts/docker/mlc-create-wrapper.sh scripts/docker/enforce-containers.sh \
           scripts/docker/emergency-container-stop.sh scripts/user/atomic/container-create \
           scripts/lib/validate-resource-limits.sh; do
    count=$(grep -c "aime\.mlc" "$f" 2>/dev/null || echo 0)
    echo "$f: $count"
  done
  # All should be 0

  # Files with deliberate fallback should still have aime.mlc.USER
  for f in scripts/docker/ds01-resource-query.py scripts/docker/gpu-state-reader.py \
           scripts/docker/sync-container-owners.py scripts/docker/container-owner-tracker.py \
           scripts/user/atomic/container-list; do
    grep -c "aime\.mlc" "$f"
  done
  # These should have small counts (1-3 for fallback lines only)

  # Python syntax checks
  python3 -m py_compile scripts/docker/ds01-resource-query.py
  python3 -m py_compile scripts/docker/gpu-state-reader.py
  python3 -m py_compile scripts/docker/sync-container-owners.py
  python3 -m py_compile scripts/docker/container-owner-tracker.py

  # Bash syntax checks
  bash -n scripts/docker/mlc-create-wrapper.sh
  bash -n scripts/docker/enforce-containers.sh
  bash -n scripts/docker/emergency-container-stop.sh
  bash -n scripts/lib/validate-resource-limits.sh
  ```
  </verify>
  <done>All docker/, user/, and lib/ consumer scripts migrated to ds01.* primary with aime.mlc.* fallback where needed for backward compatibility. TODO markers on all fallback lines.</done>
</task>

</tasks>

<verification>
```bash
# 1. Count total aime.mlc references in scripts/docker/ and scripts/user/
# Should be drastically reduced — only fallback lines remain
grep -r "aime\.mlc" scripts/docker/ scripts/user/ scripts/lib/ --include="*.sh" --include="*.py" -c 2>/dev/null | grep -v ":0$"

# 2. All Python files compile
for f in scripts/docker/ds01-resource-query.py scripts/docker/gpu-state-reader.py \
         scripts/docker/sync-container-owners.py scripts/docker/container-owner-tracker.py; do
  python3 -m py_compile "$f" && echo "OK: $f" || echo "FAIL: $f"
done

# 3. All Bash files pass syntax check
for f in scripts/docker/mlc-create-wrapper.sh scripts/docker/enforce-containers.sh \
         scripts/docker/emergency-container-stop.sh scripts/docker/mlc-create-from-image.sh \
         scripts/lib/validate-resource-limits.sh; do
  bash -n "$f" && echo "OK: $f" || echo "FAIL: $f"
done

# 4. Label generation uses ds01.* in mlc-create-from-image.sh
grep "ds01\." scripts/docker/mlc-create-from-image.sh | head -5

# 5. Dockerfile labels in image-create use ds01.*
grep "LABEL ds01\." scripts/user/atomic/image-create
```
</verification>

<success_criteria>
- mlc-create-from-image.sh writes ds01.* labels (not aime.mlc.DS01_*)
- image-create Dockerfile LABELs use ds01.* namespace
- Docker wrapper maintains ownership fallback for pre-migration containers
- All consumer scripts use ds01.* as primary with aime.mlc.* fallback where ownership detection needed
- All Python files compile without errors
- All Bash files pass syntax check
- TODO comments mark all fallback code for future removal
</success_criteria>

<output>
After completion, create `.planning/phases/07-label-standards-migration/07-02-SUMMARY.md`
</output>
