---
phase: 03-access-control
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/admin/bare-metal-access
  - scripts/admin/nvidia-wrapper.sh
  - config/resource-limits.yaml
  - scripts/lib/error-messages.sh
autonomous: true

must_haves:
  truths:
    - "Non-exempt user running nvidia-smi gets helpful error directing them to container deploy"
    - "All nvidia-* commands (nvidia-smi, nvidia-settings, nvidia-debugdump, etc.) are wrapped"
    - "Admin can grant temporary bare metal access with auto-revocation via at command"
    - "Admin can grant permanent bare metal exemption via config"
    - "Exempt users (video group members) can run nvidia-* commands normally"
    - "resource-limits.yaml has bare_metal_access section with exempt_users and admin_group"
  artifacts:
    - path: "scripts/admin/nvidia-wrapper.sh"
      provides: "Wrapper template for all nvidia-* commands"
      contains: "video"
    - path: "scripts/admin/bare-metal-access"
      provides: "Admin CLI for grant/revoke/status of bare metal access"
      contains: "usermod"
    - path: "config/resource-limits.yaml"
      provides: "bare_metal_access configuration section"
      contains: "bare_metal_access"
  key_links:
    - from: "scripts/admin/nvidia-wrapper.sh"
      to: "/usr/local/bin/nvidia-smi"
      via: "deploy.sh copies wrapper to /usr/local/bin for each nvidia-* command"
      pattern: "REAL_CMD=.*/usr/bin/nvidia"
    - from: "scripts/admin/bare-metal-access"
      to: "config/resource-limits.yaml"
      via: "reads exempt_users list and admin_group"
      pattern: "bare_metal_access"
---

<objective>
Implement bare metal GPU access restriction via Linux video group management and nvidia-* command wrappers.

Purpose: Prevent users from bypassing container-based GPU management by directly accessing GPU devices on the host (ACCESS-01, ACCESS-02). This closes a major bypass path — without it, any user can run CUDA programs on bare metal, consuming GPU resources outside DS01's awareness.

Output: nvidia-* command wrappers with contextual error messages, admin CLI for temporary/permanent bare metal access grants, resource-limits.yaml configuration for exemptions.
</objective>

<execution_context>
@/home/datasciencelab/.claude/get-shit-done/workflows/execute-plan.md
@/home/datasciencelab/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-access-control/03-CONTEXT.md
@.planning/phases/03-access-control/03-RESEARCH.md
@scripts/docker/docker-wrapper.sh
@config/resource-limits.yaml
@scripts/lib/error-messages.sh
@scripts/lib/ds01_events.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create nvidia-* command wrapper and bare-metal-access admin CLI</name>
  <files>
    scripts/admin/nvidia-wrapper.sh
    scripts/admin/bare-metal-access
  </files>
  <action>
    **nvidia-wrapper.sh** — Single wrapper script deployed to /usr/local/bin under multiple names (nvidia-smi, nvidia-settings, nvidia-debugdump, nvidia-cuda-mps-control, nvidia-cuda-mps-server, nvidia-persistenced, nvidia-xconfig). The wrapper:

    1. Determines the real binary path: REAL_CMD="/usr/bin/$(basename "$0")"
    2. Gets CURRENT_USER=$(whoami)
    3. Checks if user is in video group: `groups "$CURRENT_USER" 2>/dev/null | grep -q '\bvideo\b'`
    4. If NOT in video group:
       - Source ds01_events.sh and log denial event (best-effort, rate-limited — see rate limiting below)
       - Display contextual error box (styled like docker-wrapper.sh boxes):
         ```
         Bare Metal GPU Access Restricted
         This server uses container-only GPU access by default.
         To use GPUs, create a container:
           container deploy my-project
         Check your access status:
           bare-metal-access status
         Need temporary access? Ask your administrator.
         Note: Access changes require a new SSH session to take effect.
         ```
       - Exit 1
    5. If in video group: `exec "$REAL_CMD" "$@"` — pass through transparently
    6. Rate limiting for denial logs: Use state file in /var/lib/ds01/rate-limits/. Max 10 denials per user per hour. First denial within window always logged at auth.warning level via logger. Source the rate limiting from a function within the script (inline, not a separate library — keep it simple).
    7. Use `set -euo pipefail` at top
    8. Admin (root or ds01-admin group) always passes through — check UID 0 or ds01-admin group membership before video group check

    **bare-metal-access** — Admin CLI (bash script) for managing temporary and permanent bare metal GPU access. Follows DS01 admin tool patterns (like ds01-users, ds01-logs).

    Subcommands:
    - `bare-metal-access grant <username> [duration]` — Grant temporary access. Default duration 24h. **Runtime check: verify `at` command is available and `atd` is active before proceeding — if not, print a clear error: "Error: 'at' command not available or atd not running. Install with: sudo apt install -y at && sudo systemctl enable --now atd" and exit 1.** Runs `sudo usermod -aG video <username>`. Schedules revocation via `at now + <duration>` (calls `gpasswd -d <user> video` + wall notification). Schedules warning notification 1h before expiry. Logs grant event. On success, print confirmation including: "Note: User must start a new SSH session for access to take effect."
    - `bare-metal-access revoke <username>` — Immediate revocation. Runs `sudo gpasswd -d <username> video`. Cancels pending at jobs for this user. Logs revoke event.
    - `bare-metal-access status [username]` — If username given, shows that user's status. If no username and run by non-root, shows own status. If run by admin with no args, shows all users with bare metal access (members of video group). Shows: username, permanent/temporary, expiry time (from at queue).
    - `bare-metal-access list` — Alias for `status` with no args (admin view).
    - `bare-metal-access --help` — Usage information.

    Requirements:
    - Requires sudo for grant/revoke operations
    - status subcommand works without sudo for own status, needs sudo for other users
    - Uses `at` command for scheduling — verify atd is running, warn if not
    - Uses `wall` for notifications on grant, warning before expiry, and on revocation
    - Integrates with ds01_events.sh for event logging (best-effort)
    - Checks resource-limits.yaml for permanently exempt users (added in Task 2)
    - Stores grant metadata in /var/lib/ds01/bare-metal-grants/ (one file per user with grant timestamp, duration, granter)
    - Source scripts/lib/init.sh for standard DS01 bash setup
    - Duration parsing: Xh (hours), Xd (days), Xm (minutes). Default 24h.
    - Permanent grants: `bare-metal-access grant <username> permanent` — adds to video group, no revocation scheduled, records as permanent in metadata

    Anti-patterns to AVOID:
    - Do NOT check video group AND config file for access — video group IS the enforcement mechanism. Config file is just for permanent exemptions that get synced to video group on deploy.
    - Do NOT use systemd timers for temporary grants — `at` command is simpler and purpose-built for one-time scheduled tasks.
  </action>
  <verify>
    - `bash -n scripts/admin/nvidia-wrapper.sh` exits 0 (syntax check)
    - `bash -n scripts/admin/bare-metal-access` exits 0 (syntax check)
    - nvidia-wrapper.sh contains rate limiting logic (grep for rate_limit or RATE_LIMIT)
    - bare-metal-access contains grant, revoke, status subcommands (grep for each)
    - bare-metal-access grant checks for `at` command availability (grep for `atd\|command -v at`)
    - bare-metal-access grant output includes SSH session re-login note (grep for "SSH session")
    - nvidia-wrapper denial message includes SSH session re-login note (grep for "SSH session")
    - Both scripts source ds01_events.sh for event logging
  </verify>
  <done>
    nvidia-wrapper.sh intercepts nvidia-* commands with video group check and contextual error. bare-metal-access provides grant/revoke/status for temporary and permanent access with scheduled revocation via at.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add bare_metal_access configuration and update error messages</name>
  <files>
    config/resource-limits.yaml
    scripts/lib/error-messages.sh
  </files>
  <action>
    **config/resource-limits.yaml** — Add a new top-level `bare_metal_access` section (after `monitoring` section, before any removed sections comment):

    ```yaml
    # === Bare metal GPU access control ===
    # Controls direct GPU access outside containers (Phase 3)
    # Enforcement: users not in Linux 'video' group cannot access /dev/nvidia* devices
    bare_metal_access:
      # Users with permanent bare metal GPU access (added to video group on deploy)
      # These users can run nvidia-smi, CUDA programs, etc. directly on the host
      # All other users must use containers for GPU access
      exempt_users:
        - datasciencelab          # Admin account - always has access
        - h.baker@hertie-school.lan  # Research Engineer - bare metal exemption per CONTEXT

      # Admin group whose members always have bare metal access
      # (in addition to being full DS01 admins with container visibility)
      admin_group: ds01-admin

      # Default duration for temporary grants (bare-metal-access grant <user>)
      default_grant_duration: 24h

      # State directory for grant metadata
      state_dir: /var/lib/ds01/bare-metal-grants
    ```

    Also add `access_control` section for the admin model (used by Plan 02):

    ```yaml
    # === Access control configuration ===
    # Controls container isolation and admin bypass (Phase 3)
    access_control:
      # Admin accounts: see all containers, manage any container, bare metal access
      # The admin group from groups/admin.members is always included
      admin_users:
        - datasciencelab

      # Admin group (members bypass container isolation)
      admin_group: ds01-admin

      # Wrapper behaviour
      wrapper:
        # Enforcement mode: full | monitoring | disabled
        # full: enforce all access controls
        # monitoring: log denials but allow operations (dry-run)
        # disabled: pass through completely (emergency bypass)
        enforcement_mode: full

        # Debug verbosity: 0 = off, 1 = interceptions only, 2 = all invocations
        debug_level: 0

        # Unknown Docker subcommands: fail-open (allow) or fail-closed (deny)
        unknown_commands: allow
    ```

    **scripts/lib/error-messages.sh** — Add a `show_bare_metal_restricted` function (in addition to existing `show_bare_metal_warning`). This is the function that nvidia-wrapper.sh calls — but since the wrapper should be self-contained, keep the wrapper's error inline and add this function for use by other scripts:

    ```bash
    # Show bare metal access restricted message (for nvidia-* wrapper denials)
    show_bare_metal_restricted() {
        echo ""
        echo -e "${RED}+------------------------------------------------------------+${NC}"
        echo -e "${RED}|${NC}  ${BOLD}Bare Metal GPU Access Restricted${NC}                         ${RED}|${NC}"
        echo -e "${RED}+------------------------------------------------------------+${NC}"
        echo ""
        echo "  This server uses container-only GPU access by default."
        echo ""
        echo -e "  ${BOLD}To use GPUs, create a container:${NC}"
        echo "    container deploy my-project"
        echo ""
        echo -e "  ${BOLD}Check your access status:${NC}"
        echo "    bare-metal-access status"
        echo ""
        echo "  Need temporary access? Contact your administrator."
        echo ""
        echo "  Note: Access changes require a new SSH session to take effect."
        echo ""
    }
    ```

    Export this function alongside existing exports.
  </action>
  <verify>
    - `python3 -c "import yaml; yaml.safe_load(open('config/resource-limits.yaml'))"` exits 0 (valid YAML)
    - grep for `bare_metal_access` in config/resource-limits.yaml returns matches
    - grep for `access_control` in config/resource-limits.yaml returns matches
    - grep for `show_bare_metal_restricted` in scripts/lib/error-messages.sh returns match
    - grep for `exempt_users` in config/resource-limits.yaml returns match
  </verify>
  <done>
    resource-limits.yaml has bare_metal_access section with exempt users list and access_control section with admin model config. error-messages.sh has bare metal restricted error function.
  </done>
</task>

</tasks>

<verification>
1. nvidia-wrapper.sh syntax is valid: `bash -n scripts/admin/nvidia-wrapper.sh`
2. bare-metal-access syntax is valid: `bash -n scripts/admin/bare-metal-access`
3. YAML is valid: `python3 -c "import yaml; yaml.safe_load(open('config/resource-limits.yaml'))"`
4. Wrapper checks video group membership (grep for `video` in nvidia-wrapper.sh)
5. Wrapper shows contextual error with `container deploy` suggestion
6. bare-metal-access has grant with duration, revoke, status, and permanent options
7. Rate limiting logic present in nvidia-wrapper.sh
8. Event logging integration in both scripts
</verification>

<success_criteria>
- nvidia-* wrapper script exists with video group enforcement and contextual error
- bare-metal-access admin CLI exists with grant/revoke/status subcommands
- resource-limits.yaml has bare_metal_access and access_control sections
- error-messages.sh has show_bare_metal_restricted function
- All scripts pass bash syntax check
- YAML passes validation
</success_criteria>

<output>
After completion, create `.planning/phases/03-access-control/03-01-SUMMARY.md`
</output>
