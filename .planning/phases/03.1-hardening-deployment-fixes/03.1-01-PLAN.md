---
phase: 03.1-hardening-deployment-fixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/system/deploy.sh
autonomous: true

must_haves:
  truths:
    - "deploy.sh enforces deterministic permissions on every run — scripts 755, config 644, state dirs per-policy, lib 755"
    - "deploy.sh self-bootstrap works in a single run (re-exec pattern, no 'run twice' requirement)"
    - "Non-admin user (h.baker) can run ds01-events, ds01-workloads, and other deployed commands"
    - "All profile.d scripts deployed to /etc/profile.d/ with correct permissions (0644)"
    - "Event logging writable by non-root users (events.jsonl group-writable)"
    - "State directories have correct permissions (bare-metal-grants 711, rate-limits 1777)"
  artifacts:
    - path: "scripts/system/deploy.sh"
      provides: "Deterministic permissions manifest, self-bootstrap, profile.d deployment"
      contains: "chmod 755"
  key_links:
    - from: "scripts/system/deploy.sh"
      to: "/etc/profile.d/ds01-*.sh"
      via: "copies all profile.d scripts with 644 permissions"
      pattern: "profile.d.*644"
    - from: "scripts/system/deploy.sh"
      to: "/var/log/ds01/events.jsonl"
      via: "sets group-writable permissions"
      pattern: "events.jsonl"
---

<objective>
Fix deploy.sh to be self-bootstrapping (single run), enforce a deterministic permissions manifest covering all file types, fix event log permissions, and deploy all profile.d scripts correctly.

Purpose: This is the root-cause fix for the majority of Phase 3.1 issues. The cross-phase UAT found that file permissions (700 scripts, 600 config, 700 state dirs) caused cascading failures for non-admin users. This plan makes deploy.sh the single source of truth for permissions enforcement.

Output: Updated deploy.sh with self-bootstrap re-exec pattern, comprehensive permissions manifest, profile.d deployment from both source directories, and event log permission fix.
</objective>

<execution_context>
@/home/datasciencelab/.claude/get-shit-done/workflows/execute-plan.md
@/home/datasciencelab/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03.1-hardening-deployment-fixes/03.1-CONTEXT.md
@.planning/phases/03.1-hardening-deployment-fixes/03.1-RESEARCH.md
@.planning/phases/cross-phase-audit/cross-phase-UAT.md
@scripts/system/deploy.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add self-bootstrap re-exec and comprehensive permissions manifest to deploy.sh</name>
  <files>scripts/system/deploy.sh</files>
  <action>
    **Self-bootstrap re-exec pattern:** Add immediately after the shebang and before any other logic (after the comment header, before INFRA_ROOT):

    ```bash
    # Self-bootstrap: if running as deployed copy, re-exec from source
    INFRA_ROOT="/opt/ds01-infra"
    SELF="$INFRA_ROOT/scripts/system/deploy.sh"
    if [ "$0" = "/usr/local/bin/deploy" ] || [ "$(basename "$0")" = "deploy" ] && [ "$0" != "$SELF" ]; then
        exec "$SELF" "$@"
    fi
    ```

    This solves the "run twice" bug: the deployed symlink at /usr/local/bin/deploy always re-execs from the source repo, ensuring the latest code runs.

    **Note:** Move the existing `INFRA_ROOT="/opt/ds01-infra"` line into or after this block (avoid duplicating it).

    **Expand the "Set Permissions" section** (currently lines 119-138) to be a comprehensive permissions manifest. Replace the existing section with:

    ```bash
    # ============================================================================
    # Deterministic Permissions Manifest
    # ============================================================================
    # Enforces correct permissions regardless of umask or git checkout state.
    # Research: 755 executables, 644 config, per-policy state dirs.

    echo -e "${DIM}Enforcing permissions...${NC}"

    # --- Executable scripts (755) ---
    chmod 755 "$USER_ATOMIC"/* 2>/dev/null
    chmod 755 "$USER_ORCHESTRATORS"/* 2>/dev/null
    chmod 755 "$USER_WIZARDS"/* 2>/dev/null
    chmod 755 "$USER_HELPERS"/* 2>/dev/null
    chmod 755 "$USER_DISPATCHERS"/* 2>/dev/null
    chmod 755 "$INFRA_ROOT"/scripts/lib/*.sh "$INFRA_ROOT"/scripts/lib/*.py 2>/dev/null
    chmod 755 "$INFRA_ROOT"/scripts/docker/*.sh "$INFRA_ROOT"/scripts/docker/*.py 2>/dev/null
    chmod 755 "$INFRA_ROOT"/scripts/admin/* 2>/dev/null
    chmod 755 "$INFRA_ROOT"/scripts/monitoring/*.sh "$INFRA_ROOT"/scripts/monitoring/*.py 2>/dev/null
    chmod 755 "$INFRA_ROOT"/scripts/maintenance/*.sh 2>/dev/null
    chmod 755 "$INFRA_ROOT"/scripts/system/*.sh 2>/dev/null
    chmod 755 "$INFRA_ROOT"/scripts/user/ds01-login-check 2>/dev/null

    # --- Configuration files (644 — world-readable, owner-writable) ---
    chmod 644 "$INFRA_ROOT"/config/*.yaml "$INFRA_ROOT"/config/*.yml 2>/dev/null
    chmod 644 "$INFRA_ROOT"/config/groups/*.members 2>/dev/null

    # --- Shared libraries (755 — world-readable+executable for dynamic linker) ---
    chmod 755 "$INFRA_ROOT"/lib/*.so 2>/dev/null

    # --- AIME ML Containers submodule ---
    chown -R datasciencelab:docker "$INFRA_ROOT"/aime-ml-containers/ 2>/dev/null
    chmod 750 "$INFRA_ROOT"/aime-ml-containers/ 2>/dev/null
    chmod 640 "$INFRA_ROOT"/aime-ml-containers/* 2>/dev/null

    # --- State directories ---
    # /var/lib/ds01/ — root state directory
    mkdir -p /var/lib/ds01
    chown root:docker /var/lib/ds01
    chmod 775 /var/lib/ds01

    # bare-metal-grants: users need to stat own grant file (711 = traverse without listing)
    mkdir -p /var/lib/ds01/bare-metal-grants
    chmod 711 /var/lib/ds01/bare-metal-grants

    # rate-limits: users write own denial state (1777 = world-writable with sticky)
    mkdir -p /var/lib/ds01/rate-limits
    chmod 1777 /var/lib/ds01/rate-limits

    # --- Log directory and event log ---
    mkdir -p /var/log/ds01
    chown root:docker /var/log/ds01
    chmod 775 /var/log/ds01

    # events.jsonl: must be group-writable so non-root users can log events
    if [ -f /var/log/ds01/events.jsonl ]; then
        chown root:docker /var/log/ds01/events.jsonl
        chmod 664 /var/log/ds01/events.jsonl
    else
        touch /var/log/ds01/events.jsonl
        chown root:docker /var/log/ds01/events.jsonl
        chmod 664 /var/log/ds01/events.jsonl
    fi
    ```

    **Remove the duplicate state directory creation** that currently exists in the "Deploy Access Control" section (lines 317-322) — it's now handled in the permissions manifest. Keep the access control section lean.

    **Remove the duplicate /var/lib/ds01 creation** from the systemd units section (lines 339-346) — also now in the permissions manifest.

    **Deploy ALL profile.d scripts** — Add a section after the access control block that deploys from BOTH profile.d source directories:

    ```bash
    # --- Deploy profile.d scripts (644 — sourced, not executed) ---
    echo -e "${DIM}Deploying profile.d scripts...${NC}"

    # From config/deploy/profile.d/ (primary source)
    for script in "$INFRA_ROOT"/config/deploy/profile.d/ds01-*.sh; do
        [ -f "$script" ] || continue
        cp "$script" /etc/profile.d/"$(basename "$script")"
        chmod 644 /etc/profile.d/"$(basename "$script")"
    done

    # From config/etc-mirrors/profile.d/ (additional scripts)
    for script in "$INFRA_ROOT"/config/etc-mirrors/profile.d/ds01-*.sh; do
        [ -f "$script" ] || continue
        name="$(basename "$script")"
        # Don't overwrite if already deployed from primary source
        if [ ! -f /etc/profile.d/"$name" ] || ! diff -q "$INFRA_ROOT/config/deploy/profile.d/$name" /etc/profile.d/"$name" &>/dev/null 2>&1; then
            cp "$script" /etc/profile.d/"$name"
            chmod 644 /etc/profile.d/"$name"
        fi
    done

    echo -e "  ${GREEN}✓${NC} Profile.d scripts deployed (644)"
    ```

    This replaces the individual profile.d deployment lines scattered throughout deploy.sh (the ds01-gpu-awareness.sh and ds01-motd.sh specific copies in the access control section). Remove those individual cp/chmod calls and let the loop handle them all.

    **Clean stale __pycache__:** Keep the existing cleanup (line 141-142) in its current position (after permissions, before deploy).
  </action>
  <verify>
    - `bash -n scripts/system/deploy.sh` exits 0 (syntax check)
    - grep for `exec.*SELF` in deploy.sh confirms re-exec pattern
    - grep for `chmod 755.*scripts` in deploy.sh confirms permissions manifest
    - grep for `chmod 644.*config` in deploy.sh confirms config permissions
    - grep for `chmod 711.*bare-metal-grants` in deploy.sh confirms state dir permissions
    - grep for `chmod 664.*events.jsonl` in deploy.sh confirms event log fix
    - grep for `chmod 755.*lib.*\.so` in deploy.sh confirms library permissions
    - grep for `profile.d` in deploy.sh confirms profile.d deployment loop
    - grep for `etc-mirrors` in deploy.sh confirms secondary source deployment
    - No duplicate state directory creation blocks remain
  </verify>
  <done>
    deploy.sh has: (1) self-bootstrap re-exec pattern at top, (2) comprehensive deterministic permissions manifest covering scripts/config/state/lib/logs, (3) unified profile.d deployment loop from both source directories with 644 permissions, (4) events.jsonl set to 664 root:docker. No duplicate state directory creation. Single run deploys everything correctly.
  </done>
</task>

</tasks>

<verification>
1. `bash -n scripts/system/deploy.sh` passes (syntax valid)
2. Self-bootstrap: deploy.sh starts with re-exec check for /usr/local/bin/deploy
3. Permissions manifest covers: scripts (755), config (644), groups/*.members (644), lib/*.so (755)
4. State dirs: bare-metal-grants (711), rate-limits (1777), /var/lib/ds01 (775 root:docker)
5. Event log: events.jsonl (664 root:docker)
6. Profile.d loop deploys from both config/deploy/profile.d/ and config/etc-mirrors/profile.d/
7. All profile.d scripts get 644 permissions
8. No duplicate state directory creation blocks
</verification>

<success_criteria>
- deploy.sh self-bootstrap pattern prevents the "run twice" bug
- deploy.sh enforces deterministic permissions on every run
- Non-admin users can execute all deployed commands (755)
- Non-admin users can read config and .members files (644)
- Non-admin users can write to events.jsonl (664 root:docker)
- State directories have correct access policies (711, 1777, 775)
- All profile.d scripts (from both source directories) deployed with 644
- GPU notice .so library readable by all users (755)
</success_criteria>

<output>
After completion, create `.planning/phases/03.1-hardening-deployment-fixes/03.1-01-SUMMARY.md`
</output>
