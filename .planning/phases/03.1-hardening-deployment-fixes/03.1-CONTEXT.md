# Phase 3.1: Access Control Completion & Hardening - Context

**Gathered:** 2026-02-01
**Status:** Ready for planning

<domain>
## Phase Boundary

Complete Phase 3 deployment, fix design-implementation drift discovered via system audit, fix systemic permissions and allocator bugs, and deliver a coherent access control system aligned with the three-layer design (02.1-DESIGN.md). Absorbs Phase 3 plan 03-03 (never executed) plus all cross-phase UAT audit fixes.

**Sequencing:** Wave 1 (permissions + allocator fixes) -> Wave 2 (bare metal deployment + design alignment) -> Wave 3 (end-to-end validation).

**Design source of truth:** `.planning/phases/02.1-gpu-access-control-research/02.1-DESIGN.md` — three-layer GPU access architecture.

</domain>

<decisions>
## Implementation Decisions

### Permissions model
- **Claude's discretion, informed by research** — researcher should investigate Linux deployment best practices for permission manifests
- User preference: standard Linux patterns, nothing exotic
- Key constraint: non-admin users (e.g., h.baker) must be able to run all deployed user-facing commands
- Permissions must be deterministic — deploy.sh enforces them every run, not left to umask

### Deploy.sh reliability
- **Claude's discretion, informed by research** — researcher should investigate self-updating script patterns, symlink vs copy trade-offs, Python dependency management on system Python
- Key bugs to fix: self-bootstrap problem (two runs needed), pip not available on system Python
- Must be idempotent (level determined by research/Claude)
- Symlink vs copy decision deferred to research findings

### Exception handling
- **Fail-open** for all GPU allocator/checker errors — log the failure, never block container launch due to infrastructure bugs
- Exception granularity: Claude's discretion per function (narrow where clear, broad+logged where uncertain)
- GPU notice library (.so) errors: fail silently (LD_PRELOAD must never prevent login)

### Docker wrapper isolation
- **Switch to enforcing mode immediately** (not monitoring) — DS01_ISOLATION_MODE=enforcing
- Validates in realistic production environment
- Fail-open for unowned containers remains (legacy workload safety net)

### Design-implementation alignment (audit findings)
The following drift was found between 02.1-DESIGN.md and the deployed system. All must be resolved:
- **Udev rules still deployed** — `/etc/udev/rules.d/99-ds01-nvidia.rules` sets 0660, contradicts design which rejected device permissions. Must be removed, device permissions reset to 0666 defaults
- **Video group exemption logic missing** — `ds01-gpu-awareness.sh` doesn't check `groups | grep -qw video`. Grants and exemptions don't actually enable bare-metal access because CUDA_VISIBLE_DEVICES="" still gets set
- **Video group not restricted** — ~25 users all in video group, making it meaningless for access control. Must be restricted to exempt users only
- **Profile.d permissions broken** — `ds01-home-enforce.sh` (0600) and `ds01-warnings.sh` (0600) won't execute during login. Must be 0644
- **ds01-docker-group.sh not deployed** — exists in repo at `config/etc-mirrors/profile.d/` but never copied to `/etc/profile.d/`
- **nvidia wrappers contradictory** — deploy.sh actively removes them, but 03-03 planned to deploy them. Decision: align with research (researcher should determine if wrappers add value given CUDA_VISIBLE_DEVICES approach)

### Bare metal deployment (completing 03-03 scope)
- Restrict video group — remove non-exempt users, sync from resource-limits.yaml
- Fix profile.d exemption logic — add video group check to ds01-gpu-awareness.sh
- Deploy GPU notice library (.so) with correct permissions for LD_PRELOAD
- Deploy updated MOTD mentioning container-only GPU policy
- Remove udev rules (align with design)
- nvidia wrapper decision deferred to research

### Validation strategy
- Test user: h.baker (non-admin, student group)
- Acceptance bar: all 17 Phase 3.1 success criteria pass + re-run cross-phase UAT (all 8 previously-found issues resolved)
- Automated test script where possible (in /testing), manual steps for anything requiring sudo
- User will run sudo commands manually when prompted

### Research emphasis
- **Research is the primary decision driver** for this phase
- Permissions model, deploy.sh patterns, exception handling best practices, nvidia wrapper value — all should be grounded in industry practice before implementation
- User explicitly defers to research findings over upfront decisions

</decisions>

<specifics>
## Specific Ideas

- The ad-hoc permission fix (scripts 755, config 644, lib 755) applied today works — bake this into deploy.sh permanently
- 03-03-PLAN.md exists with detailed must_haves — use as reference for bare metal deployment wave
- Three-layer GPU access architecture from 02.1-DESIGN.md is the source of truth
- Video group currently has everyone (~25 users) — the restriction is the key missing piece
- Docker wrapper isolation already works well — just switch to enforcing mode
- GPU allocator chain (state reader → availability checker → allocator) is coherent — only specific bugs need fixing (MIG-only checker, .members loading)
- DCGM exporter service is failed (since Jan 31 20:54) — not in scope but worth noting
- deploy.sh has two profile.d source directories (config/deploy/profile.d/ and config/etc-mirrors/profile.d/) — consolidation is deferred but researcher should note this for context

### System audit reference
Full audit results at: `.planning/phases/cross-phase-audit/cross-phase-UAT.md`

### What's currently deployed vs what should be
| Component | Current state | Target state |
|-----------|--------------|--------------|
| ds01-gpu-awareness.sh | Deployed, missing video group check | Deployed with full exemption logic |
| Udev rules (99-ds01-nvidia.rules) | Deployed (0660) | Removed entirely |
| Video group | ~25 users (everyone) | Exempt users only |
| nvidia-* wrappers | Not deployed (actively removed) | Research-determined |
| ds01-home-enforce.sh | Deployed, 0600 | Deployed, 0644 |
| ds01-warnings.sh | Deployed, 0600 | Deployed, 0644 |
| ds01-docker-group.sh | Not deployed | Deployed, 0644 |
| GPU notice .so | Built, in repo | Deployed with correct permissions |
| Docker wrapper mode | full (enforcing) | Confirmed enforcing |
| bare-metal-access CLI | Deployed | Verified working |
| Permissions manifest | None | Deterministic in deploy.sh |

</specifics>

<deferred>
## Deferred Ideas

- Login greeting/welcome message via profile.d — captured as todo, separate from MOTD
- Config directory consolidation (config/deploy/ + config/etc-mirrors/ SSOT) — captured as todo
- Wrapper group detection mismatch investigation — captured as todo
- Group management system design (beyond video group) — captured as todo

</deferred>

---

*Phase: 03.1-hardening-deployment-fixes*
*Context gathered: 2026-02-01*
