---
phase: 03.1-hardening-deployment-fixes
plan: 02
subsystem: gpu-allocation
tags: [gpu, allocation, fail-open, exception-handling, OWASP-A10]
requires: [03-01, 03-02]
provides: [hardened-gpu-allocator, fail-open-error-handling]
affects: [container-creation, gpu-availability-checking]
tech-stack:
  added: []
  patterns: [fail-open-exception-handling, observability-via-stderr]
key-files:
  created: []
  modified:
    - scripts/docker/gpu-availability-checker.py
    - scripts/docker/gpu_allocator_v2.py
key-decisions:
  - title: "Fail-open pattern for GPU allocation chain"
    rationale: "Per OWASP 2025 A10 guidance, infrastructure errors must never block container creation. GPU allocator returns safe defaults/structured errors instead of raising exceptions."
    alternatives: "Fail-closed (reject on error) would block legitimate workloads during infrastructure issues"
    chosen: "Fail-open with stderr logging"
  - title: "Replace silent exception swallowing with stderr logging"
    rationale: "Silent 'except Exception: pass' blocks hide infrastructure problems. Logging to stderr preserves fail-open while enabling post-mortem debugging."
    alternatives: "Keep silent swallowing (loses observability), raise exceptions (breaks fail-open)"
    chosen: "Log to stderr, continue execution"
duration: 2min
completed: 2026-02-01
---

# Phase 3.1 Plan 02: GPU Allocator Hardening Summary

Fail-open exception handling for GPU allocation pipeline with full GPU detection and .members file loading verified.

## Performance

- **Duration:** 2 minutes
- **Started:** 2026-02-01 14:17 UTC
- **Completed:** 2026-02-01 14:20 UTC
- **Tasks:** 2/2 completed
- **Files modified:** 2

## Accomplishments

### Core Deliverables

1. **GPU Availability Checker Hardening**
   - Added fail-open exception handling to all public methods
   - Replaced silent `except Exception: pass` with stderr logging
   - `get_available_gpus()` returns `{}` on error (fail-open)
   - `suggest_gpu_for_user()` returns `{success: False, error}` on exception
   - `get_allocation_summary()` returns safe defaults on error
   - Verified full GPU detection alongside MIG instances (lines 161, 178)

2. **GPU Allocator Hardening**
   - Added `SAFE_DEFAULTS` class variable (`max_mig_instances=1, allow_full_gpu=False, priority=10`)
   - `_load_config()` catches `yaml.YAMLError` and returns `{}` on error
   - `_get_user_limits()` returns `SAFE_DEFAULTS` when config is empty
   - `allocate_gpu()` catches broad Exception, returns `(None, INTERNAL_ERROR)`
   - `allocate_external()` catches broad Exception, returns `(None, INTERNAL_ERROR)`
   - Lock management preserved (try/except before finally)
   - Verified .members file loading in `_load_config()` (lines 113-128)

### Bug Fixes Verified

1. **Full GPU Detection (from cross-phase UAT)**
   - Confirmed `get_available_gpus()` queries both `_get_all_mig_instances()` AND `_get_physical_gpus()`
   - Full GPUs (GPUs with no MIG partitions) now detected when MIG is disabled
   - Fixes bug where availability checker only returned MIG instances

2. **.members File Loading (from cross-phase UAT)**
   - Confirmed `_load_config()` loads group membership from `config/groups/{group}.members`
   - Merges external .members with inline members from YAML
   - Fixes bug where group membership was incomplete

## Task Commits

| Task | Description | Commit |
|------|-------------|--------|
| 1 | Verify and harden GPU availability checker | a40c03c |
| 2 | Verify and harden GPU allocator | baa2504 |

## Files Created/Modified

### Modified

**scripts/docker/gpu-availability-checker.py**
- Added fail-open exception handling to `get_available_gpus()`, `suggest_gpu_for_user()`, `get_allocation_summary()`
- Replaced silent exception swallowing in `_get_all_mig_instances()` and `_get_physical_gpus()` with stderr logging
- All public methods now return safe defaults on unexpected errors

**scripts/docker/gpu_allocator_v2.py**
- Added `SAFE_DEFAULTS` class variable for config load failures
- Enhanced `_load_config()` with yaml.YAMLError handling
- Updated `_get_user_limits()` to return `SAFE_DEFAULTS` when config empty
- Added fail-open exception handling to `allocate_gpu()` and `allocate_external()`
- All error paths log to stderr for observability

## Decisions Made

### 1. Fail-Open Pattern for GPU Allocation Chain

**Decision:** Infrastructure errors return safe defaults/structured errors instead of raising exceptions.

**Rationale:** Per OWASP 2025 A10 guidance, GPU infrastructure errors must NEVER block container creation. A failed GPU query should not prevent users from launching CPU-only containers. The allocator must degrade gracefully.

**Alternatives Considered:**
- **Fail-closed (reject on error):** Would block legitimate workloads during transient infrastructure issues (nvidia-smi timeout, Docker API hiccup)
- **Silent failure:** Would hide problems but lose observability for debugging

**Impact:**
- Container creation never crashes due to GPU allocation errors
- Users see structured error messages instead of stack traces
- Admins can debug via stderr logs without affecting user operations

### 2. Replace Silent Exception Swallowing with Stderr Logging

**Decision:** All `except Exception: pass` blocks now log to stderr before continuing.

**Rationale:** Silent exception swallowing hides infrastructure problems. During the cross-phase UAT, silent failures in MIG instance parsing masked the full GPU detection bug. Logging to stderr preserves fail-open behavior while enabling post-mortem debugging.

**Alternatives Considered:**
- **Keep silent swallowing:** Loses observability, makes debugging impossible
- **Raise exceptions:** Breaks fail-open pattern, blocks container creation

**Impact:**
- Parsing errors for MIG instances and physical GPUs now visible in logs
- Administrators can diagnose nvidia-smi issues without blocking users
- System logs capture infrastructure degradation patterns

## Deviations from Plan

None — plan executed exactly as written.

## Issues Encountered

None. Both existing bug fixes (full GPU detection, .members loading) were present in the uncommitted working tree as expected.

## Next Phase Readiness

**Phase 3.1 Plan 03 (Deploy.sh Self-Bootstrap Fix):** Ready. No blockers.

**Phase 3.1 Plan 04 (Complete Phase 3 Deployment):** Ready. GPU allocator hardening complete.

**Dependencies:**
- GPU allocator now safe for production deployment
- Full GPU detection tested in cross-phase UAT (4x A100 visible when MIG disabled)
- .members file loading enables correct group resolution

**Testing Recommendations:**
1. Simulate nvidia-smi failure → verify fail-open returns empty GPU list
2. Simulate YAML parse error → verify SAFE_DEFAULTS applied
3. Test full GPU allocation on non-MIG system → verify detection works
4. Test .members file loading → verify group membership merged correctly
