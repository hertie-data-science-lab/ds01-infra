---
phase: 03.1-hardening-deployment-fixes
plan: 01
subsystem: deployment
tags: [deploy, permissions, self-bootstrap, profile.d, event-logging]

requires:
  - 03-01  # Docker wrapper foundation
  - 03-02  # Container isolation baseline

provides:
  - deterministic-permissions-manifest
  - self-bootstrapping-deploy
  - unified-profile.d-deployment
  - non-admin-user-access

affects:
  - 03.1-02  # GPU allocator fixes (depends on .members 644)
  - 03.1-03  # Event logging (depends on events.jsonl 664)
  - 03.1-04  # Complete Phase 3 deployment

tech-stack:
  added: []
  patterns:
    - self-bootstrap-re-exec
    - deterministic-permissions-manifest
    - dual-source-profile.d-deployment

key-files:
  created: []
  modified:
    - scripts/system/deploy.sh

key-decisions:
  - decision: Self-bootstrap re-exec pattern at top of deploy.sh
    rationale: Deployed symlink at /usr/local/bin/deploy always re-execs from source repo, eliminating "run twice" bug
    impact: Single deploy run always uses latest code

  - decision: Comprehensive permissions manifest covering all file types
    rationale: Git checkout and umask can reset permissions; explicit enforcement ensures deterministic state
    impact: Scripts 755, config 644, .members 644, .so 755, state dirs per-policy

  - decision: Unified profile.d deployment loop from both source directories
    rationale: Centralizes deployment logic, ensures all profile.d scripts deployed with correct permissions
    impact: Both config/deploy/profile.d/ and config/etc-mirrors/profile.d/ scripts deployed

  - decision: events.jsonl 664 root:docker with group-writable
    rationale: Non-root users in docker group need to log events
    impact: Event logging now works for all users

duration: 1.7min
completed: 2026-02-01
---

# Phase 3.1 Plan 01: Deploy Self-Bootstrap & Permissions Manifest Summary

**Self-bootstrapping deploy.sh with comprehensive permissions enforcement — eliminates "run twice" bug and enables non-admin user access**

## Performance

- **Duration:** 1.7 minutes
- **Started:** 2026-02-01 14:16 UTC
- **Completed:** 2026-02-01 14:18 UTC
- **Tasks:** 1/1
- **Files modified:** 1

## Accomplishments

✅ **Self-bootstrap re-exec pattern** — Deployed copy at /usr/local/bin/deploy always re-execs from source, eliminating the "run twice after changes" bug

✅ **Comprehensive permissions manifest** — Deterministic enforcement of permissions for all file types regardless of umask or git checkout state:
- Scripts: 755 (executable by all users)
- Config YAML files: 644 (readable by all users)
- Group membership files (.members): 644 (readable by all users)
- Shared libraries (.so): 755 (readable+executable for dynamic linker)

✅ **State directory permissions** — Per-policy access control:
- /var/lib/ds01: 775 root:docker (group-writable)
- bare-metal-grants: 711 (users can stat own grant file, can't list directory)
- rate-limits: 1777 (world-writable with sticky bit, users write own denial state)

✅ **Event log permissions** — events.jsonl set to 664 root:docker (group-writable) so non-root users can log events

✅ **Unified profile.d deployment** — Single loop deploys from both config/deploy/profile.d/ and config/etc-mirrors/profile.d/ with 644 permissions

✅ **Removed duplicates** — Eliminated duplicate state directory creation blocks that were scattered throughout deploy.sh

## Task Commits

| Task | Description | Commit |
|------|-------------|--------|
| 1 | Add self-bootstrap re-exec and comprehensive permissions manifest to deploy.sh | 1c3a472 |

## Files Created

None — modified existing deployment infrastructure.

## Files Modified

| File | Changes |
|------|---------|
| scripts/system/deploy.sh | Added self-bootstrap re-exec pattern, expanded permissions manifest, unified profile.d deployment, removed duplicates |

## Decisions Made

### Self-Bootstrap Re-Exec Pattern

**Context:** deploy.sh was deployed as a symlink, but when run as /usr/local/bin/deploy it would deploy an old copy of itself, requiring two runs after changes.

**Decision:** Add re-exec check at top of script — if running as deployed copy, re-exec from source repo immediately.

**Implementation:**
```bash
# Self-bootstrap: if running as deployed copy, re-exec from source
INFRA_ROOT="/opt/ds01-infra"
SELF="$INFRA_ROOT/scripts/system/deploy.sh"
if [ "$0" = "/usr/local/bin/deploy" ] || { [ "$(basename "$0")" = "deploy" ] && [ "$0" != "$SELF" ]; }; then
    exec "$SELF" "$@"
fi
```

**Impact:** Single deploy run always uses latest code. Eliminates confusion and reduces deployment errors.

### Comprehensive Permissions Manifest

**Context:** Cross-phase UAT revealed that file permissions (700 scripts, 600 config, 700 state dirs) blocked all non-admin users. Git checkout and umask can reset permissions.

**Decision:** Create deterministic permissions manifest covering all file types with explicit chmod/chown on every deploy run.

**Categories:**
- Executable scripts: 755 (all users can execute)
- Configuration: 644 (all users can read)
- Group membership files: 644 (GPU allocator needs to read .members)
- Shared libraries: 755 (dynamic linker needs execute permission)
- State directories: per-policy (711, 1777, 775)
- Event log: 664 root:docker (group-writable)

**Impact:** Non-admin users can now run all deployed commands, read config, and log events. Deterministic state regardless of git checkout or umask.

### Unified Profile.d Deployment

**Context:** Individual profile.d scripts (ds01-gpu-awareness.sh, ds01-motd.sh) were deployed with separate cp/chmod commands. This was fragile and incomplete.

**Decision:** Replace individual deployments with unified loop that deploys from both config/deploy/profile.d/ (primary) and config/etc-mirrors/profile.d/ (additional).

**Implementation:** Loop through both directories, deploy all ds01-*.sh scripts with 644 permissions. Primary source takes precedence if script exists in both directories.

**Impact:** All profile.d scripts deployed consistently. Easy to add new scripts without modifying deploy.sh.

## Deviations from Plan

None — plan executed exactly as written.

## Issues Encountered

None — straightforward implementation of self-bootstrap pattern and permissions manifest.

## Next Phase Readiness

**Enables:**
- ✅ Phase 3.1 Plan 02: GPU allocator can now read .members files (644 permissions)
- ✅ Phase 3.1 Plan 03: Non-admin users can write to events.jsonl (664 permissions)
- ✅ Phase 3.1 Plan 04: Complete Phase 3 deployment with deterministic permissions

**Blockers removed:**
- ❌ "run twice" bug — eliminated by self-bootstrap re-exec
- ❌ Non-admin user command access — scripts now 755
- ❌ GPU allocator .members loading — .members now 644
- ❌ Event logging for non-root users — events.jsonl now 664

**Testing needed:**
- [ ] Verify non-admin user (h.baker) can run ds01-events, ds01-workloads
- [ ] Verify GPU allocator can read .members files
- [ ] Verify event logging works for non-root users
- [ ] Verify profile.d scripts deployed from both source directories
- [ ] Verify single deploy run deploys latest code (no "run twice")

**Ready for:** Phase 3.1 Plan 02 (GPU allocator fixes)
