---
phase: 03.1-hardening-deployment-fixes
plan: 04
type: execute
wave: 3
depends_on: ["03.1-01", "03.1-02", "03.1-03"]
files_modified:
  - testing/test-phase-3.1-validation.sh
autonomous: false

must_haves:
  truths:
    - "Exempt users bypass CUDA_VISIBLE_DEVICES block (grant dir traversable, config readable)"
    - "container deploy works end-to-end for a regular user (h.baker)"
    - "Event logging writable by non-root users"
    - "Cross-phase UAT re-run: all 8 previously-found issues resolved"
    - "deploy.sh deploys mlc-create as symlink with Python dependencies accessible"
  artifacts:
    - path: "testing/test-phase-3.1-validation.sh"
      provides: "Automated validation script for Phase 3.1 success criteria"
      contains: "phase_3_1"
  key_links:
    - from: "testing/test-phase-3.1-validation.sh"
      to: "/usr/local/bin/"
      via: "verifies deployed commands are executable by non-admin users"
      pattern: "test.*permission"
---

<objective>
Create and run a comprehensive validation script that verifies all 17 Phase 3.1 success criteria and re-runs all 8 cross-phase UAT checks. Deploy with sudo, then validate.

Purpose: Final verification that all plans in this phase achieved their goals. The validation script automates checks that can run without user interaction, and the checkpoint pauses for manual verification of items requiring sudo or multi-user testing.

Output: Validation script in testing/, deployment verified, checkpoint for user confirmation.
</objective>

<execution_context>
@/home/datasciencelab/.claude/get-shit-done/workflows/execute-plan.md
@/home/datasciencelab/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03.1-hardening-deployment-fixes/03.1-CONTEXT.md
@.planning/phases/03.1-hardening-deployment-fixes/03.1-01-SUMMARY.md
@.planning/phases/03.1-hardening-deployment-fixes/03.1-02-SUMMARY.md
@.planning/phases/03.1-hardening-deployment-fixes/03.1-03-SUMMARY.md
@.planning/phases/cross-phase-audit/cross-phase-UAT.md
@scripts/system/deploy.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create validation script and run pre-deploy checks</name>
  <files>testing/test-phase-3.1-validation.sh</files>
  <action>
    Create `testing/test-phase-3.1-validation.sh` — an automated validation script that checks all Phase 3.1 success criteria that can be verified from source code and file state.

    The script should:

    **Pre-deploy checks (can run without sudo):**

    1. **SC 1 — Permissions manifest exists in deploy.sh:**
       ```bash
       grep -q "chmod 755.*scripts" scripts/system/deploy.sh && pass "SC1: Permissions manifest"
       ```

    2. **SC 3 — Self-bootstrap pattern:**
       ```bash
       grep -q 'exec.*SELF' scripts/system/deploy.sh && pass "SC3: Self-bootstrap re-exec"
       ```

    3. **SC 5 — Profile.d deployment loop:**
       ```bash
       grep -q 'profile.d.*644' scripts/system/deploy.sh && pass "SC5: Profile.d with 644"
       ```

    4. **SC 6 — GPU availability checker handles full GPUs:**
       ```bash
       grep -q '_get_physical_gpus' scripts/docker/gpu-availability-checker.py && pass "SC6: Full GPU detection"
       ```

    5. **SC 7 — GPU allocator loads .members:**
       ```bash
       grep -q 'member_file\|groups_dir' scripts/docker/gpu_allocator_v2.py && pass "SC7: .members loading"
       ```

    6. **SC 8 — Udev rule removal in deploy.sh:**
       ```bash
       grep -q '99-ds01-nvidia.rules' scripts/system/deploy.sh && pass "SC8: Udev cleanup"
       ! grep -q 'MODE.*0660' scripts/system/deploy.sh && pass "SC8b: No device perm manipulation"
       ```

    7. **SC 9 — Video group restriction logic:**
       ```bash
       grep -q 'gpasswd -d' scripts/system/deploy.sh && pass "SC9: Video group restriction"
       ```

    8. **SC 10 — Video group exemption in GPU awareness:**
       ```bash
       grep -q 'groups.*video' config/deploy/profile.d/ds01-gpu-awareness.sh && pass "SC10: Video group exemption"
       ```

    9. **SC 11 — GPU notice library exists and is readable:**
       ```bash
       [ -f lib/libds01_gpu_notice.so ] && pass "SC11: GPU notice .so exists"
       ```

    10. **SC 12 — MOTD mentions container-only:**
        ```bash
        grep -q 'container-only' config/deploy/profile.d/ds01-motd.sh && pass "SC12: MOTD"
        ```

    11. **SC 13 — Docker wrapper enforcing mode default:**
        ```bash
        grep -q 'DS01_ISOLATION_MODE:-full' scripts/docker/docker-wrapper.sh && pass "SC13: Enforcing mode"
        ```

    12. **Python syntax checks:**
        ```bash
        python3 -c "import ast; ast.parse(open('scripts/docker/gpu-availability-checker.py').read())" && pass "Syntax: checker"
        python3 -c "import ast; ast.parse(open('scripts/docker/gpu_allocator_v2.py').read())" && pass "Syntax: allocator"
        ```

    13. **Bash syntax checks:**
        ```bash
        bash -n scripts/system/deploy.sh && pass "Syntax: deploy.sh"
        bash -n config/deploy/profile.d/ds01-gpu-awareness.sh && pass "Syntax: gpu-awareness"
        ```

    **Post-deploy checks (require sudo deploy to have been run):**

    14. **SC 2 — Non-admin can run commands:**
        ```bash
        # Check permissions on deployed symlink targets
        [ -x "$(readlink -f /usr/local/bin/ds01-events 2>/dev/null)" ] && pass "SC2: ds01-events executable"
        [ -x "$(readlink -f /usr/local/bin/ds01-workloads 2>/dev/null)" ] && pass "SC2: ds01-workloads executable"
        ```

    15. **SC 4 — mlc-create is symlink:**
        ```bash
        [ -L /usr/local/bin/mlc-create ] && pass "SC4: mlc-create is symlink"
        ```

    16. **SC 14 — Grant dir traversable:**
        ```bash
        [ -d /var/lib/ds01/bare-metal-grants ] && \
        stat -c '%a' /var/lib/ds01/bare-metal-grants | grep -q '711' && pass "SC14: Grant dir 711"
        ```

    17. **SC 16 — events.jsonl group-writable:**
        ```bash
        stat -c '%a %G' /var/log/ds01/events.jsonl 2>/dev/null | grep -q '664.*docker' && pass "SC16: events.jsonl 664 docker"
        ```

    18. **UAT re-run checks** (the 8 issues from cross-phase UAT):
        ```bash
        # UAT-1: events.jsonl writable (same as SC16)
        # UAT-2: ds01-events executable (same as SC2)
        # UAT-3: DCGM exporter — out of scope, skip
        # UAT-4: Exemption paths — grant dir 711, config 644
        stat -c '%a' /opt/ds01-infra/config/resource-limits.yaml 2>/dev/null | grep -q '644' && pass "UAT4: config readable"
        # UAT-5: Same as SC14 (grant dir)
        # UAT-6: Container isolation — manual test needed (checkpoint)
        # UAT-7: Isolation mode — same as SC13
        # UAT-8: Profile.d permissions
        for f in /etc/profile.d/ds01-*.sh; do
            perms=$(stat -c '%a' "$f" 2>/dev/null)
            [ "$perms" = "644" ] || fail "UAT8: $f has $perms (expected 644)"
        done
        pass "UAT8: All profile.d scripts 644"
        ```

    The script should output a summary: `X/Y checks passed`.

    Use a simple pass/fail counter pattern:
    ```bash
    #!/bin/bash
    # Phase 3.1 Validation Script
    set -euo pipefail
    PASS=0; FAIL=0; SKIP=0
    pass() { echo -e "  \033[0;32m✓\033[0m $1"; ((PASS++)); }
    fail() { echo -e "  \033[0;31m✗\033[0m $1"; ((FAIL++)); }
    skip() { echo -e "  \033[0;33m-\033[0m $1 (skipped)"; ((SKIP++)); }
    ```

    **Run the pre-deploy checks immediately** after creating the script.
  </action>
  <verify>
    - `bash -n testing/test-phase-3.1-validation.sh` exits 0
    - Running the script shows pre-deploy checks passing
    - Script covers all 17 success criteria (grep for SC1 through SC17 or equivalent)
  </verify>
  <done>
    Validation script created and pre-deploy source code checks pass. Post-deploy checks ready to run after `sudo deploy`.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete Phase 3.1 implementation:
    1. **Plan 01:** deploy.sh with self-bootstrap, deterministic permissions manifest, profile.d deployment, event log fix
    2. **Plan 02:** GPU allocator hardened with fail-open exceptions, .members loading verified, full GPU detection verified
    3. **Plan 03:** Udev rules removed, video group restricted to exempt users, GPU awareness with video group check, nvidia wrappers deployed, enforcing mode confirmed
    4. **Plan 04:** Validation script covering all 17 success criteria

    **Architecture (three-layer GPU access control):**
    - Layer 1: CUDA_VISIBLE_DEVICES="" (host deterrent via ds01-gpu-awareness.sh)
    - Layer 2: Docker --gpus device=UUID (container security boundary via wrapper)
    - Layer 3: Video group + grant files (opt-in bare-metal exemption)
  </what-built>
  <how-to-verify>
    **Step 1: Review changes and deploy:**
    ```bash
    # Review the diff
    git diff --stat

    # Deploy (single run should apply everything)
    sudo deploy --verbose
    ```

    **Step 2: Run the validation script:**
    ```bash
    bash testing/test-phase-3.1-validation.sh
    # All checks should pass
    ```

    **Step 3: Manual verification (requires non-admin user):**
    ```bash
    # As h.baker (or any non-admin user):
    su - h.baker

    # Check commands are executable
    which ds01-events ds01-workloads container-list

    # Check CUDA_VISIBLE_DEVICES (should be "" for non-exempt, unset for exempt)
    echo "CUDA_VISIBLE_DEVICES='$CUDA_VISIBLE_DEVICES'"

    # Check nvidia-smi wrapper (should show helpful message)
    nvidia-smi

    # Check docker ps (should show only own containers)
    docker ps

    # Try container deploy (if h.baker has GPU quota)
    # container deploy test-validation
    ```

    **Step 4: Verify device permissions:**
    ```bash
    ls -la /dev/nvidia*
    # Should show crw-rw-rw- (0666 defaults)
    ```

    **Step 5: Verify udev rules removed:**
    ```bash
    ls /etc/udev/rules.d/99-ds01-nvidia.rules 2>/dev/null
    # Should not exist
    ```

    **Step 6: Verify video group restricted:**
    ```bash
    getent group video
    # Should only show exempt users, not all 25 docker users
    ```

    **Step 7: Verify profile.d permissions:**
    ```bash
    ls -la /etc/profile.d/ds01-*.sh
    # All should be -rw-r--r-- (644)
    ```
  </how-to-verify>
  <resume-signal>Type "approved" if all checks pass, or describe any issues found.</resume-signal>
</task>

</tasks>

<verification>
1. Validation script passes all pre-deploy checks
2. After `sudo deploy`, validation script passes all post-deploy checks
3. Non-admin user can run deployed commands
4. Exempt user bypasses CUDA_VISIBLE_DEVICES block
5. Non-exempt user gets CUDA_VISIBLE_DEVICES=""
6. Device permissions at 0666 defaults
7. Udev rules removed
8. Video group restricted
9. Profile.d scripts all 644
10. events.jsonl group-writable
11. Docker wrapper in enforcing mode
</verification>

<success_criteria>
- All 17 Phase 3.1 success criteria verified (automated + manual)
- All 8 cross-phase UAT issues resolved
- Non-admin user can run DS01 commands end-to-end
- Three-layer GPU access control architecture fully deployed
- Human has verified implementation via checkpoint
</success_criteria>

<output>
After completion, create `.planning/phases/03.1-hardening-deployment-fixes/03.1-04-SUMMARY.md`
</output>
