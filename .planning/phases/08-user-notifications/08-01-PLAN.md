---
phase: 08-user-notifications
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/lib/ds01_notify.sh
autonomous: true

must_haves:
  truths:
    - "All notification scripts can source a single library for message formatting and delivery"
    - "Notifications are delivered to user TTY devices with fallback to container file"
    - "Every notification includes a full quota summary (GPU, memory, containers)"
    - "Messages use a unified bordered-box template with severity header"
  artifacts:
    - path: "scripts/lib/ds01_notify.sh"
      provides: "Shared notification library with delivery, formatting, and quota summary"
      contains: "ds01_notify"
  key_links:
    - from: "scripts/lib/ds01_notify.sh"
      to: "scripts/docker/get_resource_limits.py"
      via: "ds01_quota_summary calls get_resource_limits.py for limits"
      pattern: "get_resource_limits.py"
    - from: "scripts/lib/ds01_notify.sh"
      to: "/dev/pts/*"
      via: "ds01_notify writes to user TTY devices via who"
      pattern: "who.*awk"
---

<objective>
Create the shared notification library `scripts/lib/ds01_notify.sh` that centralises all notification primitives for Phase 8.

Purpose: This library is the foundation for all other Phase 8 work. It extracts the duplicated `notify_user()` from check-idle-containers.sh and enforce-max-runtime.sh into a single source of truth, and adds the unified message template with quota summary, container-file fallback, and severity headers per locked decisions.

Output: `scripts/lib/ds01_notify.sh` — sourced by all lifecycle and quota scripts.
</objective>

<execution_context>
@/home/datasciencelab/.claude/get-shit-done/workflows/execute-plan.md
@/home/datasciencelab/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-user-notifications/08-RESEARCH.md
@scripts/lib/init.sh
@scripts/monitoring/check-idle-containers.sh
@scripts/maintenance/enforce-max-runtime.sh
@scripts/docker/get_resource_limits.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ds01_notify.sh shared notification library</name>
  <files>scripts/lib/ds01_notify.sh</files>
  <action>
Create `scripts/lib/ds01_notify.sh` with the following functions. Source `init.sh` at the top for standard paths and colours.

**ds01_notify()**
- Signature: `ds01_notify <username> <container_name> <message>`
- Extract verbatim from check-idle-containers.sh lines 348-359 (the canonical `notify_user()` pattern)
- Primary: write to each TTY the user has open via `who | awk` + echo to `/dev/$tty`
- If `delivered=false` AND `container_name` is non-empty, call `ds01_notify_container`
- If `delivered=false` AND `container_name` is empty, log "no active terminals" (best-effort, no error)
- Use `2>/dev/null` on all TTY writes (existing pattern)

**ds01_notify_container()**
- Signature: `ds01_notify_container <container_name> <message>`
- Write alert as plain text to `/workspace/.ds01-alerts` inside the container via `docker exec`
- Format: separator line with timestamp, then the message, then blank line
- Always `2>/dev/null || true` on docker exec (container may be stopping)

**ds01_format_message()**
- Signature: `ds01_format_message <severity> <title> <body> <username>`
- Severity labels: WARNING (approaching limit), ALERT (at limit/blocked), STOPPED (container stopped), NOTICE (informational/exempt)
- Output a bordered box matching existing style (━━━ top/bottom borders)
- Format:
  ```
  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  [SEVERITY] TITLE

  BODY

  Your resource quotas:
  QUOTA_SUMMARY_OUTPUT
  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  ```
- Call `ds01_quota_summary "$username"` for the quota section
- If quota summary fails or is empty, omit the quota section (don't show empty block)

**ds01_quota_summary()**
- Signature: `ds01_quota_summary <username>`
- Call `get_resource_limits.py` for max-gpus, max-containers, aggregate (memory)
- Get current GPU count from `gpu-state-reader.py user <username>` or docker ps with GPU filter
- Get current container count from `docker ps --filter "label=ds01.user=$username"`
- Get current memory from cgroup: `/sys/fs/cgroup/ds01.slice/ds01-{group}-{sanitized_user}.slice/memory.current`
  - Use `username_utils.py` for sanitisation, `get_resource_limits.py --group` for group
- Format as multi-line: `  GPUs: X/Y | Memory: X/Y GB | Containers: X/Y`
- Handle "unlimited" gracefully (show "unlimited" not a ratio)
- Cache results in a global variable `_DS01_QUOTA_CACHE_<username>` to avoid repeated Python calls within same script run
- All Python calls use `2>/dev/null || echo ""` — never fail loudly

The library should:
- Be idempotent when sourced multiple times (guard with `[ -n "${_DS01_NOTIFY_LOADED:-}" ] && return 0`)
- Source `init.sh` for `$DS01_ROOT`, `$DS01_SCRIPTS`, colour codes
- Export no variables (functions only, no namespace pollution)
- Log via stderr for diagnostic messages (not stdout, which is for message content)
  </action>
  <verify>
- `bash -n scripts/lib/ds01_notify.sh` — syntax check passes
- `source scripts/lib/ds01_notify.sh && type ds01_notify && type ds01_notify_container && type ds01_format_message && type ds01_quota_summary` — all four functions defined
- Library can be sourced twice without error
  </verify>
  <done>
scripts/lib/ds01_notify.sh exists with ds01_notify(), ds01_notify_container(), ds01_format_message(), and ds01_quota_summary() functions. Syntax-valid bash. Sources init.sh. Includes idempotent guard.
  </done>
</task>

</tasks>

<verification>
- `bash -n scripts/lib/ds01_notify.sh` exits 0
- All four public functions (ds01_notify, ds01_notify_container, ds01_format_message, ds01_quota_summary) are defined after sourcing
- Library sources cleanly alongside init.sh without variable conflicts
</verification>

<success_criteria>
Shared notification library exists and provides unified notification primitives that check-idle-containers.sh, enforce-max-runtime.sh, and resource-alert-checker.sh can source in subsequent plans.
</success_criteria>

<output>
After completion, create `.planning/phases/08-user-notifications/08-01-SUMMARY.md`
</output>
