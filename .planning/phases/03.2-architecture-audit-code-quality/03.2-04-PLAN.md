---
phase: 03.2-architecture-audit-code-quality
plan: 04
type: execute
wave: 3
depends_on: ["03.2-02", "03.2-03"]
files_modified:
  - .planning/STATE.md
  - .planning/ROADMAP.md
  - config/CLAUDE.md
  - scripts/docker/CLAUDE.md
  - scripts/lib/CLAUDE.md
  - scripts/monitoring/CLAUDE.md
  - scripts/system/CLAUDE.md
  - scripts/admin/CLAUDE.md
autonomous: true

must_haves:
  truths:
    - "Architecture documentation (CLAUDE.md files) reflects post-audit, post-refactoring state of the codebase"
    - "STATE.md accurately reflects Phase 3.2 completion and current project position"
    - "ROADMAP.md shows Phase 3.2 complete with plan checkboxes ticked"
    - "Deferred items from audit are captured in STATE.md pending todos or backlog"
  artifacts:
    - path: ".planning/STATE.md"
      provides: "Updated project state reflecting Phase 3.2 completion"
      contains: "Phase 3.2"
    - path: ".planning/ROADMAP.md"
      provides: "Updated roadmap with Phase 3.2 plans and completion status"
    - path: "config/CLAUDE.md"
      provides: "Updated config documentation reflecting new structure"
  key_links:
    - from: "03.2-AUDIT-REPORT.md deferred backlog"
      to: ".planning/STATE.md pending todos"
      via: "Medium+Low items transferred to project state for future phases"
      pattern: "MEDIUM|LOW|deferred"
---

<objective>
Update all architecture documentation and planning state to reflect the post-audit, post-refactoring state of the codebase. Sync STATE.md, ROADMAP.md, and all CLAUDE.md files. Transfer deferred audit items to project backlog.

Purpose: Ensure documentation accurately represents the system after Phase 3.2 changes, so Phase 4 starts with correct context. Close the audit loop.

Output: Updated CLAUDE.md files across the codebase, synced STATE.md and ROADMAP.md, deferred items in project backlog.
</objective>

<execution_context>
@/home/datasciencelab/.claude/get-shit-done/workflows/execute-plan.md
@/home/datasciencelab/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03.2-architecture-audit-code-quality/03.2-01-SUMMARY.md
@.planning/phases/03.2-architecture-audit-code-quality/03.2-02-SUMMARY.md
@.planning/phases/03.2-architecture-audit-code-quality/03.2-03-SUMMARY.md
@.planning/phases/03.2-architecture-audit-code-quality/03.2-AUDIT-REPORT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update Architecture Documentation (CLAUDE.md files)</name>
  <files>config/CLAUDE.md, scripts/docker/CLAUDE.md, scripts/lib/CLAUDE.md, scripts/monitoring/CLAUDE.md, scripts/system/CLAUDE.md, scripts/admin/CLAUDE.md</files>
  <action>
Read each existing CLAUDE.md file and update to reflect changes from Plans 02 and 03:

1. **config/CLAUDE.md** -- Major update:
   - Document new hierarchy (deploy/, runtime/, state/)
   - Explain variables.env and template pattern
   - Remove references to etc-mirrors/ if eliminated
   - Document lifecycle separation

2. **scripts/docker/CLAUDE.md** -- Update for code fixes:
   - Note any Critical/High fixes applied (lock timeout, file pre-checks, etc.)
   - Update descriptions of gpu_allocator_v2.py, docker-wrapper.sh if behaviour changed
   - Note dead code removed

3. **scripts/lib/CLAUDE.md** -- Update if event logging or utilities changed:
   - Note event size limit enforcement if added
   - Note any API changes

4. **scripts/monitoring/CLAUDE.md** -- Light update:
   - Note any changes to detect-workloads.py

5. **scripts/system/CLAUDE.md** -- Update for deploy.sh changes:
   - Note fill_config_template() addition
   - Note YAML validation addition
   - Note config path changes

6. **scripts/admin/CLAUDE.md** -- Light update if any admin tools changed

Each CLAUDE.md should be concise (per modular-claude-docs rules):
- Purpose of the directory
- Key files and what they do
- Links to related CLAUDE.md files
- Any important conventions or gotchas

Do NOT bloat these files. Keep them as navigation aids, not encyclopaedias.
  </action>
  <verify>
- All listed CLAUDE.md files updated
- Each CLAUDE.md accurately reflects current codebase state
- config/CLAUDE.md reflects new hierarchy
- No stale references to removed/moved files
  </verify>
  <done>All CLAUDE.md files reflect post-Phase-3.2 codebase state. No stale references.</done>
</task>

<task type="auto">
  <name>Task 2: Sync Planning State + Capture Deferred Items</name>
  <files>.planning/STATE.md, .planning/ROADMAP.md</files>
  <action>
1. **Update STATE.md:**
   - Current position: Phase 3.2 complete, ready for Phase 4
   - Add Phase 3.2 to performance metrics
   - Update pending todos: mark completed items, add new deferred items from audit
   - Transfer Medium+Low severity items from audit report to pending todos with severity and suggested phase
   - Update accumulated decisions with any new decisions from Phase 3.2
   - Update session continuity section

2. **Update ROADMAP.md:**
   - Phase 3.2 entry: update Plans section with actual plan names and checkboxes
   - Mark Phase 3.2 plans as complete (tick checkboxes)
   - Update progress table: Phase 3.2 complete
   - Verify Phase 4 details still accurate (plans already exist from earlier planning)

3. **Deferred items backlog:**
   - All Medium+Low audit findings go to STATE.md pending todos
   - Format: `- [ ] [SEVERITY] [description] -- deferred from Phase 3.2 audit (suggested: Phase X)`
   - Include the 5 deferred items already known from MEMORY.md context:
     a. Refactor MIG slot representation (fragile '.' check) -- MEDIUM
     b. Add SSH re-login messaging for group changes -- MEDIUM
     c. Improve profile.d error visibility (silent failures) -- LOW
     d. Consolidate event rate limiting (denial layer only) -- LOW
     e. Create unit tests for critical fixes -- BLOCKING (2 hours)

Commit: `docs(03.2): sync planning state and architecture docs`
  </action>
  <verify>
- STATE.md current position shows Phase 3.2 complete
- ROADMAP.md Phase 3.2 entry has plan checkboxes
- Deferred items from audit report captured in STATE.md pending todos
- Performance metrics updated
- No stale information in either file
  </verify>
  <done>STATE.md and ROADMAP.md accurately reflect Phase 3.2 completion. All deferred items captured for future phases. Project state is clean and accurate for Phase 4 start.</done>
</task>

</tasks>

<verification>
- [ ] All CLAUDE.md files updated (6 files minimum)
- [ ] config/CLAUDE.md reflects new config hierarchy
- [ ] STATE.md shows Phase 3.2 complete, Phase 4 next
- [ ] ROADMAP.md Phase 3.2 has ticked plan checkboxes
- [ ] Deferred items from audit captured in STATE.md
- [ ] No stale references in any documentation
- [ ] Clean commit with all doc updates
</verification>

<success_criteria>
1. Documentation accuracy: All CLAUDE.md files match current codebase
2. Planning state: STATE.md and ROADMAP.md reflect reality
3. Backlog capture: Every Medium+Low audit finding has a pending todo
4. Phase 4 readiness: Clean handoff with accurate project state
</success_criteria>

<output>
After completion, create `.planning/phases/03.2-architecture-audit-code-quality/03.2-04-SUMMARY.md`
</output>
