# Phase 3.2 Quick Reference: Architecture Audit & Code Quality

> Condensed from 03.2-AUDIT-REPORT.md (880 lines). Read the full report for evidence URLs and detailed analysis.

## Architecture Verdicts (7/7 subsystems validated)

| Subsystem | Verdict | Key Finding |
|-----------|---------|-------------|
| Event logging | PASS | Never-block pattern stronger than typical HPC. JSONL + PIPE_BUF atomicity correct |
| Workload detection | PASS-WITH-NOTES | 30s polling acceptable. Transient 2-scan filter is non-standard but justified (DS01 detects post-hoc, unlike SLURM/K8s which control launch) |
| Container isolation | PASS-WITH-NOTES | Wrapper approach correct. Docker auth plugin **rejected** (CVE-2024-41110 + demo-grade OPA) |
| GPU access control | PASS | Three-layer architecture matches SLURM exactly. Each layer justified, none removable |
| Deployment pipeline | PASS | Self-bootstrap re-exec, deterministic permissions manifest, fail-closed. Production-ready |
| GPU allocation | PASS-WITH-NOTES | Stateless file-locking design is innovative. Fail-open correct for DS01 (availability > strict isolation) |
| Config management | IMPROVE → FIXED | Consolidated into deploy/runtime/state hierarchy with generative template pipeline |

**Key architectural conclusion:** DS01's architecture is fundamentally sound. All issues were implementation-level, not architectural.

## Error Handling Philosophy (validated across all subsystems)

| Context | Mode | Rationale |
|---------|------|-----------|
| User operations (container create, GPU alloc) | Fail-open | Availability over restriction |
| System operations (deploy.sh, systemd) | Fail-closed | Integrity over availability |
| Logging/monitoring | Best-effort | Never block operations |

## Critical Fixes Applied

| ID | Severity | Fix | File | Commit |
|----|----------|-----|------|--------|
| CRITICAL-01 | CRITICAL | 5s SIGALRM lock timeout + fail-open | `gpu_allocator_v2.py:89-124` | c0d1a68 |
| HIGH-01 | HIGH | `validate_ds01_environment()` pre-flight checks | `mlc-patched.py:1795-1830` | f3cf770 |
| HIGH-02 | HIGH | `validate_yaml()` pre-deploy YAML check | `deploy.sh:160-181` | 941719b |
| HIGH-03 | HIGH | 4KB MAX_EVENT_SIZE with truncation + fail-open | `ds01_events.py:52,174-198` | 10b1ae9 |

## Deferred Items (5 MEDIUM, ~2.5 hours total)

| ID | Issue | File | Effort | Suggested Phase |
|----|-------|------|--------|-----------------|
| MEDIUM-01 | MIG slot uses fragile `'.' in gpu` string check | `gpu_allocator_v2.py:123` | 30min | 3.3 |
| MEDIUM-02 | No SSH re-login message after group changes | `add-user-to-docker.sh` | 5min | 3.3 |
| MEDIUM-03 | Profile.d errors silent during login | `config/deploy/profile.d/*.sh` | 15min | 3.3 |
| MEDIUM-04 | Rate limiting only in denial layer, not general events | `docker-wrapper.sh` | 1hr | 4.1 |
| MEDIUM-06 | Grant file JSON corruption not detected on read | `bare-metal-access` | 20min | 3.3 |

Dead code (MEDIUM-05, ORIGINAL_MLC variable) was removed during this phase.

## Rejected Alternatives

**Docker authorization plugin:** Evaluated and rejected.
1. CVE-2024-41110 — critical bypass vulnerability in Docker's AuthZ mechanism
2. OPA opa-docker-authz is a demo project (77 commits, 9 open issues)
3. Already parked by DS01 in Dec 2025 Phase 3 research
4. Adds OPA + plugin daemon as runtime dependencies
5. Wrapper approach covers the practical attack surface (users don't have root)

**Device permission manipulation (udev 0660):** Rejected in Phase 2.1 research. Breaks nvidia-smi, NVIDIA driver overrides permissions, race conditions.

## Security Blocker

**CVE-2025-23266** (NVIDIA Container Toolkit < 1.16.2) — container escape vulnerability. **Must verify `nvidia-ctk --version` before Phase 4 deployment.** If vulnerable, upgrade is BLOCKING.

## Suggestions for Future Phases

1. **inotify on /proc** for real-time GPU process detection (currently polling) — not urgent, awareness layer only
2. **One-time migration script** to label legacy containers with `ds01.user` — eliminates fail-open for unowned containers
3. **ShellCheck** on critical bash scripts (docker-wrapper.sh, deploy.sh) — tool not installed yet, ~30min to run
4. **Ruff format/check** runs — pre-commit configured but manual runs recommended before releases
5. **Event rate limiting** should be consolidated into `ds01_events.py` rather than per-caller implementation

## Config Hierarchy (implemented)

```
config/
├── deploy/          # Install-time → copied TO /etc/
│   ├── systemd/
│   ├── profile.d/
│   ├── logrotate.d/
│   └── sudoers.d/
├── runtime/         # Per-operation → read during execution
│   ├── resource-limits.yaml
│   ├── groups/
│   ├── group-overrides.txt
│   └── user-overrides.yaml
├── state/           # Persistence documentation
│   └── README.md    # Documents /var/lib/ds01 structure
└── variables.env    # Deploy-time variables for templates
```

Template support: `*.template` files processed by `fill_config_template()` with `envsubst`.
