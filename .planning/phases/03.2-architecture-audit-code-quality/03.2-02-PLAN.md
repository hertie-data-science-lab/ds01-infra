---
phase: 03.2-architecture-audit-code-quality
plan: 02
type: execute
wave: 2
depends_on: ["03.2-01"]
files_modified:
  - scripts/docker/gpu_allocator_v2.py
  - scripts/docker/docker-wrapper.sh
  - scripts/docker/mlc-create-wrapper.sh
  - scripts/docker/mlc-patched.py
  - scripts/docker/gpu-availability-checker.py
  - scripts/docker/gpu_availability_checker.py
  - scripts/lib/ds01_events.py
  - scripts/lib/ds01_events.sh
  - scripts/system/deploy.sh
  - scripts/monitoring/detect-workloads.py
  - config/deploy/profile.d/
  - config/resource-limits.yaml
autonomous: true

must_haves:
  truths:
    - "All Critical severity code issues from audit report are fixed"
    - "All High severity code issues from audit report are fixed"
    - "Confirmed dead code removed from codebase"
    - "Each fix is an atomic commit with clear message"
    - "No regressions introduced -- existing functionality preserved"
  artifacts:
    - path: "scripts/docker/gpu_allocator_v2.py"
      provides: "GPU allocator with Critical+High fixes applied"
    - path: "scripts/system/deploy.sh"
      provides: "Deploy script with Critical+High fixes applied"
  key_links:
    - from: "03.2-AUDIT-REPORT.md"
      to: "code fixes"
      via: "Each fix traces back to a specific audit finding"
      pattern: "CRITICAL-|HIGH-"
---

<objective>
Fix all Critical and High severity code quality issues identified in Plan 01's audit report. Remove confirmed dead code. Apply ruff formatting to all modified Python files. Each fix gets an atomic commit.

Purpose: Remediate the most impactful code issues before Phase 4, ensuring the foundation is reliable for resource enforcement.

Output: Fixed code files with atomic commits per fix. Deferred Medium+Low items remain catalogued in audit report.
</objective>

<execution_context>
@/home/datasciencelab/.claude/get-shit-done/workflows/execute-plan.md
@/home/datasciencelab/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03.2-architecture-audit-code-quality/03.2-CONTEXT.md
@.planning/phases/03.2-architecture-audit-code-quality/03.2-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix Critical Severity Issues</name>
  <files>Files identified as CRITICAL in 03.2-AUDIT-REPORT.md</files>
  <action>
Read the audit report from Plan 01 (`03.2-AUDIT-REPORT.md`) and extract all CRITICAL severity findings.

For each CRITICAL finding:
1. Read the affected file
2. Implement the proposed fix from the audit report
3. Verify the fix doesn't break existing functionality
4. Commit atomically with message: `fix(03.2): [description] -- CRITICAL-NN`

**Expected CRITICAL issues (from research and haiku branch validation):**
- GPU allocator file lock timeout missing (blocks indefinitely if lockfile stuck)
- Any security vulnerabilities (CVE-related, permission escalation paths)

**Fix guidelines:**
- Minimal change -- fix the issue, don't refactor surrounding code
- Preserve all existing interfaces (callers unchanged)
- fail-open for user operations, fail-closed for system operations
- Add brief inline comment explaining the fix rationale

After each fix, run: `ruff format [file]` and `ruff check --fix [file]`
  </action>
  <verify>
- Each CRITICAL fix committed with atomic commit
- `ruff check` passes on modified files
- Existing tests (if any) still pass
- grep audit report to confirm all CRITICAL items addressed
  </verify>
  <done>All CRITICAL severity findings from audit report are fixed, committed, and pass linting.</done>
</task>

<task type="auto">
  <name>Task 2: Fix High Severity Issues + Dead Code Removal</name>
  <files>Files identified as HIGH in 03.2-AUDIT-REPORT.md, plus dead code locations</files>
  <action>
Read the audit report and extract all HIGH severity findings and dead code items.

For each HIGH finding:
1. Read the affected file
2. Implement the proposed fix from the audit report
3. Commit atomically: `fix(03.2): [description] -- HIGH-NN`

**Expected HIGH issues (from research context):**
- File pre-checks missing (mlc-patched.py, resource-limits.yaml validation before use)
- YAML validation missing in deploy.sh (deploy with broken YAML could break system)
- Event size limits not enforced (events >4KB break PIPE_BUF atomic write guarantee)
- Grant file validation missing (JSON corruption detection)

**Dead code removal:**
1. Read vulture/deadcode output (if run in Plan 01) or audit report dead code section
2. For each confirmed dead code item:
   - Verify it's truly unused (grep for references)
   - Remove it
   - If it's a failed approach, document in commit message WHY it was there and WHY it's being removed
3. Commit: `refactor(03.2): remove dead code -- [description]`

**Expected dead code:**
- ORIGINAL_MLC variable (never referenced after Phase 3 changes)
- Any leftover OPA migration code
- Deprecated system scripts (.deprecated suffix files)

After all fixes, run `ruff format` and `ruff check --fix` on all modified Python files.
  </action>
  <verify>
- Each HIGH fix committed atomically
- Dead code removed with documented commit messages
- `ruff format .` and `ruff check .` pass on modified files
- grep audit report to confirm all HIGH items and dead code items addressed
  </verify>
  <done>All HIGH severity findings fixed. All confirmed dead code removed. All modified Python files pass ruff formatting and linting. Medium+Low issues remain in backlog (not touched).</done>
</task>

</tasks>

<verification>
- [ ] All CRITICAL findings from audit report fixed with atomic commits
- [ ] All HIGH findings from audit report fixed with atomic commits
- [ ] Dead code removed with documented commit messages
- [ ] `ruff format .` produces no changes on modified Python files
- [ ] `ruff check .` passes on modified Python files
- [ ] No regressions: existing functionality preserved
- [ ] Each commit references the audit finding ID (CRITICAL-NN / HIGH-NN)
</verification>

<success_criteria>
1. Zero remaining CRITICAL issues in codebase
2. Zero remaining HIGH issues in codebase
3. All confirmed dead code removed
4. Clean git history: one commit per fix, clear messages
5. All modified Python files pass ruff formatting and linting
</success_criteria>

<output>
After completion, create `.planning/phases/03.2-architecture-audit-code-quality/03.2-02-SUMMARY.md`
</output>
